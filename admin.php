<?php
require_once ("includes/connection.php");
$_POST = db_filter($_POST);
$_GET = db_filter($_GET);

if (isset($_GET['access_token']) && isset($_GET['vk'])) {
    if (validateSecureAccess($_GET['access_token'], $_GET['vk'])) {
        // Token validation successful, proceed to admin panel or 2FA if enabled
        if ($admin_settings['email_code'] == 'true') {
            // Proceed to email verification
            // Your existing email verification code here
        } else {
            // Direct access to admin panel
            header("Location: admin", true, 301);
            
            exit;
        }
    } else {
        header("Location: login", true, 301);
        exit;
    }
}
if (isset($_SESSION['last_activity'])) {
    $session_minutes = isset($security_settings['admin_session']) ? 
                     intval($security_settings['admin_session']) : 15;
    
    $session_lifetime = $session_minutes * 60; // Convert to seconds
    $current_time = time();
    
    // If session has expired
    if (($current_time - $_SESSION['last_activity']) > $session_lifetime) {
        // Clear all session variables
        $_SESSION = array();
        
        // Destroy the session
        session_destroy();
        
        // Redirect to login page
        header("Location: login", true, 301);
        exit;
    }
}

// Update last activity timestamp
$_SESSION['last_activity'] = time();

define('DEMO_MODE', false); 
define('BINARY_MODE', false); 
if(count($_POST) && DEMO_MODE) {
    $alert_demo = true;
    $allowed = ['action', 'last_id', 'search', 'show', 'fake', 'orderby', 'status', 'sort_by', 'sort_order', 'per_page', 'page', 'user_id', 'transaction_id', 'amount', 'currency', 'limit'];

    $_POST = array_intersect_key($_POST, array_flip($allowed));

    if(empty($_POST)) {
        if(isset($_SERVER['HTTP_X_REQUESTED_WITH']) && strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) === 'xmlhttprequest') {
            header('Content-Type: application/json');
            die(json_encode(['status' => false]));
        }
        ?>
        <script>
           function showAlert() { if (typeof Swal === 'undefined') { alert('Not allowed in demo version'); } else { Swal.fire({ title: 'Not Allowed', text: 'For Smooth demo version experience we have disabled the submission.', icon: 'error', showCancelButton: true, confirmButtonText: 'Contact Support', cancelButtonText: 'OK', confirmButtonColor: '#3085d6', cancelButtonColor: '#d33', reverseButtons: true }).then((result) => { if (result.isConfirmed) { window.open('https://t.me/bitdersteam', '_blank'); } }); } } if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', showAlert); } else { showAlert(); }
        </script>
        <?php
       
    }
}

if (basename($_SERVER["REQUEST_URI"]) == 'admin')
{
    if(!check_license()) {
        $json = array('connection'=>$connection, 'database'=>$database, 'username'=>$username, 'password'=>$password, 'license' => false);
        $json = json_encode($json);
        $json =  $OpensslEncryption->encrypt($json, ENCRYPTION_KEY);
        file_put_contents("includes/settings.php", $json);
        die("Invalid License");
    }
}

if(isset($_SESSION['admin_chk']) && $_SESSION['admin_chk']) {
 $stmt = mysqli_prepare($DB_CONN, "SELECT * FROM users WHERE id = ?");
mysqli_stmt_bind_param($stmt, "i", $_SESSION['admin_chk']);
mysqli_stmt_execute($stmt);
$user = mysqli_stmt_get_result($stmt);
$user = mysqli_fetch_assoc($user);
}

// if (isset($_POST['2fa']))
// {
//     if (TokenAuth6238::verify($_SESSION['secret'], $_POST['2fa']))
//     {
//         unset($_SESSION['admin_chk']);
//         unset($_SESSION['code']);
//         $_SESSION['admin_login'] = $user['email'];
//         $_SESSION['admin_name'] = $user['username'];
//         $_SESSION['id'] = $user['id'];
//         header("location: admin", true, 301);
//         exit;
//     }
//     else
//     {
//         $alert = true;
//         $alert_class = $g_alert[36]['class'];
//         $alert_message = $g_alert[36]['content'];
//     }
// }
if (isset($_SESSION['admin_chk']) && $admin_settings['email_code'] == 'true')
{
    $total_attempts = 5;
    if(!isset($_SESSION['attempts']))
        $_SESSION['attempts'] = 0;
    $msg = NULL;
    if (isset($_POST['code']) && $_SESSION['attempts'] < $total_attempts)
    {
        if ($_POST['code'] == $_SESSION['code'])
        {
            unset($_SESSION['code']);
            unset($_SESSION['admin_chk']);
            $_SESSION['admin_login'] = $user['email'];
            $_SESSION['admin_name'] = $user['username'];
            $_SESSION['id'] = $user['id'];
            header("location: admin", true, 301);
            exit;
        }
        else
        {
            $_SESSION['attempts']++;
            $msg = "<h3 style='color:red'>Invalid Code - ".($total_attempts-$_SESSION['attempts'])." Try Left</h3>";
        }
    } elseif(isset($_POST['code'])) {
        $msg = "<h3 style='color:red'>Max Tries Reached.</h3>";
    }
    $admin_2fa = $user['2fa']; 
    $email = $user['email'];
    $code = mt_rand(100000, 999999);
    $_SESSION['code'] = $code;
    sendadminmail('admin_login_code', $code);
?>
<html lang="en">
    <!--begin::Head-->
    <head>
        <title>Bitders Security Check</title>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700" />
        <!--end::Fonts-->
        <!--begin::Global Stylesheets Bundle(mandatory for all pages)-->
        <link href="bitders/assets/plugins.bundle.css" rel="stylesheet" type="text/css" />
        <link href="bitders/assets/style.bundle.css" rel="stylesheet" type="text/css" />
        <!--end::Global Stylesheets Bundle-->
        <script>// Frame-busting to prevent site from being loaded within a frame without permission (click-jacking) if (window.top != window.self) { window.top.location.replace(window.self.location.href); }</script>
    </head>
    <!--end::Head-->
    <!--begin::Body-->
    <body id="kt_body" class="app-blank bgi-size-cover bgi-position-center bgi-no-repeat">
        <!--begin::Theme mode setup on page load-->
        <script>var defaultThemeMode = "light"; var themeMode; if ( document.documentElement ) { if ( document.documentElement.hasAttribute("data-bs-theme-mode")) { themeMode = document.documentElement.getAttribute("data-bs-theme-mode"); } else { if ( localStorage.getItem("data-bs-theme") !== null ) { themeMode = localStorage.getItem("data-bs-theme"); } else { themeMode = defaultThemeMode; } } if (themeMode === "system") { themeMode = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light"; } document.documentElement.setAttribute("data-bs-theme", themeMode); }</script>
        <!--end::Theme mode setup on page load-->
        <!--begin::Root-->
        <div class="d-flex flex-column flex-root" id="kt_app_root">
            <!--begin::Page bg image-->
            <style>body { background-image: url('assets/media/auth/bg9.jpg'); } [data-bs-theme="dark"] body { background-image: url('assets/media/auth/bg9-dark.jpg'); }</style>
            <!--end::Page bg image-->
            <!--begin::Authentication - Signup Welcome Message -->
            <div class="d-flex flex-column flex-center flex-column-fluid">
                <!--begin::Content-->
                <div class="d-flex flex-column flex-center text-center p-10">
                    <!--begin::Wrapper-->
                    <div class="card card-flush w-lg-650px py-5">
                        <div class="card-body py-15 py-lg-20">
                            <!--begin::Logo-->
                            <div class="mb-13">
                                <a  href="/admin" class="">
                                    <img alt="Logo" src="bitders/assets/logo.svg" class="h-40px" />
                                </a>
                            </div>
                            <!--end::Logo-->
                            <!--begin::Title-->
                            <h1 class="fw-bolder text-gray-900 mb-7">Browser Change Detect</h1>
                            <!--end::Title-->
                            <!--begin::Counter-->
                            <!--end::Counter-->
                            <!--begin::Text-->
                            <div class="fw-semibold fs-6 text-gray-500 mb-7">Please enter Security Code we have sent on your email</div>
                            <!--end::Text-->
                            <?=$msg?$msg:''?>
                            <!--begin::Form-->
                            <form class="w-md-350px mb-2 mx-auto" method="post" id="kt_coming_soon_form">
                                <div class="fv-row text-start">
                                    <div class="d-flex flex-column flex-md-row justify-content-center gap-3">
                                        <!--end::Input=-->
                                        <input type="text" placeholder="Code" name="code" autocomplete="off" class="form-control" />
                                        <!--end::Input=-->
                                        <!--begin::Submit-->
                                        <button class="btn btn-primary text-nowrap" id="kt_coming_soon_submit" type="submit" name='submit'>
                                            <!--begin::Indicator label-->
                                            <span class="indicator-label">Enter</span>
                                            
                                        </button>
                                        <!--end::Submit-->
                                    </div>
                                </div>
                            </form>
                            <!--end::Form-->
                            <!--begin::Illustration-->
                    
                            <!--end::Illustration-->
                        </div>
                    </div>
                    <!--end::Wrapper-->
                </div>
                <!--end::Content-->
            </div>
            <!--end::Authentication - Signup Welcome Message-->
        </div>
        <!--end::Root-->
        <!--begin::Javascript-->
        <!--begin::Global Javascript Bundle(mandatory for all pages)-->
        <script src="bitders/assets/global/plugins.bundle.js"></script>
        <script src="bitders/assets/scripts.bundle.js"></script>
        <!--end::Global Javascript Bundle-->
        <!--begin::Custom Javascript(used for this page only)-->
        <!--end::Custom Javascript-->
        <!--end::Javascript-->
    </body>
    <!--end::Body-->
</html>
<?php } elseif($_SESSION['admin_chk']) {
    if(isset($_GET['page'])) {
    setcookie('last_page', $_GET['page'], time() + (86400 * 30), "/");
}
    unset($_SESSION['admin_chk']);
    $_SESSION['admin_login'] = $user['email'];
    $_SESSION['admin_name'] = $user['username'];
    $_SESSION['id'] = $user['id'];
    
    // Check if there was a last page stored
    if(isset($_COOKIE['last_page'])) {
        $redirect_to = "admin?page=" . $_COOKIE['last_page'];
        setcookie('last_page', '', time() - 3600, '/'); // Clear the cookie
    } else {
        $redirect_to = "admin"; // Default redirect if no stored page
    }
    
    header("location: $redirect_to", true, 301);
    exit;
}
if (!isset($_SESSION['admin_login']))
{
    header("location: login", true, 301);
    exit;
} else {
    if($admin_settings['logout_on_ip_change']){
        $up = mysqli_fetch_array(mysqli_query($DB_CONN, "SELECT ip FROM `login_report` WHERE user_id = '{$_SESSION['id']}' order by id desc limit 1"))[0];
        if($up != $ip) {
            session_destroy();
            header("location: $login_link",  true,  301 ); exit;
        }
    }
    if($admin_settings['logout_on_browser_change']){
        $us = mysqli_fetch_array(mysqli_query($DB_CONN, "SELECT useragent FROM `login_report` WHERE user_id = '{$_SESSION['id']}' order by id desc limit 1"))[0];
        if($us != $_SERVER['HTTP_USER_AGENT']) {
            session_destroy();
            header("location: $login_link",  true,  301 ); exit;
        }
    }
}

if ($_GET['page'] == 'login') {
    $alert = false;
    $alert_class = '';
    $alert_message = '';
    if ((isset($_GET['logout'])) && ($_GET['logout'] == "true")) {
        // Store the referring page if it exists
        if(isset($_SERVER['HTTP_REFERER'])) {
            // Parse the URL to get the query parameters
            $parsed_url = parse_url($_SERVER['HTTP_REFERER']);
            if(isset($parsed_url['query'])) {
                // Store only the page parameter
                parse_str($parsed_url['query'], $params);
                if(isset($params['page'])) {
                    setcookie('last_page', $params['page'], time() + (86400 * 30), "/"); // Cookie expires in 30 days
                }
            }
        }

        $_SESSION['admin_login'] = NULL;
        $_SESSION['admin_name'] = NULL;
        $_SESSION['id'] = NULL;
        unset($_SESSION['user_login']);
        unset($_SESSION['user_name']);
        unset($_SESSION['user_id']);
        session_destroy();
        header("location: login", true, 301);
        exit;
    }
}

function isCronActive() {
    global $DB_CONN;
    $stmt = mysqli_query($DB_CONN, "SELECT * FROM cron WHERE type = 1 ORDER BY id DESC LIMIT 1");
    if(mysqli_num_rows($stmt) > 0)
        return true;
    else
        return false;
}

if (!isCronActive()) {
     $cronCommand = "*/1 * * * * php " . $_SERVER['DOCUMENT_ROOT'] . "/index.php cron";
     $escapedCommand = htmlspecialchars($cronCommand, ENT_QUOTES);
    ?>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const cronCommand = '<?php echo $escapedCommand; ?>';
        Swal.fire({
            title: 'Cron Job Setup Required',
            html: `
                <div class="text-left" style="text-align: left;">
                    <p>The automated tasks are not running. Please set up a cron job using one of these methods:</p>
                    
                    <div style="margin: 20px 0;">
                        <strong style="color: #2563eb;">🔵 cPanel Instructions:</strong>
                        <ol style="margin: 10px 0; padding-left: 20px;">
                            <li>Log into cPanel</li>
                            <li>Find and click "Cron Jobs" (under Advanced)</li>
                            <li>Select "Once Per Minute" from the Common Settings</li>
                            <li>Copy this command to "Command":</li>
                            <code style="background: #f4f4f4; padding: 10px; display: block; margin: 10px 0; word-break: break-all;">
                                ${cronCommand}
                            </code>
                            <li>Click "Add New Cron Job"</li>
                        </ol>
                    </div>

                    <div style="margin: 20px 0;">
                        <strong style="color: #2563eb;">🔵 Hostinger Instructions:</strong>
                        <ol style="margin: 10px 0; padding-left: 20px;">
                            <li>Log into Hostinger Control Panel</li>
                            <li>Go to "Advanced" → "Cron Jobs"</li>
                            <li>Set time interval to "* * * * *" (every minute)</li>
                            <li>Copy this command:</li>
                            <code style="background: #f4f4f4; padding: 10px; display: block; margin: 10px 0; word-break: break-all;">
                                ${cronCommand}
                            </code>
                            <li>Click "Submit"</li>
                        </ol>
                    </div>

                    <div style="margin: 20px 0;">
                        <strong style="color: #2563eb;">🔵 Plesk Instructions:</strong>
                        <ol style="margin: 10px 0; padding-left: 20px;">
                            <li>Go to "Scheduled Tasks"</li>
                            <li>Click "Add Task"</li>
                            <li>Set "Run" to "Every minute"</li>
                            <li>Copy this command:</li>
                            <code style="background: #f4f4f4; padding: 10px; display: block; margin: 10px 0; word-break: break-all;">
                                ${cronCommand}
                            </code>
                        </ol>
                    </div>

                    <div style="margin: 20px 0;">
                        <strong style="color: #2563eb;">🔵 Command Line (SSH):</strong>
                        <ol style="margin: 10px 0; padding-left: 20px;">
                            <li>Connect via SSH</li>
                            <li>Run: <code>crontab -e</code></li>
                            <li>Add this line:</li>
                            <code style="background: #f4f4f4; padding: 10px; display: block; margin: 10px 0; word-break: break-all;">
                                */1 * * * * ${cronCommand}
                            </code>
                            <li>Save and exit (usually :wq in vim)</li>
                        </ol>
                    </div>

                    <p style="margin-top: 20px; color: #dc2626;"><strong>Note:</strong> After setting up, wait 1-2 minutes and refresh this page. The alert should disappear if configured correctly.</p>
                </div>
            `,
            icon: 'warning',
            confirmButtonText: 'I understand',
            width: '800px',
            showCloseButton: true,
            showCancelButton: true,
            cancelButtonText: 'Close',
            confirmButtonColor: '#2563eb',
            cancelButtonColor: '#dc2626'
        });
    });
    </script>
<? }
if ($_GET['page'] == 'update_auto_updates' && $_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action'])) {
    if ($_POST['action'] === 'update_auto_updates') {
        header('Content-Type: application/json');
        // Get auto_updates value
        $auto_updates = isset($_POST['auto_updates']) ? $_POST['auto_updates'] : 'false';
        
        // Get current preferences
        $pref = mysqli_query($DB_CONN, "SELECT * FROM preferences WHERE id=1");
        if (!$pref || mysqli_num_rows($pref) == 0) {
            echo json_encode(['success' => false, 'message' => 'Preferences not found']);
            exit;
        }
        
        $pref = mysqli_fetch_assoc($pref);
        $versions = json_decode($pref['version'], true);
        
        // Add or update auto_updates in versions
        $versions['auto_updates'] = $auto_updates;
        
        // Encode back to JSON
        $versions_json = json_encode($versions);
        
        // Update in database
        $update_query = "UPDATE preferences SET version = ? WHERE id = 1";
        $stmt = mysqli_prepare($DB_CONN, $update_query);
        mysqli_stmt_bind_param($stmt, 's', $versions_json);
        
        if (mysqli_stmt_execute($stmt)) {
            echo json_encode(['success' => true, 'message' => 'Auto-update setting saved successfully']);
        } else {
            echo json_encode(['success' => false, 'message' => 'Failed to save auto-update setting']);
        }
        
        mysqli_stmt_close($stmt);
        exit;
    }
} 
if ($_GET['page'] == 'trade') {
    header('Content-Type: application/json');
    
    switch($_GET['action']) {
        case 'get_active':
            $query = mysqli_query($DB_CONN, 
    "SELECT t.*, u.username, u.email, c.name as currency_name
    FROM trades t 
    LEFT JOIN users u ON t.user_id = u.id
    LEFT JOIN currencies c ON t.payment_method_id = c.id 
    WHERE t.trade_result = ''");
            
            $trades = [];
            while($row = mysqli_fetch_assoc($query)) {
                $trades[] = $row;
            }
            echo json_encode($trades);
            break;

        case 'get_completed':
           $query = mysqli_query($DB_CONN, 
    "SELECT t.*, u.username, u.email, c.name as currency_name
    FROM trades t 
    LEFT JOIN users u ON t.user_id = u.id
    LEFT JOIN currencies c ON t.payment_method_id = c.id 
    WHERE t.trade_result != ''");
            
            $trades = [];
            while($row = mysqli_fetch_assoc($query)) {
                $trades[] = $row;
            }
            echo json_encode($trades);
            break;

        case 'get_single':
            $id = (int)$_GET['id'];
            $query = mysqli_query($DB_CONN, 
                "SELECT * FROM trades WHERE id = $id LIMIT 1");
            echo json_encode(mysqli_fetch_assoc($query));
            break;

        case 'update':
            $id = (int)$_POST['trade_id'];
            $entry_price = floatval($_POST['entry_price']);
            $exit_price = floatval($_POST['exit_price']);
            $stoploss = floatval($_POST['stoploss']);
            $takeprofit = floatval($_POST['takeprofit']);
            $status = (int)$_POST['status'];
            $trade_result = mysqli_real_escape_string($DB_CONN, $_POST['trade_result']);

            $query = mysqli_query($DB_CONN, 
                "UPDATE trades 
                SET entry_price = $entry_price,
                    exit_price = $exit_price,
                    stoploss = $stoploss,
                    takeprofit = $takeprofit,
                    status = $status,
                    trade_result = '$trade_result',
                    closed_by = 'admin'
                WHERE id = $id");

            echo json_encode(['success' => $query ? true : false]);
            break;
    }
    exit;
}
if ($_GET['page'] == 'tgnews') {
    ob_start();
    while (ob_get_level()) {
        ob_end_clean();
    }
    header('Content-Type: application/json');
    header('X-Content-Type-Options: nosniff');

     try {
        $botToken = $tgtoken;
        $telegramApiUrl = "https://api.telegram.org/bot$botToken";
        
        // Process input data with null coalescing
        $content = $_POST['content'];
        $buttonTexts = isset($_POST['button_text']) ? $_POST['button_text'] : [];
        $buttonData = isset($_POST['button_data']) ? $_POST['button_data'] : [];
        $buttonTypes = isset($_POST['button_type']) ? $_POST['button_type'] : [];
        $buttonPositions = isset($_POST['button_position']) ? $_POST['button_position'] : [];
        $mode = $_POST['mode'];
        $selectedImageUrl = isset($_POST['selected_image']) ? $_POST['selected_image'] : '';
        $parseMode = 'HTML';
$content = str_replace("\\'", "'", $content);
 $content = str_replace(['\\r\\n', '\\r', '\\n', "\r\n", "\r"], "\n", $content);
        // First convert markdown-style links to HTML
$content = preg_replace(
    '/\[([^\]]+)\]\((https?:\/\/[^\s\)]+)\)/', 
    '<a href="$2">$1</a>', 
    $content
);

// Then normalize any existing HTML links to use double quotes
$content = preg_replace(
    '/<a[\s]+href[\s]*=[\s]*[\'"]([^\'"]+)[\'"][\s]*>/i',
    '<a href="$1">',
    $content
);

// Clean HTML tags
$content = strip_tags($content, '<b><strong><i><em><u><ins><s><strike><del><a><code><pre>');

// Handle line breaks


        $channelId = $telegram_settings['channel_id'];
        $testUserId = $telegram_settings['personal_id'];

        $inlineKeyboard = [];
        $lastRow = [];
        
        // Process buttons with improved URL validation
        for ($i = 0; $i < count($buttonTexts); $i++) {
            if (!empty($buttonTexts[$i]) && !empty($buttonData[$i])) {
                $button = ['text' => $buttonTexts[$i]];
                
                // Validate and format URLs for buttons
                if ($buttonTypes[$i] === 'url' || $buttonTypes[$i] === 'web_app') {
                    $url = filter_var($buttonData[$i], FILTER_SANITIZE_URL);
                    if (!filter_var($url, FILTER_VALIDATE_URL)) {
                        continue; // Skip invalid URLs
                    }
                    $buttonData[$i] = $url;
                }

                if ($mode === 'channel') {
                    if (in_array($buttonTypes[$i], ['web_app', 'url'])) {
                        $button['url'] = $buttonData[$i];
                    } else {
                        continue;
                    }
                } else {
                    switch ($buttonTypes[$i]) {
                        case 'url':
                            $button['url'] = $buttonData[$i];
                            break;
                        case 'web_app':
                            $button['web_app'] = ['url' => $buttonData[$i]];
                            break;
                        case 'callback_data':
                            $button['callback_data'] = $buttonData[$i];
                            break;
                    }
                }
                
                if ($buttonPositions[$i] === 'same') {
                    $lastRow[] = $button;
                } else {
                    if (!empty($lastRow)) {
                        $inlineKeyboard[] = $lastRow;
                        $lastRow = [];
                    }
                    $inlineKeyboard[] = [$button];
                }
            }
        }

        if (!empty($lastRow)) {
            $inlineKeyboard[] = $lastRow;
        }

        $userIds = [];
        
        if ($mode === 'test') {
            $userIds[] = $testUserId;
        } elseif ($mode === 'channel') {
            $userIds[] = $channelId;
        } elseif ($mode === 'live') {
            $query = "SELECT oauth_uid FROM `users` WHERE oauth_provider = 'telegram'";
            $result = $DB_CONN->query($query);
            
            if ($result && $result->num_rows > 0) {
                while ($row = $result->fetch_assoc()) {
                    $userIds[] = $row['oauth_uid'];
                }
            } else {
                throw new Exception("Error fetching users or no users found.");
            }
        }

        $successCount = 0;
        $failCount = 0;
        $errors = [];

        foreach ($userIds as $userId) {
            $message = [
                'chat_id' => $userId,
                'parse_mode' => $parseMode
            ];

            if (!empty($inlineKeyboard)) {
                $message['reply_markup'] = json_encode(['inline_keyboard' => $inlineKeyboard]);
            }

            if (!empty($selectedImageUrl)) {
                $message['photo'] = $selectedImageUrl;
                $message['caption'] = $content;
                $apiUrl = "$telegramApiUrl/sendPhoto";
            } else {
                $message['text'] = $content;
                $apiUrl = "$telegramApiUrl/sendMessage";
            }

            $ch = curl_init($apiUrl);
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
            curl_setopt($ch, CURLOPT_POSTFIELDS, $message);
            $response = curl_exec($ch);
            $httpcode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
            curl_close($ch);

            if ($httpcode === 200) {
                $successCount++;
            } else {
                $failCount++;
                $errors[] = "Error sending message to $userId: HTTP $httpcode - $response";
            }

            if ($mode === 'live') {
                usleep(34000);
            }
        }

        $DB_CONN->close();

        $responseMessage = '';
        if ($mode === 'test') {
            $responseMessage = $successCount > 0 ? "Test message sent successfully!" : "Failed to send test message.";
        } elseif ($mode === 'channel') {
            $responseMessage = $successCount > 0 ? "Message sent to channel successfully!" : "Failed to send message to channel.";
        } else {
            $responseMessage = "Newsletter sent to $successCount users. Failed: $failCount";
        }

        echo json_encode([
            'success' => ($failCount === 0),
            'message' => $responseMessage,
            'details' => [
                'success_count' => $successCount,
                'fail_count' => $failCount,
                'errors' => $errors
            ]
        ]);

    } catch (Exception $e) {
        echo json_encode([
            'success' => false,
            'message' => 'An error occurred',
            'error' => $e->getMessage()
        ]);
    }
    exit;
}
if ($_GET['page'] === 'lang' && isset($_POST['action'])) {

    header('Content-Type: application/json');
    ob_start();
    mysqli_set_charset($DB_CONN, "utf8mb4");
    
    $response = ['success' => false, 'message' => '', 'data' => null];
    $fullUrl = "http://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
    $parsedUrl = parse_url($fullUrl);
    $domain = $parsedUrl['host'];

    switch ($_POST['action']) {


    case 'add':
    if (isset($_POST['name']) && isset($_POST['code'])) {
        $name = mysqli_real_escape_string($DB_CONN, $_POST['name']);
        $code = mysqli_real_escape_string($DB_CONN, strtolower($_POST['code']));
        $status = mysqli_real_escape_string($DB_CONN, $_POST['status'] ?? '1');
        $translate = isset($_POST['translate']) && $_POST['translate'] === 'true' ? 1 : 0;
        $has_translation_license = checkLicense($domain);
        // Define translation status for new language
        $translation_status = [
            'content' => isset($_POST['translate_content']) && $_POST['translate_content'] === 'true',
            'alerts' => isset($_POST['translate_alerts']) && $_POST['translate_alerts'] === 'true',
            'faqs' => isset($_POST['translate_faqs']) && $_POST['translate_faqs'] === 'true',
            'categories' => isset($_POST['translate_categories']) && $_POST['translate_categories'] === 'true',
            'news' => isset($_POST['translate_news']) && $_POST['translate_news'] === 'true',
            'tasks' => isset($_POST['translate_tasks']) && $_POST['translate_tasks'] === 'true',
            'telegram_bot' => isset($_POST['translate_bot']) && $_POST['translate_bot'] === 'true'
        ];

        
        // Check if language exists and handle translation status
        $check = mysqli_query($DB_CONN, "SELECT id, code, translation_status FROM languagues WHERE code='$code'");
        if (mysqli_num_rows($check) > 0) {
            $existing_lang = mysqli_fetch_assoc($check);
            $existing_translations = json_decode($existing_lang['translation_status'], true);
            
            $translation_message = '';
            if ($translation_status['content'] && $existing_translations['content']) {
                $translation_message .= 'Content, ';
            }
            if ($translation_status['alerts'] && $existing_translations['alerts']) {
                $translation_message .= 'Alerts, ';
            }
            if ($translation_status['faqs'] && $existing_translations['faqs']) {
                $translation_message .= 'FAQs, ';
            }
            if ($translation_status['categories'] && $existing_translations['categories']) {
                $translation_message .= 'Categories, ';
            }
            if ($translation_status['news'] && $existing_translations['news']) {
                $translation_message .= 'News, ';
            }

            if ($translation_status['tasks'] && $existing_translations['tasks']) {
                    $translation_message .= 'Tasks, ';
                }
            $response['success'] = false;
            $response['message'] = 'Language code already exists.';
            updateSiteData($siteURL);
            if ($translation_message) {
                $translation_message = rtrim($translation_message, ', ');
                $response['message'] .= " The following translations are already present: $translation_message";
            }
            break;
        }

        // Proceed with insertion if language doesn't exist
       $translation_status_json = mysqli_real_escape_string($DB_CONN, json_encode($translation_status));
        $insert = mysqli_query($DB_CONN, 
            "INSERT INTO languagues (`name`, `code`, `status`, `translation_status`) 
             VALUES ('$name', '$code', '$status', '$translation_status_json')"
        );

        if ($insert) {
            $new_lang_id = mysqli_insert_id($DB_CONN);
            $copy_status = [];

            // Determine if we should actually translate based on license and toggle
            $should_translate = $translate && $has_translation_license;
            
            // Process selected content types with or without translation
            if (isset($_POST['translate_content']) && $_POST['translate_content'] === 'true') {
                $copy_status['content'] = processContentTranslation($DB_CONN, $new_lang_id, $code, $domain, $should_translate);
            }
            
            if (isset($_POST['translate_alerts']) && $_POST['translate_alerts'] === 'true') {
                $copy_status['alerts'] = processAlertsTranslation($DB_CONN, $new_lang_id, $code, $domain, $should_translate);
            }
            
            if (isset($_POST['translate_faqs']) && $_POST['translate_faqs'] === 'true') {
                $copy_status['faqs'] = processFaqsTranslation($DB_CONN, $new_lang_id, $code, $domain, $should_translate);
            }
            
            if (isset($_POST['translate_categories']) && $_POST['translate_categories'] === 'true') {
                $copy_status['categories'] = processCategoriesTranslation($DB_CONN, $new_lang_id, $code, $domain, $should_translate);
            }
            
            if (isset($_POST['translate_news']) && $_POST['translate_news'] === 'true') {
                $copy_status['news'] = processNewsTranslation($DB_CONN, $new_lang_id, $code, $domain, $should_translate);
            }
            
            if (isset($_POST['translate_bot']) && $_POST['translate_bot'] === 'true') {
                $copy_status['telegram_bot'] = processTelegramBotTranslation($DB_CONN, $new_lang_id, $code, $domain, $should_translate);
            }
            
            if (isset($_POST['translate_tasks']) && $_POST['translate_tasks'] === 'true') {
                $copy_status['tasks'] = processTasksTranslation($DB_CONN, $new_lang_id, $code, $domain, $should_translate);
            }

            $response['success'] = true;
            $response['message'] = 'Language added successfully';
            $response['translations'] = $copy_status;
            
            // Add information about translation licensing if applicable
            if ($translate && !$has_translation_license) {
                $response['license_required'] = true;
                $response['message'] .= ' (Content was copied without translation due to licensing limitations)';
            }
        } else {
            $response['success'] = false;
            $response['message'] = 'Failed to add language';
        }
    }
    break;
       case 'list':
    $languages = [];
    $query = mysqli_query($DB_CONN, "SELECT * FROM languagues ORDER BY id ASC");
    while ($lang = mysqli_fetch_assoc($query)) {
        $translation_status = json_decode($lang['translation_status'], true);
        $languages[] = [
            'id' => $lang['id'],
            'name' => $lang['name'],
            'code' => $lang['code'],
            'status' => $lang['status'],
            'status_badge' => $lang['status'] == 1 ? 
                '<span class="badge badge-light-success fs-7 fw-bold">Active</span>' : 
                '<span class="badge badge-light-danger fs-7 fw-bold">Inactive</span>',
            'translations' => $translation_status
        ];
    }
    $response['success'] = true;
    $response['data'] = $languages;
    break;
        case 'edit':
            if (isset($_POST['id'])) {
                $id = mysqli_real_escape_string($DB_CONN, $_POST['id']);
                $query = mysqli_query($DB_CONN, "SELECT * FROM languagues WHERE id='$id' LIMIT 1");
                if ($lang = mysqli_fetch_assoc($query)) {
                    $response['success'] = true;
                    $response['data'] = $lang;
                }
            }
            break;

        case 'update':
    if (isset($_POST['id'])) {
        $id = mysqli_real_escape_string($DB_CONN, $_POST['id']);
        $name = mysqli_real_escape_string($DB_CONN, $_POST['name']);
        $code = mysqli_real_escape_string($DB_CONN, $_POST['code']);
        $status = mysqli_real_escape_string($DB_CONN, $_POST['status']);
        
        // Check if we have a valid translation license
        $has_translation_license = checkTranslationLicense($domain);
        $translate = isset($_POST['translate']) && $_POST['translate'] === 'true';
        $should_translate = $translate && $has_translation_license;
        
        // Get current translation status
        $current_query = mysqli_query($DB_CONN, "SELECT translation_status FROM languagues WHERE id='$id'");
        $current_lang = mysqli_fetch_assoc($current_query);
        $current_translations = json_decode($current_lang['translation_status'], true);
        
        // Update translation status if new translations are requested
        $translation_status = [
            'content' => isset($_POST['translate_content']) && $_POST['translate_content'] === 'true',
            'alerts' => isset($_POST['translate_alerts']) && $_POST['translate_alerts'] === 'true',
            'faqs' => isset($_POST['translate_faqs']) && $_POST['translate_faqs'] === 'true',
            'categories' => isset($_POST['translate_categories']) && $_POST['translate_categories'] === 'true',
            'news' => isset($_POST['translate_news']) && $_POST['translate_news'] === 'true',
            'tasks' => isset($_POST['translate_tasks']) && $_POST['translate_tasks'] === 'true',
            'telegram_bot' => isset($_POST['translate_telegram_bot']) && $_POST['translate_telegram_bot'] === 'true'
        ];
        $translation_status_json = mysqli_real_escape_string($DB_CONN, json_encode($translation_status));
        
        $update = mysqli_query($DB_CONN, 
            "UPDATE languagues SET 
                `name` = '$name', 
                `code` = '$code', 
                `status` = '$status',
                `translation_status` = '$translation_status_json'
            WHERE id = '$id'"
        );
        
        // Process new translations if requested
        if ($update) {
            $copy_status = [];

            if (isset($_POST['translate_content']) && $_POST['translate_content'] === 'true' && !$current_translations['content']) {
                $copy_status['content'] = processContentTranslation($DB_CONN, $id, $code, $domain, $should_translate);
            }
            if (isset($_POST['translate_alerts']) && $_POST['translate_alerts'] === 'true' && !$current_translations['alerts']) {
                $copy_status['alerts'] = processAlertsTranslation($DB_CONN, $id, $code, $domain, $should_translate);
            }
            if (isset($_POST['translate_faqs']) && $_POST['translate_faqs'] === 'true' && !$current_translations['faqs']) {
                $copy_status['faqs'] = processFaqsTranslation($DB_CONN, $id, $code, $domain, $should_translate);
            }
            if (isset($_POST['translate_categories']) && $_POST['translate_categories'] === 'true' && !$current_translations['categories']) {
                $copy_status['categories'] = processCategoriesTranslation($DB_CONN, $id, $code, $domain, $should_translate);
            }
            if (isset($_POST['translate_news']) && $_POST['translate_news'] === 'true' && !$current_translations['news']) {
                $copy_status['news'] = processNewsTranslation($DB_CONN, $id, $code, $domain, $should_translate);
            }
            if (isset($_POST['translate_tasks']) && $_POST['translate_tasks'] === 'true' && !$current_translations['tasks']) {
                $copy_status['tasks'] = processTasksTranslation($DB_CONN, $id, $code, $domain, $should_translate);
            }
            if (isset($_POST['translate_bot']) && $_POST['translate_bot'] === 'true' && !$current_translations['telegram_bot']) {
                $copy_status['telegram_bot'] = processTelegramBotTranslation($DB_CONN, $id, $code, $domain, $should_translate);
            }
            
            $response['translations'] = $copy_status;
            
            // Add information about translation licensing if applicable
            if ($translate && !$has_translation_license) {
                $response['license_required'] = true;
                $response['message'] = 'Language updated successfully (Content was copied without translation due to licensing limitations)';
            } else {
                $response['message'] = 'Language updated successfully';
            }
        } else {
            $response['message'] = 'Failed to update language';
        }

        $response['success'] = $update ? true : false;
        updateSiteData($siteURL);
    }
    break;

        case 'delete':
            if (isset($_POST['id']) && $_POST['id'] != 1) {
                $id = mysqli_real_escape_string($DB_CONN, $_POST['id']);
                $delete = mysqli_query($DB_CONN, "DELETE FROM languagues WHERE id='$id'");
                if ($delete) {
                    mysqli_query($DB_CONN, "DELETE FROM faqs WHERE lang_id='$id'");
                    mysqli_query($DB_CONN, "DELETE FROM alerts WHERE lang_id='$id'");
                    mysqli_query($DB_CONN, "DELETE FROM content WHERE lang_id='$id'");
                    mysqli_query($DB_CONN, "DELETE FROM categories WHERE lang_id='$id'");
                    mysqli_query($DB_CONN, "DELETE FROM news WHERE lang_id='$id'");
                    mysqli_query($DB_CONN, "DELETE FROM tasks WHERE lang_id='$id'");
                    mysqli_query($DB_CONN, "DELETE FROM telegram_bot WHERE lang_id='$id'");
                    $response['success'] = true;
                    $response['message'] = 'Language deleted successfully';
                    updateSiteData($siteURL);
                } else {
                    $response['message'] = 'Failed to delete language';
                }
            }
            break;
            
    }
    ob_clean();
    echo json_encode($response);
    exit;
}


if ($_GET['page'] === 'test_processor' && $_POST['action'] === 'test_processor') {
    header('Content-Type: application/json');
    
    $response = [
        'success' => false,
        'message' => '',
        'details' => ''
    ];
    
    try {
        // Get processor settings from database
        $query = mysqli_query($DB_CONN, "SELECT * FROM `payment_methods` WHERE id = '{$_POST['processor_id']}'");
        $row = mysqli_fetch_assoc($query);
        
        if (!$row) {
            throw new Exception('Invalid processor ID');
        }
        
        $existingSettings = json_decode($row['currencies'], true);
        $testSettings = $_POST['settings'];
        $sensitiveFields = ['pass', 'key', 'alternate', 'secret', 'ipn'];
        
        // Process sensitive fields - encrypt new values, keep existing ones
        foreach ($testSettings as $key => $value) {
            if (contains($key, $sensitiveFields)) {
                if (!isset($existingSettings[$key]) || $value !== $existingSettings[$key]) {
                    $testSettings[$key] = encrypt_decrypt('encrypt', $value);
                } else {
                    $testSettings[$key] = $existingSettings[$key];
                }
            }
        }
        
        // Decrypt all sensitive values for testing
        foreach ($testSettings as $key => $value) {
            if (contains($key, $sensitiveFields)) {
                $testSettings[$key] = encrypt_decrypt('decrypt', $value);
            }
        }
        
        // Test the processor
        $processor = new PaymentProcessor($_POST['processor_id'], $testSettings);
        $result = $processor->processPayment('test');
        
        // Format the response
        if ($result['success']) {
            $response['success'] = true;
            $response['message'] = 'Settings tested successfully!';
            $response['details'] = isset($result['balances']) ? 'Available balance: ' . json_encode($result['balances']) : '';
        } else {
            $response['message'] = 'Settings test failed: ' . $result['message'];
            $response['details'] = isset($result['test_result']) ? json_encode($result['test_result']) : '';
        }
    } catch (Exception $e) {
        $response['message'] = 'Error testing settings: ' . $e->getMessage();
    }
    
    echo json_encode($response);
    exit;
}
if ($_GET['page'] === 'telegram_chat' && $_SERVER['REQUEST_METHOD'] === 'POST') {
    $action = $_POST['action'] ?? '';
    $response = ['success' => false];
    
    switch($action) {
        case 'get_users':
            $stmt = $DB_CONN->prepare("SELECT DISTINCT tu.username, tu.first_name, tu.last_name,tu.photo_path,tu.user_id, MAX(t.date) AS last_activity, ( SELECT text FROM telegram WHERE user_id = t.user_id AND type = 'private' ORDER BY date DESC LIMIT 1 ) AS last_message FROM telegram t JOIN telegram_users tu ON t.user_id = tu.user_id WHERE t.type = 'private' GROUP BY t.user_id ORDER BY last_activity DESC;
            ");
            $stmt->execute();
            $result = $stmt->get_result();
            $users = [];
            while($row = $result->fetch_assoc()) {
                $users[] = $row;
            }
            $response = ['success' => true, 'users' => $users];
            break;

      case 'get_user_info':
    $user_id = $_POST['user_id'] ?? '';
    if(!$user_id) {
        $response = ['success' => false, 'error' => 'No user ID provided'];
        break;
    }

    $telegram_info = getTelegramUserInfo($user_id);
    
    if ($telegram_info) {
        error_log("Got Telegram info: " . json_encode($telegram_info));
    }
    
    // Then get from database
    $stmt = $DB_CONN->prepare("
        SELECT DISTINCT
            t.user_id,
            t.username,
            t.first_name,
            t.last_name,
            MAX(t.date) as last_activity,
            COUNT(*) as message_count
        FROM telegram t
        WHERE t.user_id = ?
        GROUP BY t.user_id, t.username, t.first_name, t.last_name
    ");
    
    $stmt->bind_param('s', $user_id);
    $stmt->execute();
    $result = $stmt->get_result();
    $user = $result->fetch_assoc();
    
    if ($user || $telegram_info) {
        // Combine database and Telegram info, preferring Telegram info if available
        $user_data = [
            'user_id' => $user_id,
            'username' => $telegram_info['username'] ?? $user['username'] ?? null,
            'first_name' => $telegram_info['first_name'] ?? $user['first_name'] ?? null,
            'last_name' => $telegram_info['last_name'] ?? $user['last_name'] ?? null,
            'bio' => $telegram_info['bio'] ?? null,
            'last_activity' => $user['last_activity'] ?? null,
            'message_count' => $user['message_count'] ?? 0,
            'photo_url' => $telegram_info['photo_path'] ?? 0,
        ];
        
        $user_data['display_name'] = trim($user_data['first_name'] . ' ' . $user_data['last_name']) ?: 'Unknown User';
        $user_data['username_display'] = $user_data['username'] ? '@' . $user_data['username'] : 'No username';
        
        $response = [
            'success' => true, 
            'user' => $user_data
        ];
    } else {
        $response = [
            'success' => false, 
            'error' => 'User not found'
        ];
    }
    break;
case 'get_chat_history':
    $user_id = $_POST['user_id'] ?? '';
    $last_timestamp = $_POST['last_timestamp'] ?? 0;
    
    if(!$user_id) break;

    // Modified query to ensure proper chronological sorting
    $stmt = $DB_CONN->prepare("
        SELECT 
            t.*,
            CASE WHEN t.type = 'BOT' THEN 1 ELSE 0 END as is_bot,
            r.text as replied_text,
            r.message_id as replied_message_id,
            r.type as replied_message_type,
            r.first_name as replied_first_name,
            COALESCE(t.date, UNIX_TIMESTAMP(t.datetime)) as message_timestamp
        FROM telegram t
        LEFT JOIN telegram r ON t.reply = r.message_id
        WHERE (t.user_id = ? OR t.chat_id = ?) 
        AND (
            t.type IN ('private', 'BOT') 
            OR t.event_type = 'message'
            OR t.reason = 'support_reply'
        )
        AND t.text IS NOT NULL 
        AND t.text != ''
        ORDER BY 
            CASE 
                WHEN t.date > 0 THEN t.date
                ELSE UNIX_TIMESTAMP(t.datetime)
            END ASC,
            t.id ASC
        LIMIT 100
    ");
    
    $stmt->bind_param('ss', $user_id, $user_id);
    $stmt->execute();
    $result = $stmt->get_result();
    $messages = [];
    while($row = $result->fetch_assoc()) {
        // Ensure every message has a valid timestamp
        if (empty($row['date']) || $row['date'] == 0) {
            $row['date'] = strtotime($row['datetime']);
        }
        $messages[] = $row;
    }
    
    $response = ['success' => true, 'messages' => $messages];
    break;
    case 'clear_chat':
    $user_id = $_POST['user_id'] ?? '';
    if(!$user_id) {
        $response = ['success' => false, 'error' => 'No user ID provided'];
        break;
    }

    // Get messages to delete from your database
    $stmt = $DB_CONN->prepare("
        SELECT message_id 
        FROM telegram 
        WHERE (chat_id = ? OR user_id = ?) 
        AND type = 'BOT'
        ORDER BY date DESC
    ");
    $stmt->bind_param('ss', $user_id, $user_id);
    $stmt->execute();
    $result = $stmt->get_result();
    
    $success = true;
    $deleted_count = 0;

    // Delete messages one by one via Telegram API
    while($row = $result->fetch_assoc()) {
        $tg_response = sendTelegramRequest('deleteMessage', [
            'chat_id' => $user_id,
            'message_id' => $row['message_id']
        ]);
        
        $tg_result = json_decode($tg_response, true);
        
        if($tg_result['ok']) {
            $deleted_count++;
            // Delete from database if successful
            $delete_stmt = $DB_CONN->prepare("
                DELETE FROM telegram 
                WHERE message_id = ? AND type = 'BOT'
            ");
            $delete_stmt->bind_param('s', $row['message_id']);
            $delete_stmt->execute();
        } else {
            // If message already deleted on Telegram, remove from DB
            if($tg_result['error_code'] == 400 && strpos($tg_result['description'], 'message to delete not found') !== false) {
                $delete_stmt = $DB_CONN->prepare("
                    DELETE FROM telegram 
                    WHERE message_id = ? AND type = 'BOT'
                ");
                $delete_stmt->bind_param('s', $row['message_id']);
                $delete_stmt->execute();
            }
        }
    }

    // Then clear chat history via Telegram API
    $tg_response = sendTelegramRequest('deleteChat', [
        'chat_id' => $user_id
    ]);
    
    $response = [
        'success' => true,
        'messages_deleted' => $deleted_count
    ];
    break;

case 'block_user':
    $user_id = $_POST['user_id'] ?? '';
    if(!$user_id) {
        $response = ['success' => false, 'error' => 'No user ID provided'];
        break;
    }

    // First try to block via Telegram API
    $tg_response = sendTelegramRequest('banChatMember', [
        'chat_id' => $user_id,
        'user_id' => $user_id,
        'revoke_messages' => true // This will delete the user's messages
    ]);
    
    $tg_result = json_decode($tg_response, true);
    
    if($tg_result['ok']) {
        // Then mark as blocked in your database
        $stmt = $DB_CONN->prepare("
            UPDATE telegram 
            SET status = 'blocked'
            WHERE user_id = ?
        ");
        $stmt->bind_param('s', $user_id);
        $stmt->execute();
        
        // Also send a message to inform the user they've been blocked
        sendTelegramRequest('sendMessage', [
            'chat_id' => $user_id,
            'text' => 'You have been blocked from using this bot.'
        ]);
        
        $response = ['success' => true];
    } else {
        $response = [
            'success' => false, 
            'error' => 'Failed to block user on Telegram',
            'telegram_error' => $tg_result['description'] ?? 'Unknown error'
        ];
    }
    break;

// And update the send_message case to ensure proper timestamp
case 'send_message':
    $user_id = $_POST['user_id'] ?? '';
    $message = $_POST['message'] ?? '';
    $reply_to_message_id = $_POST['reply_to_message_id'] ?? null;
    
    if(!$user_id || !$message) break;

    $data = [
        'chat_id' => $user_id,
        'text' => $message
    ];
    
    // Add reply_to_message_id if it exists
    if ($reply_to_message_id) {
        $data['reply_to_message_id'] = $reply_to_message_id;
    }
    
    $tg_response = sendTelegramRequest('sendMessage', $data);
    $tg_result = json_decode($tg_response, true);

    if($tg_result['ok']) {
        $message_id = $tg_result['result']['message_id'];
        $current_time = time();
        
        // Update the logEvent to include reply information
        logEvent(
            $user_id, 
            $user_id, 
            $message_id, 
            'message', 
            'support_reply',
            json_encode([
                'sent_via' => 'admin_panel',
                'reply_to_message_id' => $reply_to_message_id
            ]),
            $message
        );

        // Update the timestamp and reply information
        $stmt = $DB_CONN->prepare("
            UPDATE telegram 
            SET 
                date = ?,
                reply = ?
            WHERE message_id = ? AND (date IS NULL OR date = 0)
        ");
        $stmt->bind_param('iss', $current_time, $reply_to_message_id, $message_id);
        $stmt->execute();

        $response = [
            'success' => true,
            'message' => [
                'message_id' => $message_id,
                'text' => $message,
                'date' => $current_time,
                'is_bot' => true,
                'type' => 'BOT',
                'first_name' => 'Bitders Demo Bot',
                'username' => 'bitders_demo_bot',
                'reply' => $reply_to_message_id
            ]
        ];
    }
    break;

        case 'delete_message':
            $message_id = $_POST['message_id'] ?? '';
            if(!$message_id) break;

            // First get the chat_id for this message
            $stmt = $DB_CONN->prepare("
                SELECT chat_id FROM telegram 
                WHERE message_id = ? AND type = 'BOT'
                LIMIT 1
            ");
            $stmt->bind_param('s', $message_id);
            $stmt->execute();
            $result = $stmt->get_result();
            $message = $result->fetch_assoc();

            if ($message) {
                // Delete message via Telegram API
                $data = [
                    'chat_id' => $message['chat_id'],
                    'message_id' => $message_id
                ];
                $tg_response = sendTelegramRequest('deleteMessage', $data);
                $tg_result = json_decode($tg_response, true);

                if($tg_result['ok']) {
                    // Delete from database
                    $stmt = $DB_CONN->prepare("
                        DELETE FROM telegram 
                        WHERE message_id = ? AND type = 'BOT'
                    ");
                    $stmt->bind_param('s', $message_id);
                    $stmt->execute();
                    $response = ['success' => true];
                }
            }
            break;
    }

    header('Content-Type: application/json');
    echo json_encode($response);
    exit;
}

if ($_GET['page'] === 'adminapi' && $_SERVER['REQUEST_METHOD'] === 'POST') {
  while (ob_get_level()) {
        ob_end_clean();
    }
    header('Content-Type: application/json');
    
    try {
        $action = $_POST['action'] ?? '';
        
        if (empty($action)) {
            throw new Exception('Action is required');
        }
        
        switch($action) {
        case 'getPrivateUsers':
    $query = "SELECT DISTINCT t.chat_id, t.username, t.first_name, t.last_name
              FROM telegram t 
              WHERE t.type = 'private'
              ORDER BY t.date DESC";
              
    $result = $DB_CONN->query($query);
    $users = $result->fetch_all(MYSQLI_ASSOC);
    
    echo json_encode(['success' => true, 'users' => $users]);
    break;
        case 'getEvents':
            $limit = $_POST['limit'] ?? 50;
            $offset = $_POST['offset'] ?? 0;
            $search = $_POST['search'] ?? '';
            
            $query = "SELECT t.*, 
                     COALESCE(u.username, t.username) as user_username,
                     COALESCE(u.first_name, t.first_name) as user_firstname,
                     COALESCE(u.last_name, t.last_name) as user_lastname
                     FROM telegram t 
                     LEFT JOIN users u ON t.user_id = u.telegram_id
                     WHERE event_type IS NOT NULL";
                     
            if ($search) {
                $query .= " AND (t.text LIKE ? OR t.details LIKE ?)";
                $search = "%$search%";
            }
            
            $query .= " ORDER BY date DESC LIMIT ? OFFSET ?";
            
            $stmt = $DB_CONN->prepare($query);
            
            if ($search) {
                $stmt->bind_param('ssii', $search, $search, $limit, $offset);
            } else {
                $stmt->bind_param('ii', $limit, $offset);
            }
            
            $stmt->execute();
            $result = $stmt->get_result();
            $events = $result->fetch_all(MYSQLI_ASSOC);
            
            echo json_encode(['success' => true, 'events' => $events]);
            break;

        case 'getMessages':
            $chat_id = $_POST['chat_id'];
            $limit = $_POST['limit'] ?? 50;
            $offset = $_POST['offset'] ?? 0;
            $search = $_POST['search'] ?? '';
            
            $query = "SELECT t.*, 
                     COALESCE(u.username, t.username) as user_username,
                     COALESCE(u.first_name, t.first_name) as user_firstname,
                     COALESCE(u.last_name, t.last_name) as user_lastname
                     FROM telegram t 
                     LEFT JOIN users u ON t.user_id = u.telegram_id
                     WHERE t.chat_id = ?";
                     
            if ($search) {
                $query .= " AND t.text LIKE ?";
                $search = "%$search%";
            }
            
            $query .= " ORDER BY date DESC LIMIT ? OFFSET ?";
            
            $stmt = $DB_CONN->prepare($query);
            
            if ($search) {
                $stmt->bind_param('ssii', $chat_id, $search, $limit, $offset);
            } else {
                $stmt->bind_param('sii', $chat_id, $limit, $offset);
            }
            
            $stmt->execute();
            $result = $stmt->get_result();
            $messages = $result->fetch_all(MYSQLI_ASSOC);
            
            echo json_encode(['success' => true, 'messages' => $messages]);
            break;

        case 'deleteMessage':
            $chat_id = $_POST['chat_id'];
            $message_id = $_POST['message_id'];
            
            $data = [
                'chat_id' => $chat_id,
                'message_id' => $message_id
            ];
            
            $response = json_decode(sendTelegramRequest('deleteMessage', $data), true);
            
            if ($response['ok']) {
                logEvent(
                    $_SESSION['user_id'],
                    $chat_id,
                    $message_id,
                    'message_delete',
                    'admin_action',
                    json_encode([
                        'admin_user' => $_SESSION['username'],
                        'deleted_message_id' => $message_id
                    ])
                );
                echo json_encode(['success' => true]);
            } else {
                echo json_encode(['success' => false, 'error' => $response['description']]);
            }
            break;
            
        case 'editMessage':
            $chat_id = $_POST['chat_id'];
            $message_id = $_POST['message_id'];
            $text = $_POST['text'];
            
            $data = [
                'chat_id' => $chat_id,
                'message_id' => $message_id,
                'text' => $text
            ];
            
            $response = json_decode(sendTelegramRequest('editMessageText', $data), true);
            
            if ($response['ok']) {
                logEvent(
                    $_SESSION['user_id'],
                    $chat_id,
                    $message_id,
                    'message_edit',
                    'admin_action',
                    json_encode([
                        'admin_user' => $_SESSION['username'],
                        'edited_message_id' => $message_id,
                        'new_text' => $text
                    ])
                );
                echo json_encode(['success' => true]);
            } else {
                echo json_encode(['success' => false, 'error' => $response['description']]);
            }
            break;

        case 'pinMessage':
            $chat_id = $_POST['chat_id'];
            $message_id = $_POST['message_id'];
            
            $data = [
                'chat_id' => $chat_id,
                'message_id' => $message_id
            ];
            
            $response = json_decode(sendTelegramRequest('pinChatMessage', $data), true);
            
            if ($response['ok']) {
                logEvent(
                    $_SESSION['user_id'],
                    $chat_id,
                    $message_id,
                    'message_pin',
                    'admin_action',
                    json_encode([
                        'admin_user' => $_SESSION['username'],
                        'pinned_message_id' => $message_id
                    ])
                );
                echo json_encode(['success' => true]);
            } else {
                echo json_encode(['success' => false, 'error' => $response['description']]);
            }
            break;

        case 'replyMessage':
            $chat_id = $_POST['chat_id'];
            $reply_to_message_id = $_POST['reply_to_message_id'];
            $text = $_POST['text'];
            
            $data = [
                'chat_id' => $chat_id,
                'text' => $text,
                'reply_to_message_id' => $reply_to_message_id
            ];
            
            $response = json_decode(sendTelegramRequest('sendMessage', $data), true);
            
            if ($response['ok']) {
                logEvent(
                    $_SESSION['user_id'],
                    $chat_id,
                    $response['result']['message_id'],
                    'message_reply',
                    'admin_action',
                    json_encode([
                        'admin_user' => $_SESSION['username'],
                        'reply_to_message_id' => $reply_to_message_id,
                        'message_text' => $text
                    ])
                );
                echo json_encode(['success' => true, 'message_id' => $response['result']['message_id']]);
            } else {
                echo json_encode(['success' => false, 'error' => $response['description']]);
            }
            break;
            case 'sendMessage':
    $chat_id = $_POST['chat_id'];
    $text = $_POST['text'];
    $reply_to_message_id = $_POST['reply_to_message_id'] ?? null;
    
    $data = [
        'chat_id' => $chat_id,
        'text' => $text,
        'parse_mode' => 'HTML'
    ];
    
    if ($reply_to_message_id) {
        $data['reply_to_message_id'] = $reply_to_message_id;
    }
    
    $response = json_decode(sendTelegramRequest('sendMessage', $data), true);
    
    if ($response['ok']) {
        logEvent(
            $_SESSION['user_id'],
            $chat_id,
            $response['result']['message_id'],
            'message_send',
            'admin_action',
            json_encode([
                'admin_user' => $_SESSION['username'],
                'message_text' => $text,
                'reply_to_message_id' => $reply_to_message_id
            ])
        );
        echo json_encode(['success' => true, 'message_id' => $response['result']['message_id']]);
    } else {
        echo json_encode(['success' => false, 'error' => $response['description']]);
    }
     default:
                throw new Exception('Invalid action specified');
        }
    } catch (Exception $e) {
        echo json_encode([
            'success' => false,
            'error' => $e->getMessage()
        ]);
    }
    exit; // Ensure no additional output
}

if ($_GET['page'] == 'send_newsletter') {
    if ($_SERVER['REQUEST_METHOD'] === 'POST') {
        header('Content-Type: application/json; charset=utf-8');
        
        try {
            $response = ['success' => false, 'message' => '', 'data' => []];
            $_POST['message'] = str_replace('\r\n', "\n", $_POST['message']);
            $_POST['message'] = str_replace('\n', "\n", $_POST['message']);
            $_POST['message'] = str_replace('\r', "\n", $_POST['message']);
            
            $type = intval($_POST['type']);
            $subject = trim($_POST['subject']);
            $message = $_POST['message'];
            $isTest = isset($_POST['test']) && $_POST['test'] === 'true';

            if ($type == 2 && empty($_POST['username'])) {
                throw new Exception('Please select a user');
            }
            
            if ($isTest) {
                $testUser = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT id, username, email FROM users WHERE id = 1 LIMIT 1"));
                if (!$testUser) {
                    throw new Exception('No test user found');
                }
                
                if (sendnewsletter($testUser['id'], $subject, $message)) {
                    $response['success'] = true;
                    $response['message'] = "Test email sent to {$testUser['username']} ( {$testUser['email']} )";
                } else {
                    throw new Exception('Failed to send test email');
                }
            } else {
                // Handle actual newsletter sending
                $query = '';
                switch($type) {
                    case 1: // All users
                        $query = "SELECT id, username FROM users WHERE id != 1";
                        break;
                    case 2: // Specific user
                        $userid = intval($_POST['username']);
                        $query = "SELECT id, username FROM users WHERE id = $userid";
                        break;
                    case 3: // Active users
                        $query = "SELECT id, username FROM users WHERE status = 1";
                        break;
                    case 4: // Non-active users
                        $query = "SELECT id, username FROM users WHERE status = 0";
                        break;
                    case 5: // Users with deposits
                        $query = "SELECT users.id, users.username FROM users 
                                INNER JOIN package_deposits ON users.id = package_deposits.user_id 
                                WHERE package_deposits.status = 1 
                                GROUP BY users.id";
                        break;
                    case 6: // Users with active deposits
                        $query = "SELECT users.id, users.username FROM users 
                                INNER JOIN package_deposits ON users.id = package_deposits.user_id 
                                WHERE package_deposits.status = 1 OR package_deposits.avail > 0 
                                GROUP BY users.id";
                        break;
                    default:
                        throw new Exception('Invalid user type selected');
                }
                
               $result = mysqli_query($DB_CONN, $query);
                if (!$result) {
                    throw new Exception('Database query failed');
                }
                
                $sentCount = 0;
                $failedCount = 0;
                $sentUsers = [];
                $failedUsers = [];
                
                while ($user = mysqli_fetch_assoc($result)) {
                    if (sendnewsletter($user['id'], $subject, $message)) {
                        $sentCount++;
                        $sentUsers[] = $user['username'];
                    } else {
                        $failedCount++;
                        $failedUsers[] = $user['username'];
                    }
                }
                
                if ($sentCount > 0) {
                    $response['success'] = true;
                    $response['users'] = $sentUsers;
                    $response['failed_users'] = $failedUsers;
                    $response['message'] = "Newsletter sent successfully";
                } else {
                    throw new Exception('No emails were sent successfully');
                }
            }
            
        } catch (Exception $e) {
            $response['message'] = $e->getMessage();
        }
        
        echo json_encode($response);
        exit;
    }
}
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_GET['page']) && $_GET['page'] === 'test_smtp_connection') {
    while (ob_get_level()) {
        ob_end_clean();
    }
    header('Content-Type: application/json');
    try {
        if (empty($_POST['smtp_host']) || empty($_POST['smtp_user']) || empty($_POST['smtp_pass'])) {
            throw new Exception("All SMTP fields are required");
        }

        $select_detail = mysqli_query($DB_CONN, "SELECT * FROM preferences");
        $row_detail = mysqli_fetch_assoc($select_detail);
        $email_settings = json_decode($row_detail['email_settings'], true);

        $mail = new \PHPMailer\PHPMailer\PHPMailer(true);
        $mail->SMTPDebug = 0;
        $mail->isSMTP();
        $mail->Host = $_POST['smtp_host'];
        $mail->SMTPAuth = true;
        $mail->Username = $_POST['smtp_user'];
        $mail->Password = encrypt_decrypt('decrypt', $_POST['smtp_pass']) ? 
                         encrypt_decrypt('decrypt', $_POST['smtp_pass']) : 
                         $_POST['smtp_pass'];
        $mail->SMTPSecure = $_POST['smtp_secure'] ?: 'tls';
        $mail->Port = $_POST['smtp_port'] ?: 587;
        $from_email = $email_settings['from_email'] ?? 'noreply@example.com';
        $title = $email_settings['title'] ?? 'Test Email';
        $mail->setFrom($from_email, $title);
        $mail->addAddress("admin@bitders.com");
        $mail->addReplyTo($from_email, $title);
        $mail->isHTML(true);
        $mail->Subject = "SMTP Test Email";
        $mail->Body = "Test Email from {$from_email}";

        if ($mail->send()) {
            echo json_encode([
                'success' => true,
                'message' => 'SMTP Test Email Sent Successfully! ✅'
            ]);
        } else {
            throw new Exception($mail->ErrorInfo);
        }
        
    } catch (Exception $e) {
        echo json_encode([
            'success' => false,
            'message' => 'Connection Failed: ' . $e->getMessage() . ' ❌'
        ]);
    }
    exit;
}

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_GET['page']) && $_GET['page'] === 'test_imap_connection') {
    while (ob_get_level()) {
        ob_end_clean();
    }
    header('Content-Type: application/json');
    try {
        if (empty($_POST['imap_host']) || empty($_POST['imap_user']) || empty($_POST['imap_pass'])) {
            throw new Exception("All IMAP fields are required");
        }

        $select_detail = mysqli_query($DB_CONN, "SELECT * FROM preferences");
        $row_detail = mysqli_fetch_assoc($select_detail);
        $email_settings = json_decode($row_detail['email_settings'], true);

        $imap_password = encrypt_decrypt('decrypt', $_POST['imap_pass']) ? 
                        encrypt_decrypt('decrypt', $_POST['imap_pass']) : 
                        $_POST['imap_pass'];
        $imap_string = "{" . $_POST['imap_host'] . ":" . ($_POST['imap_port'] ?? '993') . 
                      "/imap/" . ($_POST['imap_secure'] ?? 'ssl') . "/novalidate-cert}INBOX";

        $inbox = @imap_open($imap_string, $_POST['imap_user'], $imap_password);
        if ($inbox) {
            imap_close($inbox);
            echo json_encode(['success' => true, 'message' => 'IMAP Connection Successful! ✅']);
        } else {
            throw new Exception(imap_last_error() ?: 'Connection failed');
        }
    } catch (Exception $e) {
        echo json_encode([
            'success' => false, 
            'message' => 'Connection Failed: ' . $e->getMessage() . ' ❌'
        ]);
    }
    exit;
}
if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_GET['page']) && $_GET['page'] === 'categories') {
    header('Content-Type: application/json');
    $result = false;
    $message = '';
    $response = ['success' => false, 'data' => null, 'message' => ''];

    if (isset($_POST['action'])) {
        switch ($_POST['action']) {
            case 'add':
                $stmt = $DB_CONN->prepare("
                    INSERT INTO categories (name, slug, description, parent_id, seo_robots) 
                    VALUES (?, ?, ?, ?, ?)
                ");
                 $slug = strtolower(str_replace(' ', '-', $_POST['name']));
                 $parent_id = empty($_POST['parent_id']) ? null : $_POST['parent_id'];
                $stmt->bind_param('sssis', 
                    $_POST['name'],
                    $slug,
                    $_POST['description'],
                    $parent_id,
                    $_POST['seo_robots']
                );
                $result = $stmt->execute();
    
                $response = [
                    'success' => $result,
                    'message' => $result ? 'Category added successfully' : 'Error adding category'
                ];
                            updateSiteData($siteURL);
                break;
            
            case 'edit':
                $stmt = $DB_CONN->prepare("
                    UPDATE categories 
                    SET name = ?, description = ?, parent_id = ?, seo_robots = ?
                    WHERE id = ?
                ");
                $stmt->bind_param('ssisi', 
                    $_POST['name'],
                    $_POST['description'],
                    $_POST['parent_id'],
                    $_POST['seo_robots'],
                    $_POST['id']
                );
                
                $result = $stmt->execute();
                
                $response = [
                    'success' => $result,
                    'message' => $result ? 'Category updated successfully' : 'Error updating category'
                ];
                updateSiteData($siteURL);
                break;
            
            case 'delete':
                $stmt = $DB_CONN->prepare("DELETE FROM categories WHERE id = ?");
                $stmt->bind_param('i', $_POST['id']);
                $result = $stmt->execute();
                $response = [
                    'success' => $result,
                    'message' => $result ? 'Category deleted successfully' : 'Error deleting category'
                ];
                break;
                case 'update_order':
    $stmt = $DB_CONN->prepare("UPDATE categories SET sort_order = ? WHERE id = ?");
    $stmt->bind_param('ii', $_POST['order'], $_POST['id']);
    $success = $stmt->execute();
    
    $response = [
        'success' => $success,
        'message' => $success ? 'Order updated successfully' : 'Error updating order'
    ];
    break;
            case 'get_all':
                $query = "SELECT 
        c.id, 
        c.name, 
        c.slug, 
        c.description,
        c.parent_id,
        p.name as parent_name,
        c.seo_robots,
        COALESCE(c.sort_order, 0) as sort_order
    FROM categories c 
    LEFT JOIN categories p ON c.parent_id = p.id
    WHERE c.parent_id IS NOT NULL
    ORDER BY c.sort_order, c.name";
                
                $categories = $DB_CONN->query($query)->fetch_all(MYSQLI_ASSOC);
                $response = [
                    'success' => true,
                    'data' => $categories,
                    'message' => ''
                ];
                break;
                 case 'get_all_site':
                $query = "SELECT 
        c.id, 
        c.name, 
        c.slug, 
        c.description,
        c.parent_id,
        p.name as parent_name,
        c.seo_robots,
        COALESCE(c.sort_order, 0) as sort_order
    FROM categories c 
    LEFT JOIN categories p ON c.parent_id = p.id
    WHERE c.parent_id IS NOT NULL AND c.parent_id != 1
    ORDER BY c.sort_order, c.name";
                
                $categories = $DB_CONN->query($query)->fetch_all(MYSQLI_ASSOC);
                $response = [
                    'success' => true,
                    'data' => $categories,
                    'message' => ''
                ];
                break;

            case 'get_parents':
                $query = "SELECT id, name FROM categories WHERE name IN ('Site', 'FAQs') ORDER BY name";
                $parents = $DB_CONN->query($query)->fetch_all(MYSQLI_ASSOC);
                $response = [
                    'success' => true,
                    'data' => $parents,
                    'message' => ''
                ];
                break;
        }
    }
    
    echo json_encode($response);
    exit;
}

if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_GET['page']) && $_GET['page'] === 'upload') {
    header('Content-Type: application/json');
    $response = ['success' => false, 'message' => ''];

    function get_unique_filename($dir, $filename) {
        $file_parts = pathinfo($filename);
        $base_name = $file_parts['filename'];
        $extension = $file_parts['extension'];
        $counter = 1;
        
        while (file_exists($dir . $filename)) {
            $filename = $base_name . "_{$counter}." . $extension;
            $counter++;
        }
        
        return $filename;
    }

    $images_dir = "images/";
    $domain = "https://" . $_SERVER['HTTP_HOST'] . dirname($_SERVER['PHP_SELF']);

    if (isset($_FILES["avatar"])) {
        $original_filename = basename($_FILES["avatar"]["name"]);
        $target_file = $images_dir . get_unique_filename($images_dir, $original_filename);
        $imageFileType = strtolower(pathinfo($target_file, PATHINFO_EXTENSION));

        if (getimagesize($_FILES["avatar"]["tmp_name"]) === false) {
            $response['message'] = "File is not an image.";
        } elseif ($_FILES["avatar"]["size"] > 5000000) {
            $response['message'] = "Sorry, your file is too large.";
        } elseif (!in_array($imageFileType, ['jpg', 'jpeg', 'png', 'gif', 'webp'])) {
            $response['message'] = "Sorry, only JPG, JPEG, PNG, WEBP & GIF files are allowed.";
        } elseif (move_uploaded_file($_FILES["avatar"]["tmp_name"], $target_file)) {
            $stmt = $DB_CONN->prepare("INSERT INTO image_metadata (filename, filepath) VALUES (?, ?)");
            $stmt->bind_param("ss", basename($target_file), $target_file);
            
            if ($stmt->execute()) {
                $response['success'] = true;
                $response['message'] = "The file has been uploaded as " . basename($target_file);
                $response['newName'] = basename($target_file);
                $response['id'] = $DB_CONN->insert_id;
            } else {
                $response['message'] = "Error inserting image metadata into database.";
            }
            $stmt->close();
        } else {
            $response['message'] = "Sorry, there was an error uploading your file.";
        }
    } elseif (isset($_POST["update_metadata"])) {
        $filename = $_POST["filename"];
        $alt_text = $_POST["alt_text"];
        $title = $_POST["title"];
        $caption = $_POST["caption"];
        $description = $_POST["description"];

        // Check if the image is already in the database
        $stmt = $DB_CONN->prepare("SELECT id FROM image_metadata WHERE filename = ?");
        $stmt->bind_param("s", $filename);
        $stmt->execute();
        $result = $stmt->get_result();
        
        if ($result->num_rows > 0) {
            // Update existing record
            $row = $result->fetch_assoc();
            $id = $row['id'];
            $stmt = $DB_CONN->prepare("UPDATE image_metadata SET alt_text = ?, title = ?, caption = ?, description = ? WHERE id = ?");
            $stmt->bind_param("ssssi", $alt_text, $title, $caption, $description, $id);
        } else {
            // Insert new record
            $filepath = $images_dir . $filename;
            $stmt = $DB_CONN->prepare("INSERT INTO image_metadata (filename, filepath, alt_text, title, caption, description) VALUES (?, ?, ?, ?, ?, ?)");
            $stmt->bind_param("ssssss", $filename, $filepath, $alt_text, $title, $caption, $description);
        }
        
        if ($stmt->execute()) {
            $response['success'] = true;
            $response['message'] = "Image metadata updated successfully.";
        } else {
            $response['message'] = "Error updating image metadata.";
        }
        $stmt->close();
    } elseif (isset($_POST["rename_image"])) {
        $old_name = $_POST["rename_image"];
        $new_name = $_POST["new_name"];
        $file_extension = pathinfo($old_name, PATHINFO_EXTENSION);
        $new_name_with_ext = $new_name . '.' . $file_extension;
        $new_name_with_ext = get_unique_filename($images_dir, $new_name_with_ext);

        // First, check if there's a database entry
        $stmt = $DB_CONN->prepare("SELECT id FROM image_metadata WHERE filename = ?");
        $stmt->bind_param("s", $old_name);
        $stmt->execute();
        $result = $stmt->get_result();
        
        if (rename($images_dir . $old_name, $images_dir . $new_name_with_ext)) {
            if ($result->num_rows > 0) {
                // Update existing database entry
                $stmt = $DB_CONN->prepare("UPDATE image_metadata SET filename = ?, filepath = ?, last_modified = CURRENT_TIMESTAMP WHERE filename = ?");
                $new_filepath = $images_dir . $new_name_with_ext;
                $stmt->bind_param("sss", $new_name_with_ext, $new_filepath, $old_name);
            } else {
                // Create new database entry if it doesn't exist
                $stmt = $DB_CONN->prepare("INSERT INTO image_metadata (filename, filepath, upload_date, last_modified) VALUES (?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)");
                $new_filepath = $images_dir . $new_name_with_ext;
                $stmt->bind_param("ss", $new_name_with_ext, $new_filepath);
            }
            
            if ($stmt->execute()) {
                $response['success'] = true;
                $response['message'] = "Image renamed successfully.";
                $response['newName'] = $new_name_with_ext;
                $response['newUrl'] = $domain . $images_dir . $new_name_with_ext;
            } else {
                $response['message'] = "Error updating database after rename.";
            }
            $stmt->close();
        } else {
            $response['message'] = "Error renaming image.";
        }
    } elseif (isset($_POST["delete_image"])) {
        $filename = $_POST["delete_image"];
        $file_to_delete = $images_dir . $filename;
        
        if (file_exists($file_to_delete) && unlink($file_to_delete)) {
            // Delete from database if exists
            $stmt = $DB_CONN->prepare("DELETE FROM image_metadata WHERE filename = ?");
            $stmt->bind_param("s", $filename);
            $stmt->execute();
            $stmt->close();

            $response['success'] = true;
            $response['message'] = "Image deleted successfully.";
        } else {
            $response['message'] = "Error deleting image file.";
        }
    } elseif (isset($_POST["action"]) && $_POST["action"] == "get_images") {
    $sort_by = isset($_POST['sort_by']) ? $_POST['sort_by'] : 'upload_date';
    $sort_order = isset($_POST['sort_order']) ? $_POST['sort_order'] : 'DESC';
    $page = isset($_POST['page']) ? (int)$_POST['page'] : 1;
    $per_page = isset($_POST['per_page']) ? (int)$_POST['per_page'] : 10;
    $search = isset($_POST['search']) ? $_POST['search'] : '';
    
    $allowed_sort_columns = ['filename', 'upload_date', 'last_modified'];
    if (!in_array($sort_by, $allowed_sort_columns)) {
        $sort_by = 'upload_date';
    }
    
    $sort_order = $sort_order === 'asc' ? 'ASC' : 'DESC';
    
    // Get all images from database first
    $query = "SELECT * FROM image_metadata";
    if ($search) {
        $query .= " WHERE filename LIKE ? OR alt_text LIKE ? OR title LIKE ?";
    }
    $query .= " ORDER BY $sort_by $sort_order";
    
    if ($search) {
        $stmt = $DB_CONN->prepare($query);
        $search_param = "%$search%";
        $stmt->bind_param("sss", $search_param, $search_param, $search_param);
        $stmt->execute();
        $result = $stmt->get_result();
    } else {
        $result = $DB_CONN->query($query);
    }
    
    $db_images = array();
    while ($row = $result->fetch_assoc()) {
        $db_images[$row['filename']] = [
            'id' => $row['id'],
            'name' => $row['filename'],
            'url' => $domain . $row['filepath'],
            'alt_text' => $row['alt_text'],
            'title' => $row['title'],
            'caption' => $row['caption'],
            'description' => $row['description'],
            'upload_date' => $row['upload_date'],
            'last_modified' => $row['last_modified']
        ];
    }

    // Get files from directory and sync with database
    $images = array();
    $files = scandir($images_dir);
       foreach ($files as $file) {
        if (in_array(strtolower(pathinfo($file, PATHINFO_EXTENSION)), ['jpg', 'jpeg', 'png', 'gif', 'webp'])) {
            $image_data = array(); // Initialize the array first
            $full_path = $images_dir . $file; // Use full path for file operations
            
            if (isset($db_images[$file])) {
                // Use database entry if it exists
                $image_data = $db_images[$file];
            } else {
                // Only create new entries if we're not searching
                if (!$search) {
                    // Create new entry for files not in database
                    $stmt = $DB_CONN->prepare("INSERT INTO image_metadata (filename, filepath, upload_date, last_modified) VALUES (?, ?, FROM_UNIXTIME(?), FROM_UNIXTIME(?))");
                    $filepath = $images_dir . $file;
                    $full_url = $domain . $filepath;
                    $file_time = filemtime($full_path);
                    $stmt->bind_param("ssii", $file, $filepath, $file_time, $file_time);
                    $stmt->execute();
                    
                    $image_data = [
                        'id' => $DB_CONN->insert_id,
                        'name' => $file,
                        'url' => $domain . $images_dir . $file,
                        'alt_text' => '',
                        'title' => '',
                        'caption' => '',
                        'description' => '',
                        'upload_date' => date("Y-m-d H:i:s", $file_time),
                        'last_modified' => date("Y-m-d H:i:s", $file_time)
                    ];
                }
            }
    
            // Add file information only if the file exists
            if (file_exists($full_path)) {
                $image_data['filesize'] = filesize($full_path);
                $dimensions = @getimagesize($full_path);
                if ($dimensions) {
                    $image_data['width'] = $dimensions[0];
                    $image_data['height'] = $dimensions[1];
                } else {
                    $image_data['width'] = 0;
                    $image_data['height'] = 0;
                }
            } else {
                $image_data['filesize'] = 0;
                $image_data['width'] = 0;
                $image_data['height'] = 0;
            }
            
            // Only add the image data if it's properly initialized
            if (!empty($image_data)) {
                $images[] = $image_data;
            }
        }
    }

    // Clean up deleted files from database
    if (!$search) {  // Only clean up when not searching
        $stmt = $DB_CONN->prepare("SELECT filename, filepath FROM image_metadata");
        $stmt->execute();
        $result = $stmt->get_result();
        while ($row = $result->fetch_assoc()) {
            if (!file_exists($row['filepath'])) {
                $delete_stmt = $DB_CONN->prepare("DELETE FROM image_metadata WHERE filename = ?");
                $delete_stmt->bind_param("s", $row['filename']);
                $delete_stmt->execute();
                $delete_stmt->close();
            }
        }
        $stmt->close();
    }

    // Sort the final array
    usort($images, function($a, $b) use ($sort_by, $sort_order) {
        $result = $a[$sort_by] <=> $b[$sort_by];
        return $sort_order === 'ASC' ? $result : -$result;
    });

    // Apply pagination after sorting
    $total_records = count($images);
    $offset = ($page - 1) * $per_page;
    $images = array_slice($images, $offset, $per_page);

    $response['success'] = true;
    $response['images'] = $images;
    $response['pagination'] = [
        'total' => $total_records,
        'per_page' => $per_page,
        'current_page' => $page,
        'total_pages' => ceil($total_records / $per_page)
    ];
}

    echo json_encode($response);
    exit;
}
if($_GET['page'] == 'sptree') {
    header("Content-type: application/json");
    $data = array();
    if(isset($_GET['id']) && $_GET['id']) {
        $user_id = (int)$_GET['id'];
        $i = 0;
        $u = mysqli_query($DB_CONN,"SELECT * from users where sponsor = '{$user_id}'");
        if(mysqli_num_rows($u)) {
            while ($left = mysqli_fetch_assoc($u)) {
                $data['children'][$i]['id'] = $left['id'];
                $data['children'][$i]['name'] = $left['username'];
                $data['children'][$i]['title'] = $left['fullname'];
                $data['children'][$i]['relationship'] = '001';
                $i++;
            }
        } else {
            $data['children'] = array();
        }
    }
    echo json_encode($data);
    die();
}
if ($_GET['page'] == 'getwebhookinfo') {
    $bot_type = $_GET['bot_type'] ?? 'main';
    $token = $_GET['token'] ?? '';
    
    if (empty($token)) {
        header('Content-Type: application/json');
        echo json_encode(['ok' => false, 'description' => 'Token not provided']);
        exit;
    }

    function getWebhookInfo($token) {
        $url = "https://api.telegram.org/bot" . $token . "/getWebhookInfo";
        $response = file_get_contents($url);
        
        if ($response === false) {
            return ['ok' => false, 'description' => 'Unable to fetch webhook info'];
        }
        
        return json_decode($response, true);
    }

    while (ob_get_level()) {
        ob_end_clean();
    }
    
    header('Content-Type: application/json');
    $webhookInfo = getWebhookInfo($token);
    echo json_encode($webhookInfo);
    exit;
}
if ($_GET['page'] == 'add_expage') {
    if ($_SERVER['REQUEST_METHOD'] === 'POST') {
        $page_key = $_POST['page_key'];
        $template_name = $_POST['template_name'];
        $page_type = $_POST['page_type'];

        $select_detail = mysqli_query($DB_CONN, "SELECT * FROM preferences");
        $row_detail = mysqli_fetch_assoc($select_detail);
        $extra_pages = json_decode($row_detail['extra_pages'], true) ?: [];

        if (!isset($extra_pages[$page_key])) {
            $extra_pages[$page_key] = ['template' => $template_name, 'type' => $page_type, 'xx' => xx];
            $extra_pages_json = mysqli_real_escape_string($DB_CONN, json_encode($extra_pages));
            $update_extra_pages = mysqli_query($DB_CONN, "UPDATE preferences SET extra_pages='{$extra_pages_json}' WHERE id='{$row_detail['id']}'");

            if ($update_extra_pages) {
                // Define the directory and file paths
                $dir = __DIR__ . '/tmpl/';
                $new_file_path = $dir . $template_name;
                if ($page_type === 'user') {
                    $source_file_path = $dir . '/templates/userside.tpl';
                } else {
                    $source_file_path = $dir . '/templates/frontside.tpl';
                }

                if (!is_dir($dir)) {
                    mkdir($dir, 0777, true);
                }

                if (!file_exists($new_file_path)) {
                    $content = file_get_contents($source_file_path);

                    if ($content !== false) {
                        $file_created = file_put_contents($new_file_path, $content);

                        if ($file_created !== false) {
                            echo json_encode(['success' => true, 'message' => 'File created successfully']);
                        } else {
                            echo json_encode(['success' => false, 'message' => 'File creation failed']);
                        }
                    } else {
                        echo json_encode(['success' => false, 'message' => 'Failed to read source file']);
                    }
                } else {
                    echo json_encode(['success' => false, 'message' => 'File already exists']);
                }
                exit;
            } else {
                echo json_encode(['success' => false, 'message' => 'Database update failed']);
                exit;
            }
        } else {
            echo json_encode(['success' => false, 'message' => 'Page already exists']);
            exit;
        }
    } else {
        echo json_encode(['success' => false, 'message' => 'Invalid request method']);
        exit;
    }
}
if ($_GET['page'] == 'delete_expage') {
    if ($_SERVER['REQUEST_METHOD'] === 'POST') {
        $page_key = trim($_POST['page_key']);

        if (empty($page_key)) {
            echo json_encode(['success' => false, 'message' => 'Page key is required']);
            exit;
        }
        $select_stmt = mysqli_prepare($DB_CONN, "SELECT extra_pages FROM preferences WHERE id = 1");
        mysqli_stmt_execute($select_stmt);
        $result = mysqli_stmt_get_result($select_stmt);

        $row_detail = mysqli_fetch_assoc($result);
        $extra_pages = json_decode($row_detail['extra_pages'], true) ?: [];

        if (isset($extra_pages[$page_key])) {
            $template_name = $extra_pages[$page_key]['template'];
            unset($extra_pages[$page_key]);
            $extra_pages_json = json_encode($extra_pages);
            $update_stmt = mysqli_prepare($DB_CONN, "UPDATE preferences SET extra_pages = ? WHERE id = 1");
            mysqli_stmt_bind_param($update_stmt, "s", $extra_pages_json);
            $update_success = mysqli_stmt_execute($update_stmt);

            if ($update_success) {
                $file_path = __DIR__ . '/tmpl/' . $template_name;
                if (file_exists($file_path)) {
                    unlink($file_path);
                }
                echo json_encode(['success' => true, 'message' => 'Page and template file deleted successfully']);
            } else {
                echo json_encode(['success' => false, 'message' => 'Database update failed']);
            }
        } else {
            echo json_encode(['success' => false, 'message' => 'Page not found']);
        }
    } else {
        echo json_encode(['success' => false, 'message' => 'Invalid request method']);
    }
    exit;
}
if ($_GET['page'] == 'add_category') {
    header('Content-Type: application/json');
    if ($_SERVER['REQUEST_METHOD'] == 'POST' && !empty($_POST['name'])) {
        $category_name = mysqli_real_escape_string($DB_CONN, $_POST['name']);
        
        // Generate slug
        $slug = strtolower(trim(preg_replace('/[^A-Za-z0-9-]+/', '-', $category_name)));
        
        // Ensure slug uniqueness
        $base_slug = $slug;
        $counter = 1;
        do {
            $check_query = "SELECT id FROM categories WHERE slug = '$slug'";
            $result = $DB_CONN->query($check_query);
            if ($result->num_rows > 0) {
                $slug = $base_slug . '-' . $counter;
                $counter++;
            } else {
                break;
            }
        } while (true);

        $query = "INSERT INTO categories (name, slug) VALUES ('$category_name', '$slug')";
        
        if ($DB_CONN->query($query)) {
            $new_category_id = $DB_CONN->insert_id;
            echo json_encode(['success' => true, 'id' => $new_category_id, 'slug' => $slug]);
                        updateSiteData($siteURL);
        } else {
            error_log("Error adding category: " . $DB_CONN->error);
            echo json_encode(['success' => false, 'error' => 'Database error']);
        }
    } else {
        echo json_encode(['success' => false, 'error' => 'Invalid request']);
    }
    exit;
}

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_GET['page']) && $_GET['page'] === 'upload_image') {
    // Set the upload directory
    $upload_dir = 'images/';
    
    // Ensure the upload directory exists
    if (!file_exists($upload_dir)) {
        mkdir($upload_dir, 0777, true);
    }
  $siteURL = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? "https" : "http") . "://$_SERVER[HTTP_HOST]";

    // Check if a file was uploaded
    if (isset($_FILES['file']) && $_FILES['file']['error'] === UPLOAD_ERR_OK) {
        $file = $_FILES['file'];
        
        // Generate a unique filename
        $filename = uniqid() . '_' . $file['name'];
        $filepath = $upload_dir . $filename;

        // List of allowed file extensions
        $allowed_extensions = ['jpg', 'jpeg', 'png', 'gif', 'webp'];
        
        // Get the file extension
        $file_extension = strtolower(pathinfo($filename, PATHINFO_EXTENSION));

        // Check if the file extension is allowed
        if (in_array($file_extension, $allowed_extensions)) {
            // Attempt to move the uploaded file to the upload directory
            if (move_uploaded_file($file['tmp_name'], $filepath)) {
                // File uploaded successfully
                 $response = [
                    'location' => $siteURL . '/' . $filepath // Full URL to the uploaded file
                ];
                echo json_encode($response);
                exit;
            } else {
                // Failed to move the file
                http_response_code(500);
                echo json_encode(['error' => 'Failed to save the file.']);
                exit;
            }
        } else {
            // Invalid file type
            http_response_code(400);
            echo json_encode(['error' => 'Invalid file type. Only JPG, JPEG, PNG, and GIF are allowed.']);
            exit;
        }
    } else {
        // No file uploaded or upload error
        http_response_code(400);
        echo json_encode(['error' => 'No file uploaded or upload error occurred.']);
        exit;
    }
} 
if ($_GET['page'] == 'get_products')
    {   
if (isset($_GET['id'])) {
    $id = $_GET['id'];
    $stmt = $DB_CONN->prepare("SELECT * FROM products WHERE id = ?");
    $stmt->bind_param("i", $id);
    $stmt->execute();
    $result = $stmt->get_result();
    $product = $result->fetch_assoc();
    
    header('Content-Type: application/json');
    echo json_encode($product);
    die();
} else {
    http_response_code(400);
    echo json_encode(['error' => 'No ID provided']);
}
}
if (isset($_GET['page']) && $_GET['page'] === 'delete_product' && isset($_GET['id'])) {
    $id = $_GET['id'];
    
    // Perform the deletion
    $stmt = $DB_CONN->prepare("DELETE FROM products WHERE id = ?");
    $stmt->bind_param("i", $id);
    $result = $stmt->execute();

    if ($result) {
        echo json_encode(['success' => true]);
    } else {
        echo json_encode(['success' => false, 'message' => 'Failed to delete product']);
    }
    exit;
}


if ($_GET['page'] == 'block_users_by_ip')
    {   

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $user_ids = $_POST['user_ids'] ?? [];
    $action = $_POST['action'] ?? '';

    if (!empty($user_ids) && !empty($action)) {
        $user_ids = array_map('intval', $user_ids);
        $user_ids_str = implode(",", $user_ids);

        // Define the SQL query to check current statuses
        $check_status_sql = "SELECT id,username, status, auto_withdraw FROM users WHERE id IN ($user_ids_str)";
        $result = mysqli_query($DB_CONN, $check_status_sql);
        $already_processed = [];
        $to_process = [];

        while ($row = mysqli_fetch_assoc($result)) {
            if ($action === 'block' && $row['status'] == 2) {
                $already_processed[] = $row['username'];
            } elseif ($action === 'suspend' && $row['auto_withdraw'] == 3) {
                $already_processed[] = $row['username'];
            } else {
                $to_process[] = $row['id'];
            }
        }

        if (!empty($to_process)) {
            $to_process_str = implode(",", $to_process);

            if ($action === 'block') {
                $sql = "UPDATE users SET status = 2 WHERE id IN ($to_process_str)";
                $message = "Users blocked successfully.";
            } elseif ($action === 'suspend') {
                $sql = "UPDATE users SET auto_withdraw = 3 WHERE id IN ($to_process_str)";
                $message = "Users suspended successfully.";
            } else {
                echo "Invalid action.";
                exit;
            }

            if (mysqli_query($DB_CONN, $sql)) {
                echo $message;
                if (!empty($already_processed)) {
                    echo " The following users were already " . $action . " usernames: " .  implode(", ", $already_processed);
                }
            } else {
                echo "Error updating users: " . mysqli_error($DB_CONN);
            }
        } else {
            echo "No users to process. ";
            if (!empty($already_processed)) {
               echo "All selected users were already " . $action . " usernames: " . implode(", ", $already_processed);
            }
        }
    } else {
        echo "No users selected or action specified.";
    }
    exit; // Ensure script stops after output
}
}
if ($_GET['page'] == 'ajax')
{
    header("Content-type: application/json");
    if ( $_GET['h'] == 'get_template_pop') 
{
    ob_start();
    $m = mysqli_query($DB_CONN, "SELECT id, name, subject, type, content, alerty  from email where id = '{$_POST['id']}'");
    while ($email = mysqli_fetch_assoc($m)) {
        
        ?>
    <tr>
        <th>Name</th>
         <td><?=$email['name']?></td>
    </tr>
    <tr>
        <th>Subject</th>
         <td><?=$email['subject']?></td>
    </tr>
    <tr>
        <th>Template</th>
         <td><?=$email['content']?></td>
    </tr>
    <tr>
        <th>Alert</th>
         <td><?=$email['alerty']?></td>
    </tr>
        <?
    
    }
    $data['data'] = ob_get_clean();
}
if ( $_GET['h'] == 'get_user_detail') {
    if(isset($_GET['user_id']))
{   
    $id = ($_GET['user_id']);
    $user = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT * from users where id = '{$id}'"));
    $user['balance'] = amount_format($user['balance']);
    ?>
    <tr>
        <th colspan="2" class="text-center"><?=$user['username']?></th>
    </tr>
    <tr>
        <th colspan="2" class="text-center"><?=$user['balance']?></th>
    </tr>
    <?
}    
}
if ( $_GET['h'] == 'expiring') 
{
    $_POST['last_id'] = isset($_POST['last_id']) ? $_POST['last_id'] : 0;
    $last_id = ($_POST['last_id']);
    $l = "";
    if($last_id) {
        $l = "and id < '{$last_id}'";
    }
    $f = "";
    if(isset($_POST['fake']) && $_POST['fake']) {
        $f .= " {$_POST['fake']}";
    }
    $or = "";
    if(isset($_POST['orderby']) && $_POST['orderby']) {
        $or .= " order by {$_POST['orderby']}";
    }
    $s = "";
    if(isset($_POST['show']) && $_POST['show']) {
        $s .= "{$_POST['show']}";
    }
    $us = "";
    if(isset($_POST['user']) && $_POST['user']) {
        $us .= " and user_id = {$_POST['user']}";
    }
    $p = "";
    if(isset($_POST['plan']) && $_POST['plan']) {
        $p .= " and package_id = {$_POST['plan']}";
    }
    $w = "";
    if(isset($_POST['status']) && $_POST['status']) {
        $w .= " and user_id IN (SELECT id from users WHERE status = '{$_POST['status']}') ";
    }
    if(isset($_POST['payment_method_id']) && count($_POST['payment_method_id'])) {
        $w .= " and payment_method_id in (".implode(",", $_POST['payment_method_id']).") ";
    }
    if(isset($_POST['search']) && $_POST['search']) {
        $_POST['search'] = str_replace(" ", "%", $_POST['search']);
        $w .= " and (amount like '%{$_POST['search']}%' or txn_id like '%{$_POST['search']}%' or package_deposits.id like '%{$_POST['search']}%') ";
    }
    $b = "SELECT  package_deposits.id,package_deposits.package_id,package_deposits.avail,package_deposits.plan_id, package_deposits.txn_id,package_deposits.user_id, package_deposits.payment_method_id,package_deposits.amount, package_deposits.status, package_deposits.last_earningDateTime, package_deposits.datetime, (SELECT users.username from users where id = package_deposits.user_id) as username,(SELECT users.sponsor from users where id = package_deposits.user_id) as sponsor, (SELECT users.email from users where id = package_deposits.user_id) as email 
    FROM `package_deposits` where status = 1 
    AND user_id {$f} 
    {$p}
    {$us}
    {$w}
    {$l}
    {$or} 
    LIMIT 0, {$s}";
   // echo $b;
    $d = mysqli_query($DB_CONN, "$b");
    ob_start();
    $l_id = 0;
    $sumprofit=0;
    $sumusers=0;
    while ($tx = mysqli_fetch_assoc($d)) {
        $l_id = $tx['id'];
        $sponsor = mysqli_fetch_assoc(mysqli_query($DB_CONN, "select username from users where id='{$tx['sponsor']}'"));
          $package = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT * from packages where id = '{$tx['package_id']}'"));
      $details = json_decode($package['details'], true);
      $plan = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT * from package_plans where id = '{$tx['plan_id']}'"));
      $rem = strtotime($tx['last_earningDateTime'])+(($package['duration'] - $package['avail'])*$package['diff_in_seconds'])-time();
      $next = strtotime($tx['last_earningDateTime'])+$package['diff_in_seconds'];
      $last_day = date('l', strtotime($tx['last_earningDateTime']));
      $exclude_days = array();
      if($package['earnings_mon_fri'] == 1) {
        if($last_day == 'Friday')
          $next += (86400*2);
        $exclude_days[] = 'Saturday';
        $exclude_days[] = 'Sunday';
      }
      $next_day = date('l', $next);
      if($package['earnings_mon_fri'] == 2) {
        $earning_days = json_decode($package['earning_days'], true);
        $days_loop = array('Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday');
        foreach ($days_loop as $day) {
          if($earning_days[$day] != 'on') {
            $exclude_days[] = $day;
            if($day == $next_day)
              $next += 86400;
          }
        }
      }
      $exclude_days = array_unique($exclude_days);
      $current_time = time();
      $dtCurrent = DateTime::createFromFormat('U', $current_time);
      $dtCreate = DateTime::createFromFormat('U', $next);
      $diff = $dtCurrent->diff($dtCreate);
      $interval = $diff->format("%d days %h hours %i minutes");
      $interval = preg_replace('/(^0| 0) (days|hours|minutes)/', '', $interval);
      $tx['expiry'] = date("F j, Y, g:i a", addDays($tx['datetime'], $package['duration'], $package['diff_in_seconds'], $exclude_days));
      $tx['last_earning_time'] = $tx['avail'] > 0 ? date("F j, Y, g:i a", strtotime($tx['last_earningDateTime'])) : 'N/A';
      $tx['next_earning_time'] =  date("F j, Y, g:i a", $next);
      $tx['next_earning'] = max($interval, 0);
      $tx['reinvest'] = $details['auto_reinvest'];
      $tx['datetime'] = date("F j, Y, g:i a", strtotime($tx['datetime']));
      $tx['profit'] = ($plan['percent_max'] / 100)*$tx['amount'];
      $sumprofit += $tx['profit'];
      $tx['total_profit'] = $tx['profit']*$package['duration'];
      $tx['percentage'] = $plan['percent_max'];
      $tx['total_percentage'] = $plan['percent_max']*$package['duration'];
      $tx['pname'] = $package['name'];
      $tx['amount'] = $tx['amount'];
      $tx['cid'] = $tx['payment_method_id'];
      $tx['fee'] = $tx['fee'];
      $tx['duration'] = $package['duration'];
      $earned = fiat(mysqli_fetch_array(mysqli_query($DB_CONN, "SELECT sum(amount) FROM `transactions` WHERE ref_id = '{$tx['id']}' and txn_type = 'earning'"))[0]);
      $tx['earned'] = $earned;
      $e = mysqli_query($DB_CONN, "SELECT * FROM `transactions` WHERE ref_id = '{$tx['id']}' and txn_type = 'earning' ");
      while ($earning = mysqli_fetch_assoc($e))
        $tx['earning'][] = $earning;
      $tx['allowprincipal'] = $package['allowprincipal'];
      $release = false;
      if($details['principal_release_period']) {
        $rt = strtotime($tx['datetime'])+($details['principal_release_period']*86400);
        if($rt <= time())
          $release = true;
        else
          $tx['release_time'] = date("F j, Y, g:i a", $rt);
      } else {
        foreach ($details['depositduration'] as $key => $duration) {
        $duration = (int)$duration;
        if($duration > 0) {
          if((strtotime($tx['datetime'])+($duration*86400)) <= time()) {
          $release = true;
          break;
        }}}
        if($details['depositduration'][0]) {
          $rt = strtotime($tx['datetime'])+($details['depositduration'][0]*86400);
          $tx['release_time'] = date("F j, Y, g:i a", $rt);
        }
      }
      $tx['release'] = $release;
?>
        
    <tr class="border-gray-500" >
            <td class="px-5 py-0  "  class="ps-0"><?=$tx['id']?></td>
            <td class="p-0">
    <div class="d-flex align-items-center">
        <!--begin::Name-->
        <div class="d-flex justify-content-start flex-column">
            <a  href="admin?page=user&id=<?=$tx['user_id']?>&view=overview" class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6">  <?=$tx['username']?></a>
            <a  href="admin?page=user&id=<?=$tx['user_id']?>&view=overview" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-9">
            <span class="text-gray-900">@</span>:   <?=$tx['email']?></a>
            <? if($tx['sponsor'] > 0) { ?>
             <a  href="admin?page=user&id=<?=$tx['sponsor']?>&view=overview" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-9">
            <span class="text-gray-900">Upline</span>:   <?=$sponsor['username']?></a>
            <? } ?>
        </div>
        <!--end::Name-->
    </div>
</td>       <td class="p-0">

        <div class="d-flex align-items-center">
            <!--begin::Avatar-->
            <div class="symbol symbol-30px me-5">
                <img alt="<?=$tx['cname']?>" src="images/icons/<?=$tx['payment_method_id']?>.svg" width="15px">
            </div>
            <!--end::Avatar-->
            <!--begin::Name-->
            <div class="d-flex justify-content-start flex-column">
                <a  href="#" class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6"><?php echo $tx['pname'] ?></a>
                <a  href="#" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                <span class="">Invested</span>:  <span class="badge badge-light-success fs-6 fw-bold"><?=fiat($tx['amount'])?></span></a>
                <a  href="#" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                <span class="">Next Profit</span>:<span class="badge badge-light-warning fs-6 fw-bold"><?php echo fiat($tx['profit']) ?></span></a>
                <a  href="<?=$tx['chain_url']?><?=$tx['txn_id']?>" target="_blank"><span class="badge badge-sm badge-light"><?php echo mb_substr($tx['txn_id'], 0, 6) ?></span></a>
            </div>
            <!--end::Name-->
        </div>
            
            </td >
           
           <td class="text-start">
                    <span class="text-gray-900 fw-bold d-block fs-7">
                        <?=$tx['avail'] ?>
                        /
                        <?=$tx['duration'] ?>
                    </span>
                    <span class="text-muted fw-bold d-block fs-8 text-gray-900">
                        <u>Next After<?=$tx['next_earning'] ?></u>
                    </span>
                    <span class="text-muted fw-semibold d-block fs-8">Next:<?=$tx['next_earning_time'] ?></span>
                    <span class="text-muted fw-semibold d-block fs-8">Last:<?=$tx['last_earning_time'] ?></span>
                </td>                                       
            
             <td class="text-start">
                    <span class="text-gray-900 fw-bold d-block fs-7"><?=$tx['expiry']?></span>
                    <span class="text-muted fw-semibold d-block fs-8">
                        <?php $dt = date("M d, Y h:i:s A", strtotime($tx['expiry']));
                            echo time_elapsed_string($dt, true); ?>
                    </span>
                </td>
            <td>
                    <span class="text-gray-900 fw-bold d-block fs-7"><?=$tx['datetime'] ?></span>
                    <span class="text-muted fw-semibold d-block fs-8">
                        <?php $dt = date("M d, Y h:i:s A", strtotime($tx['datetime']));
                            echo time_elapsed_string($dt, true); ?>
                    </span>
                </td>
        </tr>
        <?
    } ?>
     <tr>
        <td colspan="2"> Next Earnings Total</td>
        <td> <?=fiat($sumprofit)?></td>
        <td> Users</td>
        <td> <?=$sumusers?></td>
    </tr>   
    <? 
    $data['data'] = ob_get_clean();
    $data['last_id'] = $l_id;
}
if ( $_GET['h'] == 'transactions') 
{
    $_POST['last_id'] = isset($_POST['last_id']) ? $_POST['last_id'] : 0;
    $last_id = ($_POST['last_id']);
    $l = "";
    if($last_id) {
        $l = "and id < '{$last_id}'";
    }
    $f = "";
    if(isset($_POST['fake']) && $_POST['fake']) {
        $f .= " {$_POST['fake']}";
    }
    $w = "";
    if(isset($_POST['payment_method_id']) && count($_POST['payment_method_id'])) {
        $w .= " and payment_method_id in (".implode(",", $_POST['payment_method_id']).") ";
    }
    if(isset($_POST['search']) && $_POST['search']) {
        $_POST['search'] = str_replace(" ", "%", $_POST['search']);
        $w .= " and (amount like '%{$_POST['search']}%' or txn_id like '%{$_POST['search']}%' or .username like '%{$_POST['search']}%' or transactions.id like '%{$_POST['search']}%') ";
    }
    if(isset($_POST['txn_type']) && $_POST['txn_type']) {
        $w .= " and txn_type = '{$_POST['txn_type']}' ";
    }
    if(isset($_POST['start_date']) && $_POST['start_date']) {
        $w .= " and date(created_at) >= '{$_POST['start_date']}' ";
    }
    if(isset($_POST['end_date']) && $_POST['end_date']) {
        $w .= " and date(created_at) <= '{$_POST['end_date']}' ";
    }
    if(isset($_POST['user_id']) && $_POST['user_id']) {
        $w .= " and user_id = '{$_POST['user_id']}'";
    }

    $d = mysqli_query($DB_CONN, "SELECT transactions.id, transactions.timestamp, transactions.payment_method_id, transactions.amount, transactions.status, transactions.created_at, transactions.txn_id,transactions.fee, transactions.txn_type, transactions.user_id, transactions.detail, (SELECT users.username from users where id = transactions.user_id) as username, (SELECT users.email from users where id = transactions.user_id) as email, (SELECT currencies.name from currencies where id = transactions.payment_method_id) as currency, (SELECT currencies.chain_url from currencies where id = transactions.payment_method_id) as chain_url, (SELECT currencies.symbol from currencies where id = transactions.payment_method_id) as symbol, (SELECT packages.name from packages where id = transactions.package_id) as packagename
    FROM `transactions`
    WHERE user_id {$f}
        {$w}
        {$l}
        order by id desc
        LIMIT 0, 10");
        
    ob_start();
    $l_id = 0;
    while ($tx = mysqli_fetch_assoc($d)) {
        $l_id = $tx['id'];
        ?>
    <tr >
        <td class="px-5 py-0  border-gray-500" <?if($tx['txn_id']){?>rowspan="3"<?}else{?>rowspan="2"<?}?> class="ps-0"><?=$tx['id']?></td>
        <td class="p-0">
            <div class="d-flex align-items-center">
                <!--begin::Name-->
                <div class="d-flex justify-content-start flex-column">
                    <a  href="admin?page=user&id=<?=$tx['user_id']?>&view=overview" class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6">   <?=$tx['username']?></a>
                    <a  href="admin?page=user&id=<?=$tx['user_id']?>&view=overview" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-9">
                    <span class="text-gray-900">@</span>:   <?=$tx['email']?></a>
                </div>
                <!--end::Name-->
            </div>
        </td>                                           
          
        <td class="p-0">   
            <div class="d-flex align-items-center">
                <!--begin::Avatar-->
                <div class="symbol symbol-30px me-5">
                    <img alt="<?=$tx['cname']?>" src="images/icons/<?=$tx['payment_method_id']?>.svg" width="15px">
                </div>
                <!--end::Avatar-->
                <!--begin::Name-->
                <div class="d-flex justify-content-start flex-column">
                    <a  href="#" class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6">  <?=$tx['currency']?></a>
                    <a  href="#" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                    <span class="text-gray-900">Symbol</span>:  <?=$tx['symbol']?></a>
                </div>
                <!--end::Name-->
            </div>
            </td >
            <td class="p-0">
                <a   class="text-gray-900 fw-bold text-hover-primary d-block mb-1 fs-6"><?=fiat($tx['amount'])?></a>
                <span class="text-muted fw-semibold text-muted d-block fs-7">Fee: <?=fiat($tx['fee'])?></span>
            </td>
            <td class="p-0">
              <?  echo getBadge($tx['txn_type']); ?>
            </td>
            <td class="p-0">
            <span class="text-gray-900 fw-bold d-block fs-7"><?=$tx['timestamp']?></span>
            <span class="text-muted fw-semibold d-block fs-8"><?php $dt = date("M d, Y h:i:s A", strtotime($tx['timestamp'])); echo time_elapsed_string($dt, true);?></span>
        </td>

            </td>
            <td class="text-end p-0">
                <a  type="button" onclick="edit_transaction('<?=$tx['id']?>','<?=$tx['username']?>','<?=$tx['currency']?>','<?=$tx['txn_type']?>','<?=$tx['amount']?>','<?=$tx['detail']?>','<?=$tx['txn_id']?>','<?=$tx['status']?>')" class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm me-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Edit">
                    <i class="ki-duotone ki-pencil fs-2">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                </a>
            </td>
            
        </tr>
        <tr >
            <td class="pb-1 pt-1 <? if($tx['txn_id']){?>  <? }else{ ?>border-gray-500<? } ?>">Details</td>
              <td class="pb-1 pt-1 <? if($tx['txn_id']){?>  <? }else{ ?>border-gray-500<? } ?>" colspan="6">
                <span  class="badge badge-sm badge-light fs-12"><?=$tx['detail']?></span>
            </td>
                                       
        </tr>
    <? if($tx['txn_id']){?>
        <tr >
            <td class="pb-1 pt-1 border-gray-500">Transaction</td>
            <td class="pb-1 pt-1 border-gray-500" colspan="6" ><span class="text-muted fw-semibold text-muted  fs-7"><?=$tx['packagename']?>    <?      switch($tx['status']) {
        case '0':?>
                <span class="badge badge-light-info">Pending</span>
         <? ; break; case '1'     ?>    
            <span class="badge badge-light-success"> Done</span>
            <? ; break; }?></span><a  href="<?=$tx['chain_url']?><?=$tx['txn_id']?>" target="_blank"><span class="badge badge-sm badge-light"><?=$tx['txn_id']?></span></a></td>
            
        </tr>
        <?
    }}
    $data['data'] = ob_get_clean();
    $data['last_id'] = $l_id;
}
if ( $_GET['h'] == 'edit_transaction') 
{
    mysqli_query($DB_CONN, "UPDATE `transactions` SET `amount` = '{$_POST['amount']}', `detail` = '{$_POST['detail']}', `txn_id` = '{$_POST['txn_id']}' WHERE id = '{$_POST['id']}'");
    $data['status'] = true;
}

if ( $_GET['h'] == 'reviews') 
{
    $or = "";
    if(isset($_POST['orderby']) && $_POST['orderby']) {
        $or .= " order by {$_POST['orderby']}";
    }
    $s = "";
    if(isset($_POST['show']) && $_POST['show']) {
        $s .= "{$_POST['show']}";
    }
    $w = "";
    if(isset($_POST['status']) && $_POST['status'] > -1) {
        $w .= " and status = '{$_POST['status']}'";
    }
    $m = "SELECT *, (SELECT users.username from users WHERE id = reviews.user_id) as username FROM `reviews` where id
        {$w}
        {$or} 
        LIMIT 0, {$s}";
    $d = mysqli_query($DB_CONN, "$m");
    ob_start();
    while ($review = mysqli_fetch_assoc($d)) {
        ?>
    <tr>
        <td class="text-center"><?=$review['id']; ?> </td>
        <td data-bs-target="key" class="ps-0"><span class="text-gray-900 fw-bold d-block fs-6"><?=$review['review']?></span> 
            </td>
        <td class="text-center"><span class=" fw-bolder d-block fs-7"><u><?=$review['username']?></u></span></td>
        <td class="text-center"><? if($review['status'] == '1') {?> <span class="badge badge-light-success">Published</span> <? }else{?> <span class="badge badge-light-warning">Moderate</span> <? } ?></td>
        <td>
        <div class="d-flex justify-content-end flex-shrink-0">
            <a  type="button" href="?page=reviews&action=edit&id=<?=$review['id']?>" class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm me-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Edit">
                <i class="ki-duotone ki-pencil fs-2">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
            </a>
        </div>
    </td>
    </tr>
    <?
    }
    $data['data'] = ob_get_clean();
}
if ($_GET['h'] == 'add_review') {


    $user_id = isset($_POST['user_id']) ? intval($_POST['user_id']) : $_SESSION['user_id'];
    $product_id = intval($_POST['product_id']);
    $review = mysqli_real_escape_string($DB_CONN, trim($_POST['review']));
    $rating = floatval($_POST['rating']);
    $status = isset($_POST['status']) ? 1 : 0;

    // Validate inputs
    if (empty($product_id) || empty($review) || $rating < 0 || $rating > 5) {
        echo json_encode(['status' => false, 'message' => 'Invalid inputs']);
        exit;
    }

    // Prepare and execute the insert query
    $query = "INSERT INTO reviews 
              (user_id, product_id, review, status, rating, datetime) 
              VALUES 
              ('$user_id', '$product_id', '$review', '$status', '$rating', NOW())";
    
    $result = mysqli_query($DB_CONN, $query);

    if ($result) {
        echo json_encode([
            'status' => true, 
            'message' => 'Review added successfully',
            'id' => mysqli_insert_id($DB_CONN)
        ]);
    } else {
        echo json_encode([
            'status' => false, 
            'message' => 'Failed to add review',
            'error' => mysqli_error($DB_CONN)
        ]);
    }
    exit;
}
if ($_GET['h'] == 'get_users') {

    $query = "SELECT id, username FROM users ORDER BY username ASC";
    $result = mysqli_query($DB_CONN, $query);
    
    $users = [];
    while ($row = mysqli_fetch_assoc($result)) {
        $users[] = $row;
    }

    echo json_encode($users);
    exit;
}
if ($_GET['h'] == 'get_products') {

    $query = "SELECT id, name FROM products ORDER BY name ASC";
    $result = mysqli_query($DB_CONN, $query);
    
    $products = [];
    while ($row = mysqli_fetch_assoc($result)) {
        $products[] = $row;
    }

    echo json_encode($products);
    exit;
}
if ( $_GET['h'] == 'applications') 
{
    $or = "";
    if(isset($_POST['orderby']) && $_POST['orderby']) {
        $or .= " order by {$_POST['orderby']}";
    }
    $s = "";
    if(isset($_POST['show']) && $_POST['show']) {
        $s .= "{$_POST['show']}";
    }
    $w = "";
     if(isset($_POST['status']) && $_POST['status'] > -1) {
        $w .= " and status = '{$_POST['status']}'";
    }
    $m = "SELECT id, result, comment,status,timestamp,user_id,(SELECT users.fullname from users WHERE id = applications.user_id) as name,(SELECT users.email from users WHERE id = applications.user_id) as email, (SELECT users.username from users WHERE id = applications.user_id) as username,(SELECT tasks.name from tasks WHERE id = applications.task_id) as task FROM `applications` where id
        {$w}
        {$or} 
        LIMIT 0, {$s}";
    $d = mysqli_query($DB_CONN, "$m");

        ob_start();
    while ($task = mysqli_fetch_assoc($d)) {
            

        ?>
    <tr>
        
    <td class="text-center"><?=$task['id']; ?> </td>
        <td data-bs-target="key" class="ps-0"><span class="text-gray-900 fw-bold d-block fs-6"><?=$task['task']?></span> 
            
            </td>
     <td class="text-left"><div class="d-flex justify-content-start flex-column">
                                                                        <a  href="admin?page=user&id=<?=$task['user_id']?>&view=overview" class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6">   <?=$task['username']?></a>
                                                                        <a  href="admin?page=user&id=<?=$task['user_id']?>&view=overview" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-9">
                                                                        <span class="text-gray-900"></span>   <?=$task['name']?></a>
                                                                        <a  href="admin?page=user&id=<?=$task['user_id']?>&view=overview" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-9">
                                                                        <span class="text-gray-900">@:</span>   <?=$task['email']?></a>
                                                                    </div></td>    
    <td class="text-left"><span class=" fw-bolder d-block fs-7"><?=$task['result']?></span> <br><?=$task['comment']?>
    </td>
       
        <td class="text-center"><? if($task['status'] == '1') {?> <span class="badge badge-light-success">Published</span> <? }else{?> <span class="badge badge-light-warning">Moderate</span> <? } ?></td>
        <td>
                                                                <div class="d-flex justify-content-end flex-shrink-0">
                                                            
                                                                    <a  type="button" href="?page=applications&action=edit&id=<?=$task['id']?>" class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm me-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Edit">
                                                                        <i class="ki-duotone ki-pencil fs-2">
                                                                            <span class="path1"></span>
                                                                            <span class="path2"></span>
                                                                        </i>
                                                                    </a>
                                                                    
                                                                </div>
                                                            </td>
                                                            
                                                            
    
    </tr>
    <?
    }
    $data['data'] = ob_get_clean();
}
if ( $_GET['h'] == 'emails') 
{
    ob_start();
    $m = mysqli_query($DB_CONN, "SELECT * FROM `email` ORDER by type;");
    while ($email = mysqli_fetch_assoc($m)) {

        ?>
    <tr>
    <td class="text-center"><span class="badge badge-primary"><?=$email['type']?></span></td>
        <td data-bs-target="key" class="ps-0"><span class="text-gray-900 fw-bold d-block fs-6"><?=$email['subject']?></span> 
            <span class="text-dark fw-bolder d-block fs-7"><u><?=$email['name']?></u></span>
            </td>
        
    
        <td class="text-center"><?=$email['alerty']?></td>
        <td class="text-center"><?=$email['status'] ? '<span class="badge badge-light-success">Enabled</span>' : '<span class="badge badge-light-danger">Disabled</span>' ?></td>
        <td>
                                                                <div class="d-flex justify-content-end flex-shrink-0">
                                                                    <a  type="button" onclick="show_email('<?=$email['id']?>')" class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm me-1" data-bs-toggle="tooltip" data-bs-placement="top" title="View">
                                                                        <i class="ki-duotone ki-notepad fs-2">
                        <span class="path1"></span>
                <span class="path2"></span>
                <span class="path3"></span>
                <span class="path4"></span>
                <span class="path5"></span>
            </i>
                                                                    </a>
                                                                    <a  type="button" href="?page=templates&action=edit&id=<?=$email['id']?>" class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm me-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Edit">
                                                                        <i class="ki-duotone ki-pencil fs-2">
                                                                            <span class="path1"></span>
                                                                            <span class="path2"></span>
                                                                        </i>
                                                                    </a>
                                                                    
                                                                </div>
                                                            </td>
                                                            
                                                            
    
    </tr>
    <?
    }
    $data['data'] = ob_get_clean();
}
if ( $_GET['h'] == 'get_template_pop') 
{
    ob_start();
    $m = mysqli_query($DB_CONN, "SELECT id, name, subject, type, content, alerty  from email where id = '{$_POST['id']}'");
    while ($email = mysqli_fetch_assoc($m)) {
        
        ?>
    <tr>
        <th>Name</th>
         <td><?=$email['name']?></td>
    </tr>
    <tr>
        <th>Subject</th>
         <td><?=$email['subject']?></td>
    </tr>
    <tr>
        <th>Template</th>
         <td><?=$email['content']?></td>
    </tr>
    <tr>
        <th>Alert</th>
         <td><?=$email['alerty']?></td>
    </tr>
        <?
    
    }
    $data['data'] = ob_get_clean();
}
if ( $_GET['h'] == 'users') 
{
    $_POST['last_id'] = isset($_POST['last_id']) ? $_POST['last_id'] : 0;
    $last_id = ($_POST['last_id']);
    $l = "";
    if($last_id) {
        $l = "and id < '{$last_id}'";
    }
    $or = "";
    if(isset($_POST['orderby']) && $_POST['orderby']) {
        $or .= " order by {$_POST['orderby']}";
    }
    $f = "";
    if(isset($_POST['fake']) && $_POST['fake']) {
        $f .= " {$_POST['fake']}";
    }
    $s = "";
    if(isset($_POST['show']) && $_POST['show']) {
        $s .= "{$_POST['show']}";
    }
    $w = "";
    if(isset($_POST['status']) && $_POST['status']) {
        $w .= " and status = '{$_POST['status']}'";
    }
    if(isset($_POST['search']) && $_POST['search']) {
        $_POST['search'] = str_replace(" ", "%", $_POST['search']);
        $w .= " and (username like '%{$_POST['search']}%' or email like '%{$_POST['search']}%' or oauth_uid like '%{$_POST['search']}%' or id like '%{$_POST['search']}%')  ";
    }
    $b = "SELECT users.id, users.username, users.fullname, users.email, users.sponsor, users.2fa, users.earnings,users.auto_withdraw, users.status,users.oauth_uid,users.oauth_provider,users.kyc, users.wi_pm_id, users.created_at ,(SELECT sum(amount) FROM `transactions` where txn_type = 'referral' AND user_id = users.id) as referral, (SELECT sum(amount) FROM `transactions` where txn_type = 'invest' AND user_id = users.id) as invest,(SELECT sum(amount) FROM `package_deposits` where STATUS = '1' AND user_id = users.id) as activeinvest, (SELECT sum(amount) FROM `transactions` where txn_type = 'withdraw' AND user_id = users.id) as withdraw, (SELECT sum(amount) FROM `transactions` where txn_type = 'earning' AND user_id = users.id) as earnings, (SELECT sum(balance) FROM `user_balances` where user_id = users.id) as balance, (SELECT sum(faucet) FROM `user_balances` where user_id = users.id) as faucet, (SELECT name FROM `payment_methods` where id = users.wi_pm_id) as processor 
    FROM `users` WHERE id != 1
    and id {$f}
        {$w}
        {$l}
        {$or} 
        LIMIT 0, {$s}";
    $d = mysqli_query($DB_CONN, "$b");
    ob_start();
    $l_id = 0;
    while ($u = mysqli_fetch_assoc($d)) {
        $l_id = $u['id'];
      
        ?>

    <tr class="<?=($u['status'] == 0 ? "bg-hover-light-warning" :     ($u['status'] == 1 ? "bg-hover-light-primary" :     ($u['status'] == 2 ? "bg-hover-light-danger" : "")));?>">
            <td class="ps-0"><?=$u['id']?> </td>
            <td>
<div class="d-flex align-items-center">


<!--begin::Name-->
<div class="d-flex justify-content-start flex-column">
    
<a  href="admin?page=user&id=<?=$u['id']?>&view=overview" class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6"> <?=$u['username']?> <?php if ($u['invest'] && $u['activeinvest']) {?>
                                                            
                                                                    <i class="ki-duotone ki-dollar fs-2 text-success" title="Active Investment">
                                                                        <span class="path1"></span>
                                                                        <span class="path2"></span>
                                                                        <span class="path3"></span>
                                                                    </i>
                                                            
                                                                <? }elseif($u['invest']){ ?>
                                                            
                                                                    <i class="ki-duotone ki-dollar fs-2" title="Invested">
                                                                        <span class="path1"></span>
                                                                        <span class="path2"></span>
                                                                        <span class="path3"></span>
                                                                    </i>
                                                            
                                                                <?} if($u['kyc'] == '1'){ ?>                                                            
                                                                    <i class="ki-duotone ki-fingerprint-scanning fs-2 text-success" title="KYC">
                                                                         <span class="path1"></span>
                                                                         <span class="path2"></span>
                                                                         <span class="path3"></span>
                                                                         <span class="path4"></span>
                                                                         <span class="path5"></span>
                                                                    </i>
                                                            
                                                                <? }?><? if($u['oauth_uid']) {?> <span class="badge badge-light-primary badge-sm"><?=$u['oauth_uid']?></span> <? } ?></a>
<a  href="#" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
<span class="text-gray-900">Name</span>:    <?=$u['fullname']?>  </a>
    <a  href="#" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
<span class="text-gray-900">Email</span>:   <?=$u['email']?></a>
<a  href="admin?page=user&id=<?=$u['sponsor']?>&view=overview" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
<span class="text-gray-900">Sponsor</span>:     <?php echo get_username($u['sponsor']) ? : 'N/A'; ?></a> 
<? if(BINARY_MODE) { ?>
<a href="admin?page=user&id=<?=$u['parent']?>&view=overview" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
<span class="text-gray-900">Parent</span>:     <?php echo get_username($u['parent']) ? : 'N/A'; ?></a>  
<a href="#" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
<span class="text-gray-900">Side</span>:     <?php echo $u['side'] ?: 'N/A'; ?></a>
<? } ?>
<a  href="admin?page=user&id=<?=$u['sponsor']?>&view=overview" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
<span class="text-gray-900">Created  </span>: <? echo date("M d, Y  ", strtotime($u['created_at'])) ?></a> 

</div>
<!--end::Name-->
</div>
</td>

<td>
   <div class="d-flex align-items-center">
        <div class="flex-grow-1">
            <a  class="text-gray-800 text-hover-primary fw-bold fs-6">Balance</a>
        </div>
        <span class="badge badge-light-success fs-8 fw-bold"><?=fiat($u['balance'])?></span>
    </div>
    <div class="d-flex align-items-center">
        <div class="flex-grow-1">
            <a  class="text-gray-800 text-hover-primary fw-bold fs-6">Earnings</a>
        </div>
        <span class="badge badge-light-primary fs-8 fw-bold"><?=fiat($u['earnings'])?></span>
    </div>
    <div class="d-flex align-items-center">
        <div class="flex-grow-1">
            <a  class="text-gray-800 text-hover-primary fw-bold fs-6">Withdrew</a>
        </div>
        <span class="badge badge-light-warning fs-8 fw-bold"><?=fiat($u['withdraw'])?></span>
    </div>
    <div class="d-flex align-items-center">
        <div class="flex-grow-1">
            <a  class="text-gray-800 text-hover-primary fw-bold fs-6">Funded</a>
        </div>
        <span class="badge badge-light-info fs-8 fw-bold"><?=fiat($u['invest'])?></span>
    </div>
    <div class="d-flex align-items-center">
        <div class="flex-grow-1">
            <a  class="text-gray-800 text-hover-primary fw-bold fs-6">Commission</a>
        </div>
        <span class="badge badge-light-secondary fs-8 fw-bold"><?=fiat($u['referral'])?></span>
    </div>



</td>
                                                        
          
        <td>
    <div class="d-flex align-items-center">
        <div class="flex-grow-1">
        <span class="text-gray-800 fw-semibold text-muted fw-bold fs-6">Status</span>
        </div> <?=($u['status'] == 0 ? "<span class='badge badge-light-warning'>InActive</span>" :     ($u['status'] == 1 ? "<span class='badge badge-light-success'>Active</span>" :     ($u['status'] == 2 ? "<span class='badge badge-light-danger'>Blocked</span>" : "")));?>
    </div>
    <div class="d-flex align-items-center">
        <div class="flex-grow-1">
        <span class="text-gray-800 fw-semibold text-muted fw-bold fs-6">2FA</span>
        </div>  <?=$u['2fa'] ? "<span class='badge badge-light-success'>Enabled</span>" : "<span class='badge badge-light-danger'>Disabled</span>"?>
    </div>  <div class="d-flex align-items-center">
        <div class="flex-grow-1">
        <span class="text-gray-800 fw-semibold text-muted  fw-bold fs-6">Withdraw</span>
        </div>  <? if($u['auto_withdraw'] == "0"){    echo "<span class='badge badge-light-primary'>Default</span>";} elseif($u['auto_withdraw'] == "2"){    echo "<span class='badge badge-light-success'>Auto</span>";} elseif($u['auto_withdraw'] == "1"){    echo "<span class='badge badge-light-warning'>Fake</span>";}?>
    </div>
    <div class="d-flex align-items-center">
        <div class="flex-grow-1">
        <span class="text-gray-800 fw-semibold text-muted fw-bold fs-6">Processor</span>
        </div> <? if($u['processor']) { ?> <span class="badge badge-light-warning"> <?=$u['processor']  ?></span> <? } else {?> <span class="badge badge-light-primary">Default</span> <? } ?>  
    </div>
    
    
</td>       <td class="text-end">
                                                                            
    <div class="d-flex justify-content-end flex-shrink-0">
        
        <a  type="button" href="admin?page=user&id=<?=$u['id']?>&view=overview" class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm me-1" data-bs-toggle="tooltip" data-bs-placement="top" title="View">
            <i class="ki-duotone ki-notepad fs-2">
                        <span class="path1"></span>
                <span class="path2"></span>
                <span class="path3"></span>
                <span class="path4"></span>
                <span class="path5"></span>
            </i>
        </a>
        
        <a  href="admin?page=user&id=<?=$u['id']?>&view=edit" class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm me-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Edit">
            <i class="ki-duotone ki-pencil fs-2">
                <span class="path1"></span>
                <span class="path2"></span>
            </i>
        </a>
        <? if($u['status'] == "1"){ ?>  
        <a   onclick="ban_user('<?=$u['id']?>')" type="button" class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm me-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Block">
            <i class="ki-duotone ki-eye-slash fs-2">
                <span class="path1"></span>
                <span class="path2"></span>
            </i>
        </a>
        <? } elseif($u['status'] == "2") { ?>
        <a   onclick="unban_user('<?=$u['id']?>')" type="button" class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm me-1" data-bs-toggle="tooltip" data-bs-placement="top" title="UnBlock">
            <i class="ki-duotone ki-shield fs-2">
                <span class="path1"></span>
                <span class="path2"></span>
            </i>
        </a>
        <? } ?>
        <a  onclick="del_user('<?=$u['id']?>')" type="button" class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="Delete">
            <i class="ki-duotone ki-trash fs-2"> 
                <span class="path1"></span>
                <span class="path2"></span>
                <span class="path3"></span>
                <span class="path4"></span>
                <span class="path5"></span>
            </i>
        </a>
    </div>
                </td>       
        
            </td>
        </tr>
        <?
    }
    $data['data'] = ob_get_clean();
    $data['last_id'] = $l_id;
}
if ( $_GET['h'] == 'del_user') 
{
    if(mysqli_query($DB_CONN, "DELETE FROM `users` WHERE id = '{$_POST['id']}'"))
        $data['status'] = true;
    else
        $data['status'] = false;
}
if ( $_GET['h'] == 'ban_user') 
{
    if(mysqli_query($DB_CONN, "UPDATE `users` SET status = 2 WHERE id = '{$_POST['id']}'"))
        $data['status'] = true;
    else
        $data['status'] = false;
}
if ( $_GET['h'] == 'unban_user') 
{
    if(mysqli_query($DB_CONN, "UPDATE `users` SET status = 1 WHERE id = '{$_POST['id']}'"))
        $data['status'] = true;
    else
        $data['status'] = false;
}
if ( $_GET['h'] == 'currencies') 
{
    ob_start();
    $m = mysqli_query($DB_CONN, "SELECT *, (SELECT name from payment_methods WHERE id = currencies.de_pm_id) as deposit, (SELECT name from payment_methods WHERE id = currencies.wi_pm_id) as withdraw FROM `currencies` ORDER BY  ID;");
    while ($c = mysqli_fetch_assoc($m)) {

        ?>
    <tr>
            <td>
                
            <div class="d-flex align-items-center">
                <!--begin::Avatar-->
                <div class="symbol symbol-45px me-5">
                    <img alt="<?=$c['name']?>" src="images/icons/<?=$c['id']?>.svg" width="15px">
                </div>
                <!--end::Avatar-->
                <!--begin::Name-->
                <div class="d-flex justify-content-start flex-column">
                    <a  href="#" class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6">  <?=$c['name']?></a>
                    <a  href="#" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                    <span class="text-gray-900">Symbol</span>:  <?=$c['symbol']?></a>
                </div>
                <!--end::Name-->
            </div>
            
            </td>
            <td>
                <a  href="#" class="text-gray-900 fw-bold text-hover-primary d-block mb-1 fs-6">$<?=$c['rate']?></a>
                <span class="text-muted fw-semibold text-muted d-block fs-7"></span>
            </td>
        <td data-bs-target="key" class="ps-0"><span class="text-gray-900 fw-bold d-block fs-6"><span class='badge badge-lg badge-light-primary'><?=$c['deposit']?></span></span> 
            </td>
            <td data-bs-target="key" class="ps-0"><span class="text-gray-900 fw-bold d-block fs-6"><span class='badge badge-lg badge-light-info'><?=$c['withdraw']?></span></span> 
            </td>
        
    <td>
    <div class="d-flex align-items-center">
    
    
        <!--begin::Name-->
        <div class="d-flex justify-content-start flex-column">
        <a  class="text-gray-900 fw-bold text-hover-primary d-block mb-1 fs-6"><span class="text-muted fw-semibold text-muted  fs-7">Deposit</span>: <?=$c['de_pm_id'] ? "<span class='badge badge-light-success'>Enabled</span>" : "<span class='badge badge-light-danger'>Disabled</span>"?></a>
        <a  class="text-gray-900 fw-bold text-hover-primary d-block mb-1 fs-6"><span class="text-muted fw-semibold text-muted  fs-7">Withdraw</span>: <?=$c['wi_pm_id'] ? "<span class='badge badge-light-success'>Enabled</span>" : "<span class='badge badge-light-danger'>Disabled</span>"?></a>
    
    </div>
        <!--end::Name-->
    </div>
</td>
        <td>
      <div class="d-flex justify-content-end flex-shrink-0">
    <a type="button" onclick="show_currency('<?=$c['id']?>','<?=$c['name']?>','<?=$c['symbol']?>','<?=$c['rate']?>')" class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm me-1" data-bs-toggle="tooltip" data-bs-placement="top" title="View">
        <i class="ki-duotone ki-notepad fs-2">
            <span class="path1"></span>
            <span class="path2"></span>
        </i>
    </a>
    <a type="button" onclick="edit_currency('<?=$c['id']?>','<?=$c['name']?>','<?=$c['ticker']?>','<?=$c['symbol']?>','<?=$c['rate']?>','<?=$c['dep_min']?>','<?=$c['dep_max']?>','<?=$c['dep_fee_per']?>','<?=$c['dep_fee_amount']?>','<?=$c['dep_fee_min']?>','<?=$c['dep_fee_max']?>','<?=$c['address']?>','<?=$c['with_min']?>','<?=$c['with_max']?>','<?=$c['with_fee_per']?>','<?=$c['with_fee_amount']?>','<?=$c['with_fee_min']?>','<?=$c['with_fee_max']?>','<?=$c['transfer_min']?>','<?=$c['transfer_max']?>','<?=$c['transfer_fee_per']?>','<?=$c['transfer_fee_amount']?>','<?=$c['transfer_fee_min']?>','<?=$c['transfer_fee_max']?>','<?=$c['de_pm_id']?>','<?=$c['wi_pm_id']?>','<?=$c['pms']?>','<?=$c['wpms']?>','<?=$c['is_p']?>')" class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm me-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Edit">
        <i class="ki-duotone ki-pencil fs-2">
            <span class="path1"></span>
            <span class="path2"></span>
        </i>
    </a>
    <?php if(!$c['is_p']) { ?>
    <a type="button" onclick="copy_currency('<?=$c['id']?>','<?=$c['name']?>')" class="btn btn-icon btn-bg-light btn-active-color-warning btn-sm me-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Create Practice Wallet">
        <i class="ki-duotone ki-copy fs-2">
            <span class="path1"></span>
            <span class="path2"></span>
        </i>
    </a>
    <?php } ?>
    <?php if($c['is_p']) { ?>
    <a type="button" onclick="delete_currency('<?=$c['id']?>','<?=$c['name']?>')" class="btn btn-icon btn-bg-light btn-active-color-danger btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="Delete Practice Wallet">
        <i class="ki-duotone ki-trash fs-2">
            <span class="path1"></span>
            <span class="path2"></span>
        </i>
    </a>
    <?php } ?>
</div>
    </td>
    
    </tr>
    <?
    }
    $data['data'] = ob_get_clean();
}
if ($_GET['h'] == 'copy_currency') {
    // Get the source currency details
    $source = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT * FROM currencies WHERE id = '{$_POST['id']}'"));
    
    // Create new practice wallet name
    $practice_name = $source['name'] . ' Practice';
    
    // Insert new currency record
    $query = "INSERT INTO currencies 
        (name, symbol, rate, dep_min, dep_max, dep_fee_per, dep_fee_amount, dep_fee_min, dep_fee_max,
        address, with_min, with_max, with_fee_per, with_fee_amount, with_fee_min, with_fee_max,
        transfer_min, transfer_max, transfer_fee_per, transfer_fee_amount, transfer_fee_min, 
        transfer_fee_max, de_pm_id, wi_pm_id, is_p)
        VALUES 
        ('$practice_name', '{$source['symbol']}', '{$source['rate']}', 
        '{$source['dep_min']}', '{$source['dep_max']}', '{$source['dep_fee_per']}', 
        '{$source['dep_fee_amount']}', '{$source['dep_fee_min']}', '{$source['dep_fee_max']}',
        '{$source['address']}', '{$source['with_min']}', '{$source['with_max']}', 
        '{$source['with_fee_per']}', '{$source['with_fee_amount']}', '{$source['with_fee_min']}', 
        '{$source['with_fee_max']}', '{$source['transfer_min']}', '{$source['transfer_max']}', 
        '{$source['transfer_fee_per']}', '{$source['transfer_fee_amount']}', 
        '{$source['transfer_fee_min']}', '{$source['transfer_fee_max']}', 
        '{$source['de_pm_id']}', '{$source['wi_pm_id']}', '1')";
    
    mysqli_query($DB_CONN, $query);
    $new_id = mysqli_insert_id($DB_CONN);
    
    // Copy the icon file
    copy("images/icons/{$source['id']}.svg", "images/icons/{$new_id}.svg");
    
    $data['status'] = true;
    $data['message'] = "Practice wallet created successfully";
}
if ( $_GET['h'] == 'edit_currency') 
{
    mysqli_query($DB_CONN, "UPDATE `currencies` SET `name` = '{$_POST['name']}', `ticker` = '{$_POST['ticker']}', `dep_min` = '{$_POST['dep_min']}', `dep_max` = '{$_POST['dep_max']}', `dep_fee_per` = '{$_POST['dep_fee_per']}', `dep_fee_amount` = '{$_POST['dep_fee_amount']}', `dep_fee_min` = '{$_POST['dep_fee_min']}', `dep_fee_max` = '{$_POST['dep_fee_max']}',`address` = '{$_POST['address']}', `with_min` = '{$_POST['with_min']}', `with_max` = '{$_POST['with_max']}', `with_fee_per` = '{$_POST['with_fee_per']}', `with_fee_amount` = '{$_POST['with_fee_amount']}', `with_fee_min` = '{$_POST['with_fee_min']}', `with_fee_max` = '{$_POST['with_fee_max']}', `transfer_min` = '{$_POST['transfer_min']}', `transfer_max` = '{$_POST['transfer_max']}', `transfer_fee_per` = '{$_POST['transfer_fee_per']}', `transfer_fee_amount` = '{$_POST['transfer_fee_amount']}', `transfer_fee_min` = '{$_POST['transfer_fee_min']}', `transfer_fee_max` = '{$_POST['transfer_fee_max']}',  `de_pm_id` = '{$_POST['de_pm_id']}', `wi_pm_id` = '{$_POST['wi_pm_id']}', `is_p` = '{$_POST['is_p']}'  WHERE id = '{$_POST['id']}'");
        $data['status'] = true;
    
}
if ($_GET['h'] == 'delete_currency') {
    // First check if it's a practice wallet
    $currency = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT * FROM currencies WHERE id = '{$_POST['id']}'"));
    
    if ($currency['is_p']) {
        // Delete the icon file
        @unlink("images/icons/{$_POST['id']}.svg");
        
        // Delete the currency record
        mysqli_query($DB_CONN, "DELETE FROM currencies WHERE id = '{$_POST['id']}' AND is_p = 1");
        
        $data['status'] = true;
        $data['message'] = "Practice wallet deleted successfully";
    } else {
        $data['status'] = false;
        $data['message'] = "Only practice wallets can be deleted";
    }
}
if ( $_GET['h'] == 'get_currency_pop') 
{
    ob_start();
    $m = mysqli_query($DB_CONN, "SELECT id, name, symbol, rate, dep_fee_per, dep_fee_amount, dep_fee_min, dep_fee_max, dep_min, dep_max, with_fee_per, with_fee_amount, with_fee_min, with_fee_max, with_min, with_max, (SELECT name FROM payment_methods WHERE id = currencies.de_pm_id) as deposit, (SELECT name FROM payment_methods WHERE id = currencies.wi_pm_id) as withdraw from currencies where id  = '{$_POST['id']}'");
    while ($c = mysqli_fetch_assoc($m)) {
        
        ?>
        
        <tr>
            <th class="title text-center text-primary" colspan="4">Deposit</th>
        </tr>
        <tr>
            <th class="title" colspan="2">Deposit Settings:</th>
             <th class="title" colspan="2"><?if($c['deposit'] == NULL) {?><span class="badge badge-light-danger">Disabled</span><? }?><span class="badge badge-light-success"><?=$c['deposit']?></span></th>
        </tr>
        <tr>
            <th class="title text-center" colspan="4">Deposit Limits</th>
        </tr>
        <tr>
            <th style="width: 30%">Min ($)</th>
            <td style="width: 20%" class="text-end"><?=$c['dep_min']?></td>
            <th style="width: 30%">Max ($)</th>
            <td style="width: 20%" class="text-end"><?=$c['dep_max']?></td>
        </tr>
        <tr>
            <th class="title  text-center" colspan="4">Deposit Fees</th>
        </tr>
        <tr>
            <th>Fee (%)</th>
            <td class="text-end"><?=$c['dep_fee_per']?></td>
            <th>Additional Fee ($)</th>
            <td class="text-end"><?=$c['dep_fee_amount']?></td>
        </tr>
        <tr>
            <th>Min ($)</th>
            <td class="text-end"><?=$c['dep_fee_min']?></td>
            <th>Max ($)</th>
            <td class="text-end"><?=$c['dep_fee_max']?></td>
        </tr>
            <tr>
            <th class="title text-center text-info" colspan="4">Withdraw</th>
        </tr>
        <tr>
            <th class="title" colspan="2">Withdraw Settings</th>
             <th class="title" colspan="2"><?if($c['withdraw'] == NULL) {?><span class="badge badge-light-danger">Disabled</span><? }?><span class="badge badge-light-success"><?=$c['withdraw']?></span></th>
        </tr>
         <tr>
            <th class="title  text-center" colspan="4">Withdraw Limits</th>
        </tr>
        <tr>
            <th>Min ($)</th>
            <td class="text-end"><?=$c['with_min']?></td>
            <th>Max ($)</th>
            <td class="text-end"><?=$c['with_max']?></td>
        </tr>
        <tr>
            <th class="title  text-center" colspan="4">Withdraw Fees</th>
        </tr>
        <tr>
            <th>Fee (%)</th>
            <td class="text-end"><?=$c['with_fee_per']?></td>
            <th>Additional Fee ($)</th>
            <td class="text-end"><?=$c['with_fee_amount']?></td>
        </tr>
        <tr>
            <th>Min ($)</th>
            <td class="text-end"><?=$c['with_fee_min']?></td>
            <th>Max ($)</th>
            <td class="text-end"><?=$c['with_fee_max']?></td>
        </tr>




        <?
    
    }
    $data['data'] = ob_get_clean();
}
echo json_encode($data);
    die();
}
?>  
<!DOCTYPE html>

<html lang="en">
    <!--begin::Head-->
    <head>
<base/>
       <title>  <?php    $page = $_GET['page'] ? str_replace('_', ' ', $_GET['page']) : 'Dashboard';    echo ucwords($page) . ' | ' . $preferences['title'] . ' | Bitders';    ?></title>
        <meta charset="utf-8" />
        <meta name="description" content="Bitders Admin Panel" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta property="og:locale" content="en_US" />
        <meta property="og:type" content="article" />
        <meta property="og:title" content="https://BitDers.com" />
        <meta property="og:url" content="https://BitDers.com" />
        <meta property="og:site_name" content="$$$ By Bitders" />
        <link rel="shortcut icon" type="image/svg+xml" href="bitders/assets/logo.svg">
        <link rel="shortcut icon" type="image/png" href="bitders/assets/logo.png">
        <!--begin::Fonts(mandatory for all pages)-->
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700" />
        <!--end::Fonts-->
    
        <!--begin::Global Stylesheets Bundle(mandatory for all pages)-->
        <link href="bitders/assets/plugins.bundle.css" rel="stylesheet" type="text/css" />
        <link href="bitders/assets/style.bundle.css" rel="stylesheet" type="text/css" />
        <!--end::Global Stylesheets Bundle-->
                <script src="bitders/assets/plugins.bundle.js"></script>
        <script src="bitders/assets/scripts.bundle.js"></script>
            <style>
    .image-input-placeholder {
        background-image: url('bitders/assets/placeholder.svg');
    }

    [data-bs-theme="dark"] .image-input-placeholder {
        background-image: url('bitders/assets/placeholder.svg');
    }
</style>
        <script>// Frame-bus;lnmcvkkting to prevent site from being loaded within a frame without permission (click-jacking) if (window.top != window.self) { window.top.location.replace(window.self.location.href); }</script>
    </head>
    <!--end::Head-->
    <!--begin::Body-->
    <body id="kt_app_body" data-kt-app-layout="dark-sidebar" data-kt-app-header-fixed="true" data-kt-app-sidebar-enabled="true" data-kt-app-sidebar-fixed="true" data-kt-app-sidebar-hoverable="true" data-kt-app-sidebar-push-header="true" data-kt-app-sidebar-push-toolbar="true" data-kt-app-sidebar-push-footer="true" data-kt-app-toolbar-enabled="true" class="app-default">
        <!--begin::Theme mode setup on page load-->
        <script>var defaultThemeMode = "light"; var themeMode; if ( document.documentElement ) { if ( document.documentElement.hasAttribute("data-bs-theme-mode")) { themeMode = document.documentElement.getAttribute("data-bs-theme-mode"); } else { if ( localStorage.getItem("data-bs-theme") !== null ) { themeMode = localStorage.getItem("data-bs-theme"); } else { themeMode = defaultThemeMode; } } if (themeMode === "system") { themeMode = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light"; } document.documentElement.setAttribute("data-bs-theme", themeMode); }</script>
        <!--end::Theme mode setup on page load-->
        <!--begin::App-->
        <div class="d-flex flex-column flex-root app-root" id="kt_app_root">
            <!--begin::Page-->
            <div class="app-page flex-column flex-column-fluid" id="kt_app_page">
                <!--begin::Header-->
                <div id="kt_app_header" class="app-header" data-kt-sticky="true" data-kt-sticky-activate="{default: true, lg: true}" data-kt-sticky-name="app-header-minimize" data-kt-sticky-offset="{default: '200px', lg: '0'}" data-kt-sticky-animation="false">
                    <!--begin::Header container-->
                    <div class="app-container container-fluid d-flex align-items-stretch justify-content-between" id="kt_app_header_container">
                        <!--begin::Sidebar mobile toggle-->
                        <div class="d-flex align-items-center d-lg-none ms-n3 me-1 me-md-2" title="Show sidebar menu">
                            <div class="btn btn-icon btn-active-color-primary w-35px h-35px" id="kt_app_sidebar_mobile_toggle">
                                <i class="ki-duotone ki-abstract-14 fs-2 fs-md-1">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                            </div>
                        </div>
                        <!--end::Sidebar mobile toggle-->
                        <!--begin::Mobile logo-->
                        <div class="d-flex align-items-center flex-grow-1 flex-lg-grow-0">
                            <a  href="bitders" class="d-lg-none">
                                <img alt="Logo" src="bitders/assets/logo.svg" class="h-30px" />
                            </a>
                        </div>
                        <!--end::Mobile logo-->
                        <!--begin::Header wrapper-->
                        <div class="d-flex align-items-stretch justify-content-between flex-lg-grow-1" id="kt_app_header_wrapper">
                            <!--begin::Menu wrapper-->
                            <div class="app-header-menu app-header-mobile-drawer align-items-stretch" data-kt-drawer="true" data-kt-drawer-name="app-header-menu" data-kt-drawer-activate="{default: true, lg: false}" data-kt-drawer-overlay="true" data-kt-drawer-width="250px" data-kt-drawer-direction="end" data-kt-drawer-toggle="#kt_app_header_menu_toggle" data-kt-swapper="true" data-kt-swapper-mode="{default: 'append', lg: 'prepend'}" data-kt-swapper-parent="{default: '#kt_app_body', lg: '#kt_app_header_wrapper'}">
                                <!--begin::Menu-->
                                <div class="menu menu-rounded menu-column menu-lg-row my-5 my-lg-0 align-items-stretch fw-semibold px-2 px-lg-0" id="kt_app_header_menu" data-kt-menu="true">
                                    <!--begin:Menu item-->
                                    <a  href="admin?page=transaction"  class="menu-item  px-5">
                                        <!--begin:Menu link-->
                                        <span class="menu-link p-0">
                                         
                                            <span class="d-flex flex-column">
                                                <span class=" fs-7 fw-semibold text-muted">Add </span>
                                                <span class="fs-6 fw-bold text-gray-800">Transaction</span>
                                            </span>
                                        <span class="badge badge-primary ms-2">+</span>
                                        </span>
                                        <!--end:Menu link-->
                                        <!--begin:Menu sub-->
                                    
                                        <!--end:Menu sub-->
                                    </a>
                                    <a  href="admin?page=users"  class="menu-item  px-5">
                                        <!--begin:Menu link-->
                                        <span class="menu-link p-0">
                                            <span class="d-flex flex-column">
                                            <span class="fs-7 fw-semibold text-muted ">Active </span>
                                            <span class="fs-6 fw-bold text-gray-800">Users</span>
                                        </span>
                                        
                                        <span class="badge badge-success ms-2"><?php $ausers= mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT count(id) as c FROM `users` where status = '1' and id != '1'")) ['c'];   echo number_format($ausers) ?></span>
                                        </span>
                                        <!--end:Menu link-->
                                        <!--begin:Menu sub-->
                                    
                                        <!--end:Menu sub-->
                                    </a>
                                        <!--begin:Menu item-->
                                    <a  href="admin?page=pending_withdrawals"  class="menu-item  px-5">
                                        <!--begin:Menu link-->
                                        <span class="menu-link p-0">
                                            <span class="d-flex flex-column">
                                            <span class="fs-7 fw-semibold text-muted ">Pending </span>
                                            <span class="fs-6 fw-bold text-gray-800">Withdrawals</span>
                                        </span>
                                        
                                        <span class="badge badge-danger ms-2"><?php $pending_withdraw = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT count(id) as c FROM `transactions` where txn_type = 'withdraw' and status = 0")) ['c']; echo number_format($pending_withdraw) ?></span>
                                        </span>
                                        <!--end:Menu link-->
                                        <!--begin:Menu sub-->
                                    
                                        <!--end:Menu sub-->
                                    </a>
                                    
                                    <a  href="admin?page=pending_investments"  class="menu-item px-5">
                                        <!--begin:Menu link-->
                                        <span class="menu-link p-0">
                                          
                                            <span class="d-flex flex-column">
                                                                            <span class="fs-7 fw-semibold text-muted ">Pending </span>
                                                                            <span class="fs-6 fw-bold text-gray-800">Investments</span>
                                                                        </span>
                                        <span class="badge badge-warning ms-2"><?php $pending_investments = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT count(id) as c FROM `package_deposits` where txn_id = '' and status = 0")) ['c'];     echo number_format($pending_investments) ?></span>
                                        </span>
                                        <!--end:Menu link-->
                                        <!--begin:Menu sub-->
                                    
                                        <!--end:Menu sub-->
                                    </a>
                                     <? if ($kyc_settings['enable']){ ?>
                                    <a  href="admin?page=pending_kyc"  class="menu-item px-5">
                                        <!--begin:Menu link-->
                                        <span class="menu-link p-0">
                                          
                                            <span class="d-flex flex-column">
                                                <span class="fs-7 fw-semibold text-muted ">Pending </span>
                                                <span class="fs-6 fw-bold text-gray-800">KYC</span>
                                            </span>
                                        <span class="badge badge-warning ms-2"><?php $pending_kyc = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT count(id) as c FROM `users` WHERE kyc = 2")) ['c'];    echo number_format($pending_kyc) ?></span>
                                        </span>
                                        <!--end:Menu sub-->
                                    </a>
                                    <? } if ($user_settings['support']){ ?>
                                    
                                    <a  href="admin?page=support"  class="menu-item px-5">
                                        <!--begin:Menu link-->
                                        <span class="menu-link p-0">
                                            <span class="d-flex flex-column">
                                                <span class="fs-7 fw-semibold text-muted ">Support </span>
                                                <span class="fs-6 fw-bold text-gray-800">Tickets</span>
                                            </span>
                                        <span class="badge badge-info ms-2"><?php $pending_tickets = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT count(id) as c FROM tickets where status != '2'")) ['c'];    echo number_format($pending_tickets) ?></span>
                                        </span>
                                        <!--end:Menu link-->
                                        <!--begin:Menu sub-->
                                    
                                        <!--end:Menu sub-->
                                    </a>
                                    <!--end:Menu item-->
                                <? } if ($user_settings['reviews']){ ?>
                                    <a  href="admin?page=reviews"  class="menu-item px-5">
                                        <!--begin:Menu link-->
                                        <span class="menu-link p-0">
                                            <span class="d-flex flex-column">
                                                <span class="fs-7 fw-semibold text-muted ">Pending </span>
                                                <span class="fs-6 fw-bold text-gray-800">Reviews</span>
                                            </span>
                                        <span class="badge badge-info ms-2"><?php $pending_reviews = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT count(id) as c FROM reviews where status = '0'")) ['c'];     echo number_format($pending_reviews) ?></span>
                                        </span>
                                    </a>
                                    <!--end:Menu item-->
                                    <? } if (true){ ?>
                                    <a  href="admin?page=rewards"  class="menu-item px-5">
                                        <!--begin:Menu link-->
                                        <span class="menu-link p-0">
                                            <span class="d-flex flex-column">
                                                <span class="fs-7 fw-semibold text-muted ">Pending </span>
                                                <span class="fs-6 fw-bold text-gray-800">Rewards</span>
                                            </span>
                                        <span class="badge badge-info ms-2"><?php $pending_rewards = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT count(id) as c FROM `distributor_rewards` WHERE status = 'pending'")) ['c'];     echo number_format($pending_rewards) ?></span>
                                        </span>
                                    </a>
                                    <!--end:Menu item-->
                                    <? }?>
                                </div>
                                <!--end::Menu-->
                            </div>
                            <!--end::Menu wrapper-->
                            <!--begin::Navbar-->
                            <div class="app-navbar flex-shrink-0">
                                <!--begin::Search-->
                                <div class="app-navbar-item align-items-stretch ms-1 ms-md-4">
                                    <!--begin::Search-->
                                
                                    <!--end::Search-->
                                </div>
                                <!--end::Search-->
                                <!--begin::Notifications-->
                            <div class="app-navbar-item ms-1 ms-md-4">
                                    <!--begin::Menu- wrapper-->
                                    <div class="btn btn-icon btn-custom btn-icon-muted btn-active-light btn-active-color-primary w-35px h-35px" data-kt-menu-trigger="{default: 'click', lg: 'hover'}" data-kt-menu-attach="parent" data-kt-menu-placement="bottom-end" id="kt_menu_item_wow">
                                        <i class="ki-duotone ki-notification-status fs-2">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                            <span class="path3"></span>
                                            <span class="path4"></span>
                                        </i>
                                    </div>
                                    <!--begin::Menu-->
                                    <div class="menu menu-sub menu-sub-dropdown menu-column w-350px w-lg-375px" data-kt-menu="true" id="kt_menu_notifications" style="">
                                        <!--begin::Heading-->
                                        <div class="d-flex flex-column bgi-no-repeat rounded-top" style="">
                                            <!--begin::Title-->
                                            <h3 class="text-white fw-semibold px-9 mt-10 mb-6">Notifications 
                                            <span class="fs-8 opacity-75 ps-3"></span></h3>
                                            <!--end::Title-->
                                            <!--begin::Tabs-->
                                            <ul class="nav nav-line-tabs nav-line-tabs-2x nav-stretch fw-semibold px-9" role="tablist">
                                                <li class="nav-item" role="presentation">
                                                    <a  class="nav-link text-white opacity-75 opacity-state-100 pb-4" data-bs-toggle="tab" href="#kt_topbar_notifications_1" aria-selected="false" tabindex="-1" role="tab">Alerts</a>
                                                </li>
                                                <li class="nav-item" role="presentation">
                                                    <a  class="nav-link text-white opacity-75 opacity-state-100 pb-4 active" data-bs-toggle="tab" href="#kt_topbar_notifications_2" aria-selected="true" role="tab">Updates</a>
                                                </li>
                                                <li class="nav-item" role="presentation">
                                                    <a  class="nav-link text-white opacity-75 opacity-state-100 pb-4" data-bs-toggle="tab" href="#kt_topbar_notifications_3" aria-selected="false" tabindex="-1" role="tab">Logs</a>
                                                </li>
                                            </ul>
                                            <!--end::Tabs-->
                                        </div>
                                        <!--end::Heading-->
                                        <!--begin::Tab content-->
                                        <div class="tab-content">
                                            <!--begin::Tab panel-->
                                            <div class="tab-pane fade" id="kt_topbar_notifications_1" role="tabpanel">
                                                <!--begin::Items-->
                                                <div class="scroll-y mh-325px my-5 px-8">
                                                    <!--begin::Item-->
                                                    <div class="d-flex flex-stack py-4">
                                                        <!--begin::Section-->
                                                        <div class="d-flex align-items-center">
                                                            <!--begin::Symbol-->
                                                            <div class="symbol symbol-35px me-4">
                                                                <span class="symbol-label bg-light-primary">
                                                                    <i class="ki-duotone ki-abstract-28 fs-2 text-primary">
                                                                        <span class="path1"></span>
                                                                        <span class="path2"></span>
                                                                    </i>
                                                                </span>
                                                            </div>
                                                            <!--end::Symbol-->
                                                            <!--begin::Title-->
                                                            <div class="mb-0 me-2">
                                                                <a  href="#" class="fs-6 text-gray-800 text-hover-primary fw-bold">No Alerts</a>
                                                                <div class="text-gray-500 fs-7">No System Alerts</div>
                                                            </div>
                                                            <!--end::Title-->
                                                        </div>
                                                        <!--end::Section-->
                                                        <!--begin::Label-->
                                                        <span class="badge badge-light fs-8"></span>
                                                        <!--end::Label-->
                                                    </div>
                                                    <!--end::Item-->
                                    
                                                    <!--end::Item-->
                                                </div>
                                                <!--end::Items-->
                                                <!--begin::View more-->
                                                
                                                <!--end::View more-->
                                            </div>
                                            <!--end::Tab panel-->
                                            <!--begin::Tab panel-->
                                            <div class="tab-pane fade show active" id="kt_topbar_notifications_2" role="tabpanel">
                                                <!--begin::Wrapper-->
                                                <div class="d-flex flex-column px-9">
                                                    <!--begin::Section-->
                                                    <div class="pt-10 pb-0">
                                                        <!--begin::Title-->
                                                        <h3 class="text-gray-900 text-center fw-bold">Get Pro Access</h3>
                                                        <!--end::Title-->
                                                        <!--begin::Text-->
                                                        <div class="text-center text-gray-600 fw-semibold pt-1">Outlines keep you honest. They stoping you from amazing poorly about drive</div>
                                                        <!--end::Text-->
                                                        <!--begin::Action-->
                                                        <div class="text-center mt-5 mb-9">
                                                            <a  href="https://bitders.com" class="btn btn-sm btn-primary px-6" >Upgrade</a>
                                                        </div>
                                                        <!--end::Action-->
                                                    </div>
                                                    <!--end::Section-->
                                                    <!--begin::Illustration-->
                                                    <div class="text-center px-4">
                                                    
                                                    </div>
                                                    <!--end::Illustration-->
                                                </div>
                                                <!--end::Wrapper-->
                                            </div>
                                            <!--end::Tab panel-->
                                            <!--begin::Tab panel-->
                                            <div class="tab-pane fade" id="kt_topbar_notifications_3" role="tabpanel">
                                                <!--begin::Items-->
                                                <div class="scroll-y mh-325px my-5 px-8">
                                                     <?php
        $l = mysqli_query($DB_CONN, "select *,(select username from users where id =login_report.user_id ) as username, (select email from users where id = login_report.user_id ) as email from login_report where user_id = '1' order by id desc limit 10");
        while ($login = mysqli_fetch_assoc($l))
        {
?>
                                                    <!--begin::Item-->
                                                    <div class="d-flex flex-stack py-4">
                                                        <!--begin::Section-->
                                                        <div class="d-flex align-items-center me-2">
                                                            <!--begin::Code-->
                                                            <span class="w-70px badge badge-light-success me-4">LOGGED OK</span>
                                                            <!--end::Code-->
                                                            <!--begin::Title-->
                                                            <a  href="#" class="text-gray-800 text-hover-primary fw-semibold"><?=$login['country']?>-<?=$login['os']?>-<?=$login['ip']?></a>
                                                            <!--end::Title-->
                                                        </div>
                                                        <!--end::Section-->
                                                        <!--begin::Label-->
                                                        <span class="badge badge-light fs-8"><?php $dt = date("M d, Y h:i:s A", strtotime($login['datetime']));
            echo time_elapsed_string($dt, true); ?></span>
                                                        <!--end::Label-->
                                                    </div>
                                                    <!--end::Item-->
                            <? } ?>
                                                </div>
                                                <!--end::Items-->
                                                <!--begin::View more-->
                                                <div class="py-3 text-center border-top">
                                                    <a  href="admin?page=login_reports" class="btn btn-color-gray-600 btn-active-color-primary">View All 
                                                    <i class="ki-duotone ki-arrow-right fs-5">
                                                        <span class="path1"></span>
                                                        <span class="path2"></span>
                                                    </i></a>
                                                </div>
                                                <!--end::View more-->
                                            </div>
                                            <!--end::Tab panel-->
                                        </div>
                                        <!--end::Tab content-->
                                    </div>
                                    <!--end::Menu-->
                                    <!--end::Menu wrapper-->
                                </div>
                                <!--end::Notifications-->
                                <!--begin::Chat-->
                                
                                <!--end::Chat-->
                                <!--begin::My apps links-->
                            
                                <!--end::My apps links-->
                                <!--begin::Theme mode-->
                                <div class="app-navbar-item ms-1 ms-md-4">
                                    <!--begin::Menu toggle-->
                                    <a  href="#" class="btn btn-icon btn-custom btn-icon-muted btn-active-light btn-active-color-primary w-35px h-35px" data-kt-menu-trigger="{default:'click', lg: 'hover'}" data-kt-menu-attach="parent" data-kt-menu-placement="bottom-end">
                                        <i class="ki-duotone ki-night-day theme-light-show fs-1">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                            <span class="path3"></span>
                                            <span class="path4"></span>
                                            <span class="path5"></span>
                                            <span class="path6"></span>
                                            <span class="path7"></span>
                                            <span class="path8"></span>
                                            <span class="path9"></span>
                                            <span class="path10"></span>
                                        </i>
                                        <i class="ki-duotone ki-moon theme-dark-show fs-1">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                        </i>
                                    </a>
                                    <!--begin::Menu toggle-->
                                    <!--begin::Menu-->
                                    <div class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-title-gray-700 menu-icon-gray-500 menu-active-bg menu-state-color fw-semibold py-4 fs-base w-150px" data-kt-menu="true" data-kt-element="theme-mode-menu">
                                        <!--begin::Menu item-->
                                        <div class="menu-item px-3 my-0">
                                            <a  href="#" class="menu-link px-3 py-2" data-kt-element="mode" data-kt-value="light">
                                                <span class="menu-icon" data-kt-element="icon">
                                                    <i class="ki-duotone ki-night-day fs-2">
                                                        <span class="path1"></span>
                                                        <span class="path2"></span>
                                                        <span class="path3"></span>
                                                        <span class="path4"></span>
                                                        <span class="path5"></span>
                                                        <span class="path6"></span>
                                                        <span class="path7"></span>
                                                        <span class="path8"></span>
                                                        <span class="path9"></span>
                                                        <span class="path10"></span>
                                                    </i>
                                                </span>
                                                <span class="menu-title">Light</span>
                                            </a>
                                        </div>
                                        <!--end::Menu item-->
                                        <!--begin::Menu item-->
                                        <div class="menu-item px-3 my-0">
                                            <a  href="#" class="menu-link px-3 py-2" data-kt-element="mode" data-kt-value="dark">
                                                <span class="menu-icon" data-kt-element="icon">
                                                    <i class="ki-duotone ki-moon fs-2">
                                                        <span class="path1"></span>
                                                        <span class="path2"></span>
                                                    </i>
                                                </span>
                                                <span class="menu-title">Dark</span>
                                            </a>
                                        </div>
                                        <!--end::Menu item-->
                                        <!--begin::Menu item-->
                                        <div class="menu-item px-3 my-0">
                                            <a  href="#" class="menu-link px-3 py-2" data-kt-element="mode" data-kt-value="system">
                                                <span class="menu-icon" data-kt-element="icon">
                                                    <i class="ki-duotone ki-screen fs-2">
                                                        <span class="path1"></span>
                                                        <span class="path2"></span>
                                                        <span class="path3"></span>
                                                        <span class="path4"></span>
                                                    </i>
                                                </span>
                                                <span class="menu-title">System</span>
                                            </a>
                                        </div>
                                        <!--end::Menu item-->
                                    </div>
                                    <!--end::Menu-->
                                </div>
                                <!--end::Theme mode-->
                                <!--begin::User menu-->
                                <div class="app-navbar-item ms-1 ms-md-4" id="kt_header_user_menu_toggle">
                                    <!--begin::Menu wrapper-->
                                    <div class="cursor-pointer symbol symbol-35px" data-kt-menu-trigger="{default: 'click', lg: 'hover'}" data-kt-menu-attach="parent" data-kt-menu-placement="bottom-end">
                                        <img src="bitders/assets/logo.svg" class="rounded-3" alt="user" />
                                    </div>
                                    <!--begin::User account menu-->
                                    <div class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-800 menu-state-bg menu-state-color fw-semibold py-4 fs-6 w-275px" data-kt-menu="true">
                                        <!--begin::Menu item-->
                                        <div class="menu-item px-3">
                                            <div class="menu-content d-flex align-items-center px-3">
                                                <!--begin::Avatar-->
                                                <div class="symbol symbol-50px me-5">
                                                    <img alt="Logo" src="bitders/assets/logo.svg" />
                                                </div>
                                                <!--end::Avatar-->
                                                <!--begin::Username-->
                                                <div class="d-flex flex-column">
                                                    <div class="fw-bold d-flex align-items-center fs-5">Admin
                                                    <span class="badge badge-light-success fw-bold fs-8 px-2 py-1 ms-2">Bitders</span></div>
                                                
                                                </div>
                                                <!--end::Username-->
                                            </div>
                                        </div>
                                    
                                        <!--end::Menu item-->
                                        <!--begin::Menu item-->
                                        <div class="menu-item px-5 my-1">
                                            <a  href="admin?page=admin" class="menu-link px-5" >Account Settings</a>
                                        </div>
                                        
                                            <div class="menu-item px-5 my-1">
                                              
                                        </div>
                                        <!--end::Menu item-->
                                        <!--begin::Menu item-->
                                        <div class="menu-item px-5">
                                            <a  href="logout" class="menu-link px-5">Sign Out</a>
                                        </div>
                                        <!--end::Menu item-->
                                    </div>
                                    <!--end::User account menu-->
                                    <!--end::Menu wrapper-->
                                </div>
                                <!--end::User menu-->
                                <!--begin::Header menu toggle-->
                                <div class="app-navbar-item d-lg-none ms-2 me-n2" title="Show header menu">
                                    <div class="btn btn-flex btn-icon btn-active-color-primary w-30px h-30px" id="kt_app_header_menu_toggle">
                                        <i class="ki-duotone ki-element-4 fs-1">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                        </i>
                                    </div>
                                </div>
                                <!--end::Header menu toggle-->
                                <!--begin::Aside toggle-->
                                <!--end::Header menu toggle-->
                            </div>
                            <!--end::Navbar-->
                        </div>
                        <!--end::Header wrapper-->
                    </div>
                    <!--end::Header container-->
                </div>
                <!--end::Header-->
                <!--begin::Wrapper-->
                <div class="app-wrapper flex-column flex-row-fluid" id="kt_app_wrapper">
                    <!--begin::Sidebar-->
                    <div id="kt_app_sidebar" class="app-sidebar flex-column" data-kt-drawer="true" data-kt-drawer-name="app-sidebar" data-kt-drawer-activate="{default: true, lg: false}" data-kt-drawer-overlay="true" data-kt-drawer-width="225px" data-kt-drawer-direction="start" data-kt-drawer-toggle="#kt_app_sidebar_mobile_toggle">
                        <!--begin::Logo-->
                        <div class="app-sidebar-logo px-6" id="kt_app_sidebar_logo">
                            <!--begin::Logo image-->
                            <a  href="/admin">
                                <img alt="Logo" src="bitders/assets/logo.svg" class="h-25px app-sidebar-logo-default" />
                                <img alt="Logo" src="bitders/assets/logo.svg" class="h-20px app-sidebar-logo-minimize" />
                            </a>
                            <!--end::Logo image-->
                            <!--begin::Sidebar toggle-->
                            <!--begin::Minimized sidebar setup:
            if (isset($_COOKIE["sidebar_minimize_state"]) && $_COOKIE["sidebar_minimize_state"] === "on") { 
                1. "src/js/layout/sidebar.js" adds "sidebar_minimize_state" cookie value to save the sidebar minimize state.
                2. Set data-kt-app-sidebar-minimize="on" attribute for body tag.
                3. Set data-kt-toggle-state="active" attribute to the toggle element with "kt_app_sidebar_toggle" id.
                4. Add "active" class to to sidebar toggle element with "kt_app_sidebar_toggle" id.
            }
        -->
                            <div id="kt_app_sidebar_toggle" class="app-sidebar-toggle btn btn-icon btn-shadow btn-sm btn-color-muted btn-active-color-primary h-30px w-30px position-absolute top-50 start-100 translate-middle rotate" data-kt-toggle="true" data-kt-toggle-state="active" data-kt-toggle-target="body" data-kt-toggle-name="app-sidebar-minimize">
                                <i class="ki-duotone ki-black-left-line fs-3 rotate-180">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                            </div>
                            <!--end::Sidebar toggle-->
                        </div>
                        <!--end::Logo-->
                        <!--begin::sidebar menu-->
                <div class="app-sidebar-menu overflow-hidden flex-column-fluid">
    <!--begin::Menu wrapper-->
    <div id="kt_app_sidebar_menu_wrapper" class="app-sidebar-wrapper">
        <!--begin::Scroll wrapper-->
        <div
            id="kt_app_sidebar_menu_scroll"
            class="scroll-y my-5 mx-3"
            data-kt-scroll="true"
            data-kt-scroll-activate="true"
            data-kt-scroll-height="auto"
            data-kt-scroll-dependencies="#kt_app_sidebar_logo, #kt_app_sidebar_footer"
            data-kt-scroll-wrappers="#kt_app_sidebar_menu"
            data-kt-scroll-offset="5px"
            data-kt-scroll-save-state="true"
        >
            <!--begin::Menu-->
            <div class="menu menu-column menu-rounded menu-sub-indention fw-semibold fs-6" id="#kt_app_sidebar_menu" data-kt-menu="true" data-kt-menu-expand="true">
                <!--begin:Menu item-->
                <div data-kt-menu-trigger="click" class="menu-item menu-accordion <?php echo (($_SERVER["REQUEST_URI"] === "/admin") ? "show here" : "") ?> <?=(($_GET['page'] == 'performance' || $_GET['page'] == 'pending_investments' || $_GET['page'] == 'expiring_investments' || $_GET['page'] == 'pending_withdrawals') ? "show here" : "") ?>">
                    <!--begin:Menu link-->
                    <span class="menu-link">
                        <span class="menu-icon">
                            <i class="ki-duotone ki-home fs-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                                <span class="path4"></span>
                            </i>
                        </span>
                        <span class="menu-title">Dashboard</span>
                        <span class="menu-arrow"></span>
                    </span>
                    <!--end:Menu link-->
                    <!--begin:Menu sub-->
                    <div class="menu-sub menu-sub-accordion">
                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?php echo (($_SERVER["REQUEST_URI"] === "/admin") ? "active" : "") ?>" href="admin">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Dashboard</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=performance") ? "active" : "") ?>" href="admin?page=performance">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Performance</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        
                          <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=expiring_investments") ? "active" : "") ?>" href="admin?page=expiring_investments">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Expiring Investments</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                        <!--begin:Menu item-->

                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=pending_investments") ? "active" : "") ?>" href="admin?page=pending_investments">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Pending Investments</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=pending_withdrawals") ? "active" : "") ?>" href="admin?page=pending_withdrawals">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Pending Withdrawals</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                         <? if ($kyc_settings['enable']){ ?>
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=pending_kyc") ? "active" : "") ?>" href="admin?page=pending_kyc">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Pending KYC</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <? } ?>
                        <!--end:Menu item-->
                    </div>
                    <!--end:Menu sub-->
                </div>
                <!--end:Menu item-->
                <!--begin:Menu item-->
                <div class="menu-item pt-5">
                    <!--begin:Menu content-->
                    <div class="menu-content">
                        <span class="menu-heading fw-bold text-uppercase fs-7">Plans</span>
                    </div>
                    <!--end:Menu content-->
                </div>
                <!--end:Menu item-->
                <!--begin:Menu item-->
                <div data-kt-menu-trigger="click" class="menu-item menu-accordion <?=(($_GET['page'] == 'plans' || $_GET['page'] == 'plans' || $_GET['page'] == 'holidays') ? "show here" : "") ?>">
                    <!--begin:Menu link-->
                    <span class="menu-link">
                        <span class="menu-icon">
                            <i class="ki-duotone ki-graph fs-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                            </i>
                        </span>
                        <span class="menu-title">Investment Plans</span>
                        <span class="menu-arrow"></span>
                    </span>
                    <!--end:Menu link-->
                    <!--begin:Menu sub-->
                    <div class="menu-sub menu-sub-accordion">
                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=plans") ? "active" : "") ?>" href="admin?page=plans">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Investment Plans</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=plans") ? "active" : "") ?>" href="admin?page=plans&action=edit">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Add New</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=holidays") ? "active" : "") ?>" href="admin?page=holidays">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Earning Holidays</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                 <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=earnings") ? "active" : "") ?>" href="admin?page=earnings">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Issue Earnings </span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--begin:Menu item-->
                    </div>
                    <!--end:Menu sub-->
                </div>
                <!--end:Menu item-->
                <!--begin:Menu item-->
                      <!--begin:Menu item-->
                <div data-kt-menu-trigger="click" class="menu-item menu-accordion <?=(($_GET['page'] == 'games' || $_GET['page'] == 'gameslog' ) ? "show here" : "") ?>">
                    <!--begin:Menu link-->
                    <span class="menu-link">
                        <span class="menu-icon">
                            <i class="ki-duotone ki-calculator fs-2">
                                <span class="path1"></span>
                                 <span class="path2"></span>
                                 <span class="path3"></span>
                                 <span class="path4"></span>
                                 <span class="path5"></span>
                                 <span class="path6"></span>
                            </i>
                        </span>
                        <span class="menu-title">Games</span>
                        <span class="menu-arrow"></span>
                    </span>
                    <!--end:Menu link-->
                    <!--begin:Menu sub-->
                    <div class="menu-sub menu-sub-accordion">
                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=games") ? "active" : "") ?>" href="admin?page=games">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Games</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=gameslog") ? "active" : "") ?>" href="admin?page=gameslog">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Games Logs</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                      
               
                        <!--begin:Menu item-->
                    </div>
                    <!--end:Menu sub-->
                </div>
                 <div data-kt-menu-trigger="click" class="menu-item menu-accordion <?=(($_GET['page'] == 'tasks' || $_GET['page'] == 'applications' ) ? "show here" : "") ?>">
                    <!--begin:Menu link-->
                    <span class="menu-link">
                        <span class="menu-icon">
                            <i class="ki-duotone ki-cup fs-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                        </span>
                        <span class="menu-title">Tasks/Bounty</span>
                        <span class="menu-arrow"></span>
                    </span>
                    <!--end:Menu link-->
                    <!--begin:Menu sub-->
                    <div class="menu-sub menu-sub-accordion">
                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=tasks") ? "active" : "") ?>" href="admin?page=tasks">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">All Tasks/Bounties</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=tasks&action=edit") ? "active" : "") ?>" href="admin?page=tasks&action=edit">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Add Task/Bounty</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=applications") ? "active" : "") ?>" href="admin?page=applications">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Applications</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                      
               
                        <!--begin:Menu item-->
                    </div>
                    <!--end:Menu sub-->
                </div>
                <!--end:Menu item-->
                <!--begin:Menu item-->
                 <div class="menu-item pt-5">
                    <!--begin:Menu content-->
                    <div class="menu-content">
                        <span class="menu-heading fw-bold text-uppercase fs-7">Management</span>
                    </div>
                    <!--end:Menu content-->
                </div>
                <!--begin:Menu item-->
                <div data-kt-menu-trigger="click" class="menu-item menu-accordion <?=(($_GET['page'] == 'users' || $_GET['page'] == 'top_refer' || $_GET['page'] == 'ip_checks' || $_GET['page'] == 'login_reports') ? "show here" : "") ?>">
                    <!--begin:Menu link-->
                    <span class="menu-link">
                        <span class="menu-icon">
                            <i class="ki-duotone ki-people fs-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                                <span class="path4"></span>
                            </i>
                        </span>
                        <span class="menu-title">Users</span>
                        <span class="menu-arrow"></span>
                    </span>
                    <!--end:Menu link-->
                    <!--begin:Menu sub-->
                    <div class="menu-sub menu-sub-accordion">
                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=users") ? "active" : "") ?>" href="admin?page=users">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Users</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=users&status=2") ? "active" : "") ?>" href="admin?page=users&status=2">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Blocked Accounts</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                        <!--begin:Menu item-->
                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "admin?page=top_refer") ? "active" : "") ?>" href="admin?page=top_refer">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Top Referral Earnings</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                        <!--begin:Menu item-->
                        <!--begin:Menu item-->
                        <!--begin:Menu item-->
                        <!--end:Menu item-->
                        <!--begin:Menu item-->

                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=ip_checks") ? "active" : "") ?>" href="/admin?page=ip_checks">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Users IP Check</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=login_reports") ? "active" : "") ?>" href="/admin?page=login_reports">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Login History</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                         <? if ($kyc_settings['enable']){ ?>
                          <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=kyc") ? "active" : "") ?>" href="/admin?page=kyc">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Users KYC</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                        <? } ?>
                    </div>
                    <!--end:Menu sub-->
                </div>
                <!--end:Menu item-->
                <!--begin:Menu item-->

                <!--begin:Menu item-->
                <div data-kt-menu-trigger="click" class="menu-item menu-accordion  <?=(($_GET['page'] == 'transactions') ? "show here" : "") ?>">
                    <!--begin:Menu link-->
                    <span class="menu-link">
                        <span class="menu-icon">
                            <i class="ki-duotone ki-book fs-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                                <span class="path4"></span>
                            </i>
                        </span>
                        <span class="menu-title">Transactions</span>
                        <span class="menu-arrow"></span>
                    </span>
                    <!--end:Menu link-->
                    <!--begin:Menu sub-->
                    <div class="menu-sub menu-sub-accordion">
                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=transactions") ? "active" : "") ?>" href="admin?page=transactions">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Transactions</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/bitders/currencies") ? "active" : "") ?>" href="admin?page=transactions&txn_type=invest">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Deposits</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/bitders/currencies") ? "active" : "") ?>" href="admin?page=transactions&txn_type=earning">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Earnings</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                        <? if(BINARY_MODE) { ?>
                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "admin?page=transactions&txn_type=binary") ? "active" : "") ?>" href="admin?page=transactions&txn_type=binary">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Binary</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                        <? } ?>
                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/bitders/currencies") ? "active" : "") ?>" href="admin?page=transactions&txn_type=withdraw">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Withdrawals</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/bitders/currencies") ? "active" : "") ?>" href="admin?page=transactions&txn_type=invest">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Referrals</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                        
                         <? if ($exchange_settings['enable']){ ?>
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/bitders/currencies") ? "active" : "") ?>" href="admin?page=transactions&txn_type=exchange">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Exchanges</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        
                         <? } if ($transfer_settings['enable']){ ?>
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/bitders/currencies") ? "active" : "") ?>" href="admin?page=transactions&txn_type=transfer">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Transfers</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <? } ?>
                    </div>
                    <!--end:Menu sub-->
                </div>
                <!--end:Menu item-->
                <div class="menu-item pt-5">
                    <!--begin:Menu content-->
                    <div class="menu-content">
                        <span class="menu-heading fw-bold text-uppercase fs-7">Settings</span>
                    </div>
                    <!--end:Menu content-->
                </div>
                <!--begin:Menu item-->
                <div data-kt-menu-trigger="click" class="menu-item menu-accordion <?=(($_GET['page'] == 'site_settings'  || $_GET['page'] == 'main_settings' || $_GET['page'] == 'kyc_settings' || $_GET['page'] == 'admin' || $_GET['page'] == 'referral' || $_GET['page'] == 'exchange' || $_GET['page'] == 'info_box' || $_GET['page'] == 'email' || $_GET['page'] == 'seo_settings' || $_GET['page'] == 'push_alerts' || $_GET['page'] == 'security') ? "show here" : "") ?>">
                    <!--begin:Menu link-->
                    <span class="menu-link">
                        <span class="menu-icon">
                            <i class="ki-duotone ki-setting-2 fs-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                                <span class="path4"></span>
                            </i>
                        </span>
                        <span class="menu-title">Settings</span>
                        <span class="menu-arrow"></span>
                    </span>
                    <!--end:Menu link-->
                    <!--begin:Menu sub-->
                    <div class="menu-sub menu-sub-accordion">
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=site_settings") ? "active" : "") ?>" href="admin?page=site_settings">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Site Settings</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                          <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=telegram_settings") ? "active" : "") ?>" href="admin?page=telegram_settings">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Telegram Bot Token</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=main_settings") ? "active" : "") ?>" href="admin?page=main_settings">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Main Settings</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=admin") ? "active" : "") ?>" href="admin?page=admin">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Admin Settings</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                        <!--begin:Menu item-->
                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=referral") ? "active" : "") ?>" href="admin?page=referral">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Referral Settings</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=security") ? "active" : "") ?>" href="admin?page=security" >
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Security Settings</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        
                     
                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=info_box") ? "active" : "") ?>" href="admin?page=info_box">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Info Box Settings</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                         <? if ($exchange_settings['enable']){ ?>
                        <!--end:Menu item-->
                            <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=exchange") ? "active" : "") ?>" href="admin?page=exchange">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Exchange Rates</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                         <? } ?>
                         <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=email") ? "active" : "") ?>" href="admin?page=email">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Email Settings</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                      
                         <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=push_alerts") ? "active" : "") ?>" href="admin?page=push_alerts">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Push Alerts Settings</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                         
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=kyc_settings") ? "active" : "") ?>" href="admin?page=kyc_settings">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">KYC Settings</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=seo_settings") ? "active" : "") ?>" href="admin?page=seo_settings">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Seo Settings </span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        
                        
                    </div>
                    <!--end:Menu sub-->
                </div>
                <!--end:Menu item-->

                <!--begin:Menu item-->
                <div data-kt-menu-trigger="click" class="menu-item menu-accordion <?=(($_GET['page'] == 'currencies' || $_GET['page'] == 'processings') ? "show here" : "") ?>">
                    <!--begin:Menu link-->
                    <span class="menu-link">
                        <span class="menu-icon">
                            <i class="ki-duotone ki-dollar fs-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                                <span class="path4"></span>
                            </i>
                        </span>
                        <span class="menu-title">Processings</span>
                        <span class="menu-arrow"></span>
                    </span>
                    <!--end:Menu link-->
                    <!--begin:Menu sub-->
                    <div class="menu-sub menu-sub-accordion">
                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=currencies") ? "active" : "") ?>" href="admin?page=currencies">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Currencies</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                        <!--begin:Menu item-->
                        <div class="menu-item " > 
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=processings") ? "active" : "") ?>" href="admin?page=processings">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Processors </span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                    </div>
                    <!--end:Menu sub-->
                </div>
                <!--end:Menu item-->

                <!--begin:Menu item-->
                <div data-kt-menu-trigger="click" class="menu-item menu-accordion <?=(($_GET['page'] == 'content' || $_GET['page'] == 'telegram_bot' || $_GET['page'] == 'alerts' || $_GET['page'] == 'templates' || $_GET['page'] == 'news' || $_GET['page'] == 'faqs'  || $_GET['page'] == 'languages') ? "show here" : "") ?>">
                    <!--begin:Menu link-->
                    <span class="menu-link">
                        <span class="menu-icon">
                            <i class="ki-duotone ki-notepad fs-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                                <span class="path4"></span>
                            </i>
                        </span>
                        <span class="menu-title">Content</span>
                        <span class="menu-arrow"></span>
                    </span>
                    <!--end:Menu link-->
                    <!--begin:Menu sub-->
                    <div class="menu-sub menu-sub-accordion">
                       
                    <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=content") ? "active" : "") ?>" href="admin?page=content">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Site Content </span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=telegram_bot") ? "active" : "") ?>" href="admin?page=telegram_bot">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Bot Content </span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=alerts") ? "active" : "") ?>" href="admin?page=alerts">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">System Alerts</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->

                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=templates") ? "active" : "") ?>" href="admin?page=templates">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Email/Alert Templates</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                             <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                           <a class="menu-link" href="#" data-bs-toggle="modal" data-bs-target="#kt_modal_100">
    <span class="menu-bullet">
        <span class="bullet bullet-dot"></span>
    </span>
    <span class="menu-title">Media Manager</span>
</a>
                            <!--end:Menu link-->
                        </div>
                        
                         <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                           <a class="menu-link" href="#" onclick="showCategoryManager(); return false;">
    <span class="menu-bullet">
        <span class="bullet bullet-dot"></span>
    </span>
    <span class="menu-title">Categories</span>
</a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                        
                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=news") ? "active" : "") ?>" href="admin?page=news">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">News </span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->

                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=faqs") ? "active" : "") ?>" href="admin?page=faqs">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Faqs </span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->

                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=languages") ? "active" : "") ?>" href="admin?page=languages">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Languages </span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->


                       
                    </div>
                    <!--end:Menu sub-->
                </div>
                <!--end:Menu item-->
                <? if($trading_settings['enable']) { ?> 
                <div data-kt-menu-trigger="click" class="menu-item menu-accordion <?=(($_GET['page'] == 'trading' || $_GET['page'] == 'trades') ? "show here" : "") ?>">
                    <!--begin:Menu link-->
                    <span class="menu-link">
                        <span class="menu-icon">
                            <i class="ki-duotone ki-chart-line fs-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                                <span class="path4"></span>
                            </i>
                        </span>
                        <span class="menu-title"> Trading</span>
                        <span class="menu-arrow"></span>
                    </span>
                    <!--end:Menu link-->
                    <!--begin:Menu sub-->
                    <div class="menu-sub menu-sub-accordion">
                        <!--begin:Menu item-->
                        <div class="menu-item">
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=trading") ? "active" : "") ?>" href="admin?page=trading">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Trading Pair</span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                        <!--begin:Menu item-->
                        <div class="menu-item " > 
                            <!--begin:Menu link-->
                            <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=trades") ? "active" : "") ?>" href="admin?page=trades">
                                <span class="menu-bullet">
                                    <span class="bullet bullet-dot"></span>
                                </span>
                                <span class="menu-title">Trades </span>
                            </a>
                            <!--end:Menu link-->
                        </div>
                        <!--end:Menu item-->
                    </div>
                    <!--end:Menu sub-->
                </div>
                <? } ?>
                <div class="menu-item pt-5">
                    <!--begin:Menu content-->
                    <div class="menu-content">
                        <span class="menu-heading fw-bold text-uppercase fs-7">Utilities</span>
                    </div>
                    <!--end:Menu content-->
                </div>
                <!--end:Menu item-->
                <!--begin:Menu item-->
               
                <!--end:Menu item-->
                <!--begin:Menu item-->
                <div class="menu-item">
                    <!--begin:Menu link-->
                    <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=manage_pages") ? "active" : "") ?>" href="admin?page=manage_pages">
                        <span class="menu-icon">
                            <i class="ki-duotone ki-setting-4 fs-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                        </span>
                        <span class="menu-title">Manage Pages</span>
                    </a>
                    <!--end:Menu link-->
                </div>
                <!--end:Menu item-->
                <!--begin:Menu item-->
                <div class="menu-item">
                    <!--begin:Menu link-->
                    <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=support") ? "active" : "") ?>" href="admin?page=support">
                        <span class="menu-icon">
                            <i class="ki-duotone ki-messages  fs-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                        </span>
                        <span class="menu-title">Support Tickets</span>
                    </a>
                    <!--end:Menu link-->
                </div>
                <!--end:Menu item-->
                <!--begin:Menu item-->
                <div class="menu-item">
                    <!--begin:Menu link-->
                    <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=newsletter") ? "active" : "") ?>" href="admin?page=newsletter">
                        <span class="menu-icon">
                            <i class="ki-duotone ki-click  fs-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                        </span>
                        <span class="menu-title">Newsletter</span>
                    </a>
                    <!--end:Menu link-->
                </div>
                <!--end:Menu item-->
                <!--begin:Menu item-->
                <div class="menu-item">
                    <!--begin:Menu link-->
                    <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=mainenance") ? "active" : "") ?>" href="admin?page=mainenance">
                        <span class="menu-icon">
                            <i class="ki-duotone ki-rescue fs-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                                <span class="path4"></span>
                            </i>
                        </span>
                        <span class="menu-title">Maintenance Page</span>
                    </a>
                    <!--end:Menu link-->
                </div>
                
                <div class="menu-item">
                    <!--begin:Menu link-->
                    <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=telegram_manager") ? "active" : "") ?>" href="admin?page=telegram_manager">
                        <span class="menu-icon">
                            <i class="ki-duotone ki-send fs-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                                <span class="path4"></span>
                            </i>
                        </span>
                        <span class="menu-title">Telegram App/Bot</span>
                    </a>
                    <!--end:Menu link-->
                </div>
                 <div class="menu-item">
                    <!--begin:Menu link-->
                    <a  class="menu-link <?PHP echo (($_SERVER["REQUEST_URI"] === "/admin?page=products") ? "active" : "") ?>" href="admin?page=products">
                        <span class="menu-icon">
                            <i class="ki-duotone ki-shop fs-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                                <span class="path4"></span>
                                <span class="path5"></span>
                            </i>
                        </span>
                        <span class="menu-title">Products</span>
                    </a>
                    <!--end:Menu link-->
                </div>
                
                
                     
                <!--end:Menu item-->
            </div>
            <!--end::Menu-->
        </div>
        <!--end::Scroll wrapper-->
    </div>
    <!--end::Menu wrapper-->
</div>

                        <!--end::sidebar menu-->
<!--begin::Footer-->
<div class="app-sidebar-footer flex-column-auto pt-2 pb-6 px-6" id="kt_app_sidebar_footer">
    <a href="/admin?page=system" class="btn btn-flex flex-center btn-custom btn-primary overflow-hidden text-nowrap px-0 h-40px w-100 <?php echo ($versions['script_update_available'] || $versions['app_update_available']) ? 'pulse pulse-warning' : ''; ?>" data-bs-toggle="tooltip" data-bs-trigger="hover" data-bs-dismiss="click" title="<?php echo ($versions['script_update_available'] || $versions['app_update_available']) ? 'Updates available!' : 'Updated and running.'; ?>">
        
        <span class="menu-icon ">
            <i class="ki-duotone ki-shield-tick <?php echo ($versions['script_update_available'] || $versions['app_update_available']) ? 'text-warning' : 'text-success'; ?> fs-1">
                <span class="path1"></span>
                <span class="path2"></span>
            </i>
            <?php if($versions['script_update_available'] || $versions['app_update_available']): ?>
                <span class="pulse-ring"></span>
            <?php endif; ?>
        </span>
        
        <span class="menu-title">System 
            <span class="badge <?php echo ($versions['script_update_available'] || $versions['app_update_available']) ? 'badge-warning' : 'badge-primary'; ?> badge-sm fw-bold fs-8 px-2 ms-2">All-In-One</span> 
            <span class="badge <?php echo ($versions['script_update_available'] || $versions['app_update_available']) ? 'badge-warning' : 'badge-success'; ?> badge-sm fw-bold fs-8 px-2 ms-2"><?php echo $versions['script']; ?></span>
        </span>
    </a>
</div>
<!--end::Footer-->
                    </div>
                    <!--end::Sidebar-->
<div class="app-main flex-column flex-row-fluid" id="kt_app_main">
                        <!--begin::Content wrapper-->
                        <div class="d-flex flex-column flex-column-fluid">
                            <!--begin::Toolbar-->
                    
                         <div id="kt_app_toolbar" class="app-toolbar py-3 py-lg-6">
    <!--begin::Toolbar container-->
    <div id="kt_app_toolbar_container" class="app-container container-xxl d-flex flex-stack">
        <!--begin::Page title-->
        <div class="page-title d-flex flex-column justify-content-center flex-wrap me-3">
            <!--begin::Title-->
            <h1 class="page-heading d-flex text-gray-900 fw-bold fs-3 flex-column justify-content-center my-0">
                <?php
                $page = $_GET['page'] ? str_replace('_', ' ', $_GET['page']) : 'Dashboard';
                echo ucwords($page);
                ?>
            </h1>

            <ul class="breadcrumb breadcrumb-separatorless fw-semibold fs-7 my-0 pt-1">

                <li class="breadcrumb-item text-muted">
                    <a  href="admin" class="text-muted text-hover-primary">Admin</a>
                </li>

                <li class="breadcrumb-item">
                    <span class="bullet bg-gray-500 w-5px h-2px"></span>
                </li>

                <li class="breadcrumb-item text-muted">
                    <?php echo ucwords($page); ?>
                </li>

            </ul>

        </div>
        <div class="d-flex align-items-center gap-2 gap-lg-3">
        </div>
    </div>
</div>
<? if($alert_demo) {?>
<div class="alert alert-warning alert-dismissible fade show" role="alert">
    <strong>DEMO MODE ACTIVE</strong> - This is a restricted demo version. To see full functionality, please 
    <a href="https://t.me/bitdersteam" class="alert-link" target="_blank">contact support</a>.
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
<? } if($_GET['page'] == 'manage_pages' || $_GET['page'] == 'info_box' || $_GET['page'] == 'content') { ?>
<div id="kt_app_content" class="app-content flex-column-fluid">
<!--begin::Content container-->
<div id="kt_app_content_container" class="app-container container-fluid">
<? } else { ?>
<div id="kt_app_content" class="app-content flex-column-fluid">
<!--begin::Content container-->
<div id="kt_app_content_container" class="app-container container-xxl">
    <? } ?>
<!--begin::Layout-->
<div class="d-flex flex-column flex-lg-row">
    <!--begin::Content-->
    <div class="flex-lg-row-fluid mb-10 mb-lg-0 me-lg-7 me-xl-10">

<? if ($_GET['page'] == 'exchange')
{
    if (isset($_POST['action']) && $_POST['action'] == "delete")
    {
        $RECORD = mysqli_query($DB_CONN, "delete from exchange where id='{$_POST['id']}'");
        if ($RECORD)
        {
            $alert = true;
            $alert_class = 'alert alert-success alert-dismissible alert-custom';
            $alert_message = 'Operation Successfully!';
        }
    }
    if (isset($_POST['submit']))
    {
        if ($_POST['action'] == 'new')
        {
            $arr['address'] = $_POST['detail'];
            $settings = mysqli_real_escape_string($DB_CONN, json_encode($arr));
            if (mysqli_query($DB_CONN, "INSERT INTO `exchange`(`from_currency`, `to_currency`, `rate`) VALUES ('{$_POST['from_currency']}', '{$_POST['to_currency']}', '{$_POST['rate']}')"))
            {

                $msg = 'Added';
            }
            else
            {
                $msg = 1;
            }
        }
    }

if (isset($msg))
    {
        if ($msg == 0)
        {
            echo "<p><span class=\"btn btn-success\" style=\"cursor:default;\">Successfully Perform the Operation!</span> </p>";
        }
        elseif ($msg == 1)
        {
            echo "<p><span class=\"btn btn-danger\" style=\"cursor:default;\">Error. Try Again!</span> </p>";
        }
    } ?>   
    
                                            <!--begin::Card-->
                                            <div class="card">
                                                    <div class="card-header min-h-unset py-2">
                                            <!--begin::Card title-->
                                            <h3 class="card-title align-items-start flex-column m-0">
                                                        <span class="card-label fw-bold text-gray-900">Exchange Rates</span>
                                                        <span class="text-gray-500 mt-1 fw-semibold fs-6">Add Exchange rates (%) for multiple currencies</span>
                                                    </h3>
                                            <!--end::Card title-->
                                        </div>
                                                <!--begin::Card body-->
                                                <div class="card-body p-12">
                                                    <!--begin::Form-->
                                                            <div class="card mt-3">
 
          
         
            <table  class="table table-striped table-bordered display dataTable table-hover table-sm" id="default_order">
              <thead>
                <tr>
                  <th width="2%">ID</th>
                  <th width="30%">From Currency</th>
                  <th width="30%">To Currency</th>
                  <th width="8%">Percentage</th>
                  <th width="20%">Actions</th>
                </tr>
              </thead>
              <tbody>
              <?php
    $q = mysqli_query($DB_CONN, "SELECT *, (SELECT name from currencies where id = exchange.from_currency) as fromc, (SELECT name from currencies where id = exchange.to_currency) as toc FROM exchange; ") or die(mysqli_error($DB_CONN));
    while ($query = mysqli_fetch_assoc($q))
    {
?>
                  <tr>
                  <td><?php echo $query['id'] ?></td>
                  <td style="width:20%"><img src="images/icons/<?php echo $query['from_currency'] ?>.svg"> <?php echo $query['fromc'] ?></td>   
                  <td style="width:20%"><img src="images/icons/<?php echo $query['to_currency'] ?>.svg"> <?php echo $query['toc'] ?></td>    
                  <td style="width:50%"><?php echo $query['rate'] ?>%</td>
        <td>


<form action="" method="post" id="form_<?php echo $query['id'] ?>">
<input type="hidden" name="action" value="delete">
<input type="hidden" name="id" value="<?php echo $query['id'] ?>">
<button type="submit" name="submit" class="dropdown-item" value="Delete" onclick="return confirm('Do you Realy Want to Delete?')"><i class="fas fa-trash" aria-hidden="true"></i> Delete</button>
</form>

</td>
                </tr>
                  <?php } ?>
              </tbody>
             
            </table>
            </div>
                                                    <!--end::Form-->
                                                </div>
                                                <!--end::Card body-->
                                            </div>
                                            <!--end::Card-->
                                        </div>
                                        <!--end::Content-->
                                        <!--begin::Sidebar-->
                                        <div class="flex-lg-auto min-w-lg-300px">
                                            <!--begin::Card-->
                                            <div class="card" data-kt-sticky="true" data-kt-sticky-name="invoice" data-kt-sticky-offset="{default: false, lg: '200px'}" data-kt-sticky-width="{lg: '250px', lg: '300px'}" data-kt-sticky-left="auto" data-kt-sticky-top="150px" data-kt-sticky-animation="false" data-kt-sticky-zindex="95">
                                                <!--begin::Card body-->
                                                <div class="card-body p-10">
                                                    <!--begin::Input group-->
                                                      
        <form action="" role="form" method="post">
    <table  width="100%" class="table sm-0">

        <tr>
    <td>From :</td>
    
    <td><div class="col-md-10">
                                            <select name="from_currency" class="form-select ">
                <?php $select_method = mysqli_query($DB_CONN, "SELECT *from currencies where de_pm_id != 0");
    while ($row_method = mysqli_fetch_assoc($select_method))
    { ?>
                        <option value="<?php echo $row_method['id'] ?>"> <?php echo $row_method['name'] ?> </option>
                <?php
    } ?>  
            </select>
            <small id="emailHelp" class="form-text text-muted fs-9">Please select Payment method </small>
        </div></td>
  </tr><tr>
    <td>To :</td>
    <td><div class="col-md-10">
                                            <select name="to_currency" class="form-select">
                <?php $select_method = mysqli_query($DB_CONN, "SELECT *from currencies where de_pm_id != 0");
    while ($row_method = mysqli_fetch_assoc($select_method))
    { ?>
                        <option value="<?php echo $row_method['id'] ?>"> <?php echo $row_method['name'] ?> </option>
                <?php
    } ?>  
            </select>
            <small id="emailHelp" class="form-text text-muted fs-9">Please select Payment method </small>
        </div></td>
  </tr>
  
  <tr>
    <td>  Percentage:</td>
    <td> <input name="rate" class="form-control form-control-sm" type="text" required id="Detail " placeholder="Percentage " value="">
      <small class="fs-9">Please add the Percentage(%) you want to deduct as fee while exchange</small></td>
  </tr>
  
  </tr>  

  </table>
    <!--begin::Separator-->
<div class="separator separator-dashed mb-8"></div>
<!--end::Separator-->
<!--begin::Actions-->
<div class="mb-0">
<input type="hidden" name="action" value="new" />
<button  type="submit" name="submit" class="btn btn-primary w-100" id="kt_invoice_submit_button">
<i class="ki-duotone ki-triangle fs-3">
<span class="path1"></span>
<span class="path2"></span>
<span class="path3"></span>
</i>Add </button>
</div>
<!--end::Actions-->
</div>
<!--end::Card body-->
                </div> </div>
<?
}
if ($_GET['page'] == 'info_box')
{ 
    $select_detail = mysqli_query($DB_CONN, "select * from preferences");
    $row_detail = mysqli_fetch_assoc($select_detail);
    $infobox_settings = json_decode($row_detail['infobox_settings'], true);
    $idd = $row_detail['id'];

    if (isset($_POST['submit']))
    {
        $infobox_settings = mysqli_real_escape_string($DB_CONN, json_encode($_POST['infobox_settings']));
        $update_in = mysqli_query($DB_CONN, "UPDATE preferences set infobox_settings='{$infobox_settings}' WHERE id='$idd'");

        if ($update_in)
        {
            echo '<div class="alert alert-success">
      Updated Successfully ! 
</div>';
updateSiteData($siteURL);
        }
        $select_detail = mysqli_query($DB_CONN, "select * from preferences");
        $row_detail = mysqli_fetch_assoc($select_detail);
        $infobox_settings = json_decode($row_detail['infobox_settings'], true);
        $idd = $row_detail['id'];

    }
?>
                                <form method="POST" action="" class="form fv-plugins-bootstrap5 fv-plugins-framework">
                                                            <!--begin::Content-->
                                    <div class="card mb-5 mb-xl-10">
                                        <!--begin::Card header-->
                                    <div class="card-header min-h-unset py-2">
        <div class="card-title m-0">
            <h3 class="fw-bold m-0 fs-5">Info Box Settings</h3>
        </div>
    </div>
                                
                                                <!--begin::Card body-->
                                                <div class="card-body border-top p-3">
         <!-- Main Slider Toggle -->
<div class="row border-bottom">
    <div class="d-flex flex-stack">
        <div class="d-flex">
            <div class="d-flex flex-column">
                <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Show Slider</a>
                <div class="fs-9 fw-semibold text-gray-500">Enable to show slider options.</div>
            </div>
        </div>
        <div class="d-flex justify-content-end">
            <div class="form-check form-check-solid form-check-custom form-switch">
                <input class="form-check-input w-45px h-30px slider-trigger" type="checkbox" 
                       name="infobox_settings[slider]" id="slider" value="true"
                       data-target="sliderOptions"
                       <?=$infobox_settings['slider'] == 'true' ? 'checked' : '' ?>>
                <label class="form-check-label fs-9" for="slider"></label>
            </div>
        </div>
    </div>
</div>

<!-- Individual Slider Options -->
<div id="sliderOptions" style="display: <?=$infobox_settings['slider'] == 'true' ? 'block' : 'none' ?>">
      <div class="row mb-8">
    <div class="col-lg-4">
        <div class="d-flex flex-column">
            <label class="fs-6 fw-bold mb-2">Slider Images</label>
            <div class="text-muted fs-7">Upload images for your homepage slider</div>
        </div>
    </div>
    <div class="col-lg-8">
        <div id="slider-images-container" class="d-flex flex-wrap gap-3">
            <?php if (isset($infobox_settings['sliders']) && is_array($infobox_settings['sliders'])): ?>
                <?php foreach ($infobox_settings['sliders'] as $index => $slider): ?>
                    <div class="image-input-group position-relative">
                        <button type="button" class="btn btn-icon btn-danger btn-sm position-absolute start-0 top-0 remove-image-group" style="margin-left: -12px; margin-top: -12px; z-index: 5;">
                            <i class="ki-duotone ki-trash fs-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                                <span class="path4"></span>
                                <span class="path5"></span>
                            </i>
                        </button>
                        <div class="image-input image-input-outline" data-kt-image-input="true" style="background-image: url('svg/avatars/blank.svg')">
                            <div class="image-input-wrapper w-200px h-125px slider-preview"
                                style="background-image: url('<?= htmlspecialchars($slider) ?>')">
                            </div>
                            <label class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                                   data-kt-image-input-action="change" data-bs-toggle="modal" data-bs-target="#kt_modal_100">
                                <i class="ki-duotone ki-pencil fs-7">
                                    <span class="path1"></span><span class="path2"></span>
                                </i>
                            </label>
                            <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                                  data-kt-image-input-action="remove" data-bs-toggle="tooltip" title="Remove Image">
                                <i class="ki-outline ki-cross fs-2"></i>
                            </span>
                        </div>
                        <input type="hidden" class="slider-image-url" name="infobox_settings[sliders][]" 
                               value="<?= htmlspecialchars($slider) ?>">
                               <div class="mt-3">
                    <input type="text" class="form-control form-control-sm mb-2" 
                           name="infobox_settings[slider_meta][<?= $index ?>][title]" 
                           value="<?= htmlspecialchars($infobox_settings['slider_meta'][$index]['title'] ?? '') ?>" 
                           placeholder="Title">
                    <input type="text" class="form-control form-control-sm mb-2" 
                           name="infobox_settings[slider_meta][<?= $index ?>][subtitle]" 
                           value="<?= htmlspecialchars($infobox_settings['slider_meta'][$index]['subtitle'] ?? '') ?>" 
                           placeholder="Subtitle">
                    <textarea class="form-control form-control-sm" 
                            name="infobox_settings[slider_meta][<?= $index ?>][description]" 
                            placeholder="Description"><?= htmlspecialchars($infobox_settings['slider_meta'][$index]['description'] ?? '') ?></textarea>
                </div>
                    </div>
                    
                <?php endforeach; ?>
            <?php endif; ?>
        </div>

        <button type="button" id="add-more-images" class="btn btn-light-primary btn-sm mt-3">
            <i class="ki-duotone ki-plus fs-2"></i>Add More Images
        </button>
    </div>
</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const sliderToggle = document.querySelector('.slider-trigger');
    const sliderOptions = document.getElementById('sliderOptions');
    sliderToggle.addEventListener('change', function() {
        const targetId = this.getAttribute('data-target');
        document.getElementById(targetId).style.display = this.checked ? 'block' : 'none';
    });
});
</script>       
                                       
<script>
document.getElementById('add-more-images').addEventListener('click', function() {
    const container = document.getElementById('slider-images-container');
    const newIndex = container.children.length;
    const newImageGroup = document.createElement('div');
    newImageGroup.className = 'image-input-group position-relative';
    
    newImageGroup.innerHTML = `
        <button type="button" class="btn btn-icon btn-danger btn-sm position-absolute start-0 top-0 remove-image-group" style="margin-left: -12px; margin-top: -12px; z-index: 5;">
            <i class="ki-duotone ki-trash fs-2">
                <span class="path1"></span>
                <span class="path2"></span>
                <span class="path3"></span>
                <span class="path4"></span>
                <span class="path5"></span>
            </i>
        </button>
        <div class="image-input image-input-outline" data-kt-image-input="true" style="background-image: url('svg/avatars/blank.svg')">
            <div class="image-input-wrapper w-200px h-125px slider-preview"
                style="background-image: url('bitders/assets/placeholder.svg')">
            </div>
            <label class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                   data-kt-image-input-action="change" data-bs-toggle="modal" data-bs-target="#kt_modal_100">
                <i class="ki-duotone ki-pencil fs-7">
                    <span class="path1"></span><span class="path2"></span>
                </i>
            </label>
            <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                  data-kt-image-input-action="remove" data-bs-toggle="tooltip" title="Remove Image">
                <i class="ki-outline ki-cross fs-2"></i>
            </span>
        </div>
        <input type="hidden" class="slider-image-url" name="infobox_settings[sliders][]" value="">
        
        <div class="mt-3">
            <input type="text" class="form-control form-control-sm mb-2" 
                   name="infobox_settings[slider_meta][${newIndex}][title]" 
                   placeholder="Title">
            <input type="text" class="form-control form-control-sm mb-2" 
                   name="infobox_settings[slider_meta][${newIndex}][subtitle]" 
                   placeholder="Subtitle">
            <textarea class="form-control form-control-sm" 
                      name="infobox_settings[slider_meta][${newIndex}][description]" 
                      placeholder="Description"></textarea>
        </div>
    `;
    
    container.appendChild(newImageGroup);
    
    if (typeof KTImageInput !== 'undefined') {
        KTImageInput.createInstances();
    }
});

// Handle image removal (clearing the image)
document.addEventListener('click', function(e) {
    if (e.target.closest('[data-kt-image-input-action="remove"]')) {
        const imageGroup = e.target.closest('.image-input-group');
        const preview = imageGroup.querySelector('.slider-preview');
        const hiddenInput = imageGroup.querySelector('.slider-image-url');
        
        preview.style.backgroundImage = "url('bitders/assets/placeholder.svg')";
        hiddenInput.value = '';
    }
});

// Handle complete slide removal
document.addEventListener('click', function(e) {
    if (e.target.closest('.remove-image-group')) {
        const imageGroup = e.target.closest('.image-input-group');
        imageGroup.remove();
        
        // Reindex remaining slides
        const container = document.getElementById('slider-images-container');
        const remainingSlides = container.querySelectorAll('.image-input-group');
        remainingSlides.forEach((slide, index) => {
            const titleInput = slide.querySelector('[name^="infobox_settings[slider_meta]"][name$="[title]"]');
            const subtitleInput = slide.querySelector('[name^="infobox_settings[slider_meta]"][name$="[subtitle]"]');
            const descriptionInput = slide.querySelector('[name^="infobox_settings[slider_meta]"][name$="[description]"]');
            
            if (titleInput) titleInput.name = `infobox_settings[slider_meta][${index}][title]`;
            if (subtitleInput) subtitleInput.name = `infobox_settings[slider_meta][${index}][subtitle]`;
            if (descriptionInput) descriptionInput.name = `infobox_settings[slider_meta][${index}][description]`;
        });
    }
});

</script>                                     
                                                    
         <div class="row"> 
    <label class="col-lg-6 col-form-label required fw-semibold fs-6">Home Last Transactions (Investments and Withdrawals)</label>
    <div class="col-lg-6 d-flex align-items-center gap-3">
        <div class="fv-row fv-plugins-icon-container">
            <input type="text" placeholder="Enter Quantity" name="infobox_settings[last_transactions]" value="<?=$infobox_settings['last_transactions'] ?>" class="form-control form-control-sm">
            <small class="text-muted">Enter quantity</small>
        </div>
        <div class="form-check form-check-custom form-check-solid">
            <input type="checkbox" class="form-check-input mask-trigger" data-target="transactions-mask" name="infobox_settings[transactions_mask]" value="1" <?= isset($infobox_settings['transactions_mask']) && $infobox_settings['transactions_mask'] ? 'checked' : '' ?>>
            <label class="form-check-label">Mask Username</label>
        </div>
        <div class="fv-row fv-plugins-icon-container mask-input" id="transactions-mask" style="display: <?= isset($infobox_settings['transactions_mask']) && $infobox_settings['transactions_mask'] ? 'block' : 'none' ?>;">
            <input type="number" placeholder="Asterisks" name="infobox_settings[transactions_stars]" value="<?= $infobox_settings['transactions_stars'] ?? 4 ?>" class="form-control form-control-sm" min="1" max="10">
        <small class="text-muted">Asterisk count</small>
        </div>
    </div>
</div>

<div class="row">
    <label class="col-lg-6 col-form-label required fw-semibold fs-6">Home Last Deposits</label>
    <div class="col-lg-6 d-flex align-items-center gap-3">
        <div class="fv-row fv-plugins-icon-container">
            <input type="text" placeholder="Enter Quantity" name="infobox_settings[last_deposits]" value="<?=$infobox_settings['last_deposits'] ?>" class="form-control form-control-sm">
            <small class="text-muted">Enter quantity</small>
        </div>
        <div class="form-check form-check-custom form-check-solid">
            <input type="checkbox" class="form-check-input mask-trigger" data-target="deposits-mask" name="infobox_settings[last_deposits_mask]" value="1" <?= isset($infobox_settings['last_deposits_mask']) && $infobox_settings['last_deposits_mask'] ? 'checked' : '' ?>>
            <label class="form-check-label">Mask Username</label>
        </div>
        <div class="fv-row fv-plugins-icon-container mask-input" id="deposits-mask" style="display: <?= isset($infobox_settings['last_deposits_mask']) && $infobox_settings['last_deposits_mask'] ? 'block' : 'none' ?>;">
            <input type="number" placeholder="Asterisks" name="infobox_settings[last_deposits_stars]" value="<?= $infobox_settings['last_deposits_stars'] ?? 4 ?>" class="form-control form-control-sm" min="1" max="10">
        <small class="text-muted">Asterisk count</small>
        </div>
    </div>
</div>

<div class="row">
    <label class="col-lg-6 col-form-label required fw-semibold fs-6">Home Last Withdrawals</label>
    <div class="col-lg-6 d-flex align-items-center gap-3">
        <div class="fv-row fv-plugins-icon-container">
            <input type="text" placeholder="Enter Quantity" name="infobox_settings[last_withdraws]" value="<?=$infobox_settings['last_withdraws'] ?>" class="form-control form-control-sm">
            <small class="text-muted">Enter quantity</small>
        </div>
        <div class="form-check form-check-custom form-check-solid">
            <input type="checkbox" class="form-check-input mask-trigger" data-target="withdraws-mask" name="infobox_settings[last_withdraws_mask]" value="1" <?= isset($infobox_settings['last_withdraws_mask']) && $infobox_settings['last_withdraws_mask'] ? 'checked' : '' ?>>
            <label class="form-check-label">Mask Username</label>
        </div>
        <div class="fv-row fv-plugins-icon-container mask-input" id="withdraws-mask" style="display: <?= isset($infobox_settings['last_withdraws_mask']) && $infobox_settings['last_withdraws_mask'] ? 'block' : 'none' ?>;">
            <input type="number" placeholder="Asterisks" name="infobox_settings[last_withdraws_stars]" value="<?= $infobox_settings['last_withdraws_stars'] ?? 4 ?>" class="form-control form-control-sm" min="1" max="10">
         <small class="text-muted">Asterisk count</small>
         </div>
    </div>
</div>

<div class="row">
    <label class="col-lg-6 col-form-label required fw-semibold fs-6">Home Top Referrals</label>
    <div class="col-lg-6 d-flex align-items-center gap-3">
        <div class="fv-row fv-plugins-icon-container">
            <input type="text" placeholder="Enter Quantity" name="infobox_settings[top_refferals]" value="<?=$infobox_settings['top_refferals'] ?>" class="form-control form-control-sm">
            <small class="text-muted">Enter quantity</small>
        </div>
        <div class="form-check form-check-custom form-check-solid">
            <input type="checkbox" class="form-check-input mask-trigger" data-target="referrals-mask" name="infobox_settings[top_refferals_mask]" value="1" <?= isset($infobox_settings['top_refferals_mask']) && $infobox_settings['top_refferals_mask'] ? 'checked' : '' ?>>
            <label class="form-check-label">Mask Username</label>
        </div>
        <div class="fv-row fv-plugins-icon-container mask-input" id="referrals-mask" style="display: <?= isset($infobox_settings['top_refferals_mask']) && $infobox_settings['top_refferals_mask'] ? 'block' : 'none' ?>;">
            <input type="number" placeholder="Asterisks" name="infobox_settings[top_refferals_stars]" value="<?= $infobox_settings['top_refferals_stars'] ?? 4 ?>" class="form-control form-control-sm" min="1" max="10">
       <small class="text-muted">Asterisk count</small>
       </div>
    </div>
</div>

<div class="row">
    <label class="col-lg-6 col-form-label required fw-semibold fs-6">Home Top Depositors</label>
    <div class="col-lg-6 d-flex align-items-center gap-3">
        <div class="fv-row fv-plugins-icon-container">
            <input type="text" placeholder="Enter Quantity" name="infobox_settings[top_depositors]" value="<?=$infobox_settings['top_depositors'] ?>" class="form-control form-control-sm">
            <small class="text-muted">Enter quantity</small>
        </div>
        <div class="form-check form-check-custom form-check-solid">
            <input type="checkbox" class="form-check-input mask-trigger" data-target="depositors-mask" name="infobox_settings[top_depositors_mask]" value="1" <?= isset($infobox_settings['top_depositors_mask']) && $infobox_settings['top_depositors_mask'] ? 'checked' : '' ?>>
            <label class="form-check-label">Mask Username</label>
        </div>
        <div class="fv-row fv-plugins-icon-container mask-input" id="depositors-mask" style="display: <?= isset($infobox_settings['top_depositors_mask']) && $infobox_settings['top_depositors_mask'] ? 'block' : 'none' ?>;">
            <input type="number" placeholder="Asterisks" name="infobox_settings[top_depositors_stars]" value="<?= $infobox_settings['top_depositors_stars'] ?? 4 ?>" class="form-control form-control-sm" min="1" max="10">
        <small class="text-muted">Asterisk count</small>
        </div>
    </div>
</div>

<div class="row">
    <label class="col-lg-6 col-form-label required fw-semibold fs-6"> Home Last Reviews</label>
    <div class="col-lg-6 d-flex align-items-center gap-3">
        <div class="fv-row fv-plugins-icon-container">
            <input type="text" placeholder="Enter Quantity" name="infobox_settings[last_reviews]" value="<?=$infobox_settings['last_reviews'] ?>" class="form-control form-control-sm">
            <small class="text-muted">Enter quantity</small>
        </div>
        <div class="form-check form-check-custom form-check-solid">
            <input type="checkbox" class="form-check-input mask-trigger" data-target="reviews-mask" name="infobox_settings[last_reviews_mask]" value="1" <?= isset($infobox_settings['last_reviews_mask']) && $infobox_settings['last_reviews_mask'] ? 'checked' : '' ?>>
            <label class="form-check-label">Mask Username</label>
        </div>
        <div class="fv-row fv-plugins-icon-container mask-input" id="reviews-mask" style="display: <?= isset($infobox_settings['last_reviews_mask']) && $infobox_settings['last_reviews_mask'] ? 'block' : 'none' ?>;">
            <input type="number" placeholder="Asterisks" name="infobox_settings[last_reviews_stars]" value="<?= $infobox_settings['last_reviews_stars'] ?? 4 ?>" class="form-control form-control-sm" min="1" max="10">
            <small class="text-muted">Asterisk count</small>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    // Handle masking toggles
    document.querySelectorAll('.mask-trigger').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            const targetId = this.getAttribute('data-target');
            document.getElementById(targetId).style.display = this.checked ? 'block' : 'none';
        });
    });
});
</script>
                                                      <div class="row ">
                                                        <label class="col-lg-6 col-form-label required fw-semibold fs-6"> Tasks</label>
                                                        <div class="col-lg-6 fv-row fv-plugins-icon-container">
                                                             <input type="text" placeholder="Enter Quantity" name="infobox_settings[tasks]" value="<?=$infobox_settings['tasks'] ?>" class="form-control form-control-sm">
                                                             <small class="text-muted">Enter the numbers of reviews you want to show.</small>
                                                        </div>
                                                    </div>
                                                         <div class="row border-bottom">
                                                        <div class="d-flex flex-stack">
                                                                    <div class="d-flex">
                                                                        <div class="d-flex flex-column">
                                                                            <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Show Investment Packages </a>
                                                                            <div class="fs-9 fw-semibold text-gray-500">Enable to show Investment Packages .</div>
                                                                        </div>
                                                                    </div>
                                                                    <div class="d-flex justify-content-end">
                                                                        <div class="form-check form-check-solid form-check-custom form-switch">
                                                                            <input class="form-check-input w-45px h-30px" type="checkbox" name="infobox_settings[investmentpackages]" id="investmentpackages"  value="true"
                                                                            <?=$infobox_settings['investmentpackages'] == 'true' ? 'checked' : '' ?>>
                                                                            <label class="form-check-label fs-9" for="investmentpackages"></label>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                    </div>
                                                    <div class="row border-bottom">
                                                        <div class="d-flex flex-stack">
                                                                    <div class="d-flex">
                                                                        <div class="d-flex flex-column">
                                                                            <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Show Trading Pairs  </a>
                                                                            <div class="fs-9 fw-semibold text-gray-500">Enable to show referral program .</div>
                                                                        </div>
                                                                    </div>
                                                                    <div class="d-flex justify-content-end">
                                                                        <div class="form-check form-check-solid form-check-custom form-switch">
                                                                            <input class="form-check-input w-45px h-30px" type="checkbox" name="infobox_settings[trading]" id="trading"  value="true"
                                                                            <?=$infobox_settings['trading'] == 'true' ? 'checked' : '' ?>>
                                                                            <label class="form-check-label fs-9" for="trading"></label>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                    </div>
                                                     <div class="row border-bottom">
                                                        <div class="d-flex flex-stack">
                                                                    <div class="d-flex">
                                                                        <div class="d-flex flex-column">
                                                                            <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Show Referral Program </a>
                                                                            <div class="fs-9 fw-semibold text-gray-500">Enable to show referral program .</div>
                                                                        </div>
                                                                    </div>
                                                                    <div class="d-flex justify-content-end">
                                                                        <div class="form-check form-check-solid form-check-custom form-switch">
                                                                            <input class="form-check-input w-45px h-30px" type="checkbox" name="infobox_settings[referral]" id="referral"  value="true"
                                                                            <?=$infobox_settings['referral'] == 'true' ? 'checked' : '' ?>>
                                                                            <label class="form-check-label fs-9" for="referral"></label>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                    </div>
                                                    
                                                  <!-- Main Statistics Toggle -->
<div class="row border-bottom">
    <div class="d-flex flex-stack">
        <div class="d-flex">
            <div class="d-flex flex-column">
                <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Show Statistics</a>
                <div class="fs-9 fw-semibold text-gray-500">Enable to show statistics.</div>
            </div>
        </div>
        <div class="d-flex justify-content-end">
            <div class="form-check form-check-solid form-check-custom form-switch">
                <input class="form-check-input w-45px h-30px statistics-trigger" type="checkbox" 
                       name="infobox_settings[statistics]" id="statistics" value="true"
                       data-target="statisticsOptions"
                       <?=$infobox_settings['statistics'] == 'true' ? 'checked' : '' ?>>
                <label class="form-check-label fs-9" for="statistics"></label>
            </div>
        </div>
    </div>
</div>

<!-- Individual Statistics Options -->
<!-- User Statistics -->
<div id="statisticsOptions" class="border-bottom" style="display: <?=$infobox_settings['statistics'] == 'true' ? 'block' : 'none' ?>">
    <!-- User Statistics Group -->
    <div class="row border-bottom">
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Total Users</a>
                    <div class="fs-9 fw-semibold text-gray-500">Show total users count</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" 
                           name="infobox_settings[total_users]" id="total_users" value="true"
                           <?=$infobox_settings['total_users'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="total_users"></label>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row border-bottom">
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Active Users</a>
                    <div class="fs-9 fw-semibold text-gray-500">Show active users count</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" 
                           name="infobox_settings[active_users]" id="active_users" value="true"
                           <?=$infobox_settings['active_users'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="active_users"></label>
                </div>
            </div>
        </div>
    </div>

    <div class="row border-bottom">
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Today's New Users</a>
                    <div class="fs-9 fw-semibold text-gray-500">Show today's new user count</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" 
                           name="infobox_settings[today_users]" id="today_users" value="true"
                           <?=$infobox_settings['today_users'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="today_users"></label>
                </div>
            </div>
        </div>
    </div>

    <div class="row border-bottom">
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Newest Member</a>
                    <div class="fs-9 fw-semibold text-gray-500">Show newest member information</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" 
                           name="infobox_settings[newest_member]" id="newest_member" value="true"
                           <?=$infobox_settings['newest_member'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="newest_member"></label>
                </div>
            </div>
        </div>
    </div>

    <!-- Deposit Statistics Group -->
    <div class="row border-bottom">
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Total Deposit</a>
                    <div class="fs-9 fw-semibold text-gray-500">Show total deposits amount</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" 
                           name="infobox_settings[total_deposit]" id="total_deposit" value="true"
                           <?=$infobox_settings['total_deposit'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="total_deposit"></label>
                </div>
            </div>
        </div>
    </div>

    <div class="row border-bottom">
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Today's Deposits</a>
                    <div class="fs-9 fw-semibold text-gray-500">Show today's deposit amount</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" 
                           name="infobox_settings[today_deposit]" id="today_deposit" value="true"
                           <?=$infobox_settings['today_deposit'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="today_deposit"></label>
                </div>
            </div>
        </div>
    </div>

    <div class="row border-bottom">
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Largest Investment</a>
                    <div class="fs-9 fw-semibold text-gray-500">Show largest investment amount</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" 
                           name="infobox_settings[largest_investment]" id="largest_investment" value="true"
                           <?=$infobox_settings['largest_investment'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="largest_investment"></label>
                </div>
            </div>
        </div>
    </div>

    <div class="row border-bottom">
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Smallest Investment</a>
                    <div class="fs-9 fw-semibold text-gray-500">Show smallest investment amount</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" 
                           name="infobox_settings[smallest_investment]" id="smallest_investment" value="true"
                           <?=$infobox_settings['smallest_investment'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="smallest_investment"></label>
                </div>
            </div>
        </div>
    </div>

    <!-- Withdrawal Statistics Group -->
    <div class="row border-bottom">
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Total Withdraw</a>
                    <div class="fs-9 fw-semibold text-gray-500">Show total withdrawals amount</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" 
                           name="infobox_settings[total_withdraw]" id="total_withdraw" value="true"
                           <?=$infobox_settings['total_withdraw'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="total_withdraw"></label>
                </div>
            </div>
        </div>
    </div>

    <div class="row border-bottom">
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Today's Withdrawals</a>
                    <div class="fs-9 fw-semibold text-gray-500">Show today's withdrawal amount</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" 
                           name="infobox_settings[today_withdraw]" id="today_withdraw" value="true"
                           <?=$infobox_settings['today_withdraw'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="today_withdraw"></label>
                </div>
            </div>
        </div>
    </div>

    <div class="row border-bottom">
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Largest Withdrawal</a>
                    <div class="fs-9 fw-semibold text-gray-500">Show largest withdrawal amount</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" 
                           name="infobox_settings[largest_withdraw]" id="largest_withdraw" value="true"
                           <?=$infobox_settings['largest_withdraw'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="largest_withdraw"></label>
                </div>
            </div>
        </div>
    </div>

    <div class="row border-bottom">
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Smallest Withdrawal</a>
                    <div class="fs-9 fw-semibold text-gray-500">Show smallest withdrawal amount</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" 
                           name="infobox_settings[smallest_withdraw]" id="smallest_withdraw" value="true"
                           <?=$infobox_settings['smallest_withdraw'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="smallest_withdraw"></label>
                </div>
            </div>
        </div>
    </div>

    <!-- Site Statistics -->
    <div class="row">
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Days Online</a>
                    <div class="fs-9 fw-semibold text-gray-500">Show total days online</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" 
                           name="infobox_settings[days_online]" id="days_online" value="true"
                           <?=$infobox_settings['days_online'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="days_online"></label>
                </div>
            </div>
        </div>
    </div>
</div>
      <div class="row border-bottom">
                                                        <div class="d-flex flex-stack">
                                                                    <div class="d-flex">
                                                                        <div class="d-flex flex-column">
                                                                            <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Languages Selector  </a>
                                                                            <div class="fs-9 fw-semibold text-gray-500">Enable to Languages dropdown .</div>
                                                                        </div>
                                                                    </div>
                                                                    <div class="d-flex justify-content-end">
                                                                        <div class="form-check form-check-solid form-check-custom form-switch">
                                                                            <input class="form-check-input w-45px h-30px" type="checkbox" name="infobox_settings[languages]" id="languages"  value="true"
                                                                            <?=$infobox_settings['languages'] == 'true' ? 'checked' : '' ?>>
                                                                            <label class="form-check-label fs-9" for="languages"></label>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                    </div>
                                                          <div class="row border-bottom">
                                                        <div class="d-flex flex-stack">
                                                                    <div class="d-flex">
                                                                        <div class="d-flex flex-column">
                                                                            <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Light/Dark Mode Selector </a>
                                                                            <div class="fs-9 fw-semibold text-gray-500">Enable to show Light/Dark Mode .</div>
                                                                        </div>
                                                                    </div>
                                                                    <div class="d-flex justify-content-end">
                                                                        <div class="form-check form-check-solid form-check-custom form-switch">
                                                                            <input class="form-check-input w-45px h-30px theme-trigger" type="checkbox" name="infobox_settings[theme]" id="theme"  value="true" data-target="themeOptions"
                                                                            <?=$infobox_settings['theme'] == 'true' ? 'checked' : '' ?>>
                                                                            <label class="form-check-label fs-9" for="theme"></label>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                    </div>
                                                    
                                                  
                                                        <div class="row">
                                                            
                                                                <div class="d-flex flex-stack">
                                                                    <div class="d-flex">
                                                                        <div class="d-flex flex-column">
                                                                            <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Theme Mode </a>
                                                                            <div class="fs-9 fw-semibold text-gray-500">Select Light Dark or system.</div>
                                                                        </div>
                                                                    </div>
                                                                    <div class="d-flex justify-content-end">
                                                                        <select class="form-select form-select-sm mb-2" name="infobox_settings[theme_mode]">
    <option value="light" <?= $infobox_settings['theme_mode'] === 'light' ? 'selected' : '' ?>>Light</option>
    <option value="dark" <?= $infobox_settings['theme_mode'] === 'dark' ? 'selected' : '' ?>>Dark</option>
     <option value="system" <?= $infobox_settings['theme_mode'] === 'system' ? 'selected' : '' ?>>System</option>
</select>
                                                                    </div>
                                                                </div>
                                                                
                                                                
                               
                            </div>
                            
                                 <div class="row hidden" style="display:none;">
                                <!-- Primary Color -->
<div class="row ">
    <label class="col-lg-6 col-form-label required fw-semibold fs-6">Primary Color</label> 
    <div class="col-lg-6 fv-row">
        <input type="color" placeholder="Primary Color" name="infobox_settings[primary]" 
               value="<?= isset($infobox_settings['primary']) ? $infobox_settings['primary'] : '#2563eb'; ?>" 
               class="form-control form-control-sm"> 
    </div>
</div>

<!-- Primary Hover Color -->
<div class="row ">
    <label class="col-lg-6 col-form-label required fw-semibold fs-6">Primary Hover Color</label> 
    <div class="col-lg-6 fv-row">
        <input type="color" placeholder="Primary Hover Color" name="infobox_settings[primary_hover]" 
               value="<?= isset($infobox_settings['primary_hover']) ? $infobox_settings['primary_hover'] : '#1d4ed8'; ?>" 
               class="form-control form-control-sm"> 
    </div>
</div>

<!-- Dark Color -->
<div class="row ">
    <label class="col-lg-6 col-form-label required fw-semibold fs-6">Dark Color</label> 
    <div class="col-lg-6 fv-row">
        <input type="color" placeholder="Dark Color" name="infobox_settings[dark]" 
               value="<?= isset($infobox_settings['dark']) ? $infobox_settings['dark'] : '#111827'; ?>" 
               class="form-control form-control-sm"> 
    </div>
</div>

<!-- Dark Lighter Color -->
<div class="row ">
    <label class="col-lg-6 col-form-label required fw-semibold fs-6">Dark Lighter Color</label> 
    <div class="col-lg-6 fv-row">
        <input type="color" placeholder="Dark Lighter Color" name="infobox_settings[dark_lighter]" 
               value="<?= isset($infobox_settings['dark_lighter']) ? $infobox_settings['dark_lighter'] : '#1f2937'; ?>" 
               class="form-control form-control-sm"> 
    </div>
</div>

<!-- Light Color -->
<div class="row ">
    <label class="col-lg-6 col-form-label required fw-semibold fs-6">Light Color</label> 
    <div class="col-lg-6 fv-row">
        <input type="color" placeholder="Light Color" name="infobox_settings[light]" 
               value="<?= isset($infobox_settings['light']) ? $infobox_settings['light'] : '#f8fafc'; ?>" 
               class="form-control form-control-sm"> 
    </div>
</div>

<!-- Light Darker Color -->
<div class="row ">
    <label class="col-lg-6 col-form-label required fw-semibold fs-6">Light Darker Color</label> 
    <div class="col-lg-6 fv-row">
        <input type="color" placeholder="Light Darker Color" name="infobox_settings[light_darker]" 
               value="<?= isset($infobox_settings['light_darker']) ? $infobox_settings['light_darker'] : '#f1f5f9'; ?>" 
               class="form-control form-control-sm"> 
    </div>
</div>

<!-- Border Light Color -->
<div class="row ">
    <label class="col-lg-6 col-form-label required fw-semibold fs-6">Border Light Color</label> 
    <div class="col-lg-6 fv-row">
        <input type="color" placeholder="Border Light Color" name="infobox_settings[border_light]" 
               value="<?= isset($infobox_settings['border_light']) ? $infobox_settings['border_light'] : '#e2e8f0'; ?>" 
               class="form-control form-control-sm"> 
    </div>
</div>

<!-- Border Dark Color -->
<div class="row ">
    <label class="col-lg-6 col-form-label required fw-semibold fs-6">Border Dark Color</label> 
    <div class="col-lg-6 fv-row">
        <input type="color" placeholder="Border Dark Color" name="infobox_settings[border_dark]" 
               value="<?= isset($infobox_settings['border_dark']) ? $infobox_settings['border_dark'] : '#374151'; ?>" 
               class="form-control form-control-sm"> 
    </div>
</div>

<!-- Disabled Color -->
<div class="row ">
    <label class="col-lg-6 col-form-label required fw-semibold fs-6">Disabled Color</label> 
    <div class="col-lg-6 fv-row">
        <input type="color" placeholder="Disabled Color" name="infobox_settings[disabled]" 
               value="<?= isset($infobox_settings['disabled']) ? $infobox_settings['disabled'] : '#94a3b8'; ?>" 
               class="form-control form-control-sm"> 
    </div>
</div>

<!-- Accent Color -->
<div class="row ">
    <label class="col-lg-6 col-form-label required fw-semibold fs-6">Accent Color</label> 
    <div class="col-lg-6 fv-row">
        <input type="color" placeholder="Accent Color" name="infobox_settings[accent]" 
               value="<?= isset($infobox_settings['accent']) ? $infobox_settings['accent'] : '#3b82f6'; ?>" 
               class="form-control form-control-sm"> 
    </div>
</div>

<!-- Accent Success Color -->
<div class="row ">
    <label class="col-lg-6 col-form-label required fw-semibold fs-6">Accent Success Color</label> 
    <div class="col-lg-6 fv-row">
        <input type="color" placeholder="Accent Success Color" name="infobox_settings[accent_success]" 
               value="<?= isset($infobox_settings['accent_success']) ? $infobox_settings['accent_success'] : '#10b981'; ?>" 
               class="form-control form-control-sm"> 
    </div>
</div>

<!-- Accent Warning Color -->
<div class="row ">
    <label class="col-lg-6 col-form-label required fw-semibold fs-6">Accent Warning Color</label> 
    <div class="col-lg-6 fv-row">
        <input type="color" placeholder="Accent Warning Color" name="infobox_settings[accent_warning]" 
               value="<?= isset($infobox_settings['accent_warning']) ? $infobox_settings['accent_warning'] : '#f59e0b'; ?>" 
               class="form-control form-control-sm"> 
    </div>
</div>

<!-- Accent Error Color -->
<div class="row ">
    <label class="col-lg-6 col-form-label required fw-semibold fs-6">Accent Error Color</label> 
    <div class="col-lg-6 fv-row">
        <input type="color" placeholder="Accent Error Color" name="infobox_settings[accent_error]" 
               value="<?= isset($infobox_settings['accent_error']) ? $infobox_settings['accent_error'] : '#ef4444'; ?>" 
               class="form-control form-control-sm"> 
    </div>
</div>

                            </div>
                       
                                                 
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Function to handle toggle behavior
    function setupToggle(toggleClass) {
        const toggle = document.querySelector('.' + toggleClass);
        if (toggle) {
            toggle.addEventListener('change', function() {
                const targetId = this.getAttribute('data-target');
                const targetElement = document.getElementById(targetId);
                if (targetElement) {
                    targetElement.style.display = this.checked ? 'block' : 'none';
                }
            });
        }
    }

    // Setup both toggles
    setupToggle('statistics-trigger');
    setupToggle('theme-trigger');
});
</script>
                                                
                                                </div>
                                                
                                                    <div class="card-body border-top p-3">
                                            
                                                                               <div class="row">
                                <label class="col-lg-6 col-form-label required fw-semibold fs-6">Dashboard Transactions</label>
                                <div class="col-lg-6 fv-row fv-plugins-icon-container">
                                    <input type="text" placeholder="Enter Quantity" name="infobox_settings[dtransactions]" value="<?=$infobox_settings['dtransactions'] ?? 5; ?>" class="form-control form-control-sm">
                                </div>
                            </div>
                            
                            <div class="row">
                                <label class="col-lg-6 col-form-label required fw-semibold fs-6">Dashboard Activities Logs</label>
                                <div class="col-lg-6 fv-row fv-plugins-icon-container">
                                    <input type="text" placeholder="Enter Quantity" name="infobox_settings[dlogs]" value="<?=$infobox_settings['dlogs'] ?? 5; ?>" class="form-control form-control-sm">
                                </div>
                            </div>
                            
                            <div class="row">
                                <label class="col-lg-6 col-form-label required fw-semibold fs-6">Dashboard Packages</label>
                                <div class="col-lg-6 fv-row fv-plugins-icon-container">
                                    <input type="text" placeholder="Enter Quantity" name="infobox_settings[dpackages]" value="<?=$infobox_settings['dpackages'] ?? 5; ?>" class="form-control form-control-sm">
                                </div>
   <div class="row mb-4">
            <label class="col-lg-6 col-form-label fw-semibold fs-6">Main Stats</label>
            <div class="col-lg-6 fv-row fv-plugins-icon-container">
                <div class="mt-3">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="form-check form-check-custom form-check-solid mb-2">
                                <input class="form-check-input" type="checkbox" name="infobox_settings[dashboard_show_stats_earnings_today]" value="true" <?=isset($infobox_settings['dashboard_show_stats_earnings_today']) && $infobox_settings['dashboard_show_stats_earnings_today'] ? 'checked' : '';?>>
                                <label class="form-check-label fs-7">Show Earnings Today</label>
                            </div>
                            <div class="form-check form-check-custom form-check-solid mb-2">
                                <input class="form-check-input" type="checkbox" name="infobox_settings[dashboard_show_stats_earnings_total]" value="true" <?=isset($infobox_settings['dashboard_show_stats_earnings_total']) && $infobox_settings['dashboard_show_stats_earnings_total'] ? 'checked' : '';?>>
                                <label class="form-check-label fs-7">Show Total Earnings</label>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-check form-check-custom form-check-solid mb-2">
                                <input class="form-check-input" type="checkbox" name="infobox_settings[dashboard_show_stats_bonuses]" value="true" <?=isset($infobox_settings['dashboard_show_stats_bonuses']) && $infobox_settings['dashboard_show_stats_bonuses'] ? 'checked' : '';?>>
                                <label class="form-check-label fs-7">Show Bonuses</label>
                            </div>
                             <div class="form-check form-check-custom form-check-solid mb-2">
                                <input class="form-check-input" type="checkbox" name="infobox_settings[dashboard_show_stats_tier]" value="true" <?=isset($infobox_settings['dashboard_show_stats_tier']) && $infobox_settings['dashboard_show_stats_tier'] ? 'checked' : '';?>>
                                <label class="form-check-label fs-7">Show Account Tier</label>
                            </div>
                            <div class="form-check form-check-custom form-check-solid mb-2">
                                <input class="form-check-input" type="checkbox" name="infobox_settings[dashboard_show_stats_dailystreak]" value="true" <?=isset($infobox_settings['dashboard_show_stats_dailystreak']) && $infobox_settings['dashboard_show_stats_dailystreak'] ? 'checked' : '';?>>
                                <label class="form-check-label fs-7">Show Daily Streak</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Investment Stats Section -->
        <div class="row mb-4">
            <label class="col-lg-6 col-form-label fw-semibold fs-6">Investment Stats</label>
            <div class="col-lg-6 fv-row fv-plugins-icon-container">
                <div class="form-check form-check-custom form-check-solid mb-2">
                    <input class="form-check-input" type="checkbox" name="infobox_settings[dashboard_show_investment_stats]" value="true" <?=isset($infobox_settings['dashboard_show_investment_stats']) && $infobox_settings['dashboard_show_investment_stats'] ? 'checked' : '';?>>
                    <label class="form-check-label fs-7">Show Investment Stats Section</label>
                </div>
                
                <div class="mt-3 ps-4">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="form-check form-check-custom form-check-solid mb-2">
                                <input class="form-check-input" type="checkbox" name="infobox_settings[dashboard_show_investment_stats_total]" value="true" <?=isset($infobox_settings['dashboard_show_investment_stats_total']) && $infobox_settings['dashboard_show_investment_stats_total'] ? 'checked' : '';?>>
                                <label class="form-check-label fs-7">Show Total Investment</label>
                            </div>
                            <div class="form-check form-check-custom form-check-solid mb-2">
                                <input class="form-check-input" type="checkbox" name="infobox_settings[dashboard_show_investment_stats_active]" value="true" <?=isset($infobox_settings['dashboard_show_investment_stats_active']) && $infobox_settings['dashboard_show_investment_stats_active'] ? 'checked' : '';?>>
                                <label class="form-check-label fs-7">Show Active Investments</label>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-check form-check-custom form-check-solid mb-2">
                                <input class="form-check-input" type="checkbox" name="infobox_settings[dashboard_show_investment_stats_returned]" value="true" <?=isset($infobox_settings['dashboard_show_investment_stats_returned']) && $infobox_settings['dashboard_show_investment_stats_returned'] ? 'checked' : '';?>>
                                <label class="form-check-label fs-7">Show Returned Amount</label>
                            </div>
                            <div class="form-check form-check-custom form-check-solid mb-2">
                                <input class="form-check-input" type="checkbox" name="infobox_settings[dashboard_show_investment_stats_released]" value="true" <?=isset($infobox_settings['dashboard_show_investment_stats_released']) && $infobox_settings['dashboard_show_investment_stats_released'] ? 'checked' : '';?>>
                                <label class="form-check-label fs-7">Show Released Amount</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Trading Stats Section -->
        <div class="row mb-4">
            <label class="col-lg-6 col-form-label fw-semibold fs-6">Trading Stats</label>
            <div class="col-lg-6 fv-row fv-plugins-icon-container">
                <div class="form-check form-check-custom form-check-solid mb-2">
                    <input class="form-check-input" type="checkbox" name="infobox_settings[dashboard_show_trading_stats]" value="true" <?=isset($infobox_settings['dashboard_show_trading_stats']) && $infobox_settings['dashboard_show_trading_stats'] ? 'checked' : '';?>>
                    <label class="form-check-label fs-7">Show Trading Stats Section</label>
                </div>
                
                <div class="mt-3 ps-4">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="form-check form-check-custom form-check-solid mb-2">
                                <input class="form-check-input" type="checkbox" name="infobox_settings[dashboard_show_trading_stats_total_pnl]" value="true" <?=isset($infobox_settings['dashboard_show_trading_stats_total_pnl']) && $infobox_settings['dashboard_show_trading_stats_total_pnl'] ? 'checked' : '';?>>
                                <label class="form-check-label fs-7">Show Total PnL</label>
                            </div>
                            <div class="form-check form-check-custom form-check-solid mb-2">
                                <input class="form-check-input" type="checkbox" name="infobox_settings[dashboard_show_trading_stats_today_pnl]" value="true" <?=isset($infobox_settings['dashboard_show_trading_stats_today_pnl']) && $infobox_settings['dashboard_show_trading_stats_today_pnl'] ? 'checked' : '';?>>
                                <label class="form-check-label fs-7">Show Today's PnL</label>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-check form-check-custom form-check-solid mb-2">
                                <input class="form-check-input" type="checkbox" name="infobox_settings[dashboard_show_trading_stats_total_trades]" value="true" <?=isset($infobox_settings['dashboard_show_trading_stats_total_trades']) && $infobox_settings['dashboard_show_trading_stats_total_trades'] ? 'checked' : '';?>>
                                <label class="form-check-label fs-7">Show Total Trades</label>
                            </div>
                            <div class="form-check form-check-custom form-check-solid mb-2">
                                <input class="form-check-input" type="checkbox" name="infobox_settings[dashboard_show_trading_stats_active_trades]" value="true" <?=isset($infobox_settings['dashboard_show_trading_stats_active_trades']) && $infobox_settings['dashboard_show_trading_stats_active_trades'] ? 'checked' : '';?>>
                                <label class="form-check-label fs-7">Show Active Trades</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Statistics Section -->
        <div class="row mb-4">
            <label class="col-lg-6 col-form-label fw-semibold fs-6">General Statistics</label>
            <div class="col-lg-6 fv-row fv-plugins-icon-container">
                <div class="form-check form-check-custom form-check-solid mb-2">
                    <input class="form-check-input" type="checkbox" name="infobox_settings[dashboard_show_statistics]" value="true" <?=isset($infobox_settings['dashboard_show_statistics']) && $infobox_settings['dashboard_show_statistics'] ? 'checked' : '';?>>
                    <label class="form-check-label fs-7">Show Statistics Section</label>
                </div>
                
                <div class="mt-3 ps-4">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="form-check form-check-custom form-check-solid mb-2">
                                <input class="form-check-input" type="checkbox" name="infobox_settings[dashboard_show_statistics_referrals]" value="true" <?=isset($infobox_settings['dashboard_show_statistics_referrals']) && $infobox_settings['dashboard_show_statistics_referrals'] ? 'checked' : '';?>>
                                <label class="form-check-label fs-7">Show Total Referrals</label>
                            </div>
                            <div class="form-check form-check-custom form-check-solid mb-2">
                                <input class="form-check-input" type="checkbox" name="infobox_settings[dashboard_show_statistics_transfers]" value="true" <?=isset($infobox_settings['dashboard_show_statistics_transfers']) && $infobox_settings['dashboard_show_statistics_transfers'] ? 'checked' : '';?>>
                                <label class="form-check-label fs-7">Show Total Transfers</label>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-check form-check-custom form-check-solid mb-2">
                                <input class="form-check-input" type="checkbox" name="infobox_settings[dashboard_show_statistics_exchanges]" value="true" <?=isset($infobox_settings['dashboard_show_statistics_exchanges']) && $infobox_settings['dashboard_show_statistics_exchanges'] ? 'checked' : '';?>>
                                <label class="form-check-label fs-7">Show Total Exchanges</label>
                            </div>
                            <div class="form-check form-check-custom form-check-solid mb-2">
                                <input class="form-check-input" type="checkbox" name="infobox_settings[dashboard_show_statistics_referrallink]" value="true" <?=isset($infobox_settings['dashboard_show_statistics_referrallink']) && $infobox_settings['dashboard_show_statistics_referrallink'] ? 'checked' : '';?>>
                                <label class="form-check-label fs-7">Show Referral Link</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Withdrawal Stats Section -->
        <div class="row mb-4">
            <label class="col-lg-6 col-form-label fw-semibold fs-6">Withdrawal Statistics</label>
            <div class="col-lg-6 fv-row fv-plugins-icon-container">
                <div class="form-check form-check-custom form-check-solid mb-2">
                    <input class="form-check-input" type="checkbox" name="infobox_settings[dashboard_show_withdrawal_stats]" value="true" <?=isset($infobox_settings['dashboard_show_withdrawal_stats']) && $infobox_settings['dashboard_show_withdrawal_stats'] ? 'checked' : '';?>>
                    <label class="form-check-label fs-7">Show Withdrawal Stats Section</label>
                </div>
                
                <div class="mt-3 ps-4">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="form-check form-check-custom form-check-solid mb-2">
                                <input class="form-check-input" type="checkbox" name="infobox_settings[dashboard_show_withdrawal_stats_total]" value="true" <?=isset($infobox_settings['dashboard_show_withdrawal_stats_total']) && $infobox_settings['dashboard_show_withdrawal_stats_total'] ? 'checked' : '';?>>
                                <label class="form-check-label fs-7">Show Total Withdrawals</label>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-check form-check-custom form-check-solid mb-2">
                                <input class="form-check-input" type="checkbox" name="infobox_settings[dashboard_show_withdrawal_stats_pending]" value="true" <?=isset($infobox_settings['dashboard_show_withdrawal_stats_pending']) && $infobox_settings['dashboard_show_withdrawal_stats_pending'] ? 'checked' : '';?>>
                                <label class="form-check-label fs-7">Show Pending Withdrawals</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Wallets Section -->
        <div class="row mb-4">
            <label class="col-lg-6 col-form-label fw-semibold fs-6">Wallets Display</label>
            <div class="col-lg-6 fv-row fv-plugins-icon-container">
                <div class="form-check form-check-custom form-check-solid mb-2">
                    <input class="form-check-input" type="checkbox" name="infobox_settings[dashboard_show_wallets]" value="true" <?=isset($infobox_settings['dashboard_show_wallets']) && $infobox_settings['dashboard_show_wallets'] ? 'checked' : '';?>>
                    <label class="form-check-label fs-7">Show Wallets Section</label>
                </div>
            </div>
        </div>
                            </div>
                                                
                                        
                                                
                                                </div>
<div class="card-body border-top p-3">
    <!-- Transactions Page Settings -->
    <div class="row mb-4">
        <label class="col-lg-6 col-form-label required fw-semibold fs-6">Transactions Page</label>
        <div class="col-lg-6 fv-row fv-plugins-icon-container">
            <label> Number of Transactions Per Page</label>
            <input type="text" placeholder="Enter Quantity" name="infobox_settings[transactions]" value="<?=$infobox_settings['transactions'] ?: 20;?>" class="form-control form-control-sm">
            
            <div class="mt-3">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="form-check form-check-custom form-check-solid mb-1">
                            <input class="form-check-input" type="checkbox" name="infobox_settings[transactions_show_address]" value="true" <?=isset($infobox_settings['transactions_show_address']) && $infobox_settings['transactions_show_address'] ? 'checked' : '';?>>
                            <label class="form-check-label fs-7">Show Address</label>
                        </div>
                        <div class="form-check form-check-custom form-check-solid">
                            <input class="form-check-input" type="checkbox" name="infobox_settings[transactions_show_txn]" value="true" <?=isset($infobox_settings['transactions_show_txn']) && $infobox_settings['transactions_show_txn'] ? 'checked' : '';?>>
                            <label class="form-check-label fs-7">Show TXN</label>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="form-check form-check-custom form-check-solid mb-1">
                            <input class="form-check-input" type="checkbox" name="infobox_settings[transactions_show_details]" value="true" <?=isset($infobox_settings['transactions_show_details']) && $infobox_settings['transactions_show_details'] ? 'checked' : '';?>>
                            <label class="form-check-label fs-7">Show Details</label>
                        </div>
                        <div class="form-check form-check-custom form-check-solid">
                            <input class="form-check-input" type="checkbox" name="infobox_settings[transactions_show_txn_url]" value="true" <?=isset($infobox_settings['transactions_show_txn_url']) && $infobox_settings['transactions_show_txn_url'] ? 'checked' : '';?>>
                            <label class="form-check-label fs-7">Show TXN URL</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Invested Page Settings -->
    <div class="row mb-4">
        <label class="col-lg-6 col-form-label required fw-semibold fs-6">Invested Page</label>
        <div class="col-lg-6 fv-row fv-plugins-icon-container">
            <label> Number of Invetments Per Page</label>
            <input type="text" placeholder="Enter Quantity" name="infobox_settings[packages]" value="<?=$infobox_settings['packages'] ?: 20; ?>" class="form-control form-control-sm">
            
            <div class="mt-3">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="form-check form-check-custom form-check-solid mb-1">
                            <input class="form-check-input" type="checkbox" name="infobox_settings[invested_next_earning]" value="true" <?=isset($infobox_settings['invested_next_earning']) && $infobox_settings['invested_next_earning'] ? 'checked' : '';?>>
                            <label class="form-check-label fs-7">Next Earning</label>
                        </div>
                        <div class="form-check form-check-custom form-check-solid mb-1">
                            <input class="form-check-input" type="checkbox" name="infobox_settings[invested_next_profit]" value="true" <?=isset($infobox_settings['invested_next_profit']) && $infobox_settings['invested_next_profit'] ? 'checked' : '';?>>
                            <label class="form-check-label fs-7">Next Profit</label>
                        </div>
                        <div class="form-check form-check-custom form-check-solid mb-1">
                            <input class="form-check-input" type="checkbox" name="infobox_settings[invested_last_earning_time]" value="true" <?=isset($infobox_settings['invested_last_earning_time']) && $infobox_settings['invested_last_earning_time'] ? 'checked' : '';?>>
                            <label class="form-check-label fs-7">Last Earning Time</label>
                        </div>
                        <div class="form-check form-check-custom form-check-solid mb-1">
                            <input class="form-check-input" type="checkbox" name="infobox_settings[invested_description]" value="true" <?=isset($infobox_settings['invested_description']) && $infobox_settings['invested_description'] ? 'checked' : '';?>>
                            <label class="form-check-label fs-7">Description</label>
                        </div>
                        <div class="form-check form-check-custom form-check-solid">
                            <input class="form-check-input" type="checkbox" name="infobox_settings[invested_address]" value="true" <?=isset($infobox_settings['invested_address']) && $infobox_settings['invested_address'] ? 'checked' : '';?>>
                            <label class="form-check-label fs-7">Address</label>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="form-check form-check-custom form-check-solid mb-1">
                            <input class="form-check-input" type="checkbox" name="infobox_settings[invested_expires]" value="true" <?=isset($infobox_settings['invested_expires']) && $infobox_settings['invested_expires'] ? 'checked' : '';?>>
                            <label class="form-check-label fs-7">Expires</label>
                        </div>
                        <div class="form-check form-check-custom form-check-solid mb-1">
                            <input class="form-check-input" type="checkbox" name="infobox_settings[invested_earned]" value="true" <?=isset($infobox_settings['invested_earned']) && $infobox_settings['invested_earned'] ? 'checked' : '';?>>
                            <label class="form-check-label fs-7">Earned</label>
                        </div>
                        <div class="form-check form-check-custom form-check-solid mb-1">
                            <input class="form-check-input" type="checkbox" name="infobox_settings[invested_total_profit]" value="true" <?=isset($infobox_settings['invested_total_profit']) && $infobox_settings['invested_total_profit'] ? 'checked' : '';?>>
                            <label class="form-check-label fs-7">Total Profit</label>
                        </div>
                        <div class="form-check form-check-custom form-check-solid mb-1">
                            <input class="form-check-input" type="checkbox" name="infobox_settings[invested_progress_bar]" value="true" <?=isset($infobox_settings['invested_progress_bar']) && $infobox_settings['invested_progress_bar'] ? 'checked' : '';?>>
                            <label class="form-check-label fs-7">Progress Bar</label>
                        </div>
                         <div class="form-check form-check-custom form-check-solid">
                            <input class="form-check-input" type="checkbox" name="infobox_settings[invested_txn]" value="true" <?=isset($infobox_settings['invested_txn']) && $infobox_settings['invested_txn'] ? 'checked' : '';?>>
                            <label class="form-check-label fs-7">Transactiond ID</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
     <div class="row mb-4">
        <label class="col-lg-6 col-form-label required fw-semibold fs-6">Affiliates Page</label>
        <div class="col-lg-6 fv-row fv-plugins-icon-container">
             <label> Number of Affiliates Per Page</label>
            <input type="text" placeholder="Enter Quantity" name="infobox_settings[affiliates]" value="<?=$infobox_settings['affiliates'] ?: 20; ?>" class="form-control form-control-sm">

  
            <div class="mt-3">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="form-check form-check-custom form-check-solid mb-1">
                            <input class="form-check-input" type="checkbox" name="infobox_settings[affiliates_show_levels]" value="true" <?=isset($infobox_settings['affiliates_show_levels']) && $infobox_settings['affiliates_show_levels'] ? 'checked' : '';?>>
                            <label class="form-check-label fs-7">Show Affiliates Levels</label>
                        </div>
                        <div class="form-check form-check-custom form-check-solid mb-1">
                            <input class="form-check-input" type="checkbox" name="infobox_settings[affiliates_show_stats]" value="true" <?=isset($infobox_settings['affiliates_show_stats']) && $infobox_settings['affiliates_show_stats'] ? 'checked' : '';?>>
                            <label class="form-check-label fs-7">Show Stats</label>
                        </div>
                        <div class="form-check form-check-custom form-check-solid mb-1">
                            <input class="form-check-input" type="checkbox" name="infobox_settings[affiliates_show_refid]" value="true" <?=isset($infobox_settings['affiliates_show_refid']) && $infobox_settings['affiliates_show_refid'] ? 'checked' : '';?>>
                            <label class="form-check-label fs-7">Show Ref ID</label>
                        </div>
                         <div class="form-check form-check-custom form-check-solid mb-1">
                            <input class="form-check-input" type="checkbox" name="infobox_settings[affiliates_show_reflink]" value="true" <?=isset($infobox_settings['affiliates_show_reflink']) && $infobox_settings['affiliates_show_reflink'] ? 'checked' : '';?>>
                            <label class="form-check-label fs-7">Show Ref Link</label>
                        </div>
                         <div class="form-check form-check-custom form-check-solid">
                            <input class="form-check-input" type="checkbox" name="infobox_settings[affiliates_show_affiliates_users_email]" value="true" <?=isset($infobox_settings['affiliates_show_affiliates_users_email']) && $infobox_settings['affiliates_show_affiliates_users_email'] ? 'checked' : '';?>>
                            <label class="form-check-label fs-7">Show Affiliates Users Email</label>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="form-check form-check-custom form-check-solid mb-1">
                            <input class="form-check-input" type="checkbox" name="infobox_settings[affiliates_show_banners]" value="true" <?=isset($infobox_settings['affiliates_show_banners']) && $infobox_settings['affiliates_show_banners'] ? 'checked' : '';?>>
                            <label class="form-check-label fs-7">Show Banners</label>
                        </div>
                        <div class="form-check form-check-custom form-check-solid mb-1">
                            <input class="form-check-input" type="checkbox" name="infobox_settings[affiliates_show_levels_stats]" value="true" <?=isset($infobox_settings['affiliates_show_levels_stats']) && $infobox_settings['affiliates_show_levels_stats'] ? 'checked' : '';?>>
                            <label class="form-check-label fs-7">Show Level Statistics</label>
                        </div>
                        <div class="form-check form-check-custom form-check-solid mb-1">
                            <input class="form-check-input" type="checkbox" name="infobox_settings[affiliates_show_affiliates_pms]" value="true" <?=isset($infobox_settings['affiliates_show_affiliates_pms']) && $infobox_settings['affiliates_show_affiliates_pms'] ? 'checked' : '';?>>
                            <label class="form-check-label fs-7">Show Commissions by Payment Methods</label>
                        </div>
                        <div class="form-check form-check-custom form-check-solid mb-1">
                            <input class="form-check-input" type="checkbox" name="infobox_settings[affiliates_show_affiliates_users]" value="true" <?=isset($infobox_settings['affiliates_show_affiliates_users']) && $infobox_settings['affiliates_show_affiliates_users'] ? 'checked' : '';?>>
                            <label class="form-check-label fs-7">Show Affiliates Users</label>
                        </div>
                         <div class="form-check form-check-custom form-check-solid ">
                            <input class="form-check-input" type="checkbox" name="infobox_settings[affiliates_show_affiliates_users_username]" value="true" <?=isset($infobox_settings['affiliates_show_affiliates_users_username']) && $infobox_settings['affiliates_show_affiliates_users_username'] ? 'checked' : '';?>>
                            <label class="form-check-label fs-7">Show Affiliates Users username</label>
                        </div>
                       
                       
                    </div>
                </div>
            </div>



        </div>
    </div>
      <div class="row mb-4">
        <label class="col-lg-6 col-form-label required fw-semibold fs-6">Trading Screen Page</label>
        <div class="col-lg-6 fv-row fv-plugins-icon-container">
           
            <div class="mt-3">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="form-check form-check-custom form-check-solid mb-1">
                            <input class="form-check-input" type="checkbox" name="infobox_settings[trading_buy_sell_markers]" value="true" <?=isset($infobox_settings['trading_buy_sell_markers']) && $infobox_settings['trading_buy_sell_markers'] ? 'checked' : '';?>>
                            <label class="form-check-label fs-7">Show Buy Sell Trading Order Markers</label>
                        </div>
                        
                    </div>
                    
                </div>
            </div>
        </div>
    </div>
  <div class="row mb-4">
        <label class="col-lg-6 col-form-label required fw-semibold fs-6">Trading Orders Page</label>
        <div class="col-lg-6 fv-row fv-plugins-icon-container">
            <label> Number of Orders Per Page</label>
            <input type="text" placeholder="Enter Quantity" name="infobox_settings[orders]" value="<?=$infobox_settings['orders'] ?: 20;?>" class="form-control form-control-sm">
            
            <div class="mt-3">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="form-check form-check-custom form-check-solid mb-1">
                            <input class="form-check-input" type="checkbox" name="infobox_settings[orders_show_percentage]" value="true" <?=isset($infobox_settings['orders_show_percentage']) && $infobox_settings['orders_show_percentage'] ? 'checked' : '';?>>
                            <label class="form-check-label fs-7">Show Percentages with Trade Results</label>
                        </div>
                        
                    </div>
                    
                </div>
            </div>
        </div>
    </div>

    <!-- Activities Logs Page Settings -->
    <div class="row mb-4">
        <label class="col-lg-6 col-form-label required fw-semibold fs-6">Activities Logs Page</label>
        <div class="col-lg-6 fv-row fv-plugins-icon-container">
            <input type="text" placeholder="Enter Quantity" name="infobox_settings[logs]" value="<?=$infobox_settings['logs'] ?: 20; ?>" class="form-control form-control-sm">
        </div>
    </div>
    
    <!-- Affiliates Page Settings -->
   
</div>
                                            <?php
$pages = [
    // Core navigation
    'home' => ['icon' => 'bi-house', 'description' => 'Home page navigation', 'auth' => false],
    'about' => ['icon' => 'bi-info-circle', 'description' => 'About us Page', 'auth' => false],
    'dashboard' => ['icon' => 'bi-grid', 'description' => 'User dashboard access', 'auth' => true],
    
    // Financial operations
    'invest' => ['icon' => 'bi-graph-up', 'description' => 'Investment options', 'auth' => true],
    'deposit' => ['icon' => 'bi-wallet', 'description' => 'Deposit funds', 'auth' => true],
    'withdraw' => ['icon' => 'bi-cash', 'description' => 'Withdraw funds', 'auth' => true],
    'transfer' => ['icon' => 'bi-arrow-left-right', 'description' => 'Transfer funds', 'auth' => true],
    'exchange' => ['icon' => 'bi-arrow-repeat', 'description' => 'Currency exchange', 'auth' => true],
    // Trading and Investment
    
    
    'trade' => ['icon' => 'bi-bar-chart', 'description' => 'Trading platform', 'auth' => true],
    'orders' => ['icon' => 'bi-list-check', 'description' => 'Order history', 'auth' => true],
    
    // Trading Types
    'spot' => ['icon' => 'bi-bar-chart-steps', 'description' => 'Spot trading', 'auth' => true, 'coming' => true,],
    'futures' => ['icon' => 'bi-graph-up-arrow', 'description' => 'Futures trading', 'auth' => true , 'coming' => true,],
    'p2p' => ['icon' => 'bi-people', 'description' => 'Peer to peer trading', 'auth' => true, 'coming' => true,],
    
    // Transaction Logs
    'transactions' => ['icon' => 'bi-journal-text', 'description' => 'Transactions history', 'auth' => true],
    'investments' => ['icon' => 'bi-journal-text', 'description' => 'Investment history', 'auth' => true],
    'deposit_logs' => ['icon' => 'bi-journal-text', 'description' => 'Deposit history', 'auth' => true],
    'withdraw_logs' => ['icon' => 'bi-journal-check', 'description' => 'Withdrawal history', 'auth' => true],
    'transfer_logs' => ['icon' => 'bi-arrow-left-right', 'description' => 'Transfer history', 'auth' => true],
    'exchange_logs' => ['icon' => 'bi-clock-history', 'description' => 'Exchange history', 'auth' => true],
    'faucet_logs' => ['icon' => 'bi-clock-history', 'description' => 'Faucet claim history', 'auth' => true],
    
    // Features
   
    'faucet' => ['icon' => 'bi-droplet', 'description' => 'Faucet rewards', 'auth' => true],   
    'daily_rewards' => ['icon' => 'bi-gift', 'description' => 'Daily rewards', 'auth' => true],
    'tap' => ['icon' => 'bi-list', 'description' => 'Tap', 'auth' => true],
    'tasks' => ['icon' => 'bi-list', 'description' => 'Tasks', 'auth' => true],
    

    
    // User Account
    'profile' => ['icon' => 'bi-person', 'description' => 'User profile settings', 'auth' => true],
    'wallets' => ['icon' => 'bi-wallet-2', 'description' => 'User wallets', 'auth' => true],
    'affiliates' => ['icon' => 'bi-people', 'description' => 'Affiliate program', 'auth' => true],
    'support' => ['icon' => 'bi-life-preserver', 'description' => 'Support center', 'auth' => true],
    
    // Support and Information
    
    'contact' => ['icon' => 'bi-chat', 'description' => 'Contact support', 'auth' => false],
    'faq' => ['icon' => 'bi-question-circle', 'description' => 'Frequently asked questions', 'auth' => false],
    'news' => ['icon' => 'bi-newspaper', 'description' => 'Latest updates', 'auth' => false],
    
    // Authentication
    'login' => ['icon' => 'bi-box-arrow-in-right', 'description' => 'User login', 'auth' => false],
    'register' => ['icon' => 'bi-person-plus', 'description' => 'New user registration', 'auth' => false],
    'logout' => ['icon' => 'bi-box-arrow-right', 'description' => 'User logout', 'auth' => true],
];
?>

<!-- Navigation Menu Settings -->
<div class="card">
<div class="card-header d-flex justify-content-between align-items-center">
    <h3 class="card-title">Navigation Menu Settings</h3>
    <button type="button" class="btn btn-sm btn-light-primary" id="resetOrder">
        <i class="bi bi-arrow-counterclockwise me-1"></i>Reset Order
    </button>
</div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-row-bordered table-hover">
                <thead>
                    <tr class="fw-bold fs-6 text-gray-800">
                        <th style="min-width: 150px;">Menu Item</th>
                        <th style="min-width: 200px;">Description</th>
                        <th style="min-width: 120px;">Navbar
                            <small class="d-block text-muted">Order</small>
                        </th>
                        <th style="min-width: 120px;">Sidebar
                            <small class="d-block text-muted">Order</small>
                        </th>
                        <th style="min-width: 120px;">Bottom Nav
                            <small class="d-block text-muted">Order</small>
                        </th>
                        <th style="min-width: 120px;">Quick Actions
                            <small class="d-block text-muted">Order</small>
                        </th>
                        <th style="min-width: 120px;">Trading Features
                            <small class="d-block text-muted">Order</small>
                        </th>
                        <th style="min-width: 100px;">Auth Required</th>
                          <th style="min-width: 100px;">Coming</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach($pages as $key => $item): ?>
                    <tr>
                        <td>
                            <div class="d-flex align-items-center gap-2">
                                <i class="bi <?= $item['icon'] ?>"></i>
                                <span class="fw-semibold"><?= ucfirst($key) ?></span>
                            </div>
                        </td>
                        <td><?= $item['description'] ?></td>
                        <td>
                            <div class="d-flex align-items-center gap-2">
                                <div class="form-check form-check-solid form-check-custom">
                                    <input type="checkbox" class="form-check-input" 
                                           name="infobox_settings[navbar][<?= $key ?>][enabled]" value="true"
                                           <?= isset($infobox_settings['navbar'][$key]['enabled']) && $infobox_settings['navbar'][$key]['enabled'] == 'true' ? 'checked' : '' ?>>
                                </div>
                                <input type="number" class="form-control form-control-sm w-65px"
                                       name="infobox_settings[navbar][<?= $key ?>][order]" 
                                       value="<?= $infobox_settings['navbar'][$key]['order'] ?? '0' ?>"
                                       min="0">
                            </div>
                           <? if(!$item['auth']) {?>
                            <div class="d-flex align-items-center gap-2">
                                <div class="form-check form-check-solid form-check-custom">
                                    <input type="checkbox" class="form-check-input" 
                                           name="infobox_settings[navbar][<?= $key ?>][after_login]" value="true"
                                           <?= isset($infobox_settings['navbar'][$key]['after_login']) && $infobox_settings['navbar'][$key]['after_login'] == 'true' ? 'checked' : '' ?>>
                                </div>
                              Show After Login
                            </div>
                            <?}?>
                        </td>
                        <td>
                            <div class="d-flex align-items-center gap-2">
                                <div class="form-check form-check-solid form-check-custom">
                                    <input type="checkbox" class="form-check-input" 
                                           name="infobox_settings[sidebar][<?= $key ?>][enabled]" value="true"
                                           <?= isset($infobox_settings['sidebar'][$key]['enabled']) && $infobox_settings['sidebar'][$key]['enabled'] == 'true' ? 'checked' : '' ?>>
                                </div>
                                <input type="number" class="form-control form-control-sm w-65px"
                                       name="infobox_settings[sidebar][<?= $key ?>][order]" 
                                       value="<?= $infobox_settings['sidebar'][$key]['order'] ?? '0' ?>"
                                       min="0">
                            </div>
                             <? if(!$item['auth']) {?>
                            <div class="d-flex align-items-center gap-2">
                                <div class="form-check form-check-solid form-check-custom">
                                    <input type="checkbox" class="form-check-input" 
                                           name="infobox_settings[sidebar][<?= $key ?>][after_login]" value="true"
                                           <?= isset($infobox_settings['sidebar'][$key]['after_login']) && $infobox_settings['sidebar'][$key]['after_login'] == 'true' ? 'checked' : '' ?>>
                                </div>
                              Show After Login
                            </div>
                            <?}?>
                        </td>
                        <td>
                            <div class="d-flex align-items-center gap-2">
                                <div class="form-check form-check-solid form-check-custom">
                                    <input type="checkbox" class="form-check-input" 
                                           name="infobox_settings[bottomnav][<?= $key ?>][enabled]" value="true"
                                           <?= isset($infobox_settings['bottomnav'][$key]['enabled']) && $infobox_settings['bottomnav'][$key]['enabled'] == 'true' ? 'checked' : '' ?>>
                                </div>
                                <input type="number" class="form-control form-control-sm w-65px"
                                       name="infobox_settings[bottomnav][<?= $key ?>][order]" 
                                       value="<?= $infobox_settings['bottomnav'][$key]['order'] ?? '0' ?>"
                                       min="0">
                            </div>
                             <? if(!$item['auth']) {?>
                            <div class="d-flex align-items-center gap-2">
                                <div class="form-check form-check-solid form-check-custom">
                                    <input type="checkbox" class="form-check-input" 
                                           name="infobox_settings[bottomnav][<?= $key ?>][after_login]" value="true"
                                           <?= isset($infobox_settings['bottomnav'][$key]['after_login']) && $infobox_settings['bottomnav'][$key]['after_login'] == 'true' ? 'checked' : '' ?>>
                                </div>
                              Show After Login
                            </div>
                            <?}?>
                        </td>
                        <td>
                            <div class="d-flex align-items-center gap-2">
                                <div class="form-check form-check-solid form-check-custom">
                                    <input type="checkbox" class="form-check-input" 
                                           name="infobox_settings[quickactions][<?= $key ?>][enabled]" value="true"
                                           <?= isset($infobox_settings['quickactions'][$key]['enabled']) && $infobox_settings['quickactions'][$key]['enabled'] == 'true' ? 'checked' : '' ?>>
                                </div>
                                <input type="number" class="form-control form-control-sm w-65px"
                                       name="infobox_settings[quickactions][<?= $key ?>][order]" 
                                       value="<?= $infobox_settings['quickactions'][$key]['order'] ?? '0' ?>"
                                       min="0">
                            </div>
                             <? if(!$item['auth']) {?>
                            <div class="d-flex align-items-center gap-2">
                                <div class="form-check form-check-solid form-check-custom">
                                    <input type="checkbox" class="form-check-input" 
                                           name="infobox_settings[quickactions][<?= $key ?>][after_login]" value="true"
                                           <?= isset($infobox_settings['quickactions'][$key]['after_login']) && $infobox_settings['quickactions'][$key]['after_login'] == 'true' ? 'checked' : '' ?>>
                                </div>
                              Show After Login
                            </div>
                            <?}?>
                        </td>
                        <td>
                            <div class="d-flex align-items-center gap-2">
                                <div class="form-check form-check-solid form-check-custom">
                                    <input type="checkbox" class="form-check-input" 
                                           name="infobox_settings[tradingfeatures][<?= $key ?>][enabled]" value="true"
                                           <?= isset($infobox_settings['tradingfeatures'][$key]['enabled']) && $infobox_settings['tradingfeatures'][$key]['enabled'] == 'true' ? 'checked' : '' ?>>
                                </div>
                                <input type="number" class="form-control form-control-sm w-65px"
                                       name="infobox_settings[tradingfeatures][<?= $key ?>][order]" 
                                       value="<?= $infobox_settings['tradingfeatures'][$key]['order'] ?? '0' ?>"
                                       min="0">
                            </div>
                             <? if(!$item['auth']) {?>
                            <div class="d-flex align-items-center gap-2">
                                <div class="form-check form-check-solid form-check-custom">
                                    <input type="checkbox" class="form-check-input" 
                                           name="infobox_settings[tradingfeatures][<?= $key ?>][after_login]" value="true"
                                           <?= isset($infobox_settings['tradingfeatures'][$key]['after_login']) && $infobox_settings['tradingfeatures'][$key]['after_login'] == 'true' ? 'checked' : '' ?>>
                                </div>
                              Show After Login
                            </div>
                            <?}?>
                        </td>
                        <td>
                            <div class="form-check form-check-solid form-check-custom">
                                <input type="checkbox" class="form-check-input" <?= $item['auth'] ? 'checked' : '' ?> disabled>
                            </div>
                        </td>
                         <td>
                            <div class="form-check form-check-solid form-check-custom">
                                <input type="checkbox" class="form-check-input" name="infobox_settings[coming_soon][<?= $key ?>][enabled]" value="true" 
                                <?= $item['coming'] && isset($infobox_settings['coming_soon'][$key]['enabled']) && $infobox_settings['coming_soon'][$key]['enabled'] == 'true' ? 'checked' : '' ?> >
                               
                            </div>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const navTable = document.querySelector('.table-responsive table');
    if (!navTable) return;

    function getOriginalOrder() {
        return Array.from(navTable.querySelectorAll('tbody tr')).map((row, index) => ({
            row: row,
            originalIndex: index + 1
        }));
    }

    function resetOrders(section) {
        const originalOrder = getOriginalOrder();
        originalOrder.forEach(({row, originalIndex}) => {
            const checkbox = row.querySelector(`input[name^="infobox_settings[${section}]"][type="checkbox"]`);
            const orderInput = row.querySelector(`input[name^="infobox_settings[${section}]"][type="number"]`);
            
            if (checkbox && orderInput && checkbox.checked) {
                orderInput.value = originalIndex.toString();
            }
        });
    }

    // Set up reset button event listener
    document.getElementById('resetOrder').addEventListener('click', function() {
        ['navbar', 'sidebar', 'bottomnav', 'quickactions', 'tradingfeatures'].forEach(section => {
            resetOrders(section);
        });
    });

    function updateOrderNumbers(section, skipAutoReorder = false) {
        const rows = Array.from(navTable.querySelectorAll('tbody tr'));
        const sectionCheckboxes = rows.map(row => ({
            checkbox: row.querySelector(`input[name^="infobox_settings[${section}]"][type="checkbox"]`),
            orderInput: row.querySelector(`input[name^="infobox_settings[${section}]"][type="number"]`)
        }));

        if (!skipAutoReorder) {
            let currentOrder = 1;
            const usedOrders = new Set();
            
            // First pass: Keep manually set orders that are valid
            sectionCheckboxes.forEach(({checkbox, orderInput}) => {
                if (checkbox && checkbox.checked && orderInput) {
                    const manualOrder = parseInt(orderInput.value);
                    if (manualOrder > 0) {
                        usedOrders.add(manualOrder);
                    }
                }
            });

            // Second pass: Assign available orders to items without valid manual orders
            sectionCheckboxes.forEach(({checkbox, orderInput}) => {
                if (checkbox && checkbox.checked && orderInput) {
                    const manualOrder = parseInt(orderInput.value);
                    if (manualOrder <= 0) {
                        while (usedOrders.has(currentOrder)) {
                            currentOrder++;
                        }
                        orderInput.value = currentOrder.toString();
                        usedOrders.add(currentOrder);
                        currentOrder++;
                    }
                }
            });
        }

        // Set disabled items to 0
        sectionCheckboxes.forEach(({checkbox, orderInput}) => {
            if (checkbox && !checkbox.checked && orderInput) {
                orderInput.value = '0';
            }
        });
    }

    function handleCheckboxChange(checkbox) {
        const section = checkbox.name.match(/\[(.*?)\]/)[1];
        const orderInput = checkbox.closest('.d-flex').querySelector('input[type="number"]');
        
        if (orderInput) {
            orderInput.disabled = !checkbox.checked;
            if (checkbox.checked && orderInput.value === '0') {
                updateOrderNumbers(section);
            } else if (!checkbox.checked) {
                orderInput.value = '0';
            }
        }
    }

    function validateNumberInput(input) {
        const section = input.name.match(/\[(.*?)\]/)[1];
        input.value = input.value.replace(/[^0-9]/g, '');
        const value = parseInt(input.value);
        if (isNaN(value) || value < 0) {
            input.value = '0';
        }
        
        updateOrderNumbers(section, true);
    }

    // Initialize event listeners for all sections
    ['navbar', 'sidebar', 'bottomnav', 'quickactions', 'tradingfeatures'].forEach(section => {
        const checkboxes = navTable.querySelectorAll(`input[name^="infobox_settings[${section}]"][type="checkbox"]:not([disabled])`);
        
        checkboxes.forEach(checkbox => {
            handleCheckboxChange(checkbox);
            checkbox.addEventListener('change', function() {
                handleCheckboxChange(this);
            });
        });
    });

    // Set up number input event listeners
    navTable.querySelectorAll('input[type="number"]').forEach(input => {
        input.addEventListener('input', function() {
            validateNumberInput(this);
        });

        input.addEventListener('keypress', function(e) {
            if (!/[0-9]/.test(e.key)) {
                e.preventDefault();
            }
        });
    });
});
</script>
                                       
                                                
                                                <!--end::Card body-->
                                                <!--begin::Actions-->
                                                <div class="card-footer d-flex justify-content-end py-6 px-9">
                                                    
                                                    <button type="submit" name="submit" class="btn btn-primary" >Save Changes</button>
                                                </div>
                                                <!--end::Actions-->
                                            </form>
                                            <!--end::Form-->
                                        </div>
                                        <!--end::Content-->

<?
}
if ($_GET['page'] == 'alerts') {
if (isset($_POST['submit'])) {

    $all_updates_successful = true; // Track all updates
    
    foreach ($_POST['class'] as $index => $value) {
        $content = cleanContent($_POST['content'][$index]);
        
        $stmt = $DB_CONN->prepare("UPDATE alerts SET class = ?, content = ? WHERE id = ?");
        $stmt->bind_param("ssi", $value, $content, $index);
        if (!$stmt->execute()) {
            $all_updates_successful = false; // Mark as failed if any update fails
            break;
        }
        $stmt->close();
    }
    
    if ($all_updates_successful) {
        updateSiteData($siteURL);
        $success_message = true;
    } else {
        $error_message = "Some updates failed to save. Please try again.";
    }
}


$lang = isset($_GET['lang']) ? $_GET['lang'] : $lang_id;
$stmt = $DB_CONN->prepare("SELECT * FROM alerts WHERE lang_id = ? ");
$stmt->bind_param("i", $lang);
$stmt->execute();
$pref = $stmt->get_result();
?>

<div class="card">
<!--begin::Card header-->
<div class="card-header min-h-unset py-2">
    <!--begin::Card title-->
    <div class="card-title">
        <!--begin::Title and counter-->
        <div class="d-flex flex-column">
            <div class="d-flex align-items-center gap-4">
                <h3 class="fw-bolder m-0">
                    <i class="ki-duotone ki-notification-status fs-1 me-2">
                        <span class="path1"></span>
                        <span class="path2"></span>
                        <span class="path3"></span>
                    </i>
                    System Alerts
                </h3>
                <span class="badge badge-light-primary fs-7 fw-bold">
                    <?php echo $pref->num_rows; ?> Alerts
                </span>
            </div>
            <p class="text-gray-400 fs-6 m-0 mt-2">
                <i class="ki-duotone ki-information-5 fs-7 me-1">
                    <span class="path1"></span>
                    <span class="path2"></span>
                    <span class="path3"></span>
                </i>
                Manage user-facing alerts across different pages and languages
            </p>
        </div>
        <!--end::Title and counter-->
    </div>
    <!--end::Card title-->

    <!--begin::Card toolbar-->
    <div class="card-toolbar">
        <!--begin::Language selector wrapper-->
        <div class="d-flex flex-column align-items-end gap-2">
              <form class="mb-8" action="?page=alerts" method="GET">
                  <input type="hidden" name="page" value="alerts">
            <div class="d-flex flex-column gap-2">
                <select name="lang" class="form-select form-select-sm form-select-solid w-200px" 
                        onchange="this.form.submit()"
                        data-control="select2"
                        data-placeholder="Select Language">
                    <?php  
                    $l = $DB_CONN->query("SELECT * FROM languagues WHERE status = 1");
                    while ($lan = $l->fetch_assoc()): 
                    ?>
                        <option value="<?php echo htmlspecialchars($lan['id']); ?>"
                                <?php echo ($lan['id'] == $lang) ? 'selected' : ''; ?>>
                            <?php echo htmlspecialchars($lan['name']); ?>
                        </option>
                    <?php endwhile; ?>
                </select>
                <div class="text-gray-500 fs-7">
                    <i class="ki-duotone ki-information-5 fs-7 me-1"></i>
                    Select the language to edit alerts for different localizations
                </div>
            </div>
        </form>
        </div>
        <!--end::Language selector wrapper-->
    </div>
    <!--end::Card toolbar-->
</div>
<!--end::Card header-->


    <!--begin::Card body-->
    <div class="card-body">
        <?php if (isset($success_message)): ?>
            <div class="alert alert-success d-flex align-items-center p-5 mb-7 fade show">
                <i class="ki-duotone ki-shield-tick fs-2hx text-success me-4">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
                <div class="d-flex flex-column">
                    <h4 class="mb-1 text-success">Updates Saved Successfully</h4>
                    <span>All alert changes have been saved and are now live.</span>
                </div>
                <button type="button" class="position-absolute position-sm-relative m-2 m-sm-0 top-0 end-0 btn btn-icon ms-sm-auto" data-bs-dismiss="alert">
                    <i class="ki-duotone ki-cross fs-1 text-success"><span class="path1"></span><span class="path2"></span></i>
                </button>
            </div>
        <?php endif; ?>
<?php if (isset($error_message)): ?>
    <div class="alert alert-danger d-flex align-items-center p-5 mb-7 fade show">
        <i class="ki-duotone ki-shield-cross fs-2hx text-danger me-4">
            <span class="path1"></span>
            <span class="path2"></span>
        </i>
        <div class="d-flex flex-column">
            <h4 class="mb-1 text-danger">Update Failed</h4>
            <span><?php echo htmlspecialchars($error_message); ?></span>
        </div>
        <button type="button" class="position-absolute position-sm-relative m-2 m-sm-0 top-0 end-0 btn btn-icon ms-sm-auto" data-bs-dismiss="alert">
            <i class="ki-duotone ki-cross fs-1 text-danger"><span class="path1"></span><span class="path2"></span></i>
        </button>
    </div>
<?php endif; ?>
   

        <!--begin::Alerts form-->
        <form method="POST" action="" class="alerts-form" id="alerts-form">
            <!--begin::Table-->
            <div class="table-responsive">
                <table class="table table-row-bordered table-row-dashed gy-4">
                    <thead>
                        <tr class="fw-bold fs-6 text-gray-800">
                            <th class="min-w-150px">Page</th>
                            <th class="min-w-200px">Alert Class</th>
                            <th>Alert Content</th>
                        </tr>
                    </thead>
                    <tbody>
    <?php while ($alert = $pref->fetch_assoc()): ?>
        <tr>
            <td class="fw-bold text-gray-800">
                <?php echo htmlspecialchars($alert['page']); ?>
            </td>
            <td>
                <div class="position-relative">
                    <input type="text" 
                           name="class[<?php echo $alert['id']; ?>]" 
                           class="form-control form-control-sm form-control-solid"
                           value="<?php echo htmlspecialchars($alert['class']); ?>"
                           placeholder="Enter alert class">
                </div>
            </td>
            <td>
                <div class="d-flex flex-column gap-2">
                    <textarea name="content[<?php echo $alert['id']; ?>]" 
                              class="form-control form-control-sm form-control-solid" 
                              rows="2"
                              placeholder="Enter alert content"><?php echo $alert['content']; ?></textarea>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge badge-light-info">Default</span>
                        <span class="text-gray-600 fs-7"><?php echo htmlspecialchars($alert['ref']); ?></span>
                    </div>
                </div>
            </td>
        </tr>
    <?php endwhile; ?>
</tbody>
                </table>
            </div>
            <!--end::Table-->

            <!--begin::Action buttons-->
            <div class="d-flex justify-content-end gap-2 mt-8">
                <button type="reset" class="btn btn-sm btn-light" id="reset-form">
                    Reset Changes
                </button>
                <button type="submit" name="submit" class="btn btn-sm btn-primary" data-kt-indicator="off">
                    <span class="indicator-label">
                        Save Changes
                    </span>
                    <span class="indicator-progress">
                        Saving... <span class="spinner-border spinner-border-sm align-middle ms-2"></span>
                    </span>
                </button>
            </div>
            <!--end::Action buttons-->
        </form>
        <!--end::Alerts form-->
    </div>
    <!--end::Card body-->
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Select2 for language dropdown
    if (typeof jQuery !== 'undefined' && typeof jQuery.fn.select2 !== 'undefined') {
        jQuery('[data-control="select2"]').select2({
            minimumResultsForSearch: 10
        });
    }

    // Store original form values for reset functionality
    const originalValues = new Map();
    document.querySelectorAll('textarea[name^="content["], input[name^="class["]').forEach(element => {
        originalValues.set(element.name, element.value);
    });

    // Reset form to original values
    document.getElementById('reset-form').addEventListener('click', function(e) {
        e.preventDefault();
        originalValues.forEach((value, key) => {
            const element = document.querySelector(`[name="${key}"]`);
            if (element) {
                element.value = value;
            }
        });
    });

    // Form submission handling
    const form = document.querySelector('.alerts-form');
form.addEventListener('submit', function(e) {
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.setAttribute('data-kt-indicator', 'on');
    
    // Optional: Add form validation
    const textareas = this.querySelectorAll('textarea[name^="content["]');
    let isValid = true;
    
    textareas.forEach(textarea => {
        if (!textarea.value.trim()) {
            isValid = false;
            textarea.classList.add('is-invalid');
        }
    });
    
    if (!isValid) {
        e.preventDefault();
        submitBtn.setAttribute('data-kt-indicator', 'off');
        // Show validation error message
        return;
    }
});
});
</script>
<?
}
if ($_GET['page'] == 'templates')
{ 
    if (isset($_GET['id']))
    {
        $e_id = $_GET['id'];
    }
    if (isset($_POST['submit']) && isset($_POST['action']) && $_POST['action'] == "update")
    {
        $content = $_POST['content'];
        $alerty =  mysqli_real_escape_string($DB_CONN, $_POST['alerty']);
        $Update = mysqli_query($DB_CONN, "UPDATE  email set  subject='{$_POST['subject']}', `content`='{$content}', `alerty`='{$alerty}' , `status`='{$_POST['status']}' where id='$e_id'") or die(mysqli_error($DB_CONN));
        echo "<div class=\"alert alert-success text-center\"> Updated Successfully</div>";

    }

    if (isset($_GET['action']) && $_GET['action'] == 'edit')
    {
        $email = mysqli_query($DB_CONN, "select * from email where id = '{$e_id}'");
        $email = mysqli_fetch_assoc($email);
        if (true)
        {
?>
<div class="card">
    <div class="card-header">
        <div class="d-flex align-items-center">
                                                                
            <!--begin::Name-->
            <div class="d-flex justify-content-start flex-column">
                <a  class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6">Edit <span class=""><?=$email['name'] ?> </span></a>
                <a  class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                <span class="text-gray-900">Type</span>: <span class="c_symbol"><?=$email['type'] ?></span></a>
            </div>
            <!--end::Name-->
        </div>
    </div>
<div class="card-body">
<form id="edit_template_form" class="form fv-plugins-bootstrap5 fv-plugins-framework" method="post">
    <div class="form-group is-empty">
        <label for="title" class="control-label ajax_label">
            Subject
        </label>
        <input type="text" required="required" placeholder="" name="subject" id="subject" value="<?=$email['subject'] ?>" class="form-control form-control-solid" />
      
    </div>
    <div class="form-group is-empty">
        <label for="domain" class="control-label ajax_label">
            Text
        </label>
 
         <textarea class="form-control form-control form-control-solid" data-kt-autosize="true" name="content" id="content"><?=$email['content'] ?></textarea>
<small class="fs-9"> Universal Shortcodes : #name# - #username# - #email# - #site_name# - #site_url# - #currency# - #symbol# </span> <br>                      
<small class="fs-9"> Available Shortcodes (This template) :  
<? if($email['id'] == 'user_investment_expired') {                        
echo '#invested_amount# - #invest_date# - #plan# ';
 } elseif($email['id'] == 'invest_user_notification') { 
echo '#amount# - #method# - #plan# - #date# - #batch# - #compound#';     
 }elseif($email['id'] == 'deposit_user_notification') { 
echo '#amount# - #method# - #date#';     
 } elseif($email['id'] == 'withdraw_request_user_notification') { 
echo '#amount# - #method# - #ip# - #wallet# - #date# ';     
 } elseif($email['id'] == 'withdraw_user_notification') { 
echo '#amount# - #method#  - #wallet# - #date# - #batch# - #tx_url# ';
 }elseif($email['id'] == 'referral_commision_notification') { 
echo '#amount# - #method#  - #ref_username# - #ref_name#  ';  
 }elseif($email['id'] == 'direct_signup_notification') { 
echo ' #ref_username# - #ref_name# - #ref_email#';  
 }elseif($email['id'] == 'exchange_user_notification') { 
echo ' #amount_from# - #currency_from# - #amount_to# - #currency_to#';  
 }elseif($email['id'] == 'transfer_to_notification') { 
echo ' #amount# - #method# - #to_username#';  
 }elseif($email['id'] == 'transfer_from_notification') { 
echo ' #amount# - #method# - #from_username# ';  
 }elseif($email['id'] == 'logged_in') { 
echo '#ip# - #country# - #os# - #browser# - #useragent# - #time# ';  
 }elseif($email['id'] == 'email_code') { 
echo '#action# - #code#  ';  
 }elseif($email['id'] == 'admin_ticket_reply' || $email['id'] == 'admin_ticket_message') { 
echo '#message# - #username# - #code# - #link# - #status# - #title#';  
 }elseif($email['id'] == 'user_ticket_reply' || $email['id'] == 'user_ticket_message') { 
echo '#message# - #code# - #link# - #status# - #title#';  
 };?></small>              
                    </div>
                   
                    <div class="form-group is-empty">
                        <label for="email" class="control-label ajax_label">
                            Alert
                        </label>
                        <input type="text"  placeholder="" name="alerty" id="alerty" value="<?=$email['alerty'] ?>" class="form-control form-control-solid" />
                  
                    </div>
                    <div class="separator separator-dashed my-2"></div>
                     <div class="form-group ">
                        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Disable <?=$email['name'] ?> Email/Alert</a>
                    <div class="fs-9 fw-semibold text-gray-500">Disable Alert and Email.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="status" id="status" value="1" <?=$email['status'] == '1' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="status"></label>
                </div>
            </div>
        </div>
                  
                    </div>

                 </div>     <!--end::Scroll-->

                    <!--end::Modal body-->
                    <!--begin::Modal footer-->
                    <div class="card-footer flex-center">
                         <input type="hidden" name="action" value="update" />
                    <input type="hidden" name="id" value="<?=$e_id ?>" />
                
                   
                        <!--end::Button-->
                        <!--begin::Button-->
                        <button type="submit" id="kt_modal_create_api_key_submit" name="submit" class="btn btn-primary">
                            <span class="indicator-label">Submit</span>
                          
                        </button>
                        <!--end::Button-->
                    </div>
                    <!--end::Modal footer-->
                   
                    <div></div>
                </form>
                <!--end::Form-->
            </div>
</div>
<?
        }
    }
    else
    { ?>
                            <div class="card mb-2">
                                        <div class="card-header min-h-unset py-2">
                                            <h3 class="card-title align-items-start flex-column m-0">
                                                 <span class="card-label fw-bold text-gray-900">Email Templates</span>
                                               <span class="text-gray-500 mt-1 fw-semibold fs-6">Email settings can be changed on <a  href="admin?page=email">Email Settings page</a></span>
                                                
                                            </h3>
                                        </div>
                                <div class="card-body">
                            
                                        <div class="table-responsive" data-select2-id="select2-data-145-mo44">
                                                <!--begin::Table-->
                                                
                                                <table  class="table align-middle table-bordered table-striped gs-0 gy-4 email_table">
                                                    <!--begin::Thead-->
                                                    <thead class="fw-bold text-muted bg-light">
                                                        <tr>
                                                                <th class="min-w-125px min-w-125px ps-5 text-center">Type</th>
                                                            <th class=" ps-9">Subject/Name</th>
                                                            
                                                            
                                                        
                                                            <th class="min-w-275px">Alert</th>
                                                            <th class="min-w-125px ps-5 text-center">Status</th>
                                                        
                                                            <th class="text-end ">Action</th>
                                                        </tr>
                                                    </thead>
                                                    <!--end::Thead-->
                                                    <!--begin::Tbody-->
                                                    <tbody class="fs-6 fw-bold text-gray-600">
                                                        
                                                    </tbody>
                                                    <!--end::Tbody-->
                                                </table>
                                                <!--end::Table-->
                                            </div>
                                            <!--end::Table wrapper-->
                                            
                                            
                                        
                                        </div>
                                        <!--end::Content-->
                                    </div>
                                        <!--end::Content-->
                                        <!--begin::Sidebar-->
                                
                                        <!--end::Sidebar-->
                                    </div>
                                


<div class="modal fade" id="email_template" tabindex="-1" style="display: none;" aria-hidden="true">
    <!--begin::Modal dialog-->
    <div class="modal-dialog modal-dialog-centered mw-650px">
        <!--begin::Modal content-->
        <div class="modal-content">
            <!--begin::Modal header-->
            <div class="modal-header" id="kt_modal_create_api_key_header">
                <!--begin::Modal title-->
                <h2>Template</h2>
                <!--end::Modal title-->
                <!--begin::Close-->
                <div class="btn btn-sm btn-icon btn-active-color-primary" data-bs-dismiss="modal">
                    <!--begin::Svg Icon | path: images/icons/duotune/arrows/arr061.svg-->
                    <span class="svg-icon svg-icon-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <rect opacity="0.5" x="6" y="17.3137" width="16" height="2" rx="1" transform="rotate(-45 6 17.3137)" fill="currentColor"></rect>
                            <rect x="7.41422" y="6" width="16" height="2" rx="1" transform="rotate(45 7.41422 6)" fill="currentColor"></rect>
                        </svg>
                    </span>
                    <!--end::Svg Icon-->
                </div>
                <!--end::Close-->
            </div>
            <!--end::Modal header-->
            <!--begin::Form-->

            <!--begin::Modal body-->
            <div class="modal-body py-10 px-lg-17">
                <!--begin::Scroll-->
                <div class="scroll-y me-n7 pe-7" id="kt_modal_create_api_key_scroll" data-kt-scroll="true" data-kt-scroll-activate="{default: false, lg: true}" data-kt-scroll-max-height="auto">
                    <!--begin::Notice-->

                    <!--end::Notice-->
                    <div class="table-responsive">
                        <table  class="table table-row-dashed table-bordered table-bordered align-middle gs-0 gy-4 my-0">
                            <tbody id="tdata"></tbody>
                        </table>
                    </div>
                </div>
                <!--end::Scroll-->
            </div>
            <!--end::Modal body-->
            <!--begin::Modal footer-->
            <div class="modal-footer flex-center">
                <!--begin::Button-->
                <button type="reset" id="kt_modal_create_api_key_cancel" class="btn btn-light me-3" data-bs-dismiss="modal">Close</button>
                <!--end::Button-->
            </div>
            <!--end::Modal footer-->
            <div></div>
            <!--end::Form-->
        </div>
        <!--end::Modal content-->
    </div>
    <!--end::Modal dialog-->
</div>

<script type="text/javascript">
$("#edit_template_form").submit(function(e) {
    e.preventDefault();
    var form = $(this);
    $.ajax({
        type: "POST",
        url: "?page=ajax&h=edit_template",
        data: form.serialize(),
        success: function(data)
        {
          if(data.status) {
            Swal.fire({
        text: "Template Updated Successfully",
        icon: "success",
        buttonsStyling: false,
        confirmButtonText: "Ok, got it!",
        customClass: {
            confirmButton: "btn btn-primary"
        }
    });
            $("#edit_template").modal('hide');
            $("#edit_template_form").trigger('reset');
            load_templates();
          } else {
            alert("Server Error");
          }
        }
    });
});
function load_templates() {
    $("#loader").show();
$.ajax({
    async: true,
    url:'?page=ajax&h=emails',
    type:'POST',
    success:function(data) {
        $(".email_table tbody").html(data.data);
        $("#loader").hide();
     }
    });
}
function show_email(id) {
    $.ajax({
        type: "POST",
        url: "?page=ajax&h=get_template_pop",
        data: {id:id},
        success: function(data)
        {
            $("#tdata").html(data.data);
            $("#email_template").modal('show');
        }
    });
}
$(function() {
    load_templates();
});
</script>   
<?
    } ?>
<?
}
if ($_GET['page'] == 'content') {
    $lang_id = isset($_GET['lang']) ? (int)$_GET['lang'] : 1;
    
    // Handle form submissions
if(isset($_POST['update'])) {
    $page = $_POST['page'];
    
    // Store content directly - it's already filtered
    $content_array = $_POST['content'];
    
    // Apply stripslashes to each value to remove any existing escapes
    foreach($content_array as $key => $value) {
        $content_array[$key] = stripslashes($value);
    }
    
    // Convert to JSON
    $content_json = json_encode($content_array);
    
    // Use a prepared statement to prevent further escaping issues
    $stmt = mysqli_prepare($DB_CONN, "UPDATE content SET content_data = ? WHERE page = ? AND lang_id = ?");
    mysqli_stmt_bind_param($stmt, "ssi", $content_json, $page, $lang_id);
    $query = mysqli_stmt_execute($stmt);
    mysqli_stmt_close($stmt);
    
    if($query) {
        $success_message = '<div class="alert alert-success py-2">Updated Successfully</div>';
        updateSiteData($siteURL);
    }
}
    
    if(isset($_POST['add_page'])) {
        $page = $_POST['new_page']; // Already sanitized by db_filter
        $initial_content = [
            'icon' => '',
            'menu' => '',
            'header' => '',
            'title' => '',
            'text' => '',
            'page_title' => '',
            'content' => ''
        ];
        
        $content_json = json_encode($initial_content, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);
        
        $query = mysqli_query($DB_CONN,
            "INSERT INTO content (page, content_data, lang_id) 
            VALUES ('{$page}', '{$content_json}', '{$lang_id}')");
            
        if($query) {
            $success_message = '<div class="alert alert-success py-2">Page Added Successfully</div>';
            updateSiteData($siteURL);
        }
    }
    
    if(isset($_POST['delete_page'])) {
        $page = $_POST['page']; // Already sanitized by db_filter
        $query = mysqli_query($DB_CONN, "DELETE FROM content WHERE page = '{$page}' AND lang_id = '{$lang_id}'");
        if($query) {
            $success_message = '<div class="alert alert-success py-2">Page Deleted Successfully</div>';
            updateSiteData($siteURL);
        }
    }
?>
<div class="card mb-2">
    <div class="card-header min-h-unset py-2 d-flex justify-content-between align-items-center">
        <h3 class="card-title m-0">
            <span class="card-label fw-bold text-gray-900">Content Management</span>
        </h3>
        <div class="d-flex gap-3 align-items-center">
            <form method="GET" class="m-0">
                <input type="hidden" name="page" value="content">
                <select name="lang" class="form-select form-select-sm w-150px" onchange="this.form.submit()">
                    <?php
                    $languages = mysqli_query($DB_CONN, "SELECT * FROM languagues WHERE status = 1");
                    while($lan = mysqli_fetch_assoc($languages)) {
                        $selected = ($lan['id'] == $lang_id) ? ' selected' : '';
                        echo "<option value='{$lan['id']}'{$selected}>{$lan['name']}</option>";
                    }
                    ?>
                </select>
            </form>
         <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#add-page-modal">
    <i class="ki-duotone ki-plus fs-2">
        <span class="path1"></span>
        <span class="path2"></span>
        <span class="path3"></span>
    </i> 
    New Page
</button>
        </div>
    </div>
    <div class="card-header border-bottom min-h-unset py-2">
    <div class="d-flex align-items-center w-100">
        <!--begin::Search container-->
        <div class="position-relative w-100 me-2">
            <span class="svg-icon svg-icon-1 svg-icon-gray-500 position-absolute top-50 translate-middle-y ms-4">
                <i class="ki-duotone ki-magnifier fs-2">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
            </span>
            <input type="text" class="form-control form-control-solid form-control-sm ps-12" id="content-search" 
                   placeholder="Search Content pages..." autocomplete="off">
            <div id="search-results" class="position-absolute start-0 mt-1 w-100 rounded shadow-sm bg-body d-none"
                 style="max-height: 250px; overflow-y: auto; z-index: 999; border: 1px solid var(--kt-border-color);">
                <!-- Search results will appear here -->
            </div>
        </div>
        <!--end::Search container-->
        
        <!--begin::Quick navigation dropdown-->
        <div class="ms-2">
            <select id="page-jump" class="form-select form-select-sm" data-control="select2" data-placeholder="Jump to page">
                <option></option>
                <!-- Page options will be populated via JavaScript -->
            </select>
        </div>
        <!--end::Quick navigation dropdown-->
    </div>
</div>
    <div class="card-body">
        <?php 
        if(isset($success_message)) {
            echo $success_message;
        }
        
        $pages = mysqli_query($DB_CONN, "SELECT * FROM content WHERE lang_id = '{$lang_id}'");
        if(mysqli_num_rows($pages) == 0) {
            echo '<div class="alert alert-info">No pages found. Click "New Page" to add content.</div>';
        }
        
        while($page = mysqli_fetch_assoc($pages)) {
            $content_data = json_decode($page['content_data'], true);
        ?>
        <form method="POST" class="mb-4">
            <div class="card card-bordered shadow-sm">
                <div class="card-header min-h-unset py-2 d-flex justify-content-between align-items-center">
                    <h3 class="card-title m-0 d-flex align-items-center gap-2">
                        <span class="badge badge-light-primary fs-7"><?= htmlspecialchars($page['page']) ?></span>
                        <span class="text-gray-600 fs-7">Last updated: <?= date('M d, Y H:i', strtotime($page['updated_at'])) ?></span>
                    </h3>
                    <div class="d-flex gap-2">
    <button type="submit" name="update" class="btn btn-sm btn-light-success">
        <i class="ki-duotone ki-check fs-2">
            <span class="path1"></span>
            <span class="path2"></span>
        </i> 
        Save Changes
    </button>
    <button type="submit" name="delete_page" class="btn btn-sm btn-light-danger" 
            onclick="return confirm('Are you sure you want to delete this page?')">
        <i class="ki-duotone ki-trash fs-2">
            <span class="path1"></span>
            <span class="path2"></span>
            <span class="path3"></span>
            <span class="path4"></span>
        </i>
    </button>
</div>
                </div>
                <div class="card-body p-4">
                    <!-- Common Fields -->
                   <!-- Common Fields in Top Grid -->
<div class="row g-3 mb-4">
    <div class="col-md-4">
    <div class="d-flex flex-column">
        <label class="form-label required fs-7 mb-1">Icon</label>
        <div class="input-group">
            <input type="text" name="content[icon]" id="iconInput_<?= $page['page'] ?>" 
                   class="form-control form-control-sm bg-light" 
                   placeholder="e.g., Home, User" 
                   value="<?= $content_data['icon'] ?? '' ?>">
            <button type="button" class="btn btn-sm btn-light-primary" 
                    onclick="openIconSelector('<?= $page['page'] ?>')">
                Select Icon
            </button>
        </div>
        <small class="text-muted">Click 'Select Icon' to choose from available Lucide icons</small>
    </div>
</div>
    <div class="col-md-4">
        <div class="d-flex flex-column">
            <label class="form-label required fs-7 mb-1">Menu</label>
            <input type="text" name="content[menu]" class="form-control form-control-sm bg-light" 
                   placeholder="e.g., Home, About Us"
                   value="<?= $content_data['menu'] ?? '' ?>">
            <small class="text-muted">For App Navigation/Sidebar menu items</small>
        </div>
    </div>
    <div class="col-md-4">
        <div class="d-flex flex-column">
            <label class="form-label required fs-7 mb-1">Header</label>
            <input type="text" name="content[header]" class="form-control form-control-sm bg-light" 
                   placeholder="e.g., Welcome to Dashboard"
                   value="<?= $content_data['header'] ?? '' ?>">
            <small class="text-muted">Main heading at the top of each page</small>
        </div>
    </div>
    <div class="col-md-4">
        <div class="d-flex flex-column">
            <label class="form-label required fs-7 mb-1">Title</label>
            <input type="text" name="content[title]" class="form-control form-control-sm bg-light" 
                   placeholder="e.g., Recent Transactions"
                   value="<?= $content_data['title'] ?? '' ?>">
                   <?  if (substr($page['page'], -5) === "_logs"): ?>
                    Transactions Page Title
                    <?php endif; ?>
            <small class="text-muted">For section titles and feature headings</small>
        </div>
    </div>
    <div class="col-md-4">
        <div class="d-flex flex-column">
            <label class="form-label required fs-7 mb-1">Text</label>
            <input type="text" name="content[text]" class="form-control form-control-sm bg-light" 
                   placeholder="e.g., View your recent activity"
                   value="<?= $content_data['text'] ?? '' ?>">
                    <?  if (substr($page['page'], -5) === "_logs"): ?>
                    Transactions Page Title sub head
                    <?php endif; ?>
            <small class="text-muted">Short descriptive text for features and sections</small>
        </div>
    </div>
    <div class="col-md-4">
        <div class="d-flex flex-column">
            <label class="form-label required fs-7 mb-1">Page Title</label>
            <input type="text" name="content[page_title]" class="form-control form-control-sm bg-light" 
                   placeholder="e.g., Transaction History"
                   value="<?= $content_data['page_title'] ?? '' ?>">
            <small class="text-muted">Appears in browser tab and breadcrumbs</small>
        </div>
    </div>
        <?php 
    // Check if the page name ends with "_logs"
    if (substr($page['page'], -5) === "_logs"): 
    ?>
    <div class="col-md-4">
        <div class="d-flex flex-column">
            <label class="form-label required fs-7 mb-1">Transaction Title</label>
            <input type="text" name="content[transaction_title]" class="form-control form-control-sm bg-light" 
                   placeholder="e.g., Transaction Details"
                   value="<?= $content_data['transaction_title'] ?? '' ?>">
            <small class="text-muted">Title for transaction Pages TXN_TYPE</small>
        </div>
    </div>
    <?php endif; ?>
    <div class="col-12">
        <div class="d-flex flex-column">
            <label class="form-label required fs-7 mb-1">Content</label>
            <textarea name="content[content]" class="form-control form-control-sm bg-light" 
                      placeholder="Enter detailed page content or description"
                      rows="2"><?= $content_data['content'] ?? '' ?></textarea>
            <small class="text-muted">Main content area text and descriptions</small>
        </div>
    </div>
</div>

<!-- Additional Fields -->
<div class="separator my-4"></div>

<div class="mb-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <label class="form-label fs-7 mb-0">Additional Fields</label>
        <button type="button" class="btn btn-sm btn-light-primary py-1" onclick="addField('<?= $page['page'] ?>')">
            <i class="ki-duotone ki-plus fs-2"><span class="path1"></span><span class="path2"></span><span class="path3"></span></i>
            Add Field
        </button>
    </div>
    
    <div id="fields_<?= $page['page'] ?>">
        <div class="row g-3">
        <?php 
       if($content_data) {
            foreach($content_data as $key => $value) {
                // Exclude common fields AND the transaction_title field if this is a _logs page
                $commonFields = ['icon', 'menu', 'header', 'title', 'text', 'page_title', 'content'];
                
                // Add transaction_title to excluded fields if this is a _logs page
                if (substr($page['page'], -5) === "_logs") {
                    $commonFields[] = 'transaction_title';
                }
                
                if(!in_array($key, $commonFields)) {
        ?>
        <div class="col-md-4" data-field="<?= htmlspecialchars($key) ?>">
            <div class="position-relative">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <label class="form-label text-gray-600 fs-7 mb-0"><?= htmlspecialchars($key) ?></label>
                    <button type="button" class="btn btn-sm btn-icon btn-light-danger p-0 w-20px h-20px" onclick="removeField(this)">
                        <i class="ki-duotone ki-cross fs-6">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                    </button>
                </div>
                <input type="text" name="content[<?= $key ?>]" class="form-control form-control-sm bg-light" 
                       value="<?= $value ?>">
            </div>
        </div>
        <?php
                }
            }
        }
        ?>
        </div>
    </div>
</div>

                   
                    <input type="hidden" name="page" value="<?= $page['page'] ?>">
                </div>
            </div>
        </form>
        <?php } ?>
    </div>
</div>

<!-- Add Page Modal -->
<div class="modal fade" id="add-page-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST">
                <div class="modal-header py-2">
                    <h5 class="modal-title">Add New Page</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label required">Page Identifier</label>
                        <input type="text" name="new_page" class="form-control form-control-sm" required 
                               pattern="[a-z0-9_]+" title="Only lowercase letters, numbers and underscore allowed">
                        <span class="fs-8 text-gray-500">Use lowercase letters, numbers and underscore only (e.g., "home", "about_us")</span>
                    </div>
                </div>
                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-sm btn-light" data-bs-dismiss="modal">Close</button>
                    <button type="submit" name="add_page" class="btn btn-sm btn-primary">Add Page</button>
                </div>
            </form>
        </div>
    </div>
</div>
<div class="modal fade" id="iconSelectorModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Lucide Icon</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" class="form-control" id="iconSearch" 
                           placeholder="Search icons...">
                </div>
                <div class="row g-3" id="iconGrid">
                    <!-- Icons will be populated here via JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>
 <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
  <!-- Custom Script -->
  <script>
document.addEventListener("DOMContentLoaded", function() {
    // Initialize search functionality
    initContentSearch();
    
    // Initialize page jump dropdown
    initPageJump();
});

function initContentSearch() {
    const searchInput = document.getElementById('content-search');
    const searchResults = document.getElementById('search-results');
    
    // Get all page cards for searching
    const pageCards = document.querySelectorAll('.card-body form .card');
    
    // Add event listener for search input
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        
        if (searchTerm.length < 2) {
            searchResults.classList.add('d-none');
            // Reset visibility of all cards when search is cleared
            pageCards.forEach(card => {
                card.closest('form').style.display = '';
            });
            return;
        }
        
        let results = [];
        
        // Search through pages
        pageCards.forEach(card => {
            const pageForm = card.closest('form');
            const pageTitle = card.querySelector('.card-title .badge').textContent;
            const pageContent = card.textContent;
            
            if (pageTitle.toLowerCase().includes(searchTerm) || pageContent.toLowerCase().includes(searchTerm)) {
                results.push({
                    title: pageTitle,
                    element: pageForm
                });
                pageForm.style.display = '';
            } else {
                pageForm.style.display = 'none';
            }
        });
        
        // Display search results for quick navigation
        if (results.length > 0) {
            searchResults.innerHTML = results.map(result => 
                `<div class="py-2 px-3 cursor-pointer search-result-item hover-bg-light-primary" 
                     data-page="${result.title}">
                    <div class="d-flex align-items-center">
                        <span class="bullet bullet-dot bg-primary me-2"></span>
                        ${result.title}
                    </div>
                </div>`
            ).join('');
            
            searchResults.classList.remove('d-none');
            
            // Add click event to search results
            document.querySelectorAll('.search-result-item').forEach(item => {
                item.addEventListener('click', function() {
                    const pageName = this.getAttribute('data-page');
                    scrollToPage(pageName);
                    searchResults.classList.add('d-none');
                });
            });
        } else {
            searchResults.innerHTML = '<div class="py-2 px-3 text-muted">No pages found</div>';
            searchResults.classList.remove('d-none');
        }
    });
    
    // Close search results when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.classList.add('d-none');
        }
    });
    
    // Close search results on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            searchResults.classList.add('d-none');
        }
    });
}

function initPageJump() {
    const pageJump = document.getElementById('page-jump');
    const pageCards = document.querySelectorAll('.card-body form .card');
    
    // Populate dropdown with all pages
    pageCards.forEach(card => {
        const pageTitle = card.querySelector('.card-title .badge').textContent;
        const option = document.createElement('option');
        option.value = pageTitle;
        option.textContent = pageTitle;
        pageJump.appendChild(option);
    });
    
    // Initialize Select2 for enhanced dropdown
    $(pageJump).select2({
        minimumResultsForSearch: 5,
        dropdownParent: $(pageJump).parent()
    });
    
    // Add change event to jump to selected page
    $(pageJump).on('change', function() {
        const selectedPage = $(this).val();
        if (selectedPage) {
            scrollToPage(selectedPage);
            $(this).val('').trigger('change.select2');
        }
    });
}

function scrollToPage(pageName) {
    const pageCards = document.querySelectorAll('.card-body form .card');
    
    for (let card of pageCards) {
        const cardTitle = card.querySelector('.card-title .badge').textContent;
        
        if (cardTitle === pageName) {
            // Highlight the card briefly
            card.classList.add('border-primary');
            card.querySelector('.card-header').classList.add('bg-light-primary');
            
            // Smooth scroll to the element
            card.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Remove highlight after a delay
            setTimeout(() => {
                card.classList.remove('border-primary');
                card.querySelector('.card-header').classList.remove('bg-light-primary');
            }, 2000);
            
            break;
        }
    }
}
</script>
  <script>
    // Helper function to convert PascalCase to kebab-case
    function toKebabCase(str) {
      return str.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
    }

    document.addEventListener("DOMContentLoaded", function () {
      window.openIconSelector = function (pageId) {
        const modalElement = document.getElementById("iconSelectorModal");
        const modal = new bootstrap.Modal(modalElement);
        const iconGrid = document.getElementById("iconGrid");
        const searchInput = document.getElementById("iconSearch");

        // Get icon names from lucide.icons (these are in PascalCase)
        const icons = lucide.icons ? Object.keys(lucide.icons) : [];
        if (!icons.length) {
          console.error("No icons found in lucide.icons");
        }

        // Render the icons inside the grid
        function renderIcons(iconsToRender) {
          iconGrid.innerHTML = iconsToRender.map(icon => `
            <div class="col-3 col-md-2 mb-3">
              <div class="d-flex flex-column align-items-center p-2 border rounded cursor-pointer hover-bg-light-primary"
                   onclick="selectIcon('${icon}', '${pageId}')">
                <!-- Use the converted kebab-case name for the data-lucide attribute -->
                <i data-lucide="${toKebabCase(icon)}" class="w-24px h-24px"></i>
                <span class="fs-8 text-center mt-1 text-truncate w-100">${icon}</span>
              </div>
            </div>
          `).join("");
          lucide.createIcons();
        }

        // Reset search input and render all icons
        searchInput.value = "";
        renderIcons(icons);

        // Filter icons as user types
        searchInput.addEventListener("input", function (e) {
          const searchTerm = e.target.value.toLowerCase();
          const filteredIcons = icons.filter(icon => 
            icon.toLowerCase().includes(searchTerm)
          );
          renderIcons(filteredIcons);
        });

        modal.show();
      };

      // Set the selected icon name into the input field and close the modal
      window.selectIcon = function (iconName, pageId) {
        const inputField = document.getElementById(`iconInput_${pageId}`);
        if (inputField) {
          inputField.value = iconName;
        }
        const modalElement = document.getElementById("iconSelectorModal");
        const modalInstance = bootstrap.Modal.getInstance(modalElement);
        if (modalInstance) {
          modalInstance.hide();
        }
      };
    });
function addField(page) {
    const container = document.querySelector(`#fields_${page} .row`);
    const fieldName = prompt('Enter field name (lowercase letters, numbers and underscore only):');
    
    if (!fieldName) return;
    
    if (!/^[a-z0-9_]+$/.test(fieldName)) {
        alert('Field name can only contain lowercase letters, numbers and underscore');
        return;
    }

    const commonFields = ['icon', 'menu', 'header', 'title', 'text', 'page_title', 'content'];
    
    // Prevent adding transaction_title as an additional field for _logs pages
    if (page.endsWith('_logs') && fieldName === 'transaction_title') {
        alert('Transaction Title is already a standard field for log pages.');
        return;
    }
    
    if (commonFields.includes(fieldName)) {
        alert('This is a common field. Please use a different name.');
        return;
    }

    const existingFields = container.querySelectorAll('[data-field]');
    for (let field of existingFields) {
        if (field.dataset.field === fieldName) {
            alert('This field already exists!');
            return;
        }
    }

    const div = document.createElement('div');
    div.className = 'col-md-4';
    div.setAttribute('data-field', fieldName);
    div.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-1">
            <label class="form-label text-gray-600 fs-7 mb-0">${fieldName}</label>
            <button type="button" class="btn btn-sm btn-icon btn-light-danger p-0 w-20px h-20px" onclick="removeField(this)">
                <i class="ki-duotone ki-cross fs-6">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
            </button>
        </div>
        <input type="text" name="content[${fieldName}]" class="form-control form-control-sm">
    `;

    container.appendChild(div);
}

function removeField(button) {
    if (confirm('Are you sure you want to remove this field?')) {
        button.closest('[data-field]').remove();
    }
}
</script>
<?php }  if ($_GET['page'] == 'news'){
$alert = false;
$action = $_POST['action'] ?? $_GET['action'] ?? '';  // Check POST first, then GET
$id = intval($_GET['id'] ?? $_POST['id'] ?? 0);

// Fetch news item for editing
if (($action == 'edit' || $action == 'update') && $id > 0) {
    $stmt = $DB_CONN->prepare("SELECT * FROM news WHERE id = ?");
    $stmt->bind_param("i", $id);
    $stmt->execute();
    $news_item = $stmt->get_result()->fetch_assoc();
    $stmt->close();

    if (!$news_item) {
        $alert = true;
        $alert_class = 'alert alert-danger alert-dismissible alert-custom';
        $alert_message = "News item not found for ID: $id";
        $action = ''; // Reset action to show the list view
    } else {
        $news_item['categories'] = getCategories($id, 'news');

        // Fetch FAQs for this news item
        $faq_stmt = $DB_CONN->prepare("SELECT * FROM faqs WHERE news_id = ?");
        $faq_stmt->bind_param("i", $id);
        $faq_stmt->execute();
        $faqs = $faq_stmt->get_result()->fetch_all(MYSQLI_ASSOC);
        $faq_stmt->close();
    }
}


if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['submit'])) {
    $title = mysqli_real_escape_string($DB_CONN, $_POST['title']);
    $slug = $_POST['slug'] ?? convertTitleToURL($title);
    $content = cleanContent($_POST['content']);
    $short_description = cleanContent($_POST['short_description']);
    $datetime = $_POST['datetime'];
    $author = $_POST['author'];
    $keywords = $_POST['keywords'];
    $image_url = $_POST['image_url'];
    $seo_robots = $_POST['seo_robots'];
    $include_in_sitemap = $_POST['include_in_sitemap'];
    $schema_type = $_POST['schema_type'] ? :'';
    $status = $_POST['status'];
    $category_ids = $_POST['categories'] ?? [];

   if ($_POST['action'] == 'update' && $id > 0) {
    $query = "UPDATE news SET title = ?, slug = ?, content = ?, short_description = ?, datetime = ?, 
              image_url = ?, author = ?, keywords = ?, lang_id = ?, seo_robots = ?, include_in_sitemap = ?, schema_type = ?, status = ? 
              WHERE id = ?";
    $stmt = $DB_CONN->prepare($query);
    $stmt->bind_param("ssssssisisssii", $title, $slug, $content, $short_description, $datetime, 
                      $image_url, $author, $keywords, $lang_id, $seo_robots, $include_in_sitemap, $schema_type, $status, $id);
                      updateSiteData($siteURL);
                      
} else {
    $query = "INSERT INTO news (title, slug, content, short_description, datetime, image_url, author, keywords, 
              lang_id, seo_robots, include_in_sitemap, schema_type, status) 
             VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";
    $stmt = $DB_CONN->prepare($query);
    $stmt->bind_param("ssssssisisssi", $title, $slug, $content, $short_description, $datetime, 
                      $image_url, $author, $keywords, $lang_id, $seo_robots, $include_in_sitemap, $schema_type, $status);
                      updateSiteData($siteURL);
}

    if ($stmt->execute()) {
        $affected_rows = $stmt->affected_rows;
        $news_id = $_POST['action'] == 'update' ? $id : $DB_CONN->insert_id;

        // Handle categories
        addCategoriesToItem($news_id, 'news', $category_ids);
        manageFAQs($news_id, 'news');

        if ($affected_rows > 0) {
             $alert = true;
            $alert_class = 'alert alert-success alert-dismissible alert-custom';
            $alert_message = 'News item ' . ($action == 'update' ? 'updated' : 'added') . ' successfully!';
            echo "<script>window.location.href='admin?page=news&action=edit&id={$news_id}&alert_message={$alert_message}&alert_class={$alert_class}'</script>";
            
        } else {
             $alert = true;
            $alert_class = 'alert alert-warning alert-dismissible alert-custom';
            $alert_message = 'No changes were made to the news item.';
        }
    } else {
         $alert = true;
        $alert_class = 'alert alert-danger alert-dismissible alert-custom';
        $alert_message = 'Error ' . ($action == 'update' ? 'updating' : 'adding') . ' news item: ' . $stmt->error;
    }
    $stmt->close();
}



if ($action === 'delete' && isset($_POST['id'])) {  
     $blog_id = intval($_POST['id']);
    $delete_categories = "DELETE FROM news_categories WHERE news_id = $blog_id";
    if (!mysqli_query($DB_CONN, $delete_categories)) {
        echo "Error deleting Categories: " . mysqli_error($DB_CONN);
    }
    
    // Delete from faqs
    $delete_faqs = "DELETE FROM faqs WHERE news_id = $blog_id";
    if (!mysqli_query($DB_CONN, $delete_faqs)) {
        echo "Error deleting FAQs: " . mysqli_error($DB_CONN);
    }
    
    $delete_blog = "DELETE FROM news WHERE id = $blog_id";
    if (!mysqli_query($DB_CONN, $delete_blog)) {
        echo "Error deleting Blog: " . mysqli_error($DB_CONN);
    } else {
      $alert = true;
     $alert_class = 'alert alert-success alert-dismissible alert-custom';
     $alert_message = 'News item Deleted successfully!';
     updateSiteData($siteURL);
    }
}

$query = "SELECT id, title, image_url,slug ,LEFT(content, 100) AS short_content, datetime FROM news ORDER BY datetime DESC";
$news_list = $DB_CONN->query($query);

if (!$news_list) {
    echo "Error fetching news: " . $DB_CONN->error;
}
    ?>
 <?php if(isset($_GET['alert_message']) && $_GET['alert_message']) {
        $alert = true;
            $alert_class = $_GET['alert_class'];
            $alert_message = $_GET['alert_message'];
     
 }
?>  
    <?php if ($alert): ?>
        <div class="<?php echo $alert_class; ?>" role="alert">
            <?php echo $alert_message; ?>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    <?php endif; ?>

    <?php if ($action == 'add' || $action == 'edit'): ?>
  <form id="kt_ecommerce_add_product_form" class="form d-flex flex-column flex-lg-row fv-plugins-bootstrap5 fv-plugins-framework" method="post" enctype="multipart/form-data"  >
         <div class="d-flex flex-column gap-3 w-100 w-lg-300px  me-lg-10">
    <!--begin::Featured Image-->
    <div class="card card-flush py-2">
        <div class="card-header min-h-unset p-2">
            <div class="card-title m-0">
                <h3 class="card-label fs-6 fw-bold m-0">Featured Image</h3>
            </div>
        </div>
        <div class="card-body p-2">
            <div class="image-input image-input-outline" data-kt-image-input="true">
                <div class="image-input-wrapper w-250px h-100px" id="main-image-preview"
                     style="background-image: url('<?= ($news_item && $news_item['image_url']) ? htmlspecialchars($news_item['image_url']) : 'bitders/assets/placeholder.svg' ?>')">
                </div>
                <label class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow"
                       data-kt-image-input-action="change"
                       data-bs-toggle="modal"
                       data-bs-target="#kt_modal_100">
                    <i class="ki-duotone ki-pencil fs-7"><span class="path1"></span><span class="path2"></span></i>
                </label>
                <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow"
                      data-kt-image-input-action="cancel">
                    <i class="ki-outline ki-cross fs-2"></i>
                </span>
                <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow"
                      data-kt-image-input-action="remove">
                    <i class="ki-outline ki-cross fs-2"></i>
                </span>
            </div>
            <input type="hidden" id="selected_image_url" name="image_url" 
                   value="<?= ($news_item && $news_item['image_url']) ? htmlspecialchars($news_item['image_url']) : '' ?>">
            <div class="fs-7 text-muted mt-2">Set featured image (*.png, *.jpg, *.jpeg)</div>
        </div>
    </div>

    <!--begin::Status-->
    <div class="card card-flush py-2">
        <div class="card-header min-h-unset p-2">
            <div class="card-title m-0">
                <h3 class="card-label fs-6 fw-bold m-0">Publishing</h3>
            </div>
            <div class="card-toolbar">
                <div class="rounded-circle bg-<?= isset($news_item['status']) && $news_item['status'] === 1 ? 'success' : 'warning' ?> w-15px h-15px"></div>
            </div>
        </div>
        <div class="card-body p-2">
            <div class="d-flex gap-5">
                <div class="form-check form-check-custom form-check-solid">
                    <input class="form-check-input" type="radio" name="status" value="1" 
                           <?= isset($news_item['status']) && $news_item['status'] === 1 ? 'checked' : '' ?>>
                    <label class="form-check-label">Published</label>
                </div>
                <div class="form-check form-check-custom form-check-solid">
                    <input class="form-check-input" type="radio" name="status" value="0" 
                           <?= isset($news_item['status']) && $news_item['status'] === 0 ? 'checked' : '' ?>>
                    <label class="form-check-label">Draft</label>
                </div>
            </div>
        </div>
    </div>

    <!--begin::SEO Settings-->
<div class="card card-flush py-2">
    <div class="card-header min-h-unset p-2">
        <div class="card-title m-0">
            <div class="d-flex align-items-center">
                <i class="ki-duotone ki-chart-simple-3 fs-3 me-2">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
                <h3 class="card-label fs-6 fw-bold m-0">SEO Settings</h3>
            </div>
        </div>
    </div>
    <div class="card-body p-2">
        <!-- Search Engine Index -->
        <div class="border-bottom pb-2 mb-2">
            <div class="d-flex flex-column">
                <label class="fs-7 fw-bold d-flex align-items-center mb-2">
                    <i class="ki-duotone ki-search fs-6 me-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                    Search Engine Index
                </label>
                <div class="btn-group w-100" data-kt-buttons="true" data-kt-buttons-target="[data-kt-button]">
                    <label class="btn btn-outline btn-active-light-primary <?= $news_item && $news_item['seo_robots'] === 'yes' ? 'active' : '' ?> flex-grow-1 py-1" data-kt-button="true">
                        <input class="btn-check" type="radio" name="seo_robots" value="yes" 
                               <?= $news_item && $news_item['seo_robots'] === 'yes' ? 'checked' : '' ?>>
                        <i class="ki-duotone ki-check fs-2"></i>
                        <span class="fs-7 fw-bold">Allow</span>
                    </label>
                    <label class="btn btn-outline btn-active-light-danger <?= $news_item && $news_item['seo_robots'] === 'no' ? 'active' : '' ?> flex-grow-1 py-1" data-kt-button="true" >
                        <input class="btn-check" type="radio" name="seo_robots" value="no"
                               <?= $news_item && $news_item['seo_robots'] === 'no' ? 'checked' : 'checked' ?>>
                        <i class="ki-duotone ki-cross fs-2"></i>
                        <span class="fs-7 fw-bold">Prevent</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Sitemap -->
        <div class="border-bottom pb-2 mb-2">
            <div class="d-flex align-items-center justify-content-between">
                <label class="fs-7 fw-bold d-flex align-items-center mb-0">
                    <i class="ki-duotone ki-graph-up fs-6 me-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                    Include in Sitemap
                </label>
                <div class="form-check form-switch form-check-custom form-check-solid">
                    <input class="form-check-input h-20px w-35px" type="checkbox" name="include_in_sitemap" value="yes"
                           <?= isset($news_item['include_in_sitemap']) && $news_item['include_in_sitemap'] === 'yes' ? 'checked' : '' ?>>
                </div>
            </div>
        </div>

        <!-- Content Type -->
        <div>
            <label class="fs-7 fw-bold d-flex align-items-center mb-2">
                <i class="ki-duotone ki-document fs-6 me-1">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
                Content Type
            </label>
            <div class="d-flex flex-column gap-1">
                <div class="form-check form-check-custom form-check-solid form-check-lg">
                    <input class="form-check-input" type="radio" name="schema_type" value="BlogPosting"
                           <?= $news_item && $news_item['schema_type'] === 'BlogPosting' ? 'checked' : '' ?>>
                    <label class="form-check-label d-flex align-items-center">
                        <span class="fs-7 fw-bold me-2">Blog Post</span>
                        <span class="badge badge-light-primary fs-8">Personal content</span>
                    </label>
                </div>
                <div class="form-check form-check-custom form-check-solid form-check-lg">
                    <input class="form-check-input" type="radio" name="schema_type" value="Article"
                           <?= $news_item && $news_item['schema_type'] === 'Article' ? 'checked' : '' ?>>
                    <label class="form-check-label d-flex align-items-center">
                        <span class="fs-7 fw-bold me-2">Article</span>
                        <span class="badge badge-light-info fs-8">News content</span>
                    </label>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize tooltips
document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(tooltip => {
    new bootstrap.Tooltip(tooltip);
});

// Handle sitemap switch label update
const sitemapCheckbox = document.querySelector('input[name="include_in_sitemap"]');

// Add a hidden input to ensure we always get a value
const form = sitemapCheckbox.closest('form');
const hiddenInput = document.createElement('input');
hiddenInput.type = 'hidden';
hiddenInput.name = 'include_in_sitemap';
hiddenInput.value = 'no';
sitemapCheckbox.parentNode.insertBefore(hiddenInput, sitemapCheckbox);

// Update the checkbox value handling
sitemapCheckbox.addEventListener('change', function() {
    if (this.checked) {
        this.value = 'yes';
        hiddenInput.disabled = true;  // Disable hidden input when checkbox is checked
    } else {
        hiddenInput.disabled = false; // Enable hidden input when checkbox is unchecked
    }
});

// Initialize the state on page load
if (sitemapCheckbox.checked) {
    hiddenInput.disabled = true;
}

// Handle robots radio button state
document.querySelectorAll('input[name="seo_robots"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const labels = document.querySelectorAll('[data-kt-button]');
        labels.forEach(label => {
            label.classList.remove('active');
        });
        this.closest('[data-kt-button]').classList.add('active');
    });
});
</script>

    <!--begin::Categories-->
<div class="card card-flush py-2">
    <div class="card-header min-h-unset p-2">
        <div class="card-title m-0">
            <h3 class="card-label fs-6 fw-bold m-0">Categories</h3>
        </div>
        <div class="card-toolbar">
            <button type="button" class="btn btn-light-primary btn-sm py-1" onclick="showCategoryManager()">
                <i class="ki-duotone ki-plus fs-7"></i>Manage Categories
            </button>
        </div>
    </div>
    <div class="card-body p-2">
        <div class="mb-3" id="categoriesCheckboxContainer">
            <?php
            $all_categories = getAllCategories();
            $item_categories = $action == 'edit' ? $news_item['categories'] : [];
            $item_category_ids = array_column($item_categories, 'id');
            
            foreach ($all_categories as $category):
                $checked = in_array($category['id'], $item_category_ids) ? 'checked' : '';
            ?>
                <div class="form-check form-check-custom form-check-solid mb-1">
                    <input class="form-check-input" type="checkbox" 
                           name="categories[]" 
                           value="<?= $category['id'] ?>"
                           id="category_<?= $category['id'] ?>"
                           <?= $checked ?>>
                    <label class="form-check-label fs-7" for="category_<?= $category['id'] ?>">
                        <?= htmlspecialchars($category['name']) ?>
                    </label>
                </div>
            <?php endforeach; ?>
        </div>
    </div>
</div>
</div>                        
                                            
              <div class="d-flex flex-column flex-row-fluid gap-7 gap-lg-10">
                                            <!--begin:::Tabs-->
                                           
                                            <!--end:::Tabs-->
                                            <!--begin::Tab content-->
                                            <div class="tab-content">
                                                <!--begin::Tab pane-->
                                                <div class="tab-pane fade active show" id="kt_ecommerce_add_product_general" role="tab-panel">
                                                    <div class="d-flex flex-column gap-7 gap-lg-10">
                                                        <!--begin::General options-->
                                                        <div class="card card-flush py-4">
                     
                                                            <div class="card-body pt-0">
                                                                                                        
          
                    <div class="mb-3">
                        <label for="title" class="form-label">Title:</label>
                        <input type="text" class="form-control form-control-sm form-control-solid" id="title" name="title" required value="<?php echo htmlspecialchars($news_item['title'] ?? ''); ?>">
                    </div>
                    <div class="mb-3">
                        <label for="title" class="form-label">Slug:</label>
                        <input type="text" class="form-control form-control-sm form-control-solid" id="slug" name="slug" required value="<?php echo htmlspecialchars($news_item['slug'] ?? ''); ?>">
                    </div>
                    <script>
                        const titleInput = document.getElementById('title');
const slugInput = document.getElementById('slug');

// Add event listener for real-time conversion
titleInput.addEventListener('input', function() {
    const titleValue = this.value;
    const slugValue = generateSlug(titleValue);
    slugInput.value = slugValue;
});

// Function to generate slug
function generateSlug(text) {
    return text
        .toLowerCase() // Convert to lowercase
        .trim() // Remove whitespace from both ends
        .replace(/[^\w\s-]/g, '') // Remove special characters
        .replace(/\s+/g, '-') // Replace spaces with hyphens
        .replace(/-+/g, '-'); // Replace multiple hyphens with single hyphen
}
                    </script>
                    <div class="mb-3">
                        <label for="short_description" class="form-label">Short Description:</label>
                        <textarea class="form-control form-control-sm form-control-solid" id="short_description" name="short_description" rows="3"><?php echo htmlspecialchars($news_item['short_description'] ?? ''); ?></textarea>
                    </div>
         
            
            
                    <div class="mb-3">
                        <label for="author" class="form-label">Author:</label>
                         <select name="author" class="form-select form-select-sm form-select-solid" >
                <option selected="true" disabled="disabled" >Choose author</option>
                
                <?php $select_sponsor = mysqli_query($DB_CONN, "select * from users where author =1 ");
    while ($row_sponsor = mysqli_fetch_assoc($select_sponsor))
    { ?>

    <option value="<?php echo $row_sponsor['id'] ?>" <?php if ($news_item['author'] == $row_sponsor['id']) echo 'selected="selected"'; ?> > <?php echo $row_sponsor['username']; ?> </option>
            <?php
    } ?>
            </select>
            
                    
                    </div>

  
                    <div class="mb-3">
                        <label for="keywords" class="form-label">Keywords (comma-separated):</label>
                        <input type="text" class="form-control form-control-sm form-control-solid" id="keywords" name="keywords" value="<?php echo htmlspecialchars($news_item['keywords'] ?? ''); ?>">
                    </div>
                   
                    <div class="mb-3">
    <label for="content" class="form-label">Content:</label>
    <div class="form-control" id="kt_docs_quill_basic">
        <?php echo htmlspecialchars($news_item['content'] ?? ''); ?>
    </div>
    <textarea name="content" id="hiddenContent" style="display:none;"></textarea>
</div>


                    <div class="mb-3">
                        <label for="datetime" class="form-label">Date and Time:</label>
                        <input type="datetime-local" class="form-control form-control-sm form-control-solid" id="datetime" name="datetime" required value="<?php echo htmlspecialchars($news_item['datetime'] ?? date('Y-m-d\TH:i')); ?>">
                    </div>
</div>
        </div>
        
        
        
<div class="card card-flush py-4">
    <div class="card-header">
        <div class="card-title">
            <div class="d-flex align-items-center">
                <i class="ki-duotone ki-question fs-1 me-2">
                    <span class="path1"></span>
                    <span class="path2"></span>
                    <span class="path3"></span>
                </i>
                <h2>Frequently Asked Questions</h2>
            </div>
        </div>
        <div class="card-toolbar">
            <button type="button" class="btn btn-sm btn-light-primary" onclick="addFaqItem()">
                <i class="ki-duotone ki-plus fs-2 me-2">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
                Add New FAQ
            </button>
        </div>
    </div>

    <div class="card-body pt-0">
        <div class="mb-10">
            <div class="text-muted fs-7 mb-5">Add frequently asked questions about this News/Blog to help your customers find answers quickly.</div>
            
            <div id="faq-section">
                <?php if ($news_item && !empty($faqs)): ?>
                    <?php foreach ($faqs as $index => $faq): ?>
                        <div class="faq-item card card-bordered mb-5">
                            <div class="card-body p-5">
                                <div class="d-flex flex-column gap-5">
                                    <!-- Question Section -->
                                    <div class="form-group">
                                        <label class="form-label ">Question #<?= $index + 1 ?></label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-light">
                                                <i class="ki-duotone ki-question-2 fs-3">
                                                    <span class="path1"></span>
                                                    <span class="path2"></span>
                                                </i>
                                            </span>
                                            <input type="text" 
                                                   class="form-control form-control-sm form-control-solid" 
                                                   name="faq_question[]" 
                                                   placeholder="Enter question here" 
                                                   value="<?= htmlspecialchars($faq['question']) ?>"
                                                   >
                                        </div>
                                    </div>

                                    <!-- Answer Section -->
                                    <div class="form-group">
                                        <label class="form-label ">Answer</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-light">
                                                <i class="ki-duotone ki-message-text-2 fs-3">
                                                    <span class="path1"></span>
                                                    <span class="path2"></span>
                                                </i>
                                            </span>
                                            <textarea class="form-control form-control-sm form-control-solid" 
                                                      name="faq_answer[]" 
                                                      placeholder="Enter detailed answer" 
                                                      rows="3"
                                                      ><?= htmlspecialchars($faq['answer']) ?></textarea>
                                        </div>
                                    </div>

                                    <!-- Action Buttons -->
                                    <div class="d-flex justify-content-end">
                                        <button type="button" 
                                                class="btn btn-sm btn-icon btn-light-danger" 
                                                onclick="removeFaqItem(this)"
                                                data-bs-toggle="tooltip"
                                                title="Remove FAQ">
                                            <i class="ki-duotone ki-trash fs-2">
                                                <span class="path1"></span>
                                                <span class="path2"></span>
                                                <span class="path3"></span>
                                                <span class="path4"></span>
                                                <span class="path5"></span>
                                            </i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <?php endforeach; ?>
                <?php else: ?>
                    <!-- Empty State -->
                    <div class="faq-item card card-bordered mb-5">
                        <div class="card-body p-5">
                            <div class="d-flex flex-column gap-5">
                                <div class="form-group">
                                    <label class="form-label ">Question #1</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light">
                                            <i class="ki-duotone ki-question-2 fs-3">
                                                <span class="path1"></span>
                                                <span class="path2"></span>
                                            </i>
                                        </span>
                                        <input type="text" 
                                               class="form-control form-control-sm form-control-solid" 
                                               name="faq_question[]" 
                                               placeholder="Enter question here"
                                               >
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label ">Answer</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light">
                                            <i class="ki-duotone ki-message-text-2 fs-3">
                                                <span class="path1"></span>
                                                <span class="path2"></span>
                                            </i>
                                        </span>
                                        <textarea class="form-control form-control-sm form-control-solid" 
                                                  name="faq_answer[]" 
                                                  placeholder="Enter detailed answer" 
                                                  rows="3"
                                                  ></textarea>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-end">
                                    <button type="button" 
                                            class="btn btn-sm btn-icon btn-light-danger" 
                                            onclick="removeFaqItem(this)"
                                            data-bs-toggle="tooltip"
                                            title="Remove FAQ">
                                        <i class="ki-duotone ki-trash fs-2">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                            <span class="path3"></span>
                                            <span class="path4"></span>
                                            <span class="path5"></span>
                                        </i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                <?php endif; ?>
            </div>
        </div>
    </div>
</div>

                                                </div>
                                                </div>
                                                <!--end::Tab pane-->
                                                <!--begin::Tab pane-->
                                         
                                                <!--end::Tab pane-->
                                            </div>              
         <div class="d-flex justify-content-end">
                                            
                                                <!--begin::Button-->
                                                <input type="hidden" name="action" value="<?php echo $action == 'edit' ? 'update' : 'add'; ?>">
                    <?php if ($action == 'edit'): ?>
                        <input type="hidden" name="id" value="<?php echo $id; ?>">
                    <?php endif; ?>
                    <button type="submit" name="submit" class="btn btn-primary"><?php echo $action == 'edit' ? 'Update' : 'Add'; ?> News</button>
                    <a href="admin?page=news" class="btn btn-secondary">Cancel</a>
                                                <!--end::Button-->
                                            </div>
                                        </div>
                                        <!--end::Main column-->
                                    </form>
<!-- Quill Dependencies -->
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet" />

<!-- Initialize Quill and Add Source Code Toggle -->
<script>
// Initialize Quill
var quill = new Quill('#kt_docs_quill_basic', {
    modules: {
        toolbar: {
            container: [
                [{ header: [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                ['blockquote', 'code-block'],
                [{ list: 'ordered' }, { list: 'bullet' }],
                [{ script: 'sub' }, { script: 'super' }],
                [{ indent: '-1' }, { indent: '+1' }],
                [{ direction: 'rtl' }],
                [{ size: ['small', false, 'large', 'huge'] }],
                [{ color: [] }, { background: [] }],
                [{ align: [] }],
                ['link', 'image', 'video'],
                ['clean']
            ],
            handlers: {
                'image': function() {
                    // Open your modal
                    $('#kt_modal_100').modal('show');
                }
            }
        }
    },
    placeholder: 'Type your text here...',
    theme: 'snow'
});


document.addEventListener('DOMContentLoaded', function() {

    const editorContainer = document.querySelector('#kt_docs_quill_basic').parentNode;
    const toggleButton = document.createElement('button');
    toggleButton.textContent = 'Toggle Source Code';
    toggleButton.className = 'btn btn-light-primary btn-sm mt-2';
    toggleButton.type = 'button'; 
    editorContainer.appendChild(toggleButton);

    const sourceTextarea = document.createElement('textarea');
    sourceTextarea.className = 'form-control form-control-solid mt-2';
    sourceTextarea.style.display = 'none';
    sourceTextarea.style.height = '300px';
    editorContainer.appendChild(sourceTextarea);

    var initialContent = `<?php echo htmlspecialchars_decode($news_item['content'] ?? ''); ?>`;
    quill.clipboard.dangerouslyPasteHTML(initialContent);

    let isSourceView = false;
    toggleButton.onclick = function() {
        isSourceView = !isSourceView;
        
        if (isSourceView) {
            // Show source code
            sourceTextarea.value = quill.root.innerHTML;
            quill.container.style.display = 'none';
            sourceTextarea.style.display = 'block';
        } else {
            // Show editor and update content
            quill.root.innerHTML = sourceTextarea.value;
            sourceTextarea.style.display = 'none';
            quill.container.style.display = 'block';
        }
    };

    // Update hidden content field when source code changes
    sourceTextarea.addEventListener('input', function() {
        document.querySelector('#hiddenContent').value = sourceTextarea.value;
    });

    // Update hidden content on editor changes
    quill.on('text-change', function() {
        if (!isSourceView) {
            document.querySelector('#hiddenContent').value = quill.root.innerHTML;
        }
    });

    // Form submission handler
    const form = document.querySelector('form');
    if (form) {
        form.onsubmit = function() {
            var content = document.querySelector('#hiddenContent');
            content.value = isSourceView ? sourceTextarea.value : quill.root.innerHTML;
        };
    }
});
</script>

<!-- Optional: Add some custom styling -->
<style>
.ql-editor {
    min-height: 200px;
}

.source-code-active {
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 10px;
}
</style>
               
        


    <?php else: ?>
<div class="card">
    <div class="card-header border-0 pt-6">
        <!--begin::Card title-->
        <div class="card-title">
            <!--begin::Search-->
            <div class="d-flex align-items-center position-relative my-1">
                <i class="ki-duotone ki-magnifier fs-3 position-absolute ms-4">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
                <input type="text" 
                       class="form-control form-control-solid w-250px ps-12" 
                       placeholder="Search news..."
                       id="searchInput">
            </div>
            <!--end::Search-->
        </div>
        <!--begin::Card title-->
        
        <!--begin::Card toolbar-->
        <div class="card-toolbar">
            <div class="d-flex justify-content-end">
                <!--begin::Add News-->
                <a href="admin?page=news&action=add" class="btn btn-primary">
                    <i class="ki-duotone ki-plus fs-2">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                    Add News
                </a>
                <!--end::Add News-->
            </div>
        </div>
        <!--end::Card toolbar-->
    </div>

    <div class="card-body pt-0">
        <!--begin::Table container-->
        <div class="table-responsive">
            <!--begin::Table-->
            <table class="table table-row-dashed table-row-gray-300 align-middle gs-0 gy-4" id="news_table">
                <!--begin::Table head-->
                <thead>
                    <tr class="fw-bold text-muted">
                        
                        <th class="min-w-80px text-muted">ID</th>
                        <th class="min-w-200px text-muted">Title</th>
                        <th class="min-w-125px text-muted">Date</th>
                        <th class="min-w-100px text-end text-muted">Actions</th>
                    </tr>
                </thead>
                <!--end::Table head-->

                <!--begin::Table body-->
                <tbody>
                    <?php while ($row = $news_list->fetch_assoc()): ?>
                        <tr>
                          
                            <td>
                                <span class="text-dark fw-bold text-hover-primary d-block fs-7">
                                    <?php echo htmlspecialchars($row['id']); ?>
                                </span>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="symbol symbol-45px me-5">
                                        <img src="<?php echo htmlspecialchars($row['image_url']); ?>" 
                                             alt="<?php echo htmlspecialchars($row['title']); ?>"
                                             onerror="this.src='bitders/assets/logo.svg'"/>
                                    </div>
                                    <div class="d-flex flex-column">
                                        <a href="admin?page=news&action=edit&id=<?php echo $row['id']; ?>" 
                                           class="text-gray-900 fw-bold d-block fs-7">
                                            <?php echo htmlspecialchars($row['title']); ?>
                                        </a>
                                        <span class="text-muted fw-semibold text-muted d-block fs-7">  <?php echo $row['slug']; ?></span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex flex-column">
                                    <span class="text-dark fw-bold">
                                        <?php echo date('M d, Y', strtotime($row['datetime'])); ?>
                                    </span>
                                    <span class="text-muted fw-semibold text-muted d-block fs-7">
                                        <?php echo date('h:i A', strtotime($row['datetime'])); ?>
                                    </span>
                                </div>
                            </td>
                            <td class="text-end">
                                <div class="d-flex flex-end">
                                    <!-- Preview -->
                                    <a href="news/<?php echo htmlspecialchars($row['slug']); ?>" 
                                       target="_blank"
                                       class="btn btn-icon btn-bg-light btn-active-color-warning btn-sm me-1"
                                       data-bs-toggle="tooltip"
                                       title="Preview">
                                        <i class="ki-duotone ki-eye fs-2">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                            <span class="path3"></span>
                                        </i>
                                    </a>
                                    
                                    <!-- Edit -->
                                    <a href="admin?page=news&action=edit&id=<?php echo $row['id']; ?>" 
                                       class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm me-1"
                                       data-bs-toggle="tooltip"
                                       title="Edit">
                                        <i class="ki-duotone ki-pencil fs-2">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                        </i>
                                    </a>
                                    
                                    <!-- Delete -->
                                    <button type="button" 
                                            class="btn btn-icon btn-bg-light btn-active-color-danger btn-sm"
                                            onclick="confirmDelete(<?php echo $row['id']; ?>)"
                                            data-bs-toggle="tooltip"
                                            title="Delete">
                                        <i class="ki-duotone ki-trash fs-2">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                            <span class="path3"></span>
                                            <span class="path4"></span>
                                            <span class="path5"></span>
                                        </i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    <?php endwhile; ?>
                </tbody>
                <!--end::Table body-->
            </table>
            <!--end::Table-->
        </div>
        <!--end::Table container-->
    </div>
</div>

<!-- Delete Form Template (Hidden) -->
<form id="deleteForm" action="" method="post" style="display: none;">
    <input type="hidden" name="action" value="delete">
    <input type="hidden" name="id" value="">
</form>

<script>
"use strict";

// Initialize tooltips
var initTooltips = function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
};

// Search functionality
var initSearch = function() {
    const searchInput = document.getElementById('searchInput');
    const table = document.getElementById('news_table');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

    searchInput.addEventListener('keyup', function(e) {
        const searchText = e.target.value.toLowerCase();

        for (let row of rows) {
            const titleCell = row.querySelector('td:nth-child(3)');
            const title = titleCell.textContent.toLowerCase();

            if (title.includes(searchText)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }
    });
};

// Select all functionality
var initSelectAll = function() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('tbody .form-check-input');

    selectAllCheckbox.addEventListener('change', function() {
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    });
};

// Delete confirmation
var confirmDelete = function(id) {
    Swal.fire({
        text: "Are you sure you want to delete this news item?",
        icon: "warning",
        showCancelButton: true,
        buttonsStyling: false,
        confirmButtonText: "Yes, delete!",
        cancelButtonText: "No, cancel",
        customClass: {
            confirmButton: "btn fw-bold btn-danger",
            cancelButton: "btn fw-bold btn-active-light-primary"
        }
    }).then(function(result) {
        if (result.isConfirmed) {
            const form = document.getElementById('deleteForm');
            form.querySelector('input[name="id"]').value = id;
            form.submit();
        }
    });
};

// Initialize components
document.addEventListener('DOMContentLoaded', function() {
    initTooltips();
    initSearch();
    initSelectAll();
});
</script>
    <?php endif; ?>
<?php
}
if ($_GET['page'] == 'faqs')
{ ?>
<div class="card">
    <!--begin::Card header-->
    <div class="card-header border-0 pt-1">
        <!--begin::Card title-->
        <div class="card-title">
            <!--begin::Search-->
            <div class="d-flex align-items-center position-relative my-1">
                <i class="ki-duotone ki-magnifier fs-3 position-absolute ms-5">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
                <input type="text" id="faqSearch" class="form-control form-control-solid form-control-sm w-250px ps-13" placeholder="Search FAQs">
            </div>
            <!--end::Search-->
            
            <!--begin::Status filter-->
            <div class="d-flex align-items-center ms-4">
                <select id="categoryFilter" class="form-select form-select-solid form-select-sm">
                    <option value="">All Categories</option>
                    <?php
                    $categories_query = mysqli_query($DB_CONN, "SELECT c.* 
    FROM categories c
    INNER JOIN categories p ON c.parent_id = p.id
    WHERE p.name = 'FAQs'
    ORDER BY c.name");

$categories_array = array();
while ($cat = mysqli_fetch_assoc($categories_query)) {
    $categories_array[] = $cat;
}
                    foreach ($categories_array as $cat) {
    echo "<option value='{$cat['name']}'>{$cat['name']}</option>";
}
                    ?>
                </select>
            </div>
            <!--end::Status filter-->
        </div>
        <!--end::Card title-->

        <!--begin::Card toolbar-->
        <div class="card-toolbar">
            <!--begin::Language select-->
            <div class="me-4">
                <form class="d-inline">
                    <input type="hidden" name="page" value="faqs">
                    <select name="lang" class="form-select form-select-solid form-select-sm" onchange="this.form.submit()">

                        <?php
                         $lang = isset($_GET['lang']) ? $_GET['lang'] : $lang_id;
                        $l = mysqli_query($DB_CONN, "SELECT * FROM languagues WHERE status = 1");

                        while ($lan = mysqli_fetch_assoc($l)) {
                            echo "<option value='{$lan['id']}'" . ($lan['id'] == $lang ? " selected" : "") . ">{$lan['name']}</option>";
                        }
                        ?>
                    </select>
                </form>
            </div>
            <!--end::Language select-->
            
            <!--begin::Add FAQ-->
            <a href="#" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#kt_modal_add_faq">
                <i class="ki-duotone ki-plus fs-2"></i>
                Add FAQ
            </a>
            <!--end::Add FAQ-->
        </div>
        <!--end::Card toolbar-->
    </div>
    <!--end::Card header-->

    <!--begin::Card body-->
    <div class="card-body py-0">
        <?php
        // Handle FAQ Updates
if (isset($_POST['submit'])) {
    $success = true;
    
    foreach ($_POST['question'] as $index => $value) {
        $question = trim(cleanContent($value));
        $answer = trim(cleanContent($_POST['answer'][$index]));
        
        // If both question and answer are empty, delete the FAQ
        if (empty($question) && empty($answer)) {
            $delete_stmt = $DB_CONN->prepare("DELETE FROM faqs WHERE id = ?");
            $delete_stmt->bind_param("i", $index);
            $success = $delete_stmt->execute();
            
            if (!$success) {
                break;
            }
            continue; // Skip the update for this item since we've deleted it
        }
        $tags = cleanContent($_POST['tags'][$index]);
        $category_id = !empty($_POST['category_id'][$index]) ? (int)$_POST['category_id'][$index] : "NULL";
        
        // Update the FAQ using prepared statement
        $stmt = $DB_CONN->prepare(
            "UPDATE faqs SET 
            question = ?, 
            answer = ?,
            tags = ?,
            category_id = ?
            WHERE id = ?"
        );
        $stmt->bind_param("sssii", $question, $answer, $tags, $category_id, $index);
        $success = $stmt->execute();
        
        if (!$success) {
            break;
        }
    }
    
    if ($success) {
        echo '<div class="alert alert-success d-flex align-items-center p-5 mb-10">
            <i class="ki-duotone ki-shield-tick fs-2hx text-success me-4">
                <span class="path1"></span><span class="path2"></span>
            </i>
            <div class="d-flex flex-column">
                <h4 class="mb-1 text-success">Success</h4>
                <span>FAQs updated successfully!</span>
            </div>
        </div>';
    }
}


        // Handle New FAQ Addition
if (isset($_POST['add'])) {
    $question = cleanContent($_POST['question']);
    $answer = cleanContent($_POST['answer']);
    $tags = cleanContent($_POST['tags']);
    $category_id = !empty($_POST['category_id']) ? (int)$_POST['category_id'] : "NULL";
    
    $stmt = $DB_CONN->prepare(
        "INSERT INTO faqs(question, answer, tags, lang_id, category_id, product_id, news_id) 
        VALUES(?, ?, ?, ?, ?, 0, 0)"
    );
    $stmt->bind_param("sssii", $question, $answer, $tags, $_POST['lang_id'], $category_id);
    $success = $stmt->execute();
    
    if ($success) {
        echo '<div class="alert alert-success d-flex align-items-center p-5 mb-10">
            <i class="ki-duotone ki-shield-tick fs-2hx text-success me-4">
                <span class="path1"></span><span class="path2"></span>
            </i>
            <div class="d-flex flex-column">
                <h4 class="mb-1 text-success">Success</h4>
                <span>New FAQ added successfully!</span>
            </div>
        </div>';
    }
}


        // Language Selection
       

        ?>

        <!--begin::Form-->
        <form method="POST" action="" id="faq_form">
            <?php
            // Get categories for dropdown
            $categories = mysqli_query($DB_CONN, "SELECT c.* 
    FROM categories c
    INNER JOIN categories p ON c.parent_id = p.id
    WHERE p.name = 'FAQs'
    ORDER BY c.name");
            
            // Get FAQs grouped by category (only general FAQs)
    $pref = mysqli_query($DB_CONN, 
    "SELECT f.*, c.name as category_name 
    FROM faqs f 
    LEFT JOIN categories c ON f.category_id = c.id 
    WHERE f.lang_id = '{$lang}' 
    AND (f.product_id = 0 OR f.product_id IS NULL)
    AND (f.news_id = 0 OR f.news_id IS NULL)
    ORDER BY COALESCE(c.name, 'Uncategorized'), f.id") 
    or die(mysqli_error($DB_CONN));



            $current_category = null;
            
            while ($a = mysqli_fetch_assoc($pref)) {
                // Display category header if category changes
                if ($current_category !== $a['category_name']) {
                    $current_category = $a['category_name'];
                    if ($current_category !== null) {
                        echo '</div>'; // Close previous accordion item if exists
                    }
                    ?>
                    <!--begin::Category Section-->
                    <div class="separator separator-dashed my-1"></div>
                    <div class="accordion accordion-icon-toggle" id="kt_accordion_<?= $current_category ?>">
                        <div class="mb-5">
                            <h3 class="fs-2 text-gray-800 w-bolder mb-0">
                                <?= ($current_category ?? 'Uncategorized') ?>
                            </h3>
                        </div>
                    <?php
                }
                ?>
               <!--begin::FAQ Item-->
                <div class="mb-5 faq-item" data-category="<?= htmlspecialchars($a['category_name'] ?? 'Uncategorized') ?>">
                    <div class="card card-bordered hover-elevator-up">
                        <div class="card-body p-lg-1 p-1">
                            <div class="row">
                                <div class="col-lg-5 col-md-12">
                                    <div class="mb-1">
                                        <label class="form-label fw-bold">Question</label>
                                        <div class="position-relative">
                                            <input type="text" name="question[<?=$a['id']?>]" 
                                                   class="form-control form-control-solid form-control-sm" 
                                                   value="<?=$a['question']?>"
                                                   data-bs-toggle="tooltip"
                                                   title="Leave both question and answer empty to delete">
                                            <span class="position-absolute top-50 end-0 translate-middle-y me-2">
                                                <i class="ki-duotone ki-message-text-2 fs-2 text-gray-500">
                                                    <span class="path1"></span>
                                                    <span class="path2"></span>
                                                </i>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-5 col-md-12">
                                    <div class="mb-1">
                                        <label class="form-label fw-bold">Answer</label>
                                        <textarea name="answer[<?=$a['id']?>]" 
                                                  class="form-control form-control-solid form-control-sm" 
                                                  rows="3"
                                                  data-bs-toggle="tooltip"
                                                  title="Leave both question and answer empty to delete"><?=$a['answer']?></textarea>
                                    </div>
                                </div>
                                <div class="col-lg-2 col-md-12">
                                    <div class="mb-1">
                                        <label class="form-label fw-bold">Category</label>
                                        <select name="category_id[<?=$a['id']?>]" class="form-select form-select-solid form-select-sm">
                                            <option value="">No Category</option>
                                            <?php
                                            mysqli_data_seek($categories, 0);
                                            while ($cat = mysqli_fetch_assoc($categories)) {
                                                echo "<option value='{$cat['id']}'" . 
                                                    ($cat['id'] == $a['category_id'] ? " selected" : "") . 
                                                    ">{$cat['name']}</option>";
                                            }
                                            ?>
                                        </select>
                                    </div>
                                    <div class="mb-1">
                                        <label class="form-label fw-bold">Tags</label>
                                        <input type="text" name="tags[<?=$a['id']?>]" 
                                               class="form-control form-control-solid form-control-sm" 
                                               value="<?=$a['tags']?>"
                                               placeholder="Enter tags">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--end::FAQ Item-->
            <?php } ?>
            </div> <!-- Close last accordion item -->

            <!--begin::Form Submit-->
            <div class="d-flex justify-content-between align-items-center mt-10">
                <span class="text-gray-700 fs-6 fw-semibold empty-faq-counter"></span>
                <button type="submit" name="submit" class="btn btn-primary" id="submitButton">
                    <span class="indicator-label">
                        <i class="ki-duotone ki-check fs-2 me-2">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                        Update FAQs
                    </span>
                    <span class="indicator-progress">
                        Please wait... 
                        <span class="spinner-border spinner-border-sm align-middle ms-2"></span>
                    </span>
                </button>
            </div>
            <!--end::Form Submit-->
        </form>
        <!--end::Form-->
    </div>
    <!--end::Card body-->
</div>
<!--end::Card-->

<!--begin::Modal - Add FAQ-->
<div class="modal fade" id="kt_modal_add_faq" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-650px">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="fw-bold">Add New FAQ</h2>
                <div class="btn btn-icon btn-sm btn-active-icon-primary" data-bs-dismiss="modal">
                    <i class="ki-duotone ki-cross fs-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                </div>
            </div>
            <form method="post" id="kt_modal_add_faq_form">
                <div class="modal-body py-10 px-lg-17">
                    <!--begin::Scroll-->
                    <div class="scroll-y me-n7 pe-7" data-kt-scroll="true" data-kt-scroll-activate="{default: false, lg: true}" data-kt-scroll-max-height="auto" data-kt-scroll-dependencies="#kt_modal_add_faq_header" data-kt-scroll-wrappers="#kt_modal_add_faq_scroll" data-kt-scroll-offset="300px">
                        <div class="fv-row mb-7">
                            <label class="required fw-semibold fs-6 mb-2">Category</label>
                            <select name="category_id" class="form-select" data-control="select2" data-placeholder="Select a category">
                                <option value="">No Category</option>
                                <?php
                                mysqli_data_seek($categories, 0);
                                while ($cat = mysqli_fetch_assoc($categories)) {
                                    echo "<option value='{$cat['id']}'>{$cat['name']}</option>";
                                }
                                ?>
                            </select>
                        </div>
                        <div class="fv-row mb-7">
                            <label class="required fw-semibold fs-6 mb-2">Question</label>
                            <textarea class="form-control" name="question" rows="3" required></textarea>
                        </div>
                        <div class="fv-row mb-7">
                            <label class="required fw-semibold fs-6 mb-2">Answer</label>
                            <textarea class="form-control" name="answer" rows="5" required></textarea>
                        </div>
                        <div class="fv-row mb-7">
                            <label class="fw-semibold fs-6 mb-2">Tags</label>
                            <input type="text" class="form-control" name="tags" placeholder="Enter tags separated by commas">
                        </div>
                    </div>
                    <!--end::Scroll-->
                </div>
                <div class="modal-footer flex-center">
                    <input type="hidden" name="lang_id" value="<?=$lang?>" />
                    <button type="reset" data-bs-dismiss="modal" class="btn btn-light me-3">Cancel</button>
                    <button type="submit" name="add" class="btn btn-primary">
                        <span class="indicator-label">Add FAQ</span>
                        <span class="indicator-progress">Please wait... 
                            <span class="spinner-border spinner-border-sm align-middle ms-2"></span>
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<!--end::Modal - Add FAQ-->

<!--begin::Page Specific Javascript-->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')).map(function(e) {
        return new bootstrap.Tooltip(e);
    });

    // Enhanced search functionality with debounce
    const searchInput = document.getElementById('faqSearch');
    let searchTimeout;

    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const searchText = this.value.toLowerCase();
            filterFaqs();
        }, 300);
    });

    // Category filter functionality
    const categoryFilter = document.getElementById('categoryFilter');
    categoryFilter.addEventListener('change', filterFaqs);

    function filterFaqs() {
        const searchText = searchInput.value.toLowerCase();
        const selectedCategory = categoryFilter.value;

        document.querySelectorAll('.faq-item').forEach(item => {
            const question = item.querySelector('input[name^="question"]').value.toLowerCase();
            const answer = item.querySelector('textarea[name^="answer"]').value.toLowerCase();
            const tags = item.querySelector('input[name^="tags"]')?.value.toLowerCase() || '';
            const category = item.dataset.category;

            const matchesSearch = question.includes(searchText) || 
                                answer.includes(searchText) || 
                                tags.includes(searchText);
            const matchesCategory = !selectedCategory || category === selectedCategory;

            item.style.display = (matchesSearch && matchesCategory) ? '' : 'none';
        });

        updateCounters();
    }

    // Enhanced visual feedback for empty FAQs
    function updateEmptyFaqStyle() {
        let emptyCount = 0;
        document.querySelectorAll('.faq-item').forEach(item => {
            const question = item.querySelector('input[name^="question"]').value.trim();
            const answer = item.querySelector('textarea[name^="answer"]').value.trim();
            const card = item.querySelector('.card');
            
            if (question === '' && answer === '') {
                emptyCount++;
                card.classList.add('border-danger', 'border-dashed');
                card.classList.remove('border-gray-300');
            } else {
                card.classList.remove('border-danger', 'border-dashed');
                card.classList.add('border-gray-300');
            }
        });

        // Update empty FAQ counter
        const counter = document.querySelector('.empty-faq-counter');
        counter.textContent = emptyCount > 0 ? 
            `${emptyCount} FAQ${emptyCount > 1 ? 's' : ''} marked for deletion` : '';
    }

    // Update category counters
    function updateCounters() {
        const categories = {};
        document.querySelectorAll('.faq-item:not([style*="display: none"])').forEach(item => {
            const category = item.dataset.category;
            categories[category] = (categories[category] || 0) + 1;
        });

        document.querySelectorAll('.category-counter').forEach(counter => {
            const category = counter.closest('.accordion').id.replace('kt_accordion_', '');
            counter.textContent = categories[category] || 0;
        });
    }

    // Add event listeners
    document.querySelectorAll('input[name^="question"], textarea[name^="answer"]')
        .forEach(el => el.addEventListener('input', () => {
            updateEmptyFaqStyle();
            el.closest('.card').classList.add('border-primary');
            setTimeout(() => {
                el.closest('.card').classList.remove('border-primary');
            }, 300);
        }));

    // Form submission handling
    const faqForm = document.getElementById('faq_form');
    faqForm.addEventListener('submit', function(e) {
        const emptyFaqs = document.querySelectorAll('.card.border-danger').length;
        
        if (emptyFaqs > 0) {
            if (!confirm(`${emptyFaqs} FAQ${emptyFaqs > 1 ? 's' : ''} will be permanently deleted. Do you want to continue?`)) {
                e.preventDefault();
                return false;
            }
        }
    });

    // Initialize
    updateEmptyFaqStyle();
    updateCounters();

    // Initialize Select2
    if (typeof jQuery !== 'undefined' && typeof jQuery.fn.select2 !== 'undefined') {
        jQuery('select[data-control="select2"]').select2({
            dropdownParent: jQuery('#kt_modal_add_faq')
        });
    }
});
</script>
<?
}
if ($_GET['page'] == 'telegram_settings'){
function setTelegramWebhook($encrypted_token, $url) {
    $token = encrypt_decrypt('decrypt', $encrypted_token);
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, "https://api.telegram.org/bot{$token}/setWebhook?url={$url}");
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_TIMEOUT, 10);
    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);
    
    return $httpCode === 200 ? json_decode($response, true) : null;
}
    $fullUrl = "http://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
    $parsedUrl = parse_url($fullUrl);
    $domain = $parsedUrl['host'];
$telegramLicenseActive = checkLicense($domain, 'telegram');

// Process form submission
if (isset($_POST['update_tokens']) ) {
    // Prepare telegram tokens array with encrypted individual tokens
    $telegram_data = [
        'main_token' => !empty($_POST['main_token']) ? encrypt_decrypt('encrypt', $_POST['main_token']) : '',
        'chat_token' => isset($_POST['use_main_token_chat']) 
            ? encrypt_decrypt('encrypt', $_POST['main_token']) 
            : (!empty($_POST['chat_token']) ? encrypt_decrypt('encrypt', $_POST['chat_token']) : ''),
        'group_token' => isset($_POST['use_main_token_group']) 
            ? encrypt_decrypt('encrypt', $_POST['main_token']) 
            : (!empty($_POST['group_token']) ? encrypt_decrypt('encrypt', $_POST['group_token']) : '')
    ];

    // Validation - check if we have at least one non-empty token
    $valid_tokens = false;
    $non_empty_tokens = array_filter($telegram_data);
    
    if (!empty($non_empty_tokens)) {
        $valid_tokens = true;
    }

    if ($valid_tokens) {
        // Prepare webhook URLs
        $webhook_urls = [
            'main' => "{$preferences['domain']}/thetelegrambot.php",
            'chat' => "{$preferences['domain']}/thetelegrambot.php",
            'group' => "{$preferences['domain']}/thetelegrambot.php"
        ];

        // Setup webhooks and get bot details
        $webhook_results = [];
        $unique_tokens = [];
        $bot_details = [];

        foreach (['main', 'chat', 'group'] as $type) {
            $encrypted_token = $telegram_data[$type . '_token'];
            if (!empty($encrypted_token) && !in_array($encrypted_token, $unique_tokens)) {
                // Set webhook
                $webhook_results[$type] = setTelegramWebhook($encrypted_token, $webhook_urls[$type]);
                
                // Get bot info
                $bot_data = getTelegramBotInfo($encrypted_token);
                if ($bot_data) {
                    $bot_details[$type] = $bot_data;
                }
                $unique_tokens[] = $encrypted_token;
            }
        }

        // Store in database
        $telegram_json = json_encode($telegram_data);
        $escaped_telegram = mysqli_real_escape_string($DB_CONN, $telegram_json);
        
        $update_query = "UPDATE preferences SET tgtoken = '{$escaped_telegram}' LIMIT 1";
        mysqli_query($DB_CONN, $update_query);
        updateSiteData($siteURL);

        // Update the $tgtoken variable for immediate use
        $tgtoken = [];
        foreach ($telegram_data as $key => $encrypted_value) {
            if (!empty($encrypted_value)) {
                $tgtoken[$key] = encrypt_decrypt('decrypt', $encrypted_value);
            }
        }
    }
} else {
    // Initial page load - Get tokens from database
    $tgtoken_encrypted = $pref['tgtoken'];
    $tgtoken = []; // Initialize array for tokens
    $bot_details = []; // Initialize array for bot details

    if (!empty($tgtoken_encrypted)) {
        // Decode the JSON string to get the encrypted tokens
        $tokens_array = json_decode($tgtoken_encrypted, true);
        
        if (is_array($tokens_array)) {
            // Decrypt and store tokens
            foreach (['main', 'chat', 'group'] as $type) {
                if (!empty($tokens_array[$type . '_token'])) {
                    $tgtoken[$type . '_token'] = encrypt_decrypt('decrypt', $tokens_array[$type . '_token']);
                    
                    // Get bot details
                    $bot_data = getTelegramBotInfo($tokens_array[$type . '_token']);
                    
                    if ($bot_data) {
                        $bot_details[$type] = $bot_data;
                    }
                }
            }
        }
    }
}
?>
<div class="card">
    <div class="card-body">
        <form method="POST" action="" id="telegram_bot_tokens_form">
            <div class="row g-5">
                
                
                <!-- Main Bot Token -->
                <div class="col-md-12">
                    <div class="card card-flush h-100 bg-light-primary">
                        <div class="card-header">
                            <h3 class="card-title">Telegram Bot Setup</h3>
                        </div>
                        <div class="card-body">
<div class="mb-3">
    <label class="form-label">Enter Bot Token</label>
   <?php if (empty($tgtoken['main_token'])): ?>
    <!-- Step-by-step guide -->
    <div class="alert alert-info d-flex align-items-center p-5 mb-5">
        <span class="svg-icon svg-icon-2hx svg-icon-info me-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path opacity="0.3" d="..." fill="currentColor"/>
                <path d="..." fill="currentColor"/>
            </svg>
        </span>
        <div class="d-flex flex-column">
            <h4 class="mb-1 text-info">How to create a Telegram bot:</h4>
            <ol class="m-0">
                <li>Open Telegram and search for @BotFather</li>
                <li>Send <code>/newbot</code> command</li>
                <li>Follow the setup instructions</li>
                <li>Copy the API token you receive</li>
                <li>Paste it in the field below</li>
            </ol>
        </div>
    </div>
<?php endif; ?>
    <div class="d-flex align-items-center gap-2 mb-2">
        <?php if (!empty($tgtoken['main_token']) && $telegramLicenseActive): ?>
            <button type="button" 
                    class="btn btn-sm badge badge-light-warning" 
                    onclick="showTokenInput('main')">
                Set New Main Token
            </button>
            <span class="badge badge-light-success">Token Set</span>
        <?php endif; ?>
    </div>
    
    <input type="text" 
           class="form-control form-control-solid <?= !empty($tgtoken['main_token']) ? 'd-none' : '' ?>" 
           id="main_token"
           name="main_token" 
           placeholder="Example: 1234567890:ABCdefGHIJKlmNoPQRsTUVwxyZ-123456789" 
           value=""/>
    
    <div class="text-muted fs-7 mt-2">
        Primary bot token for multiple functionalities. Keep this token secure.
    </div>
</div>
                            <!-- Main Bot Details Section -->
<?php if (!empty($bot_details['main'])): ?>
    <div class="mt-4 text-center">
        <div class="symbol symbol-100px mb-3">
            <img src="<?php 
                     $bot_id = $bot_details['main']['id'];
                     echo getUserProfilePhotos($bot_id) ?: 'https://via.placeholder.com/100'; 
                     ?>" 
                 alt="<?= htmlspecialchars($bot_details['main']['first_name']) ?>" 
                 class="symbol-label bg-light-primary">
        </div>
        <div class="fw-bold text-gray-900 fs-4 mb-1">
            <?= htmlspecialchars($bot_details['main']['first_name'] ?? 'Unknown Bot') ?>
        </div>
        <a href="https://t.me/<?= htmlspecialchars($bot_details['main']['username'] ?? '') ?>" 
           target="_blank" 
           class="text-gray-600 text-hover-primary fs-6">
            @<?= htmlspecialchars($bot_details['main']['username'] ?? 'unknown_bot') ?>
        </a>
        <div class="text-muted mt-2">
            <span class="badge badge-light-success">
                <?= $bot_details['main']['is_bot'] ? 'Bot Account' : 'Not a Bot' ?>
            </span>
        </div>
        
        <!-- Add Webhook Info Button and Status Here -->
        <div class="d-flex flex-column gap-2 mt-4">
            <button type="button" 
                    class="btn btn-sm btn-light-primary" 
                    onclick="getWebhookInfo('main', '<?= htmlspecialchars($tgtoken['main_token']) ?>')"
                    id="webhook-btn-main">
                Check Webhook Status
            </button>
            <div id="webhook-info-main" class="d-none">
                <div class="border border-gray-300 rounded p-3 mt-2">
                    <div class="d-flex flex-column gap-2">
                        <div class="d-flex justify-content-between">
                            <span class="fw-bold">Pending Updates:</span>
                            <span id="pending-main">-</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="fw-bold">Last Error:</span>
                            <span id="last-error-main">-</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="fw-bold">Error Date:</span>
                            <span id="error-date-main">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<?php endif; ?>
                        </div>
                    </div>
                </div>

                <!-- Chat Support Bot Token -->
                <div class="col-md-4 d-none">
                    <div class="card card-flush h-100 bg-light-success">
                        <div class="card-header">
                            <h3 class="card-title">Chat Support Bot</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" 
                                       type="checkbox" 
                                       id="use_main_token_chat" 
                                       name="use_main_token_chat"
                                       <?= empty($tgtoken['chat_token']) || $tgtoken['chat_token'] === $tgtoken['main_token'] ? 'checked' : '' ?>/>
                                <label class="form-check-label" for="use_main_token_chat">
                                    Use Main Bot Token
                                </label>
                            </div>
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <?php if (!empty($tgtoken['chat_token']) && $tgtoken['chat_token'] !== $tgtoken['main_token']): ?>
                                    <button type="button" 
                                            class="btn btn-sm badge badge-light-warning" 
                                            onclick="showTokenInput('chat')">
                                        Set New Chat Token
                                    </button>
                                    <span class="badge badge-light-success">Token Set</span>
                                <?php endif; ?>
                            </div>
                            <input type="text" 
                                   class="form-control form-control-solid <?= !empty($tgtoken['chat_token']) ? 'd-none' : '' ?>" 
                                   id="chat_token"
                                   name="chat_token" 
                                   placeholder="Enter Chat BOT:TOKEN" 
                                   value=""
                                   <?= empty($tgtoken['chat_token']) || $tgtoken['chat_token'] === $tgtoken['main_token'] ? 'disabled' : '' ?>/>
                            <div class="text-muted fs-7 mt-2">
                                Token for customer support conversations
                            </div>

                           <!-- Chat Bot Details Section -->
<?php if (!empty($bot_details['chat'])): ?>
    <div class="mt-4 text-center">
        <div class="symbol symbol-100px mb-3">
            <img src="<?php 
                     $bot_id = $bot_details['chat']['id'];
                     echo getUserProfilePhotos($bot_id) ?: 'https://via.placeholder.com/100'; 
                     ?>" 
                 alt="<?= htmlspecialchars($bot_details['chat']['first_name']) ?>" 
                 class="symbol-label bg-light-success">
        </div>
        <div class="fw-bold text-gray-900 fs-4 mb-1">
            <?= htmlspecialchars($bot_details['chat']['first_name'] ?? 'Unknown Bot') ?>
        </div>
        <a href="https://t.me/<?= htmlspecialchars($bot_details['chat']['username'] ?? '') ?>" 
           target="_blank" 
           class="text-gray-600 text-hover-primary fs-6">
            @<?= htmlspecialchars($bot_details['chat']['username'] ?? 'unknown_bot') ?>
        </a>
        <div class="text-muted mt-2">
            <span class="badge badge-light-success">
                <?= $bot_details['chat']['is_bot'] ? 'Bot Account' : 'Not a Bot' ?>
            </span>
        </div>
        
        <!-- Add Webhook Info Button and Status Here -->
        <div class="d-flex flex-column gap-2 mt-4">
            <button type="button" 
                    class="btn btn-sm btn-light-primary" 
                    onclick="getWebhookInfo('chat', '<?= htmlspecialchars($tgtoken['chat_token']) ?>')"
                    id="webhook-btn-chat">
                Check Webhook Status
            </button>
            <div id="webhook-info-chat" class="d-none">
                <div class="border border-gray-300 rounded p-3 mt-2">
                    <div class="d-flex flex-column gap-2">
                        <div class="d-flex justify-content-between">
                            <span class="fw-bold">Pending Updates:</span>
                            <span id="pending-chat">-</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="fw-bold">Last Error:</span>
                            <span id="last-error-chat">-</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="fw-bold">Error Date:</span>
                            <span id="error-date-chat">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<?php endif; ?>
                        </div>
                    </div>
                </div>

                <!-- Group/Channel Bot Token -->
                <div class="col-md-4 d-none" >
                    <div class="card card-flush h-100 bg-light-info">
                        <div class="card-header">
                            <h3 class="card-title">Group/Channel Bot</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" 
                                       type="checkbox" 
                                       id="use_main_token_group" 
                                       name="use_main_token_group"
                                       <?= empty($tgtoken['group_token']) || $tgtoken['group_token'] === $tgtoken['main_token'] ? 'checked' : '' ?>/>
                                <label class="form-check-label" for="use_main_token_group">
                                    Use Main Bot Token
                                </label>
                            </div>
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <?php if (!empty($tgtoken['group_token']) && $tgtoken['group_token'] !== $tgtoken['main_token']): ?>
                                    <button type="button" 
                                            class="btn btn-sm badge badge-light-warning" 
                                            onclick="showTokenInput('group')">
                                        Set New Group Token
                                    </button>
                                    <span class="badge badge-light-success">Token Set</span>
                                <?php endif; ?>
                            </div>
                            <input type="text" 
                                   class="form-control form-control-solid <?= !empty($tgtoken['group_token']) ? 'd-none' : '' ?>" 
                                   id="group_token"
                                   name="group_token" 
                                   placeholder="Enter Group BOT:TOKEN" 
                                   value=""
                                   <?= empty($tgtoken['group_token']) || $tgtoken['group_token'] === $tgtoken['main_token'] ? 'disabled' : '' ?>/>
                            <div class="text-muted fs-7 mt-2">
                                Token for group chats and channel broadcasts
                            </div>
<!-- Chat Bot Details Section -->
<?php if (!empty($bot_details['group'])): ?>
    <div class="mt-4 text-center">
        <div class="symbol symbol-100px mb-3">
            <img src="<?php 
                     $bot_id = $bot_details['group']['id'];
                     echo getUserProfilePhotos($bot_id) ?: 'https://via.placeholder.com/100'; 
                     ?>" 
                 alt="<?= htmlspecialchars($bot_details['group']['first_name']) ?>" 
                 class="symbol-label bg-light-info">  <!-- Changed to light-info to match the card style -->
        </div>
        <div class="fw-bold text-gray-900 fs-4 mb-1">
            <?= htmlspecialchars($bot_details['group']['first_name'] ?? 'Unknown Bot') ?>
        </div>
        <a href="https://t.me/<?= htmlspecialchars($bot_details['group']['username'] ?? '') ?>" 
           target="_blank" 
           class="text-gray-600 text-hover-primary fs-6">
            @<?= htmlspecialchars($bot_details['group']['username'] ?? 'unknown_bot') ?>
        </a>
        <div class="text-muted mt-2">
            <span class="badge badge-light-success">
                <?= $bot_details['group']['is_bot'] ? 'Bot Account' : 'Not a Bot' ?>
            </span>
        </div>
        
        <!-- Add Webhook Info Button and Status Here -->
        <div class="d-flex flex-column gap-2 mt-4">
            <button type="button" 
                    class="btn btn-sm btn-light-primary" 
                    onclick="getWebhookInfo('group', '<?= htmlspecialchars($tgtoken['group_token']) ?>')"
                    id="webhook-btn-group">  <!-- Changed from chat to group -->
                Check Webhook Status
            </button>
            <div id="webhook-info-group" class="d-none">  <!-- Changed from chat to group -->
                <div class="border border-gray-300 rounded p-3 mt-2">
                    <div class="d-flex flex-column gap-2">
                        <div class="d-flex justify-content-between">
                            <span class="fw-bold">Pending Updates:</span>
                            <span id="pending-group">-</span>  <!-- Changed from chat to group -->
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="fw-bold">Last Error:</span>
                            <span id="last-error-group">-</span>  <!-- Changed from chat to group -->
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="fw-bold">Error Date:</span>
                            <span id="error-date-group">-</span>  <!-- Changed from chat to group -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<?php endif; ?>

                           
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="d-flex justify-content-end mt-4">
                <button type="submit" 
                        name="update_tokens" 
                        class="btn btn-primary">
                    Save Telegram Bot Tokens
                </button>
            </div>
        </form>
    </div>
</div>
<script>
async function getWebhookInfo(botType, token) {
    if (!token) {
        toastr.error('No token available for this bot');
        return;
    }

    const btn = document.getElementById(`webhook-btn-${botType}`);
    const infoDiv = document.getElementById(`webhook-info-${botType}`);
    
    try {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...';
        
        const response = await fetch(`admin?page=getwebhookinfo&bot_type=${botType}&token=${encodeURIComponent(token)}`);
        const data = await response.json();
        
        if (data.ok) {
            const pendingUpdates = data.result.pending_update_count ?? 'N/A - All Good';
            const lastErrorDate = data.result.last_error_date 
                ? new Date(data.result.last_error_date * 1000).toLocaleString() 
                : 'N/A - All Good';
            const lastErrorMessage = data.result.last_error_message ?? 'N/A - All Good';
            
            document.getElementById(`pending-${botType}`).textContent = pendingUpdates;
            document.getElementById(`last-error-${botType}`).textContent = lastErrorMessage;
            document.getElementById(`error-date-${botType}`).textContent = lastErrorDate;
            
            infoDiv.classList.remove('d-none');
        } else {
            toastr.error('Failed to fetch webhook info: ' + (data.description || 'Unknown error'));
        }
    } catch (error) {
        toastr.error('Error fetching webhook info: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = 'Check Webhook Status';
    }
}
</script>
<script>

document.addEventListener('DOMContentLoaded', function() {
    const mainToken = document.getElementById('main_token');
    const chatToken = document.getElementById('chat_token');
    const groupToken = document.getElementById('group_token');
    const useMainTokenChat = document.getElementById('use_main_token_chat');
    const useMainTokenGroup = document.getElementById('use_main_token_group');

    // Function to show token input field
    window.showTokenInput = function(type) {
        const tokenInput = document.getElementById(`${type}_token`);
        const button = event.target;
        const buttonContainer = button.parentElement;
        
        // Show input field
        tokenInput.classList.remove('d-none');
        tokenInput.value = '';
        tokenInput.disabled = false;
        tokenInput.focus();
        
        // Hide the button container
        buttonContainer.classList.add('d-none');

        // If this is the main token, and other tokens are using it, show their inputs too
        if (type === 'main') {
            if (useMainTokenChat.checked) {
                showTokenInput('chat');
                useMainTokenChat.checked = false;
            }
            if (useMainTokenGroup.checked) {
                showTokenInput('group');
                useMainTokenGroup.checked = false;
            }
        }
    }

    // Token field management
    function updateTokenField(checkbox, tokenField) {
        if (checkbox.checked) {
            tokenField.value = mainToken.value;
            tokenField.disabled = true;
            tokenField.classList.add('d-none');
        } else {
            tokenField.value = '';
            tokenField.disabled = false;
            tokenField.classList.remove('d-none');
            tokenField.focus();
        }
    }

    // Main token change handler
    mainToken.addEventListener('input', function() {
        if (useMainTokenChat.checked) {
            chatToken.value = this.value;
        }
        if (useMainTokenGroup.checked) {
            groupToken.value = this.value;
        }
    });

    // Checkbox change handlers
    useMainTokenChat.addEventListener('change', () => updateTokenField(useMainTokenChat, chatToken));
    useMainTokenGroup.addEventListener('change', () => updateTokenField(useMainTokenGroup, groupToken));
});
</script>
   <?
}
if ($_GET['page'] == 'telegram_bot')
{ 
        $lang_id = isset($_GET['lang']) ? (int)$_GET['lang'] : 1;
    
    // Handle form submissions
if(isset($_POST['update'])) {
    $page = $_POST['page'];
    
    // Store content directly - it's already filtered
    $content_array = $_POST['content'];
    
    // Apply stripslashes to each value to remove any existing escapes
    foreach($content_array as $key => $value) {
        // No need for htmlspecialchars here as we want to store raw data
        $content_array[$key] = cleanContent($value);
    }
    
    // Convert to JSON with options to preserve formatting
    $content_json = json_encode($content_array, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);
    
    // Get menu position and order from form
    $menu_line = isset($_POST['menu_line']) ? $_POST['menu_line'] : 'separate';
    $menu_order = isset($_POST['menu_order']) ? (int)$_POST['menu_order'] : 0;
    
    // Get allow_loading setting (0 if not checked, 1 if checked)
    $allow_loading = isset($_POST['allow_loading']) ? 1 : 0;
    $show_in_menu = isset($_POST['show_in_menu']) ? 1 : 0;
    // Get buttons (simple comma-separated list)
    $buttons = isset($_POST['buttons']) ? is_array($_POST['buttons']) ? implode(',', $_POST['buttons']) : $_POST['buttons'] : '';
    $image_url = $_POST['image_url'];
    
    // Use a prepared statement to update all fields
    $stmt = mysqli_prepare($DB_CONN, 
        "UPDATE telegram_bot SET 
            content_data = ?, 
            menu_line = ?, 
            menu_order = ?,
            image_url = ?,
            allow_loading = ?,
            show_in_menu = ?,
            buttons = ?
        WHERE page = ? AND lang_id = ?");
    
    mysqli_stmt_bind_param($stmt, "ssisssssi", $content_json, $menu_line, $menu_order, $image_url, $allow_loading,$show_in_menu, $buttons, $page, $lang_id);
    $query = mysqli_stmt_execute($stmt);
    mysqli_stmt_close($stmt);
    
    if($query) {
        $success_message = '<div class="alert alert-success py-2">Updated Successfully</div>';
        updateSiteData($siteURL);
    }
}
    
if(isset($_POST['add_page'])) {
    $page = $_POST['new_page']; // Already sanitized by db_filter
    $content_type = $_POST['content_type'] ?? 'page';
    
    if ($content_type === 'page') {
        // Regular page (existing code)
        $initial_content = [
            'icon' => '',
            'menu' => '',
            'loading_text' => '',
            'header' => '',
            'sub_text' => '',           
            'details' => '',
            'content' => '',
            'footer_text' => '',
        ];
    } else {
        // External URL button
        $button_text = $_POST['button_text'] ?? '';
        $button_icon = $_POST['button_icon'] ?? '';
        $external_url = $_POST['external_url'] ?? '';
        
        $initial_content = [
            'icon' => $button_icon,
            'menu' => $button_text,
            'external_url' => $external_url,
            'is_external' => true,
            'loading_text' => '',
            'header' => '',
            'sub_text' => '',
            'details' => '',
            'content' => '',
            'footer_text' => '',
        ];
    }
    
    $content_json = json_encode($initial_content, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);
    
    $query = mysqli_query($DB_CONN,
        "INSERT INTO telegram_bot (page, content_data, lang_id) 
        VALUES ('{$page}', '{$content_json}', '{$lang_id}')");
        
    if($query) {
        $success_message = '<div class="alert alert-success py-2">' . 
            ($content_type === 'page' ? 'Page' : 'Button') . ' Added Successfully</div>';
        updateSiteData($siteURL);
    }
}
    
    if(isset($_POST['delete_page'])) {
        $page = $_POST['page']; // Already sanitized by db_filter
        $query = mysqli_query($DB_CONN, "DELETE FROM telegram_bot WHERE page = '{$page}' AND lang_id = '{$lang_id}'");
        if($query) {
            $success_message = '<div class="alert alert-success py-2">Page Deleted Successfully</div>';
            updateSiteData($siteURL);
        }
    }
?>
<div class="card mb-2">
    <div class="card-header min-h-unset py-2 d-flex justify-content-between align-items-center">
        <h3 class="card-title m-0">
            <span class="card-label fw-bold text-gray-900">Telegram Bot Manager</span>
        </h3>
        <div class="d-flex gap-3 align-items-center">
            <form method="GET" class="m-0">
                <input type="hidden" name="page" value="content">
                <select name="lang" class="form-select form-select-sm w-150px" onchange="this.form.submit()">
                    <?php
                    $languages = mysqli_query($DB_CONN, "SELECT * FROM languagues WHERE status = 1");
                    while($lan = mysqli_fetch_assoc($languages)) {
                        $selected = ($lan['id'] == $lang_id) ? ' selected' : '';
                        echo "<option value='{$lan['id']}'{$selected}>{$lan['name']}</option>";
                    }
                    ?>
                </select>
            </form>
         <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#add-page-modal">
    <i class="ki-duotone ki-plus fs-2">
        <span class="path1"></span>
        <span class="path2"></span>
        <span class="path3"></span>
    </i> 
    New Page
</button>
        </div>
    </div>
    <div class="card-header border-bottom min-h-unset py-2">
    <div class="d-flex align-items-center w-100">
        <!--begin::Search container-->
        <div class="position-relative w-100 me-2">
            <span class="svg-icon svg-icon-1 svg-icon-gray-500 position-absolute top-50 translate-middle-y ms-4">
                <i class="ki-duotone ki-magnifier fs-2">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
            </span>
            <input type="text" class="form-control form-control-solid form-control-sm ps-12" id="content-search" 
                   placeholder="Search Bot pages..." autocomplete="off">
            <div id="search-results" class="position-absolute start-0 mt-1 w-100 rounded shadow-sm bg-body d-none"
                 style="max-height: 250px; overflow-y: auto; z-index: 999; border: 1px solid var(--kt-border-color);">
                <!-- Search results will appear here -->
            </div>
        </div>
        <!--end::Search container-->
        
        <!--begin::Quick navigation dropdown-->
        <div class="ms-2">
            <select id="page-jump" class="form-select form-select-sm" data-control="select2" data-placeholder="Jump to page">
                <option></option>
                <!-- Page options will be populated via JavaScript -->
            </select>
        </div>
        <!--end::Quick navigation dropdown-->
    </div>
</div>
    <div class="card-body">
        <?php 
        if(isset($success_message)) {
            echo $success_message;
        }
        
        $pages = mysqli_query($DB_CONN, "SELECT * FROM telegram_bot WHERE lang_id = '{$lang_id}' ORDER BY show_in_menu DESC, menu_order ASC, `telegram_bot`.`page` ASC");
        if(mysqli_num_rows($pages) == 0) {
            echo '<div class="alert alert-info">No pages found. Click "New Page" to add content.</div>';
        }
        function getFieldValue($content_data, $default_templates, $field_name, $use_for_value = true) {
    // If content data exists for this field, use it
    if (isset($content_data[$field_name]) && !empty($content_data[$field_name])) {
        return $content_data[$field_name];
    }
    
    // Otherwise check for default template
    if (isset($default_templates[$field_name]) && !empty($default_templates[$field_name])) {
        if ($use_for_value) {
            return $default_templates[$field_name]; // Return as default value
        } else {
            return "e.g., " . htmlspecialchars($default_templates[$field_name]); // Return as placeholder
        }
    }
    
    // Fallback default placeholders based on field
    $placeholders = [
        'header' => 'e.g., 📊 *Your Transactions*',
        'sub_text' => 'e.g., View your recent activity',
        'details' => 'Enter detailed page content with placeholders like #username#',
        'footer_text' => 'e.g., Select a currency to withdraw:',
        'options_text' => 'e.g., 💰 #package_name# (#min_deposit# - #max_deposit#)',
        'loading_text' => 'e.g., Loading transactions ✅',
        'icon' => 'e.g., 📊, 💰, 👛',
        'menu' => 'e.g., Transactions, Wallets'
    ];
    
    return $placeholders[$field_name] ?? "Enter text here";
}
function isFieldEmpty($content_data, $field_name) {
        return !isset($content_data[$field_name]) || empty($content_data[$field_name]);
    }

   ?>
   <div class="accordion accordion-icon-toggle" id="telegram_pages_accordion">
    <?php
    $counter = 0;
    while($page = mysqli_fetch_assoc($pages)) {
        $counter++;
        $content_data = json_decode($page['content_data'], true) ?? [];
        $default_templates = !empty($page['default_templates']) ? json_decode($page['default_templates'], true) : [];
        $page_id = 'page_' . preg_replace('/[^a-z0-9_]/i', '_', $page['page']);
    ?>
    <div class="accordion-item mb-5 shadow-sm border rounded">
        <h2 class="accordion-header" id="heading_<?= $page_id ?>">
            <button class="accordion-button fs-4 fw-bold <?= ($counter > 1) ? 'collapsed' : '' ?>" type="button" 
                    data-bs-toggle="collapse" data-bs-target="#collapse_<?= $page_id ?>" 
                    aria-expanded="<?= ($counter === 1) ? 'true' : 'false' ?>" aria-controls="collapse_<?= $page_id ?>">
                <div class="d-flex align-items-center w-100">
                    <div class="d-flex align-items-center me-auto">
                        <span class="badge badge-light-primary fs-7 me-2"><?= htmlspecialchars($page['page']) ?></span>
                        <?php if(!empty($content_data['icon'])): ?>
                            <span class="fs-5 me-2"><?= htmlspecialchars($content_data['icon']) ?></span>
                        <?php endif; ?>
                        <?php if(!empty($content_data['menu'])): ?>
                            <span class="text-gray-700"><?= htmlspecialchars($content_data['menu']) ?></span>
                        <?php endif; ?>
                        <?php if(!empty($page['show_in_menu']) && $page['show_in_menu'] == 1): ?>
    <span class="badge badge-light-info fs-7 me-2">Menu #<?= (int)$page['menu_order'] ?></span>
<?php endif; ?>
<?php if(!empty($content_data['is_external']) && $content_data['is_external']): ?>
    <span class="badge badge-light-warning fs-7 me-2">External URL</span>
    <?php if(!empty($content_data['external_url'])): ?>
        <span class="text-muted fs-8 me-2"><?= htmlspecialchars($content_data['external_url']) ?></span>
    <?php endif; ?>
<?php endif; ?>
                    </div>
                    <span class="text-gray-500 fs-7 ms-2">Last updated: <?= date('M d, Y H:i', strtotime($page['updated_at'])) ?></span>
                </div>

            </button>
        </h2>
        <div id="collapse_<?= $page_id ?>" class="accordion-collapse collapse <?= ($counter === 1) ? 'show' : '' ?>" 
             aria-labelledby="heading_<?= $page_id ?>" data-bs-parent="#telegram_pages_accordion">
            <div class="accordion-body p-0">



        <form method="POST" class="mb-0">
            <div class="card card-bordered shadow-sm">
                <div class="card-header min-h-unset py-2 d-flex justify-content-between align-items-center">
                    <h3 class="card-title m-0 d-flex align-items-center gap-2">
                        <span class="badge badge-light-primary fs-7"><?= htmlspecialchars($page['page']) ?></span>
                        <span class="text-gray-600 fs-7">Last updated: <?= date('M d, Y H:i', strtotime($page['updated_at'])) ?></span>
                    </h3>
                    <div class="d-flex gap-2">
                          <div class="d-flex flex-column">
                          
                            <div class="form-check form-switch form-check-custom form-check-solid">
                                <input class="form-check-input" type="checkbox" name="show_in_menu" value="1" 
                                       <?= (!empty($page['show_in_menu']) && $page['show_in_menu'] == 1) ? 'checked' : '' ?>>
                                <label class="form-check-label">Show in menu keyboard</label>
                            </div>
                           
                        </div>
    <button type="submit" name="update" class="btn btn-sm btn-light-success">
        <i class="ki-duotone ki-check fs-2">
            <span class="path1"></span>
            <span class="path2"></span>
        </i> 
        Save Changes
    </button>
    <button type="submit" name="delete_page" class="btn btn-sm btn-light-danger" 
            onclick="return confirm('Are you sure you want to delete this page?')">
        <i class="ki-duotone ki-trash fs-2">
            <span class="path1"></span>
            <span class="path2"></span>
            <span class="path3"></span>
            <span class="path4"></span>
        </i>
    </button>
</div>
                </div>
                <div class="card-body p-4">
<div class="row g-3 mb-4">

<div class="col-md-4">
<div class="text-center">
            <div class="image-input image-input-outline" data-kt-image-input="true">
                <div class="image-input-wrapper w-350px h-150px" id="welcome-image-start-preview"
                    style="background-image: url('<?= !empty($page['image_url']) ? htmlspecialchars($page['image_url']) : 'bitders/assets/placeholder.svg' ?>')">
                </div>
                <label class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                       data-kt-image-input-action="change" data-bs-toggle="modal" data-bs-target="#kt_modal_100">
                    <i class="ki-duotone ki-pencil fs-7"><span class="path1"></span><span class="path2"></span></i>
                </label>
                <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                      data-kt-image-input-action="cancel" data-bs-toggle="tooltip" title="Cancel">
                    <i class="ki-outline ki-cross fs-2"></i>
                </span>
                <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                      data-kt-image-input-action="remove" data-bs-toggle="tooltip" title="Remove">
                    <i class="ki-outline ki-cross fs-2"></i>
                </span>
            </div>
            <div class="text-muted fs-7 mt-2">Upload an image to be Shown on this Menu/Page ( leave empty to show simple text ).</div>
            <input type="hidden" id="welcome-image-start-url" name="image_url" 
                   value="<?= !empty($page['image_url']) ? htmlspecialchars($page['image_url']) : '' ?>" 
                   data-original-value="<?= !empty($page['image_url']) ? htmlspecialchars($page['image_url']) : '' ?>">
        </div>
        </div>
        <div class="col-md-8">
            <div class="row">
               <?php if ((!empty($page['show_in_menu']) && $page['show_in_menu'] == 1) || 
          (isset($content_data['is_external']) && $content_data['is_external'])): ?>
                    
                <div class="col-md-6">
                <div class="d-flex flex-column">
                    <label class="form-label required fs-7 mb-1">Menu Position</label>
                    <select name="menu_line" class="form-control form-control-sm bg-light">
                        <option value="separate" <?= $page['menu_line'] === 'separate' ? 'selected' : '' ?>>Separate Line</option>
                        <option value="same" <?= $page['menu_line'] === 'same' ? 'selected' : '' ?>>Same Line</option>
                    </select>
                    <small class="text-muted">Button positioning in the menu</small>
                </div>
            </div>
            <?php endif; ?>
            <?php if ((!empty($page['show_in_menu']) && $page['show_in_menu'] == 1) || 
          (isset($content_data['is_external']) && $content_data['is_external'])): ?>
            <div class="col-md-6">
                <div class="d-flex flex-column">
                    <label class="form-label required fs-7 mb-1">Menu Order</label>
                    <input type="number" name="menu_order" class="form-control form-control-sm bg-light" 
                           value="<?= $page['menu_order'] ?>" min="0" max="100">
                    <small class="text-muted">Display order in the menu (lower numbers first)</small>
                </div>
            </div>
             <?php endif; ?>
<div class="col-md-6">
    <div class="d-flex flex-column mt-3">
        <label class="form-label fs-7 mb-1">Buttons</label>
        <select class="form-select form-select-solid form-select-sm" name="buttons[]" id="buttons_select_<?= $page['page'] ?>" multiple="multiple">
            <?php 
            $all_pages = mysqli_query($DB_CONN, "SELECT page FROM telegram_bot WHERE lang_id = '{$lang_id}' ORDER BY page ASC");
            $selected_buttons = !empty($page['buttons']) ? explode(',', $page['buttons']) : [];
            
            while ($row_page = mysqli_fetch_assoc($all_pages)) {
                $is_selected = in_array($row_page['page'], $selected_buttons) ? 'selected' : '';
            ?>
                <option value="<?= htmlspecialchars($row_page['page']) ?>" <?= $is_selected ?>><?= htmlspecialchars($row_page['page']) ?></option>
            <?php } ?>
        </select>
        <small class="text-muted">Select pages to use as buttons</small>
    </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function() {
    // Initialize the select2 for buttons
    $('[id^="buttons_select_"]').each(function() {
        $(this).select2({
            placeholder: "Select pages for buttons",
            allowClear: true,
            tags: true,
            tokenSeparators: [','],
            width: '100%'
        });
    });
});</script>
              <div class="col-md-6 mt-3">
                        <div class="d-flex flex-column">
                            <label class="form-label fs-7 mb-1">Show Loading</label>
                            <div class="form-check form-switch form-check-custom form-check-solid">
                                <input class="form-check-input" type="checkbox" name="allow_loading" value="1" 
                                       <?= (!empty($page['allow_loading']) && $page['allow_loading'] == 1) ? 'checked' : '' ?>>
                                <label class="form-check-label">Enable loading indicator</label>
                            </div>
                            <small class="text-muted">Show loading animation when page loads</small>
                        </div>
                    </div>
</div>
        </div>

<div class="separator my-4"></div>
<!-- Add this above your form or in a tooltip/modal -->
<div class="alert alert-info mb-3 p-0">
    <h6 class="mb-1">Text Formatting Options (Markdown)</h6>
    <div class="d-flex flex-wrap gap-2">
        <!-- Basic formatting -->
        <button type="button" class="btn btn-sm btn-light" onclick="applyFormatting('*Bold text*')">
            *Bold text* <i class="fas fa-copy ms-1"></i>
        </button>
        <button type="button" class="btn btn-sm btn-light" onclick="applyFormatting('_Italic text_')">
            _Italic text_ <i class="fas fa-copy ms-1"></i>
        </button>
        <button type="button" class="btn btn-sm btn-light" onclick="applyFormatting('__Underlined text__')">
            __Underlined text__ <i class="fas fa-copy ms-1"></i>
        </button>
        <button type="button" class="btn btn-sm btn-light" onclick="applyFormatting('~Strikethrough~')">
            ~Strikethrough~ <i class="fas fa-copy ms-1"></i>
        </button>
        <button type="button" class="btn btn-sm btn-light" onclick="applyFormatting('`Code`')">
            `Code` <i class="fas fa-copy ms-1"></i>
        </button>
        <!-- Block formatting -->
        <button type="button" class="btn btn-sm btn-light" onclick="applyFormatting('```\nCode block\n```')">
            Code block <i class="fas fa-copy ms-1"></i>
        </button>
        <button type="button" class="btn btn-sm btn-light" onclick="applyFormatting('||Spoiler text||')">
            ||Spoiler text|| <i class="fas fa-copy ms-1"></i>
        </button>
        <!-- Links -->
        <button type="button" class="btn btn-sm btn-light" onclick="applyFormatting('[Link text](URL)')">
            [Link text](URL) <i class="fas fa-copy ms-1"></i>
        </button>
    </div>
</div>
<div class="alert alert-light-primary mt-2 p-2">
    <small class="fw-bold">Pro tip:</small> 
    <small>You can also highlight text in a field and then click these buttons to apply formatting directly.</small>
</div>


 <!-- Icon field - show for menu items AND external links -->
<?php if ((!empty($page['show_in_menu']) && $page['show_in_menu'] == 1) || 
          (isset($content_data['is_external']) && $content_data['is_external'])): ?>
<div class="col-md-4">
    <div class="d-flex flex-column">
        <label class="form-label required fs-7 mb-1">Icon</label>
        <div class="input-group">
            <input type="text" name="content[icon]" id="iconInput_<?= $page['page'] ?>" 
                   class="form-control form-control-sm bg-light" 
                   value="<?= htmlspecialchars($content_data['icon'] ?? '') ?>">
        </div>
        <small class="text-muted">
            <?php if (isset($content_data['is_external']) && $content_data['is_external']): ?>
                Emoji icon for this external link button
            <?php else: ?>
                Emoji icon for this page (e.g., 📊 for transactions)
            <?php endif; ?>
            <?php if (isset($default_templates['icon'])): ?>
                <br><span class="text-primary">Default: <?= htmlspecialchars($default_templates['icon']) ?></span>
            <?php endif; ?>
        </small>
    </div>
</div>
<?php endif; ?>

<!-- Menu field - show for menu items AND external links -->
<?php if ((!empty($page['show_in_menu']) && $page['show_in_menu'] == 1) || 
          (isset($content_data['is_external']) && $content_data['is_external'])): ?>
<div class="col-md-4">
    <div class="d-flex flex-column">
        <label class="form-label required fs-7 mb-1">
            <?php if (isset($content_data['is_external']) && $content_data['is_external']): ?>
                Button Text
            <?php else: ?>
                Menu
            <?php endif; ?>
        </label>
        <input type="text" name="content[menu]" class="form-control form-control-sm bg-light" 
               value="<?= htmlspecialchars($content_data['menu'] ?? '') ?>">
        <small class="text-muted">
            <?php if (isset($content_data['is_external']) && $content_data['is_external']): ?>
                Text displayed on the external link button
            <?php else: ?>
                For bot menu buttons and navigation
            <?php endif; ?>
            <?php if (isset($default_templates['menu'])): ?>
                <br><span class="text-primary">Default: <?= htmlspecialchars($default_templates['menu']) ?></span>
            <?php endif; ?>
        </small>
    </div>
</div>
<?php endif; ?>

<!-- Back Text field - only for non-menu pages that aren't external links -->
<?php if ($page['show_in_menu'] == 0 && !(isset($content_data['is_external']) && $content_data['is_external'])): ?>
<div class="col-md-4">
    <div class="d-flex flex-column">
        <label class="form-label required fs-7 mb-1">Back Text</label>
        <div class="input-group">
           <input type="text" name="content[back_text]" class="form-control form-control-sm bg-light" 
               value="<?= htmlspecialchars($content_data['back_text'] ?? '') ?>">
        </div>
        <small class="text-muted">
            Back to PageName
            <?php if (isset($default_templates['back_text'])): ?>
                <br><span class="text-primary">Default: <?= htmlspecialchars($default_templates['back_text']) ?></span>
            <?php endif; ?>
        </small>
    </div>
</div>
<?php endif; ?>
<!-- Loading Text field -->
<div class="col-md-4">
    <div class="d-flex flex-column">
        <label class="form-label required fs-7 mb-1">Loading Text</label>
        <input type="text" name="content[loading_text]" class="form-control form-control-sm bg-light" 
               value="<?= htmlspecialchars($content_data['loading_text'] ?? '') ?>">
        <small class="text-muted">
            Text shown during loading states
            <?php if (isset($default_templates['loading_text'])): ?>
                <br><span class="text-primary">Default: <?= htmlspecialchars($default_templates['loading_text']) ?></span>
            <?php endif; ?>
        </small>
    </div>
</div>

<!-- Header field -->
<div class="col-md-4">
    <div class="d-flex flex-column">
        <label class="form-label required fs-7 mb-1">Header / Page Title</label>
        <input type="text" name="content[header]" class="form-control form-control-sm bg-light" 
               value="<?= htmlspecialchars($content_data['header'] ?? '') ?>">
        <small class="text-muted">
            Main heading at the top of each page
            <?php if (isset($default_templates['header'])): ?>
                <br><span class="text-primary">Default: <?= htmlspecialchars($default_templates['header']) ?></span>
            <?php endif; ?>
        </small>
    </div>
</div>

<!-- Sub Header Text field -->
<div class="col-md-4">
    <div class="d-flex flex-column">
        <label class="form-label required fs-7 mb-1">Sub Header Text</label>
        <input type="text" name="content[sub_text]" class="form-control form-control-sm bg-light" 
               value="<?= htmlspecialchars($content_data['sub_text'] ?? '') ?>">
        <small class="text-muted">
            Short descriptive text
            <?php if (isset($default_templates['sub_text'])): ?>
                <br><span class="text-primary">Default: <?= htmlspecialchars($default_templates['sub_text']) ?></span>
            <?php endif; ?>
        </small>
    </div>
</div>

<!-- Details field -->
<div class="col-12">
    <div class="d-flex flex-column">
        <label class="form-label required fs-7 mb-1">Details</label>
        <textarea rows="3" name="content[details]" class="form-control form-control-sm bg-light"><?= !empty($content_data['details']) ? htmlspecialchars($content_data['details']) : '' ?></textarea>
        <small class="text-muted">
            Additional detailed information
            <?php if (isset($default_templates['details'])): ?>
                <br><span class="text-primary">Default: <?= nl2br(htmlspecialchars($default_templates['details'])) ?></span>
            <?php endif; ?>
        </small>
        <?php if (isFieldEmpty($content_data, 'details') && isset($default_templates['details'])): ?>
        <div class="text-muted fs-7 mt-1">
            <span class="badge badge-light-info">Using default template</span>
        </div>
        <?php endif; ?>
    </div>
</div>

<?php 
// --- DYNAMIC FIELD GROUPS SECTION ---

// Define field groups and their descriptions
$fieldGroups = [
    'header' => [
        'title' => 'Section Headers',
        'fields' => ['wallets_header', 'investments_header', 'transactions_header'],
        'description' => 'Header text for different sections'
    ],
    'details' => [
        'title' => 'Detail Templates',
        'fields' => ['details_with_release_date', 'details_principal_available', 'details_id', 'details_url', 'details_variable'],
        'description' => 'Templates for displaying different types of details'
    ],
    'messages' => [
        'title' => 'Messages',
        'fields' => ['no_investments', 'no_wallets', 'no_transactions', 'separator'],
        'description' => 'Messages shown when data is not available'
    ],
    'buttons' => [
        'title' => 'Button Text',
        'fields' => ['confirm_btn', 'cancel_btn', 'back_to_investments_btn', 'prev_button', 'next_button'],
        'description' => 'Text displayed on various buttons'
    ],
    'prompts' => [
        'title' => 'User Prompts',
        'fields' => ['partial_release_prompt', 'confirm_release'],
        'description' => 'Templates for prompting user actions'
    ],
    'pagination' => [
        'title' => 'Pagination Settings',
        'fields' => ['per_page', 'page_indicator'],
        'description' => 'Settings for paginated displays'
    ],
    'results' => [
        'title' => 'Result Templates',
        'fields' => ['results', 'results_variable', 'success_instant', 'success_pending'],
        'description' => 'Templates for showing results or confirmations'
    ]
];

// Get complex fields that should be rendered as textareas
$complexFields = [
    'details_with_release_date', 'details_principal_available', 'details_id', 'details_url',
    'partial_release_prompt', 'confirm_release', 'results', 'results_variable',
    'success_instant', 'success_pending'
];

// Field descriptions - provide specific descriptions for important fields
$fieldDescriptions = [
    'details_with_release_date' => 'Template for investments with future principal release date (#id# shows as sequential number)',
    'details_principal_available' => 'Template for investments with available principal release (#id# shows as sequential number)',
    'details_id' => 'Transaction details with ID format',
    'details_url' => 'Transaction details with ID and URL format',
    'partial_release_prompt' => 'Template displayed when asking for partial release amount',
    'confirm_release' => 'Template displayed when confirming principal release',
    'per_page' => 'Number of transactions to display per page',
    'prev_button' => 'Text for the previous page button',
    'next_button' => 'Text for the next page button',
    'page_indicator' => 'Format for the page indicator (use {current} and {total} as placeholders)',
    'confirm_btn' => 'Text for the confirm button',
    'cancel_btn' => 'Text for the cancel button',
    'back_to_investments_btn' => 'Text for the back to investments button',
    'no_investments' => 'Message to display when no investments are found',
    'no_wallets' => 'Message to display when no wallet addresses are found',
    'separator' => 'Separator to use between page sections',
    'wallets_header' => 'Header text for the wallets section',
    'investments_header' => 'Header text for the investments section',
    'transactions_header' => 'Header text for the transactions section'
];

// Common fields to exclude (already handled in the main form)
$commonFields = ['icon', 'menu', 'loading_text', 'header', 'sub_text', 'details', 'content', 'footer_text', 'options_text', 'back_text'];

// Process template fields
if (!empty($default_templates)) {
    // Group fields by category
    $categorizedFields = [];
    $uncategorizedFields = [];
    
    foreach ($default_templates as $field_key => $default_value) {
        // Skip common fields
        if (in_array($field_key, $commonFields)) {
            continue;
        }
        
        // Find which group this field belongs to
        $assigned = false;
        foreach ($fieldGroups as $group => $info) {
            if (in_array($field_key, $info['fields'])) {
                if (!isset($categorizedFields[$group])) {
                    $categorizedFields[$group] = [
                        'title' => $info['title'],
                        'description' => $info['description'],
                        'fields' => []
                    ];
                }
                $categorizedFields[$group]['fields'][$field_key] = $default_value;
                $assigned = true;
                break;
            }
        }
        
        // If field doesn't belong to any group, add to uncategorized
        if (!$assigned) {
            $uncategorizedFields[$field_key] = $default_value;
        }
    }
    
    // Render grouped fields
    foreach ($categorizedFields as $group => $info) {
        if (!empty($info['fields'])) {
            echo '<div class="separator my-4"></div>';
            echo '<h3 class="fs-7 fw-bold mb-1">' . htmlspecialchars($info['title']) . '</h3>';
            echo '<div class="text-muted mb-0">' . htmlspecialchars($info['description']) . '</div>';
            echo '<div class="row g-3 mb-3">';
            
            foreach ($info['fields'] as $field_key => $default_value) {
                // Skip if this field doesn't exist in default templates
                if (!isset($default_templates[$field_key])) {
                    continue;
                }
                
                // Determine if complex field (needs textarea)
                $isComplexField = in_array($field_key, $complexFields) || 
                                 strlen($default_value) > 100 || 
                                 strpos($default_value, "\n") !== false;
                
                // Get field description
                $description = $fieldDescriptions[$field_key] ?? "Field for " . ucwords(str_replace('_', ' ', $field_key));
                
                // Determine column width
                $colWidth = $isComplexField ? '12' : 'md-4';
                
                echo '<div class="col-' . $colWidth . '">';
                echo '<div class="d-flex flex-column">';
                echo '<label class="form-label required fs-7 mb-1">' . ucwords(str_replace('_', ' ', $field_key)) . '</label>';
                
                if ($isComplexField) {
                    echo '<textarea rows="4" name="content[' . $field_key . ']" class="form-control form-control-sm bg-light">';
                    echo !empty($content_data[$field_key]) ? htmlspecialchars($content_data[$field_key]) : '';
                    echo '</textarea>';
                } else {
                    echo '<input type="' . ($field_key === 'per_page' ? 'number' : 'text') . '" name="content[' . $field_key . ']" class="form-control form-control-sm bg-light" ';
                    echo 'value="' . htmlspecialchars($content_data[$field_key] ?? '') . '">';
                }
                
                echo '<small class="text-muted">' . htmlspecialchars($description);
                if (isset($default_templates[$field_key])) {
                   echo '<br><span class="text-primary">Default: ' . nl2br(htmlspecialchars($default_templates[$field_key])) . '</span>';
                }
                echo '</small>';
                
                if (isFieldEmpty($content_data, $field_key) && isset($default_templates[$field_key])) {
                    echo '<div class="text-muted fs-7 mt-1">';
                    echo '<span class="badge badge-light-info">Using default template</span>';
                    echo '</div>';
                }
                echo '</div></div>';
            }
            
            echo '</div>';
        }
    }
    
    // Render uncategorized fields (if any)
    if (!empty($uncategorizedFields)) {
        echo '<div class="separator my-4"></div>';
        echo '<h3 class="fs-7 fw-bold mb-3">Additional Fields</h3>';
        echo '<div class="row g-3 mb-3">';
        
        foreach ($uncategorizedFields as $field_key => $default_value) {
            // Determine if complex field
            $isComplexField = strlen($default_value) > 100 || strpos($default_value, "\n") !== false;
            
            echo '<div class="col-' . ($isComplexField ? '12' : 'md-4') . '">';
            echo '<div class="d-flex flex-column">';
            echo '<label class="form-label required fs-7 mb-1">' . ucwords(str_replace('_', ' ', $field_key)) . '</label>';
            
            if ($isComplexField) {
                echo '<textarea rows="4" name="content[' . $field_key . ']" class="form-control form-control-sm bg-light">';
                echo !empty($content_data[$field_key]) ? htmlspecialchars($content_data[$field_key]) : '';
                echo '</textarea>';
            } else {
                echo '<input type="text" name="content[' . $field_key . ']" class="form-control form-control-sm bg-light" ';
                echo 'value="' . htmlspecialchars($content_data[$field_key] ?? '') . '">';
            }
            
            echo '<small class="text-muted">Field for ' . htmlspecialchars(str_replace('_', ' ', $field_key));
            if (isset($default_templates[$field_key])) {
                echo '<br><span class="text-primary">Default: ' . htmlspecialchars($default_templates[$field_key]) . '</span>';
            }
            echo '</small>';
            
            if (isFieldEmpty($content_data, $field_key) && isset($default_templates[$field_key])) {
                echo '<div class="text-muted fs-7 mt-1">';
                echo '<span class="badge badge-light-info">Using default template</span>';
                echo '</div>';
            }
            echo '</div></div>';
        }
        
        echo '</div>';
    }
    
    // Special page-specific information sections
    if (strpos($page['page'], 'profile') !== false) {
        echo '<div class="col-12 mt-3">';
        echo '<div class="alert alert-info">';
        echo '<i class="fa fa-info-circle me-2"></i>';
        echo '<strong>Template Reuse Information</strong>';
        echo '<p class="mb-1">The profile page reuses templates from other pages:</p>';
        echo '<ul class="mb-0">';
        echo '<li>Transaction details use templates from the "Transactions" page</li>';
        echo '<li>Investment details use templates from the "Investments" page</li>';
        echo '<li>Wallet formatting uses elements from the "Wallets" page</li>';
        echo '</ul>';
        echo '<div class="mt-2">';
        echo 'To customize these elements, please edit their respective page templates.';
        echo '</div>';
        echo '</div>';
        echo '</div>';
    }
}
?>

<!-- Content field -->
<div class="col-12">
    <div class="d-flex flex-column">
        <label class="form-label required fs-7 mb-1">Content</label>
        <textarea name="content[content]" class="form-control form-control-sm bg-light" 
                  rows="3"><?= htmlspecialchars($content_data['content'] ?? '') ?></textarea>
        <small class="text-muted">
            Main content text
            <?php if (isset($default_templates['content'])): ?>
                <br><span class="text-primary">Default: <?= htmlspecialchars($default_templates['content']) ?></span>
            <?php endif; ?>
        </small>
    </div>
</div>

<!-- Footer Text field -->
<div class="col-md-4">
    <div class="d-flex flex-column">
        <label class="form-label required fs-7 mb-1">Footer (Instruction Text)</label>
        <input type="text" name="content[footer_text]" class="form-control form-control-sm bg-light" 
               value="<?= htmlspecialchars($content_data['footer_text'] ?? '') ?>">
        <small class="text-muted">
            Short descriptive text
            <?php if (isset($default_templates['footer_text'])): ?>
                <br><span class="text-primary">Default: <?= htmlspecialchars($default_templates['footer_text']) ?></span>
            <?php endif; ?>
        </small>
    </div>
</div>

<!-- Options Text field -->
<div class="col-md-4">
    <div class="d-flex flex-column">
        <label class="form-label required fs-7 mb-1">Menu Options Button Text</label>
        <input type="text" name="content[options_text]" class="form-control form-control-sm bg-light" 
               value="<?= htmlspecialchars($content_data['options_text'] ?? '') ?>">
        <small class="text-muted">
            Text to be shown in options button
            <?php if (isset($default_templates['options_text'])): ?>
                <br><span class="text-primary">Default: <?= htmlspecialchars($default_templates['options_text']) ?></span>
            <?php endif; ?>
        </small>
    </div>
</div>

<!-- Additional Custom Fields -->
<div class="separator my-4"></div>
<div class="mb-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <label class="form-label fs-7 mb-0">Additional Custom Fields</label>
        <button type="button" class="btn btn-sm btn-light-primary py-1" onclick="addField('<?= $page['page'] ?>')">
            <i class="ki-duotone ki-plus fs-2"><span class="path1"></span><span class="path2"></span><span class="path3"></span></i>
            Add Field
        </button>
    </div>
    
    <div id="fields_<?= $page['page'] ?>">
        <div class="row g-3">
        <?php 
        if($content_data) {
            // Get all fields from both our dynamically rendered templates and common fields
            $handledFields = $commonFields ?? ['icon', 'menu', 'loading_text', 'header', 'sub_text', 'details', 'content', 'footer_text', 'options_text','back_text'];
            
            // Add all default template fields to the handled fields list since our dynamic renderer will handle those
            if (!empty($default_templates)) {
                foreach ($default_templates as $key => $value) {
                    $handledFields[] = $key;
                }
            }
            
            // Now display only fields that aren't already handled elsewhere
            foreach($content_data as $key => $value) {
                if(!in_array($key, $handledFields)) {
        ?>
        <div class="col-md-4" data-field="<?= htmlspecialchars($key) ?>">
            <div class="position-relative">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <label class="form-label text-gray-600 fs-7 mb-0"><?= htmlspecialchars($key) ?></label>
                    <button type="button" class="btn btn-sm btn-icon btn-light-danger p-0 w-20px h-20px" onclick="removeField(this)">
                        <i class="ki-duotone ki-cross fs-6">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                    </button>
                </div>
                <input type="text" name="content[<?= $key ?>]" class="form-control form-control-sm bg-light" 
                       value="<?= htmlspecialchars($value) ?>">
                <small class="text-muted">
                    Custom field
                    <?php if (isset($default_templates[$key])): ?>
                        <br><span class="text-primary">Default: <?= htmlspecialchars($default_templates[$key]) ?></span>
                    <?php endif; ?>
                </small>
                <?php if (empty($value) && isset($default_templates[$key])): ?>
                    <div class="text-muted fs-7 mt-1">
                        <span class="badge badge-light-info">Using default template</span>
                    </div>
                <?php endif; ?>
            </div>
        </div>
        <?php
                }
            }
        }
        ?>
        </div>
    </div>
</div>
<?php
// Check if this is an external button
$is_external = isset($content_data['is_external']) && $content_data['is_external'] === true;
?>
<?php if ($is_external): ?>
<div class="separator my-4"></div>
<h3 class="fs-7 fw-bold mb-3">External URL Settings</h3>
<div class="alert alert-light-info">
    <i class="ki-outline ki-information-5 fs-2 me-2"></i>
    This is configured as an external URL button. When used in navigation, it will open the URL in a browser.
</div>

<div class="row g-3 mb-3">
    <div class="col-md-8">
        <div class="d-flex flex-column">
            <label class="form-label required fs-7 mb-1">External URL</label>
            <input type="url" name="content[external_url]" class="form-control form-control-sm bg-light" 
                   value="<?= htmlspecialchars($content_data['external_url'] ?? '') ?>">
            <small class="text-muted">
                The URL that will open when this button is clicked (e.g., https://t.me/somesupport)
            </small>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="d-flex flex-column">
            <label class="form-label fs-7 mb-1">Is External Link</label>
            <div class="form-check form-switch form-check-custom form-check-solid">
                <input class="form-check-input" type="checkbox" name="content[is_external]" value="1" 
                       <?= ($is_external) ? 'checked' : '' ?>>
                <label class="form-check-label">Enable external URL</label>
            </div>
            <small class="text-muted">Controls whether this button opens an external URL</small>
        </div>
    </div>
</div>
<?php endif; ?>

                     
                            <input type="hidden" name="page" value="<?= $page['page'] ?>">
                        </div>
                    </div>
                     </div>
                </form>
            </div>
        </div>
    </div>
    <?php } ?>
</div>

<!-- Modified Add Page Modal -->
<div class="modal fade" id="add-page-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST">
                <div class="modal-header py-2">
                    <h5 class="modal-title">Add New Page/Button</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label required">Type</label>
                        <select name="content_type" class="form-select form-select-sm" id="content_type_selector">
                            <option value="page">Regular Page</option>
                            <option value="button">External URL Button</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label required">Identifier</label>
                        <input type="text" name="new_page" class="form-control form-control-sm" required 
                               pattern="[a-z0-9_]+" title="Only lowercase letters, numbers and underscore allowed">
                        <span class="fs-8 text-gray-500">Use lowercase letters, numbers and underscore only (e.g., "support", "contact_us")</span>
                    </div>
                    
                    <!-- External URL fields (shown only when button type is selected) -->
                    <div id="button_fields" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label required">Button Text</label>
                            <input type="text" name="button_text" class="form-control form-control-sm"
                                   placeholder="Contact Support">
                        </div>
                        <div class="mb-3">
                            <label class="form-label required">Button Icon</label>
                            <input type="text" name="button_icon" class="form-control form-control-sm"
                                   placeholder="📞">
                        </div>
                        <div class="mb-3">
                            <label class="form-label required">External URL</label>
                            <input type="url" name="external_url" class="form-control form-control-sm"
                                   placeholder="https://t.me/somesupport">
                        </div>
                    </div>
                </div>
                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-sm btn-light" data-bs-dismiss="modal">Close</button>
                    <button type="submit" name="add_page" class="btn btn-sm btn-primary">Add</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>

document.addEventListener('DOMContentLoaded', function() {
    // Toggle button fields visibility based on selection
    const contentTypeSelector = document.getElementById('content_type_selector');
    const buttonFields = document.getElementById('button_fields');
    
    if (contentTypeSelector && buttonFields) {
        contentTypeSelector.addEventListener('change', function() {
            buttonFields.style.display = this.value === 'button' ? 'block' : 'none';
        });
    }
});
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    // Remember open accordion items
    const openAccordions = JSON.parse(localStorage.getItem('openTelegramAccordions') || '[]');
    
    // Apply saved state
    openAccordions.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.classList.add('show');
            
            // Update the corresponding button
            const button = document.querySelector(`[data-bs-target="#${id}"]`);
            if (button) button.classList.remove('collapsed');
        }
    });
    
    // Save state when accordions are toggled
    document.querySelectorAll('.accordion-collapse').forEach(item => {
        item.addEventListener('shown.bs.collapse', function() {
            const currentOpen = JSON.parse(localStorage.getItem('openTelegramAccordions') || '[]');
            if (!currentOpen.includes(this.id)) {
                currentOpen.push(this.id);
                localStorage.setItem('openTelegramAccordions', JSON.stringify(currentOpen));
            }
        });
        
        item.addEventListener('hidden.bs.collapse', function() {
            const currentOpen = JSON.parse(localStorage.getItem('openTelegramAccordions') || '[]');
            const updatedOpen = currentOpen.filter(id => id !== this.id);
            localStorage.setItem('openTelegramAccordions', JSON.stringify(updatedOpen));
        });
    });
});
// Global variables to remember selection
let lastSelectedField = null;
let lastSelectionStart = null;
let lastSelectionEnd = null;
let lastSelection = "";

// Add event listeners to all text inputs and textareas
document.addEventListener("DOMContentLoaded", function() {
    const textFields = document.querySelectorAll('input[type="text"], textarea');
    textFields.forEach(field => {
        field.addEventListener('mouseup', saveSelection);
        field.addEventListener('keyup', saveSelection);
        field.addEventListener('focus', saveSelection);
    });
    
    // Initialize formatting buttons
    initializeFormattingButtons();
});

// Save the current selection
function saveSelection() {
    const field = this || document.activeElement;
    
    if (field && (field.tagName === 'TEXTAREA' || (field.tagName === 'INPUT' && field.type === 'text'))) {
        lastSelectedField = field;
        lastSelectionStart = field.selectionStart;
        lastSelectionEnd = field.selectionEnd;
        lastSelection = field.value.substring(lastSelectionStart, lastSelectionEnd);
    }
}

// Initialize all formatting buttons
function initializeFormattingButtons() {
    const formatButtons = document.querySelectorAll('[onclick^="applyFormatting"]');
    formatButtons.forEach(button => {
        // Extract the format string from the onclick attribute
        const onclickAttr = button.getAttribute('onclick');
        const formatMatch = onclickAttr.match(/applyFormatting\('(.+?)'\)/);
        if (formatMatch && formatMatch[1]) {
            const format = formatMatch[1].replace(/\\n/g, '\n'); // Handle newlines
            
            // Replace the onclick with our enhanced version
            button.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation(); // Prevent event bubbling
                applyFormatting(format);
                return false; // Prevent default behavior
            };
        }
    });
}

// This function properly applies the different markdown formats
function applyFormatting(format) {
    let field = document.activeElement;
    let useLastSelection = false;
    
    // Check if current element is editable
    if (!(field && 
        (field.tagName === 'TEXTAREA' || 
         (field.tagName === 'INPUT' && field.type === 'text') ||
         field.isContentEditable))) {
        
        // If no active editable element, check if we have a saved selection
        if (lastSelectedField && lastSelection) {
            field = lastSelectedField;
            useLastSelection = true;
        } else {
            // No suitable field found, copy to clipboard
            navigator.clipboard.writeText(format);
            showCopyAlert('Format copied to clipboard');
            return;
        }
    }
    
    if (field) {
        // Element is editable
        let start, end, selection, formattedText;
        
        if (useLastSelection) {
            // Use the saved selection
            field.focus();
            start = lastSelectionStart;
            end = lastSelectionEnd;
            selection = lastSelection;
            
            // Restore the selection
            field.setSelectionRange(start, end);
        } else {
            // Use current selection
            start = field.selectionStart;
            end = field.selectionEnd;
            selection = field.value.substring(start, end);
        }
        
        if (selection) {
            // Apply formatting to selected text based on the format type
            if (format.includes('```')) {
                // Code block
                formattedText = '```\n' + selection + '\n```';
            } else if (format === '*Bold text*') {
                // Bold
                formattedText = '*' + selection + '*';
            } else if (format === '_Italic text_') {
                // Italic
                formattedText = '_' + selection + '_';
            } else if (format === '__Underlined text__') {
                // Underline
                formattedText = '__' + selection + '__';
            } else if (format === '~Strikethrough~') {
                // Strikethrough
                formattedText = '~' + selection + '~';
            } else if (format === '`Code`') {
                // Inline code
                formattedText = '`' + selection + '`';
            } else if (format === '[Link text](URL)') {
                // Link
                formattedText = '[' + selection + '](https://)';
            } else if (format === '||Spoiler text||') {
                // Spoiler
                formattedText = '||' + selection + '||';
            } else {
                // Generic fallback
                formattedText = format.replace(/text|Code block/g, selection);
            }
            
            // Replace the selected text with the formatted text
            field.setRangeText(formattedText, start, end);
            
            // Set cursor position after the formatted text
            field.selectionStart = start + formattedText.length;
            field.selectionEnd = start + formattedText.length;
            
            // Show visual feedback
            const originalBg = field.style.backgroundColor;
            field.style.backgroundColor = '#f0f8ff'; // Light blue flash
            setTimeout(() => {
                field.style.backgroundColor = originalBg;
            }, 200);
            
            // Clear the saved selection after using it
            if (useLastSelection) {
                lastSelection = "";
                lastSelectionStart = null;
                lastSelectionEnd = null;
            }
        } else {
            // No selection, just insert the format template at cursor position
            field.setRangeText(format, start, end, 'end');
        }
        
        // Focus back on the field
        field.focus();
    }
}

function showCopyAlert(message) {
    // Create alert element
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    
    // Set content
    alertDiv.innerHTML = message + 
        '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
    
    // Add to document
    document.body.appendChild(alertDiv);
    
    // Remove after 3 seconds
    setTimeout(() => {
        alertDiv.classList.remove('show');
        setTimeout(() => alertDiv.remove(), 150);
    }, 3000);
}
</script>
  <!-- Custom Script -->
  <script>
document.addEventListener("DOMContentLoaded", function() {
    // Initialize search functionality
    initContentSearch();
    
    // Initialize page jump dropdown
    initPageJump();
});

function initContentSearch() {
    const searchInput = document.getElementById('content-search');
    const searchResults = document.getElementById('search-results');
    
    // Get all accordion items for searching
    const accordionItems = document.querySelectorAll('.accordion-item');
    
    // Add event listener for search input
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        
        if (searchTerm.length < 2) {
            searchResults.classList.add('d-none');
            // Reset visibility of all accordion items when search is cleared
            accordionItems.forEach(item => {
                item.style.display = '';
            });
            return;
        }
        
        let results = [];
        
        // Search through pages
        accordionItems.forEach(item => {
            const pageTitle = item.querySelector('.accordion-header .badge').textContent;
            const pageContent = item.textContent;
            
            if (pageTitle.toLowerCase().includes(searchTerm) || pageContent.toLowerCase().includes(searchTerm)) {
                results.push({
                    title: pageTitle,
                    element: item
                });
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
        
        // Display search results for quick navigation
        if (results.length > 0) {
            searchResults.innerHTML = results.map(result => 
                `<div class="py-2 px-3 cursor-pointer search-result-item hover-bg-light-primary" 
                     data-page="${result.title}">
                    <div class="d-flex align-items-center">
                        <span class="bullet bullet-dot bg-primary me-2"></span>
                        ${result.title}
                    </div>
                </div>`
            ).join('');
            
            searchResults.classList.remove('d-none');
            
            // Add click event to search results
            document.querySelectorAll('.search-result-item').forEach(item => {
                item.addEventListener('click', function() {
                    const pageName = this.getAttribute('data-page');
                    scrollToPage(pageName);
                    searchResults.classList.add('d-none');
                });
            });
        } else {
            searchResults.innerHTML = '<div class="py-2 px-3 text-muted">No pages found</div>';
            searchResults.classList.remove('d-none');
        }
    });
    
    // Close search results when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.classList.add('d-none');
        }
    });
    
    // Close search results on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            searchResults.classList.add('d-none');
        }
    });
}

function initPageJump() {
    const pageJump = document.getElementById('page-jump');
    const accordionItems = document.querySelectorAll('.accordion-item');
    
    // Populate dropdown with all pages
    accordionItems.forEach(item => {
        const pageTitle = item.querySelector('.accordion-header .badge').textContent;
        const option = document.createElement('option');
        option.value = pageTitle;
        option.textContent = pageTitle;
        pageJump.appendChild(option);
    });
    
    // Initialize Select2 for enhanced dropdown
    $(pageJump).select2({
        minimumResultsForSearch: 5,
        dropdownParent: $(pageJump).parent()
    });
    
    // Add change event to jump to selected page
    $(pageJump).on('change', function() {
        const selectedPage = $(this).val();
        if (selectedPage) {
            scrollToPage(selectedPage);
            $(this).val('').trigger('change.select2');
        }
    });
}

function scrollToPage(pageName) {
    const accordionItems = document.querySelectorAll('.accordion-item');
    
    for (let item of accordionItems) {
        const itemTitle = item.querySelector('.accordion-header .badge').textContent;
        
        if (itemTitle === pageName) {
            // Open the accordion
            const collapseElement = item.querySelector('.accordion-collapse');
            const bsCollapse = new bootstrap.Collapse(collapseElement, { toggle: true });
            
            // Smooth scroll to the element
            item.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Highlight the header briefly
            const header = item.querySelector('.accordion-header');
            header.classList.add('bg-light-primary');
            
            // Remove highlight after a delay
            setTimeout(() => {
                header.classList.remove('bg-light-primary');
            }, 2000);
            
            break;
        }
    }
}
</script>
<style>
.accordion-item {
    border: 1px solid var(--kt-border-color);
    overflow: hidden;
}

.accordion-button {
    padding: 0.75rem 1rem;
    background-color: var(--kt-card-cap-bg);
}

.accordion-button:not(.collapsed) {
    color: var(--kt-primary);
    background-color: var(--kt-light-primary);
    box-shadow: none;
}

.accordion-button:focus {
    box-shadow: none;
    border-color: var(--kt-border-color);
}




/* Remove default accordion bottom border */
.accordion-item:not(:first-of-type) {
    border-top: 1px solid var(--kt-border-color);
}

/* Adjust spacing between items */
.accordion-item + .accordion-item {
    margin-top: 1rem;
}

/* Improve search result item styling */
.search-result-item {
    transition: background-color 0.2s;
    cursor: pointer;
}

.search-result-item:hover {
    background-color: var(--kt-gray-100);
}
</style>
  <script>
    // Helper function to convert PascalCase to kebab-case
    function toKebabCase(str) {
      return str.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
    }

function addField(page) {
    const container = document.querySelector(`#fields_${page} .row`);
    const fieldName = prompt('Enter field name (lowercase letters, numbers and underscore only):');
    
    if (!fieldName) return;
    
    if (!/^[a-z0-9_]+$/.test(fieldName)) {
        alert('Field name can only contain lowercase letters, numbers and underscore');
        return;
    }

    const commonFields = ['icon', 'menu', 'loading_text', 'header', 'sub_text', 'details', 'content', 'footer_text'];
    
    // Prevent adding transaction_title as an additional field for _logs pages
    if (page.endsWith('_logs') && fieldName === 'transaction_title') {
        alert('Transaction Title is already a standard field for log pages.');
        return;
    }
    
    if (commonFields.includes(fieldName)) {
        alert('This is a common field. Please use a different name.');
        return;
    }

    const existingFields = container.querySelectorAll('[data-field]');
    for (let field of existingFields) {
        if (field.dataset.field === fieldName) {
            alert('This field already exists!');
            return;
        }
    }

    const div = document.createElement('div');
    div.className = 'col-md-4';
    div.setAttribute('data-field', fieldName);
    div.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-1">
            <label class="form-label text-gray-600 fs-7 mb-0">${fieldName}</label>
            <button type="button" class="btn btn-sm btn-icon btn-light-danger p-0 w-20px h-20px" onclick="removeField(this)">
                <i class="ki-duotone ki-cross fs-6">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
            </button>
        </div>
        <input type="text" name="content[${fieldName}]" class="form-control form-control-sm">
    `;

    container.appendChild(div);
}

function removeField(button) {
    if (confirm('Are you sure you want to remove this field?')) {
        button.closest('[data-field]').remove();
    }
}
</script>
<?
}
if ($_GET['page'] == 'telegram_manager')
{ ?>
                 
<?php

if (isset($_POST['submit'])) {


if (isset($_POST['telegram']['welcome_image'])) {
    if (empty($_POST['telegram']['welcome_image'])) {
        $telegram_settings['welcome_image'] = '';
    } else {
        $telegram_settings['welcome_image'] = htmlspecialchars($_POST['telegram']['welcome_image']);
    }
}
if (isset($_POST['telegram']['welcome_image_start'])) {
    if (empty($_POST['telegram']['welcome_image_start'])) {
        $telegram_settings['welcome_image_start'] = '';
    } else {
        $telegram_settings['welcome_image_start'] = htmlspecialchars($_POST['telegram']['welcome_image_start']);
    }
}
foreach ($_POST['telegram'] as $key => $value) {
    $_POST['telegram'][$key] = cleanContent($value);
}

$telegram = json_encode($_POST['telegram'], JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);
$telegram = mysqli_real_escape_string($DB_CONN, $telegram);
    $update_telegram = mysqli_query($DB_CONN, "UPDATE preferences SET telegram_settings = '{$telegram}' LIMIT 1");
    if ($update_telegram) {
        updateSiteData($siteURL);
        echo '<br><div class="alert alert-success">
        Updated Successfully!
        </div>';
    } else {
        echo '<br><div class="alert alert-danger">
        Failed to update preferences. Please try again.
        </div>';
    }
}
    $pref = mysqli_query($DB_CONN, "select * from preferences where id='1' limit 1") or die(mysqli_error($DB_CONN));
    $pre = mysqli_fetch_assoc($pref);
    $telegram_settings = json_decode($pre['telegram_settings'], true);
    
  
?> 
                                     <form method="POST" action="" enctype="multipart/form-data">
    <div class="card mb-5 mb-xl-10">
        <div class="card-body">  
                                         <div class="row">
                                           <div class="col-md-2">
                                            <label class="fs-9">  Channel  ID </label>
                                            </div>
                                            <div class="col-md-10">
                                            <input style="border: 1px solid lightgrey" type="text" placeholder="Enter Telegram  Channel  ID" name="telegram[channel_id]" value="<?=$telegram_settings['channel_id'] ?>" class="form-control form-control-sm">
                                            <small class="fs-9"> Add your <a  href="https://t.me/<?=$telegram_settings['username'] ?>" target="_blank">@<?=$telegram_settings['username'] ?></a> Bot to your Channel as Admin. and Enter /getid to get the Channel Chat ID</small>
                                            </div> 
                                                       <div class="separator separator-dashed my-2"></div>
                                                <div class="col-md-2">
                                            <label class="fs-9"> Group Chat ID </label>
                                            </div>
                                            <div class="col-md-10">
                                            <input style="border: 1px solid lightgrey" type="text" placeholder="Enter Telegram Group  ID" name="telegram[group_id]" value="<?=$telegram_settings['group_id'] ?>" class="form-control form-control-sm">
                                            <small class="fs-9">Add your<a  href="https://t.me/<?=$telegram_settings['username'] ?>" target="_blank">@<?=$telegram_settings['username'] ?></a> BOT to your Group as Admin. and Enter /getid to get the Channel Chat ID</small>
                                            </div> 
                                                        <div class="separator separator-dashed my-2"></div>
                                                <div class="col-md-2">
                                            <label class="fs-9"> Personal User ID </label>
                                            </div>
                                            <div class="col-md-10">
                                            <input style="border: 1px solid lightgrey" type="text" placeholder="Enter Telegram Group  ID" name="telegram[personal_id]" value="<?=$telegram_settings['personal_id'] ?>" class="form-control form-control-sm">
                                             <small class="fs-9">Start your <a  href="https://t.me/<?=$telegram_settings['username'] ?>" target="_blank">@<?=$telegram_settings['username'] ?></a>  Enter /getid to get the Chat ID</small>
                                            </div> 
                                                         <div class="separator separator-dashed my-2"></div>
<div class="col-md-2">
    <label class="fs-9">Mini App Link</label>
</div>
<div class="col-md-10">
    <div class="row g-3">
        <div class="col-md-6">
            <input style="border: 1px solid lightgrey" type="text" 
                placeholder="https://t.me/yourBot/" 
                name="telegram[mini_app_link]" 
                value="<?=$telegram_settings['mini_app_link'] ?>" 
                class="form-control form-control-sm">
        </div>
        <div class="col-md-3">
            <select name="telegram[mini_app_link_start]" 
                class="form-select form-select-sm" 
                style="border: 1px solid lightgrey">
                <option value="start" <?php echo ($telegram_settings['mini_app_link_start'] == 'start') ? 'selected' : ''; ?>>
                    start
                </option>
                <option value="startapp" <?php echo ($telegram_settings['mini_app_link_start'] == 'startapp') ? 'selected' : ''; ?>>
                    startapp
                </option>
            </select>
        </div>
        <div class="col-md-3">
            <select name="telegram[mini_app_link_type]" 
                class="form-select form-select-sm" 
                style="border: 1px solid lightgrey">
               
                <option value="userID" <?php echo ($telegram_settings['mini_app_link_type'] == 'userID') ? 'selected' : ''; ?>>
                    Telegram ID
                </option>
            </select>
        </div>
    </div>
    <small class="fs-9">Enter the Telegram game link. go to @botfather enter /newapp select this bot, Enter Title of the Mini App, Enter Short Description, Upload a 640x360 Photo, Enter App Url <b><?=$siteURL?></b> and enter the app name and copy the app url telegram give your and post here.</small>

                                           
                                            </div> 
                                            </div>
                                              </div> 
                                            </div>
                                            
                                            
                                             <div class="separator separator-dashed my-2"></div>
                                            <div class="row">
                                                  
                                                <div class="col-md-6">
                                                    <div class="card mb-5 ">
        <div class="card-body">  
                                                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Telegram Bot  </a>
          <div class="d-flex flex-stack">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Subscribe our Channel to Start Bot App</a>
            <div class="fs-9 fw-semibold text-gray-500">Enable to follow channel before getting the start message with apps message.</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <div class="form-check form-check-solid form-check-custom form-switch">
            <input class="form-check-input w-45px h-30px" type="checkbox" name="telegram[verify]" id="verify" value="true" <?= $telegram_settings['verify'] == 'true' ? 'checked' : '' ?>>
            <label class="form-check-label fs-9" for="verify"></label>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
    const verifyCheckbox = document.getElementById('verify');
    const verifyStartDiv = document.getElementById('verify_start');

    // Toggle display based on the checkbox's checked state
    const toggleVerifyStart = () => verifyStartDiv.style.display = verifyCheckbox.checked ? 'block' : 'none';

    // Initial check and event listener
    toggleVerifyStart();
    verifyCheckbox.addEventListener('change', toggleVerifyStart);
});
</script>
<div id="verify_start" <?= $telegram_settings['verify'] == 'true' ? 'style="display:block;"' : 'style="display:none;"' ?>>
        <div class="separator separator-dashed my-2"></div>
        <div class="row">
            <div class="col-md-3">
                <label class="fs-9">Text to be shown to Join Channel</label>
            </div>
            <div class="col-md-9">
                <textarea type="text" name="telegram[verify_text]" class="form-control form-control-sm" ><?= $telegram_settings['verify_text'] ?? 'You have not subscribed to our channel yet, subscribe:
https://t.me/bitders
and then click Verify to continue.'; ?> </textarea>
                <label class="form-check-label fs-9" for="verify_text">Don't forget to mention the same channel you used for Channel ID</label>
            </div>
       
        </div>
         <div class="separator separator-dashed my-2"></div>
          <div class="row">
            <div class="col-md-3">
                <label class="fs-9">Text to be Shown on Verify Button</label>
            </div>
            <div class="col-md-9">
                <textarea type="text" name="telegram[verify_text_button]" class="form-control form-control-sm" ><?= $telegram_settings['verify_text_button'] ?? 'Verify'; ?> </textarea>
                <label class="form-check-label fs-9" for="verify_text">Don't forget to mention the same channel you used for Channel ID</label>
            </div>
       
        </div>
  
    <div class="separator separator-dashed my-2"></div>
        <div class="row">
            <div class="col-md-3">
                <label class="fs-9">Text to be shown If Not joined Channel </label>
            </div>
            <div class="col-md-9">
                <textarea type="text" name="telegram[verify_text_not]" class="form-control form-control-sm" ><?= $telegram_settings['verify_text_not'] ?? 'You have not subscribed. Please subscribe to continue.'; ?> </textarea>
                <label class="form-check-label fs-9" for="verify_text">Don't forget to mention the same channel you used for Channel ID</label>
            </div>
       
        </div>
    </div>
    </div>
    </div>  
    <div class="card mb-5 ">
    <div class="card-body">  
        <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Telegram Bot</a>
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Join Our Chat Group to Start Bot App</a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable to join chat group before getting the start message with apps message.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="telegram[verify_chat]" id="verify_chat" value="true" <?= $telegram_settings['verify_chat'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="verify_chat"></label>
                </div>
            </div>
        </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const verifyCheckbox = document.getElementById('verify_chat');
        const verifyStartDiv = document.getElementById('verify_start_chat');
        const toggleVerifyStart = () => verifyStartDiv.style.display = verifyCheckbox.checked ? 'block' : 'none';
        toggleVerifyStart();
        verifyCheckbox.addEventListener('change', toggleVerifyStart);
    });
</script>

<div id="verify_start_chat" <?= $telegram_settings['verify_chat'] == 'true' ? 'style="display:block;"' : 'style="display:none;"' ?>>
        <div class="separator separator-dashed my-2"></div>
        <div class="row">
            <div class="col-md-3">
                <label class="fs-9">Text to be shown to Join Chat Group</label>
            </div>
            <div class="col-md-9">
                <textarea type="text" name="telegram[verify_text_chat]" class="form-control form-control-sm" ><?= $telegram_settings['verify_text_chat'] ?? 'You have not joined our chat group yet, join:
https://t.me/bitders
and then click Verify to continue.'; ?> </textarea>
                <label class="form-check-label fs-9" for="verify_text_chat">Don't forget to mention the same group you used for Chat Group ID</label>
            </div>
        </div>
        <div class="separator separator-dashed my-2"></div>
        <div class="row">
            <div class="col-md-3">
                <label class="fs-9">Text to be Shown on Verify Button</label>
            </div>
            <div class="col-md-9">
                <textarea type="text" name="telegram[verify_text_button_chat]" class="form-control form-control-sm" ><?= $telegram_settings['verify_text_button_chat'] ?? 'Verify'; ?> </textarea>
                <label class="form-check-label fs-9" for="verify_text_button_chat">Don't forget to mention the same group you used for Chat Group ID</label>
            </div>
        </div>
        <div class="separator separator-dashed my-2"></div>
        <div class="row">
            <div class="col-md-3">
                <label class="fs-9">Text to be shown If Not joined Chat Group</label>
            </div>
            <div class="col-md-9">
                <textarea type="text" name="telegram[verify_text_not_chat]" class="form-control form-control-sm" ><?= $telegram_settings['verify_text_not_chat'] ?? 'You have not joined. Please join to continue.'; ?> </textarea>
                <label class="form-check-label fs-9" for="verify_text_not_chat">Don't forget to mention the same group you used for Chat Group ID</label>
            </div>
        </div>
    </div>
    </div>
</div>
                                                    
    
  <div class="card mb-5 ">
        <div class="card-body">  
        <div class="d-flex flex-stack">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Setup MenuButton for Bot</a>
            <div class="fs-9 fw-semibold text-gray-500">Enable to set Menu Button for Bot.</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <div class="form-check form-check-solid form-check-custom form-switch">
            <input class="form-check-input w-45px h-30px" type="checkbox" name="telegram[menu_button]" id="menu_button" value="true" <?= $telegram_settings['menu_button'] == 'true' ? 'checked' : '' ?>>
            <label class="form-check-label fs-9" for="menu_button"></label>
        </div>
    </div>
</div>


  <script>
    document.addEventListener('DOMContentLoaded', () => {
    const verifyCheckbox = document.getElementById('menu_button');
    const verifyStartDiv = document.getElementById('menu_button_div');

    // Toggle display based on the checkbox's checked state
    const toggleVerifyStart = () => verifyStartDiv.style.display = verifyCheckbox.checked ? 'block' : 'none';

    // Initial check and event listener
    toggleVerifyStart();
    verifyCheckbox.addEventListener('change', toggleVerifyStart);
});
</script>

  
    <div id="menu_button_div" <?= $telegram_settings['menu_button'] == 'true' ? 'style="display:block;"' : 'style="display:none;"' ?>>
        <div class="separator separator-dashed my-2"></div>
        <div class="row">
            <div class="col-md-3">
                <label class="fs-9">Menu Button Text</label>
            </div>
            <div class="col-md-9">
                <input type="text" name="telegram[menu_button_text]" class="form-control form-control-sm" value="<?= $telegram_settings['menu_button_text'] ?? 'Start App'; ?>">
                <label class="form-check-label fs-9" for="menu_button_text">Title for Mini App Start Button </label>
            </div>
            
             <div class="col-md-3">
                <label class="fs-9">Menu Button Link</label>
            </div>
            <div class="col-md-9">
             
               <input type="text" 
       name="telegram[menu_button_link]" 
       class="form-control form-control-sm" 
       value="<?php echo isset($telegram_settings['menu_button_link']) && !empty($telegram_settings['menu_button_link']) ? $telegram_settings['menu_button_link'] : $siteURL; ?>">
                <label class="form-check-label fs-9" for="menu_button_link">Title for Mini App Start Button </label>
            </div>
       
        </div>
        <div class="separator separator-dashed my-2"></div>

         <div class="d-flex flex-stack">
        <div class="d-flex">
            <div class="d-flex flex-column">
                <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Use Verification to show menu button</a>
                <div class="fs-9 fw-semibold text-gray-500">Enable to show button to users who have verified subscribe to your channel.</div>
            </div>
        </div>
        <div class="d-flex justify-content-end">
            <div class="form-check form-check-solid form-check-custom form-switch">
                <input class="form-check-input w-45px h-30px" type="checkbox" name="telegram[menu_button_verify]" id="mini_app_start" value="true" <?= $telegram_settings['menu_button_verify'] == 'true' ? 'checked' : '' ?>>
                <label class="form-check-label fs-9" for="menu_button_verify"></label>
            </div>
        </div>
    </div>
    </div>

 



    </div>
    </div>  
    
  <div class="card mb-5 ">
        <div class="card-body">  
<div class="row">
<div class="col-md-4">
    <div class="form-group">
        <label class="fs-9">Welcome Message for /Start</label>
    </div>
</div>
<div class="col-md-8">
    <textarea name="telegram[welcome_start]" class="form-control form-control-sm"><?=$telegram_settings['welcome_start'] ?></textarea>
    <small id="Help_start" class="form-text text-muted fs-9">Available ShortCodes - #username#,#first_name#,#last_name#</small>
</div>
</div>
<div class="separator separator-dashed my-2"></div>

<div class="d-flex flex-stack">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Use Buttons with /Start Message</a>
            <div class="fs-9 fw-semibold text-gray-500">Enable to use buttons with /Start message.</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <div class="form-check form-check-solid form-check-custom form-switch">
            <input class="form-check-input w-45px h-30px" type="checkbox" name="telegram[use_buttons_start]" id="use_buttons_start" value="true" <?= $telegram_settings['use_buttons_start'] == 'true' ? 'checked' : '' ?>>
            <label class="form-check-label fs-9" for="use_buttons_start"></label>
        </div>
    </div>
</div>

<div id="buttons_start" <?= $telegram_settings['use_buttons_start'] == 'true' ? 'style="display:block;"' : 'style="display:none;"' ?>>
    <div class="separator separator-dashed my-2"></div>
    <div class="d-flex flex-stack">
        <div class="d-flex">
            <div class="d-flex flex-column">
                <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Use Telegram Mini App /Start</a>
                <div class="fs-9 fw-semibold text-gray-500">Enable to use telegram Mini App.</div>
            </div>
        </div>
        <div class="d-flex justify-content-end">
            <div class="form-check form-check-solid form-check-custom form-switch">
                <input class="form-check-input w-45px h-30px" type="checkbox" name="telegram[mini_app_start]" id="mini_app_start" value="true" <?= $telegram_settings['mini_app_start'] == 'true' ? 'checked' : '' ?>>
                <label class="form-check-label fs-9" for="mini_app_start"></label>
            </div>
        </div>
    </div>
    <div id="mini_start" <?= $telegram_settings['mini_app_start'] == 'true' ? 'style="display:block;"' : 'style="display:none;"' ?>>
        <div class="separator separator-dashed my-2"></div>
        <div class="row">
            <div class="col-md-3">
                <label class="fs-9">Mini App Start Button Title</label>
            </div>
            <div class="col-md-9">
                <input type="text" name="telegram[mini_app_private_start]" class="form-control form-control-sm" value="<?= $telegram_settings['mini_app_private_start'] ?? 'Start'; ?>">
                <label class="form-check-label fs-9" for="memo_start">Title for Mini App Start Button </label>
            </div>
       
        </div>
    </div>
    <div class="separator separator-dashed my-2"></div>
    <?php if (isset($telegram_settings['buttons_start'])): ?>
        <?php foreach ($telegram_settings['buttons_start'] as $index_start => $button): ?>
            <div class="button-container">
                <div class="row">
                    <div class="col-md-3">
                        <input type="text" class="form-control form-control-sm" name="telegram[buttons_start][<?= $index_start ?>][name]" placeholder="Button Name" value="<?= $button['name'] ?>">
                    </div>
                    <div class="col-md-2">
                        <select class="form-select form-select-sm" name="telegram[buttons_start][<?= $index_start ?>][type]">
                            <option value="url" <?= $button['type'] == 'url' ? 'selected' : '' ?>>URL</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control form-control-sm" name="telegram[buttons_start][<?= $index_start ?>][action]" placeholder="Button Action" value="<?= $button['action'] ?>">
                    </div>
                    <div class="col-md-2">
                        <select class="form-select form-select-sm" name="telegram[buttons_start][<?= $index_start ?>][line]">
                            <option value="separate" <?= $button['line'] == 'separate' ? 'selected' : '' ?>>Separate Row</option>
                            <option value="same" <?= $button['line'] == 'same' ? 'selected' : '' ?>>Same Row</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-sm btn-primary remove-button-start py-0" onclick="removeButtonStart(this)">x</button>
                    </div>
                </div>
            </div>
        <?php endforeach; ?>
    <?php endif; ?>
</div>
<div class="separator separator-dashed my-2"></div>
<button type="button" id="add_button_start" class="btn btn-sm btn-primary add_another_start py-0" onclick="addButtonStart()" <?= $telegram_settings['use_buttons_start'] == 'true' ? 'style="display:block;"' : 'style="display:none;"' ?>>+</button>
<div class="separator separator-dashed my-2"></div>

<div class="d-flex flex-stack">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Use Image with /Start Message</a>
            <div class="fs-9 fw-semibold text-gray-500">Enable to use image in the group welcome messages.</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <div class="form-check form-check-solid form-check-custom form-switch">
            <input class="form-check-input w-45px h-30px" type="checkbox" name="telegram[use_image_start]" id="use_image_start" value="true" <?= $telegram_settings['use_image_start'] == 'true' ? 'checked' : '' ?>>
            <label class="form-check-label fs-9" for="use_image_start"></label>
        </div>
    </div>
</div>

<div id="image_start" <?= $telegram_settings['use_image_start'] == 'true' ? 'style="display:block;"' : 'style="display:none;"' ?>>
    <div class="separator separator-dashed my-2"></div>
    <div class="col-md-8">
        <div class="text-center">
            <div class="image-input image-input-outline" data-kt-image-input="true">
                <div class="image-input-wrapper w-350px h-150px" id="welcome-image-start-preview"
                    style="background-image: url('<?= !empty($telegram_settings['welcome_image_start']) ? htmlspecialchars($telegram_settings['welcome_image_start']) : 'bitders/assets/placeholder.svg' ?>')">
                </div>
                <label class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                       data-kt-image-input-action="change" data-bs-toggle="modal" data-bs-target="#kt_modal_100">
                    <i class="ki-duotone ki-pencil fs-7"><span class="path1"></span><span class="path2"></span></i>
                </label>
                <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                      data-kt-image-input-action="cancel" data-bs-toggle="tooltip" title="Cancel">
                    <i class="ki-outline ki-cross fs-2"></i>
                </span>
                <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                      data-kt-image-input-action="remove" data-bs-toggle="tooltip" title="Remove">
                    <i class="ki-outline ki-cross fs-2"></i>
                </span>
            </div>
            <div class="text-muted fs-7 mt-2">Upload an image to be sent to new users when they /Start.</div>
            <input type="hidden" id="welcome-image-start-url" name="telegram[welcome_image_start]" 
                   value="<?= !empty($telegram_settings['welcome_image_start']) ? htmlspecialchars($telegram_settings['welcome_image_start']) : '' ?>" 
                   data-original-value="<?= !empty($telegram_settings['welcome_image_start']) ? htmlspecialchars($telegram_settings['welcome_image_start']) : '' ?>">
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {


    let buttonCountStart = <?= isset($telegram_settings['buttons_start']) ? count($telegram_settings['buttons_start']) : 0 ?>;

    window.addButtonStart = function() {
        const buttonsDivStart = document.getElementById('buttons_start');
        if (!buttonsDivStart) return;

        const newButtonStart = document.createElement('div');
        newButtonStart.className = 'button-container';
        newButtonStart.innerHTML = `
            <div class="row">
                <div class="col-md-3">
                    <input type="text" class="form-control form-control-sm" name="telegram[buttons_start][${buttonCountStart}][name]" placeholder="Button Name">
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm" name="telegram[buttons_start][${buttonCountStart}][type]">
                        <option value="url">URL</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control form-control-sm" name="telegram[buttons_start][${buttonCountStart}][action]" placeholder="Button Action">
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm" name="telegram[buttons_start][${buttonCountStart}][line]">
                        <option value="separate">Separate Row</option>
                        <option value="same">Same Row</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-sm btn-primary remove-button-start py-0" onclick="removeButtonStart(this)">x</button>
                </div>
            </div>`;
        buttonsDivStart.appendChild(newButtonStart);
        buttonCountStart++;
    }

    window.removeButtonStart = function(element) {
        element.closest('.button-container').remove();
    }

    const useButtonsStart = document.getElementById('use_buttons_start');
    if (useButtonsStart) {
        useButtonsStart.addEventListener('change', function() {
            const buttonsDivStart = document.getElementById('buttons_start');
            const addButtonDivStart = document.getElementById('add_button_start');
            const displayStateStart = this.checked ? 'block' : 'none';
            if (buttonsDivStart) buttonsDivStart.style.display = displayStateStart;
            if (addButtonDivStart) addButtonDivStart.style.display = displayStateStart;
        });
    }

    const miniAppStart = document.getElementById('mini_app_start');
    if (miniAppStart) {
        miniAppStart.addEventListener('change', function() {
            const miniDivStart = document.getElementById('mini_start');
            if (miniDivStart) miniDivStart.style.display = this.checked ? 'block' : 'none';
        });
    }

    const useImageStart = document.getElementById('use_image_start');
    if (useImageStart) {
        useImageStart.addEventListener('change', function() {
            const imageDivStart = document.getElementById('image_start');
            if (imageDivStart) imageDivStart.style.display = this.checked ? 'block' : 'none';
        });
    }
});
</script>

</div>
    </div>  
 <div class="card mb-5">
    <div class="card-body">
        <!-- Main Bot Enable Switch -->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable TelegramBOT for Users</a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable Telegram bot functionality for your users.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="telegram[telegrambot]" id="telegrambot" value="true" <?=$telegram_settings['telegrambot'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="telegrambot"></label>
                </div>
            </div>
        </div>

        <!-- Keyboard Type Selection -->
        <div class="keyboard-settings mt-5" id="keyboardSettings" style="display: none;">
<div class="d-flex flex-stack flex-grow-1">
                <!--begin::Content-->
                <div class="fw-semibold">
                    <div class="fs-8 text-gray-700">To Set Telegram Bot Content  <a href="admin?page=telegram_bot" class="fw-bold">Click here</a></div>
                </div>


            </div>
            <div class="separator separator-dashed my-2"></div>
<div class="row">
    <div class="col-md-2">
        <label class="fs-9">Default Columns for User Keyboard</label>
    </div>
    <div class="col-md-10">
        <input type="text" name="telegram[user_key_col]" class="form-control form-control-sm" value="<?=$telegram_settings['user_key_col'] ?? '2'?>">
        <label class="form-check-label fs-9" for="memo">For user keyboard you can define the number of columns</label>
    </div>
    <div class="separator separator-dashed my-2"></div>
    
    <div class="col-md-2">
        <label class="fs-9">Danger Alert Prefix</label>
    </div>
    <div class="col-md-10">
        <input type="text" name="telegram[danger_call_alert]" class="form-control form-control-sm" value="<?=$telegram_settings['danger_call_alert'] ?? '❌ '?>">
        <label class="form-check-label fs-9" for="memo">Custom prefix for danger alerts (default: ❌)</label>
    </div>
    <div class="separator separator-dashed my-2"></div>
    
    <div class="col-md-2">
        <label class="fs-9">Warning Alert Prefix</label>
    </div>
    <div class="col-md-10">
        <input type="text" name="telegram[warning_call_alert]" class="form-control form-control-sm" value="<?=$telegram_settings['warning_call_alert'] ?? '⚠️ '?>">
        <label class="form-check-label fs-9" for="memo">Custom prefix for warning alerts (default: ⚠️)</label>
    </div>
    <div class="separator separator-dashed my-2"></div>
    
    <div class="col-md-2">
        <label class="fs-9">Success Alert Prefix</label>
    </div>
    <div class="col-md-10">
        <input type="text" name="telegram[success_call_alert]" class="form-control form-control-sm" value="<?=$telegram_settings['success_call_alert'] ?? '✅ '?>">
        <label class="form-check-label fs-9" for="memo">Custom prefix for success alerts (default: ✅)</label>
    </div>
    <div class="separator separator-dashed my-2"></div>
    
    <div class="col-md-2">
        <label class="fs-9">Info Alert Prefix</label>
    </div>
    <div class="col-md-10">
        <input type="text" name="telegram[info_call_alert]" class="form-control form-control-sm" value="<?=$telegram_settings['info_call_alert'] ?? 'ℹ️ '?>">
        <label class="form-check-label fs-9" for="memo">Custom prefix for info alerts (default: ℹ️)</label>
    </div>
</div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const telegrambotSwitch = document.getElementById('telegrambot');
    const keyboardSettings = document.getElementById('keyboardSettings');

    // Initial state check
    keyboardSettings.style.display = telegrambotSwitch.checked ? 'block' : 'none';

    // Toggle keyboard settings visibility
    telegrambotSwitch.addEventListener('change', function() {
        keyboardSettings.style.display = this.checked ? 'block' : 'none';
    });
});
</script>

<div class="card mb-5 ">
    <div class="card-body">
        <div class="row">
            <div class="d-flex flex-stack">
                <div class="d-flex">
                    <div class="d-flex flex-column">
                        <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Notification for Users</a>
                        <div class="fs-9 fw-semibold text-gray-500">Enable Telegram bot Notification for your users.</div>
                    </div>
                </div>
                <div class="d-flex justify-content-end">
                    <div class="form-check form-check-solid form-check-custom form-switch">
                        <input class="form-check-input w-45px h-30px notification-toggle" type="checkbox" 
                               name="telegram[notify_user]" id="notify_user" value="true" 
                               <?php echo $telegram_settings['notify_user'] == 'true' ? 'checked' : ''; ?>>
                        <label class="form-check-label fs-9" for="notify_user"></label>
                    </div>
                </div>
            </div>

            <div class="user-notification-content" style="display: <?php echo $telegram_settings['notify_user'] == 'true' ? 'block' : 'none'; ?>">
                
                <div class="separator separator-dashed my-2"></div>
                <!-- Investment Alert Section -->
                 <div class="d-flex flex-stack">
                <div class="d-flex">
                    <div class="d-flex flex-column">
                        <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Send Notification only </a>
                        <div class="fs-9 fw-semibold text-gray-500">Enable Telegram bot to send Notification for your users.</div>
                    </div>
                </div>
                <div class="d-flex justify-content-end">
                    <div class="form-check form-check-solid form-check-custom form-switch">
                        <input class="form-check-input w-45px h-30px notification-toggle" type="checkbox" 
                               name="telegram[notify_user_notification]" id="notify_user_notification" value="true" 
                               <?php echo $telegram_settings['notify_user_notification'] == 'true' ? 'checked' : ''; ?>>
                        <label class="form-check-label fs-9" for="notify_user_notification"></label>
                    </div>
                </div>
            </div>

                <div class="separator separator-dashed my-2"></div>
                <!-- Withdrawal Alert Section -->
             <div class="d-flex flex-stack">
                <div class="d-flex">
                    <div class="d-flex flex-column">
                        <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Send Full Email/Telegram Alerts to Users</a>
                        <div class="fs-9 fw-semibold text-gray-500">Enable to Send Full Email/Telegram Alerts to Users.</div>
                    </div>
                </div>
                <div class="d-flex justify-content-end">
                    <div class="form-check form-check-solid form-check-custom form-switch">
                        <input class="form-check-input w-45px h-30px notification-toggle" type="checkbox" 
                               name="telegram[notify_user_full]" id="notify_user_full" value="true" 
                               <?php echo $telegram_settings['notify_user_full'] == 'true' ? 'checked' : ''; ?>>
                        <label class="form-check-label fs-9" for="notify_user_full"></label>
                    </div>
                </div>
            </div>
                 <div class="separator separator-dashed my-2"></div>
                <!-- Withdrawal Alert Section -->
             <div class="d-flex flex-stack">
                <div class="d-flex">
                    <div class="d-flex flex-column">
                        <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Dismiss Button with alerts and notification</a>
                        <div class="fs-9 fw-semibold text-gray-500">Enable to have dismiss button along notification or alert .</div>
                    </div>
                </div>
                <div class="d-flex justify-content-end">
                    <div class="form-check form-check-solid form-check-custom form-switch">
                        <input class="form-check-input w-45px h-30px notification-toggle" type="checkbox" 
                               name="telegram[notify_user_dismiss]" id="notify_user_dismiss" value="true" 
                               <?php echo $telegram_settings['notify_user_dismiss'] == 'true' ? 'checked' : ''; ?>>
                        <label class="form-check-label fs-9" for="notify_user_dismiss"></label>
                    </div>
                </div>
            </div>
                   <div class="separator separator-dashed my-2"></div>
                <!-- Withdrawal Alert Section -->
             <div class="d-flex flex-stack">
                <div class="d-flex">
                    <div class="d-flex flex-column">
                        <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Share Button with alerts and notification</a>
                        <div class="fs-9 fw-semibold text-gray-500">Enable to have Share button along notification or alert .</div>
                    </div>
                </div>
                <div class="d-flex justify-content-end">
                    <div class="form-check form-check-solid form-check-custom form-switch">
                        <input class="form-check-input w-45px h-30px notification-toggle" type="checkbox" 
                               name="telegram[notify_user_share]" id="notify_user_share" value="true" 
                               <?php echo $telegram_settings['notify_user_share'] == 'true' ? 'checked' : ''; ?>>
                        <label class="form-check-label fs-9" for="notify_user_share"></label>
                    </div>
                </div>
            </div>
          <div class="separator separator-dashed my-2"></div>
<div class="d-flex flex-stack">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Web App Button for User Notifications</a>
            <div class="fs-9 fw-semibold text-gray-500">Enable to display WebApp button on user notifications.</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <div class="form-check form-check-solid form-check-custom form-switch">
            <input class="form-check-input w-45px h-30px notification-toggle" type="checkbox" 
                   name="telegram[show_webapp_button_user]" id="show_webapp_button_user" value="true" 
                   <?php echo $telegram_settings['show_webapp_button_user'] == 'true' ? 'checked' : ''; ?>>
            <label class="form-check-label fs-9" for="show_webapp_button_user"></label>
        </div>
    </div>
</div>

<!-- User WebApp Button Text (conditional) -->
<div class="d-flex flex-stack mt-2 ms-4 webapp-button-text-user" style="<?php echo $telegram_settings['show_webapp_button_user'] != 'true' ? 'display: none !important;' : ''; ?>">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a class="fs-8 text-gray-900 text-hover-primary fw-bold">User WebApp Button Text</a>
            <div class="fs-9 fw-semibold text-gray-500">Custom text for the WebApp button on user notifications.</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <input type="text" class="form-control form-control-sm" name="telegram[webapp_button_text_user]" 
               value="<?php echo isset($telegram_settings['webapp_button_text_user']) ? htmlspecialchars($telegram_settings['webapp_button_text_user']) : 'WebApp'; ?>">
    </div>
</div>

            </div>
        </div>
    </div>
</div>

<!-- Admin Notifications Card -->
<div class="card mb-5">
    <div class="card-body">
        <div class="row">
            <div class="d-flex flex-stack">
                <div class="d-flex">
                    <div class="d-flex flex-column">
                        <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Notification for Admin</a>
                        <div class="fs-9 fw-semibold text-gray-500">Enable Telegram bot Notification for administrators.</div>
                    </div>
                </div>
                <div class="d-flex justify-content-end">
                    <div class="form-check form-check-solid form-check-custom form-switch">
                        <input class="form-check-input w-45px h-30px notification-toggle" type="checkbox" 
                               name="telegram[notify_admin]" id="notify_admin" value="true" 
                               <?php echo $telegram_settings['notify_admin'] == 'true' ? 'checked' : ''; ?>>
                        <label class="form-check-label fs-9" for="notify_admin"></label>
                    </div>
                </div>
            </div>

            <div class="admin-notification-content" style="display: <?php echo $telegram_settings['notify_admin'] == 'true' ? 'block' : 'none'; ?>">

                <div class="separator separator-dashed my-2"></div>
                <!-- Admin Investment Alert Section -->
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Investment Activation Alert for admin</label>
                    </div>
                </div>
                <div class="col-md-12">
                    <textarea name="telegram[invest_admin]" class="form-control form-control-sm"><?php echo $telegram_settings['invest_admin'] ?: 'Dear Admin,

New investment received:
User: #name# (#username#)
Plan: #plan#
Amount: #amount#
Currency: #method#
Transaction: #batch#
DateTime: #date#

#app_url#?startpp=#telegram_id#'; ?></textarea>
                    <small class="fs-9">Universal Shortcodes: #name# - #username# - #telegram_id# - #site_name# - #app_url# - #currency# - #symbol#<br>
                        Available Shortcodes (This template): #amount# - #method# - #plan# - #date# - #batch# - #compound#</small>
                </div>

                <div class="separator separator-dashed my-2"></div>
                <!-- Admin Withdrawal Alert Section -->
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Withdrawal Alert for admin</label>
                    </div>
                </div>
                <div class="col-md-12">
                    <textarea name="telegram[withdraw_admin]" class="form-control form-control-sm"><?php echo $telegram_settings['withdraw_admin'] ?: 'Dear Admin,

New withdrawal request:
User: #name# (#username#)
Amount: #amount# #method#
Wallet: #wallet#
Transaction ID: #batch#
DateTime: #date#

#app_url#?startpp=#telegram_id#'; ?></textarea>
                    <small class="fs-9">Universal Shortcodes: #name# - #username# - #telegram_id# - #site_name# - #app_url# - #currency# - #symbol#<br>
                        Available Shortcodes (This template): #amount# - #method# - #wallet# - #date# - #batch# - #tx_url#</small>
                </div>
<!-- Admin WebApp Button Settings -->
<div class="separator separator-dashed my-2"></div>
<div class="d-flex flex-stack">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Web App Button for Admin Notifications</a>
            <div class="fs-9 fw-semibold text-gray-500">Enable to display WebApp button on admin notifications.</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <div class="form-check form-check-solid form-check-custom form-switch">
            <input class="form-check-input w-45px h-30px notification-toggle" type="checkbox" 
                   name="telegram[show_webapp_button_admin]" id="show_webapp_button_admin" value="true" 
                   <?php echo $telegram_settings['show_webapp_button_admin'] == 'true' ? 'checked' : ''; ?>>
            <label class="form-check-label fs-9" for="show_webapp_button_admin"></label>
        </div>
    </div>
</div>

<!-- Admin WebApp Button Text (conditional) -->
<div class="d-flex flex-stack mt-2 ms-4 webapp-button-text-admin" style="<?php echo $telegram_settings['show_webapp_button_admin'] != 'true' ? 'display: none !important;' : ''; ?>">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Admin WebApp Button Text</a>
            <div class="fs-9 fw-semibold text-gray-500">Custom text for the WebApp button on admin notifications.</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <input type="text" class="form-control form-control-sm" name="telegram[webapp_button_text_admin]" 
               value="<?php echo isset($telegram_settings['webapp_button_text_admin']) ? htmlspecialchars($telegram_settings['webapp_button_text_admin']) : 'WebApp'; ?>">
    </div>
</div>


            </div>
        </div>
    </div>
</div>

<!-- Channel/Group Notifications Card -->
<div class="card mb-5">
    <div class="card-body">
        <div class="row">
            <!-- Channel Toggle -->
            <div class="d-flex flex-stack">
                <div class="d-flex">
                    <div class="d-flex flex-column">
                        <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Notification for Channel</a>
                        <div class="fs-9 fw-semibold text-gray-500">Enable Telegram bot Notification for your Channel.</div>
                    </div>
                </div>
                <div class="d-flex justify-content-end">
                    <div class="form-check form-check-solid form-check-custom form-switch">
                        <input class="form-check-input w-45px h-30px notification-toggle" type="checkbox" 
                               name="telegram[notify_channel]" id="notify_channel" value="true" 
                               <?php echo $telegram_settings['notify_channel'] == 'true' ? 'checked' : ''; ?>>
                        <label class="form-check-label fs-9" for="notify_channel"></label>
                    </div>
                </div>
            </div>

            <div class="separator separator-dashed my-2"></div>

            <!-- Group Toggle -->
            <div class="d-flex flex-stack">
                <div class="d-flex">
                    <div class="d-flex flex-column">
                        <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Notification for Group</a>
                        <div class="fs-9 fw-semibold text-gray-500">Enable Telegram bot Notification for your Group.</div>
                    </div>
                </div>
                <div class="d-flex justify-content-end">
                    <div class="form-check form-check-solid form-check-custom form-switch">
                        <input class="form-check-input w-45px h-30px notification-toggle" type="checkbox" 
                               name="telegram[notify_group]" id="notify_group" value="true" 
                               <?php echo $telegram_settings['notify_group'] == 'true' ? 'checked' : ''; ?>>
                        <label class="form-check-label fs-9" for="notify_group"></label>
                    </div>
                </div>
            </div>

            <div class="channel-group-notification-content" style="display: <?php echo ($telegram_settings['notify_channel'] == 'true' || $telegram_settings['notify_group'] == 'true') ? 'block' : 'none'; ?>">
                <div class="separator separator-dashed my-2"></div>
                <!-- Channel/Group Investment Alert Section -->
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Investment Activation Alert for Channel/Group</label>
                    </div>
                </div>
                <div class="col-md-12">
                    <textarea name="telegram[invest_channel]" class="form-control form-control-sm"><?php echo $telegram_settings['invest_channel'] ?: '🎉 New Investment Alert!

User #name# has invested:
📊 Plan: #plan#
💰 Amount: #amount#
💱 Currency: #method#
🔖 Transaction: #batch#
📅 DateTime: #date#

#app_url#'; ?></textarea>
                    <small class="fs-9">Universal Shortcodes: #name# - #username# - #telegram_id# - #site_name# - #app_url# - #currency# - #symbol#<br>
                        Available Shortcodes (This template): #amount# - #method# - #plan# - #date# - #batch# - #compound#</small>
                </div>

                <div class="separator separator-dashed my-2"></div>
                <!-- Channel/Group Withdrawal Alert Section -->
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Withdrawal Alert for Channel/Group</label>
                    </div>
                </div>
                <div class="col-md-12">
                    <textarea name="telegram[withdraw_channel]" class="form-control form-control-sm"><?php echo $telegram_settings['withdraw_channel'] ?: '💫 New Withdrawal Processed!

User #name# has withdrawn:
💰 Amount: #amount# #method#
🏦 Wallet: #wallet#
🔖 Transaction ID: #batch#
📅 DateTime: #date#

#app_url#'; ?></textarea>
                    <small class="fs-9">Universal Shortcodes: #name# - #username# - #telegram_id# - #site_name# - #app_url# - #currency# - #symbol#<br>
                        Available Shortcodes (This template): #amount# - #method# - #wallet# - #date# - #batch# - #tx_url#</small>
                </div>
                <!-- Channel WebApp Button Settings -->
<div class="separator separator-dashed my-2"></div>
<div class="d-flex flex-stack">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Web App Button for Channel Notifications</a>
            <div class="fs-9 fw-semibold text-gray-500">Enable to display WebApp button on channel notifications.</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <div class="form-check form-check-solid form-check-custom form-switch">
            <input class="form-check-input w-45px h-30px notification-toggle" type="checkbox" 
                   name="telegram[show_webapp_button_channel]" id="show_webapp_button_channel" value="true" 
                   <?php echo $telegram_settings['show_webapp_button_channel'] == 'true' ? 'checked' : ''; ?>>
            <label class="form-check-label fs-9" for="show_webapp_button_channel"></label>
        </div>
    </div>
</div>

<!-- Channel WebApp Button Text (conditional) -->
<div class="d-flex flex-stack mt-2 ms-4 webapp-button-text-channel" style="<?php echo $telegram_settings['show_webapp_button_channel'] != 'true' ? 'display: none !important;' : ''; ?>">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Channel WebApp Button Text</a>
            <div class="fs-9 fw-semibold text-gray-500">Custom text for the WebApp button on channel notifications.</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <input type="text" class="form-control form-control-sm" name="telegram[webapp_button_text_channel]" 
               value="<?php echo isset($telegram_settings['webapp_button_text_channel']) ? htmlspecialchars($telegram_settings['webapp_button_text_channel']) : 'WebApp'; ?>">
    </div>
</div>
<!-- Group WebApp Button Settings -->
<div class="separator separator-dashed my-2"></div>
<div class="d-flex flex-stack">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Web App Button for Group Notifications</a>
            <div class="fs-9 fw-semibold text-gray-500">Enable to display WebApp button on group notifications.</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <div class="form-check form-check-solid form-check-custom form-switch">
            <input class="form-check-input w-45px h-30px notification-toggle" type="checkbox" 
                   name="telegram[show_webapp_button_group]" id="show_webapp_button_group" value="true" 
                   <?php echo $telegram_settings['show_webapp_button_group'] == 'true' ? 'checked' : ''; ?>>
            <label class="form-check-label fs-9" for="show_webapp_button_group"></label>
        </div>
    </div>
</div>

<!-- Group WebApp Button Text (conditional) -->
<div class="d-flex flex-stack mt-2 ms-4 webapp-button-text-group" style="<?php echo $telegram_settings['show_webapp_button_group'] != 'true' ? 'display: none !important; ' : ''; ?>">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Group WebApp Button Text</a>
            <div class="fs-9 fw-semibold text-gray-500">Custom text for the WebApp button on group notifications.</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <input type="text" class="form-control form-control-sm" name="telegram[webapp_button_text_group]" 
               value="<?php echo isset($telegram_settings['webapp_button_text_group']) ? htmlspecialchars($telegram_settings['webapp_button_text_group']) : 'WebApp'; ?>">
    </div>
</div>

            </div>
        </div>
    </div>
</div>


<script>
// JavaScript to toggle visibility of text fields based on checkbox state
document.addEventListener('DOMContentLoaded', function() {
    // Function to handle toggle visibility with !important
    function toggleVisibility(element, isVisible) {
        if (isVisible) {
            element.style.setProperty('display', 'flex', 'important');
        } else {
            element.style.setProperty('display', 'none', 'important');
        }
    }
    
    // Initialize all toggle fields
    function initializeToggles() {
        // User WebApp button
        const userToggle = document.getElementById('show_webapp_button_user');
        const userTextField = document.querySelector('.webapp-button-text-user');
        if (userToggle && userTextField) {
            toggleVisibility(userTextField, userToggle.checked);
            userToggle.addEventListener('change', function() {
                toggleVisibility(userTextField, this.checked);
            });
        }
        
        // Admin WebApp button
        const adminToggle = document.getElementById('show_webapp_button_admin');
        const adminTextField = document.querySelector('.webapp-button-text-admin');
        if (adminToggle && adminTextField) {
            toggleVisibility(adminTextField, adminToggle.checked);
            adminToggle.addEventListener('change', function() {
                toggleVisibility(adminTextField, this.checked);
            });
        }
        
        // Channel WebApp button
        const channelToggle = document.getElementById('show_webapp_button_channel');
        const channelTextField = document.querySelector('.webapp-button-text-channel');
        if (channelToggle && channelTextField) {
            toggleVisibility(channelTextField, channelToggle.checked);
            channelToggle.addEventListener('change', function() {
                toggleVisibility(channelTextField, this.checked);
            });
        }
        
        // Group WebApp button
        const groupToggle = document.getElementById('show_webapp_button_group');
        const groupTextField = document.querySelector('.webapp-button-text-group');
        if (groupToggle && groupTextField) {
            toggleVisibility(groupTextField, groupToggle.checked);
            groupToggle.addEventListener('change', function() {
                toggleVisibility(groupTextField, this.checked);
            });
        }
    }
    
    // Call initialization function
    initializeToggles();
});
document.addEventListener('DOMContentLoaded', function() {
    const toggles = document.querySelectorAll('.notification-toggle');
    
    toggles.forEach(toggle => {
        toggle.addEventListener('change', function() {
            const id = this.id;
            let contentSection;
            
            // Handle different content sections
            if (id === 'notify_user') {
                contentSection = document.querySelector('.user-notification-content');
            } else if (id === 'notify_admin') {
                contentSection = document.querySelector('.admin-notification-content');
            } else if (id === 'notify_channel' || id === 'notify_group') {
                contentSection = document.querySelector('.channel-group-notification-content');
                // Special handling for channel/group section
                const otherToggle = id === 'notify_channel' ? 
                    document.getElementById('notify_group') : 
                    document.getElementById('notify_channel');
                
                // Show content if either channel or group is enabled
                if (contentSection) {
                    contentSection.style.display = (this.checked || otherToggle.checked) ? 'block' : 'none';
                }
                return; // Exit early for channel/group toggles
            }
            
            // Handle user and admin sections
            if (contentSection) {
                contentSection.style.display = this.checked ? 'block' : 'none';
            }
        });
    });
});
</script>
                                                           
                                            </div>
                                                            
                                                <div class="col-md-6">
                                                     <div class="card mb-5">
        <div class="card-body">  
           <div class="row">
                                                      <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Telegram Group / Channel</a>
                                                    
                                                     
      
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="fs-9"> Welcome Message for Newly Users Joined</label>
                    </div>
                </div>
             <div class="col-md-9">
                 <textarea  name="telegram[welcome]" class="form-control form-control-sm"><?=$telegram_settings['welcome'] ?></textarea> 
                 <small id="Help" class="form-text text-muted fs-9">Available ShortCodes - #username#,#first_name#,#last_name#,#group_name#</small>
                 </div>
                  <div class="separator separator-dashed my-2"></div>
                
<div class="d-flex flex-stack">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Use Buttons with Welcome Message</a>
            <div class="fs-9 fw-semibold text-gray-500">Enable to Remove User joined the group messages.</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <div class="form-check form-check-solid form-check-custom form-switch">
            <input class="form-check-input w-45px h-30px" type="checkbox" name="telegram[use_buttons]" id="use_buttons" value="true" <?= $telegram_settings['use_buttons'] == 'true' ? 'checked' : '' ?>>
            <label class="form-check-label fs-9" for="use_buttons"></label>
        </div>
    </div>
</div>

<div id="buttons" <?= $telegram_settings['use_buttons'] == 'true' ? 'style="display:block;"' : 'style="display:none;"' ?>>
    <div class="separator separator-dashed my-2"></div>
    <div class="d-flex flex-stack">
        <div class="d-flex">
            <div class="d-flex flex-column">
                <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Use Telegram Mini App</a>
                <div class="fs-9 fw-semibold text-gray-500">Enable to use telegram Min App.</div>
            </div>
        </div>
        <div class="d-flex justify-content-end">
            <div class="form-check form-check-solid form-check-custom form-switch">
                <input class="form-check-input w-45px h-30px" type="checkbox" name="telegram[mini_app]" id="mini_app" value="true" <?= $telegram_settings['mini_app'] == 'true' ? 'checked' : '' ?>>
                <label class="form-check-label fs-9" for="mini_app"></label>
            </div>
        </div>
    </div>
    <div id="mini" <?= $telegram_settings['mini_app'] == 'true' ? 'style="display:block;"' : 'style="display:none;"' ?>>
        <div class="separator separator-dashed my-2"></div>
        <div class="row">
            <div class="col-md-3">
                <label class="fs-9">Mini App Start Button Title</label>
            </div>
            <div class="col-md-9">
                <input type="text" name="telegram[mini_app_group]" class="form-control form-control-sm" value="<?= $telegram_settings['mini_app_group'] ?? 'Open App'; ?>">
                <label class="form-check-label fs-9" for="memo">Title for Mini App Start Button (For Group)</label>
            </div>
        </div>
    </div>
    <div class="separator separator-dashed my-2"></div>
    <?php if (isset($telegram_settings['buttons'])): ?>
        <?php foreach ($telegram_settings['buttons'] as $index => $button): ?>
            <div class="button-container">
                <div class="row">
                    <div class="col-md-3">
                        <input type="text" class="form-control form-control-sm" name="telegram[buttons][<?= $index ?>][name]" placeholder="Button Name" value="<?= $button['name'] ?>">
                    </div>
                    <div class="col-md-2">
                        <select class="form-select form-select-sm" name="telegram[buttons][<?= $index ?>][type]">
                            <option value="url" <?= $button['type'] == 'url' ? 'selected' : '' ?>>URL</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control form-control-sm" name="telegram[buttons][<?= $index ?>][action]" placeholder="Button Action" value="<?= $button['action'] ?>">
                    </div>
                    <div class="col-md-2">
                        <select class="form-select form-select-sm" name="telegram[buttons][<?= $index ?>][line]">
                            <option value="separate" <?= $button['line'] == 'separate' ? 'selected' : '' ?>>Separate Row</option>
                            <option value="same" <?= $button['line'] == 'same' ? 'selected' : '' ?>>Same Row</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-sm btn-primary remove-button py-0" onclick="removeButton(this)">x</button>
                    </div>
                </div>
            </div>
        <?php endforeach; ?>
    <?php endif; ?>
</div>
<div class="separator separator-dashed my-2"></div>
<button type="button" id="add_button" class="btn btn-sm btn-primary add_another py-0" <?= $telegram_settings['use_buttons'] == 'true' ? 'style="display:block;"' : 'style="display:none;"' ?>>+</button>
<div class="separator separator-dashed my-2"></div>

<div class="d-flex flex-stack">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Use Image with Welcome Message</a>
            <div class="fs-9 fw-semibold text-gray-500">Enable to use image in the group welcome messages.</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <div class="form-check form-check-solid form-check-custom form-switch">
            <input class="form-check-input w-45px h-30px" type="checkbox" name="telegram[use_image]" id="use_image" value="true" <?= $telegram_settings['use_image'] == 'true' ? 'checked' : '' ?>>
            <label class="form-check-label fs-9" for="use_image"></label>
        </div>
    </div>
</div>

<div id="image" <?= $telegram_settings['use_image'] == 'true' ? 'style="display:block;"' : 'style="display:none;"' ?>>
    <div class="separator separator-dashed my-2"></div>
    <div class="col-md-8">
        <div class="text-center">
            <div class="image-input image-input-outline" data-kt-image-input="true">
                <div class="image-input-wrapper w-350px h-150px" id="welcome-image-preview"
                    style="background-image: url('<?= !empty($telegram_settings['welcome_image']) ? htmlspecialchars($telegram_settings['welcome_image']) : 'bitders/assets/placeholder.svg' ?>')">
                </div>
                <label class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                       data-kt-image-input-action="change" data-bs-toggle="modal" data-bs-target="#kt_modal_100">
                    <i class="ki-duotone ki-pencil fs-7"><span class="path1"></span><span class="path2"></span></i>
                </label>
                <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                      data-kt-image-input-action="cancel" data-bs-toggle="tooltip" title="Cancel">
                    <i class="ki-outline ki-cross fs-2"></i>
                </span>
                <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                      data-kt-image-input-action="remove" data-bs-toggle="tooltip" title="Remove">
                    <i class="ki-outline ki-cross fs-2"></i>
                </span>
            </div>
            <div class="text-muted fs-7 mt-2">Upload an image to be sent to new users when they /Start.</div>
            <input type="hidden" id="welcome-image-start-url" name="telegram[welcome_image]" 
                   value="<?= !empty($telegram_settings['welcome_image']) ? htmlspecialchars($telegram_settings['welcome_image']) : '' ?>" 
                   data-original-value="<?= !empty($telegram_settings['welcome_image']) ? htmlspecialchars($telegram_settings['welcome_image']) : '' ?>">
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        let buttonCount = <?= isset($telegram_settings['buttons']) ? count($telegram_settings['buttons']) : 0 ?>;

        window.addButton = function() {
            const buttonsDiv = document.getElementById('buttons');
            const newButton = document.createElement('div');
            newButton.className = 'button-container';
            newButton.innerHTML = `
                <div class="row">
                    <div class="col-md-3">
                        <input type="text" class="form-control form-control-sm" name="telegram[buttons][${buttonCount}][name]" placeholder="Button Name">
                    </div>
                    <div class="col-md-2">
                        <select class="form-select form-select-sm" name="telegram[buttons][${buttonCount}][type]">
                            <option value="url">URL</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control form-control-sm" name="telegram[buttons][${buttonCount}][action]" placeholder="Button Action">
                    </div>
                    <div class="col-md-2">
                        <select class="form-select form-select-sm" name="telegram[buttons][${buttonCount}][line]">
                            <option value="separate">Separate Row</option>
                            <option value="same">Same Row</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-sm btn-primary remove-button py-0" onclick="removeButton(this)">x</button>
                    </div>
                </div>
            `;
            buttonsDiv.appendChild(newButton);
            buttonCount++;
        }

        window.removeButton = function(element) {
            element.closest('.button-container').remove();
        }

        // Attach event listeners
        document.getElementById('add_button').addEventListener('click', addButton);

        document.getElementById('use_buttons').addEventListener('change', function() {
            const buttonsDiv = document.getElementById('buttons');
            const addButtonDiv = document.getElementById('add_button');
            const displayState = this.checked ? 'block' : 'none';
            buttonsDiv.style.display = displayState;
            addButtonDiv.style.display = displayState;
        });

        document.getElementById('mini_app').addEventListener('change', function() {
            const miniDiv = document.getElementById('mini');
            miniDiv.style.display = this.checked ? 'block' : 'none';
        });

        document.getElementById('use_image').addEventListener('change', function() {
            const imageDiv = document.getElementById('image');
            imageDiv.style.display = this.checked ? 'block' : 'none';
        });
    });
</script>

</div></div></div>
<div class="card mb-5">
        <div class="card-body">  
          <div class="row">
    <div class="separator separator-dashed my-2"></div>
    <div class="col-md-3">
    <div class="form-group">
        <label class="fs-9">Goodbye Message for Users Left</label>
    </div>
</div>
<div class="col-md-9">
    <textarea name="telegram[goodbye]" class="form-control form-control-sm"><?=$telegram_settings['goodbye'] ?></textarea>
    <small id="Help" class="form-text text-muted fs-9">Available ShortCodes - #username#,#first_name#,#last_name#,#group_name#</small>
</div>
<div class="separator separator-dashed my-2"></div>

<div class="d-flex flex-stack">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Use Buttons with Goodbye Message</a>
            <div class="fs-9 fw-semibold text-gray-500">Enable to show buttons when users leave the group.</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <div class="form-check form-check-solid form-check-custom form-switch">
            <input class="form-check-input w-45px h-30px" type="checkbox" name="telegram[use_goodbye_buttons]" id="use_goodbye_buttons" value="true" <?= $telegram_settings['use_goodbye_buttons'] == 'true' ? 'checked' : '' ?>>
            <label class="form-check-label fs-9" for="use_goodbye_buttons"></label>
        </div>
    </div>
</div>

<div id="goodbye_buttons" <?= $telegram_settings['use_goodbye_buttons'] == 'true' ? 'style="display:block;"' : 'style="display:none;"' ?>>
    <?php if (isset($telegram_settings['goodbye_buttons'])): ?>
        <?php foreach ($telegram_settings['goodbye_buttons'] as $index => $button): ?>
            <div class="button-container">
                <div class="row">
                    <div class="col-md-3">
                        <input type="text" class="form-control form-control-sm" name="telegram[goodbye_buttons][<?= $index ?>][name]" placeholder="Button Name" value="<?= $button['name'] ?>">
                    </div>
                    <div class="col-md-2">
                        <select class="form-select form-select-sm" name="telegram[goodbye_buttons][<?= $index ?>][type]">
                            <option value="url" <?= $button['type'] == 'url' ? 'selected' : '' ?>>URL</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control form-control-sm" name="telegram[goodbye_buttons][<?= $index ?>][action]" placeholder="Button Action" value="<?= $button['action'] ?>">
                    </div>
                    <div class="col-md-2">
                        <select class="form-select form-select-sm" name="telegram[goodbye_buttons][<?= $index ?>][line]">
                            <option value="separate" <?= $button['line'] == 'separate' ? 'selected' : '' ?>>Separate Row</option>
                            <option value="same" <?= $button['line'] == 'same' ? 'selected' : '' ?>>Same Row</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-sm btn-primary remove-button py-0" onclick="removeGoodbyeButton(this)">x</button>
                    </div>
                </div>
            </div>
        <?php endforeach; ?>
    <?php endif; ?>
</div>
<div class="separator separator-dashed my-2"></div>
<button type="button" id="add_goodbye_button" class="btn btn-sm btn-primary add_another py-0" <?= $telegram_settings['use_goodbye_buttons'] == 'true' ? 'style="display:block;"' : 'style="display:none;"' ?>>+</button>

<div class="separator separator-dashed my-2"></div>

<div class="d-flex flex-stack">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Use Image with Goodbye Message</a>
            <div class="fs-9 fw-semibold text-gray-500">Enable to use image in the group goodbye messages.</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <div class="form-check form-check-solid form-check-custom form-switch">
            <input class="form-check-input w-45px h-30px" type="checkbox" name="telegram[use_goodbye_image]" id="use_goodbye_image" value="true" <?= $telegram_settings['use_goodbye_image'] == 'true' ? 'checked' : '' ?>>
            <label class="form-check-label fs-9" for="use_goodbye_image"></label>
        </div>
    </div>
</div>

<div id="goodbye_image" <?= $telegram_settings['use_goodbye_image'] == 'true' ? 'style="display:block;"' : 'style="display:none;"' ?>>
    <div class="separator separator-dashed my-2"></div>
    <div class="col-md-8">
        <div class="text-center">
            <div class="image-input image-input-outline" data-kt-image-input="true">
                <div class="image-input-wrapper w-350px h-150px" id="goodbye-image-preview"
                    style="background-image: url('<?= !empty($telegram_settings['goodbye_image']) ? htmlspecialchars($telegram_settings['goodbye_image']) : 'bitders/assets/placeholder.svg' ?>')">
                </div>
                <label class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                       data-kt-image-input-action="change" data-bs-toggle="modal" data-bs-target="#kt_modal_100">
                    <i class="ki-duotone ki-pencil fs-7"><span class="path1"></span><span class="path2"></span></i>
                </label>
                <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                      data-kt-image-input-action="cancel" data-bs-toggle="tooltip" title="Cancel">
                    <i class="ki-outline ki-cross fs-2"></i>
                </span>
                <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                      data-kt-image-input-action="remove" data-bs-toggle="tooltip" title="Remove">
                    <i class="ki-outline ki-cross fs-2"></i>
                </span>
            </div>
            <div class="text-muted fs-7 mt-2">Upload an image to be sent when users leave the group.</div>
            <input type="hidden" id="goodbye-image-url" name="telegram[goodbye_image]" 
                   value="<?= !empty($telegram_settings['goodbye_image']) ? htmlspecialchars($telegram_settings['goodbye_image']) : '' ?>" 
                   data-original-value="<?= !empty($telegram_settings['goodbye_image']) ? htmlspecialchars($telegram_settings['goodbye_image']) : '' ?>">
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let goodbyeButtonCount = <?= isset($telegram_settings['goodbye_buttons']) ? count($telegram_settings['goodbye_buttons']) : 0 ?>;

    window.addGoodbyeButton = function() {
        const buttonsDiv = document.getElementById('goodbye_buttons');
        const newButton = document.createElement('div');
        newButton.className = 'button-container';
        newButton.innerHTML = `
            <div class="row">
                <div class="col-md-3">
                    <input type="text" class="form-control form-control-sm" name="telegram[goodbye_buttons][${goodbyeButtonCount}][name]" placeholder="Button Name">
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm" name="telegram[goodbye_buttons][${goodbyeButtonCount}][type]">
                        <option value="url">URL</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control form-control-sm" name="telegram[goodbye_buttons][${goodbyeButtonCount}][action]" placeholder="Button Action">
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm" name="telegram[goodbye_buttons][${goodbyeButtonCount}][line]">
                        <option value="separate">Separate Row</option>
                        <option value="same">Same Row</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-sm btn-primary remove-button py-0" onclick="removeGoodbyeButton(this)">x</button>
                </div>
            </div>
        `;
        buttonsDiv.appendChild(newButton);
        goodbyeButtonCount++;
    }

    window.removeGoodbyeButton = function(element) {
        element.closest('.button-container').remove();
    }

    document.getElementById('add_goodbye_button').addEventListener('click', addGoodbyeButton);

    document.getElementById('use_goodbye_buttons').addEventListener('change', function() {
        const buttonsDiv = document.getElementById('goodbye_buttons');
        const addButtonDiv = document.getElementById('add_goodbye_button');
        const displayState = this.checked ? 'block' : 'none';
        buttonsDiv.style.display = displayState;
        addButtonDiv.style.display = displayState;
    });

    document.getElementById('use_goodbye_image').addEventListener('change', function() {
        const imageDiv = document.getElementById('goodbye_image');
        imageDiv.style.display = this.checked ? 'block' : 'none';
    });
});
</script>

<div class="separator separator-dashed my-2"></div> 
</div></div></div>
<div class="card mb-5">
    <div class="card-body">  
        <div class="row">
            <div class="d-flex flex-stack">
                <div class="d-flex">
                    <div class="d-flex flex-column">
                        <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Bonus for Posting TXN/Batch in your telegram Group</a>
                        <div class="fs-9 fw-semibold text-gray-500">Enable to reward users for posting the batch.</div>
                    </div>
                </div>
                <div class="d-flex justify-content-end">
                    <div class="form-check form-check-solid form-check-custom form-switch">
                        <input class="form-check-input w-45px h-30px" type="checkbox" name="telegram[posting_txn]" id="posting_txn" value="true" <?=$telegram_settings['posting_txn'] == 'true' ? 'checked' : '' ?>>
                        <label class="form-check-label fs-9" for="posting_txn"></label>
                    </div>
                </div>
            </div>        
       
           
            
            <div id="posting" style="display: <?=$telegram_settings['posting_txn'] == 'true' ? 'block' : 'none' ?>;">
                 <div class="separator separator-dashed my-2"></div> 
                <div class="row mb-3">
    <div class="col-md-2">
        <label class="fs-9">Daily Limits</label>
    </div>
    <div class="col-md-10">
        <div class="input-group input-group-sm">
            <input type="number" name="telegram[posting_daily_limit]" class="form-control form-control-sm" value="<?=$telegram_settings['posting_daily_limit'] ?: '10'; ?>">
            <span class="input-group-text fs-9">rewards per user</span>
        </div>
        <small class="form-text text-muted fs-9">Maximum number of rewards a user can receive per day (0 for unlimited)</small>
    </div>
</div>
 <div class="separator separator-dashed my-2"></div> 
<div class="row mb-3">
    <div class="col-md-2">
        <label class="fs-9">Withdrawal Check Period</label>
    </div>
    <div class="col-md-10">
    <select class="form-select form-select-sm form-select-solid mb-2" name="telegram[withdrawal_check]">
        <option value="single" <?=$telegram_settings['withdrawal_check'] == 'single' || !isset($telegram_settings['withdrawal_check']) ? 'selected' : '' ?>>
            Check only posted withdrawal
        </option>
        <option value="today" <?=$telegram_settings['withdrawal_check'] == 'today' ? 'selected' : '' ?>>
            Check Withdrawals for same date.
        </option>
        <option value="all" <?=$telegram_settings['withdrawal_check'] == 'all' ? 'selected' : '' ?>>
            Check all withdrawals
        </option>
    </select>
</div>
</div>
 <div class="separator separator-dashed my-2"></div> 
<div class="row mb-3">
    <div class="col-md-2">
        <label class="fs-9">Minimum Withdrawal</label>
    </div>
    <div class="col-md-10">
        <div class="input-group input-group-sm">
            <input type="number" step="0.01" name="telegram[min_withdrawal_amount]" class="form-control form-control-sm" value="<?=$telegram_settings['min_withdrawal_amount'] ?: '0'; ?>">
            <span class="input-group-text fs-9">minimum amount</span>
        </div>
        <small class="form-text text-muted fs-9">Only reward proofs for withdrawals above this amount (0 for no minimum)</small>
    </div>
</div>
 <div class="separator separator-dashed my-2"></div> 
<div class="row mb-3">
    <div class="col-md-2">
        <label class="fs-9">Time Restrictions</label>
    </div>
    <div class="col-md-10">
        <div class="input-group input-group-sm">
            <input type="number" name="telegram[posting_time_delay]" class="form-control form-control-sm" value="<?=$telegram_settings['posting_time_delay'] ?: '0'; ?>">
            <span class="input-group-text fs-9">minutes delay</span>
        </div>
        <small class="form-text text-muted fs-9">Only reward proofs posted X minutes after withdrawal (0 for no delay)</small>
    </div>
</div>
 <div class="separator separator-dashed my-2"></div> 
<div class="row mb-3">
    <div class="col-md-2">
        <label class="fs-9">Random Bonus</label>
    </div>
    <div class="col-md-10">
   <div class="d-flex flex-stack">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Random Bonus Instead of Fixed</a>
            <div class="fs-9 fw-semibold text-gray-500">Enable to give random bonus with in the range</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <div class="form-check form-check-solid form-check-custom form-switch">
            <input class="form-check-input w-45px h-30px" type="checkbox" 
                   name="telegram[random_bonus]" id="random_bonus" 
                   value="true" <?=$telegram_settings['random_bonus'] == 'true' ? 'checked' : '' ?>>
            <label class="form-check-label fs-9" for="random_bonus"></label>
        </div>
    </div>
</div>
    
      
        <div id="random_bonus_settings" style="display: <?=$telegram_settings['random_bonus'] == 'true' ? 'block' : 'none' ?>;">
             <div class="separator separator-dashed my-2"></div> 
            <div class="input-group input-group-sm mb-2">
                <span class="input-group-text fs-9">Min</span>
                <input type="number" step="0.01" min="0.01" 
                       name="telegram[random_bonus_min]" 
                       class="form-control form-control-sm" 
                       value="<?=isset($telegram_settings['random_bonus_min']) ? floatval($telegram_settings['random_bonus_min']) : '0.1' ?>"
                       onchange="validateMinMax()">
                <span class="input-group-text fs-9">Max</span>
                <input type="number" step="0.01" min="0.01"
                       name="telegram[random_bonus_max]" 
                       class="form-control form-control-sm" 
                       value="<?=isset($telegram_settings['random_bonus_max']) ? floatval($telegram_settings['random_bonus_max']) : '1.0' ?>"
                       onchange="validateMinMax()">
            </div>
        </div>
    </div>
</div>
 <div class="separator separator-dashed my-2"></div> 

                <div class="row mb-3">
                    <div class="col-md-2">
                        <label class="fs-9">Fixed Bonus Amount</label>
                    </div>
                    <div class="col-md-10">
                        <input type="text" name="telegram[posting_txn_amount]" class="form-control form-control-sm" value="<?=$telegram_settings['posting_txn_amount'] ?: '0.1'; ?>">
                        <small class="form-text text-muted fs-9">Enter the Bonus amount you want to give for posting</small>
                    </div>
                </div>
 <div class="separator separator-dashed my-2"></div> 
<div class="d-flex flex-stack">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Use different currency for bonus</a>
            <div class="fs-9 fw-semibold text-gray-500">Enable to use a different currency for the bonus</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <div class="form-check form-check-solid form-check-custom form-switch">
            <input class="form-check-input w-45px h-30px" type="checkbox" 
                   name="telegram[use_different_currency]" id="use_different_currency" 
                   value="true" <?=$telegram_settings['use_different_currency'] == 'true' ? 'checked' : '' ?>>
            <label class="form-check-label fs-9" for="use_different_currency"></label>
        </div>
    </div>
</div>

<div class="row mb-3" id="currency_selector" style="display: <?=$telegram_settings['use_different_currency'] == 'true' ? 'block' : 'none' ?>;">
     <div class="separator separator-dashed my-2"></div>
    <div class="col-md-4">
        <div class="form-group">
            <label class="fs-9"> Bonus Currency: </label>
        </div>
    </div>
    <div class="col-md-8">
        <select class="form-select form-select-sm form-select-solid" name="telegram[posting_currency]" id="posting_currency" 
                <?=$telegram_settings['use_different_currency'] != 'true' ? 'disabled' : '' ?>>
            <?php 
            $select_method = mysqli_query($DB_CONN, "SELECT * from currencies where de_pm_id != 0");
            while ($row_method = mysqli_fetch_assoc($select_method)) { 
            ?>
                <option value="<?php echo $row_method['id'] ?>" 
                        <?=$telegram_settings['posting_currency'] == $row_method['id'] ? "selected" : "" ?>>
                    <?php echo $row_method['name'] ?>
                </option>
            <?php } ?>
        </select>
        <small class="form-text text-muted fs-9">Select currency for bonus payment</small>
    </div>
</div>



            <!-- Pattern Settings -->

 <div class="separator separator-dashed my-2"></div>
                   <div class="row mb-3">
        <div class="col-md-2">
            <label class="fs-9">Transaction Response Message</label>
        </div>
        <div class="col-md-10">
            <textarea name="telegram[posting_txn_reply]" class="form-control form-control-sm"><?=$telegram_settings['posting_txn_reply'] ?: '🎉 Congratulations! You earned a #amount# bonus for sharing your payment proof!'; ?></textarea>
            <small class="form-text text-muted fs-9">Available ShortCodes - #amount#, #txn#</small>
        </div>
    </div>

    <div class="separator separator-dashed my-2"></div>

    <div class="d-flex flex-stack">
        <div class="d-flex">
            <div class="d-flex flex-column">
                <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Use Image with Transaction Response</a>
                <div class="fs-9 fw-semibold text-gray-500">Enable to send an image with the transaction response message.</div>
            </div>
        </div>
        <div class="d-flex justify-content-end">
            <div class="form-check form-check-solid form-check-custom form-switch">
                <input class="form-check-input w-45px h-30px" type="checkbox" 
                       name="telegram[use_posting_txn_image]" id="use_posting_txn_image" 
                       value="true" <?=$telegram_settings['use_posting_txn_image'] == 'true' ? 'checked' : ''?>>
                <label class="form-check-label fs-9" for="use_posting_txn_image"></label>
            </div>
        </div>
    </div>

    <div id="posting_txn_image_section" style="display: <?=$telegram_settings['use_posting_txn_image'] == 'true' ? 'block' : 'none'?>;">
        <div class="separator separator-dashed my-2"></div>
        <div class="col-md-8">
            <div class="text-center">
                <div class="image-input image-input-outline" data-kt-image-input="true">
                    <div class="image-input-wrapper w-350px h-150px" id="posting-txn-image-preview"
                        style="background-image: url('<?=!empty($telegram_settings['posting_txn_image']) ? htmlspecialchars($telegram_settings['posting_txn_image']) : 'bitders/assets/placeholder.svg'?>')">
                    </div>
                    <label class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                           data-kt-image-input-action="change" data-bs-toggle="modal" data-bs-target="#kt_modal_100">
                        <i class="ki-duotone ki-pencil fs-7"><span class="path1"></span><span class="path2"></span></i>
                    </label>
                    <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                          data-kt-image-input-action="cancel" data-bs-toggle="tooltip" title="Cancel">
                        <i class="ki-outline ki-cross fs-2"></i>
                    </span>
                    <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                          data-kt-image-input-action="remove" data-bs-toggle="tooltip" title="Remove">
                        <i class="ki-outline ki-cross fs-2"></i>
                    </span>
                </div>
                <div class="text-muted fs-7 mt-2">Upload an image to be sent with transaction responses.</div>
                <input type="hidden" id="posting-txn-image-url" name="telegram[posting_txn_image]" 
                       value="<?=!empty($telegram_settings['posting_txn_image']) ? htmlspecialchars($telegram_settings['posting_txn_image']) : ''?>" 
                       data-original-value="<?=!empty($telegram_settings['posting_txn_image']) ? htmlspecialchars($telegram_settings['posting_txn_image']) : ''?>">
            </div>
        </div>
    </div>

    <div class="separator separator-dashed my-2"></div>
                 <div class="separator separator-dashed my-2"></div> 
                <div class="row mb-3">
    <div class="d-flex flex-stack">
        <div class="d-flex">
            <div class="d-flex flex-column">
                <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Show Buttons with Message</a>
                <div class="fs-9 fw-semibold text-gray-500">Enable to show buttons with the congratulation message</div>
            </div>
        </div>
        <div class="d-flex justify-content-end">
            <div class="form-check form-check-solid form-check-custom form-switch">
                <input class="form-check-input w-45px h-30px" type="checkbox" 
                       name="telegram[use_cong_buttons]" id="use_cong_buttons" 
                       value="true" <?=$telegram_settings['use_cong_buttons'] == 'true' ? 'checked' : '' ?>>
                <label class="form-check-label fs-9" for="use_cong_buttons"></label>
            </div>
        </div>
    </div>
    
    <div id="cong_buttons" style="display: <?=$telegram_settings['use_cong_buttons'] == 'true' ? 'block' : 'none' ?>;">
         <div class="separator separator-dashed my-2"></div>
        <div class="mt-3">
            <?php
            if(isset($telegram_settings['cong_buttons']) && is_array($telegram_settings['cong_buttons'])) {
                foreach($telegram_settings['cong_buttons'] as $key => $button) {
                    ?>
                    <div class="button-container mb-2">
                        <div class="row">
                            <div class="col-md-3">
                                <input type="text" class="form-control form-control-sm" 
                                       name="telegram[cong_buttons][<?=$key?>][text]" 
                                       value="<?=$button['text']?>" 
                                       placeholder="Button Text">
                            </div>
                            <div class="col-md-4">
                                <input type="text" class="form-control form-control-sm" 
                                       name="telegram[cong_buttons][<?=$key?>][url]" 
                                       value="<?=$button['url']?>" 
                                       placeholder="Button URL">
                                <small class="text-muted">Use #user_id# for dynamic user ID</small>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select form-select-sm" 
                                        name="telegram[cong_buttons][<?=$key?>][position]">
                                    <option value="new_row" <?=$button['position']=='new_row'?'selected':''?>>New Row</option>
                                    <option value="same_row" <?=$button['position']=='same_row'?'selected':''?>>Same Row</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-sm btn-danger remove-button" 
                                        onclick="removeCongButton(this)">×</button>
                            </div>
                        </div>
                    </div>
                    <?php
                }
            }
            ?>
        </div>
        <button type="button" id="add_cong_button" class="btn btn-sm btn-primary mt-2">
           +
        </button>
    </div>
     <div class="separator separator-dashed my-2"></div>
</div>


                <div class="row mb-3">
                    <div class="col-md-2">
                        <label class="fs-9">Posting TXN MEMO</label>
                    </div>
                    <div class="col-md-10">
                        <input type="text" name="telegram[posting_txn_memo]" class="form-control form-control-sm" value="<?=$telegram_settings['posting_txn_memo'] ?: 'Bonus #amount# for Posting #txn# in our TG'; ?>">
                        <small class="form-text text-muted fs-9">Available ShortCodes - #amount#, #txn#</small>
                    </div>
                </div>
            </div>
        </div>
        <script>
$(document).ready(function() {
    // Handle main toggle for posting TXN
    $('#posting_txn').change(function() {
        if($(this).is(':checked')) {
            $('#posting').slideDown();
        } else {
            $('#posting').slideUp();
        }
    });

    // Handle currency selector toggle
    $('#use_different_currency').change(function() {
        if($(this).is(':checked')) {
            $('#currency_selector').slideDown();
            $('#posting_currency').prop('disabled', false);
        } else {
            $('#currency_selector').slideUp();
            $('#posting_currency').prop('disabled', true);
        }
    });

    // Initialize currency selector state
    if(!$('#use_different_currency').is(':checked')) {
        $('#posting_currency').prop('disabled', true);
    }

    // Handle random bonus toggle
    $('input[name="telegram[random_bonus]"]').change(function() {
        if($(this).is(':checked')) {
            $('#random_bonus_settings').slideDown();
            validateMinMax();
        } else {
            $('#random_bonus_settings').slideUp();
        }
    });

    // Handle congratulation buttons toggle
    $('#use_cong_buttons').change(function() {
        $('#cong_buttons').slideToggle(this.checked);
    });

    // Handle custom patterns toggle
    $('#use_custom_patterns').change(function() {
        $('#patterns_input').slideToggle(this.checked);
    });
    
    // Handle custom domains toggle
    $('#use_custom_domains').change(function() {
        $('#domains_input').slideToggle(this.checked);
    });
      const usePostingTxnImage = document.getElementById('use_posting_txn_image');
    if (usePostingTxnImage) {
        usePostingTxnImage.addEventListener('change', function() {
            const imageSection = document.getElementById('posting_txn_image_section');
            if (imageSection) {
                imageSection.style.display = this.checked ? 'block' : 'none';
            }
        });
    }
    let congButtonCount = $('.button-container').length;
    
    window.addCongButton = function() {
        const buttonsDiv = document.querySelector('#cong_buttons .mt-3');
        const newButton = document.createElement('div');
        newButton.className = 'button-container mb-2';
        newButton.innerHTML = `
            <div class="row">
                <div class="col-md-3">
                    <input type="text" class="form-control form-control-sm" 
                           name="telegram[cong_buttons][${congButtonCount}][text]" 
                           placeholder="Button Text">
                </div>
                <div class="col-md-4">
                    <input type="text" class="form-control form-control-sm" 
                           name="telegram[cong_buttons][${congButtonCount}][url]" 
                           placeholder="Button URL">
                    <small class="text-muted">Use #user_id# for dynamic user ID</small>
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm" 
                            name="telegram[cong_buttons][${congButtonCount}][position]">
                        <option value="new_row">New Row</option>
                        <option value="same_row">Same Row</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-sm btn-danger remove-button" 
                            onclick="removeCongButton(this)">×</button>
                </div>
            </div>
        `;
        buttonsDiv.appendChild(newButton);
        congButtonCount++;
    }

    window.removeCongButton = function(element) {
        element.closest('.button-container').remove();
    }

    document.getElementById('add_cong_button').addEventListener('click', addCongButton);
});

function validateMinMax() {
    const minInput = $('input[name="telegram[random_bonus_min]"]');
    const maxInput = $('input[name="telegram[random_bonus_max]"]');
    const min = parseFloat(minInput.val()) || 0.1;
    const max = parseFloat(maxInput.val()) || 1.0;
    
    if(min < 0.01) {
        minInput.val(0.01);
    }
    
    if(max < min) {
        maxInput.val(min);
    }
    
    // Ensure both values are properly formatted
    minInput.val(parseFloat(minInput.val()).toFixed(2));
    maxInput.val(parseFloat(maxInput.val()).toFixed(2));
}
</script>
    </div>
</div>


         
         
<div class="card mb-5">
        <div class="card-body">  
          <div class="row">
 <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Remove Join Events when someone joined the group</a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable to Remove User joined the group messages .</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="telegram[join]" id="disable" value="true" <?=$telegram_settings['join'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="disable"></label>
                </div>
            </div>
        </div>        
       
           <div class="separator separator-dashed my-2"></div> 
                               <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Remove left Events when someone left the group</a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable to Remove User left the group messages .</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="telegram[left]" id="disable" value="true" <?=$telegram_settings['left'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="disable"></label>
                </div>
            </div>
        </div>   
            
       
                    <div class="separator separator-dashed my-2"></div> 
                               <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Remove Forward Messages</a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable to Remove forwarded messages.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="telegram[forwarded]" id="forwarded" value="true" <?=$telegram_settings['forwarded'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="forwarded"></label>
                </div>
            </div>
        </div> 
         <div class="separator separator-dashed my-2"></div>   
         
         </div></div></div>
<div class="card mb-5">
        <div class="card-body">  
          <div class="row">
                                                    <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Use FAQ's as Answers to Users Questions</a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable to instant reply users query if found in FAQ's .</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="telegram[faqs]" id="faqs" value="true" <?=$telegram_settings['faqs'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="faqs"></label>
                </div>
            </div>
        </div>
        
            <div id="faqsdiv" <?= $telegram_settings['faqs'] == 'true' ? 'style="display:block;"' : 'style="display:none;"' ?>>
        <div class="separator separator-dashed my-2"></div>
        <div class="d-flex flex-stack">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Use Buttons with FAQ Message</a>
            <div class="fs-9 fw-semibold text-gray-500">Enable to Remove User joined the group messages.</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <div class="form-check form-check-solid form-check-custom form-switch">
            <input class="form-check-input w-45px h-30px" type="checkbox" name="telegram[use_buttons_faqs]" id="use_buttons_faqs" value="true" <?= $telegram_settings['use_buttons_faqs'] == 'true' ? 'checked' : '' ?>>
            <label class="form-check-label fs-9" for="use_buttons_faqs"></label>
        </div>
    </div>
</div>
<div id="buttons_faqs" <?= $telegram_settings['use_buttons_faqs'] == 'true' ? 'style="display:block;"' : 'style="display:none;"' ?>>
    <div class="separator separator-dashed my-2"></div>
    <div class="d-flex flex-stack">
        <div class="d-flex">
            <div class="d-flex flex-column">
                <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Use Telegram FAQ Mini App</a>
                <div class="fs-9 fw-semibold text-gray-500">Enable to use telegram FAQ Mini App.</div>
            </div>
        </div>
        <div class="d-flex justify-content-end">
            <div class="form-check form-check-solid form-check-custom form-switch">
                <input class="form-check-input w-45px h-30px" type="checkbox" name="telegram[mini_app_faqs]" id="mini_app_faqs" value="true" <?= $telegram_settings['mini_app_faqs'] == 'true' ? 'checked' : '' ?>>
                <label class="form-check-label fs-9" for="mini_app_faqs"></label>
            </div>
        </div>
    </div>
    <div id="mini_faqs" <?= $telegram_settings['mini_app_faqs'] == 'true' ? 'style="display:block;"' : 'style="display:none;"' ?>>
        <div class="separator separator-dashed my-2"></div>
        <div class="row">
            <div class="col-md-3">
                <label class="fs-9">Bot Button Title (For Bot)</label>
            </div>
            <div class="col-md-3">
                <input type="text" name="telegram[mini_app_private_faqs]" class="form-control form-control-sm" value="<?= $telegram_settings['mini_app_private_faqs'] ?? 'Start'; ?>">
                <label class="form-check-label fs-9" for="memo_faqs">Title for Mini App Start Button (For Bot)</label>
            </div>
            <div class="col-md-3">
                <label class="fs-9">Bot Button Title (For Group)</label>
            </div>
            <div class="col-md-3">
                <input type="text" name="telegram[mini_app_group_faqs]" class="form-control form-control-sm" value="<?= $telegram_settings['mini_app_group_faqs'] ?? 'Open App'; ?>">
                <label class="form-check-label fs-9" for="memo_faqs">Title for Mini App Start Button (For Group)</label>
            </div>
        </div>
    </div>
    <div class="separator separator-dashed my-2"></div>
    <?php if (isset($telegram_settings['buttons_faqs'])): ?>
        <?php foreach ($telegram_settings['buttons_faqs'] as $index_faqs => $button): ?>
            <div class="button-container">
                <div class="row">
                    <div class="col-md-3">
                        <input type="text" class="form-control form-control-sm" name="telegram[buttons_faqs][<?= $index_faqs ?>][name]" placeholder="Button Name" value="<?= $button['name'] ?>">
                    </div>
                    <div class="col-md-2">
                        <select class="form-select form-select-sm" name="telegram[buttons_faqs][<?= $index_faqs ?>][type]">
                            <option value="url" <?= $button['type'] == 'url' ? 'selected' : '' ?>>URL</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control form-control-sm" name="telegram[buttons_faqs][<?= $index_faqs ?>][action]" placeholder="Button Action" value="<?= $button['action'] ?>">
                    </div>
                    <div class="col-md-2">
                        <select class="form-select form-select-sm" name="telegram[buttons_faqs][<?= $index_faqs ?>][line]">
                            <option value="separate" <?= $button['line'] == 'separate' ? 'selected' : '' ?>>Separate Row</option>
                            <option value="same" <?= $button['line'] == 'same' ? 'selected' : '' ?>>Same Row</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-sm btn-primary remove-button-faqs py-0" onclick="removeButtonFaqs(this)">x</button>
                    </div>
                </div>
            </div>
        <?php endforeach; ?>
    <?php endif; ?>
</div>
<button type="button" id="add_button_faqs" class="btn btn-sm btn-primary add_another_faqs py-0" onclick="addButtonFaqs()" <?= $telegram_settings['use_buttons_faqs'] == 'true' ? 'style="display:block;"' : 'style="display:none;"' ?>>+</button>
<div class="separator separator-dashed my-2"></div>
    </div>
       <script>
           let buttonCountFaqs = <?= isset($telegram_settings['buttons_faqs']) ? count($telegram_settings['buttons_faqs']) : 0 ?>;

    window.addButtonFaqs = function() {
        const buttonsDivFaqs = document.getElementById('buttons_faqs');
        if (!buttonsDivFaqs) return;

        const newButtonFaqs = document.createElement('div');
        newButtonFaqs.className = 'button-container';
        newButtonFaqs.innerHTML = `
            <div class="row">
                <div class="col-md-3">
                    <input type="text" class="form-control form-control-sm" name="telegram[buttons_faqs][${buttonCountFaqs}][name]" placeholder="Button Name">
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm" name="telegram[buttons_faqs][${buttonCountFaqs}][type]">
                        <option value="url">URL</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control form-control-sm" name="telegram[buttons_faqs][${buttonCountFaqs}][action]" placeholder="Button Action">
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm" name="telegram[buttons_faqs][${buttonCountFaqs}][line]">
                        <option value="separate">Separate Row</option>
                        <option value="same">Same Row</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-sm btn-primary remove-button-faqs py-0" onclick="removeButtonFaqs(this)">x</button>
                </div>
            </div>`;
        buttonsDivFaqs.appendChild(newButtonFaqs);
        buttonCountFaqs++;
    }

    window.removeButtonFaqs = function(element) {
        element.closest('.button-container').remove();
    }

    const useButtonsFaqs = document.getElementById('use_buttons_faqs');
    if (useButtonsFaqs) {
        useButtonsFaqs.addEventListener('change', function() {
            const buttonsDivFaqs = document.getElementById('buttons_faqs');
            const addButtonDivFaqs = document.getElementById('add_button_faqs');
            const displayStateFaqs = this.checked ? 'block' : 'none';
            if (buttonsDivFaqs) buttonsDivFaqs.style.display = displayStateFaqs;
            if (addButtonDivFaqs) addButtonDivFaqs.style.display = displayStateFaqs;
        });
    }
const miniAppFaqs = document.getElementById('mini_app_faqs');
    if (miniAppFaqs) {
        miniAppFaqs.addEventListener('change', function() {
            const miniDivFaqs = document.getElementById('mini_faqs');
            if (miniDivFaqs) miniDivFaqs.style.display = this.checked ? 'block' : 'none';
        });
    }
               const faqs = document.getElementById('faqs');
    if (faqs) {
        faqs.addEventListener('change', function() {
            const faqsdiv = document.getElementById('faqsdiv');
            if (faqsdiv) faqsdiv.style.display = this.checked ? 'block' : 'none';
        });
    }
       </script> 
<div class="separator separator-dashed my-2"></div>

</div></div></div>
<div class="card mb-5">
        <div class="card-body">  
          <div class="row">
<div class="col-md-2">
    <label class="fs-9">Ban Words</label>
</div>

<div class="col-md-10">
    <input type="text" name="telegram[ban_words]" class="form-control form-control-sm" value="<?=$telegram_settings['ban_words'] ?: 'Scam,Pending,not paying,not working,fraud'; ?>">
    <label class="form-check-label fs-9" for="memo">Comma to separate words: don't use spaces</label>
    <small class="fs-9">Messages to Bot and Messages in group with these words will be deleted automatically</small>
</div>
<div class="separator separator-dashed my-2"></div>
<div class="d-flex flex-stack">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Restrict The user if Banned Words Sent</a>
            <div class="fs-9 fw-semibold text-gray-500">Enable to Restrict the user if banned words are sent.</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <div class="form-check form-check-solid form-check-custom form-switch">
            <input class="form-check-input w-45px h-30px" type="checkbox" name="telegram[ban_words_restrict]" id="ban_words_restrict" value="true" <?= $telegram_settings['ban_words_restrict'] == 'true' ? 'checked' : '' ?>>
            <label class="form-check-label fs-9" for="ban_words_ban"></label>
        </div>
    </div>
</div>

<div id="wordrestrict" class="row">
    <div class="separator separator-dashed my-2"></div>

    <div class="col-md-2">
        <label class="fs-9">Time Period</label>
    </div>

    <div class="col-md-10">
        <input type="text" name="telegram[ban_words_restrict_time]" class="form-control form-control-sm" value="<?=$telegram_settings['ban_words_restrict_time']; ?>">
        <label class="form-check-label fs-9" for="memo">Restrict Time Period.</label>
        <small class="fs-9">Enter Hours, Like 24 for 24 hours</small>
    </div>
</div>
<script>
$("#wordrestrict").<?= $telegram_settings['ban_words_restrict'] == 'true' ? "show" : "hide" ?>();
$("#ban_words_restrict").click(function() {
    if($(this).is(":checked")) {
        $("#wordrestrict").show();
    } else {
        $("#wordrestrict").hide();
    }
});
</script>
<div class="separator separator-dashed my-2"></div>
<div class="d-flex flex-stack">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Ban The user if Banned Words Sent</a>
            <div class="fs-9 fw-semibold text-gray-500">Enable to ban the user if banned words are sent.</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <div class="form-check form-check-solid form-check-custom form-switch">
            <input class="form-check-input w-45px h-30px" type="checkbox" name="telegram[ban_words_ban]" id="ban_words_ban" value="true" <?= $telegram_settings['ban_words_ban'] == 'true' ? 'checked' : '' ?>>
            <label class="form-check-label fs-9" for="ban_words_ban"></label>
        </div>
    </div>
</div>

<div id="wordban" class="row">
    <div class="separator separator-dashed my-2"></div>

    <div class="col-md-2">
        <label class="fs-9">Time Period</label>
    </div>

    <div class="col-md-10">
        <input type="text" name="telegram[ban_words_ban_time]" class="form-control form-control-sm" value="<?=$telegram_settings['ban_words_ban_time']; ?>">
        <label class="form-check-label fs-9" for="memo">Ban Time Period.</label>
        <small class="fs-9">Enter Hours, Like 24 for 24 hours</small>
    </div>
</div>
<script>
$("#wordban").<?= $telegram_settings['ban_words_ban'] == 'true' ? "show" : "hide" ?>();
$("#ban_words_ban").click(function() {
    if($(this).is(":checked")) {
        $("#wordban").show();
    } else {
        $("#wordban").hide();
    }
});
</script>

<div class="separator separator-dashed my-2"></div>
<div class="d-flex flex-stack">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Kick The User if Ban Word Send</a>
            <div class="fs-9 fw-semibold text-gray-500">Enable to kick the user if banned words are sent.</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <div class="form-check form-check-solid form-check-custom form-switch">
            <input class="form-check-input w-45px h-30px" type="checkbox" name="telegram[ban_words_kick]" id="ban_words_kick" value="true" <?= $telegram_settings['ban_words_kick'] == 'true' ? 'checked' : '' ?>>
            <label class="form-check-label fs-9" for="ban_words_kick"></label>
        </div>
    </div>
</div>
</div></div></div>
<div class="card mb-5">
        <div class="card-body">  
          <div class="row">
<div class="separator separator-dashed my-2"></div>
<div class="col-md-2">
    <label class="fs-9">Allowed URLs</label>
</div>

<div class="col-md-10">
    <input type="text" name="telegram[allowed_urls]" class="form-control form-control-sm" value="<?=$telegram_settings['allowed_urls'] ?: 'bitders.com,tronscan.org,t.me/bitders'; ?>">
    <label class="form-check-label fs-9" for="memo">Comma to separate URLs: don't use spaces</label>
    <small class="fs-9">Messages to Bot and Messages in group with these URLs will be allowed only; rest links will be deleted automatically</small>
</div>
<div class="separator separator-dashed my-2"></div>
<div class="d-flex flex-stack">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Restrict The User if Disallowed URL Sent</a>
            <div class="fs-9 fw-semibold text-gray-500">Enable to restrict the user if a disallowed URL is sent.</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <div class="form-check form-check-solid form-check-custom form-switch">
            <input class="form-check-input w-45px h-30px" type="checkbox" name="telegram[allowed_urls_restrict]" id="allowed_urls_restrict" value="true" <?= $telegram_settings['allowed_urls_restrict'] == 'true' ? 'checked' : '' ?>>
            <label class="form-check-label fs-9" for="allowed_urls_restrict"></label>
        </div>
    </div>
</div>

<div id="urlrestrict" class="row">
    <div class="separator separator-dashed my-2"></div>

    <div class="col-md-2">
        <label class="fs-9">Time Period</label>
    </div>

    <div class="col-md-10">
        <input type="text" name="telegram[allowed_urls_restrict_time]" class="form-control form-control-sm" value="<?=$telegram_settings['allowed_urls_restrict_time']; ?>">
        <label class="form-check-label fs-9" for="memo">Restrict Time Period.</label>
        <small class="fs-9">Enter Hours, Like 24 for 24 hours</small>
    </div>
</div>
<script>
$("#urlrestrict").<?= $telegram_settings['allowed_urls_restrict'] == 'true' ? "show" : "hide" ?>();
$("#allowed_urls_restrict").click(function() {
    if($(this).is(":checked")) {
        $("#urlrestrict").show();
    } else {
        $("#urlrestrict").hide();
    }
});
</script>
<div class="separator separator-dashed my-2"></div>
<div class="d-flex flex-stack">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Ban The User if Disallowed URL Sent</a>
            <div class="fs-9 fw-semibold text-gray-500">Enable to ban the user if a disallowed URL is sent.</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <div class="form-check form-check-solid form-check-custom form-switch">
            <input class="form-check-input w-45px h-30px" type="checkbox" name="telegram[allowed_urls_ban]" id="allowed_urls_ban" value="true" <?= $telegram_settings['allowed_urls_ban'] == 'true' ? 'checked' : '' ?>>
            <label class="form-check-label fs-9" for="allowed_urls_ban"></label>
        </div>
    </div>
</div>

<div id="urlban" class="row">
    <div class="separator separator-dashed my-2"></div>

    <div class="col-md-2">
        <label class="fs-9">Time Period</label>
    </div>

    <div class="col-md-10">
        <input type="text" name="telegram[allowed_urls_ban_time]" class="form-control form-control-sm" value="<?=$telegram_settings['allowed_urls_ban_time']; ?>">
        <label class="form-check-label fs-9" for="memo">Ban Time Period.</label>
        <small class="fs-9">Enter Hours, Like 24 for 24 hours</small>
    </div>
</div>
<script>
$("#urlban").<?= $telegram_settings['allowed_urls_ban'] == 'true' ? "show" : "hide" ?>();
$("#allowed_urls_ban").click(function() {
    if($(this).is(":checked")) {
        $("#urlban").show();
    } else {
        $("#urlban").hide();
    }
});
</script>

<div class="separator separator-dashed my-2"></div>
<div class="d-flex flex-stack">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Kick The User if Disallowed URL Sent</a>
            <div class="fs-9 fw-semibold text-gray-500">Enable to kick the user if a disallowed URL is sent.</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <div class="form-check form-check-solid form-check-custom form-switch">
            <input class="form-check-input w-45px h-30px" type="checkbox" name="telegram[allowed_urls_kick]" id="allowed_urls_kick" value="true" <?= $telegram_settings['allowed_urls_kick'] == 'true' ? 'checked' : '' ?>>
            <label class="form-check-label fs-9" for="allowed_urls_kick"></label>
        </div>
    </div>
</div>
</div></div></div>
<div class="card mb-5">
        <div class="card-body">  
          <div class="row">
<div class="separator separator-dashed my-2"></div>
<div class="col-md-2">
    <label class="fs-9">Allowed Mentions</label>
</div>

<div class="col-md-10">
    <input type="text" name="telegram[allowed_mentions]" class="form-control form-control-sm" value="<?=$telegram_settings['allowed_mentions'] ?: '@bitders,@telegram'; ?>">
    <label class="form-check-label fs-9" for="memo">Comma to separate words: don't use spaces</label>
    <small class="fs-9">Messages to Bot and Messages in group with these mentions will be allowed only; rest mentions will be deleted automatically</small>
</div>
<div class="separator separator-dashed my-2"></div>
<div class="d-flex flex-stack">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Restrict The User if Disallowed Mention Sent</a>
            <div class="fs-9 fw-semibold text-gray-500">Enable to restrict the user if a disallowed mention is sent.</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <div class="form-check form-check-solid form-check-custom form-switch">
            <input class="form-check-input w-45px h-30px" type="checkbox" name="telegram[allowed_mentions_restrict]" id="allowed_mentions_restrict" value="true" <?= $telegram_settings['allowed_mentions_restrict'] == 'true' ? 'checked' : '' ?>>
            <label class="form-check-label fs-9" for="allowed_mentions_restrict"></label>
        </div>
    </div>
</div>

<div id="mentionrestrict" class="row">
    <div class="separator separator-dashed my-2"></div>

    <div class="col-md-2">
        <label class="fs-9">Time Period</label>
    </div>

    <div class="col-md-10">
        <input type="text" name="telegram[allowed_mentions_restrict_time]" class="form-control form-control-sm" value="<?=$telegram_settings['allowed_mentions_restrict_time']; ?>">
        <label class="form-check-label fs-9" for="memo">Restrict Time Period.</label>
        <small class="fs-9">Enter Hours, Like 24 for 24 hours</small>
    </div>
</div>
<script>
$("#mentionrestrict").<?= $telegram_settings['allowed_mentions_restrict'] == 'true' ? "show" : "hide" ?>();
$("#allowed_mentions_restrict").click(function() {
    if($(this).is(":checked")) {
        $("#mentionrestrict").show();
    } else {
        $("#mentionrestrict").hide();
    }
});
</script>
<div class="separator separator-dashed my-2"></div>
<div class="d-flex flex-stack">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Ban The User if Disallowed Mention Sent</a>
            <div class="fs-9 fw-semibold text-gray-500">Enable to ban the user if a disallowed mention is sent.</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <div class="form-check form-check-solid form-check-custom form-switch">
            <input class="form-check-input w-45px h-30px" type="checkbox" name="telegram[allowed_mentions_ban]" id="allowed_mentions_ban" value="true" <?= $telegram_settings['allowed_mentions_ban'] == 'true' ? 'checked' : '' ?>>
            <label class="form-check-label fs-9" for="allowed_mentions_ban"></label>
        </div>
    </div>
</div>

<div id="mentionban" class="row">
    <div class="separator separator-dashed my-2"></div>

    <div class="col-md-2">
        <label class="fs-9">Time Period</label>
    </div>

    <div class="col-md-10">
        <input type="text" name="telegram[allowed_mentions_ban_time]" class="form-control form-control-sm" value="<?=$telegram_settings['allowed_mentions_ban_time']; ?>">
        <label class="form-check-label fs-9" for="memo">Ban Time Period.</label>
        <small class="fs-9">Enter Hours, Like 24 for 24 hours</small>
    </div>
</div>
<script>
$("#mentionban").<?= $telegram_settings['allowed_mentions_ban'] == 'true' ? "show" : "hide" ?>();
$("#allowed_mentions_ban").click(function() {
    if($(this).is(":checked")) {
        $("#mentionban").show();
    } else {
        $("#mentionban").hide();
    }
});
</script>
<div class="separator separator-dashed my-2"></div>
<div class="d-flex flex-stack">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Kick The User if Disallowed Mention Sent</a>
            <div class="fs-9 fw-semibold text-gray-500">Enable to kick the user if a disallowed mention is sent.</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <div class="form-check form-check-solid form-check-custom form-switch">
            <input class="form-check-input w-45px h-30px" type="checkbox" name="telegram[allowed_mentions_kick]" id="allowed_mentions_kick" value="true" <?= $telegram_settings['allowed_mentions_kick'] == 'true' ? 'checked' : '' ?>>
            <label class="form-check-label fs-9" for="allowed_mentions_kick"></label>
        </div>
    </div>
</div>
            </div> <!-- group channel end -->
                                                     </div> 
                                            </div>      
                                     
                               </div>                       
                                                    
                                                  <div class="row">
                               </div>
                                               </div>
                                               <div class="card-footer d-flex justify-content-end py-2 px-9">
       <input type="submit" name="submit" class="btn btn-primary" value="Update Settings">

   
</div>

                                        </form>
               
                                      
                         

                       
                                            <!--end:::Tab content-->
                                        </div>
                                        <!--end::Card body-->
                                    </div>
                                    
                                  
                                    <!--end::Card-->
<? }

 if ($_GET['page'] == 'telegram_chat') { ?>
<div class="d-flex flex-column flex-lg-row">
    <!-- Loading Overlay -->
    <div class="loading-overlay position-fixed top-0 start-0 w-100 h-100 bg-white bg-opacity-75 d-none" style="z-index: 9999;" id="loading_overlay">
        <div class="d-flex justify-content-center align-items-center h-100">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <!-- Users List Section -->
    <div class="flex-column flex-lg-row-auto w-100 w-lg-300px w-xl-400px mb-10 mb-lg-0">
        <div class="card card-flush">
            <!-- Contacts Header -->
            <div class="card-header pt-7" id="kt_chat_contacts_header">
                <div class="card-title d-flex align-items-center">
                    <h2 class="fw-bold">Contacts</h2>
                    <span class="badge badge-primary ms-3" id="online_users_count">0</span>
                </div>
                <div class="card-toolbar">
                    <div class="search-box position-relative">
                        <input type="text" class="form-control form-control-solid" placeholder="Search contacts" id="contact_search">
                        <i class="bi bi-search position-absolute top-50 end-0 translate-middle-y me-3"></i>
                    </div>
                </div>
            </div>

            <!-- Contacts Body -->
            <div class="card-body pt-5" id="kt_chat_contacts_body">
                <!-- Contacts Loading Skeleton -->
                <div class="contacts-loading d-none">
                    <?php for($i = 0; $i < 5; $i++) { ?>
                    <div class="d-flex flex-stack py-4">
                        <div class="d-flex align-items-center w-100">
                            <div class="skeleton-loader symbol symbol-45px symbol-circle bg-light"></div>
                            <div class="ms-5 w-100">
                                <div class="skeleton-loader bg-light w-75 h-20px mb-2"></div>
                                <div class="skeleton-loader bg-light w-50 h-15px"></div>
                            </div>
                        </div>
                    </div>
                    <?php } ?>
                </div>

                <!-- Users List -->
                <div class="scroll-y me-n5 pe-5 h-400px" id="users_list"></div>
            </div>
        </div>
    </div>

    <!-- Chat Section -->
    <div class="flex-lg-row-fluid ms-lg-7 ms-xl-10">
        <div class="card" id="kt_chat_messenger">
            <!-- Chat Header -->
            <div class="card-header" id="kt_chat_messenger_header">
                <div class="card-title">
                    <div class="d-flex justify-content-center flex-column me-3">
                        <a href="#" class="fs-4 fw-bolder text-gray-900 text-hover-primary me-1 mb-2 lh-1" id="chat_user_name">Select a user</a>
                        <div class="mb-0 lh-1">
                            <span class="badge badge-success badge-circle w-10px h-10px me-1"></span>
                            <span class="fs-7 fw-bold text-gray-400" id="chat_user_status">Active</span>
                        </div>
                    </div>
                </div>
                <div class="card-toolbar">
                    <div class="me-n3">
                        <button type="button" class="btn btn-sm btn-icon btn-active-light-primary" id="user_info_btn">
                            <i class="bi bi-three-dots fs-2"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chat Body -->
            <div class="card-body" id="kt_chat_messenger_body">
                <!-- Chat Loading Skeleton -->
                <div class="chat-loading d-none">
                    <?php for($i = 0; $i < 3; $i++) { ?>
                    <div class="d-flex justify-content-start mb-10">
                        <div class="d-flex flex-column align-items-start">
                            <div class="skeleton-loader bg-light w-100px h-15px mb-2"></div>
                            <div class="skeleton-loader bg-light w-200px h-40px rounded"></div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-end mb-10">
                        <div class="d-flex flex-column align-items-end">
                            <div class="skeleton-loader bg-light w-100px h-15px mb-2"></div>
                            <div class="skeleton-loader bg-light w-200px h-40px rounded"></div>
                        </div>
                    </div>
                    <?php } ?>
                </div>

                <!-- Chat Messages -->
                <div class="scroll-y me-n5 pe-5 h-300px h-lg-auto" id="chat_messages"></div>
            </div>

            <!-- Chat Footer -->
            <div class="card-footer pt-4" id="kt_chat_messenger_footer">
                <!-- Reply Preview -->
                <div id="reply_preview" class="d-none bg-light-secondary p-3 mb-3 border rounded">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">Replying to:</small>
                            <p class="reply-text mb-0 text-truncate"></p>
                        </div>
                        <button class="btn btn-sm btn-icon" onclick="window.telegramChat.cancelReply()">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </div>

                <!-- Message Input -->
                <div class="message-input-wrapper">
                    <textarea class="form-control form-control-flush mb-3" rows="1" id="message_input" 
                        placeholder="Type a message"></textarea>
                    <div class="d-flex flex-stack">
                        <div class="d-flex align-items-center me-2">
                            <button class="btn btn-sm btn-icon btn-active-light-primary me-1" type="button" id="attach_file_btn">
                                <i class="bi bi-paperclip fs-3"></i>
                            </button>
                            <button class="btn btn-sm btn-icon btn-active-light-primary me-1" type="button" id="emoji_btn">
                                <i class="bi bi-emoji-smile fs-3"></i>
                            </button>
                        </div>
                        <button class="btn btn-primary" type="button" id="send_message_btn">
                            <span class="indicator-label">Send</span>
                            <span class="indicator-progress">Please wait... 
                                <span class="spinner-border spinner-border-sm align-middle ms-2"></span>
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Info Drawer -->
<div class="bg-white" data-kt-drawer="true" data-kt-drawer-activate="true" 
     data-kt-drawer-toggle="#user_info_btn" data-kt-drawer-close="#kt_user_info_close"
     data-kt-drawer-width="{default:'300px', 'md': '400px'}" id="kt_user_info">
    <div class="card w-100 rounded-0">
        <!-- Header -->
        <div class="card-header pe-5">
            <div class="card-title">
                <div class="d-flex justify-content-center flex-column me-3">
                    <h2 class="fs-2 fw-bolder" id="user_info_name">User Profile</h2>
                    <span class="text-gray-400 fs-7" id="user_info_status">Loading...</span>
                </div>
            </div>
            <div class="card-toolbar">
                <button type="button" class="btn btn-sm btn-icon btn-active-light-primary" id="kt_user_info_close">
                    <i class="bi bi-x fs-2"></i>
                </button>
            </div>
        </div>

        <!-- Body -->
        <div class="card-body hover-scroll-overlay-y">
            <!-- User Info -->
            <div class="d-flex flex-column align-items-center mb-10">
                <div class="symbol symbol-100px symbol-circle mb-3" id="user_profile_pic">
                    <img src="/assets/media/avatars/blank.png" alt="user" />
                </div>
                <div class="d-flex flex-column align-items-center">
                    <span class="fs-3 fw-bold mb-1" id="user_full_name">Loading...</span>
                    <a href="#" class="fs-5 text-gray-600 text-hover-primary" id="user_username">@username</a>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex flex-center gap-5 mb-10">
                <button type="button" class="btn btn-sm btn-light-primary" id="message_user_btn">
                    <i class="bi bi-chat-dots fs-4 me-2"></i>Message
                </button>
                <button type="button" class="btn btn-sm btn-light-warning" id="mute_user_btn">
                    <i class="bi bi-bell-slash fs-4 me-2"></i>Mute
                </button>
                <button type="button" class="btn btn-sm btn-light-info" id="more_actions_btn">
                    <i class="bi bi-three-dots fs-4"></i>
                </button>
            </div>

            <!-- User Stats -->
            <div class="border rounded p-5 mb-10">
                <div class="d-flex flex-stack">
                    <div class="d-flex flex-column">
                        <span class="text-gray-400 fs-7">User ID</span>
                        <span class="fs-6 fw-bold" id="user_telegram_id">Loading...</span>
                    </div>
                    <button class="btn btn-icon btn-sm btn-light-primary" onclick="window.telegramChat.copyToClipboard('#user_telegram_id')">
                        <i class="bi bi-clipboard"></i>
                    </button>
                </div>
            </div>

            <!-- User Bio -->
            <div class="mb-10">
                <h4 class="fw-bold mb-3">Bio</h4>
                <div class="text-gray-600" id="user_bio">No bio available</div>
            </div>

            <!-- Danger Zone -->
            <div class="separator separator-dashed my-8"></div>
            <div class="rounded border border-danger p-5">
                <h4 class="text-danger mb-5">Danger Zone</h4>
                <div class="d-flex flex-column gap-3">
                    <button type="button" class="btn btn-light-danger text-start" onclick="window.telegramChat.clearChat()">
                        <i class="bi bi-trash fs-4 me-2"></i>Clear Chat History
                    </button>
                    <button type="button" class="btn btn-light-danger text-start" onclick="window.telegramChat.blockUser()">
                        <i class="bi bi-shield-x fs-4 me-2"></i>Block User
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom Styles -->
<style>
.skeleton-loader {
    animation: loading 1.5s infinite;
}

.message-container {
    position: relative;
}

.message-actions {
    transition: opacity 0.3s ease;
    opacity: 0;
}

.message-container:hover .message-actions {
    opacity: 1;
}

@keyframes loading {
    0% { opacity: 0.5; }
    50% { opacity: 1; }
    100% { opacity: 0.5; }
}
</style>

<script>
class TelegramChat {
    constructor() {
        this.currentUserId = null;
        this.refreshInterval = null;
        this.lastMessageTimestamp = 0;
        this.replyToMessageId = null;
        this.chatMessages = [];
        this.isLoading = false;
        this.searchTimeout = null;
        this.messageQueue = [];
        this.processingQueue = false;
        
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.loadUsers();
        this.setupAutoResizeTextarea();
    }

    setupEventListeners() {
        // Message sending
        document.getElementById('send_message_btn').addEventListener('click', () => this.sendMessage());
        document.getElementById('message_input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });

        // Contact search
        document.getElementById('contact_search').addEventListener('input', (e) => {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                this.filterContacts(e.target.value);
            }, 300);
        });

        // File attachment
        document.getElementById('attach_file_btn').addEventListener('click', () => {
            this.showNotification('File attachment coming soon', 'info');
        });

        // Emoji button
        document.getElementById('emoji_btn').addEventListener('click', () => {
            this.showNotification('Emoji picker coming soon', 'info');
        });

        // User info actions
        document.getElementById('message_user_btn')?.addEventListener('click', () => {
            document.getElementById('message_input')?.focus();
        });

        document.getElementById('mute_user_btn')?.addEventListener('click', () => {
            this.toggleMuteUser();
        });

        document.getElementById('more_actions_btn')?.addEventListener('click', () => {
            this.showMoreActions();
        });

        // Window events
        window.addEventListener('focus', () => {
            if (this.currentUserId) {
                this.refreshChat(true);
            }
        });

        // Prevent accidental navigation
        window.addEventListener('beforeunload', (e) => {
            if (document.getElementById('message_input').value.trim()) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    }

    setupAutoResizeTextarea() {
        const textarea = document.getElementById('message_input');
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
    }

    showLoading() {
        document.getElementById('loading_overlay').classList.remove('d-none');
        this.isLoading = true;
    }

    hideLoading() {
        document.getElementById('loading_overlay').classList.add('d-none');
        this.isLoading = false;
    }

    showNotification(message, type = 'success', duration = 3000) {
        Swal.fire({
            text: message,
            icon: type,
            buttonsStyling: false,
            timer: duration,
            timerProgressBar: true,
            showConfirmButton: false,
            customClass: {
                popup: 'animate__animated animate__fadeInDown'
            }
        });
    }

    filterContacts(searchTerm) {
        const userItems = document.querySelectorAll('.user-item');
        searchTerm = searchTerm.toLowerCase();

        userItems.forEach(item => {
            const userName = item.querySelector('.fs-5').textContent.toLowerCase();
            const userMessage = item.querySelector('.fw-bold').textContent.toLowerCase();
            
            if (userName.includes(searchTerm) || userMessage.includes(searchTerm)) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    }

    loadUsers() {
        document.querySelector('.contacts-loading').classList.remove('d-none');
        document.getElementById('users_list').classList.add('d-none');

        fetch('admin?page=telegram_chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: 'action=get_users'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const usersList = document.getElementById('users_list');
                usersList.innerHTML = data.users.map(user => this.createUserListItem(user)).join('');
                
                // Update online users count
                document.getElementById('online_users_count').textContent = data.users.filter(u => u.is_online).length;

                // Add click handlers
                document.querySelectorAll('.user-item').forEach(item => {
                    item.addEventListener('click', () => {
                        document.querySelectorAll('.user-item').forEach(i => i.classList.remove('selected'));
                        item.classList.add('selected');
                        this.loadChat(item.dataset.userId);
                    });
                });
            }
        })
        .finally(() => {
            document.querySelector('.contacts-loading').classList.add('d-none');
            document.getElementById('users_list').classList.remove('d-none');
        });
    }

    createUserListItem(user) {
        const lastActivity = this.formatDate(user.last_activity * 1000);
        const isOnline = (Date.now() / 1000 - user.last_activity) < 300; // 5 minutes threshold

        return `
            <div class="d-flex flex-stack py-4 user-item cursor-pointer hover-bg-light" data-user-id="${user.user_id}">
                <div class="d-flex align-items-center">
                    <div class="symbol symbol-45px symbol-circle position-relative">
                        ${user.photo_path ? 
                            `<img src="${user.photo_path}" alt="${user.first_name}" class="user-avatar" />` :
                            `<span class="symbol-label bg-light-primary text-primary fs-6 fw-bolder">
                                ${user.first_name ? user.first_name[0] : 'U'}
                            </span>`
                        }
                        <div class="symbol-badge bg-${isOnline ? 'success' : 'gray-300'} start-100 top-100 border-4 h-15px w-15px ms-n2 mt-n2"></div>
                    </div>
                    <div class="ms-5">
                        <a href="#" class="fs-5 fw-bolder text-gray-900 text-hover-primary mb-2">
                            ${user.first_name} ${user.last_name || ''}
                        </a>
                        <div class="fw-bold text-gray-400 text-truncate" style="max-width: 150px;">
                            ${user.last_message || 'No messages yet'}
                        </div>
                    </div>
                </div>
                <div class="d-flex flex-column align-items-end ms-2">
                    <span class="text-muted fs-7 mb-1">${lastActivity}</span>
                    ${user.unread_count ? `
                        <span class="badge badge-circle badge-primary">${user.unread_count}</span>
                    ` : ''}
                </div>
            </div>
        `;
    }

    loadChat(userId) {
        if (this.currentUserId === userId) return;
        
        this.currentUserId = userId;
        this.chatMessages = [];
        this.lastMessageTimestamp = 0;
        
        // Show chat loading state
        document.querySelector('.chat-loading').classList.remove('d-none');
        document.getElementById('chat_messages').innerHTML = '';
        
        // Update UI
        const userItem = document.querySelector(`.user-item[data-user-id="${userId}"]`);
        if (userItem) {
            const userName = userItem.querySelector('.fs-5').textContent;
            document.getElementById('chat_user_name').textContent = userName;
        }

        this.cancelReply();
        this.refreshChat(true);

        // Reset refresh interval
        if (this.refreshInterval) {
            clearInterval(this.refreshInterval);
        }
        this.refreshInterval = setInterval(() => this.refreshChat(false), 5000);

        // Load user info
        this.loadUserInfo(userId);
    }

    loadUserInfo(userId) {
        fetch('admin?page=telegram_chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: `action=get_user_info&user_id=${userId}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                this.updateUserInfoUI(data.user);
            }
        })
        .catch(error => {
            console.error('Error loading user info:', error);
            this.showNotification('Error loading user info', 'error');
        });
    }

    updateUserInfoUI(user) {
        const elements = {
            'user_info_name': user.display_name,
            'user_full_name': user.display_name,
            'user_username': user.username_display,
            'user_telegram_id': user.user_id,
            'user_bio': user.bio || 'No bio available',
            'user_info_status': `Last seen ${this.formatDate(user.last_activity * 1000)}`
        };

        Object.entries(elements).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) element.textContent = value;
        });

        // Update profile picture
        const profilePic = document.querySelector('#user_profile_pic img');
        if (profilePic) {
            profilePic.src = user.photo_url || '/assets/media/avatars/blank.png';
            profilePic.alt = user.display_name;
        }
    }

    refreshChat(isInitialLoad = false) {
        if (!this.currentUserId || this.isLoading) return;

        fetch('admin?page=telegram_chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: `action=get_chat_history&user_id=${this.currentUserId}&last_timestamp=${isInitialLoad ? 0 : this.lastMessageTimestamp}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                this.updateChatMessages(data.messages, isInitialLoad);
            }
        })
        .finally(() => {
            document.querySelector('.chat-loading').classList.add('d-none');
        });
    }

    updateChatMessages(messages, isInitialLoad) {
        const messagesDiv = document.getElementById('chat_messages');
        const wasScrolledToBottom = messagesDiv.scrollHeight - messagesDiv.scrollTop === messagesDiv.clientHeight;

        if (isInitialLoad) {
            this.chatMessages = messages;
        } else {
            const newMessages = messages.filter(msg => 
                !this.chatMessages.some(existingMsg => existingMsg.message_id === msg.message_id)
            );
            this.chatMessages = [...this.chatMessages, ...newMessages];
        }

        if (this.chatMessages.length > 0) {
            this.lastMessageTimestamp = Math.max(...this.chatMessages.map(msg => msg.date));
        }

        messagesDiv.innerHTML = this.chatMessages.map(msg => this.renderMessage(msg)).join('');
        this.setupMessageActions();

        if (wasScrolledToBottom || isInitialLoad) {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    }

    renderMessage(msg) {
        const replyContent = this.getReplyContent(msg);
        const isBot = msg.type === 'BOT' || msg.is_bot === 1;
        const timestamp = this.formatDate(msg.date * 1000);

        return `
            <div class="d-flex justify-content-${isBot ? 'end' : 'start'} mb-10">
                <div class="d-flex flex-column align-items-${isBot ? 'end' : 'start'} w-100">
                    <div class="d-flex align-items-center mb-2">
                        ${isBot ? 
                            '<span class="text-muted fs-7 me-1">Support</span>' :
                            `<span class="text-muted fs-7 ms-1">${msg.first_name || 'User'}</span>`
                        }
                        <span class="text-muted fs-8 ms-2">${timestamp}</span>
                    </div>
                    <div class="message-container position-relative">
                        ${replyContent}
                        <div class="p-5 rounded bg-light-${isBot ? 'primary' : 'info'} text-dark fw-bold mw-lg-400px">
                            ${this.formatMessageText(msg.text)}
                        </div>
                        <div class="message-actions position-absolute top-0 ${isBot ? 'start-0' : 'end-0'} mt-2">
                            <button class="btn btn-sm btn-icon btn-light-primary me-1" 
                                    data-message-id="${msg.message_id}" 
                                    data-message-text="${msg.text.replace(/"/g, '&quot;')}"
                                    title="Reply">
                                <i class="bi bi-reply"></i>
                            </button>
                            ${isBot ? `
                            <button class="btn btn-sm btn-icon btn-light-danger" 
                                    data-delete-id="${msg.message_id}"
                                    title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    formatMessageText(text) {
        // Convert URLs to clickable links
        text = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-primary">$1</a>');
        // Convert line breaks to <br>
        return text.replace(/\n/g, '<br>');
    }

    getReplyContent(msg) {
        if (!msg.reply) return '';
        
        const repliedMsg = this.chatMessages.find(m => m.message_id == msg.reply);
        if (!repliedMsg) return '';

        return `
            <div class="reply-content mb-2 p-2 border-start border-4 border-gray-400 bg-gray-100 rounded">
                <small class="text-muted">Replying to ${repliedMsg.is_bot ? 'Support' : (repliedMsg.first_name || 'User')}:</small><br>
                <span class="text-gray-700">${repliedMsg.text}</span>
            </div>
        `;
    }
    
setupMessageActions() {
        document.querySelectorAll('.message-container').forEach(container => {
            const replyBtn = container.querySelector('[data-message-id]');
            if (replyBtn) {
                replyBtn.addEventListener('click', () => {
                    this.setReply(
                        replyBtn.dataset.messageId,
                        replyBtn.dataset.messageText
                    );
                });
            }

            const deleteBtn = container.querySelector('[data-delete-id]');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', () => {
                    this.deleteMessage(deleteBtn.dataset.deleteId);
                });
            }
        });
    }

    setReply(messageId, text) {
        this.replyToMessageId = messageId;
        const replyPreview = document.getElementById('reply_preview');
        replyPreview.classList.remove('d-none');
        replyPreview.querySelector('.reply-text').textContent = text;
        document.getElementById('message_input').focus();
    }

    cancelReply() {
        this.replyToMessageId = null;
        const replyPreview = document.getElementById('reply_preview');
        replyPreview.classList.add('d-none');
        replyPreview.querySelector('.reply-text').textContent = '';
    }

    deleteMessage(messageId) {
        Swal.fire({
            title: 'Delete Message',
            text: "Are you sure you want to delete this message?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Yes, delete it",
            cancelButtonText: "Cancel",
            customClass: {
                confirmButton: "btn btn-danger",
                cancelButton: "btn btn-active-light"
            }
        }).then((result) => {
            if (result.isConfirmed) {
                this.showLoading();
                
                fetch('admin?page=telegram_chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `action=delete_message&message_id=${messageId}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.chatMessages = this.chatMessages.filter(msg => msg.message_id !== messageId);
                        this.refreshChat(false);
                        this.showNotification('Message deleted successfully');
                    } else {
                        this.showNotification('Failed to delete message', 'error');
                    }
                })
                .finally(() => {
                    this.hideLoading();
                });
            }
        });
    }

    clearChat() {
        if (!this.currentUserId) return;
        
        Swal.fire({
            title: 'Clear Chat History',
            text: "Are you sure you want to clear all messages? This cannot be undone.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Yes, clear it",
            cancelButtonText: "Cancel",
            customClass: {
                confirmButton: "btn btn-danger",
                cancelButton: "btn btn-active-light"
            }
        }).then((result) => {
            if (result.isConfirmed) {
                this.showLoading();
                
                fetch('admin?page=telegram_chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `action=clear_chat&user_id=${this.currentUserId}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.chatMessages = [];
                        this.refreshChat(true);
                        this.showNotification(`Chat history cleared. ${data.messages_deleted} messages deleted.`);
                    } else {
                        this.showNotification('Failed to clear chat history', 'error');
                    }
                })
                .finally(() => {
                    this.hideLoading();
                });
            }
        });
    }

    blockUser() {
        if (!this.currentUserId) return;

        Swal.fire({
            title: 'Block User',
            text: "Are you sure you want to block this user? They won't be able to send messages anymore.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Yes, block user",
            cancelButtonText: "Cancel",
            customClass: {
                confirmButton: "btn btn-danger",
                cancelButton: "btn btn-active-light"
            }
        }).then((result) => {
            if (result.isConfirmed) {
                this.showLoading();
                
                fetch('admin?page=telegram_chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `action=block_user&user_id=${this.currentUserId}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.showNotification('User has been blocked');
                        this.loadUsers(); // Refresh users list
                    } else {
                        this.showNotification(data.error || 'Failed to block user', 'error');
                    }
                })
                .finally(() => {
                    this.hideLoading();
                });
            }
        });
    }

    toggleMuteUser() {
        // Implementation for mute functionality
        this.showNotification('Mute functionality coming soon', 'info');
    }

    showMoreActions() {
        // Implementation for more actions menu
        const actions = [
            { text: 'Export Chat History', icon: 'bi-download' },
            { text: 'Report User', icon: 'bi-flag' },
            { text: 'View Shared Media', icon: 'bi-images' }
        ];

        const html = actions.map(action => `
            <button class="btn btn-light-primary w-100 mb-2">
                <i class="${action.icon} me-2"></i>${action.text}
            </button>
        `).join('');

        Swal.fire({
            title: 'More Actions',
            html: html,
            showConfirmButton: false,
            showCloseButton: true,
            customClass: {
                container: 'more-actions-popup'
            }
        });
    }

    sendMessage() {
        if (!this.currentUserId || this.isLoading) return;
        
        const input = document.getElementById('message_input');
        const message = input.value.trim();
        if (!message) return;

        const sendButton = document.getElementById('send_message_btn');
        sendButton.setAttribute('data-kt-indicator', 'on');
        this.isLoading = true;

        const formData = new URLSearchParams();
        formData.append('action', 'send_message');
        formData.append('user_id', this.currentUserId);
        formData.append('message', message);
        
        if (this.replyToMessageId) {
            formData.append('reply_to_message_id', this.replyToMessageId);
        }

        fetch('admin?page=telegram_chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                input.value = '';
                input.style.height = 'auto';
                this.cancelReply();
                
                if (data.message) {
                    this.chatMessages.push(data.message);
                    this.refreshChat(false);
                }
            } else {
                this.showNotification('Failed to send message', 'error');
            }
        })
        .finally(() => {
            sendButton.removeAttribute('data-kt-indicator');
            this.isLoading = false;
        });
    }

    formatDate(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;
        const seconds = Math.floor(diff / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        if (seconds < 60) {
            return 'Just now';
        } else if (minutes < 60) {
            return `${minutes}m ago`;
        } else if (hours < 24 && date.getDate() === now.getDate()) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        } else if (days < 7) {
            return date.toLocaleDateString([], { weekday: 'short' });
        } else {
            return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
        }
    }

    copyToClipboard(elementId) {
        const text = document.querySelector(elementId).textContent;
        navigator.clipboard.writeText(text).then(() => {
            this.showNotification('Copied to clipboard!');
        });
    }
}

// Initialize when document is ready
document.addEventListener('DOMContentLoaded', () => {
    window.telegramChat = new TelegramChat();
});
</script>
<?} 
if ($_GET['page'] == 'holidays')
{

    if (isset($_POST['action']) && $_POST['action'] == "delete")
    {
        $RECORD = mysqli_query($DB_CONN, "delete  from holidays where id='{$_POST['package_id']}'");

        $msg = "Operation Successfull!";
    }
    else
    {
        $msg = "ERROR ! Operation Failed.";
    }

    if (isset($_POST['submit']) && isset($_POST['action']) && $_POST['action'] == "update")
    {
        $RECORD = mysqli_query($DB_CONN, "SELECT id from holidays where id='{$_POST['package_id']}'");
        if (mysqli_num_rows($RECORD) > 0)
        {
            $Update = mysqli_query($DB_CONN, "UPDATE  holidays set  `date`='{$_POST['date']}', `description`='{$_POST['description']}',  where id = '{$_POST['package_id']}'") or die(mysqli_error($DB_CONN));

            if ($Update)
            {
                $msg = "Operation Successfull!";
            }
            else
            {
                $msg = "Error!!.";
            }
        }

    }
    if (isset($_POST['submit']) && isset($_POST['action']) && $_POST['action'] == "new")
    {
        $Update = mysqli_query($DB_CONN, "insert into holidays (`date`, `description`)  values('{$_POST['date']}', '{$_POST['description']}')") or die(mysqli_error($DB_CONN));
        $msg = "Operation Successfull!";
    }
    else
    {
        $msg = "Error!!!.";
    }
?>

                                     <div class="card mb-2">
                                        <div class="card-header min-h-unset py-2">
                                            <h3 class="card-title align-items-start flex-column m-0">
                                                 <span class="card-label fw-bold text-gray-900">Earnings Holidays</span>
                                               <span class="text-gray-500 mt-1 fw-semibold fs-6"></span>
                                            </h3>
                                            
                                        </div>
                                <div class="card-body">
                                            <!--begin:::Tabs-->
                                                                <div class="table-responsive">
                                    <table  class="table table-sm table-striped table-bordered display dataTable no-footer">
                                        <thead class="">
                                            <tr>
                                                <th>#</th>
                                            <th>Date</th>
                                            <th>Description</th>
                                            <th>Actions</th>
                                        </tr>
                                            </thead>

                                
                                    <tbody>
                                        <?php
    $round = mysqli_query($DB_CONN, "select * from holidays order by id DESC") or die(mysqli_error($DB_CONN));

    if ($round && mysqli_num_rows($round) > 0)
    {
        $i = 0;
        while ($Package = mysqli_fetch_assoc($round))
        {
            echo '<tr>
                <td>' . ++$i . '</td>
                <td>' . $Package['date'] . '</td>
                <td>' . $Package['description'] . '</td>
              
                <td>
               
               
                <form action="" class="float:right;" method="post" id="form_' . $Package['id'] . '">

                <input type="hidden" name="action" value="delete" />
                <input type="hidden" name="package_id" value="' . $Package['id'] . '" />
                <input type="submit" name="submit" class="btn btn-danger btn-sm" value="Delete" onclick="return confirm(\'Do you Realy Want to Delete?\')"  />
                </form>';

        }
        echo '</td>
                </tr>';
    }

    else
    {
        echo '<tr><th colspan="5">Holidays Not Available !</th></tr>';
    } ?>
                                    </tbody>
                                    </table>
    </div>
    <!--end::Card body-->
</div>  </div>
     <div class="card mt-5">
<div class="card-header min-h-unset py-2" role="button" data-bs-toggle="collapse" data-bs-target="#kt_account_profile_details" aria-expanded="true" aria-controls="kt_account_profile_details">
        <!--begin::Card title-->
        <div class="card-title m-0">
            <h3 class="fw-bold m-0 fs-5">Add New Holidays</h3>
        </div>
        <!--end::Card title-->
    </div>
            <div class="card-body">

<form method="post" action="admin?page=holidays" class="form-horizontal">
<fieldset>
<div class="col-sm-12">
<div class="form-group">
    <label class="fs-9"><strong>Select Date</strong> </label>

    <input type="date" name="date" value="" class="form-control form-control-sm">
        <small id="" class="form-text text-muted fs-9">Select the date you want a holiday.</small>
</div>

<div class="form-group">
    <label class="fs-9"><strong>Description</strong> </label>

    <input type="text" name="description" placeholder="Description" required="" value="" class="form-control">
    <small class="fs-9"> Write the description of your holidays </small>
</div>

</div>      


</div>
<div class="card-footer d-flex justify-content-end py-6 px-9">
    <input type="hidden" name="action" value="new"> 
    <button type="submit" name="submit" class="btn btn-primary" id="kt_account_profile_details_submit">Add Holiday</button>
    
</div>

</form></div>                           
<?
}
if ($_GET['page'] == 'languages'){ 
?>
<div class="card mb-3">
    <div class="card-header py-3 d-flex align-items-center justify-content-between">
        <div>
            <h3 class="card-title m-0 fw-bold fs-4">Languages</h3>
            <span class="text-muted fs-7">Manage multiple languages for your application</span>
        </div>
       <button type="button" class="btn btn-sm btn-primary" id="addLanguageButton">
    <i class="ki-duotone ki-plus fs-6 me-1"></i>Add Language
</button>
    </div>
    
    <div class="card-body">
        <div id="messageContainer"></div>
        <div class="table-responsive">
            <table class="table table-row-bordered table-hover align-middle gs-4 gy-2">
               <thead class="bg-light">
    <tr class="text-muted fw-bold">
        <th class="min-w-50px">ID</th>
        <th class="min-w-100px">Code</th>
        <th class="min-w-200px">Language</th>
        <th class="min-w-100px">Status</th>
        <th class="min-w-150px">Translations</th>
        <th class="min-w-100px text-end">Actions</th>
    </tr>
</thead>
                <tbody id="languagesTableBody">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="languageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="modalTitle">Manage Language</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="languageForm">
                <input type="hidden" name="id" id="languageId">
                <input type="hidden" name="operation" id="operation" value="add">
                
                <div class="modal-body">
                    <!-- Basic Settings Section -->
                    <div class="mb-4">
                        <h6 class="fw-bold mb-3">Basic Settings</h6>
                        <div class="mb-4">
                            <label class="form-label required">Language Code</label>
                            <input type="text" class="form-control form-control-sm" 
                                   name="code" id="languageCode" required 
                                   placeholder="EN, FR, ES, etc."
                                   pattern="[A-Za-z]{2,3}">
                            <div class="form-text">Enter 2-3 letter language code (e.g., EN, FR, DE)</div>
                        </div>
                        <div class="mb-4">
                            <label class="form-label required">Language Name</label>
                            <input type="text" class="form-control form-control-sm" 
                                   name="name" id="languageName" required 
                                   placeholder="English, French, etc.">
                        </div>
                        <div class="mb-4">
                            <label class="form-label required">Status</label>
                            <select name="status" id="languageStatus" class="form-select form-select-sm" required>
                                <option value="1">Active</option>
                                <option value="0">Inactive</option>
                            </select>
                        </div>
                    </div>

                    <!-- Translation Settings Section -->
                    <div class="mb-4">
                        <h6 class="fw-bold mb-3">Translation Settings</h6>
                        <div id="translationOptionsLabel" class="text-muted mb-2">
                            Select content to copy (without translation):
                        </div>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" 
                                   name="translate" id="translateToggle">
                            <label class="form-check-label" for="translateToggle">
                                Enable Auto-Translation
                            </label>
                        </div>
                        <div id="translationOptions" class="ps-4">
                            <!-- Content translation option -->
                            <div class="form-check mb-2">
                                <input class="form-check-input translation-option" type="checkbox" 
                                       name="translate_content" id="translateContent">
                                <label class="form-check-label" for="translateContent">
                                    Content
                                </label>
                                <div class="form-text text-muted">Website content and interface elements</div>
                            </div>
                            
                           <div class="form-check mb-2">
                                <input class="form-check-input translation-option" type="checkbox" 
                                       name="translate_alerts" id="translateAlerts" >
                                <label class="form-check-label" for="translateAlerts">
                                    Translate Alerts
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input translation-option" type="checkbox" 
                                       name="translate_faqs" id="translateFaqs" >
                                <label class="form-check-label" for="translateFaqs">
                                    Translate FAQs
                                </label>
                            </div>
                                                    <div class="form-check mb-2">
                            <input class="form-check-input translation-option" type="checkbox" 
                                   name="translate_categories" id="translateCategories" >
                            <label class="form-check-label" for="translateCategories">
                                Translate Categories
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input translation-option" type="checkbox" 
                                   name="translate_news" id="translateNews" >
                            <label class="form-check-label" for="translateNews">
                                Translate News
                            </label>
                        </div>
                         <div class="form-check">
                            <input class="form-check-input translation-option" type="checkbox" 
                                   name="translate_tasks" id="translateTasks" >
                            <label class="form-check-label" for="translateTasks">
                                Translate Tasks
                            </label>
                        </div>
                          <div class="form-check">
                            <input class="form-check-input translation-option" type="checkbox" 
                                   name="translate_bot" id="translateBot" >
                            <label class="form-check-label" for="translateBot">
                                Translate Telegram Bot
                            </label>
                        </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary btn-sm" id="submitButton">
                        <span class="indicator-label">Save Changes</span>
                        <span class="indicator-progress">Please wait...
                            <span class="spinner-border spinner-border-sm ms-2"></span>
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>




<script>
    // Show modal for adding or editing a language
function showLanguageModal(id = null) {
    const modal = document.getElementById('languageModal');
    const form = document.getElementById('languageForm');
    const modalTitle = document.getElementById('modalTitle');
    const submitButton = document.getElementById('submitButton').querySelector('.indicator-label');
    const operation = document.getElementById('operation');
    
    // Reset form
    form.reset();
    
    if (id) {
        // Edit mode
        modalTitle.textContent = 'Edit Language';
        submitButton.textContent = 'Update Language';
        operation.value = 'update';
        
        // Load language data
        loadLanguageData(id);
    } else {
        // Add mode
        modalTitle.textContent = 'Add New Language';
        submitButton.textContent = 'Add Language';
        operation.value = 'add';
        document.getElementById('languageId').value = '';
        
        // Enable checkboxes but don't check them
        enableTranslationOptions(false);
        updateTranslationLabel(false);
    }
    
    // Show the modal
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();
}

// Load language data for editing
function loadLanguageData(id) {
    const formData = new FormData();
    formData.append('action', 'edit');
    formData.append('id', id);

    fetch('admin.php?page=lang', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const lang = data.data;
            // Set form values
            document.getElementById('languageId').value = lang.id;
            document.getElementById('languageCode').value = lang.code;
            document.getElementById('languageName').value = lang.name;
            document.getElementById('languageStatus').value = lang.status;

            // Handle translation settings
            const translationStatus = JSON.parse(lang.translation_status || '{}');
            const translateToggle = document.getElementById('translateToggle');
            
            // Set the toggle state based on translation status
            const hasTranslations = Object.values(translationStatus).some(status => status);
            translateToggle.checked = hasTranslations;
            
            // Enable checkboxes and update label
            enableTranslationOptions(true);
            updateTranslationLabel(translateToggle.checked);
            
            // Set individual translation checkboxes
            const contentTypes = ['content', 'alerts', 'faqs', 'tasks', 'categories', 'news', 'telegram_bot'];
            contentTypes.forEach(type => {
                const fieldName = type === 'telegram_bot' ? 'bot' : type;
                const checkbox = document.getElementById(`translate${fieldName.charAt(0).toUpperCase() + fieldName.slice(1)}`);
                if (checkbox) {
                    checkbox.checked = translationStatus[type] || false;
                }
            });
        } else {
            showMessage('Failed to load language data', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error loading language data', 'danger');
    });
}

// Update translation label based on toggle state
function updateTranslationLabel(isTranslationEnabled) {
    const label = document.getElementById('translationOptionsLabel');
    if (isTranslationEnabled) {
        label.textContent = 'Select content to translate:';
    } else {
        label.textContent = 'Select content to copy (without translation):';
    }
}

// Enable or disable translation options
function enableTranslationOptions(isTranslating) {
    // Update visibility but don't disable inputs
    document.getElementById('translationOptions').style.opacity = 
        isTranslating ? '1' : '0.7';
    
    // Update label text
    updateTranslationLabel(isTranslating);
}

// Initialize translation toggle behavior
function initializeTranslationToggle() {
    const translateToggle = document.getElementById('translateToggle');
    
    translateToggle.addEventListener('change', function() {
        updateTranslationLabel(this.checked);
        document.getElementById('translationOptions').classList.toggle('translation-enabled', this.checked);
    });
}

// Handle form submission
function initializeFormHandler() {
    const form = document.getElementById('languageForm');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (form.dataset.submitting === 'true') {
            return;
        }
        
        // Set submitting state
        form.dataset.submitting = 'true';
        
        const submitButton = form.querySelector('[type="submit"]');
        submitButton.setAttribute('data-kt-indicator', 'on');
        submitButton.disabled = true;
        
        // Prepare form data
        const formData = new FormData(form);
        const operation = formData.get('operation');
        formData.set('action', operation);  // 'add' or 'update'
        
        // Handle checkbox values
        const translateToggle = form.querySelector('#translateToggle');
        formData.set('translate', translateToggle.checked.toString());
        
        // Always include translation options, even if toggle is off
        // This allows copying without translation
        const contentTypes = ['content', 'alerts', 'faqs', 'tasks', 'categories', 'news', 'bot'];
        contentTypes.forEach(type => {
            const checkbox = form.querySelector(`#translate${type.charAt(0).toUpperCase() + type.slice(1)}`);
            if (checkbox) {
                formData.set(`translate_${type}`, checkbox.checked.toString());
            }
        });
        
        // Submit form data
        fetch('admin.php?page=lang', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            handleFormResponse(data, form);
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('An error occurred while processing your request', 'danger');
        })
        .finally(() => {
            // Reset submitting state
            submitButton.removeAttribute('data-kt-indicator');
            submitButton.disabled = false;
            form.dataset.submitting = 'false';
        });
    });
}

// Handle form response
function handleFormResponse(data, form) {
    if (data.success) {
        let message = data.message;
     
        // Add translation status to success message if available
        if (data.translations && Object.keys(data.translations).length > 0) {
            message += '<br><br>Translation Status:';
            message += '<ul class="mb-0">';
            for (const [type, status] of Object.entries(data.translations)) {
                let displayType = type.charAt(0).toUpperCase() + type.slice(1);
                if (type === 'telegram_bot') displayType = 'Telegram Bot';
                message += `<li>${displayType}: ${status ? 'Success' : 'Failed'}</li>`;
            }
            message += '</ul>';
        }
 
        // Show standard success message
        showMessage(message, 'success');
        loadLanguages();
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('languageModal'));
        modal.hide();
        
        // Reset form
        form.reset();
        
        // Show license required popup if needed
        if (data.license_required) {
            showLicenseAlert();
        }
    } else {
        showMessage(data.message, 'danger');
    }
}
function showLicenseAlert() {
    Swal.fire({
        title: 'Translation License Required',
        html: `
            <div class="text-start">
                <p>Your content was successfully copied without translation due to licensing limitations.</p>
                <p>To enable automatic translation capabilities:</p>
                <ul>
                    <li>Buy a Translation license for your website</li>
                    <li>Translate content between multiple languages</li>
                    <li>Save time and resources on manual translations</li>
                </ul>
            </div>
        `,
        icon: 'info',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Purchase License',
        cancelButtonText: 'Not Now',
        footer: '<a href="https://t.me/bitdersteam" target="_blank" class="btn btn-info">Contact us on Telegram</a>'
    }).then((result) => {
        if (result.isConfirmed) {
            // Open in a new window/tab
            window.open('https://bitders.com/', '_blank');
        }
    });
}
document.addEventListener('DOMContentLoaded', function() {
    loadLanguages();
    initializeTranslationToggle();
    initializeFormHandler();
    initializeComponents();
    
    // Add button event listener
    document.getElementById('addLanguageButton').addEventListener('click', function() {
        showLanguageModal();
    });
});





function loadLanguages() {
    const formData = new FormData();
    formData.append('action', 'list');

    fetch('admin.php?page=lang', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            renderLanguagesTable(data.data);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error loading languages.', 'danger');
    });
}

function renderLanguagesTable(languages) {
    const tbody = document.getElementById('languagesTableBody');
    tbody.innerHTML = languages.map(lang => `
        <tr>
            <td>${lang.id}</td>
            <td><span class="text-gray-800 fw-bold">${lang.code}</span></td>
            <td>
                <div class="d-flex align-items-center">
                    <div class="symbol symbol-30px me-3">
                        <span class="symbol-label bg-light-primary">
                            ${lang.name.substring(0, 2).toUpperCase()}
                        </span>
                    </div>
                    <span class="text-gray-800">${lang.name}</span>
                </div>
            </td>
            <td>${lang.status_badge}</td>
            <td>
                <div class="d-flex flex-column">
                    ${renderTranslationBadges(lang.translations)}
                </div>
            </td>
            <td class="text-end">
                <div class="d-flex justify-content-end flex-shrink-0">

                    ${Number(lang.id) !== 1 ? `
                                          <button onclick="showLanguageModal(${lang.id})" 
            class="btn btn-icon btn-sm btn-light-primary me-2"
            data-bs-toggle="tooltip"
            data-bs-placement="top"
            title="Edit Language">
        <i class="ki-duotone ki-pencil fs-2">
            <span class="path1"></span>
            <span class="path2"></span>
        </i>
    </button>
                        <button onclick="deleteLanguage(${lang.id})" 
                                class="btn btn-icon btn-sm btn-light-danger"
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                title="Delete Language">
                            <i class="ki-duotone ki-trash fs-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                                <span class="path4"></span>
                                <span class="path5"></span>
                            </i>
                        </button>
                    ` : ''}
                </div>
            </td>
        </tr>
    `).join('');

    // Reinitialize tooltips after rendering
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
}

function renderTranslationBadges(translations) {
    if (!translations) return '<span class="badge badge-light-warning fs-8">No translations</span>';

    const badges = [];
    if (translations.content) {
        badges.push('<span class="badge badge-light-success fs-8 mb-1">Content</span>');
    }
    if (translations.alerts) {
        badges.push('<span class="badge badge-light-success fs-8 mb-1">Alerts</span>');
    }
    if (translations.faqs) {
        badges.push('<span class="badge badge-light-success fs-8 mb-1">FAQs</span>');
    }
     if (translations.tasks) {
        badges.push('<span class="badge badge-light-success fs-8 mb-1">Tasks</span>');
    }
    if (translations.categories) {
        badges.push('<span class="badge badge-light-success fs-8 mb-1">Categories</span>');
    }
    if (translations.news) {
        badges.push('<span class="badge badge-light-success fs-8 mb-1">News</span>');
    }
if (translations.telegram_bot) {
    badges.push('<span class="badge badge-light-success fs-8 mb-1">Bot</span>');
}

    return badges.length ? badges.join(' ') : '<span class="badge badge-light-warning fs-8">No translations</span>';
}



function deleteLanguage(id) {
    if (confirm('Are you sure you want to delete this language? This action will remove all associated content.')) {
        const formData = new FormData();
        formData.append('action', 'delete');
        formData.append('id', id);

        const loadingOverlay = showLoadingOverlay();
        
        fetch('admin.php?page=lang', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            showMessage(data.message, data.success ? 'success' : 'danger');
            if (data.success) {
                loadLanguages();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('Error deleting language.', 'danger');
        })
        .finally(() => {
            removeLoadingOverlay(loadingOverlay);
        });
    }
}

function showMessage(message, type) {
    const container = document.getElementById('messageContainer');
    
    // Create alert element
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    // Clear existing messages and add new one
    container.innerHTML = '';
    container.appendChild(alert);
    
    // Auto-dismiss success messages after 5 seconds
    if (type === 'success') {
        setTimeout(() => {
            const bootstrapAlert = bootstrap.Alert.getOrCreateInstance(alert);
            bootstrapAlert.close();
        }, 5000);
    }
}

function showLoadingOverlay() {
    const overlay = document.createElement('div');
    overlay.className = 'position-fixed w-100 h-100 top-0 start-0 d-flex align-items-center justify-content-center';
    overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.2)';
    overlay.style.zIndex = '9999';
    
    const spinner = document.createElement('div');
    spinner.className = 'spinner-border text-primary';
    spinner.setAttribute('role', 'status');
    spinner.innerHTML = '<span class="visually-hidden">Loading...</span>';
    
    overlay.appendChild(spinner);
    document.body.appendChild(overlay);
    
    return overlay;
}

function removeLoadingOverlay(overlay) {
    if (overlay && overlay.parentNode) {
        overlay.parentNode.removeChild(overlay);
    }
}

// Utility function to format dates
function formatDate(dateString) {
    const options = { year: 'numeric', month: 'short', day: 'numeric' };
    return new Date(dateString).toLocaleDateString(undefined, options);
}

// Initialize tooltips and other Bootstrap components
function initializeComponents() {
    // Initialize all tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Initialize any other Bootstrap components here
}

// Handle form validation
function validateForm(form) {
    const requiredFields = form.querySelectorAll('[required]');
    let isValid = true;
    
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            isValid = false;
            field.classList.add('is-invalid');
            
            // Add validation message if it doesn't exist
            let feedback = field.nextElementSibling;
            if (!feedback || !feedback.classList.contains('invalid-feedback')) {
                feedback = document.createElement('div');
                feedback.className = 'invalid-feedback';
                feedback.textContent = 'This field is required';
                field.parentNode.insertBefore(feedback, field.nextSibling);
            }
        } else {
            field.classList.remove('is-invalid');
            const feedback = field.nextElementSibling;
            if (feedback && feedback.classList.contains('invalid-feedback')) {
                feedback.remove();
            }
        }
    });
    
    return isValid;
}

// Error handler function
function handleError(error, message = 'An error occurred') {
    console.error('Error:', error);
    showMessage(message, 'danger');
}

// Handle form reset
function resetForm(formId, modalId) {
    const form = document.getElementById(formId);
    const modal = bootstrap.Modal.getInstance(document.getElementById(modalId));
    
    if (form) {
        form.reset();
        // Remove any validation classes
        form.querySelectorAll('.is-invalid').forEach(field => {
            field.classList.remove('is-invalid');
        });
        // Remove any validation messages
        form.querySelectorAll('.invalid-feedback').forEach(feedback => {
            feedback.remove();
        });
    }
    
    if (modal) {
        modal.hide();
    }
}



</script>
<?
}
if ($_GET['page'] == 'system')
{ ?>
<div class="card mb-2">
                                        <div class="card-header min-h-unset py-2">
                                            <div class="card-title m-0">
                                                <h3 class="fw-bold m-0 fs-5">System</h3>
                                            </div>
                                        </div>
                                <div class="card-body">
                                    <h4 class="card-title"></h4>
                                     <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Check for Updates Automatically</a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable to check for Automatic Updates from Bitders.com</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="auto_updates" id="auto_updates"  value="true"
                    <?=$versions['auto_updates'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="auto_updates"></label>
                </div>
            </div>
        </div>
                                        <div class="row">
                          <table class="table align-middle table-row-dashed fs-6 fw-bold gs-0 gy-4 p-0 m-0">
                                <thead class="border-bottom border-gray-200 fs-7 text-uppercase fw-bold">
                                  <tr class=" text-gray-500">
                                  <th>System</th>
                                  <th>Status</th>
                                  <th>Detail</th>
                              </tr>
                              </thead>
                              <tbody>
                              <tr>
    <td>Script</td>
    <td><span class="badge <?php echo ($versions['script_update_available']) ? 'badge-light-warning' : 'badge-light-success'; ?> fs-7 fw-bold"><?php echo ($versions['script_update_available']) ? 'Update Available' : 'Latest'; ?></span></td>
    <td><?php echo $versions['script']?>
        <button id="check-script-update" class="btn btn-sm <?php echo ($versions['script_update_available']) ? 'btn-light-warning' : 'btn-light-primary'; ?> ms-2 p-1">
            <?php echo ($versions['script_update_available']) ? 'Update Now' : 'Check for Update'; ?>
        </button>
    </td>
</tr>
<tr>
    <td>Nextjs APP</td>
    <td><span class="badge <?php echo ($versions['app_update_available']) ? 'badge-light-warning' : 'badge-light-success'; ?> fs-7 fw-bold"><?php echo ($versions['app_update_available']) ? 'Update Available' : 'Latest'; ?></span></td>
    <td><?php echo $versions['app']?> 
        <button id="check-app-update" class="btn btn-sm <?php echo ($versions['app_update_available']) ? 'btn-light-warning' : 'btn-light-primary'; ?> ms-2 p-1">
            <?php echo ($versions['app_update_available']) ? 'Update Now' : 'Check for Update'; ?>
        </button>
    </td>
</tr>
                                                           
                               <tr>
                                  <td>PHP Version</td>
                                  <td><span class="badge badge-light-success fs-7 fw-bold">OK</span></td>
                                  <td><? echo phpversion();?></td>
                              </tr>
                               <tr>
                                  <td>Server Software</td>
                                  <td><span class="badge badge-light-success fs-7 fw-bold">OK</span></td>
                                  <td><? echo $_SERVER['SERVER_SOFTWARE'];?></td>
                              </tr>
                               <tr>
                                  <td>Server IP Address</td>
                                  <td><span class="badge badge-light-success fs-7 fw-bold">OK</span></td>
                                  <td><? echo $_SERVER['SERVER_ADDR'];?></td>
                              </tr>
                               <tr>
                                  <td>Server Protocol</td>
                                  <td><span class="badge badge-light-success fs-7 fw-bold">OK</span></td>
                                  <td><? echo $_SERVER['SERVER_PROTOCOL'];?></td>
                              </tr>
                               <tr>
                                  <td>HTTP Host</td>
                                  <td><span class="badge badge-light-success fs-7 fw-bold">OK</span></td>
                                  <td><? echo $_SERVER['HTTP_HOST'];?></td>
                              </tr>
                               <tr>
                                  <td>Server Port</td>
                                  <td><span class="badge badge-light-success fs-7 fw-bold">OK</span></td>
                                  <td><? echo $_SERVER['SERVER_PORT'];?></td>
                              </tr>
                              </tbody>
                              
                          </table>
                               
                                     
                                    </div>
                                </div>
                                </div>
<!-- Add the following script at the end of your page (just before closing the card-body div) -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
    const autoUpdateCheckbox = document.getElementById('auto_updates');
    
    if (autoUpdateCheckbox) {
        autoUpdateCheckbox.addEventListener('change', function() {
            updateAutoUpdatePreference(this.checked);
        });
    }
    
    function updateAutoUpdatePreference(isChecked) {
        // Create form data
        const formData = new FormData();
        formData.append('action', 'update_auto_updates');
        formData.append('auto_updates', isChecked ? 'true' : 'false');
        
        // Send AJAX request
        fetch('admin?page=update_auto_updates', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
       .then(data => {
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: 'Auto-update setting saved successfully',
                    timer: 2000,
                    showConfirmButton: false
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'Failed to save auto-update setting'
                });
            }
        })
        .catch(error => {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'An unexpected error occurred. Please try again.'
            });
            console.error('Error:', error);
        });
    }
});
document.addEventListener('DOMContentLoaded', function() {
    // Get script and app versions directly from PHP variables
    const scriptVersion = '<? echo $versions['script']?>';
    const appVersion = '<? echo $versions['app']?>';
    
    const domainName = window.location.hostname;
    
    document.getElementById('check-script-update').addEventListener('click', function() {
        Swal.fire({
            title: 'Checking for Script Updates',
            text: 'Please wait while we check for the latest version...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
                fetch('bitder?check_script_update=1')
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            if (data.update_available) {
                                let changelogHtml = '<div class="mt-3 mb-3"><h6 class="fw-bold">What\'s New:</h6><ul>';
                                
                                data.changelog.forEach(item => {
                                    let badgeClass = '';
                                    let typeLabel = '';
                                    
                                    switch(item.change_type) {
                                        case 'feature': 
                                            badgeClass = 'success';
                                            typeLabel = 'Feature';
                                            break;
                                        case 'improvement': 
                                            badgeClass = 'info';
                                            typeLabel = 'Improvement';
                                            break;
                                        case 'bugfix': 
                                            badgeClass = 'warning';
                                            typeLabel = 'Bug Fix';
                                            break;
                                        case 'security': 
                                            badgeClass = 'danger';
                                            typeLabel = 'Security';
                                            break;
                                    }
                                    
                                    let importanceIndicator = '';
                                    if (item.importance === 'critical') {
                                        importanceIndicator = ' <span class="fw-bold text-danger">[CRITICAL]</span>';
                                    } else if (item.importance === 'high') {
                                        importanceIndicator = ' <span class="fw-bold text-warning">[Important]</span>';
                                    }
                                    
                                    changelogHtml += `<li><span class="badge bg-${badgeClass} mb-1">${typeLabel}</span>${importanceIndicator} ${item.description}</li>`;
                                });
                                
                                changelogHtml += '</ul></div>';
                                
                                Swal.fire({
                                    icon: 'info',
                                    title: 'Update Available',
                                    html: `
                                        <div class="text-start">
                                            <p>Current version: <span class="fw-bold">${scriptVersion}</span><br>
                                            Latest version: <span class="fw-bold">${data.version}</span></p>
                                            ${changelogHtml}
                                        </div>
                                    `,
                                    showCancelButton: true,
                                    confirmButtonText: 'Update Now',
                                    cancelButtonText: 'Later'
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        Swal.fire({
                                            title: 'Updating System',
                                            html: 'Please wait while we download and install the update...',
                                            allowOutsideClick: false,
                                            didOpen: () => {
                                                Swal.showLoading();
                                                fetch('bitder?update=1')
                                                    .then(response => response.json())
                                                    .then(result => {
                                                        if (result.success) {
                                                            Swal.fire({
                                                                icon: 'success',
                                                                title: 'Update Complete',
                                                                text: 'The update was successfully installed. The page will now reload.',
                                                                allowOutsideClick: false
                                                            }).then(() => {
                                                                window.location.reload();
                                                            });
                                                        } else {
                                                            Swal.fire({
                                                                icon: 'error',
                                                                title: 'Update Failed',
                                                                text: 'There was an error during the update: ' + result.message
                                                            });
                                                        }
                                                    })
                                                    .catch(error => {
                                                        Swal.fire({
                                                            icon: 'error',
                                                            title: 'Update Error',
                                                            text: 'Failed to complete the update process'
                                                        });
                                                    });
                                            }
                                        });
                                    }
                                });
                            } else {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'System Up to Date',
                                    text: `You are running the latest version (${scriptVersion}).`
                                });
                            }
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error Checking Updates',
                                text: data.message || 'Could not retrieve version information.'
                            });
                        }
                    })
                    .catch(error => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Connection Error',
                            text: 'Could not connect to update server. Please try again later.'
                        });
                    });
            }
        });
    });
    
    document.getElementById('check-app-update').addEventListener('click', function() {
        Swal.fire({
            title: 'Checking for App Updates',
            text: 'Please wait while we check for the latest version...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
                fetch('bitder?check_app_update=1')
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            if (data.update_available) {
                                let changelogHtml = '<div class="mt-3 mb-3"><h6 class="fw-bold">What\'s New:</h6><ul>';
                                
                                data.changelog.forEach(item => {
                                    let badgeClass = '';
                                    let typeLabel = '';
                                    
                                    switch(item.change_type) {
                                        case 'feature': 
                                            badgeClass = 'success';
                                            typeLabel = 'Feature';
                                            break;
                                        case 'improvement': 
                                            badgeClass = 'info';
                                            typeLabel = 'Improvement';
                                            break;
                                        case 'bugfix': 
                                            badgeClass = 'warning';
                                            typeLabel = 'Bug Fix';
                                            break;
                                        case 'security': 
                                            badgeClass = 'danger';
                                            typeLabel = 'Security';
                                            break;
                                    }
                                    
                                    let importanceIndicator = '';
                                    if (item.importance === 'critical') {
                                        importanceIndicator = ' <span class="fw-bold text-danger">[CRITICAL]</span>';
                                    } else if (item.importance === 'high') {
                                        importanceIndicator = ' <span class="fw-bold text-warning">[Important]</span>';
                                    }
                                    
                                    changelogHtml += `<li><span class="badge bg-${badgeClass} mb-1">${typeLabel}</span>${importanceIndicator} ${item.description}</li>`;
                                });
                                
                                changelogHtml += '</ul></div>';
                                
                                Swal.fire({
                                    icon: 'info',
                                    title: 'App Update Available',
                                    html: `
                                        <div class="text-start">
                                            <p>Current version: <span class="fw-bold">${appVersion}</span><br>
                                            Latest version: <span class="fw-bold">${data.version}</span></p>
                                            ${changelogHtml}
                                        </div>
                                    `,
                                    showCancelButton: true,
                                    confirmButtonText: 'Update Now',
                                    cancelButtonText: 'Later'
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        Swal.fire({
                                            title: 'Updating App',
                                            html: 'Please wait while we download and install the update...',
                                            allowOutsideClick: false,
                                            didOpen: () => {
                                                Swal.showLoading();
                                                fetch('bitder?app_update=1')
                                                    .then(response => response.json())
                                                    .then(result => {
                                                        if (result.success) {
                                                            Swal.fire({
                                                                icon: 'success',
                                                                title: 'Update Complete',
                                                                text: 'The app update was successfully installed. ',
                                                                allowOutsideClick: false
                                                            }).then(() => {
                                                                window.location.reload();
                                                            });
                                                        } else {
                                                            Swal.fire({
                                                                icon: 'error',
                                                                title: 'Update Failed',
                                                                text: 'There was an error during the app update: ' + result.message
                                                            });
                                                        }
                                                    })
                                                    .catch(error => {
                                                        Swal.fire({
                                                            icon: 'error',
                                                            title: 'Update Error',
                                                            text: 'Failed to complete the app update process'
                                                        });
                                                    });
                                            }
                                        });
                                    }
                                });
                            } else {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'App Up to Date',
                                    text: `You are running the latest version (${appVersion}).`
                                });
                            }
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error Checking Updates',
                                text: data.message || 'Could not retrieve version information.'
                            });
                        }
                    })
                    .catch(error => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Connection Error',
                            text: 'Could not connect to update server. Please try again later.'
                        });
                    });
            }
        });
    });
});
</script>
<?
}
if ($_GET['page'] == 'main_settings')
{
    $select_detail = mysqli_query($DB_CONN, "select * from preferences");
    $row_detail = mysqli_fetch_assoc($select_detail);
    $deposit_settings = json_decode($row_detail['deposit_settings'], true);
    $withdraw_settings = json_decode($row_detail['withdraw_settings'], true);
    $transfer_settings = json_decode($row_detail['transfer_settings'], true);
    $exchange_settings = json_decode($row_detail['exchange_settings'], true);
    $register_settings = json_decode($row_detail['register_settings'], true);
    $login_settings = json_decode($row_detail['login_settings'], true);
    $user_settings = json_decode($row_detail['user_settings'], true);
    $idd = $row_detail['id'];

    if (isset($_POST['submit']))
    {
        
        $alter = validateAdminAuth($admin_settings, $_POST['alternative_passphrase'], 'site');
        if ($alter){
       
        $deposit_settings = mysqli_real_escape_string($DB_CONN, json_encode(array_map('cleanContent', $_POST['deposit'])));
        $withdraw_settings = mysqli_real_escape_string($DB_CONN, json_encode(array_map('cleanContent', $_POST['withdraw'])));
        $transfer_settings = mysqli_real_escape_string($DB_CONN, json_encode(array_map('cleanContent', $_POST['transfer'])));
        $exchange_settings = mysqli_real_escape_string($DB_CONN, json_encode(array_map('cleanContent', $_POST['exchange'])));
        $register_settings = mysqli_real_escape_string($DB_CONN, json_encode(array_map('cleanContent', $_POST['register'])));
        $login_settings = mysqli_real_escape_string($DB_CONN, json_encode(array_map('cleanContent', $_POST['login'])));
        $user_settings = mysqli_real_escape_string($DB_CONN, json_encode(array_map('cleanContent', $_POST['user'])));
if (isset($_POST['trading']['time_options']) && is_array($_POST['trading']['time_options'])) {
    $time_options = [];
    foreach ($_POST['trading']['time_options'] as $option) {
        if (isset($option['value']) && isset($option['label'])) {
            // Use cleanContent for consistency, but ensure values remain numeric
            $value = filter_var($option['value'], FILTER_SANITIZE_NUMBER_INT);
            $label = cleanContent($option['label']);
            
            if ($value > 0) {
                $time_options[] = [
                    'value' => (string)$value, // Convert to string for consistent handling
                    'label' => $label
                ];
            }
        }
    }
    $_POST['trading']['time_options'] = $time_options;
}

$trading_settings = mysqli_real_escape_string($DB_CONN, json_encode(array_map('cleanContent', $_POST['trading'])));
        $update_main_settings = mysqli_query($DB_CONN, "UPDATE preferences set  register_settings = '{$register_settings}',login_settings = '{$login_settings}', deposit_settings = '{$deposit_settings}',withdraw_settings = '{$withdraw_settings}',transfer_settings = '{$transfer_settings}',exchange_settings = '{$exchange_settings}',user_settings = '{$user_settings}',trading_settings = '{$trading_settings}' WHERE id='$idd'");

        if ($update_main_settings)
        {
            updateSiteData($siteURL);
            
            echo '<div class="alert alert-success">      Updated Successfully ! </div>';
        }else{
             echo '<div class="alert alert-success">      Nope </div>';
        }
        $select_detail = mysqli_query($DB_CONN, "select * from preferences");
        $row_detail = mysqli_fetch_assoc($select_detail);
        $deposit_settings = array_map('cleanContent', json_decode($row_detail['deposit_settings'], true));
        $withdraw_settings = array_map('cleanContent', json_decode($row_detail['withdraw_settings'], true));
        $transfer_settings = array_map('cleanContent', json_decode($row_detail['transfer_settings'], true));
        $exchange_settings = array_map('cleanContent', json_decode($row_detail['exchange_settings'], true));
        $register_settings = array_map('cleanContent', json_decode($row_detail['register_settings'], true));
        $login_settings = array_map('cleanContent', json_decode($row_detail['login_settings'], true));
        $user_settings = array_map('cleanContent', json_decode($row_detail['user_settings'], true));
        $trading_settings = array_map('cleanContent', json_decode($row_detail['trading_settings'], true));
        $idd = $row_detail['id'];
    }
    }

    $scheme = parse_url($row_detail['domain']) ['scheme'];

    $select_detail = mysqli_query($DB_CONN, "select * from preferences");
    $row_detail = mysqli_fetch_assoc($select_detail);
    $saved_datetime = isset($row_detail['datetime']) ? $row_detail['datetime'] : '';
$datetime_obj = $saved_datetime ? new DateTime($saved_datetime) : new DateTime();
$formatted_datetime = $datetime_obj->format('Y-m-d\TH:i');

?>
 <form method="POST">

<div class="row">
    <div class="col-6"><div class="card mb-2">
    <div class="card-header min-h-unset py-2">
        <div class="card-title m-0">
            <h3 class="fw-bold m-0 fs-5">Register Settings</h3>
        </div>
    </div>
    <div class="card-body py-3">

        <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Disable Registration</a>
                    <div class="fs-9 fw-semibold text-gray-500">Disable new Registration for site.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="register[disable]" id="disable"  value="true"
                    <?=$register_settings['disable'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="disable"></label>
                </div>
            </div>
        </div>
         <div class="separator separator-dashed my-2"></div>
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Force an Upline/Sponsor during register</a>
                    <div class="fs-9 fw-semibold text-gray-500">Defines whether a user must have an upline to register.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="register[sponsor_must]" id="sponsor_must" value="true" 
                    <?=$register_settings['sponsor_must'] == 'true' ? 'checked' : '' ?>> 
                    <label class="form-check-label fs-9" for="sponsor_must"></label>
                </div>
            </div>
        </div>
      
         <div class="separator separator-dashed my-2"></div>

        <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Payment Wallet Address  Field </a>
                    <div class="fs-9 fw-semibold text-gray-500">User can enter wallets while registering the account</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="register[wallets]" id="wallets"  value="true"
                    <?=$register_settings['wallets'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="wallets"></label>
                </div>
            </div>
        </div>
         <div class="separator separator-dashed my-2"></div>
        <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Use Phone Field</a>
                    <div class="fs-9 fw-semibold text-gray-500">Use Phone Field</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="register[phone]" id="phone"  value="true"
                    <?=$register_settings['phone'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="phone"></label>
                </div>
            </div>
        </div>
         <div class="separator separator-dashed my-2"></div>
        <!--begin::Item-->
               
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Use Location Field </a>
                    <div class="fs-9 fw-semibold text-gray-500">User Location Field</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="register[location]" id="location"  value="true"
                    <?=$register_settings['location'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="location"></label>
                </div>
            </div>
        </div>
         <div class="separator separator-dashed my-2"></div>
        <!--begin::Item-->
               
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Use Question Answer Field </a>
                    <div class="fs-9 fw-semibold text-gray-500">User Question Answer Field for support or security queries.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="register[questionanswer]" id="questionanswer"  value="true"
                    <?=$register_settings['questionanswer'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="questionanswer"></label>
                </div>
            </div>
        </div>
        
         <div class="separator separator-dashed my-2"></div>
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Must Confirm Email to activate account</a>
                    <div class="fs-9 fw-semibold text-gray-500">Opt in Confirm Email to activate account</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="register[double_optin_reg]" id="double_optin_reg"  value="true"
                    <?=$register_settings['double_optin_reg'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="double_optin_reg"></label>
                </div>
            </div>
        </div>
        
         <div class="separator separator-dashed my-2"></div>
    <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Must Enter Transaction Code to Register</a>
                    <div class="fs-9 fw-semibold text-gray-500">Pin Code can be used in Edit account and withdraw</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="register[pin_code]" id="pin_code_main"  value="true"
                    <?=$register_settings['pin_code'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="pin_code_main"></label>
                </div>
            </div>
        </div>
        
          <div class="separator separator-dashed my-2"></div>
    <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Must Enter Email Code to Register</a>
                    <div class="fs-9 fw-semibold text-gray-500">Email code will be sent to user email in order to activate account</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="register[email_code]" id="email_code"  value="true"
                    <?=$register_settings['email_code'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="email_code"></label>
                </div>
            </div>
        </div>
            <div class="separator separator-dashed my-2"></div>
    <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Give Bonus on New Registeration</a>
                    <div class="fs-9 fw-semibold text-gray-500">Give Bonus to User on Regisration </div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="register[register_bonus]" id="enableBon"  value="true"
                    <?=$register_settings['register_bonus'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="enableBon"></label>
                </div>
            </div>
        </div>
        <div class="row" id="register_bonusdiv">
             <div class="separator separator-dashed my-2"></div>

                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Register Bonus Amount:</label>
                       
                    </div>
                </div>
                <div class="col-md-8">
                    <input type="text" name="register[register_bonus_amount]" value="<?=$register_settings['register_bonus_amount'] ?>" class="form-control form-control-sm">
                    <label class="form-check-label fs-9" for="register_bonus_amount"></label>
                     <small class="fs-9"> Will be printed in transactions detail</small>
                </div>
                  <div class="separator separator-dashed my-2"></div>
                  <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Register Bonus Currency:</label>
                       
                    </div>
                </div>
                <div class="col-md-8">
                  <select class="form-select form-select-sm streak-input" name="register[register_bonus_currency]" >
                        <option value="">Select Payment</option>
                        <?php foreach($payments as $payment): ?>
                            <option value="<?=$payment['id']?>" <?=$register_settings['register_bonus_currency'] == $payment['id'] ? 'selected' : ''?>>
                                <?=$payment['name']?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                     </div>
        
         </div>
            
       
          <div class="separator separator-dashed my-2"></div>
        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9">Redirect after Registration </label>
                </div>
            </div>
            <div class="col-md-8">
                <select class="form-select form-select-sm" name="register[after_register]" value ="same_page" >
                    <option value="same_page"  <?=$register_settings['after_register'] == 'same_page' ? 'selected' : '' ?>>Stay on register.tpl</option>
                    <option value="after_registration_page" <?=$register_settings['after_register'] == 'after_registration_page' ? 'selected' : '' ?>>Redirect to register_redirect.tpl</option>
                    <option value="login_page" <?=$register_settings['after_register'] == 'login_page' ? 'selected' : '' ?>>Redirect to login</option>
                     <option value="login_redirect_page" <?=$register_settings['login_redirect_page'] == 'login_page' ? 'selected' : '' ?>>Redirect to login_redirect.tpl</option>
                     <option value="dashboard_page" <?=$register_settings['after_register'] == 'dashboard_page' ? 'selected' : '' ?>>Redirect to dashboardwithout login again.</option>
                      <option value="tap_page" <?=$register_settings['after_register'] == 'tap_page' ? 'selected' : '' ?>>Redirect to Tap Page without login again.</option>
                        <option value="home_page" <?=$register_settings['after_register'] == 'home_page' ? 'selected' : '' ?>>Redirect to Home Page without login again.</option>
                </select>
            </div>
        </div>
    </div>
    
</div></div>
<div class="col-6"><div class="card mb-2">
    <div class="card-header min-h-unset py-2">
        <div class="card-title m-0">
            <h3 class="fw-bold m-0 fs-5">Login Settings</h3>
        </div>
    </div>
    <div class="card-body py-3">

        <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Disable login</a>
                    <div class="fs-9 fw-semibold text-gray-500">Disable login for site.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="login[disable]" id="disable"  value="true"
                    <?=$login_settings['disable'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="disable"></label>
                </div>
            </div>
        </div>
         <div class="separator separator-dashed my-2"></div>

        <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable login with email </a>
                    <div class="fs-9 fw-semibold text-gray-500">User can enter email or username while login the account</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="login[login_with_email]" id="email"  value="true"
                    <?=$login_settings['login_with_email'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="wallets"></label>
                </div>
            </div>
        </div>
         <div id="phone_login">
          <div class="separator separator-dashed my-2"></div>
          <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable login with phone number </a>
                    <div class="fs-9 fw-semibold text-gray-500">User can enter phone or username while login the account</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="login[login_with_phone]" id="phone"  value="true"
                    <?=$login_settings['login_with_phone'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="phone"></label>
                </div>
            </div>
        </div>
        </div>
           <div class="pincode">
            
             <div class="separator separator-dashed my-2"></div>
        <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Must Use Transaction Code to login</a>
                    <div class="fs-9 fw-semibold text-gray-500">Must Enter Transaction Code.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="login[pin_code]" id="pin_code" value="true"
                    <?=$login_settings['pin_code'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="pin_code"></label>
                </div>
            </div>
        </div>
        </div>
       
        <div class="2fa">
              <div class="separator separator-dashed my-2"></div>
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Must Use 2FA to login</a>
                    <div class="fs-9 fw-semibold text-gray-500">Must enter 2FA  Code.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="login[2fa_code]" id="2fa_code" value="true"
                        <?=$login_settings['2fa_code'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="2fa_code"></label>
                </div>
            </div>
        </div>
        </div>
        <div class="separator separator-dashed my-2"></div>
         <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Must enter code sent to email to login</a>
                    <div class="fs-9 fw-semibold text-gray-500">Must enter email Pin Code sent to user email.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="login[email_code]" id="email_code" value="true"
                    <?=$login_settings['email_code'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="email_code"></label>
                </div>
            </div>
        </div>
         <div class="separator separator-dashed my-2"></div>
         <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold"> Use identity confirmation Page for Pin/2FA/Email Code</a>
                    <div class="fs-9 fw-semibold text-gray-500">will be redirected to confirmation.tpl to verify request.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="login[confirmation]" id="confirmation" value="true"
                    <?=$login_settings['confirmation'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="confirmation"></label>
                </div>
            </div>
        </div>
        <div class="separator separator-dashed my-2"></div>
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Redirect to Homepage after Logout</a>
                    <div class="fs-9 fw-semibold text-gray-500">User will be redirected to index(homepage) after logout instead of login page.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="login[homepage_after_logout]" id="homepage_after_logout"  value="true"
                    <?=$login_settings['homepage_after_logout'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="homepage_after_logout"></label>
                </div>
            </div>
        </div>
   
        <div class="separator separator-dashed my-2"></div>
        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9">Redirect after Login </label>
                </div>
            </div>
            <div class="col-md-8">
                <select class="form-select form-select-sm" name="login[after_login]" value ="home_page" >
                   <option value="dashboard_page"  <?=$login_settings['after_login'] == 'dashboard_page' ? 'selected' : '' ?> >Redirect to dashboard </option>
                    <option value="login_redirect" <?=$login_settings['after_login'] == 'login_redirect' ? 'selected' : '' ?>>Redirect to login_redirect</option>
                    <option value="home_page" <?=$login_settings['after_login'] == 'home_page' ? 'selected' : '' ?>>Redirect to Home</option>
                     <option value="tap_page" <?=$login_settings['after_login'] == 'tap_page' ? 'selected' : '' ?>>Redirect to Tap Page</option>
                     
                </select>
            </div>
        </div>
   
       

       
    
    </div>
    
</div></div>
 
    <div class="col-6"><div class="card mb-2">
    <div class="card-header min-h-unset py-2">
        <div class="card-title m-0">
            <h3 class="fw-bold m-0 fs-5">Deposit / Invest / Lottery / Dollar Game Settings</h3>
        </div>
    </div>
    <div class="card-body py-3">
        <div class="notice d-flex bg-light-primary rounded border-primary border border-dashed mb-2 p-2">
            <!--begin::Icon-->
            <i class="ki-duotone ki-design-1 fs-2tx text-primary me-4"></i>
            <!--end::Icon-->
            <!--begin::Wrapper-->
            <div class="d-flex flex-stack flex-grow-1">
                <!--begin::Content-->
                <div class="fw-semibold">
                    <div class="fs-8 text-gray-700">To Set Invest fees for each Currency <a  href="admin?page=currencies" class="fw-bold">Click here</a></div>
                </div>
                <!--end::Content-->
            </div>
            <!--end::Wrapper-->
        </div>
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Add Partial Investments Amounts to Account Balance</a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable to add partial (not fully paid amount) to account balance.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="deposit[partial_payments_balance]" id="partial_payments_balance" value="true"
                     <?=$deposit_settings['partial_payments_balance'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="partial_payments_balance"></label>
                </div>
            </div>
        </div>
        <!--begin::Item-->
         <div class="separator separator-dashed my-2"></div>
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Topup Account Balance</a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable to process deposit to account balance</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="deposit[topup]" id="topup" value="true"
                     <?=$deposit_settings['topup'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="topup"></label>
                </div>
            </div>
        </div>
        <!--end::Item-->
        <div id="topupdiv">
       
        <!--begin::Item-->
        <div class="row">
           
       
           <div class="separator separator-dashed my-2"></div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Deposit Memo :</label>
                       
                    </div>
                </div>
                <div class="col-md-8">
                    <input type="text" name="deposit[deposit_umemo]" value="Deposited in Account balance" class="form-control form-control-sm" />
                    <label class="form-check-label fs-9" for="memo"></label>
                     <small class="fs-9"> Will be printed in transactions detail</small>
                </div>
        
         </div>
        </div>
         <div class="separator separator-dashed my-2"></div>
         <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9"> Invest from Balance Fee (%) </label>
                </div>
            </div>
            <div class="col-md-8">
                <input type="amount" name="deposit[deposit_from_balance_fee]" class="form-control form-control-sm" value="<?=$deposit_settings['deposit_from_balance_fee'] ?>" />
                <small id="emailHelp" class="form-text text-muted fs-9">Fee to be deducted while deposit from account balance.</small>
            </div>   
            </div>
            <div class="separator separator-dashed my-2"></div>
                <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9"> Invest from Balance Bonus (%) </label>
                </div>
            </div>
            <div class="col-md-8"> 
                <input type="amount" name="deposit[deposit_from_balance_bonus]" class="form-control form-control-sm" value="<?=$deposit_settings['deposit_from_balance_bonus'] ?>" />
                <small id="emailHelp" class="form-text text-muted fs-9">Fee to be deducted while deposit from account balance.</small>
            </div>   
            </div>
           <div class="separator separator-dashed my-2"></div>
        <!--begin::Item-->
        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9"> Show same address for (mins) </label>
                </div>
            </div>
            <div class="col-md-8">
                <input type="amount" name="deposit[show_same_address]" class="form-control form-control-sm" value="<?=$deposit_settings['show_same_address'] ?>" />
                <small id="emailHelp" class="form-text text-muted fs-9">System will show the same payment address for time period. (leave empty to show new address everytime.)</small>
            </div>
            <div class="separator separator-dashed my-2"></div>
            <div class="col-md-4">
                        <div class="form-group">
                            <label class="fs-9">Investments History Memo :</label>
                        </div>
                    </div>
                <div class="col-md-8">
                        <input type="text" name="deposit[memo_invest]" value="<?=$deposit_settings['memo_invest'] ? : 'Invested in #plan# - #invested_amount# - #percent#' ; ?>" class="form-control form-control-sm">
                        <label class="form-check-label fs-9" for="memo">Available variables: #plan# - #invested_amount# - #percent#</label>
                    </div>
                    
                    
              <div class="separator separator-dashed my-2"></div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Investment Released Memo :</label>
                       
                    </div>
                </div>
                <div class="col-md-8">
                    <input type="text" name="deposit[investment_released]" value="<?=$deposit_settings['investment_released'] ? : 'Investment Released #amount# #method# from #plan#' ; ?>" class="form-control form-control-sm" />
                    <label class="form-check-label fs-9" for="memo">Available variables: #amount# #method# #plan#</label>
                     <small class="fs-9"> Will be printed in transactions table as transaction</small>
                </div>
                 <div class="separator separator-dashed my-2"></div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Principal Investment Returned :</label>
                       
                    </div>
                </div>
                <div class="col-md-8">
                    <input type="text" name="deposit[investment_returned]" value="<?=$deposit_settings['investment_returned'] ? : 'Principal Returned from #plan#' ; ?>" class="form-control form-control-sm" />
                    <label class="form-check-label fs-9" for="memo">Available variables: #plan# #hold_amount# #hold_percentage#</label>
                     <small class="fs-9"> Will be printed in transactions detail</small>
                </div>
     <div class="separator separator-dashed my-2"></div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Auto Reinvest Transaction Memo :</label>
                       
                    </div>
                </div>
                <div class="col-md-8">
                    <input type="text" name="deposit[auto_reinvest]" value="<?=$deposit_settings['auto_reinvest'] ? : 'Auto Reinvested #amount# to #plan#' ; ?>" class="form-control form-control-sm" />
                    <label class="form-check-label fs-9" for="memo">Available variables: #amount# #plan#</label>
                     <small class="fs-9"> Will be printed in transactions table as transaction</small>
                </div>
                
                
        </div>
         <div class="separator separator-dashed my-2"></div>
         <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Faucet  Page</a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable to show Faucet Page added via investment plans</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="deposit[faucet]" id="faucet" value="true"
                     <?=$deposit_settings['faucet'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="faucet"></label>
                </div>
            </div>
        </div>
    </div>
</div></div>
    <div class="col-6"><div class="card mb-2">
    <div class="card-header min-h-unset py-2">
        <div class="card-title m-0">
            <h3 class="fw-bold m-0 fs-5">Withdraw Settings</h3>
        </div>
    </div>
    <div class="card-body py-3">
       
<div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Manual Withdrawals</a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable to Process withdrawals </div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="withdraw[enable]" id="enablewi" value="true"
                    <?=$withdraw_settings['enable'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="enablewi"></label>
                </div>
            </div>
        </div>
        
         <div id="withdrawdiv">
                 <div class="separator separator-dashed my-2"></div>
      <div class="notice d-flex bg-light-primary rounded border-primary border border-dashed mb-2 p-2">
            <!--begin::Icon-->
            <i class="ki-duotone ki-design-1 fs-2tx text-primary me-4"></i>
            <!--end::Icon-->
            <!--begin::Wrapper-->
            <div class="d-flex flex-stack flex-grow-1">
                <!--begin::Content-->
                <div class="fw-semibold">
                    <div class="fs-8 text-gray-700">To Set Withdrawals fees for each Currency <a  href="admin?page=currencies" class="fw-bold">Click here</a></div>
                </div>
                <!--end::Content-->
            </div>
            <!--end::Wrapper-->
        </div>
        <div class="separator separator-dashed my-2"></div>
         <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Withdraw Request Memo :</label>
                       
                    </div>
                </div>
                <div class="col-md-8">
                    <input type="text" name="withdraw[request_memo]" value="<?=$withdraw_settings['request_memo'] ?  : 'Withdraw Requested' ?>" class="form-control form-control-sm" />
                    <label class="form-check-label fs-9" for="request_memo">Available variables: #method# - #address# </label>
                     <small class="fs-9"> Will be printed in transactions detail</small>
                </div>
          
        </div>
         <div class="separator separator-dashed my-2"></div>
         <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Withdraw Memo :</label>
                       
                    </div>
                </div>
                <div class="col-md-8">
                    <input type="text" name="withdraw[manual_memo]" value="<?=$withdraw_settings['manual_memo'] ?  : 'Withdraw Processed to #method# account #address#. Batch #txn_id#' ?> " class="form-control form-control-sm" />
                    <label class="form-check-label fs-9" for="memo">Available variables: #method# - #address# - #txn_id#</label>
                     <small class="fs-9"> Will be printed in transactions detail</small>
                </div>
          
        </div>
        <div class="separator separator-dashed my-2"></div>
             <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Redirect to Withdraw.success Page to show alert and withdrawal status</a>
                    <div class="fs-9 fw-semibold text-gray-500">If enabled withdraw request or success alert will be shown on <b>withdraw.success.tpl</b> page</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="withdraw[redirect]" id="redirect" value="true"
                    <?=$withdraw_settings['redirect'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="redirect"></label>
                </div>
            </div>
        </div>
        <? if ($kyc_settings['enable'])
    { ?>
         <div class="separator separator-dashed my-2"></div>
             <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">User must complete KYC to withdraw</a>
                    <div class="fs-9 fw-semibold text-gray-500">Disable to Process withdrawals for users with KYC Completed</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="withdraw[kyc]" id="kyc" value="true"
                    <?=$withdraw_settings['kyc'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="kyc"></label>
                </div>
            </div>
        </div>
        <?
    } ?>
                <div class="separator separator-dashed my-2"></div>
             <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">User Wallet address Required</a>
                    <div class="fs-9 fw-semibold text-gray-500">Disable to Process withdrawals without user wallet address</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="withdraw[address]" id="address" value="true"
                    <?=$withdraw_settings['address'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="address"></label>
                </div>
            </div>
        </div>
             <div class="separator separator-dashed my-2"></div>
             <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">User Can cancel withdraw request</a>
                    <div class="fs-9 fw-semibold text-gray-500">Disable to hide cancel withdraw button and feature.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="withdraw[cancel_withdraw]" id="cancelwithdraw" value="true"
                    <?=$withdraw_settings['cancel_withdraw'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="cancel_withdraw"></label>
                </div>
            </div>
        </div>
        <div id="cancelWithdrawDiv">
             <div class="separator separator-dashed my-2"></div>
         <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Withdraw Cancel Memo :</label>
                       
                    </div>
                </div>
                <div class="col-md-8">
                    <input type="text" name="withdraw[cancel_memo]" value="<?=$withdraw_settings['cancel_memo'] ?  : 'Withdraw Cancelled' ?> " class="form-control form-control-sm" />
                    <label class="form-check-label fs-9" for="memo">Available variables: none</label>
                     <small class="fs-9"> Will be printed in Withdrawals Transaction detail</small>
                </div>
          
        </div>
        </div>
         
        <!--begin::Item-->
        <div class="pincode">
            <div class="separator separator-dashed my-2"></div>
            <div class="d-flex flex-stack" >
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Must Use Transaction Code to withdraw</a>
                    <div class="fs-9 fw-semibold text-gray-500">Must Enter Transaction Code.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="withdraw[pin_code]" id="pin_code"  value="true"
                    <?=$withdraw_settings['pin_code'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="pin_code"></label>
                </div>
            </div>
        </div>
        </div>
        
        <!--begin::Item-->
        <div class="2fa">
             <div class="separator separator-dashed my-2"></div>
             <div class="d-flex flex-stack" >
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Must Use 2FA to withdraw</a>
                    <div class="fs-9 fw-semibold text-gray-500">Must enter 2FA  Code.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="withdraw[2fa_code]" id="2fa_code"  value="true"
                    <?=$withdraw_settings['2fa_code'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="2fa_code"></label>
                </div>
            </div>
        </div> </div>
        <div class="separator separator-dashed my-2"></div>
         <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Must enter code sent to email to withdraw</a>
                    <div class="fs-9 fw-semibold text-gray-500">Must enter email Pin Code sent to user email.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="withdraw[email_code]" id="email_code"  value="true"
                    <?=$withdraw_settings['email_code'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="email_code"></label>
                </div>
            </div>
        </div>
        <div class="separator separator-dashed my-2"></div>
         <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold"> Use identity confirmation Page for Pin/2FA/Email Code</a>
                    <div class="fs-9 fw-semibold text-gray-500">will be redirected to confirmation.tpl to verify request.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="withdraw[confirmation]" id="confirmation" value="true"
                    <?=$withdraw_settings['confirmation'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="confirmation"></label>
                </div>
            </div>
        </div>
            <div class="separator separator-dashed my-2"></div>
           <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <label class="fs-9">Limit Pending Withdraw Period </label>
                </div>
            </div>

            <div class="col-md-4">
                <input type="amount" name="withdraw[withdraw_pending_limit]" class="form-control form-control-sm" value="<?=$withdraw_settings['withdraw_pending_limit'] ?>"/>
                <small id="emailHelp" class="form-text text-muted fs-9">(leave empty to skip limits) </small>
            </div>

            <div class="col-md-1">
              <label class="fs-9">per </label>
            </div>
            <div class="col-md-4">
                <select class="form-select form-select-sm" name="withdraw[withdraw_pending_limit_duration]">
                    <option value="">None</option>
                           <option value="day" <?=$withdraw_settings['withdraw_pending_limit_duration'] == 'day' ? 'selected' : '' ?>>Day</option>
                    <option value="week" <?=$withdraw_settings['withdraw_pending_limit_duration'] == 'week' ? 'selected' : '' ?>>Week</option>
                    <option value="month" <?=$withdraw_settings['withdraw_pending_limit_duration'] == 'month' ? 'selected' : '' ?>>Month</option>
                    <option value="year" <?=$withdraw_settings['withdraw_pending_limit_duration'] == 'year' ? 'selected' : '' ?>>Year</option>
                </select>
            </div>
         
        </div>
        
                 <div class="separator separator-dashed my-2"></div>
           <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <label class="fs-9">Limit Withdraw Period </label>
                </div>
            </div>

            <div class="col-md-4">
                <input type="amount" name="withdraw[withdraw_limit]" class="form-control form-control-sm" value="<?=$withdraw_settings['withdraw_limit'] ?>"/>
                <small id="emailHelp" class="form-text text-muted fs-9">(leave empty to skip limits) </small>
            </div>

            <div class="col-md-1">
              <label class="fs-9">per </label>
            </div>
            <div class="col-md-4">
                <select class="form-select form-select-sm" name="withdraw[withdraw_limit_duration]">
                    <option value="">None</option>
                           <option value="day" <?=$withdraw_settings['withdraw_limit_duration'] == 'day' ? 'selected' : '' ?>>Day</option>
                    <option value="week" <?=$withdraw_settings['withdraw_limit_duration'] == 'week' ? 'selected' : '' ?>>Week</option>
                    <option value="month" <?=$withdraw_settings['withdraw_limit_duration'] == 'month' ? 'selected' : '' ?>>Month</option>
                    <option value="year" <?=$withdraw_settings['withdraw_limit_duration'] == 'year' ? 'selected' : '' ?>>Year</option>
                </select>
            </div>
         
        </div> 
  <!--begin::Item-->
  <div class="separator separator-dashed my-2"></div>
<!--begin::Item-->
<div class="d-flex flex-stack">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Withdrawals Between Specific Times</a>
            <div class="fs-9 fw-semibold text-gray-500">Process withdrawals only on selected days and time periods</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <div class="form-check form-check-solid form-check-custom form-switch">
            <input class="form-check-input w-45px h-30px" type="checkbox" name="withdraw[spec_time]" id="withspectime" value="true"
            <?=$withdraw_settings['spec_time'] == 'true' ? 'checked' : '' ?> onchange="toggleWithdrawTimeSettings()">
            <label class="form-check-label fs-9" for="withspectime"></label>
        </div>
    </div>
</div>

<div id="withdrawTimeSettingsDiv" class="mt-5" style="display: <?=$withdraw_settings['spec_time'] == 'true' ? 'block' : 'none' ?>;">
    <div class="separator separator-dashed my-2"></div>
    
    <!-- Day Selection -->
    <div class="mb-5">
        <label class="fs-8 fw-bold mb-2">Select Days for Withdrawals</label>
        <div class="d-flex flex-wrap gap-2">
            <?php
            $days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            $selectedDays = isset($withdraw_settings['allowed_days']) ? explode(',', $withdraw_settings['allowed_days']) : [];
            
            foreach ($days as $day) {
                $isChecked = in_array($day, $selectedDays) ? 'checked' : '';
                echo '<div class="form-check form-check-custom form-check-solid me-5 mb-2">';
                echo '<input class="form-check-input" type="checkbox" name="withdraw[allowed_days][]" value="' . $day . '" id="day_' . strtolower($day) . '" ' . $isChecked . '>';
                echo '<label class="form-check-label fs-9" for="day_' . strtolower($day) . '">' . $day . '</label>';
                echo '</div>';
            }
            ?>
        </div>
        <small class="form-text text-muted fs-9">If no days are selected, withdrawals will be allowed on all days within the time window</small>
    </div>
    
    <!-- Time Range -->
    <div class="row mb-5">
        <div class="col-12">
            <label class="fs-8 fw-bold mb-2">Withdrawal Time Window</label>
        </div>
        
        <div class="col-md-6 mb-3">
            <label class="fs-9 mb-1">From</label>
            <select name="withdraw[time_from]" class="form-select form-select-sm">
                <?php
                $selectedFromTime = isset($withdraw_settings['time_from']) ? $withdraw_settings['time_from'] : '09:00';
                for ($hour = 0; $hour < 24; $hour++) {
                    for ($min = 0; $min < 60; $min += 30) {
                        $time = sprintf('%02d:%02d', $hour, $min);
                        $selected = ($time == $selectedFromTime) ? 'selected' : '';
                        $displayTime = date('g:i A', strtotime($time));
                        echo "<option value=\"$time\" $selected>$displayTime</option>";
                    }
                }
                ?>
            </select>
        </div>
        
        <div class="col-md-6 mb-3">
            <label class="fs-9 mb-1">To</label>
            <select name="withdraw[time_to]" class="form-select form-select-sm">
                <?php
                $selectedToTime = isset($withdraw_settings['time_to']) ? $withdraw_settings['time_to'] : '17:00';
                for ($hour = 0; $hour < 24; $hour++) {
                    for ($min = 0; $min < 60; $min += 30) {
                        $time = sprintf('%02d:%02d', $hour, $min);
                        $selected = ($time == $selectedToTime) ? 'selected' : '';
                        $displayTime = date('g:i A', strtotime($time));
                        echo "<option value=\"$time\" $selected>$displayTime</option>";
                    }
                }
                ?>
            </select>
        </div>
    </div>


  
</div>

<!-- This script processes the form submission to handle the array of selected days -->
<script>
function toggleWithdrawTimeSettings() {
    const checkbox = document.getElementById('withspectime');
    const settingsDiv = document.getElementById('withdrawTimeSettingsDiv');
    
    if (checkbox.checked) {
        settingsDiv.style.display = 'block';
    } else {
        settingsDiv.style.display = 'none';
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    toggleWithdrawTimeSettings();
    
    // Add form submit event listener to process allowed_days
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        // Find all checked day checkboxes
        const checkedDays = Array.from(document.querySelectorAll('input[name="withdraw[allowed_days][]"]:checked'))
            .map(checkbox => checkbox.value);
        
        // Create a hidden input to store the comma-separated list of days
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'withdraw[allowed_days]';
        hiddenInput.value = checkedDays.join(',');
        
        // Add the hidden input to the form
        form.appendChild(hiddenInput);
    });
});
</script>
         <div class="separator separator-dashed my-2"></div>
        <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable <span class="badge badge-primary">Instant Withdrawals</span></a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable to Process withdrawals instantly through <a  href="admin?page=currencies">currencies</a> & <a  href="admin?page=processings">processings</a> settings</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="withdraw[withtype]" id="withtype" value="true"
                    <?=$withdraw_settings['withtype'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="withtype"></label>
                </div>
            </div>
        </div>
          <div id="withtypediv">
                    <div class="separator separator-dashed my-2"></div>
        <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Instant Withdrawals for users who have 2FA Active</a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable to Instant withdrawals to users with 2FA Active only.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="withdraw[instantwithdraw_2fa]" id="instantwithdraw_2fa" value="true"
                    <?=$withdraw_settings['instantwithdraw_2fa'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="instantwithdraw_2fa"></label>
                </div>
            </div>
        </div>
                     <div class="separator separator-dashed my-2"></div>
        <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Disable Instant Withdrawals for users with multiple Accounts</a>
                    <div class="fs-9 fw-semibold text-gray-500">Disable  Instant withdrawals for users with multiple Accounts. (ip / useragent based)</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="withdraw[multiple_account]" id="multiple_account" value="true"
                    <?=$withdraw_settings['multiple_account'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="multiple_account"></label>
                </div>
            </div>
        </div>
        <div class="separator separator-dashed my-2"></div>

        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9"> Delay instant Withdrawals for (mins) </label>
                </div>
            </div>
            <div class="col-md-8">
                <input type="amount" name="withdraw[delay_instant_withdraw]" class="form-control form-control-sm" value="<?=$withdraw_settings['delay_instant_withdraw'] ?>" />
                <small id="emailHelp" class="form-text text-muted fs-9">(leave empty to skip delays)- Withdraw will be delayed for given minutes. you can show timer on user history</small>
            </div>
       
          <div class="separator separator-dashed my-2"></div>
          
        <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Instant Withdrawals for Week Days only.</a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable to Instant withdrawals to users only on week days.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="withdraw[instantwithdraw_weekdays]" id="instantwithdraw_weekdays" value="true"
                    <?=$withdraw_settings['instantwithdraw_weekdays'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="instantwithdraw_weekdays"></label>
                </div>
            </div>
        </div>
         <div class="separator separator-dashed my-2"></div>
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9"> Max Daily Withdraw Limit </label>
                </div>
            </div>
            <div class="col-md-8">
                <input type="amount" name="withdraw[max_daily_withdraw_limit]" class="form-control form-control-sm" value="<?=$withdraw_settings['max_daily_withdraw_limit'] ?>" />
                <small id="emailHelp" class="form-text text-muted fs-9">(leave empty to skip limits)- Withdraw above limit will be not processed instantly.</small>
            </div>
       
          <div class="separator separator-dashed my-2"></div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Instant Withdraw Memo :</label>
                       
                    </div>
                </div>
                <div class="col-md-8">
                    <input type="text" name="withdraw[instant_memo]" value="<?=$withdraw_settings['instant_memo'] ?  : 'Instant Withdraw Processed to #method# account #address#. Batch #txn_id#' ?> " class="form-control form-control-sm" />
                    <label class="form-check-label fs-9" for="memo">Available variables:  #method# - #address# - #txn_id#</label>
                     <small class="fs-9"> Will be printed in transactions detail</small>
                </div>
        </div>
         </div>
            <!--end::type-->
        <div class="separator separator-dashed my-2"></div>
        <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable <span class="badge badge-primary">Automatic Withdrawals</span></a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable to Sent withdrawals directly to users wallet without requesting.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="withdraw[autowithdraw]" id="autowithdraw" value="true"
                    <?=$withdraw_settings['autowithdraw'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="autowithdraw"></label>
                </div>
            </div>
        </div>
        <div id="autowithdrawdiv">
             <div class="separator separator-dashed my-2"></div>
        <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Automatic Withdrawals for users who have 2FA Active</a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable to Sent withdrawals directly to users wallet without requesting for users with 2FA Active only.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="withdraw[autowithdraw_2fa]" id="autowithdraw_2fa" value="true"
                    <?=$withdraw_settings['autowithdraw_2fa'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="autowithdraw_2fa"></label>
                </div>
            </div>
        </div>
        <div class="separator separator-dashed my-2"></div>
        <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Send Automatic Withdrawals requests only </a>
                    <div class="fs-9 fw-semibold text-gray-500">If enable system will automatically send withdraw requests of available balance to <a  href="admin?page=pending_withdrawals">pending withdrawals.</a></div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="withdraw[autowithdraw_request]" id="autowithdraw_request" value="true"
                    <?=$withdraw_settings['autowithdraw_request'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="autowithdraw_request"></label>
                </div>
            </div>
        </div>
        <div class="separator separator-dashed my-2"></div>
        <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Send Automatic Withdrawals to user with Auto Enabled</a>
                    <div class="fs-9 fw-semibold text-gray-500">If enable system will automatically send auto withdraws for users with Auto Withdraw Status = 1 and rest user requests of available balance to <a  href="admin?page=pending_withdrawals">pending withdrawals.</a></div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="withdraw[autowithdraw_autouser]" id="autowithdraw_request" value="true"
                    <?=$withdraw_settings['autowithdraw_autouser'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="autowithdraw_autouser"></label>
                </div>
            </div>
        </div>
        <div class="separator separator-dashed my-2"></div>

        <div class="row" id="delay">
             <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9"> Delay Auto Withdrawals for (mins) </label>
                </div>
            </div>
            <div class="col-md-8">
                <input type="amount" name="withdraw[delay_auto_withdraw]" class="form-control form-control-sm" value="<?=$withdraw_settings['delay_auto_withdraw'] ?>" />
                <small id="emailHelp" class="form-text text-muted fs-9">(leave empty to skip delays)- Withdraw will be delayed for given minutes. you can show timer on user history</small>
            </div>
                   <div class="separator separator-dashed my-2"></div>
                     <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9"> Delay Auto Withdrawals for Binance/Bybit to get TX(mins) </label>
                </div>
            </div>
            <div class="col-md-8">
                <input type="amount" name="withdraw[delay_auto_withdraw_sleep]" class="form-control form-control-sm" value="<?=$withdraw_settings['delay_auto_withdraw_sleep'] ?>" />
                <small id="emailHelp" class="form-text text-muted fs-9">(leave empty to skip delays)- Withdraw will be processed after given minutes to get Transaction Hash instead of ID from Exchanges</small>
            </div>
                   <div class="separator separator-dashed my-2"></div>
          
        <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Auto Withdrawals for Week Days only.</a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable to Instant withdrawals to users only on week days.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="withdraw[autowithdraw_weekdays]" id="autowithdraw_weekdays" value="true"
                    <?=$withdraw_settings['autowithdraw_weekdays'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="autowithdraw_weekdays"></label>
                </div>
            </div>
        </div>
        <div class="separator separator-dashed my-2"></div>
        </div>
        <div class="row">
         
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9"> Max Daily Auto Withdraw Limit </label>
                </div>
            </div>
            <div class="col-md-8">
                <input type="amount" name="withdraw[max_daily_auto_withdraw_limit]" class="form-control form-control-sm" value="<?=$withdraw_settings['max_daily_auto_withdraw_limit'] ?>"/>
                <small id="emailHelp" class="form-text text-muted fs-9">(leave empty to skip limits) - Withdraw above limit will be not processed automatically.</small>
            </div>
        </div>
        
        <div class="separator separator-dashed my-2"></div>
        <div class="row">
            <div class="col-md-2">
                <div class="form-group">
                    <label class="fs-9">Limit Auto Withdraw Period </label>
                </div>
            </div>

            <div class="col-md-2">
                <input type="amount" name="withdraw[auto_withdraw_limit]" class="form-control form-control-sm" value="<?=$withdraw_settings['auto_withdraw_limit'] ?>"/>
                <small id="emailHelp" class="form-text text-muted fs-9">(leave empty to skip limits) </small>
            </div>

            <div class="col-md-2">
                <label class="fs-9">per </label>
            </div>
            <div class="col-md-2">
                <select class="form-select form-select-sm" name="withdraw[auto_withdraw_limit_duration]">
                    <option value="">None</option>
                           <option value="day" <?=$withdraw_settings['auto_withdraw_limit_duration'] == 'day' ? 'selected' : '' ?>>Day</option>
                    <option value="week" <?=$withdraw_settings['auto_withdraw_limit_duration'] == 'week' ? 'selected' : '' ?>>Week</option>
                    <option value="month" <?=$withdraw_settings['auto_withdraw_limit_duration'] == 'month' ? 'selected' : '' ?>>Month</option>
                    <option value="year" <?=$withdraw_settings['auto_withdraw_limit_duration'] == 'year' ? 'selected' : '' ?>>Year</option>
                </select>
            </div>
            <div class="col-md-1">
                <label class="fs-9">for </label>
            </div>
            <div class="col-md-3">
                <select class="form-select form-select-sm" name="withdraw[auto_withdraw_limit_for]">
                    <option value="processing" <?=$withdraw_settings['auto_withdraw_limit_for'] == 'processing' ? 'selected' : '' ?>>Processed</option>
                    <option value="currency" <?=$withdraw_settings['auto_withdraw_limit_for'] == 'currency' ? 'selected' : '' ?>>Currency</option>
                    <option value="pending" <?=$withdraw_settings['auto_withdraw_limit_for'] == 'pending' ? 'selected' : '' ?>>Pending</option>
                </select>
            </div>
             <div class="separator separator-dashed my-2"></div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Auto Withdraw Request Memo :</label>
                       
                    </div>
                </div>
                <div class="col-md-8">
                     <input type="text" name="withdraw[auto_req_memo]" value="<?=$withdraw_settings['auto_req_memo'] ?  : 'Auto Withdraw Processing to #method# account #address#' ?> " class="form-control form-control-sm" />
                    <label class="form-check-label fs-9" for="memo">Available variables:  #method# - #address# </label>
                     <small class="fs-9"> Will be printed in transactions detail</small>
                </div>
            <div class="separator separator-dashed my-2"></div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Auto Withdraw Memo :</label>
                       
                    </div>
                </div>
                <div class="col-md-8">
                     <input type="text" name="withdraw[auto_memo]" value="<?=$withdraw_settings['auto_memo'] ?  : 'Auto Withdraw Processed to #method# account #address#. Batch #txn_id#' ?> " class="form-control form-control-sm" />
                    <label class="form-check-label fs-9" for="memo">Available variables:  #method# - #address# - #txn_id#</label>
                     <small class="fs-9"> Will be printed in transactions detail</small>
                </div>
        </div>
       </div> 
        <!--end::auto-->
    </div>
    <!--end::auto-->
</div>
</div>
</div>
   <div class="col-6"><div class="card mb-2">
    <div class="card-header min-h-unset py-2">
        <div class="card-title m-0">
            <h3 class="fw-bold m-0 fs-5">User Settings</h3>
        </div>
    </div>
    <div class="card-body py-3">
        


        
        <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable 2FA</a>
                    <div class="fs-9 fw-semibold text-gray-500">2FA for User Profile.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="user[2fa]" id="2fa_main" value="true"
                    <?=$user_settings['2fa'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="2fa_main"></label>
                </div>
            </div>
        </div>
        
    
        <div class="pincode">
            
             <div class="separator separator-dashed my-2"></div>
        <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Must Use Transaction Code to Change Profile</a>
                    <div class="fs-9 fw-semibold text-gray-500">Must Enter Transaction Code.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="user[pin_code]" id="pin_code" value="true"
                    <?=$user_settings['pin_code'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="pin_code"></label>
                </div>
            </div>
        </div>
        </div>
       
        <div class="2fa">
              <div class="separator separator-dashed my-2"></div>
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Must Use 2FA to Change Profile</a>
                    <div class="fs-9 fw-semibold text-gray-500">Must enter 2FA  Code.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="user[2fa_code]" id="2fa_code" value="true"
                        <?=$user_settings['2fa_code'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="2fa_code"></label>
                </div>
            </div>
        </div>
        </div>
        <div class="separator separator-dashed my-2"></div>
         <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Must enter code sent to email to change profile</a>
                    <div class="fs-9 fw-semibold text-gray-500">Must enter email Pin Code sent to user email.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="user[email_code]" id="email_code" value="true"
                    <?=$user_settings['email_code'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="email_code"></label>
                </div>
            </div>
        </div>
         <div class="separator separator-dashed my-2"></div>
         <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold"> Use identity confirmation Page for Pin/2FA/Email Code</a>
                    <div class="fs-9 fw-semibold text-gray-500">will be redirected to confirmation.tpl to verify request.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="user[confirmation]" id="confirmation" value="true"
                    <?=$user_settings['confirmation'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="confirmation"></label>
                </div>
            </div>
        </div>
         <div class="separator separator-dashed my-2"></div>
         <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Use Wallets page for Payment wallets address</a>
                    <div class="fs-9 fw-semibold text-gray-500">If enable user will need to enter or change wallet details on user_wallet.tpl</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="user[wallets]" id="wallets" value="true"
                    <?=$user_settings['wallets'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="wallets"></label>
                </div>
            </div>
        </div>
  <div class="separator separator-dashed my-2"></div>
        <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Can Change Payment Wallets</a>
                    <div class="fs-9 fw-semibold text-gray-500">Update Payment wallet address after adding.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="user[can_change_wallet_acc]" id="can_change_wallet_acc"  value="true"
                    <?=$user_settings['can_change_wallet_acc'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="can_change_wallet_acc"></label>
                </div>
            </div>
        </div>
         <div class="separator separator-dashed my-2"></div>
        <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Change Email</a>
                    <div class="fs-9 fw-semibold text-gray-500">Change email after registration.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="user[can_change_email]" id="can_change_email"  value="true"
                    <?=$user_settings['can_change_email'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="can_change_email"></label>
                </div>
            </div>
        </div>
           <div class="separator separator-dashed my-2"></div>
        <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Can Upload Profile Picture</a>
                    <div class="fs-9 fw-semibold text-gray-500">Can Upload profile picture in profile.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="user[profile_photo]" id="profile_photo"  value="true"
                    <?=$user_settings['profile_photo'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="profile_photo"></label>
                </div>
            </div>
        </div>
               <div class="separator separator-dashed my-2"></div>
         <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Must enter code sent to recover password</a>
                    <div class="fs-9 fw-semibold text-gray-500">Must enter email Pin Code sent to user email.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="user[forgot_email_code]" id="forgot_email_code" value="true"
                    <?=$user_settings['forgot_email_code'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="forgot_email_code"></label>
                </div>
            </div>
        </div>
         <div class="separator separator-dashed my-2"></div>
         <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Must Verify link sent to email to recover password</a>
                    <div class="fs-9 fw-semibold text-gray-500">Must enter verify link to recover password sent to user email.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="user[forgot_email_link]" id="forgot_email_code" value="true"
                    <?=$user_settings['forgot_email_link'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="forgot_email_link"></label>
                </div>
            </div>
        </div>
                     <div class="separator separator-dashed my-2"></div>
  <div class="col-md-12">
                    <div class="d-flex flex-stack">
                        <div class="d-flex">
                            <div class="d-flex flex-column">
                                <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Logout on Ip Change</a>
                                <div class="fs-9 fw-semibold text-gray-500">User will be logout if the Ip get changed.</div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <div class="form-check form-check-solid form-check-custom form-switch">
                                <input class="form-check-input w-45px h-30px" type="checkbox" name="user[logout_on_ip_change]" id="email_code" value="true" <?=$user_settings['logout_on_ip_change'] == 'true' ? 'checked' : '' ?>>
                                <label class="form-check-label fs-9" for="logout_on_ip_change"></label>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="separator separator-dashed my-2"></div>
  <div class="col-md-12">
                    <div class="d-flex flex-stack">
                        <div class="d-flex">
                            <div class="d-flex flex-column">
                                <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Logout on Browser Change</a>
                                <div class="fs-9 fw-semibold text-gray-500">User will be logout if the Browser get changed.</div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <div class="form-check form-check-solid form-check-custom form-switch">
                                <input class="form-check-input w-45px h-30px" type="checkbox" name="user[logout_on_browser_change]" id="email_code" value="true" <?=$user_settings['logout_on_browser_change'] == 'true' ? 'checked' : '' ?>>
                                <label class="form-check-label fs-9" for="logout_on_browser_change"></label>
                            </div>
                        </div>
                    </div>
                </div>
                  
            <div class="separator separator-dashed my-2"></div>
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Support Tickets</a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable Support Ticket system for users <a  href="admin?page=support" class="fw-bold">Click here to see tickets</a>.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="user[support]" id="support" value="true"
                    <?=$user_settings['support'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="support"></label>
                </div>
            </div>
        </div>
        <div class="separator separator-dashed my-2"></div>
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Reviews for Users</a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable Support Ticket system for users <a  href="admin?page=reviews" class="fw-bold">Click here to see reviews</a>.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="user[reviews]" id="reviews" value="true"
                    <?=$user_settings['reviews'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="reviews"></label>
                </div>
            </div>
        </div>
        <div id="reviewdiv">
             <div class="separator separator-dashed my-2"></div>
            <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Publish All Reviews</a>
                    <div class="fs-9 fw-semibold text-gray-500">All reviews will be publish with out moderation</a>.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="user[reviews_publish]" id="reviews_publish" value="true"
                    <?=$user_settings['reviews_publish'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="reviews_publish"></label>
                </div>
            </div>
        </div>
           <div class="separator separator-dashed my-2"></div>
            <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Faucet for Posting Reviews</a>
                    <div class="fs-9 fw-semibold text-gray-500">enabling this will allow users to earn faucet by posting review</a>.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="user[review_faucet]" id="review_faucet" value="true"
                    <?=$user_settings['reviews_publish'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="review_faucet"></label>
                </div>
            </div>
        </div>
           
            <div class="row" id="reviewfaucet">
                 <div class="separator separator-dashed my-2"></div>
                 <div class="col-md-2">
                <div class="form-group">
                    <label class="fs-9">Faucet </label>
                </div>
            </div>

            <div class="col-md-4">
                <input type="text" name="user[review_faucet_amount]" class="form-control form-control-sm" value="<?=$user_settings['review_faucet_amount'] ?>" />
                    <label class="form-check-label fs-9" for="review_faucet_amount">(leave empty to skip)</label>
                  
            </div>
            
            <div class="col-md-2">
                <label class="fs-9">Type </label>
            </div>
            <div class="col-md-4">
                  <select class="form-select form-select-sm" name="user[review_faucet_type]">
                            <option value="0" <?=$user_settings['review_faucet_type'] == '0' ? 'selected' : '' ?>>Balance Faucet </option>
                            <option value="1" <?=$user_settings['review_faucet_type'] == '1' ? 'selected' : '' ?>> Faucet Balance </option>
                           
                        </select>
             
            </div>
            <div class="separator separator-dashed my-2"></div>
        <div class="col-md-4">
                            <div class="form-group">
                                <label class="fs-9"> Faucet Currency: </label>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <select class="form-select form-select-sm form-select-solid" name="user[review_faucet_curreny]" id="faucet_currency">
                                <?php $select_method = mysqli_query($DB_CONN, "SELECT * from currencies where de_pm_id != 0");
                while ($row_method = mysqli_fetch_assoc($select_method))
                { ?>
                                    <option value="<?php echo $row_method['id'] ?>" <? echo $user_settings['review_faucet_curreny'] == $row_method['id'] ? " selected" : "" ?>> <?php echo $row_method['name'] ?> </option>
                            <?php
                } ?>
                                        
                                    </select>
                            <small id="emailHelp" class="form-text text-muted fs-9">Will be active via this currency only.</small>
                            </div>
                   <div class="separator separator-dashed my-2"></div>
        <div class="col-md-4">
              <label class="fs-9"> Faucet Balance Memo</label>
                </div>
        
        <div class="col-md-8">
                    <input type="text" name="user[review_faucet_memo]" class="form-control form-control-sm" value="<?=$user_settings['review_faucet_memo'] ? : "#faucet_amount# for posting Review" ;  ?>" />
                    <label class="form-check-label fs-9" for="review_faucet_memo">Available Short Code #faucet_amount# </label>
                     <small class="fs-9"> Enter Faucet Balance you want to Give user after review.</small>
                </div>
             </div>   
        <div class="row" id="ban">
             <div class="separator separator-dashed my-2"></div>
        <div class="col-md-4">
              <label class="fs-9">  Reviews Ban Words </label>
                </div>
        
        <div class="col-md-8">
                    <input type="text" name="user[ban_words]" class="form-control form-control-sm" value="<?=$user_settings['ban_words'] ? : "Scam, Not, Pending, not paying, not working"; ?>" />
                    <label class="form-check-label fs-9" for="memo">User Comma to seperate words </label>
                     <small class="fs-9"> Reviews with these words will got for moderation and can be moderate on <a  href="admin?page=reviews&status=0">pending reviews page</a></small>
                </div>
                </div>
        </div>
         <div class="separator separator-dashed my-2"></div>
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Activity Logs for Users</a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable Support Ticket system for users <a  href="admin?page=logs" class="fw-bold">Click here to see logs</a>.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="user[logs]" id="logs" value="true"
                    <?=$user_settings['logs'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="logs"></label>
                </div>
            </div>
        </div>
         <div class="separator separator-dashed my-2"></div>
        <div class="d-flex flex-stack">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Daily CheckIn for earnings</a>
            <div class="fs-9 fw-semibold text-gray-500">User Must Daily CheckIn for earnings and profits </div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <div class="form-check form-check-solid form-check-custom form-switch">
            <input class="form-check-input w-45px h-30px" type="checkbox" name="user[dailycheckin]" id="dailycheckin" value="true"
                 <?=$user_settings['dailycheckin'] == 'true' ? 'checked' : '' ?>>
            <label class="form-check-label fs-9" for="dailycheckin"></label>
        </div>
    </div>
</div>

 <div class="separator separator-dashed my-2"></div>
 
<div class="d-flex flex-stack">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Daily Login Bonus & Streak</a>
            <div class="fs-9 fw-semibold text-gray-500">Enable Daily Login Bonus & Streak System for users</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <div class="form-check form-check-solid form-check-custom form-switch">
            <input class="form-check-input w-45px h-30px" type="checkbox" name="user[dailystreak]" id="dailystreak" value="true"
                onchange="toggleStreakSettings(this)" <?=$user_settings['dailystreak'] == 'true' ? 'checked' : '' ?>>
            <label class="form-check-label fs-9" for="dailystreak"></label>
        </div>
    </div>
</div>

<!-- Streak Settings Form -->
<div id="streakSettings" class="mt-3" style="display: <?=$user_settings['dailystreak'] == 'true' ? 'block' : 'none' ?>;">
    <div class="ms-2">
        <div class="d-flex align-items-center mb-2">
            <label class="fs-8 fw-bold mb-0 me-2">Number of Days:</label>
            <div class="d-flex align-items-center">
                <input type="number" class="form-control form-control-sm" style="width: 60px;" id="streakDaysCount" 
                    name="user[streak_days]" value="<?=isset($user_settings['streak_days']) ? $user_settings['streak_days'] : '7' ?>" 
                    min="1" max="7" onchange="updateDaysCount(this.value)">
                <span class="ms-2 fs-8">Days</span>
            </div>
        </div>

        <!-- Daily Settings Container -->
       <div id="dailySettingsContainer">
            <?php
            if($user_settings['dailystreak'] == 'true'):
                $days = isset($user_settings['streak_days']) ? $user_settings['streak_days'] : 7;
                for($i = 1; $i <= $days; $i++):
                    $day_bonus = isset($user_settings["streak_day{$i}_bonus"]) ? $user_settings["streak_day{$i}_bonus"] : '0';
                    $day_payment = isset($user_settings["streak_day{$i}_payment_id"]) ? $user_settings["streak_day{$i}_payment_id"] : '';
            ?>
            <div class="daily-setting mb-2">
                <div class="fs-8 fw-bold mb-1">Day <?=$i?></div>
                <div class="d-flex gap-2">
                    <input type="number" class="form-control form-control-sm streak-input" placeholder="Bonus Amount"
                        name="user[streak_day<?=$i?>_bonus]" value="<?=$day_bonus?>" step="0.01" required>
                    <select class="form-select form-select-sm streak-input" name="user[streak_day<?=$i?>_payment_id]" required>
                        <option value="">Select Payment</option>
                        <?php foreach($payments as $payment): ?>
                            <option value="<?=$payment['id']?>" <?=$day_payment == $payment['id'] ? 'selected' : ''?>>
                                <?=$payment['name']?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
            </div>
            <?php 
                endfor;
            endif;
            ?>
        </div>
    </div>
                
       
</div>

<script>
function toggleStreakSettings(checkbox) {
    const streakSettings = document.getElementById('streakSettings');
    const inputs = streakSettings.querySelectorAll('.streak-input');
    
    if (checkbox.checked) {
        streakSettings.style.display = 'block';
        inputs.forEach(input => {
            input.required = true;
            input.disabled = false;
        });
        // Initialize the days if it's being enabled
        updateDaysCount(document.getElementById('streakDaysCount').value);
    } else {
        streakSettings.style.display = 'none';
        inputs.forEach(input => {
            input.required = false;
            input.disabled = true;
        });
        // Clear the container when disabled
        document.getElementById('dailySettingsContainer').innerHTML = '';
    }
}

function updateDaysCount(days) {
    if (!document.getElementById('dailystreak').checked) {
        return; // Don't update if streak is disabled
    }
    
    days = Math.min(Math.max(days, 1), 7);
    document.getElementById('streakDaysCount').value = days;
    
    const container = document.getElementById('dailySettingsContainer');
    container.innerHTML = '';
    
    for(let i = 1; i <= days; i++) {
        const dayHtml = `
            <div class="daily-setting mb-2">
                <div class="fs-8 fw-bold mb-1">Day ${i}</div>
                <div class="d-flex gap-2">
                    <input type="number" class="form-control form-control-sm streak-input" placeholder="Bonus Amount"
                        name="user[streak_day${i}_bonus]" step="0.01" value="0" required>
                    <select class="form-select form-select-sm streak-input" name="user[streak_day${i}_payment_id]" required>
                        <option value="">Select Payment</option>
                        <?php foreach($payments as $payment): ?>
                            <option value="<?=$payment['id']?>"><?=$payment['name']?></option>
                        <?php endforeach; ?>
                    </select>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', dayHtml);
    }
}
</script>
 <div class="separator separator-dashed my-2"></div>
<div class="d-flex flex-stack">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Taps for user</a>
            <div class="fs-9 fw-semibold text-gray-500">Enable Taps for users</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <div class="form-check form-check-solid form-check-custom form-switch">
            <input class="form-check-input w-45px h-30px" type="checkbox" name="user[taps_enabled]" id="taps_enabled" value="true"
                onchange="toggleTapSettings(this)" <?=$user_settings['taps_enabled'] == 'true' ? 'checked' : '' ?>>
            <label class="form-check-label fs-9" for="taps_enabled"></label>
        </div>
    </div>
</div>
<div id="tapSettings" class="mt-3 " style="display: <?=$user_settings['taps_enabled'] == 'true' ? 'block' : 'none' ?>;">
     <div class="separator separator-dashed my-2"></div>
     <div class="row">
     <div class="col-md-4">
        <label class="fs-9">Default Taps</label>
    </div>
    <div class="col-md-8">
        <input type="text" class="form-control form-control-sm tap-input" 
            name="user[default_taps]" 
            value="<?=isset($user_settings['default_taps']) ? $user_settings['default_taps'] : '5' ?>">
    </div>
       <div class="separator separator-dashed my-2"></div>
     <div class="col-md-4">
        <label class="fs-9">Account Balance Bonus Per Tap</label>
    </div>
    <div class="col-md-8">
        <input type="number" class="form-control form-control-sm tap-input" 
            name="user[balance_bonus_per_tap]" 
            value="<?=isset($user_settings['balance_bonus_per_tap']) ? $user_settings['balance_bonus_per_tap'] : '5' ?>">
    </div>
         <div class="separator separator-dashed my-2"></div>
          <div class="col-md-4">
        <label class="fs-9">Balance Currency for TAP</label>
    </div>
  <div class="col-md-8">
        <select class="form-select form-select-sm form-select-solid tap-input" name="user[balance_bonus_payment_id]">
            <option value="">Select Payment Method</option>
            <?php foreach($payments as $payment): ?>
                <option value="<?=$payment['id']?>" 
                    <?=isset($user_settings['balance_bonus_payment_id']) && $user_settings['balance_bonus_payment_id'] == $payment['id'] ? 'selected' : ''?>>
                    <?=$payment['name']?>
                </option>
            <?php endforeach; ?>
        </select>
    </div>
    <?php $iconb = $siteURL . '/images/icons/' . $user_settings['balance_bonus_payment_id'] . '.svg';?>
    <input class="hidden d-none" name="user[balance_bonus_payment_icon]" value="<?=$iconb ?>">
      <!-- Faucet Taps Toggle -->
<div class="d-flex flex-stack">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Faucet Taps</a>
            <div class="fs-9 fw-semibold text-gray-500">Enable Faucet Taps for users</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <div class="form-check form-check-solid form-check-custom form-switch">
            <input class="form-check-input w-45px h-30px" type="checkbox" name="user[faucet_taps_enabled]" id="faucet_taps_enabled" value="true"
                onchange="toggleFaucetTapSettings(this)" <?=$user_settings['faucet_taps_enabled'] == 'true' ? 'checked' : '' ?>>
            <label class="form-check-label fs-9" for="faucet_taps_enabled"></label>
        </div>
    </div>
</div>

<!-- Faucet Taps Settings -->
<div id="faucetTapSettings" class="mt-3" style="display: <?=$user_settings['faucet_taps_enabled'] == 'true' ? 'block' : 'none' ?>;">
    <div class="separator separator-dashed my-2"></div>
    <div class="row">
        <div class="col-md-4">
            <label class="fs-9">Faucet Balance Bonus Per Tap</label>
        </div>
        <div class="col-md-8">
            <input type="text" class="form-control form-control-sm tap-input" 
                name="user[faucet_bonus_per_tap]" 
                value="<?=isset($user_settings['faucet_bonus_per_tap']) ? $user_settings['faucet_bonus_per_tap'] : '5' ?>">
        </div>
        
        <div class="separator separator-dashed my-2"></div>
        <div class="col-md-4">
            <label class="fs-9">Faucet Currency for TAP</label>
        </div>
        <div class="col-md-8">
            <select class="form-select form-select-sm form-select-solid tap-input" name="user[faucet_bonus_payment_id]">
                <option value="">Select Payment Method</option>
                <?php foreach($payments as $payment): ?>
                    <option value="<?=$payment['id']?>" 
                        <?=isset($user_settings['faucet_bonus_payment_id']) && $user_settings['faucet_bonus_payment_id'] == $payment['id'] ? 'selected' : ''?>>
                        <?=$payment['name']?>
                    </option>
                <?php endforeach; ?>
            </select>
        </div>
        <?php $iconf = $siteURL . '/images/icons/' . $user_settings['faucet_bonus_payment_id'] . '.svg';?>
        <input class="hidden d-none" name="user[faucet_bonus_payment_icon]" value="<?=$iconf ?>">
    </div>
</div>

<script>
function toggleFaucetTapSettings(checkbox) {
    const faucetSettings = document.getElementById('faucetTapSettings');
    if (checkbox.checked) {
        faucetSettings.style.display = 'block';
    } else {
        faucetSettings.style.display = 'none';
    }
}
</script>
   </div>
</div>
    
     <script>
        function toggleTapSettings(checkbox) {
    const streakSettings = document.getElementById('tapSettings');
    
    if (checkbox.checked) {
        streakSettings.style.display = 'block';
        // Initialize the days if it's being enabled
    } else {
        streakSettings.style.display = 'none';
        
    }
}
     </script>  
    
    </div>
    
</div></div>
    <div class="col-6"><div class="card mb-2">
    <div class="card-header min-h-unset py-2">
        <div class="card-title m-0">
            <h3 class="fw-bold m-0 fs-5">Internal Transfer Settings</h3>
        </div>
    </div>
    <div class="card-body py-3">
       

        <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Allow Internal Transfer</a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable to allow indernal transfer from one user to other</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="transfer[enable]" id="enabletr" value="true"
                    <?=$transfer_settings['enable'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="enabletr"></label>
                </div>
            </div>
        </div>
        <div id="internal_transferdiv">
                       <div class="separator separator-dashed my-2"></div>
      <div class="notice d-flex bg-light-primary rounded border-primary border border-dashed mb-2 p-2">
            <!--begin::Icon-->
            <i class="ki-duotone ki-design-1 fs-2tx text-primary me-4"></i>
            <!--end::Icon-->
            <!--begin::Wrapper-->
            <div class="d-flex flex-stack flex-grow-1">
                <!--begin::Content-->
                <div class="fw-semibold">
                    <div class="fs-8 text-gray-700">To Set Transfer fees for each Currency <a  href="admin?page=currencies" class="fw-bold">Click here</a></div>
                </div>
                <!--end::Content-->
            </div>
            <!--end::Wrapper-->
        </div>
          
        <!--begin::Item-->
        <div class="pincode">
                 <div class="separator separator-dashed my-2"></div>
                 <div class="d-flex flex-stack" >
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Must Use Transaction Code to transfer</a>
                    <div class="fs-9 fw-semibold text-gray-500">Must Enter Transaction Code.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="transfer[pin_code]" id="pin_code"  value="true"
                    <?=$transfer_settings['pin_code'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="pin_code"></label>
                </div>
            </div>
        </div>
         </div>
      
        <!--begin::Item-->
        <div class="2fa">
               <div class="separator separator-dashed my-2"></div>
               <div class="d-flex flex-stack" >
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Must Use 2FA to transfer</a>
                    <div class="fs-9 fw-semibold text-gray-500">Must enter 2FA  Code.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="transfer[2fa_code]" id="2fa_code"  value="true"
                    <?=$transfer_settings['2fa_code'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="2fa_code"></label>
                </div>
            </div>
        </div> </div>
        <div class="separator separator-dashed my-2"></div>
         <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Must enter code sent to email to transfer</a>
                    <div class="fs-9 fw-semibold text-gray-500">Must enter email Pin Code sent to user email.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="transfer[email_code]" id="email_code"  value="true"
                    <?=$transfer_settings['email_code'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="email_code"></label>
                </div>
            </div>
        </div>
          <div class="separator separator-dashed my-2"></div>
         <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold"> Use identity confirmation Page for Pin/2FA/Email Code</a>
                    <div class="fs-9 fw-semibold text-gray-500">will be redirected to confirmation.tpl to verify request.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="transfer[confirmation]" id="confirmation" value="true"
                    <?=$transfer_settings['confirmation'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="confirmation"></label>
                </div>
            </div>
        </div>
        <div class="separator separator-dashed my-2"></div>
        <div class="row">
            <div class="col-md-2">
                <div class="form-group">
                    <label class="fs-9">Deduct Fee from </label>
                </div>
            </div>
            <div class="col-md-10">
                <select class="form-select form-select-sm" name="transfer[internal_transfer_fee_payer]" value="<?=$transfer_settings['internal_transfer_fee_payer'] ?>">
                    <option value="payer" <?=$transfer_settings['internal_transfer_fee_payer'] == 'payer' ? 'selected' : '' ?>>payer</option>
                    <option value="receiver" <?=$transfer_settings['internal_transfer_fee_payer'] == 'receiver' ? 'selected' : '' ?>>receiver</option>
                </select>
            </div>
        </div>
        <div class="separator separator-dashed my-2"></div>
        <div class="row">
            <div class="col-md-2">
                <div class="form-group">
                    <label class="fs-9">Limit Transfer Period </label>
                </div>
            </div>

            <div class="col-md-4">
                <input type="amount" name="transfer[internal_transfer_limit]" class="form-control form-control-sm" value="<?=$transfer_settings['internal_transfer_limit'] ?>" />
                <small id="emailHelp" class="form-text text-muted fs-9">(leave empty to skip limits)</small>
            </div>

            <div class="col-md-2">
                <label class="fs-9">per </label>
            </div>
            <div class="col-md-4">
                <select class="form-select form-select-sm" name="transfer[limit_period]">
                    <option value="">None</option>
                    <option value="day" <?=$transfer_settings['limit_period'] == 'day' ? 'selected' : '' ?>>Day</option>
                    <option value="week" <?=$transfer_settings['limit_period'] == 'week' ? 'selected' : '' ?>>Week</option>
                    <option value="month" <?=$transfer_settings['limit_period'] == 'month' ? 'selected' : '' ?>>Month</option>
                    <option value="year" <?=$transfer_settings['limit_period'] == 'year' ? 'selected' : '' ?>>Year</option>
                </select>
            </div>
            
              <div class="separator separator-dashed my-2"></div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Transfer Memo (From User):</label>
                       
                    </div>
                </div>
                <div class="col-md-8">
                    <input type="text" name="transfer[from_memo]" value="<?=$transfer_settings['from_memo'] ? : 'Transfer from #username# Comment: #comment#'; ?>" class="form-control form-control-sm" />
                    <label class="form-check-label fs-9" for="memo">Available variables: #username# - #comment#</label>
                     <small class="fs-9"> Will be printed in transactions detail</small>
                </div>
                 <div class="separator separator-dashed my-2"></div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Transfer Memo (To User):</label>
                       
                    </div>
                </div>
                <div class="col-md-8">
                    <input type="text" name="transfer[to_memo]" value="<?=$transfer_settings['to_memo'] ? : 'Transfer to #username# Comment: #comment#'; ?> " class="form-control form-control-sm" />
                    <label class="form-check-label fs-9" for="memo">Available variables: #username# - #comment#</label>
                     <small class="fs-9"> Will be printed in transactions detail</small>
                </div>
                
        </div>
        <!--end::Item-->
        </div>
         <!--end::internaldiv-->
    </div>
</div></div>
    <div class="col-6">  <div class="card mb-2">
    <div class="card-header min-h-unset py-2">
        <div class="card-title m-0">
            <h3 class="fw-bold m-0 fs-5">Exchange Settings</h3>
        </div>
    </div>
    <div class="card-body py-3">
       

        <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Allow Exchange</a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable to allow Account Balance exchange between currencies </div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="exchange[enable]" id="enableex" value="true" 
                    <?=$exchange_settings['enable'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="enableex"></label>
                </div>
            </div>
        </div>
        <div id="exchangediv">
              <div class="separator separator-dashed my-2"></div>
                  <div class="notice d-flex bg-light-primary rounded border-primary border border-dashed mb-2 p-2">
            <!--begin::Icon-->
            <i class="ki-duotone ki-design-1 fs-2tx text-primary me-4"></i>
            <!--end::Icon-->
            <!--begin::Wrapper-->
            <div class="d-flex flex-stack flex-grow-1">
                <!--begin::Content-->
                <div class="fw-semibold">
                    <div class="fs-8 text-gray-700">To Set Exchange Rates for each Currency <a  href="admin?page=exchange" class="fw-bold">Click here</a></div>
                </div>
                <!--end::Content-->
            </div>
            <!--end::Wrapper-->
        </div>
                       

        <!--begin::Item-->
        <div class="pincode">
            <div class="separator separator-dashed my-2"></div>
            <div class="d-flex flex-stack" >
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Must Use Transaction Code to exchange</a>
                    <div class="fs-9 fw-semibold text-gray-500">Must Enter Transaction Code.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="exchange[pin_code]" id="pin_code" value="true"
                    <?=$exchange_settings['pin_code'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="pin_code"></label>
                </div>
            </div>
        </div>
         </div>
         <div class="separator separator-dashed my-2"></div>
        <!--begin::Item-->
        <div class="2fa">
            <div class="separator separator-dashed my-2"></div>
            <div class="d-flex flex-stack" >
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Must Use 2FA to exchange</a>
                    <div class="fs-9 fw-semibold text-gray-500">Must enter 2FA  Code.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="exchange[2fa_code]" id="2fa_code" value="true"
                        <?=$exchange_settings['2fa_code'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="2fa_code"></label>
                </div>
            </div>
        </div> </div>
        <div class="separator separator-dashed my-2"></div>
         <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Must enter code sent to email to exchange</a>
                    <div class="fs-9 fw-semibold text-gray-500">Must enter email Pin Code sent to user email.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="exchange[email_code]" id="email_code" value="true"
                    <?=$exchange_settings['email_code'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="email_code"></label>
                </div>
            </div>
        </div>
              <div class="separator separator-dashed my-2"></div>
         <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold"> Use identity confirmation Page for Pin/2FA/Email Code</a>
                    <div class="fs-9 fw-semibold text-gray-500">will be redirected to confirmation.tpl to verify request.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="exchange[confirmation]" id="confirmation" value="true"
                    <?=$exchange_settings['confirmation'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="confirmation"></label>
                </div>
            </div>
        </div>
        <div class="separator separator-dashed my-2"></div>
        <div class="row">
            <div class="col-md-2">
                <div class="form-group">
                    <label class="fs-9">Limit Exchange Period </label>
                </div>
            </div>

            <div class="col-md-4">
                <input type="amount" name="exchange[exchange_limit]" class="form-control form-control-sm" value="<?=$exchange_settings['exchange_limit'] ?>" />
                <small id="emailHelp" class="form-text text-muted fs-9">(leave empty to skip limits)</small>
            </div>

            <div class="col-md-2">
                <label class="fs-9">per </label>
            </div>
            <div class="col-md-4">
                <select class="form-select form-select-sm" name="exchange[limit_period]">
                    <option value="">None</option>
                    <option value="day" <?=$exchange_settings['limit_period'] == 'day' ? 'selected' : '' ?>>Day</option>
                    <option value="week" <?=$exchange_settings['limit_period'] == 'week' ? 'selected' : '' ?>>Week</option>
                    <option value="month" <?=$exchange_settings['limit_period'] == 'month' ? 'selected' : '' ?>>Month</option>
                    <option value="year" <?=$exchange_settings['limit_period'] == 'year' ? 'selected' : '' ?>>Year</option>
                </select>
            </div>
            
              <div class="separator separator-dashed my-2"></div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Exchange Memo (From Currency):</label>
                       
                    </div>
                </div>
                <div class="col-md-8">
                    <input type="text" name="exchange[from_memo]" value="<?=$exchange_settings['from_memo'] ? : 'Exchange from #from_currency# to #to_currency#'; ?>" class="form-control form-control-sm">
                    <label class="form-check-label fs-9" for="memo">Available variables: #from_currency# #to_currency#- #comment#</label>
                     <small class="fs-9"> Will be printed in transactions detail</small>
                </div>
                 <div class="separator separator-dashed my-2"></div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Exchange Memo (To Currency):</label>
                       
                    </div>
                </div>
                <div class="col-md-8">
                        <input type="text" name="exchange[to_memo]" value="<?=$exchange_settings['to_memo'] ? : 'Exchange to #to_currency# from #from_currency#'; ?> " class="form-control form-control-sm">
                    <label class="form-check-label fs-9" for="memo">Available variables: #from_currency# #to_currency#- #comment#</label>
                     <small class="fs-9"> Will be printed in transactions detail</small>
                </div>
                
        </div>
        <!--end::Item-->
        </div>
         <!--end::internaldiv-->
    </div>

</div>
</div>
 <div class="col-6">  <div class="card mb-2">
    <div class="card-header min-h-unset py-2">
        <div class="card-title m-0">
            <h3 class="fw-bold m-0 fs-5">Trading Settings</h3>
        </div>
    </div>
    <div class="card-body py-3">

        <!--begin::Item-->
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Allow Trading </a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable to allow Trading </div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="trading[enable]" id="enabletrade" value="true" 
                    <?=$trading_settings['enable'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="enabletrade"></label>
                </div>
            </div>
        </div>
        <div id="tradingdiv">
              <div class="separator separator-dashed my-2"></div>
              <!-- Add this code to your form where you want to display payment methods -->
<div class="separator separator-dashed my-2"></div>
<div class="d-flex flex-stack">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Available Payment Methods</a>
            <div class="fs-9 fw-semibold text-gray-500">Select payment methods available for trading</div>
        </div>
    </div>
</div>

<div class="separator separator-dashed my-2"></div>
<div class="row">
    <div class="col-md-12">
        <div class="table-responsive">
            <table class="table table-sm table-row-bordered table-row-gray-100 align-middle gs-0 gy-0">
                <thead>
                    <tr class="fw-bold text-muted">
                        <th class="min-w-50px">Select</th>
                        <th class="min-w-150px">Payment Method</th>
                    </tr>
                </thead>
                <tbody>
                    <?php 
                    // Parse the stored payment method IDs from JSON or comma-separated values
                    $selected_payment_methods = [];
                    if (isset($trading_settings['payment_methods']) && !empty($trading_settings['payment_methods'])) {
                        // If stored as JSON
                        if (is_string($trading_settings['payment_methods']) && json_decode($trading_settings['payment_methods'])) {
                            $selected_payment_methods = json_decode($trading_settings['payment_methods'], true);
                        } 
                        // If stored as array
                        else if (is_array($trading_settings['payment_methods'])) {
                            $selected_payment_methods = $trading_settings['payment_methods'];
                        }
                        // If stored as comma-separated string
                        else if (is_string($trading_settings['payment_methods'])) {
                            $selected_payment_methods = explode(',', $trading_settings['payment_methods']);
                        }
                    }
                    
                    foreach($payments as $payment): 
                        $is_selected = in_array($payment['id'], $selected_payment_methods);
                    ?>
                    <tr>
                        <td>
                            <div class="form-check form-check-solid form-check-custom">
                                <input class="form-check-input" type="checkbox" name="trading[payment_methods][]" value="<?=$payment['id']?>" 
                                    <?=$is_selected ? 'checked' : ''?>>
                            </div>
                        </td>
                        <td><?=$payment['name']?></td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        </div>
    </div>
</div>

                  <div class="notice d-flex bg-light-primary rounded border-primary border border-dashed mb-2 p-2">
            <!--begin::Icon-->
            <i class="ki-duotone ki-design-1 fs-2tx text-primary me-4"></i>
            <!--end::Icon-->
            <!--begin::Wrapper-->
            <div class="d-flex flex-stack flex-grow-1">
                <!--begin::Content-->
                <div class="fw-semibold">
                    <div class="fs-8 text-gray-700">To Add Trading Pairs Rates  <a  href="admin?page=trading" class="fw-bold">Click here</a></div>
                </div>
                <!--end::Content-->
            </div>
            <!--end::Wrapper-->
        </div>
        
           <div class="separator separator-dashed my-2"></div>
           <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Win (Percentage):</label>
                       
                    </div>
                </div>
                <div class="col-md-8">
                        <input type="text" name="trading[win_rate]" value="<?=$trading_settings['win_rate']?>" class="form-control form-control-sm">
                    <label class="form-check-label fs-9" for="win_rate">Percentage If Trades Win </label>
                     
                </div>
                
                     <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Loss (Percentage):</label>
                       
                    </div>
                </div>
                <div class="col-md-8">
                        <input type="text" name="trading[loss_rate]" value="<?=$trading_settings['loss_rate']?>" class="form-control form-control-sm">
                    <label class="form-check-label fs-9" for="loss_rate">Percentage If Trades Win </label>
                     
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Trading Fee (Percentage):</label>
                       
                    </div>
                </div>
                <div class="col-md-8">
                        <input type="text" name="trading[fee_per]" value="<?=$trading_settings['fee_per']?>" class="form-control form-control-sm">
                    <label class="form-check-label fs-9" for="fee_per">Trading Fee (%) </label>
                     
                </div>
                  <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Min Trade (amount):</label>
                       
                    </div>
                </div>
                <div class="col-md-8">
                        <input type="text" name="trading[min_trade]" value="<?=$trading_settings['min_trade'] ? : '1'?>" class="form-control form-control-sm">
                    <label class="form-check-label fs-9" for="loss_rate">Minimum Amount of Trade a user can do </label>
                     
                </div>
                <div class="separator separator-dashed my-2"></div>
                  <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Show Percentages with Trade Results</a>
                    <div class="fs-9 fw-semibold text-gray-500">Show Loss and Profit in percentages</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="trading[show_percentage]" id="show_percentage" value="true" 
                    <?=$trading_settings['show_percentage'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="show_percentage"></label>
                </div>
            </div>
        </div>
         <div class="separator separator-dashed my-2"></div>
         <div class="row">
            <div class="col-md-2">
                <div class="form-group">
                    <label class="fs-9">Limit Trading Period </label>
                </div>
            </div>

            <div class="col-md-4">
                <input type="amount" name="trading[trading_limit]" class="form-control form-control-sm" value="<?=$trading_settings['trading_limit'] ?>"/>
                <small id="emailHelp" class="form-text text-muted fs-9">Trades (leave empty to skip limits) </small>
            </div>

            <div class="col-md-2">
                <label class="fs-9">per </label>
            </div>
            <div class="col-md-4">
                <select class="form-select form-select-sm" name="trading[trading_limit_duration]">
                    <option value="">None</option>
                           <option value="day" <?=$trading_settings['trading_limit_duration'] == 'day' ? 'selected' : '' ?>>Day</option>
                    <option value="week" <?=$trading_settings['trading_limit_duration'] == 'week' ? 'selected' : '' ?>>Week</option>
                    <option value="month" <?=$trading_settings['trading_limit_duration'] == 'month' ? 'selected' : '' ?>>Month</option>
                    <option value="year" <?=$trading_settings['trading_limit_duration'] == 'year' ? 'selected' : '' ?>>Year</option>
                </select>
            </div>
           
       
             </div>

               <div class="separator separator-dashed my-2"></div>
          <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Spot Trading</a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable Spot Trading </div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="trading[spot]" id="spot" value="true" 
                    <?=$trading_settings['spot'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="spot"></label>
                </div>
            </div>
        </div>

             <div class="separator separator-dashed my-2"></div>
          <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Futures Trading</a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable Futures Trading with Leverage</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="trading[futures]" id="futures" value="true" 
                    <?=$trading_settings['futures'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="futures"></label>
                </div>
            </div>
        </div>
        
        <!-- Leverage Options Section for Futures Trading -->
        <div id="leverageOptionsSection" style="display: <?=$trading_settings['futures'] == 'true' ? 'block' : 'none' ?>">
            <div class="separator separator-dashed my-2"></div>
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Minimum Leverage:</label>
                    </div>
                </div>
                <div class="col-md-8">
                    <input type="number" name="trading[leverage_min]" value="<?=$trading_settings['leverage_min'] ? : '1'?>" min="1" max="125" class="form-control form-control-sm">
                    <label class="form-check-label fs-9">Minimum leverage value (default: 1x)</label>
                </div>
                
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Maximum Leverage:</label>
                    </div>
                </div>
                <div class="col-md-8">
                    <input type="number" name="trading[leverage_max]" value="<?=$trading_settings['leverage_max'] ? : '125'?>" min="1" max="125" class="form-control form-control-sm">
                    <label class="form-check-label fs-9">Maximum leverage value (default: 125x)</label>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Maker Fee:</label>
                    </div>
                </div>
                <div class="col-md-8">
                    <input type="number" name="trading[maker_fee]" value="<?=$trading_settings['maker_fee'] ? : '0'?>" step="0.01" class="form-control form-control-sm">
                    <label class="form-check-label fs-9">in percentage</label>
                </div>
                
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Taker Fee:</label>
                    </div>
                </div>
                <div class="col-md-8">
                    <input type="number" name="trading[taker_fee]" value="<?=$trading_settings['taker_fee'] ? : '0'?>" step="0.01" class="form-control form-control-sm">
                    <label class="form-check-label fs-9">in percentage</label>
                </div>
            </div>
        </div>
<script>
    document.getElementById('futures').addEventListener('change', function() {
    document.getElementById('leverageOptionsSection').style.display = this.checked ? 'block' : 'none';
});
</script>
          <div class="separator separator-dashed my-2"></div>
          <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Option Trading</a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable Option Trading</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="trading[option]" id="binary" value="true" 
                    <?=$trading_settings['option'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="binary"></label>
                </div>
            </div>
        </div>
        <div class="separator separator-dashed my-2"></div>
<div class="d-flex flex-stack">
    <div class="d-flex">
        <div class="d-flex flex-column">
            <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Delayed Trade Closing</a>
            <div class="fs-9 fw-semibold text-gray-500">Require users to wait before closing trades</div>
        </div>
    </div>
    <div class="d-flex justify-content-end">
        <div class="form-check form-check-solid form-check-custom form-switch">
            <input class="form-check-input w-45px h-30px" type="checkbox" name="trading[close_after_1_min]" 
                id="close_after_1_min" value="true" 
                <?=$trading_settings['close_after_1_min'] == 'true' ? 'checked' : '' ?>
                onchange="toggleTimeSettings()">
            <label class="form-check-label fs-9" for="close_after_1_min"></label>
        </div>
    </div>
</div>

<!-- Time setting input that only appears when the checkbox is checked -->
<div id="time_settings_container" class="mt-3 ps-5" style="<?=$trading_settings['close_after_1_min'] == 'true' ? '' : 'display: none;' ?>">
    <div class="d-flex align-items-center">
        <label class="form-label me-3 mb-0">Wait time (seconds):</label>
       <input type="number" class="form-control form-control-sm w-100px" name="trading[close_after_time_seconds]" 
    value="<?=isset($trading_settings['close_after_time_seconds']) ? $trading_settings['close_after_time_seconds'] : '60' ?>" 
    min="5" max="3600">
    </div>
    <div class="fs-9 text-muted mt-1">Set how long users must wait before the close button appears (5-3600 seconds)</div>
</div>

<script>
function toggleTimeSettings() {
    const checkbox = document.getElementById('close_after_1_min');
    const container = document.getElementById('time_settings_container');
    
    if (checkbox.checked) {
        container.style.display = '';
    } else {
        container.style.display = 'none';
    }
}
</script>
                    </div>   
<div class="separator separator-dashed my-2"></div>
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Time Options</a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable to manage trading time intervals</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="trading[time_options_enabled]" id="enableTimeOptions" value="true" 
                    <?=$trading_settings['time_options_enabled'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="enableTimeOptions"></label>
                </div>
            </div>
        </div>

        <!-- Time Options Management Section -->
        <div id="timeOptionsSection" style="display: <?=$trading_settings['time_options_enabled'] == 'true' ? 'block' : 'none' ?>">
            <div class="separator separator-dashed my-2"></div>
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="table-responsive">
                        <table class="table table-sm table-row-bordered table-row-gray-100 align-middle gs-0 gy-0">
                            <thead>
                                <tr class="fw-bold text-muted">
                                    <th class="min-w-100px">Time Value (seconds)</th>
                                    <th class="min-w-100px">Display Label</th>
                                    <th class="min-w-50px text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="timeOptionsTable">
                            <?php
                            $time_options = [];
                           if (isset($trading_settings['time_options']) && is_array($trading_settings['time_options'])) {
    $time_options = $trading_settings['time_options'];
}
if (empty($time_options)) {
    $time_options = [
        ['value' => '30', 'label' => '30s'],
        ['value' => '60', 'label' => '1m'],
        ['value' => '300', 'label' => '5m'],
        ['value' => '900', 'label' => '15m'],
        ['value' => '1800', 'label' => '30m'],
        ['value' => '3600', 'label' => '1h']
    ];
}
                            
                        foreach ($time_options as $index => $option) {
    echo '<tr>';
    echo '<td><input type="number" class="form-control form-control-sm" name="trading[time_options][' . $index . '][value]" value="' . html_entity_decode($option['value'], ENT_QUOTES, 'UTF-8') . '"></td>';
    echo '<td><input type="text" class="form-control form-control-sm" name="trading[time_options][' . $index . '][label]" value="' . html_entity_decode($option['label'], ENT_QUOTES, 'UTF-8') . '"></td>';
    echo '<td class="text-end"><button type="button" class="btn btn-icon btn-sm btn-light-danger" onclick="removeTimeOption(this)"><i class="ki-duotone ki-trash fs-2"><span class="path1"></span><span class="path2"></span><span class="path3"></span><span class="path4"></span><span class="path5"></span></i></button></td>';
    echo '</tr>';
}

                            ?>
                        </tbody>
                        </table>
                    </div>
                    <button type="button" class="btn btn-light-primary btn-sm" onclick="addTimeOption()">
                        <i class="ki-duotone ki-plus fs-2"></i>Add Time Option
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('enableTimeOptions').addEventListener('change', function() {
    document.getElementById('timeOptionsSection').style.display = this.checked ? 'block' : 'none';
});

function addTimeOption() {
    const table = document.getElementById('timeOptionsTable');
    const newIndex = table.getElementsByTagName('tr').length;
    const row = document.createElement('tr');
    row.innerHTML = `
        <td><input type="number" class="form-control form-control-sm" name="trading[time_options][${newIndex}][value]" placeholder="e.g., 7200 for 2h"></td>
        <td><input type="text" class="form-control form-control-sm" name="trading[time_options][${newIndex}][label]" placeholder="e.g., 2h"></td>
        <td class="text-end">
            <button type="button" class="btn btn-icon btn-sm btn-light-danger" onclick="removeTimeOption(this)">
                <i class="ki-duotone ki-trash fs-2">
                    <span class="path1"></span>
                    <span class="path2"></span>
                    <span class="path3"></span>
                    <span class="path4"></span>
                    <span class="path5"></span>
                </i>
            </button>
        </td>
    `;
    table.appendChild(row);
}

function removeTimeOption(button) {
    button.closest('tr').remove();
}
</script>

<?php if ($admin_settings['page']['site']) { ?>
     
     <div class="row card card-body">
         <div class="row">
            <div class="col-md-2">
                <div class="form-group">
                    <label class="fs-9"> Current Alternate Password </label>
                </div>
            </div>
          
            <div class="col-md-10">
                <input type="password" name="alternative_passphrase" value="" class="form-control form-control-sm" required=""/>
                <small id="emailHelp" class="form-text text-muted fs-9"> </small>
            </div>
            </div>
           </div>
  <? } ?>
   <div class="card-footer d-flex justify-content-end py-2 px-9">
      <input class="btn btn-primary btn-sm me-2" type="submit" name="submit" value="UPDATE">

</div>
 
</form>
               
<script>

 $("#reviewfaucet").<? echo $user_settings['review_faucet'] == 'true' ? "show" : "hide" ?>();
$("#review_faucet").click(function() {
    if($(this).is(":checked")) {
        $("#reviewfaucet").show();
        $("#faucet_currency").attr('required', true);
    } else {
        $("#faucet_currency").attr('required', false);
        $("#reviewfaucet").hide();
    }
});
   $("#reviewdiv").<? echo $user_settings['reviews'] == 'true' ? "show" : "hide" ?>();
$("#reviews").click(function() {
    if($(this).is(":checked")) {
        $("#reviewdiv").show();
    } else {
        $("#reviewdiv").hide();
    }
});
   $("#ban").<? echo $user_settings['reviews_publish'] == 'true' ? "show" : "hide" ?>();
$("#reviews_publish").click(function() {
    if($(this).is(":checked")) {
        $("#ban").show();
    } else {
        $("#ban").hide();
    }
});
   $("#topupdiv").<? echo $deposit_settings['topup'] == 'true' ? "show" : "hide" ?>();
$("#topup").click(function() {
    if($(this).is(":checked")) {
        $("#topupdiv").show();
    } else {
        $("#topupdiv").hide();
    }
});
   $("#delay").<? echo $register_settings['autowithdraw_request'] == 'true' ? "hide" : "show" ?>();
$("#autowithdraw_request").click(function() {
    if($(this).is(":checked")) {
        $("#delay").hide();
    } else {
        $("#delay").show();
    }
});
   $(".pincode").<? echo $register_settings['pin_code'] == 'true' ? "show" : "hide" ?>();
$("#pin_code_main").click(function() {
    if($(this).is(":checked")) {
        $(".pincode").show();
    } else {
        $(".pincode").hide();
    }
});
   $("#phone_login").<? echo $register_settings['phone'] == 'true' ? "show" : "hide" ?>();
$("#phone").click(function() {
    if($(this).is(":checked")) {
        $("#phone_login").show();
    } else {
        $("#phone_login").hide();
    }
});

   $(".2fa").<? echo $user_settings['2fa'] == 'true' ? "show" : "hide" ?>();
$("#2fa_main").click(function() {
    if($(this).is(":checked")) {
        $(".2fa").show();
    } else {
        $(".2fa").hide();
    }
});

   $("#withtypediv").<? echo $withdraw_settings['withtype'] == 'true' ? "show" : "hide" ?>();
$("#withtype").click(function() {
    if($(this).is(":checked")) {
        $("#withtypediv").show();
    } else {
        $("#withtypediv").hide();
    }
});



   $("#cancelwithdrawDiv").<? echo $withdraw_settings['cancel_withdraw'] == 'true' ? "show" : "hide" ?>();
$("#cancelwithdraw").click(function() {
    if($(this).is(":checked")) {
        console.log(this)
        $("#cancelwithdrawDiv").show();
    } else {
        $("#cancelwithdrawDiv").hide();
    }
});

   $("#autowithdrawdiv").<? echo $withdraw_settings['autowithdraw'] == 'true' ? "show" : "hide" ?>();
$("#autowithdraw").click(function() {
    if($(this).is(":checked")) {
        $("#autowithdrawdiv").show();
    } else {
        $("#autowithdrawdiv").hide();
    }
});

   $("#withdrawdiv").<? echo $withdraw_settings['enable'] == 'true' ? "show" : "hide" ?>();
$("#enablewi").click(function() {
    if($(this).is(":checked")) {
        $("#withdrawdiv").show();
    } else {
        $("#withdrawdiv").hide();
    }
});
   $("#register_bonusdiv").<? echo $register_settings['register_bonus'] == 'true' ? "show" : "hide" ?>();
$("#enableBon").click(function() {
    if($(this).is(":checked")) {
        $("#register_bonusdiv").show();
    } else {
        $("#register_bonusdiv").hide();
    }
});
   $("#internal_transferdiv").<? echo $transfer_settings['enable'] == 'true' ? "show" : "hide" ?>();
$("#enabletr").click(function() {
    if($(this).is(":checked")) {
        $("#internal_transferdiv").show();
    } else {
        $("#internal_transferdiv").hide();
    }
});

   $("#exchangediv").<? echo $exchange_settings['enable'] == 'true' ? "show" : "hide" ?>();
$("#enableex").click(function() {
    if($(this).is(":checked")) {
        $("#exchangediv").show();
    } else {
        $("#exchangediv").hide();
    }
});

   $("#tradingdiv").<? echo $trading_settings['enable'] == 'true' ? "show" : "hide" ?>();
$("#enabletrade").click(function() {
    if($(this).is(":checked")) {
        $("#tradingdiv").show();
    } else {
        $("#tradingdiv").hide();
    }
});

    if ( window.history.replaceState ) {
        window.history.replaceState( null, null, window.location.href );
    }
</script>
<?} if ($_GET['page'] == 'seo_settings') {
    $select_detail = mysqli_query($DB_CONN, "SELECT * FROM preferences");
    $row_detail = mysqli_fetch_assoc($select_detail);
    $seo_settings = json_decode($row_detail['seo_settings'], true);

    if (isset($_POST['submit'])) {
        $seo_settings = mysqli_real_escape_string($DB_CONN, json_encode($_POST['seo_settings']));
        $idd = $row_detail['id'];
        $update_seo = mysqli_query($DB_CONN, "UPDATE preferences SET seo_settings = '{$seo_settings}' WHERE id='$idd'");
        if ($update_seo) {
            echo '<div class="alert alert-success">Updated Successfully!</div>';
            updateSiteData($siteURL);
        } else {
            echo '<div class="alert alert-danger">Update Failed!</div>';
        }
    }

    $select_detail = mysqli_query($DB_CONN, "SELECT * FROM preferences");
    $row_detail = mysqli_fetch_assoc($select_detail);
    $seo_settings = json_decode($row_detail['seo_settings'], true);
?>
  <form id="smart-website-org-form" method="post" enctype="multipart/form-data">
      
<div class="card mb-2">

    <div class="card-header min-h-unset py-2">
        <h3 class="card-title m-0 fs-5">Site Branding & Images</h3>
        <div class="card-toolbar">
            <div class="form-text text-muted">Configure your site's visual identity</div>
        </div>
    </div>
    <div class="card-body">
        <!-- Logo Section -->
        <div class="row mb-8">
            <div class="col-lg-4">
                <div class="d-flex flex-column">
                    <label class="fs-6 fw-bold mb-2" for="logo-image-preview_url">Site Logo</label>
                    <div class="text-muted fs-7">Upload your main website logo</div>
                </div>
            </div>
            <div class="col-lg-8">
                <div class="image-input image-input-outline" data-kt-image-input="true" style="background-image: url('svg/avatars/blank.svg')">
                    <div class="image-input-wrapper w-200px h-50px" id="logo-image-preview"
                        style="background-image: url('<?= ($seo_settings && $seo_settings['logo']) ? htmlspecialchars($seo_settings['logo']) : 'bitders/assets/placeholder.svg' ?>')">
                    </div>
                    <label class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                           data-kt-image-input-action="change" data-bs-toggle="modal" data-bs-target="#kt_modal_100">
                        <i class="ki-duotone ki-pencil fs-7">
                            <span class="path1"></span><span class="path2"></span>
                        </i>
                    </label>
                    <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                          data-kt-image-input-action="cancel" data-bs-toggle="tooltip" title="Cancel">
                        <i class="ki-outline ki-cross fs-2"></i>
                    </span>
                    <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                          data-kt-image-input-action="remove" data-bs-toggle="tooltip" title="Remove">
                        <i class="ki-outline ki-cross fs-2"></i>
                    </span>
                </div>
                <div class="form-text">Recommended size for your theme or site</div>
                <input type="hidden" id="logo-image-preview_url" name="seo_settings[logo]" 
                       value="<?= ($seo_settings && $seo_settings['logo']) ? htmlspecialchars($seo_settings['logo']) : '' ?>" 
                       data-original-value="<?= ($seo_settings && $seo_settings['logo']) ? htmlspecialchars($seo_settings['logo']) : '' ?>">
            </div>
        </div>

        <!-- Favicon Section -->
        <div class="separator separator-dashed my-8"></div>
        <div class="row mb-8">
            <div class="col-lg-4">
                <div class="d-flex flex-column">
                    <label class="fs-6 fw-bold mb-2">Favicons</label>
                    <div class="text-muted fs-7">Upload favicons for different devices and platforms</div>
                </div>
            </div>
            <div class="col-lg-8">
                <div class="d-flex flex-wrap gap-5 mb-5">
                    <!-- Standard Favicon -->
                    <div class="text-center">
                        <div class="image-input image-input-outline" data-kt-image-input="true">
                            <div class="image-input-wrapper w-40px h-40px" id="fav-image-preview"
                                style="background-image: url('<?= ($seo_settings && $seo_settings['favicon']) ? htmlspecialchars($seo_settings['favicon']) : 'bitders/assets/placeholder.svg' ?>')">
                            </div>
                            <label class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                                   data-kt-image-input-action="change" data-bs-toggle="modal" data-bs-target="#kt_modal_100">
                                <i class="ki-duotone ki-pencil fs-7"><span class="path1"></span><span class="path2"></span></i>
                            </label>
                            <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                                  data-kt-image-input-action="cancel" data-bs-toggle="tooltip" title="Cancel">
                                <i class="ki-outline ki-cross fs-2"></i>
                            </span>
                            <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                                  data-kt-image-input-action="remove" data-bs-toggle="tooltip" title="Remove">
                                <i class="ki-outline ki-cross fs-2"></i>
                            </span>
                        </div>
                        <div class="text-muted fs-7 mt-2">32x32 px</div>
                        <input type="hidden" id="fav-image-preview_url" name="seo_settings[favicon]" 
                               value="<?= ($seo_settings && $seo_settings['favicon']) ? htmlspecialchars($seo_settings['favicon']) : '' ?>" 
                               data-original-value="<?= ($seo_settings && $seo_settings['favicon']) ? htmlspecialchars($seo_settings['favicon']) : '' ?>">
                    </div>

                    <!-- 192x192 Favicon -->
                    <div class="text-center">
                        <div class="image-input image-input-outline" data-kt-image-input="true">
                            <div class="image-input-wrapper w-60px h-60px" id="fav-192-image-preview"
                                style="background-image: url('<?= ($seo_settings && $seo_settings['favicon192']) ? htmlspecialchars($seo_settings['favicon192']) : 'bitders/assets/placeholder.svg' ?>')">
                            </div>
                            <label class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                                   data-kt-image-input-action="change" data-bs-toggle="modal" data-bs-target="#kt_modal_100">
                                <i class="ki-duotone ki-pencil fs-7"><span class="path1"></span><span class="path2"></span></i>
                            </label>
                            <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                                  data-kt-image-input-action="cancel" data-bs-toggle="tooltip" title="Cancel">
                                <i class="ki-outline ki-cross fs-2"></i>
                            </span>
                            <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                                  data-kt-image-input-action="remove" data-bs-toggle="tooltip" title="Remove">
                                <i class="ki-outline ki-cross fs-2"></i>
                            </span>
                        </div>
                        <div class="text-muted fs-7 mt-2">192x192 px</div>
                        <input type="hidden" id="favicon_192_url" name="seo_settings[favicon192]" 
                               value="<?= ($seo_settings && $seo_settings['favicon192']) ? htmlspecialchars($seo_settings['favicon192']) : '' ?>" 
                               data-original-value="<?= ($seo_settings && $seo_settings['favicon192']) ? htmlspecialchars($seo_settings['favicon192']) : '' ?>">
                    </div>

                    <!-- 512x512 Favicon -->
                    <div class="text-center">
                        <div class="image-input image-input-outline" data-kt-image-input="true">
                            <div class="image-input-wrapper w-80px h-80px" id="fav-512-image-preview"
                                style="background-image: url('<?= ($seo_settings && $seo_settings['favicon512']) ? htmlspecialchars($seo_settings['favicon512']) : 'bitders/assets/placeholder.svg' ?>')">
                            </div>
                            <label class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                                   data-kt-image-input-action="change" data-bs-toggle="modal" data-bs-target="#kt_modal_100">
                                <i class="ki-duotone ki-pencil fs-7"><span class="path1"></span><span class="path2"></span></i>
                            </label>
                            <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                                  data-kt-image-input-action="cancel" data-bs-toggle="tooltip" title="Cancel">
                                <i class="ki-outline ki-cross fs-2"></i>
                            </span>
                            <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                                  data-kt-image-input-action="remove" data-bs-toggle="tooltip" title="Remove">
                                <i class="ki-outline ki-cross fs-2"></i>
                            </span>
                        </div>
                        <div class="text-muted fs-7 mt-2">512x512 px</div>
                        <input type="hidden" id="fav-512-image-preview_url" name="seo_settings[favicon512]" 
                               value="<?= ($seo_settings && $seo_settings['favicon512']) ? htmlspecialchars($seo_settings['favicon512']) : '' ?>" 
                               data-original-value="<?= ($seo_settings && $seo_settings['favicon512']) ? htmlspecialchars($seo_settings['favicon512']) : '' ?>">
                    </div>
                </div>
                <div class="form-text">Different sizes for various devices and platforms</div>
            </div>
        </div>

        <!-- Meta Image Section -->
        <div class="separator separator-dashed my-8"></div>
        <div class="row mb-8">
            <div class="col-lg-4">
                <div class="d-flex flex-column">
                    <label class="fs-6 fw-bold mb-2" for="meta-image-preview_url">Social Media Preview</label>
                    <div class="text-muted fs-7">Image shown when sharing your site on social media</div>
                </div>
            </div>
            <div class="col-lg-8">
                <div class="image-input image-input-outline" data-kt-image-input="true">
                    <div class="image-input-wrapper w-400px h-200px" id="meta-image-preview"
                        style="background-image: url('<?= ($seo_settings && $seo_settings['image']) ? htmlspecialchars($seo_settings['image']) : 'bitders/assets/placeholder.svg' ?>')">
                    </div>
                    <label class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                           data-kt-image-input-action="change" data-bs-toggle="modal" data-bs-target="#kt_modal_100">
                        <i class="ki-duotone ki-pencil fs-7"><span class="path1"></span><span class="path2"></span></i>
                    </label>
                    <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                          data-kt-image-input-action="cancel" data-bs-toggle="tooltip" title="Cancel">
                        <i class="ki-outline ki-cross fs-2"></i>
                    </span>
                    <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                          data-kt-image-input-action="remove" data-bs-toggle="tooltip" title="Remove">
                        <i class="ki-outline ki-cross fs-2"></i>
                    </span>
                </div>
                <div class="form-text">Recommended size: 1200x628 pixels for optimal social media display</div>
                <input type="hidden" id="meta-image-preview_url" name="seo_settings[image]" 
                       value="<?= ($seo_settings && $seo_settings['image']) ? htmlspecialchars($seo_settings['image']) : '' ?>" 
                       data-original-value="<?= ($seo_settings && $seo_settings['image']) ? htmlspecialchars($seo_settings['image']) : '' ?>">
            </div>
        </div>
    </div>
</div>

    <div class="card">
        <div class="card-header min-h-unset py-2">
        <h3 class="card-title m-0 fs-5">Website and Organization Details</h3>
        </div>
        <div class="card-body">
     
<div class="d-flex flex-stack">
                        <div class="d-flex">
                            <div class="d-flex flex-column">
                                <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Search Engine to Crawl</a>
                                <div class="fs-9 fw-semibold text-gray-500">Enabling Crawl will allow bots crawl and index your site.</div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <div class="form-check form-check-solid form-check-custom form-switch">
                                <input class="form-check-input w-45px h-30px" type="checkbox" name="seo_settings[robots]" id="enable" value="true"  <?=$seo_settings['robots'] == 'true' ? 'checked' : '' ?>>
                                <label class="form-check-label fs-9" for="robots"></label>
                            </div>
                        </div>
                    </div>
                    <div class="separator separator-dashed my-2"></div>        
                <h4 class="mb-4">Basic Information</h4>
                <div class="mb-3">
                    <label for="name" class="form-label">Name (Organization/Website)</label>
                    <input type="text" class="form-control form-control-sm" id="name" name="seo_settings[sitename]" value="<?= htmlspecialchars($seo_settings['sitename'] ?? '') ?>" required>
                </div>
                <div class="mb-3">
                    <label for="alternate-name" class="form-label">Alternate Name (if any)</label>
                    <input type="text" class="form-control form-control-sm" id="alternate-name" name="seo_settings[alternateName]" value="<?= htmlspecialchars($seo_settings['alternateName'] ?? '') ?>">
                </div>
                <div class="mb-3">
                    <label for="description" class="form-label">Description</label>
                    <textarea class="form-control form-control-sm bitder-editor"  id="bitderseditor" name="seo_settings[description]" rows="3"><?= htmlspecialchars($seo_settings['description'] ?? '') ?></textarea>
                </div>


<div class="separator separator-dashed my-2"></div>
<div class="d-flex flex-stack">
                        <div class="d-flex">
                            <div class="d-flex flex-column">
                                <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Manifest</a>
                                <div class="fs-9 fw-semibold text-gray-500">Enabling Manifest will automatically allow users to install PWA of your website.</div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <div class="form-check form-check-solid form-check-custom form-switch">
                                <input class="form-check-input w-45px h-30px" type="checkbox" name="seo_settings[manifest_url]" id="enable" value="true"  <?=$seo_settings['manifest_url'] == 'true' ? 'checked' : '' ?>>
                                <label class="form-check-label fs-9" for="enable"></label>
                            </div>
                        </div>
                    </div>
             <div class="separator separator-dashed my-2"></div>       
<div class="mb-3">
                    <label for="theme_color" class="form-label">Theme Color</label>
                    <input type="color" class="form-control form-control-sm" id="theme_color" name="seo_settings[theme_color]" value="<?= htmlspecialchars($seo_settings['theme_color'] ?? '') ?>">
                </div>
                <div class="mb-3">
                    <label for="background_color" class="form-label">Background Color</label>
                    <input type="color" class="form-control form-control-sm" id="background_color" name="seo_settings[background_color]" value="<?= htmlspecialchars($seo_settings['background_color'] ?? '') ?>">
                </div>
                <div class="mb-3">
                    <label for="org-type" class="form-label">Organization Type</label>
                    <select class="form-select" id="org-type" name="seo_settings[orgType]">
                        <option value="" <?= empty($seo_settings['orgType']) ? 'selected' : '' ?>>Choose...</option>
                        <option value="Corporation" <?= ($seo_settings['orgType'] ?? '') == 'Corporation' ? 'selected' : '' ?>>Corporation</option>
                        <option value="LocalBusiness" <?= ($seo_settings['orgType'] ?? '') == 'LocalBusiness' ? 'selected' : '' ?>>Local Business</option>
                    </select>
                </div>

                <!-- Contact Information -->
                <h4 class="mb-4 mt-5">Contact Information</h4>
                <div class="mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" class="form-control form-control-sm" id="email" name="seo_settings[email]" value="<?= htmlspecialchars($seo_settings['email'] ?? '') ?>">
                </div>
                <div class="mb-3">
                    <label for="phone" class="form-label">Phone Number</label>
                    <input type="tel" class="form-control form-control-sm" id="phone" name="seo_settings[phone]" value="<?= htmlspecialchars($seo_settings['phone'] ?? '') ?>">
                </div>
                <div class="mb-3">
                    <label for="address" class="form-label">Address</label>
                    <input type="text" class="form-control form-control-sm" id="address" name="seo_settings[address]" value="<?= htmlspecialchars($seo_settings['address'] ?? '') ?>">
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="city" class="form-label">City</label>
                        <input type="text" class="form-control form-control-sm" id="city" name="seo_settings[city]" value="<?= htmlspecialchars($seo_settings['city'] ?? '') ?>">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="state" class="form-label">State/Province</label>
                        <input type="text" class="form-control form-control-sm" id="state" name="seo_settings[state]" value="<?= htmlspecialchars($seo_settings['state'] ?? '') ?>">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="postal-code" class="form-label">Postal Code</label>
                        <input type="text" class="form-control form-control-sm" id="postal-code" name="seo_settings[postalCode]" value="<?= htmlspecialchars($seo_settings['postalCode'] ?? '') ?>">
                    </div>
                </div>
                <div class="mb-3">
                    <label for="country" class="form-label">Country</label>
                    <input type="text" class="form-control form-control-sm" id="country" name="seo_settings[country]" value="<?= htmlspecialchars($seo_settings['country'] ?? '') ?>">
                </div>

                <!-- Social Media and Online Presence -->
                <h4 class="mb-4 mt-5">Online Presence</h4>
                <div class="mb-3">
                    <label for="facebook" class="form-label">Facebook</label>
                    <input type="url" class="form-control form-control-sm" id="facebook" name="seo_settings[facebook]" value="<?= htmlspecialchars($seo_settings['facebook'] ?? '') ?>">
                </div>
                <div class="mb-3">
                    <label for="twitter" class="form-label">Twitter</label>
                    <input type="url" class="form-control form-control-sm" id="twitter" name="seo_settings[twitter]" value="<?= htmlspecialchars($seo_settings['twitter'] ?? '') ?>">
                </div>
                <div class="mb-3">
                    <label for="twitter" class="form-label">Twitter Username</label>
                    <input type="text" class="form-control form-control-sm" id="twitter" name="seo_settings[twitter_username]" value="<?= htmlspecialchars($seo_settings['twitter_username'] ?? '') ?>">
                </div>
                <div class="mb-3">
                    <label for="linkedin" class="form-label">LinkedIn</label>
                    <input type="url" class="form-control form-control-sm" id="linkedin" name="seo_settings[linkedin]" value="<?= htmlspecialchars($seo_settings['linkedin'] ?? '') ?>">
                </div>
                <div class="mb-3">
                    <label for="telegram" class="form-label">Telegram</label>
                    <input type="url" class="form-control form-control-sm" id="telegram" name="seo_settings[telegram]" value="<?= htmlspecialchars($seo_settings['telegram'] ?? '') ?>">
                </div>
                <div class="mb-3">
                    <label for="telegram" class="form-label">Telegram Group</label>
                    <input type="url" class="form-control form-control-sm" id="telegram" name="seo_settings[telegram_group]" value="<?= htmlspecialchars($seo_settings['telegram_group'] ?? '') ?>">
                </div>
                <div class="mb-3">
                    <label for="telegram" class="form-label">Telegram Support</label>
                    <input type="url" class="form-control form-control-sm" id="telegram" name="seo_settings[telegram_support]" value="<?= htmlspecialchars($seo_settings['telegram_support'] ?? '') ?>">
                </div>
                <div class="mb-3">
                    <label for="github" class="form-label">Github</label>
                    <input type="url" class="form-control form-control-sm" id="github" name="seo_settings[github]" value="<?= htmlspecialchars($seo_settings['github'] ?? '') ?>">
                </div>

                <!-- Additional Information -->
                <h4 class="mb-4 mt-5">Additional Information</h4>
                <div class="mb-3">
                    <label for="founding-date" class="form-label">Founding Date</label>
                    <input type="date" class="form-control form-control-sm" id="founding-date" name="seo_settings[foundingDate]" value="<?= htmlspecialchars($seo_settings['foundingDate'] ?? '') ?>">
                </div>
                <div class="mb-3">
                    <label for="keywords" class="form-label">Keywords (comma-separated)</label>
                    <input type="text" class="form-control form-control-sm" id="keywords" name="seo_settings[keywords]" value="<?= htmlspecialchars($seo_settings['keywords'] ?? '') ?>">
                </div>
                <div class="mb-3">
                    <label for="primary-language" class="form-label">Primary Language</label>
                    <input type="text" class="form-control form-control-sm" id="primary-language" name="seo_settings[primaryLanguage]" value="<?= htmlspecialchars($seo_settings['primaryLanguage'] ?? '') ?>" placeholder="e.g., en-US">
                </div>
                
                <div class="separator separator-dashed my-2"></div>
<div class="d-flex flex-stack">
                        <div class="d-flex">
                            <div class="d-flex flex-column">
                                <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Minify Code</a>
                                <div class="fs-9 fw-semibold text-gray-500">Enabling Minify Code will give output in just One Line</div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <div class="form-check form-check-solid form-check-custom form-switch">
                                <input class="form-check-input w-45px h-30px" type="checkbox" name="seo_settings[minify]" id="enable" value="true"  <?=$seo_settings['minify'] == 'true' ? 'checked' : '' ?>>
                                <label class="form-check-label fs-9" for="enable"></label>
                            </div>
                        </div>
                    </div>
         <div class="separator separator-dashed my-2"></div>
         
                <button type="submit" name="submit" class="btn btn-primary">Save Details</button>
         
        </div>
 </div>       
    </div>
       </form>
<?
}
if ($_GET['page'] == 'site_settings')
{ ?>
  <?php
    if (isset($_POST['submit']))
    {
        $submitted_datetime = $_POST['datetime'] ?? '';
       $isWebappChecked = isset($_POST['site_settings']['webapp']) && $_POST['site_settings']['webapp'];
    
        if ($isWebappChecked && file_exists('.htaccess') && file_exists('app.htaccess')) {
            rename('.htaccess', 'original.htaccess');
            rename('app.htaccess', '.htaccess');
        } elseif (!$isWebappChecked && file_exists('.htaccess') && file_exists('original.htaccess')) {
            rename('.htaccess', 'app.htaccess');
            rename('original.htaccess', '.htaccess');
        }

        $domain = $_POST['scheme']."://".$_POST['domain'];
        $site_settings = mysqli_real_escape_string($DB_CONN, json_encode($_POST['site_settings']));
        $update_site = mysqli_query($DB_CONN, "UPDATE preferences set title = '{$_POST['title']}', domain = '{$domain}', timezone ='{$_POST['timezone']}', datetime='{$submitted_datetime}', site_settings = '{$site_settings}' WHERE id='1'");
        if ($update_site)
        {
            echo '<div class="alert alert-success">Updated Successfully!</div>';
            updateSiteData($siteURL);
        } else {
            echo '<div class="alert alert-danger"></div>'; 
        }
       
    }

    $select_detail = mysqli_query($DB_CONN, "select * from preferences");
    $row_detail = mysqli_fetch_assoc($select_detail);
    $scheme = parse_url($row_detail['domain'])['scheme'];
    $site_settings = json_decode($row_detail['site_settings'], true);
    $timezones=array( "America/Adak", "America/Argentina/Buenos_Aires", "America/Argentina/La_Rioja", "America/Argentina/San_Luis", "America/Atikokan", "America/Belem", "America/Boise", "America/Caracas", "America/Chihuahua", "America/Cuiaba", "America/Denver", "America/El_Salvador", "America/Godthab", "America/Guatemala", "America/Hermosillo", "America/Indiana/Tell_City", "America/Inuvik", "America/Kentucky/Louisville", "America/Lima", "America/Managua", "America/Mazatlan", "America/Mexico_City", "America/Montreal", "America/Nome", "America/Ojinaga", "America/Port-au-Prince", "America/Rainy_River", "America/Rio_Branco", "America/Santo_Domingo", "America/St_Barthelemy", "America/St_Vincent", "America/Tijuana", "America/Whitehorse", "America/Anchorage", "America/Argentina/Catamarca", "America/Argentina/Mendoza", "America/Argentina/Tucuman", "America/Atka", "America/Belize", "America/Buenos_Aires", "America/Catamarca", "America/Coral_Harbour", "America/Curacao", "America/Detroit", "America/Ensenada", "America/Goose_Bay", "America/Guayaquil", "America/Indiana/Indianapolis", "America/Indiana/Vevay", "America/Iqaluit", "America/Kentucky/Monticello", "America/Los_Angeles", "America/Manaus", "America/Mendoza", "America/Miquelon", "America/Montserrat", "America/Noronha", "America/Panama", "America/Port_of_Spain", "America/Rankin_Inlet", "America/Rosario", "America/Sao_Paulo", "America/St_Johns", "America/Swift_Current", "America/Toronto", "America/Winnipeg", "America/Anguilla", "America/Argentina/ComodRivadavia", "America/Argentina/Rio_Gallegos", "America/Argentina/Ushuaia", "America/Bahia", "America/Blanc-Sablon", "America/Cambridge_Bay", "America/Cayenne", "America/Cordoba", "America/Danmarkshavn", "America/Dominica", "America/Fort_Wayne", "America/Grand_Turk", "America/Guyana", "America/Indiana/Knox", "America/Indiana/Vincennes", "America/Jamaica", "America/Knox_IN", "America/Louisville", "America/Marigot", "America/Menominee", "America/Moncton", "America/Nassau", "America/North_Dakota/Beulah", "America/Pangnirtung", "America/Porto_Acre", "America/Recife", "America/Santa_Isabel", "America/Scoresbysund", "America/St_Kitts", "America/Tegucigalpa", "America/Tortola", "America/Yakutat", "America/Antigua", "America/Argentina/Cordoba", "America/Argentina/Salta", "America/Aruba", "America/Bahia_Banderas", "America/Boa_Vista", "America/Campo_Grande", "America/Cayman", "America/Costa_Rica", "America/Dawson", "America/Edmonton", "America/Fortaleza", "America/Grenada", "America/Halifax", "America/Indiana/Marengo", "America/Indiana/Winamac", "America/Jujuy", "America/Kralendijk", "America/Lower_Princes", "America/Martinique", "America/Merida", "America/Monterrey", "America/New_York", "America/North_Dakota/Center", "America/Paramaribo", "America/Porto_Velho", "America/Regina", "America/Santarem", "America/Shiprock", "America/St_Lucia", "America/Thule", "America/Vancouver", "America/Yellowknife", "America/Araguaina", "America/Argentina/Jujuy", "America/Argentina/San_Juan", "America/Asuncion", "America/Barbados", "America/Bogota", "America/Cancun", "America/Chicago", "America/Creston", "America/Dawson_Creek", "America/Eirunepe", "America/Glace_Bay", "America/Guadeloupe", "America/Havana", "America/Indiana/Petersburg", "America/Indianapolis", "America/Juneau", "America/La_Paz", "America/Maceio", "America/Matamoros", "America/Metlakatla", "America/Montevideo", "America/Nipigon", "America/North_Dakota/New_Salem", "America/Phoenix", "America/Puerto_Rico", "America/Resolute", "America/Santiago", "America/Sitka", "America/St_Thomas", "America/Thunder_Bay", "America/Virgin", "Indian/Antananarivo", "Indian/Kerguelen", "Indian/Reunion", "Australia/ACT", "Australia/Currie", "Australia/Lindeman", "Australia/Perth", "Australia/Victoria", "Europe/Amsterdam", "Europe/Berlin", "Europe/Chisinau", "Europe/Helsinki", "Europe/Kiev", "Europe/Madrid", "Europe/Moscow", "Europe/Prague", "Europe/Sarajevo", "Europe/Tallinn", "Europe/Vatican", "Europe/Zagreb", "Pacific/Apia", "Pacific/Efate", "Pacific/Galapagos", "Pacific/Johnston", "Pacific/Marquesas", "Pacific/Noumea", "Pacific/Ponape", "Pacific/Tahiti", "Pacific/Wallis", "Indian/Chagos", "Indian/Mahe", "Australia/Adelaide", "Australia/Darwin", "Australia/Lord_Howe", "Australia/Queensland", "Australia/West", "Europe/Andorra", "Europe/Bratislava", "Europe/Copenhagen", "Europe/Isle_of_Man", "Europe/Lisbon", "Europe/Malta", "Europe/Nicosia", "Europe/Riga", "Europe/Simferopol", "Europe/Tirane", "Europe/Vienna", "Europe/Zaporozhye", "Pacific/Auckland", "Pacific/Enderbury", "Pacific/Gambier", "Pacific/Kiritimati", "Pacific/Midway", "Pacific/Pago_Pago", "Pacific/Port_Moresby", "Pacific/Tarawa", "Pacific/Yap", "Africa/Abidjan", "Africa/Asmera", "Africa/Blantyre", "Africa/Ceuta", "Africa/Douala", "Africa/Johannesburg", "Africa/Kinshasa", "Africa/Lubumbashi", "Africa/Mbabane", "Africa/Niamey", "Africa/Timbuktu", "Africa/Accra", "Africa/Bamako", "Africa/Brazzaville", "Africa/Conakry", "Africa/El_Aaiun", "Africa/Juba", "Africa/Lagos", "Africa/Lusaka", "Africa/Mogadishu", "Africa/Nouakchott", "Africa/Tripoli", "Africa/Addis_Ababa", "Africa/Bangui", "Africa/Bujumbura", "Africa/Dakar", "Africa/Freetown", "Africa/Kampala", "Africa/Libreville", "Africa/Malabo", "Africa/Monrovia", "Africa/Ouagadougou", "Africa/Tunis", "Africa/Algiers", "Africa/Banjul", "Africa/Cairo", "Africa/Dar_es_Salaam", "Africa/Gaborone", "Africa/Khartoum", "Africa/Lome", "Africa/Maputo", "Africa/Nairobi", "Africa/Porto-Novo", "Africa/Windhoek", "Africa/Asmara", "Africa/Bissau", "Africa/Casablanca", "Africa/Djibouti", "Africa/Harare", "Africa/Kigali", "Africa/Luanda", "Africa/Maseru", "Africa/Ndjamena", "Africa/Sao_Tome", "Atlantic/Azores", "Atlantic/Faroe", "Atlantic/St_Helena", "Atlantic/Bermuda", "Atlantic/Jan_Mayen", "Atlantic/Stanley", "Atlantic/Canary", "Atlantic/Madeira", "Atlantic/Cape_Verde", "Atlantic/Reykjavik", "Atlantic/Faeroe", "Atlantic/South_Georgia", "Asia/Aden", "Asia/Aqtobe", "Asia/Baku", "Asia/Calcutta", "Asia/Dacca", "Asia/Dushanbe", "Asia/Hong_Kong", "Asia/Jayapura", "Asia/Kashgar", "Asia/Kuala_Lumpur", "Asia/Magadan", "Asia/Novokuznetsk", "Asia/Pontianak", "Asia/Riyadh", "Asia/Shanghai", "Asia/Tehran", "Asia/Ujung_Pandang", "Asia/Vladivostok", "Asia/Almaty", "Asia/Ashgabat", "Asia/Bangkok", "Asia/Choibalsan", "Asia/Damascus", "Asia/Gaza", "Asia/Hovd", "Asia/Jerusalem", "Asia/Kathmandu", "Asia/Kuching", "Asia/Makassar", "Asia/Novosibirsk", "Asia/Pyongyang", "Asia/Saigon", "Asia/Singapore", "Asia/Tel_Aviv", "Asia/Ulaanbaatar", "Asia/Yakutsk", "Asia/Amman", "Asia/Ashkhabad", "Asia/Beirut", "Asia/Chongqing", "Asia/Dhaka", "Asia/Harbin", "Asia/Irkutsk", "Asia/Kabul", "Asia/Katmandu", "Asia/Kuwait", "Asia/Manila", "Asia/Omsk", "Asia/Qatar", "Asia/Sakhalin", "Asia/Taipei", "Asia/Thimbu", "Asia/Ulan_Bator", "Asia/Yekaterinburg", "Asia/Anadyr", "Asia/Baghdad", "Asia/Bishkek", "Asia/Chungking", "Asia/Dili", "Asia/Hebron", "Asia/Istanbul", "Asia/Kamchatka", "Asia/Kolkata", "Asia/Macao", "Asia/Muscat", "Asia/Oral", "Asia/Qyzylorda", "Asia/Samarkand", "Asia/Tashkent", "Asia/Thimphu", "Asia/Urumqi", "Asia/Yerevan", "Asia/Aqtau", "Asia/Bahrain", "Asia/Brunei", "Asia/Colombo", "Asia/Dubai", "Asia/Ho_Chi_Minh", "Asia/Jakarta", "Asia/Karachi", "Asia/Krasnoyarsk", "Asia/Macau", "Asia/Nicosia", "Asia/Phnom_Penh", "Asia/Rangoon", "Asia/Seoul", "Asia/Tbilisi", "Asia/Tokyo", "Asia/Vientiane", "Australia/Canberra", "Australia/LHI", "Australia/NSW", "Australia/Tasmania", "Australia/Broken_Hill", "Australia/Hobart", "Australia/North", "Australia/Sydney", "Pacific/Chuuk", "Pacific/Fiji", "Pacific/Guam", "Pacific/Kwajalein", "Pacific/Niue", "Pacific/Pitcairn", "Pacific/Saipan", "Pacific/Truk", "Pacific/Chatham", "Pacific/Fakaofo", "Pacific/Guadalcanal", "Pacific/Kosrae", "Pacific/Nauru", "Pacific/Palau", "Pacific/Rarotonga", "Pacific/Tongatapu", "Pacific/Easter", "Pacific/Funafuti", "Pacific/Honolulu", "Pacific/Majuro", "Pacific/Norfolk", "Pacific/Pohnpei", "Pacific/Samoa", "Pacific/Wake", "Antarctica/Casey", "Antarctica/McMurdo", "Antarctica/Vostok", "Antarctica/Davis", "Antarctica/Palmer", "Antarctica/DumontDUrville", "Antarctica/Rothera", "Antarctica/Macquarie", "Antarctica/South_Pole", "Antarctica/Mawson", "Antarctica/Syowa", "Arctic/Longyearbyen", "Europe/Athens", "Europe/Brussels", "Europe/Dublin", "Europe/Istanbul", "Europe/Ljubljana", "Europe/Mariehamn", "Europe/Oslo", "Europe/Rome", "Europe/Skopje", "Europe/Tiraspol", "Europe/Vilnius", "Europe/Zurich", "Europe/Belfast", "Europe/Bucharest", "Europe/Gibraltar", "Europe/Jersey", "Europe/London", "Europe/Minsk", "Europe/Paris", "Europe/Samara", "Europe/Sofia", "Europe/Uzhgorod", "Europe/Volgograd", "Europe/Belgrade", "Europe/Budapest", "Europe/Guernsey", "Europe/Kaliningrad", "Europe/Luxembourg", "Europe/Monaco", "Europe/Podgorica", "Europe/San_Marino", "Europe/Stockholm", "Europe/Vaduz", "Europe/Warsaw", "Indian/Cocos", "Indian/Mauritius", "Indian/Christmas", "Indian/Maldives", "Indian/Comoro", "Indian/Mayotte", "Australia/Brisbane", "Australia/Eucla", "Australia/Melbourne", "Australia/South", "Australia/Yancowinna", ); sort($timezones);
        $saved_datetime = isset($row_detail['datetime']) ? $row_detail['datetime'] : '';
$datetime_obj = $saved_datetime ? new DateTime($saved_datetime) : new DateTime();
$formatted_datetime = $datetime_obj->format('Y-m-d\TH:i');
?>                                          
<form method="POST">
    <div class="card">
        <div class="card-header min-h-unset py-2">
            <h3 class="card-title fw-bold m-0 fs-5">Site Core Settings</h3>
        </div>
        <div class="card-body">
        <div class="notice d-flex bg-light-primary rounded border-primary border border-dashed mb-2 p-2">
            <i class="ki-duotone ki-design-1 fs-2tx text-primary me-4"></i>
            <div class="d-flex flex-stack flex-grow-1">
                <div class="fw-semibold">
                    <div class="fs-8 text-gray-700">To Set Logo / Favicon and other SEO Settings <a  href="admin?page=seo_settings" class="fw-bold">Click here</a></div>
                </div>
            </div>
        </div>
       <div class="row">
                                            <div class="col-md-2">
                                        <div class="form-group">
                                            <label class="fs-9"> Site Name </label>
                                        </div>
                                    </div>
                                        <div class="col-md-10">
                                            <input type="text" name="title" value="<?=$row_detail['title'] ?>" class="form-control form-control-sm">
                                            <small id="emailHelp" class="form-text text-muted fs-9">Your website name will be shown on each page.</small>

                                        </div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label class="fs-9"> Site URL </label>
                                            </div>
                                        </div>
                                            <div class="col-md-10">
                   <div class="form-group row">
                       <div class="col-md-2">
                                            <select name="scheme" class="form-select form-select-sm">
                                                <option value="http" <? echo $scheme == "http" ? "selected" : NULL ?>>http://</option>
                                                <option value="https" <? echo $scheme == "https" ? "selected" : NULL ?>>https://</option>
                                            </select>
                                            <small class="fs-9">Redirect to HTTPS</small>
                                            </div>
                                            <div class="col-md-10">
                                                <input type="text" name="domain" readonly value="<?php echo str_replace($scheme . "://", "", $row_detail['domain']) ?>" class="form-control form-control-sm">
                                            <small id="emailHelp" class="form-text text-muted fs-9">Your site url or doamin name. </small>
                                            </div>
                                            </div>
                                        </div>
                                    
                               
                                        <div class="col-md-2">
                                        <div class="form-group">
                                            <label class="fs-9"> Started Date </label>
                                        </div>
                                    </div>
                                    <div class="col-md-10">
                                            <input type="datetime-local" name="datetime" value="<?php echo htmlspecialchars($formatted_datetime); ?>" class="form-control form-control-sm">
                                            <small id="emailHelp" class="form-text text-muted fs-9">Select the date you have launched your site here.</small>

                                        </div>
                                   
                                 
                                     
                                    </div>
             <div class="separator separator-dashed my-2"></div>
             
            <div class="row mb-3">
                <label class="col-md-2 col-form-label fs-6">Site TimeZone</label>
                <div class="col-md-10">
                    <select class="form-select form-select-sm" name="timezone">
                        <option value="">GMT</option>
                        <?php foreach ($timezones as $value): ?>
                            <option value="<?= $value ?>" <?= ($row_detail['timezone'] == $value) ? 'selected' : '' ?>><?= $value ?></option>
                        <?php endforeach; ?>
                    </select>
                    <small class="form-text text-muted">default timezone is GMT</small>
                </div>
            </div>
            
             <div class="separator separator-dashed my-2"></div>
            <div class="row mb-3">
                <label class="col-md-2 col-form-label fs-6">Site Currency</label>
                <div class="col-md-10">
                    <input type="text" name="site_settings[site_currency]" id="site_currency" value="<?= $site_settings['site_currency'] ?: 'USD' ?>" class="form-control form-control-sm"  />
                    <small class="form-text text-muted fs-6">Can be USD, Can be any Currency like TRX BTC LTC, or Can be SAME (for invest and withdraw in same currency)</small>
                </div>
            </div>
             <div class="separator separator-dashed my-2"></div>
            <div class="row mb-3">
                <label class="col-md-2 col-form-label fs-6">Site Symbol</label>
                <div class="col-md-10">
                    <input type="text" name="site_settings[site_symbol]" id="site_symbol" value="<?= $site_settings['site_symbol'] ?: '$' ?>" class="form-control form-control-sm" />
                    <small class="form-text text-muted fs-6">Can be $, €, ₿, Ł, 🐕, Ð or TRX, CAD, JPY or any</small>
                </div>
            </div>
             <div class="separator separator-dashed my-2"></div>
            <div class="row mb-3">
                <label class="col-md-2 col-form-label fs-6">Site Round Figure</label>
                <div class="col-md-10">
                    <input type="text" name="site_settings[site_round]" id="site_round" value="<?= $site_settings['site_round'] ?: '2' ?>" class="form-control form-control-sm" />
                    <small class="form-text text-muted fs-6">2 to show 10.00 | 8 to show 10.00000000</small>
                </div>
            </div>
             <div class="separator separator-dashed my-2"></div>
            <div class="row mb-3">
                <label class="col-md-3 col-form-label fs-6">System Image format</label>
                <div class="col-md-3">
                    <select class="form-select form-select-sm" name="site_settings[image_format]">
                        <option value="svg" <?= $site_settings['image_format'] == 'svg' ? 'selected' : '' ?>>SVG</option>
                        <option value="png" <?= $site_settings['image_format'] == 'png' ? 'selected' : '' ?>>PNG</option>
                        <option value="jpg" <?= $site_settings['image_format'] == 'jpg' ? 'selected' : '' ?>>JPG</option>
                        <option value="jpeg" <?= $site_settings['image_format'] == 'jpeg' ? 'selected' : '' ?>>JPEG</option>
                        <option value="gif" <?= $site_settings['image_format'] == 'gif' ? 'selected' : '' ?>>GIF</option>
                        <option value="webp" <?= $site_settings['image_format'] == 'webp' ? 'selected' : '' ?>>WEBP</option>
                    </select>
                    <small class="form-text text-muted fs-6">can be svg, jpg, png</small>
                </div>
                <div class="col-md-3">
                    <input type="text" name="site_settings[image_width]" id="image_width" value="<?= $site_settings['image_width'] ?: '15px' ?>" class="form-control form-control-sm" />
                    <small class="form-text text-muted fs-6">Image width</small>
                </div>
                <div class="col-md-3">
                    <input type="text" name="site_settings[image_class]" id="image_class" value="<?= $site_settings['image_class'] ?: 'img-thumbnail' ?>" class="form-control form-control-sm" />
                    <small class="form-text text-muted fs-6">Image class</small>
                </div>
            </div>
             <div class="separator separator-dashed my-2"></div>
               <div class="mb-3">
                <div class="d-flex flex-stack">
                    <div class="d-flex align-items-center">
                        <i class="ki-duotone ki-google text-primary fs-2x me-3"></i>
                        <div>
                            <span class="fs-6 text-gray-900 fw-bold">Enable WebApp/Telegram Mini Web App</span>
                            <div class="fs-7 text-gray-500">Enable or Disable WebApp/Telegram Mini Web App.</div>
                        </div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input w-45px h-30px" type="checkbox" name="site_settings[webapp]" id="webapp" value="true" <?= $site_settings['webapp'] == 'true' ? 'checked' : '' ?>>
                    </div>
                </div>
            </div>
            
               <div id="webappdiv" class="mb-3">
               
                    <div class="separator separator-dashed my-2"></div>
                           <div class="row">
                                            <div class="col-md-2">
                                        <div class="form-group">
                                            <label class="fs-9"> Web App App URL </label>
                                        </div>
                                    </div>
                                        <div class="col-md-10">
                                            <input type="text" name="site_settings[webapp_url]" value="<?=$site_settings['webapp_url'] ?>" class="form-control form-control-sm">
                                            <small id="emailHelp" class="form-text text-muted fs-9">Your website name will be shown on each page.</small>

                                        </div>
                                        
                                        </div>
                                 <div class="separator separator-dashed my-2"></div>
               <div class="mb-3">
                <div class="d-flex flex-stack">
                    <div class="d-flex align-items-center">
                        <i class="ki-duotone ki-google text-primary fs-2x me-3"></i>
                        <div>
                            <span class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable to Telegram WebApp Only.</span>
                            <div class="fs-9 fw-semibold text-gray-500">Enable or Disable to work only on telegram..</div>
                        </div>
                    </div>
                    <div class="form-check form-switch fs-9">
                        <input class="form-check-input w-45px h-30px" type="checkbox" name="site_settings[tgonly]" id="tgonly" value="true" <?= $site_settings['tgonly'] == 'true' ? 'checked' : '' ?>>
                    </div>
               </div>
                </div>            
       <div class="separator separator-dashed my-2"></div>
               <div class="mb-3">
                <div class="d-flex flex-stack">
                    <div class="d-flex align-items-center">
                        <i class="ki-duotone ki-google text-primary fs-2x me-3"></i>
                        <div>
                            <span class="fs-6 text-gray-900 fw-bold">Disable API Web App </span>
                            <div class="fs-7 text-gray-500">Disable API Directory Index/Home page to be accessed.</div>
                        </div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input w-45px h-30px" type="checkbox" name="site_settings[webapp_disable]" id="webapp_disable" value="true" <?= $site_settings['webapp_disable'] == 'true' ? 'checked' : '' ?>>
                    </div>
                </div>
            </div>
                    
                  </div>
              <div class="separator separator-dashed my-2"></div>
            <div class="mb-3">
                <div class="d-flex flex-stack">
                    <div class="d-flex align-items-center">
                        <i class="ki-duotone ki-google text-primary fs-2x me-3"></i>
                        <div>
                            <span class="fs-6 text-gray-900 fw-bold">Enable Login with Google</span>
                            <div class="fs-7 text-gray-500">Enable or Disable Login with Google.</div>
                        </div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input w-45px h-30px" type="checkbox" name="site_settings[loginwithgoogle]" id="loginwithgoogle" value="true" <?= $site_settings['loginwithgoogle'] == 'true' ? 'checked' : '' ?>>
                    </div>
                </div>
            </div>
            
         
            <div id="googlediv" class="mb-3">
                    <div class="separator separator-dashed my-2"></div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Client ID</label>
                            <input type="text" name="site_settings[google][id]" value="<?= $site_settings['google']['id'] ?>" class="form-control form-control-sm" />
                            <small class="form-text text-muted fs-6">Enter Google Client ID</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Client Secret</label>
                            <input type="text" name="site_settings[google][secret]" value="<?= $site_settings['google']['secret'] ?>" class="form-control form-control-sm" />
                            <small class="form-text text-muted fs-6">Enter Google Client Secret</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Callback URL</label>
                        <div class="input-group mb-3">
                            <input id="callbackgoogle" type="text" class="form-control" value="https://bitders.com/callback.php?google" readonly>
                            <button class="btn btn-outline-secondary" type="button" id="gbutton" onclick="copyToClipboard('callbackgoogle', 'gbutton')">Copy Link</button>
                        </div>
                        <div class="alert alert-info" role="alert">
                            <h5 class="alert-heading">Google Login Setup Instructions:</h5>
                            <ol>
                                <li>Go to <a href="https://console.developers.google.com" target="_blank">google developer console</a></li>
                                <li>Click on Select a project then click on <a href="https://console.cloud.google.com/projectcreate" target="_blank">New Project</a> and create a project providing the project name</li>
                                <li>Click on <a href="https://console.cloud.google.com/apis/credentials" target="_blank">credentials</a></li>
                                <li>Click on create credentials and select <a href="https://console.cloud.google.com/apis/credentials/oauthclient" target="_blank">OAuth client ID</a></li>
                                <li>Click on <a href="https://console.cloud.google.com/apis/credentials/consent" target="_blank">Configure Consent Screen</a></li>
                                <li>Choose External option and press the create button</li>
                                <li>Please fill up the required information for app configuration</li>
                                <li>Again click on <a href="https://console.cloud.google.com/apis/credentials" target="_blank">credentials</a> and select type as web application and fill up the required information. Also don't forget to add redirect url and press create button</li>
                                <li>Finally you've got the credentials. Please copy the Client ID and Client Secret and paste it in admin panel google configuration.</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
             <div class="separator separator-dashed my-2"></div>
            <div class="mb-3">
                <div class="d-flex flex-stack">
                    <div class="d-flex align-items-center">
                        <i class="ki-duotone ki-send text-primary fs-2x me-3"></i>
                        <div>
                            <span class="fs-6 text-gray-900 fw-bold">Enable Login with Telegram</span>
                            <div class="fs-7 text-gray-500">Enable or Disable Login with Telegram.</div>
                        </div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input w-45px h-30px" type="checkbox" name="site_settings[loginwithtelegram]" id="loginwithtelegram" value="true" <?= $site_settings['loginwithtelegram'] == 'true' ? 'checked' : '' ?>>
                    </div>
                </div>
            </div>
 <div class="separator separator-dashed my-2"></div>
            <div id="telegramdiv" class="mb-3">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">BOT USERNAME (eg: mytelegram_bot)</label>
                            <input type="text" name="site_settings[telegram][username]" value="<?= $site_settings['telegram']['username'] ?>" class="form-control form-control-sm" />
                            <small class="form-text text-muted fs-6">Enter Telegram Bot Username</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">BOT HTTP API TOKEN</label>
                            <input type="text" name="site_settings[telegram][token]" value="<?= $site_settings['telegram']['token'] ?>" class="form-control form-control-sm" />
                            <small class="form-text text-muted fs-6">Enter Telegram Bot Token</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Callback URL</label>
                        <div class="input-group mb-3">
                            <input id="callbacktelegram" type="text" class="form-control" value="<?= $preferences['domain'] ?>" readonly>
                            <button class="btn btn-outline-secondary" type="button" id="tbutton" onclick="copyToClipboard('callbacktelegram', 'tbutton')">Copy Link</button>
                        </div>
                        <div class="alert alert-info" role="alert">
                            <h5 class="alert-heading">Telegram Login Setup Instructions:</h5>
                            <ol>
                                <li>Go to <a href="https://t.me/BotFather" target="_blank">Telegram Bot Father</a></li>
                                <li>Click on Start a project then click on <a href="https://t.me/BotFather" target="_blank">/newbot</a> and enter Bot Name and then Create a Username for your Bot</li>
                                <li>Finally you've got the botusername and Bot Token. Please copy the BOT:USERNAME and BOT:TOKEN and paste it in admin panel telegram configuration.</li>
                                <li>Click on Botfather Menu then click on <a href="https://t.me/BotFather" target="_blank">/mybots</a> and select the bot you created.</li>
                                <li>Click on Edit Bot Settings then click on Domain button and then click on Set domain</li>
                                <li>Copy the Callback URL Shown Above and paste to telegram Bot</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
             <div class="separator separator-dashed my-2"></div>
                <div class="mb-3">
                <div class="d-flex flex-stack">
                    <div class="d-flex align-items-center">
                        <i class="ki-duotone ki-send text-primary fs-2x me-3"></i>
                        <div>
                            <span class="fs-6 text-gray-900 fw-bold">Enable Login with MetaMask</span>
                            <div class="fs-7 text-gray-500">Enable or Disable Login with MetaMask.</div>
                        </div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input w-45px h-30px" type="checkbox" name="site_settings[loginwithmetamask]" id="loginwithmetamask" value="true" <?= $site_settings['loginwithmetamask'] == 'true' ? 'checked' : '' ?>>
                    </div>
                </div>
            </div>
 <div class="separator separator-dashed my-2"></div>
            <div id="metadiv" class="mb-3">
                
            </div>
        </div>
        <div class="card-footer">
            <button type="submit" name="submit" class="btn btn-primary">UPDATE</button>
        </div>
    </div>
</form>
<script>
function copyToClipboard(inputId, buttonId) {
    var button = document.querySelector('#' + buttonId);
    var input = document.querySelector('#' + inputId);
    
    // Select the text field
    input.select();
    input.setSelectionRange(0, 99999); // For mobile devices

    // Copy the text inside the text field
    navigator.clipboard.writeText(input.value);

    var buttonCaption = button.innerHTML;
    
    // Add bgcolor
    input.classList.add('bg-success');
    input.classList.add('text-inverse-success');

    button.innerHTML = 'Copied!';
    
    setTimeout(function() {
        button.innerHTML = buttonCaption;

        // Remove bgcolor
        input.classList.remove('bg-success');
        input.classList.remove('text-inverse-success');
    }, 3000);  // 3 seconds
}
</script>
<script>
       $("#webappdiv").<? echo $site_settings['webapp'] == 'true' ? "show" : "hide" ?>();
$("#webapp").click(function() {
    if($(this).is(":checked")) {
        console.log(this)
        $("#webappdiv").show();
    } else {
        $("#webappdiv").hide();
    }
});
</script>
<script>
       $("#googlediv").<? echo $site_settings['loginwithgoogle'] == 'true' ? "show" : "hide" ?>();
$("#loginwithgoogle").click(function() {
    if($(this).is(":checked")) {
        console.log(this)
        $("#googlediv").show();
    } else {
        $("#googlediv").hide();
    }
});
</script>
<script>
       $("#telegramdiv").<? echo $site_settings['loginwithtelegram'] == 'true' ? "show" : "hide" ?>();
$("#loginwithtelegram").click(function() {
    if($(this).is(":checked")) {
        console.log(this)
        $("#telegramdiv").show();
    } else {
        $("#telegramdiv").hide();
    }
});
</script>
<?
}
if ($_GET['page'] == 'admin')
{ ?>
  <?php
    $user_detail = mysqli_query($DB_CONN, "SELECT * from users where id = 1");
    $user_detail = mysqli_fetch_assoc($user_detail);
    if (isset($_POST['submit']))
    {
        $ch = validateAdminAuth($admin_settings, $_POST['alternative_passphrase'], null, false);
        if ($ch){
           if (!empty($_POST['admin_settings']['anpass']))
                $_POST['admin_settings']['anpass'] = encrypt_decrypt('encrypt', $_POST['admin_settings']['anpass']);
           else
                $_POST['admin_settings']['anpass'] = $admin_settings['anpass'];
        $admin_settings = mysqli_real_escape_string($DB_CONN, json_encode($_POST['admin_settings']));
        mysqli_query($DB_CONN, "UPDATE preferences set admin_settings = '{$admin_settings}' WHERE id = 1");
        mysqli_query($DB_CONN, "UPDATE users set username='{$_POST['username']}',email='{$_POST['admin_settings']['email']}' where id = 1");
        if ($_POST['password'])
        {
            $_POST['password'] = password_hash($_POST['password'], PASSWORD_DEFAULT);
            mysqli_query($DB_CONN, "UPDATE users set password='{$_POST['password']}' where id = 1");
        }
        echo '<div class="alert alert-success">Updated Successfully!</div>';
        updateSiteData($siteURL);
        $select_detail = mysqli_query($DB_CONN, "SELECT * from preferences WHERE id = 1");
        $row_detail = mysqli_fetch_assoc($select_detail);
        $admin_settings = json_decode($row_detail['admin_settings'], true);
        $idd = $row_detail['id'];
        $user_detail = mysqli_query($DB_CONN, "SELECT * from users where id = 1");
        $user_detail = mysqli_fetch_assoc($user_detail);
    }
}

?>                                          
<form method="POST">                                            
 <div class="card">
    <div class="card-header min-h-unset py-2">
        <div class="card-title m-0">
            <h3 class="fw-bold m-0 fs-5">Admin Settings</h3>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-2">
                <div class="form-group">
                    <label class="fs-9"> Admin Email </label>
                </div>
            </div>
            <div class="col-md-10">
                <input type="email" name="admin_settings[email]" value="<?php echo $admin_settings['email'] ?>" class="form-control form-control-sm" />
                <small id="emailHelp" class="form-text text-muted fs-9">Administration email. </small>
            </div>
              <div class="separator separator-dashed my-2"></div>
            <div class="col-md-2">
                <div class="form-group">
                    <label class="fs-9"> Admin Login Username </label>
                </div>
            </div>
            <div class="col-md-10">
                <input type="text" name="username" value="<?php echo $user_detail['username'] ?>" class="form-control form-control-sm" />
                <small id="emailHelp" class="form-text text-muted fs-9">Administration login username. <code>"admin" not recommended</code></small>
            </div>
                <div class="separator separator-dashed my-2"></div>
            <div class="col-md-2">
                <div class="form-group">
                    <label class="fs-9"> Set Login Password </label>
                </div>
            </div>
            <div class="col-md-10">
                 <?php if ($user_detail['password']): ?>
    <button id="setNewPasswordButton1" type="button" class="btn btn-sm badge badge-light-warning" onclick="showPasswordInput1()">Set New Admin Password</button>
    <input type="password" name="password" value="" class="form-control form-control-sm" autocomplete="new-password" id="passwordInput1" style="display:none;"/>
<?php endif; ?>

<script>
function showPasswordInput1() {
    document.getElementById('setNewPasswordButton1').style.display = 'none';
    document.getElementById('passwordInput1').style.display = 'block';
}
</script>

               
                <small id="emailHelp" class="form-text text-muted fs-9">Administration login password.</small>
            </div>
                  <div class="separator separator-dashed my-2"></div>
            <div class="col-md-2">
                <div class="form-group">
                    <label class="fs-9"> Set Alternate Password </label>
                </div>
            </div>
            <div class="col-md-10">
              
    <button id="setNewPasswordButton" type="button" class="btn btn-sm badge badge-light-warning" onclick="showPasswordInput()">Set New Alternate Password</button>
    <input type="password" name="admin_settings[anpass]" value="" class="form-control form-control-sm" autocomplete="new-password" id="passwordInput" style="display:none;"/>


<script>
function showPasswordInput() {
    document.getElementById('setNewPasswordButton').style.display = 'none';
    document.getElementById('passwordInput').style.display = 'block';
}
</script>
 <?php if ($admin_settings['anpass']): ?>
                <small id="emailHelp" class="form-text text-muted fs-9">will be used at <a   href="admin?page=transaction" class="fs-7"><b>Add Transactions</b> Page </a> for transactions.</small>
                
                          <div class="py-5 " <? if (!$admin_settings['anpass'] ) echo 'style="display: none;"'; ?>>
                              <label class="fs-9"> Check the pages to enable Alternate Password on</label>
 <label class="form-check form-check-custom form-check-solid align-items-start">
                            <!--begin::Input-->
                            <input class="form-check-input me-3" type="checkbox" name="admin_settings[page][site]" value="1"  <?php if ($admin_settings['page']['site'] == '1') echo 'checked'; ?>>
                            <!--end::Input-->
                            <!--begin::Label-->
                            <span class="form-check-label d-flex flex-column align-items-start">
                                <span class="fw-bold fs-6 mb-0">Site Settings</span>
                        
                            </span>
                            <!--end::Label-->
                        </label>
                <div class="separator separator-dashed my-2"></div>                                        
                <label class="form-check form-check-custom form-check-solid align-items-start">
                        <!--begin::Input-->
                        <input class="form-check-input me-3" type="checkbox" name="admin_settings[page][referral]" value="1"  <?php if ($admin_settings['page']['referral'] == '1') echo 'checked'; ?>>
                        <!--end::Input-->
                        <!--begin::Label-->
                        <span class="form-check-label d-flex flex-column align-items-start">
                            <span class="fw-bold fs-6 mb-0">Referral Settings</span>
                        
                        </span>
                        <!--end::Label-->
                    </label>
                <div class="separator separator-dashed my-2"></div>                                        
                <label class="form-check form-check-custom form-check-solid align-items-start">
                    <!--begin::Input-->
                    <input class="form-check-input me-3" type="checkbox" name="admin_settings[page][pending_withdraw]" value="1"  <?php if ($admin_settings['page']['pending_withdraw'] == '1') echo 'checked'; ?>>
                    <!--end::Input-->
                    <!--begin::Label-->
                    <span class="form-check-label d-flex flex-column align-items-start">
                        <span class="fw-bold fs-6 mb-0">Pending Withdraw</span>
                    
                    </span>
                    <!--end::Label-->
                </label>
                    <div class="separator separator-dashed my-2"></div>                                        
                <label class="form-check form-check-custom form-check-solid align-items-start">
                    <!--begin::Input-->
                    <input class="form-check-input me-3" type="checkbox" name="admin_settings[page][pending_deposit]" value="1"  <?php if ($admin_settings['page']['pending_deposit'] == '1') echo 'checked'; ?>>
                    <!--end::Input-->
                    <!--begin::Label-->
                    <span class="form-check-label d-flex flex-column align-items-start">
                        <span class="fw-bold fs-6 mb-0">Pending Investments</span>
                    
                    </span>
                    <!--end::Label-->
                </label>
                <div class="separator separator-dashed my-2"></div> 
     </div> 
     <?php endif; ?>
            </div>
             <div class="separator separator-dashed my-2"></div>
  <div class="col-md-12">
                    <div class="d-flex flex-stack">
                        <div class="d-flex">
                            <div class="d-flex flex-column">
                                <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Logout on Ip Change</a>
                                <div class="fs-9 fw-semibold text-gray-500">Admin will be logout if the Ip get changed.</div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <div class="form-check form-check-solid form-check-custom form-switch">
                                <input class="form-check-input w-45px h-30px" type="checkbox" name="admin_settings[logout_on_ip_change]" id="email_code" value="true" <?=$admin_settings['logout_on_ip_change'] == 'true' ? 'checked' : '' ?>>
                                <label class="form-check-label fs-9" for="logout_on_ip_change"></label>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="separator separator-dashed my-2"></div>
  <div class="col-md-12">
                    <div class="d-flex flex-stack">
                        <div class="d-flex">
                            <div class="d-flex flex-column">
                                <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Logout on Browser Change</a>
                                <div class="fs-9 fw-semibold text-gray-500">Admin will be logout if the Browser get changed.</div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <div class="form-check form-check-solid form-check-custom form-switch">
                                <input class="form-check-input w-45px h-30px" type="checkbox" name="admin_settings[logout_on_browser_change]" id="email_code" value="true" <?=$admin_settings['logout_on_browser_change'] == 'true' ? 'checked' : '' ?>>
                                <label class="form-check-label fs-9" for="logout_on_browser_change"></label>
                            </div>
                        </div>
                    </div>
                </div>
                
              <div class="separator separator-dashed my-2"></div>
              <div class="col-md-12">
                    <div class="d-flex flex-stack">
                        <div class="d-flex">
                            <div class="d-flex flex-column">
                                <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable 2FA via Email</a>
                                <div class="fs-9 fw-semibold text-gray-500">Toggle to enable and disable Email 2FA</div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <div class="form-check form-check-solid form-check-custom form-switch">
                                <input class="form-check-input w-45px h-30px" type="checkbox" name="admin_settings[email_code]" id="email_code" value="true" <?=$admin_settings['email_code'] == 'true' ? 'checked' : '' ?>>
                                <label class="form-check-label fs-9" for="email_code"></label>
                            </div>
                        </div>
                    </div>
                </div>
                
                            <div id="admin_emaildiv" class="row" >
                   <div class="col-md-4">
                        
                    </div>
                    <div class="col-md-8">
                        <input type="text" name="admin_settings[admin_email]" value="<?=$admin_settings['admin_email'] ?>" class="form-control form-control-sm">
                        <small id="emailHelp" class="form-text text-muted fs-9">Enter Email in which you want to recieve a pin code.</small>
                    </div>
                </div>

         <? if ($admin_settings['anpass']) { ?>
          <div class="separator separator-dashed my-2"></div>
            <div class="col-md-2">
                <div class="form-group">
                    <label class="fs-9"> Current Alternate Password </label>
                </div>
            </div>
          
            <div class="col-md-10">
                <input type="password" name="alternative_passphrase" value="" class="form-control form-control-sm" />
                <small id="emailHelp" class="form-text text-muted fs-9"> </small>
            </div>
  <? } ?>
  
            
        </div>
    </div>
    
<div class="card-footer d-flex justify-content-end py-2 px-9">           
      <input class="btn btn-primary btn-sm me-2" type="submit" name="submit" value="UPDATE ">
</div>

</div>

</form>
<script>
$("#admin_emaildiv").<? echo $admin_settings['email_code'] == 'true' ? "show" : "hide" ?>();
$("#email_code").click(function() {
    if($(this).is(":checked")) {
        $("#admin_emaildiv").show();
    } else {
        $("#admin_emaildiv").hide();
    }
});
</script>
<div class="modal fade " id="kt_modal_two_factor_authentication" >
            <!--begin::Modal header-->
            <div class="modal-dialog modal-dialog-centered mw-650px">
                <!--begin::Modal content-->
                <div class="modal-content">
                    <!--begin::Modal header-->
                    <div class="modal-header flex-stack">
                        <!--begin::Title-->
                        <h2>Enable Two Factor Authentication</h2>
                        <!--end::Title-->
                        <!--begin::Close-->
                        <div class="btn btn-sm btn-icon btn-active-color-primary" data-bs-dismiss="modal">
                            <i class="ki-duotone ki-cross fs-1">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                        </div>
                        <!--end::Close-->
                    </div>
                    <!--begin::Modal header-->
                    <!--begin::Modal body-->
                    <div class="modal-body scroll-y pt-10 pb-15 px-lg-17">
                        <!--begin::Options-->
            
                        <!--end::Options-->
                        <!--begin::Apps-->
                        <div class="" data-kt-element="apps">
                            <!--begin::Heading-->
                            <h3 class="text-gray-900 fw-bold mb-7">Authenticator Apps</h3>
                            <!--end::Heading-->
                            <!--begin::Description-->
                            <div class="text-gray-500 fw-semibold fs-6 mb-10">Using an authenticator app like 
                            <a  href="https://support.google.com/accounts/answer/1066447?hl=en" target="_blank">Google Authenticator</a>, 
                            <a  href="https://www.microsoft.com/en-us/account/authenticator" target="_blank">Microsoft Authenticator</a>, 
                            <a  href="https://authy.com/download/" target="_blank">Authy</a>, or 
                            <a  href="https://support.1password.com/one-time-passwords/" target="_blank">1Password</a>, scan the QR code. It will generate a 6 digit code for you to enter below. 
                            <!--begin::QR code image-->
                            <?php
    $secret = TokenAuth6238::generateRandomClue();
    $qr_url = TokenAuth6238::getBarCodeUrl($_SESSION['username'], $pref['title'], $secret); ?>
                            <div class="pt-5 text-center">
                                <img src="<?=$qr_url
?>" alt="" class="mw-150px">
                            </div>
                            <!--end::QR code image--></div>
                            <!--end::Description-->
                            <!--begin::Notice-->
                            <div class="notice d-flex bg-light-warning rounded border-warning border border-dashed mb-10 p-6">
                                <!--begin::Icon-->
                                <i class="ki-duotone ki-information fs-2tx text-warning me-4">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                    <span class="path3"></span>
                                </i>
                                <!--end::Icon-->
                                <!--begin::Wrapper-->
                                <div class="d-flex flex-stack flex-grow-1">
                                    <!--begin::Content-->
                                    <div class="fw-semibold">
                                        <div class="fs-8 text-gray-700">If you having trouble using the QR code, select manual entry on your app, and enter your username and the code: 
                                        <div class="fw-bold text-gray-900 pt-2"><?=$secret
?></div></div>
                                    </div>
                                    <!--end::Content-->
                                </div>
                                <!--end::Wrapper-->
                            </div>
                            <!--end::Notice-->
                            <!--begin::Form-->
                            <form data-kt-element="apps-form" class="form fv-plugins-bootstrap5 fv-plugins-framework" method="post">
                                <!--begin::Input group-->
                                <div class="mb-10 fv-row fv-plugins-icon-container">
                                    <input type="text" class="form-control form-control-lg form-control-solid" placeholder="Enter authentication code" name="admin[admin_2fa]">
                                <div class="fv-plugins-message-container fv-plugins-message-container--enabled invalid-feedback"></div></div>
                                <!--end::Input group-->
                                <!--begin::Actions-->
                                <div class="d-flex flex-center">
                                    <button type="reset" data-kt-element="apps-cancel" class="btn btn-light me-3">Cancel</button>
                                    <button type="submit" data-kt-element="apps-submit" name="2fa" class="btn btn-primary">
                                        <span class="indicator-label">Submit</span>
                                    
                                    </button>
                                </div>
                                <!--end::Actions-->
                            </form>
                            <!--end::Form-->
                        </div>
                        <!--end::Options-->
                        <!--begin::SMS-->
                    
                        <!--end::SMS-->
                    </div>
                    <!--begin::Modal body-->
                </div>
                <!--end::Modal content-->
            </div>
            <!--end::Modal header-->
        </div>                  
<?
}
if ($_GET['page'] == 'kyc_settings')
{ ?>
  <?php
    $select_detail = mysqli_query($DB_CONN, "select * from preferences");
    $row_detail = mysqli_fetch_assoc($select_detail);
    $kyc_settings = json_decode($row_detail['kyc_settings'], true);
    $idd = $row_detail['id'];
    if (isset($_POST['submit']))
    {
        $kyc_settings = mysqli_real_escape_string($DB_CONN, json_encode($_POST['kyc_settings']));
        $update_kyc = mysqli_query($DB_CONN, "UPDATE preferences set  kyc_settings = '{$kyc_settings}'  WHERE id='$idd'");

        if ($update_kyc)
        {
            echo '<div class="alert alert-success">
      Updated Successfully ! 
</div>';
updateSiteData($siteURL);
        }
        
        $select_detail = mysqli_query($DB_CONN, "select * from preferences");
        $row_detail = mysqli_fetch_assoc($select_detail);
        $kyc_settings = json_decode($row_detail['kyc_settings'], true);
        $idd = $row_detail['id'];
    }

    $select_detail = mysqli_query($DB_CONN, "select * from preferences");
    $row_detail = mysqli_fetch_assoc($select_detail);
?>                                          
<form method="POST">                                            
 <div class="card">
    <div class="card-header min-h-unset py-2" >
                                            <div class="card-title m-0">
                                                <h3 class="fw-bold m-0 fs-5">KYC Settings</h3>
                                            </div>
                                        </div>
    <div class="card-body">
        <div class="row">

           
              
              <div class="col-md-12">
                    <div class="d-flex flex-stack">
                        <div class="d-flex">
                            <div class="d-flex flex-column">
                                <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable KYC for Users</a>
                                <div class="fs-9 fw-semibold text-gray-500">Toggle to enable and disable Users KYC</div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <div class="form-check form-check-solid form-check-custom form-switch">
                                <input class="form-check-input w-45px h-30px" type="checkbox" name="kyc_settings[enable]" id="enable" value="true"  <?=$kyc_settings['enable'] == 'true' ? 'checked' : '' ?>>
                                <label class="form-check-label fs-9" for="enable"></label>
                            </div>
                        </div>
                    </div>
                </div>
                        <div class="separator separator-dashed my-2"></div>
<div class="row mt-5" id="veriffDiv">
        <label class="fs-5 mb-3">KYC Charges  </label>
<div class="col-md-2">
      <label class="fs-9"> Amount </label>
    </div>
    <div class="col-md-10">
      <input type="text" style="border: 1px solid lightgrey" name="kyc_settings[kyc_charges]" value="<?=$kyc_settings['kyc_charges']?>" class="form-control form-control-sm">
      <small class="help-block text-muted">add only if you want to add charges on KYC by default its zero</small>
</div>
<div class="separator separator-dashed my-2"></div>
<div class="col-md-2">
      <label class="fs-9">Currency</label>
    </div>
    <div class="col-md-10">
      <select class="form-select form-select-sm streak-input" name="kyc_settings[kyc_charges_currency]" >
        <option value="">Select Currency</option>
        <?php foreach($payments as $payment): ?>
            <option value="<?=$payment['id']?>" <?=$kyc_settings['kyc_charges_currency'] == $payment['id'] ? 'selected' : ''?>>
                <?=$payment['name']?>
            </option>
        <?php endforeach; ?>
    </select>
      <small class="help-block text-muted">Currency in which charges have to be cut</small>
    </div>

</div>
                            <div id="kyc_div" class="row" >
                   
                         <div class="separator separator-dashed my-2"></div>
                 <div class="d-flex flex-stack">
                        <div class="d-flex">
                            <div class="d-flex flex-column">
                                <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Use Veriff</a>
                                <div class="fs-9 fw-semibold text-gray-500">Toggle to enable and disable Veriff </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <div class="form-check form-check-solid form-check-custom form-switch">
                                <input class="form-check-input w-45px h-30px" type="checkbox" name="kyc_settings[veriff]" id="veriff" value="true"  <?=$kyc_settings['veriff'] == 'true' ? 'checked' : '' ?>>
                                <label class="form-check-label fs-9" for="veriff"></label>
                            </div>
                        </div>
                    </div>
<div class="row mt-5" id="veriffDiv">
        <label class="fs-5 mb-3">Veriff Settings  </label>
<div class="col-md-2">
      <label class="fs-9"> Veriff Api </label>
    </div>
    <div class="col-md-10">
      <input type="text" style="border: 1px solid lightgrey" name="kyc_settings[veriff_api]" value="<?=$kyc_settings['veriff_api']?>" class="form-control form-control-sm">
      <small class="help-block text-muted">go to Integeration --&gt; API Keys &amp; Live. SDK Key</small>
</div>
<div class="separator separator-dashed my-2"></div>
<div class="col-md-2">
      <label class="fs-9">Veriff Secret</label>
    </div>
    <div class="col-md-10">
      <input type="text" style="border: 1px solid lightgrey" name="kyc_settings[veriff_secret]" value="<?=$kyc_settings['veriff_secret']?>" class="form-control form-control-sm">
      <small class="help-block text-muted">go to Widget --&gt;  Widget Code &amp;  Copy  KEY</small>
    </div>

</div>

                     <div class="col-md-12">
 <div class="separator separator-dashed my-2"></div>
                    <div class="d-flex flex-stack">
                        <div class="d-flex">
                            <div class="d-flex flex-column">
                                <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Use Name Field</a>
                                <div class="fs-9 fw-semibold text-gray-500">Toggle to enable and disable Name Field</div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <div class="form-check form-check-solid form-check-custom form-switch">
                                <input class="form-check-input w-45px h-30px" type="checkbox" name="kyc_settings[name]" id="name" value="true"  <?=$kyc_settings['name'] == 'true' ? 'checked' : '' ?>>
                                <label class="form-check-label fs-9" for="name"></label>
                            </div>
                        </div>
                    </div>
               
                    </div>
                 
                    <div class="separator separator-dashed my-2"></div>
                      <div class="d-flex flex-stack">
                        <div class="d-flex">
                            <div class="d-flex flex-column">
                                <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Use Document Number Field</a>
                                <div class="fs-9 fw-semibold text-gray-500">Toggle to enable and disable Document Number Field</div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <div class="form-check form-check-solid form-check-custom form-switch">
                                <input class="form-check-input w-45px h-30px" type="checkbox" name="kyc_settings[number]" id="document" value="true"  <?=$kyc_settings['number'] == 'true' ? 'checked' : '' ?>>
                                <label class="form-check-label fs-9" for="number"></label>
                            </div>
                        </div>
                    </div>
                    <div class="separator separator-dashed my-2"></div>
                    <div class="row">
                    <div class="col-md-4">
                
                    <div class="d-flex flex-stack">
                        <div class="d-flex">
                            <div class="d-flex flex-column">
                                <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Use License as Document Field</a>
                                <div class="fs-9 fw-semibold text-gray-500">Toggle to enable and disable License as Document Field</div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <div class="form-check form-check-solid form-check-custom form-switch">
                                <input class="form-check-input w-45px h-30px" type="checkbox" name="kyc_settings[document][license]" id="document" value="true"  <?=$kyc_settings['document']['license'] == 'true' ? 'checked' : '' ?>>
                                <label class="form-check-label fs-9" for="document"></label>
                            </div>
                        </div>
                    </div>
               
                    </div>
                    
                    
                    <div class="col-md-4">
                
                    <div class="d-flex flex-stack">
                        <div class="d-flex">
                            <div class="d-flex flex-column">
                                <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Use ID Card as Document Field</a>
                                <div class="fs-9 fw-semibold text-gray-500">Toggle to enable and disable ID Card as Document Field</div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <div class="form-check form-check-solid form-check-custom form-switch">
                                <input class="form-check-input w-45px h-30px" type="checkbox" name="kyc_settings[document][idcard]" id="number" value="true"  <?=$kyc_settings['document']['idcard'] == 'true' ? 'checked' : '' ?>>
                                <label class="form-check-label fs-9" for="number"></label>
                            </div>
                        </div>
                    </div>
               
                    </div>
                    
                    
                    <div class="col-md-4">
                
                    <div class="d-flex flex-stack">
                        <div class="d-flex">
                            <div class="d-flex flex-column">
                                <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Use Passport as Document Field</a>
                                <div class="fs-9 fw-semibold text-gray-500">Toggle to enable and disable Passport as Document Field</div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <div class="form-check form-check-solid form-check-custom form-switch">
                                <input class="form-check-input w-45px h-30px" type="checkbox" name="kyc_settings[document][passport]" id="number" value="true"  <?=$kyc_settings['document']['passport'] == 'true' ? 'checked' : '' ?>>
                                <label class="form-check-label fs-9" for="number"></label>
                            </div>
                        </div>
                    </div>
               
                    </div>
                     
             
                    </div> <!--row-->
                 
                    
                       <div class="separator separator-dashed my-2"></div>
                             <div class="col-md-4">
                
                    <div class="d-flex flex-stack">
                        <div class="d-flex">
                            <div class="d-flex flex-column">
                                <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Use Front Side Upload Field </a>
                                <div class="fs-9 fw-semibold text-gray-500">Toggle to enable Both front back document disable for only front Field</div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <div class="form-check form-check-solid form-check-custom form-switch">
                                <input class="form-check-input w-45px h-30px" type="checkbox" name="kyc_settings[front]" id="front" value="true"  <?=$kyc_settings['front'] == 'true' ? 'checked' : '' ?>>
                                <label class="form-check-label fs-9" for="front"></label>
                            </div>
                        </div>
                    </div>
               
                    </div>
                     <div class="col-md-4">
                
                    <div class="d-flex flex-stack">
                        <div class="d-flex">
                            <div class="d-flex flex-column">
                                <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Use Back Side Upload Field </a>
                                <div class="fs-9 fw-semibold text-gray-500">Toggle to enable Both front back document disable for only front Field</div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <div class="form-check form-check-solid form-check-custom form-switch">
                                <input class="form-check-input w-45px h-30px" type="checkbox" name="kyc_settings[back]" id="back" value="true"  <?=$kyc_settings['back'] == 'true' ? 'checked' : '' ?>>
                                <label class="form-check-label fs-9" for="back"></label>
                            </div>
                        </div>
                    </div>
               
                    </div>
                     <div class="col-md-4">
                
                    <div class="d-flex flex-stack">
                        <div class="d-flex">
                            <div class="d-flex flex-column">
                                <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Use Document with Selfie Upload Field </a>
                                <div class="fs-9 fw-semibold text-gray-500">Toggle to enable Document with Selfie upload field</div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <div class="form-check form-check-solid form-check-custom form-switch">
                                <input class="form-check-input w-45px h-30px" type="checkbox" name="kyc_settings[selfie]" id="back" value="true"  <?=$kyc_settings['selfie'] == 'true' ? 'checked' : '' ?>>
                                <label class="form-check-label fs-9" for="selfie"></label>
                            </div>
                        </div>
                    </div>
               
                    </div>
                    
                      <div class="separator separator-dashed my-2"></div>
                             <div class="col-md-12">
                
                    <div class="d-flex flex-stack">
                        <div class="d-flex">
                            <div class="d-flex flex-column">
                                <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Use Phone Number Field</a>
                                <div class="fs-9 fw-semibold text-gray-500">Toggle to enable and disable Phone Number Field</div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <div class="form-check form-check-solid form-check-custom form-switch">
                                <input class="form-check-input w-45px h-30px" type="checkbox" name="kyc_settings[phone]" id="phone" value="true"  <?=$kyc_settings['phone'] == 'true' ? 'checked' : '' ?>>
                                <label class="form-check-label fs-9" for="phone"></label>
                            </div>
                        </div>
                    </div>
               
                    </div>
                    
                    
                      <div class="separator separator-dashed my-2"></div>
                             <div class="col-md-12">
                
                    <div class="d-flex flex-stack">
                        <div class="d-flex">
                            <div class="d-flex flex-column">
                                <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Use Address Field </a>
                                <div class="fs-9 fw-semibold text-gray-500">Toggle to enable and disable Address Field</div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <div class="form-check form-check-solid form-check-custom form-switch">
                                <input class="form-check-input w-45px h-30px" type="checkbox" name="kyc_settings[address]" id="address" value="true"  <?=$kyc_settings['address'] == 'true' ? 'checked' : '' ?>>
                                <label class="form-check-label fs-9" for="address"></label>
                            </div>
                        </div>
                    </div>
               
                    </div>
                    
                    
                      
                      <div class="separator separator-dashed my-2"></div>
                             <div class="col-md-12">
                
                    <div class="d-flex flex-stack">
                        <div class="d-flex">
                            <div class="d-flex flex-column">
                                <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Use Country Field </a>
                                <div class="fs-9 fw-semibold text-gray-500">Toggle to enable and disable country Field</div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <div class="form-check form-check-solid form-check-custom form-switch">
                                <input class="form-check-input w-45px h-30px" type="checkbox" name="kyc_settings[country]" id="country" value="true"  <?=$kyc_settings['country'] == 'true' ? 'checked' : '' ?>>
                                <label class="form-check-label fs-9" for="country"></label>
                            </div>
                        </div>
                    </div>
               
                    </div>
                    
                    
                      
                      <div class="separator separator-dashed my-2"></div>
                             <div class="col-md-12">
                
                    <div class="d-flex flex-stack">
                        <div class="d-flex">
                            <div class="d-flex flex-column">
                                <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Use Bill Document for Address Verification  Field</a>
                                <div class="fs-9 fw-semibold text-gray-500">Toggle to enable and disable Bill Document for Address Verification Field</div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <div class="form-check form-check-solid form-check-custom form-switch">
                                <input class="form-check-input w-45px h-30px" type="checkbox" name="kyc_settings[bill]" id="bill" value="true"  <?=$kyc_settings['bill'] == 'true' ? 'checked' : '' ?>>
                                <label class="form-check-label fs-9" for="bill"></label>
                            </div>
                        </div>
                    </div>
               
                    </div>
                    
                </div>
               
        <!--begin::Item-->
      
 
            
        </div>
    </div>
    
<div class="card-footer d-flex justify-content-end py-2 px-9">
                                    <input class="btn btn-primary btn-sm" type="submit" name="submit" value="Update KYC Settings ">
</div>

</div>
     


</form>
<script>
   $("#veriffDiv").<? echo $kyc_settings['veriff'] == 'true' ? "show" : "hide" ?>();
$("#veriff").click(function() {
    if($(this).is(":checked")) {
        $("#veriffDiv").show();
    } else {
        $("#veriffDiv").hide();
    }
});
</script>
<script>
   $("#kyc_div").<? echo $kyc_settings['enable'] == 'true' ? "show" : "hide" ?>();
$("#enable").click(function() {
    if($(this).is(":checked")) {
        $("#kyc_div").show();
    } else {
        $("#kyc_div").hide();
    }
});
</script>
<?
}
if ($_GET['page'] == 'tasks')
{

   if (isset($_POST['action']) && $_POST['action'] == "delete")
    {
        $RECORD = mysqli_query($DB_CONN, "delete from tasks where id='{$_POST['id']}'");

        if ($RECORD)
        {
            $alert = true;
            $alert_class = 'alert alert-success alert-dismissible alert-custom';
            $alert_message = 'Operation Successfully!';
        }
    }
if (isset($_POST['submit']) && isset($_POST['action']) && $_POST['action'] == "add") {
    $taskDetails = [];
    
    // If it's an automated task (type 2) and a task is selected
    if ($_POST['type'] == '2' && isset($_POST['selectedTask'])) {
        $taskDetails['selected_task'] = $_POST['selectedTask'];
    }
    
    // Merge the selected task with other details if they exist
    if (isset($_POST['details'])) {
        $taskDetails = array_merge($taskDetails, $_POST['details']);
    }
    $details = mysqli_real_escape_string($DB_CONN, json_encode($taskDetails));
    $lang = isset($_POST['lang_id']) ? (int)$_POST['lang_id'] : 1;
    
    $translation_fields = "";
    $translation_values = "";
    
    // If this is a translation (lang_id is not 1), add translation_of field
    if ($lang != 1 && isset($_POST['original_id'])) {
        $translation_fields = ", translation_of";
        $translation_values = ", '{$_POST['original_id']}'";
    }
    
    $insert = mysqli_query($DB_CONN, 
        "INSERT INTO tasks (
            type, name, url, image_url, content, status, lang_id, 
            amount_min, amount_max, details$translation_fields
        ) VALUES (
            '{$_POST['type']}', '{$_POST['name']}', '{$_POST['url']}',
            '{$_POST['image_url']}', '{$_POST['content']}', '{$_POST['status']}',
            '$lang', '{$_POST['amount_min']}', '{$_POST['amount_max']}',
            '{$details}'$translation_values
        )"
    ) or die(mysqli_error($DB_CONN));

    if ($insert) {
        $ID = mysqli_insert_id($DB_CONN);
        $alert = true;
        $alert_class = 'alert alert-success alert-dismissible alert-custom';
        $alert_message = 'Added Successfully!';
        echo "<script>window.location.href='admin?page=tasks&action=edit&id={$ID}&lang={$lang}&alert_message=Added Successfully!&alert_class=alert alert-success alert-dismissible alert-custom'</script>";
    }
} 
    if (isset($_POST['submit']) && isset($_POST['action']) && $_POST['action'] == "update") {
       $existingDetails = json_decode($currentTask['details'], true) ?: [];


    if ($_POST['type'] == '2' && isset($_POST['selectedTask'])) {
        $existingDetails['selected_task'] = $_POST['selectedTask'];
    }
    
    // Merge new details with existing ones if they exist
    if (isset($_POST['details'])) {
        $existingDetails = array_merge($existingDetails, $_POST['details']);
    }
    
    // Encode updated details as JSON and escape for database
    $details = mysqli_real_escape_string($DB_CONN, json_encode($existingDetails));
    $lang = isset($_POST['lang_id']) ? (int)$_POST['lang_id'] : 1;
    
    if ($lang != 1) {
        // Check if translation exists
        $check = mysqli_query($DB_CONN, "SELECT id FROM tasks WHERE translation_of = '{$_POST['id']}' AND lang_id = $lang");
        
        if (mysqli_num_rows($check) == 0) {
            // No translation exists - create one
            $insert = mysqli_query($DB_CONN, 
                "INSERT INTO tasks (
                    type, name, url, image_url, content, status, lang_id,
                    instructions_image_url, instructions, details, translation_of
                ) VALUES (
                    '{$_POST['type']}', '{$_POST['name']}', '{$_POST['url']}',
                    '{$_POST['image_url']}', '{$_POST['content']}', '{$_POST['status']}',
                    '$lang', '{$_POST['instructions_image_url']}', '{$_POST['instructions']}',
                    '{$details}', '{$_POST['id']}'
                )"
            );
            $success = $insert;
            $ID = mysqli_insert_id($DB_CONN);
        } else {
            // Update existing translation
            $translation = mysqli_fetch_assoc($check);
            $update = mysqli_query($DB_CONN, 
                "UPDATE tasks SET 
                    type = '{$_POST['type']}',
                    name = '{$_POST['name']}',
                    url = '{$_POST['url']}',
                    content = '{$_POST['content']}',
                    details = '{$details}',
                    image_url = '{$_POST['image_url']}',
                    status = '{$_POST['status']}',
        instructions_image_url = '{$_POST['instructions_image_url']}',
            instructions = '{$_POST['instructions']}'
                WHERE id = '{$translation['id']}'"
            );
            $success = $update;
            $ID = $translation['id'];
        }
    } else {
        // Regular update for original language
        $update = mysqli_query($DB_CONN, "UPDATE tasks SET 
            type = '{$_POST['type']}',
            name = '{$_POST['name']}',
            url = '{$_POST['url']}',
            content = '{$_POST['content']}',
            details = '{$details}',
            image_url = '{$_POST['image_url']}',
            status = '{$_POST['status']}',
            instructions_image_url = '{$_POST['instructions_image_url']}',
            instructions = '{$_POST['instructions']}'
            WHERE id = '{$_POST['id']}'"
        );
        $success = $update;
        $ID = $_POST['id'];
    }

    if ($success) {
        $alert = true;
        $alert_class = 'alert alert-success alert-dismissible alert-custom';
        $alert_message = 'Updated Successfully!';
        echo "<script>window.location.href='admin?page=tasks&action=edit&id={$ID}&lang={$lang}&alert_message=Updated Successfully!&alert_class=alert alert-success alert-dismissible alert-custom'</script>";
    }
}
    if (isset($_GET['action']) && $_GET['action'] == 'edit')
    { $lang = isset($_GET['lang']) ? (int)$_GET['lang'] : 1;
       if ($lang == 1) {
        // Edit original task
        $b = mysqli_query($DB_CONN, "SELECT * FROM tasks WHERE id = {$_GET['id']}");
    } else {
        // Check if translation exists
        $b = mysqli_query($DB_CONN, "SELECT * FROM tasks 
            WHERE translation_of = {$_GET['id']} AND lang_id = $lang");
        
        if (mysqli_num_rows($b) == 0) {
            // No translation exists, get original task data
            $b = mysqli_query($DB_CONN, "SELECT * FROM tasks WHERE id = {$_GET['id']}");
        }
    }
        
        $b = mysqli_fetch_assoc($b);
         $details = json_decode($b['details'], true);
        if (true)
        {
             if(isset($_GET['alert_message']) && $_GET['alert_message']) {
                    $alert = true;
                        $alert_class = $_GET['alert_class'];
                        $alert_message = $_GET['alert_message'];
                 
             }
             if ($alert)
                        {
                            echo '<div class="' . $alert_class . '">' . $alert_message . '</div>';
                        }
?>     
<form method="POST">               
   <div class="card mb-2">
                                        <div class="card-header min-h-unset py-2">
                                            <h3 class="card-title align-items-start flex-column m-0">
                                                 <? if($b['id']) { ?>
                                                 <span class="card-label fw-bold text-gray-900">Edit Task / Bounty</span>
                                                  <? } else { ?>
                                                  <span class="card-label fw-bold text-gray-900">Add Task / Bounty</span>
                                                   <? } ?>
                                               <span class="text-gray-500 mt-1 fw-semibold fs-6"></span>
                                            </h3>
                                        </div>
                                <div class="card-body">
       <div class="row">
           <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9"> Select Task Type</label>
                    </div>
                </div>
                <div class="col-md-8">
                    <select class="form-select form-select-sm" name="type" id="type">
                        <option value="1"  <? echo $b['type'] == "1" ? " selected" : "" ?>>Task/Bounty</option>
                        <option value="2"  <? echo $b['type'] == "2" ? " selected" : "" ?>>Automated Tasks</option>
                       
                    </select>
                    <small class="form-text text-muted fs-9">Task - Will be shown on tasks.tpl | Bounty - will be shown on bounty.tpl</small>
                    
                    
                </div>
  <div id="automatedTaskSelection" style="display: none;" class="row mt-4">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9">Select Automated Task</label>
                </div>
            </div>
            <div class="col-md-8">
    <select class="form-select form-select-sm" name="selectedTask" id="selectedTask">
        <option value="">Select a task...</option>
        <?php 
        $available_tasks = handleTasks('available');
        $selected_task_id = isset($details['selected_task']) ? $details['selected_task'] : '';
        
        foreach ($available_tasks as $task): 
            $is_selected = ($task['id'] == $selected_task_id) ? 'selected' : '';
        ?>
            <option value="<?php echo $task['id']; ?>" <?php echo $is_selected; ?>>
                <?php echo htmlspecialchars($task['name']); ?>
            </option>
        <?php endforeach; ?>
    </select>
    <small class="form-text text-muted fs-9">Choose the automated task you want to configure</small>
</div>
        </div>

        <!-- Task Configuration Section -->
        <div id="telegramTasksSection" style="display: none;">
            <div class="card mb-4 mt-4">
                <div class="card-header min-h-unset py-2">
                    <h4 class="card-title m-0">Task Configuration</h4>
                </div>
                <div class="card-body py-2">
                    <?php foreach ($available_tasks as $task):
                        $task_enabled = isset($details['tasks'][$task['id']]) && $details['tasks'][$task['id']]['enabled'];
                        $task_settings = isset($details['tasks'][$task['id']]) ? $details['tasks'][$task['id']] : [];
                    ?>
                    <div class="task-settings" id="task-<?php echo $task['id']; ?>" style="display: none;">
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" 
                                           name="details[tasks][<?php echo $task['id']; ?>][enabled]" 
                                           value="true" 
                                           <?php echo $task_enabled ? 'checked' : ''; ?>>
                                    <label class="form-check-label">
                                        <?php echo $task['name']; ?>
                                        <small class="d-block text-muted"><?php echo $task['description']; ?></small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <?php if ($task['duration_supported']): ?>
                                    <div class="row mb-2">
                                        <div class="col-md-6">
                                            <select class="form-select form-select-sm" 
                                                    name="details[tasks][<?php echo $task['id']; ?>][limit_duration]">
                                                <option value="">No time limit</option>
                                                <option value="day" <?php echo isset($task_settings['limit_duration']) && $task_settings['limit_duration'] == 'day' ? 'selected' : ''; ?>>Daily</option>
                                                <option value="week" <?php echo isset($task_settings['limit_duration']) && $task_settings['limit_duration'] == 'week' ? 'selected' : ''; ?>>Weekly</option>
                                                <option value="month" <?php echo isset($task_settings['limit_duration']) && $task_settings['limit_duration'] == 'month' ? 'selected' : ''; ?>>Monthly</option>
                                                <option value="year" <?php echo isset($task_settings['limit_duration']) && $task_settings['limit_duration'] == 'year' ? 'selected' : ''; ?>>Yearly</option>
                                            </select>
                                        </div>
                                    </div>
                                <?php endif; ?>

                                <?php if ($task['id'] === 'investment'): ?>
                                    <div class="row">
                                        <div class="col-md-4 mb-2">
                                            <input type="number" step="0.01" class="form-control form-control-sm" 
                                                   name="details[tasks][<?php echo $task['id']; ?>][min_amount]"
                                                   placeholder="Minimum investment amount"
                                                   value="<?php echo isset($task_settings['min_amount']) ? htmlspecialchars($task_settings['min_amount']) : ''; ?>">
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <select class="form-select form-select-sm" 
                                                    name="details[tasks][<?php echo $task['id']; ?>][currency_id]">
                                                <option value="">Any currency</option>
                                                <?php if (isset($payments)): foreach ($payments as $currency): ?>
                                                    <option value="<?php echo htmlspecialchars($currency['id']); ?>" 
                                                        <?php echo isset($task_settings['currency_id']) && $task_settings['currency_id'] == $currency['id'] ? 'selected' : ''; ?>>
                                                        <?php echo htmlspecialchars($currency['name']); ?>
                                                    </option>
                                                <?php endforeach; endif; ?>
                                            </select>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <select class="form-select form-select-sm" 
                                                    name="details[tasks][<?php echo $task['id']; ?>][package_id]">
                                                <option value="">Any package</option>
                                                <?php if (isset($packages)): foreach ($packages as $package): ?>
                                                    <option value="<?php echo htmlspecialchars($package['id']); ?>" 
                                                        <?php echo isset($task_settings['package_id']) && $task_settings['package_id'] == $package['id'] ? 'selected' : ''; ?>>
                                                        <?php echo htmlspecialchars($package['name']); ?>
                                                    </option>
                                                <?php endforeach; endif; ?>
                                            </select>
                                        </div>
                                    </div>
                                <?php endif; ?>
<?php if ($task['id'] === 'active_investment'): ?>
    <div class="row">
        <div class="col-md-6 mb-2">
            <input type="number" step="0.01" class="form-control form-control-sm" 
                   name="details[tasks][<?php echo $task['id']; ?>][min_amount]"
                   placeholder="Minimum active investment amount"
                   value="<?php echo isset($task_settings['min_amount']) ? htmlspecialchars($task_settings['min_amount']) : ''; ?>">
        </div>
    </div>
<?php endif; ?>
<?php if ($task['id'] === 'daily_earnings'): ?>
    <div class="row">
        <div class="col-md-6 mb-2">
            <input type="number" step="0.01" class="form-control form-control-sm" 
                   name="details[tasks][<?php echo $task['id']; ?>][min_amount]"
                   placeholder="Minimum daily earnings amount"
                   value="<?php echo isset($task_settings['min_amount']) ? htmlspecialchars($task_settings['min_amount']) : ''; ?>">
        </div>
    </div>
<?php endif; ?>
                                <?php if ($task['id'] === 'withdrawal'): ?>
                                    <div class="row">
                                        <div class="col-md-6 mb-2">
                                            <input type="number" step="0.01" class="form-control form-control-sm" 
                                                   name="details[tasks][<?php echo $task['id']; ?>][min_amount]"
                                                   placeholder="Minimum withdrawal amount"
                                                   value="<?php echo isset($task_settings['min_amount']) ? htmlspecialchars($task_settings['min_amount']) : ''; ?>">
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <select class="form-select form-select-sm" 
                                                    name="details[tasks][<?php echo $task['id']; ?>][currency_id]">
                                                <option value="">Any currency</option>
                                                <?php if (isset($payments)): foreach ($payments as $currency): ?>
                                                    <option value="<?php echo htmlspecialchars($currency['id']); ?>" 
                                                        <?php echo isset($task_settings['currency_id']) && $task_settings['currency_id'] == $currency['id'] ? 'selected' : ''; ?>>
                                                        <?php echo htmlspecialchars($currency['name']); ?>
                                                    </option>
                                                <?php endforeach; endif; ?>
                                            </select>
                                        </div>
                                    </div>
                                <?php endif; ?>

                                <?php if ($task['id'] === 'referral'): ?>
                                    <div class="row">
                                        <div class="col-md-4 mb-2">
                                            <input type="number" class="form-control form-control-sm" 
                                                   name="details[tasks][<?php echo $task['id']; ?>][min_referrals]"
                                                   placeholder="Minimum number of referrals"
                                                   value="<?php echo isset($task_settings['min_referrals']) ? htmlspecialchars($task_settings['min_referrals']) : ''; ?>">
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <input type="number" step="0.01" class="form-control form-control-sm" 
                                                   name="details[tasks][<?php echo $task['id']; ?>][min_amount]"
                                                   placeholder="Minimum total investment"
                                                   value="<?php echo isset($task_settings['min_amount']) ? htmlspecialchars($task_settings['min_amount']) : ''; ?>">
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <select class="form-select form-select-sm" 
                                                    name="details[tasks][<?php echo $task['id']; ?>][currency_id]">
                                                <option value="">Any currency</option>
                                                <?php if (isset($payments)): foreach ($payments as $currency): ?>
                                                    <option value="<?php echo htmlspecialchars($currency['id']); ?>" 
                                                        <?php echo isset($task_settings['currency_id']) && $task_settings['currency_id'] == $currency['id'] ? 'selected' : ''; ?>>
                                                        <?php echo htmlspecialchars($currency['name']); ?>
                                                    </option>
                                                <?php endforeach; endif; ?>
                                            </select>
                                        </div>
                                    </div>
                                <?php endif; ?>

                                <?php if ($task['id'] === 'account_balance'): ?>
                                    <div class="row">
                                        <div class="col-md-6 mb-2">
                                            <input type="number" step="0.01" class="form-control form-control-sm" 
                                                   name="details[tasks][<?php echo $task['id']; ?>][min_amount]"
                                                   placeholder="Minimum balance required"
                                                   value="<?php echo isset($task_settings['min_amount']) ? htmlspecialchars($task_settings['min_amount']) : ''; ?>">
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <select class="form-select form-select-sm" 
                                                    name="details[tasks][<?php echo $task['id']; ?>][currency_id]">
                                                <option value="">Any currency</option>
                                                <?php if (isset($payments)): foreach ($payments as $currency): ?>
                                                    <option value="<?php echo htmlspecialchars($currency['id']); ?>" 
                                                        <?php echo isset($task_settings['currency_id']) && $task_settings['currency_id'] == $currency['id'] ? 'selected' : ''; ?>>
                                                        <?php echo htmlspecialchars($currency['name']); ?>
                                                    </option>
                                                <?php endforeach; endif; ?>
                                            </select>
                                        </div>
                                    </div>
                                <?php endif; ?>
<?php if ($task['id'] === 'currency_specific_balance'): ?>
    <div class="row">
        <div class="col-md-6 mb-2">
            <input type="number" step="0.01" class="form-control form-control-sm" 
                   name="details[tasks][<?php echo $task['id']; ?>][min_amount]"
                   placeholder="Minimum balance required"
                   value="<?php echo isset($task_settings['min_amount']) ? htmlspecialchars($task_settings['min_amount']) : ''; ?>">
        </div>
        <div class="col-md-6 mb-2">
            <select class="form-select form-select-sm" 
                    name="details[tasks][<?php echo $task['id']; ?>][currency_id]">
                <option value="">Select currency</option>
                <?php if (isset($payments)): foreach ($payments as $currency): ?>
                    <option value="<?php echo htmlspecialchars($currency['id']); ?>" 
                        <?php echo isset($task_settings['currency_id']) && $task_settings['currency_id'] == $currency['id'] ? 'selected' : ''; ?>>
                        <?php echo htmlspecialchars($currency['name']); ?>
                    </option>
                <?php endforeach; endif; ?>
            </select>
        </div>
    </div>
<?php endif; ?>
                                <?php if ($task['id'] === 'faucet_claims'): ?>
                                    <div class="row">
                                        <div class="col-md-6 mb-2">
                                            <input type="number" step="0.01" class="form-control form-control-sm" 
                                                   name="details[tasks][<?php echo $task['id']; ?>][min_amount]"
                                                   placeholder="Minimum faucet claims amount"
                                                   value="<?php echo isset($task_settings['min_amount']) ? htmlspecialchars($task_settings['min_amount']) : ''; ?>">
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <select class="form-select form-select-sm" 
                                                    name="details[tasks][<?php echo $task['id']; ?>][currency_id]">
                                                <option value="">Any currency</option>
                                                <?php if (isset($payments)): foreach ($payments as $currency): ?>
                                                    <option value="<?php echo htmlspecialchars($currency['id']); ?>" 
                                                        <?php echo isset($task_settings['currency_id']) && $task_settings['currency_id'] == $currency['id'] ? 'selected' : ''; ?>>
                                                        <?php echo htmlspecialchars($currency['name']); ?>
                                                    </option>
                                                <?php endforeach; endif; ?>
                                            </select>
                                        </div>
                                    </div>
                                <?php endif; ?>

                                <?php if ($task['id'] === 'tier_level'): ?>
                                    <div class="row">
                                        <div class="col-md-6 mb-2">
                                            <input type="number" class="form-control form-control-sm" 
                                                   name="details[tasks][<?php echo $task['id']; ?>][min_tier]"
                                                   placeholder="Minimum tier level required"
                                                   value="<?php echo isset($task_settings['min_tier']) ? htmlspecialchars($task_settings['min_tier']) : ''; ?>">
                                        </div>
                                    </div>
                                <?php endif; ?>
                            </div>
                        </div>
                    </div>
                    <?php endforeach; ?>
                </div>
</div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get all required elements
    const typeSelect = document.getElementById('type');
    const automatedTaskSelection = document.getElementById('automatedTaskSelection');
    const telegramSection = document.getElementById('telegramTasksSection');
    const selectedTask = document.getElementById('selectedTask');
    
    // Function to handle visibility of sections
    function toggleSections() {
        const isAutomatedTask = typeSelect.value === '2';
        
        // Show/hide automated task dropdown
        automatedTaskSelection.style.display = isAutomatedTask ? 'flex' : 'none';
        
        // Show/hide telegram section based on both type and task selection
        telegramSection.style.display = isAutomatedTask && selectedTask.value ? 'block' : 'none';
        
        // Hide all task settings first
        document.querySelectorAll('.task-settings').forEach(el => {
            el.style.display = 'none';
        });
        
        // Show selected task settings if a task is selected
        if (isAutomatedTask && selectedTask.value) {
            const taskSettings = document.getElementById('task-' + selectedTask.value);
            if (taskSettings) {
                taskSettings.style.display = 'block';
            }
        }
    }

    // Add event listeners
    typeSelect.addEventListener('change', function() {
        // Reset selected task when type changes
        if (this.value !== '2') {
            selectedTask.value = '';
        }
        toggleSections();
    });

    selectedTask.addEventListener('change', toggleSections);
    
    // Set initial state
    toggleSections();
});
</script>
                <div class="separator separator-dashed my-2"></div>
                 <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9"> Enter Title of Task/Bounty</label>
                    </div>
                </div>
                <div class="col-md-8">
                    <input type="text" name="name" value="<?php echo $b["name"] ?>" class="form-control form-control-sm" required="">
                    <small id="emailHelp" class="form-text text-muted fs-9">EnterTask/Bounty name - Will be shown to users while viewing and claiming.</small>
                </div>
                 <div class="separator separator-dashed my-2"></div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Link</label>
                    </div>
                </div>
                <div class="col-md-8">
                    <input type="text" name="url" value="<?php echo $b["url"] ?>" class="form-control form-control-sm">
                    <small id="emailHelp" class="form-text text-muted fs-9">If you want to show any Image Banner for Bounty/Task. <b>Make Sure the Bot is added to this group as admin.</b></small>
                </div>
                  <div class="separator separator-dashed my-2"></div>
                  <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Task Image / ICON</label>
                    </div>
                </div>
                
        <div class="card-body text-center pt-0 col-md-8">
                                                    <!--begin::Image input-->
                                                    <!--begin::Image input placeholder-->
                                                    <style>.image-input-placeholder { background-image: url('assets/media/svg/files/blank-image.svg'); } [data-bs-theme="dark"] .image-input-placeholder { background-image: url('assets/media/svg/files/blank-image-dark.svg'); }</style>
                                                    <!--end::Image input placeholder-->
      <div class="image-input image-input-outline" data-kt-image-input="true" 
             style="background-image: url('svg/avatars/blank.svg')">
            <!--begin::Image preview wrapper-->
            <div class="image-input-wrapper w-200px " id="main-image-preview"
             style="background-image: url('<?= ($b && $b['image_url']) ? htmlspecialchars($b['image_url']) : 'bitders/assets/placeholder.svg' ?>')">
        </div>
            <!--end::Image preview wrapper-->

                    <label class="btn btn-icon btn-circle btn-color-muted btn-active-color-primary w-25px h-25px bg-body shadow"
               data-kt-image-input-action="change"
               data-bs-toggle="modal"
               data-bs-target="#kt_modal_100"
               title="Change main image">
            <i class="ki-duotone ki-pencil fs-6"><span class="path1"></span><span class="path2"></span></i>
        </label>
        <!--end::Edit button-->
        <!--begin::Cancel button-->
        <span class="btn btn-icon btn-circle btn-color-muted btn-active-color-primary w-25px h-25px bg-body shadow"
              data-kt-image-input-action="cancel"
              data-bs-toggle="tooltip"
              data-bs-dismiss="click"
              title="Cancel image">
            <i class="ki-outline ki-cross fs-3"></i>
        </span>
        <!--end::Cancel button-->
        <!--begin::Remove button-->
        <span class="btn btn-icon btn-circle btn-color-muted btn-active-color-primary w-25px h-25px bg-body shadow"
              data-kt-image-input-action="remove"
              data-bs-toggle="tooltip"
              data-bs-dismiss="click"
              title="Remove image">
            <i class="ki-outline ki-cross fs-3"></i>
        </span>
            <!--end::Remove button-->
        </div>
           <input type="hidden" id="selected_image_url" name="image_url" value="<?= ($b && $b['image_url']) ? htmlspecialchars($b['image_url']) : '' ?>">                                          <!--end::Image input-->
                                                    <!--begin::Description-->
                                                    <div class="text-muted fs-7">Image/Icon for the Task</div>
                                                    <!--end::Description-->
                                                </div>
                                                
                <div class="separator separator-dashed my-2"></div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9"> Enter Description of Task/Bounty</label>
                    </div>
                </div>
             <div class="col-md-8">
                 <textarea rows="5" name="content" class="form-control form-control-sm"><?php echo $b["content"] ?></textarea> 
                 <small id="Help" class="form-text text-muted fs-9">Add Description for your Package</small>
                 </div>
<!-- Reward Types Selection -->
<div class="row g-5 g-xl-8">
    <!-- Account Balance Column -->
    <div class="col-xl-4">
        <div class="card card-xl-stretch mb-xl-8">
            <div class="card-title px-5 py-5">
                <div class="d-flex flex-stack">
                    <div class="d-flex">
                        <div class="d-flex flex-column">
                            <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Account Balance</a>
                            <div class="fs-9 fw-semibold text-gray-500">Reward with account balance</div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-end">
                        <div class="form-check form-check-solid form-check-custom form-switch">
                            <input class="form-check-input w-45px h-30px" type="checkbox" name="details[account_balance_enabled]" value="true" id="accountBalanceCheck" <?=$details['account_balance_enabled'] == 'true' ? 'checked' : '' ?>>
                            <label class="form-check-label fs-9" for="accountBalanceCheck"></label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body" id="accountBalanceSection" style="display: none;">
                <div class="mb-5">
                    <label class="fs-9">Amount Type</label>
                    <select class="form-select form-select-sm" name="details[account_amount_type]" id="accountAmountType">
                        <option value="0" <?= $details['account_amount_type'] === '0' ? 'selected' : '' ?>>Fixed</option>
                        <option value="1" <?= $details['account_amount_type'] === '1' ? 'selected' : '' ?>>Range</option>
                    </select>
                </div>

                <div class="row mb-5" id="accountAmountFields">
                    <div class="col-md-12" id="accountMinField">
                        <label class="fs-9">Minimum Amount:</label>
                        <input type="text" name="details[account_amount_min]" class="form-control form-control-sm" value="<?=$details['account_amount_min']; ?>">
                    </div>
                    <div class="col-md-12" id="accountMaxField" style="display: none;">
                        <label class="fs-9">Maximum Amount:</label>
                        <input type="text" name="details[account_amount_max]" class="form-control form-control-sm" value="<?=$details['account_amount_max']; ?>">
                    </div>
                </div>

                <div class="mb-5">
                    <label class="fs-9">Currency</label>
                    <select class="form-select form-select-sm" name="details[account_currency]">
                        <?php 
                        $select_method = mysqli_query($DB_CONN, "SELECT * from currencies where de_pm_id != 0");
                        while ($row_method = mysqli_fetch_assoc($select_method)) {
                            $selected = ($details['account_currency'] == $row_method['id']) ? 'selected' : '';
                            echo '<option value="' . $row_method['id'] . '" ' . $selected . '>' . $row_method['name'] . '</option>';
                        }
                        ?>
                    </select>
                </div>
 <div class="card-title px-5 py-5">
                <div class="d-flex flex-stack">
                    <div class="d-flex">
                        <div class="d-flex flex-column">
                            <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Account Balance Reversal on Failure of Task</a>
                            <div class="fs-9 fw-semibold text-gray-500">Rewards will be reversed on account balance</div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-end">
                        <div class="form-check form-check-solid form-check-custom form-switch">
                            <input class="form-check-input w-45px h-30px" type="checkbox" name="details[account_balance_reversal_enabled]" value="true" id="account_balance_reversal_enabled" <?=$details['account_balance_reversal_enabled'] == 'true' ? 'checked' : '' ?>>
                            <label class="form-check-label fs-9" for="account_balance_reversal_enabled"></label>
                        </div>
                    </div>
                </div>
            </div>
                <div class="mb-5">
                    <label class="fs-9">Reward Balance Memo</label>
                    <input type="text" name="details[account_memo]" class="form-control form-control-sm" value="<?=$details['account_memo'] ?: "#task_reward# for completing Task/Bounty"; ?>">
                    <label class="form-check-label fs-9">Available Short Code #task_reward#</label>
                    <small class="fs-9 d-block">Enter detail for transaction.</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Faucet Balance Column -->
    <div class="col-xl-4">
        <div class="card card-xl-stretch mb-xl-8">
            <div class="card-title px-5 py-5">
                <div class="d-flex flex-stack">
                    <div class="d-flex">
                        <div class="d-flex flex-column">
                            <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Faucet Balance</a>
                            <div class="fs-9 fw-semibold text-gray-500">Reward with faucet balance</div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-end">
                        <div class="form-check form-check-solid form-check-custom form-switch">
                            <input class="form-check-input w-45px h-30px" type="checkbox" name="details[faucet_balance_enabled]" value="true" id="faucetBalanceCheck" <?=$details['faucet_balance_enabled'] == 'true' ? 'checked' : '' ?>>
                            <label class="form-check-label fs-9" for="faucetBalanceCheck"></label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body" id="faucetBalanceSection" style="display: none;">
                <div class="mb-5">
                    <label class="fs-9">Amount Type</label>
                    <select class="form-select form-select-sm" name="details[faucet_amount_type]" id="faucetAmountType">
                        <option value="0" <?= $details['faucet_amount_type'] === '0' ? 'selected' : '' ?>>Fixed</option>
                        <option value="1" <?= $details['faucet_amount_type'] === '1' ? 'selected' : '' ?>>Range</option>
                    </select>
                </div>

                <div class="row mb-5" id="faucetAmountFields">
                    <div class="col-md-12" id="faucetMinField">
                        <label class="fs-9">Minimum Amount:</label>
                        <input type="text" name="details[faucet_amount_min]" class="form-control form-control-sm" value="<?=$details['faucet_amount_min']; ?>">
                    </div>
                    <div class="col-md-12" id="faucetMaxField" style="display: none;">
                        <label class="fs-9">Maximum Amount:</label>
                        <input type="text" name="details[faucet_amount_max]" class="form-control form-control-sm" value="<?=$details['faucet_amount_max']; ?>">
                    </div>
                </div>

                <div class="mb-5">
                    <label class="fs-9">Currency</label>
                    <select class="form-select form-select-sm" name="details[faucet_currency]">
                        <?php 
                        $select_method = mysqli_query($DB_CONN, "SELECT * from currencies where de_pm_id != 0");
                        while ($row_method = mysqli_fetch_assoc($select_method)) {
                            $selected = ($details['faucet_currency'] == $row_method['id']) ? 'selected' : '';
                            echo '<option value="' . $row_method['id'] . '" ' . $selected . '>' . $row_method['name'] . '</option>';
                        }
                        ?>
                    </select>
                </div>
   <div class="d-flex flex-stack">
                    <div class="d-flex">
                        <div class="d-flex flex-column">
                            <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Facuet Balance Reversal on Failure of Task</a>
                            <div class="fs-9 fw-semibold text-gray-500">Rewards will be reversed on Facuet balance</div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-end">
                        <div class="form-check form-check-solid form-check-custom form-switch">
                            <input class="form-check-input w-45px h-30px" type="checkbox" name="details[faucet_balance_reversal_enabled]" value="true" id="faucet_balance_reversal_enabled" <?=$details['faucet_balance_reversal_enabled'] == 'true' ? 'checked' : '' ?>>
                            <label class="form-check-label fs-9" for="faucet_balance_reversal_enabled"></label>
                        </div>
                    </div>
                </div>
                <div class="mb-5">
                    <label class="fs-9">Reward Faucet Balance Memo</label>
                    <input type="text" name="details[faucet_memo]" class="form-control form-control-sm" value="<?=$details['faucet_memo'] ?: "#task_reward# for completing Task/Bounty"; ?>">
                    <label class="form-check-label fs-9">Available Short Code #task_reward#</label>
                    <small class="fs-9 d-block">Enter detail for transaction.</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Taps Column -->
    <div class="col-xl-4">
        <div class="card card-xl-stretch mb-xl-8">
            <div class="card-title px-5 py-5">
                <div class="d-flex flex-stack">
                    <div class="d-flex">
                        <div class="d-flex flex-column">
                            <a class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Taps</a>
                            <div class="fs-9 fw-semibold text-gray-500">Reward with taps</div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-end">
                        <div class="form-check form-check-solid form-check-custom form-switch">
                            <input class="form-check-input w-45px h-30px" type="checkbox" name="details[taps_enabled]" value="true" id="tapsCheck" <?=$details['taps_enabled'] == 'true' ? 'checked' : '' ?>>
                            <label class="form-check-label fs-9" for="tapsCheck"></label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body" id="tapsSection" style="display: none;">
                <div class="mb-5">
                    <label class="fs-9">Taps Amount</label>
                    <input type="text" name="details[taps_amount]" class="form-control form-control-sm" value="<?=$details['taps_amount']; ?>">
                    <small class="fs-9 d-block">Enter the number of Taps to reward</small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Sections
    const accountSection = document.getElementById('accountBalanceSection');
    const faucetSection = document.getElementById('faucetBalanceSection');
    const tapsSection = document.getElementById('tapsSection');

    // Checkboxes
    const accountCheck = document.getElementById('accountBalanceCheck');
    const faucetCheck = document.getElementById('faucetBalanceCheck');
    const tapsCheck = document.getElementById('tapsCheck');

    // Amount type selects
    const accountAmountType = document.getElementById('accountAmountType');
    const faucetAmountType = document.getElementById('faucetAmountType');

    // Amount fields
    const accountMinField = document.getElementById('accountMinField');
    const accountMaxField = document.getElementById('accountMaxField');
    const faucetMinField = document.getElementById('faucetMinField');
    const faucetMaxField = document.getElementById('faucetMaxField');

    // Initialize sections based on checkbox state
    function initializeSections() {
        accountSection.style.display = accountCheck.checked ? 'block' : 'none';
        faucetSection.style.display = faucetCheck.checked ? 'block' : 'none';
        tapsSection.style.display = tapsCheck.checked ? 'block' : 'none';

        // Initialize amount fields visibility
        accountMaxField.style.display = accountAmountType.value === '1' ? 'block' : 'none';
        faucetMaxField.style.display = faucetAmountType.value === '1' ? 'block' : 'none';
    }

    // Toggle sections based on checkboxes
    accountCheck.addEventListener('change', function() {
        accountSection.style.display = this.checked ? 'block' : 'none';
    });

    faucetCheck.addEventListener('change', function() {
        faucetSection.style.display = this.checked ? 'block' : 'none';
    });

    tapsCheck.addEventListener('change', function() {
        tapsSection.style.display = this.checked ? 'block' : 'none';
    });

    // Handle amount type changes for Account Balance
    accountAmountType.addEventListener('change', function() {
        accountMaxField.style.display = this.value === '1' ? 'block' : 'none';
    });

    // Handle amount type changes for Faucet Balance
    faucetAmountType.addEventListener('change', function() {
        faucetMaxField.style.display = this.value === '1' ? 'block' : 'none';
    });

    // Initialize on page load
    initializeSections();
});
</script>
             <div class="separator separator-dashed my-2"></div>
          
        
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Instructions Image Url for This Task or Bounty (if any)</label>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card-body text-center pt-0">
                                                    <!--begin::Image input-->
                                                    <!--begin::Image input placeholder-->
                                                    <style>.image-input-placeholder { background-image: url('assets/media/svg/files/blank-image.svg'); } [data-bs-theme="dark"] .image-input-placeholder { background-image: url('assets/media/svg/files/blank-image-dark.svg'); }</style>
                                                    <!--end::Image input placeholder-->
      <div class="image-input image-input-outline" data-kt-image-input="true" 
             style="background-image: url('svg/avatars/blank.svg')">
            <!--begin::Image preview wrapper-->
            <div class="image-input-wrapper w-200px " id="main-image-preview"
             style="background-image: url('<?= ($b && $b['instructions_image_url']) ? htmlspecialchars($b['instructions_image_url']) : 'bitders/assets/placeholder.svg' ?>')">
        </div>
            <!--end::Image preview wrapper-->

                    <label class="btn btn-icon btn-circle btn-color-muted btn-active-color-primary w-25px h-25px bg-body shadow"
               data-kt-image-input-action="change"
               data-bs-toggle="modal"
               data-bs-target="#kt_modal_100"
               title="Change main image">
            <i class="ki-duotone ki-pencil fs-6"><span class="path1"></span><span class="path2"></span></i>
        </label>
        <!--end::Edit button-->
        <!--begin::Cancel button-->
        <span class="btn btn-icon btn-circle btn-color-muted btn-active-color-primary w-25px h-25px bg-body shadow"
              data-kt-image-input-action="cancel"
              data-bs-toggle="tooltip"
              data-bs-dismiss="click"
              title="Cancel image">
            <i class="ki-outline ki-cross fs-3"></i>
        </span>
        <!--end::Cancel button-->
        <!--begin::Remove button-->
        <span class="btn btn-icon btn-circle btn-color-muted btn-active-color-primary w-25px h-25px bg-body shadow"
              data-kt-image-input-action="remove"
              data-bs-toggle="tooltip"
              data-bs-dismiss="click"
              title="Remove image">
            <i class="ki-outline ki-cross fs-3"></i>
        </span>
            <!--end::Remove button-->
        </div>
           <input type="hidden" id="selected_image_url" name="instructions_image_url" value="<?= ($b && $b['instructions_image_url']) ? htmlspecialchars($b['instructions_image_url']) : '' ?>">                                          <!--end::Image input-->
                                                    <!--begin::Description-->
                                                    <div class="text-muted fs-7">Instructions Image for the Task</div>
                                                    <!--end::Description-->
                                                </div>
                </div>
                <div class="separator separator-dashed my-2"></div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Instructions for This Task or Bounty (if any)</label>
                    </div>
                </div>
                 <div class="col-md-8">
                 <textarea rows="5" name="instructions" class="form-control form-control-sm"><?php echo $b["instructions"] ?></textarea> 
                 <small id="Help" class="form-text text-muted fs-9">Add Instructions while applying</small>
                 </div>
                 <div class="separator separator-dashed my-2"></div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="fs-9">Status:</label>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <select class="form-select form-select-sm" required="" name="status">
                        <option value="1" <? echo $b['status'] == "1" ? " selected" : "" ?>>Active</option>
                        <option value="0" <? echo $b['status'] == "0" ? " selected" : "" ?>>In-Active</option>
                        <option value="2" <? echo $b['status'] == "2" ? " selected" : "" ?>>Closed</option>
    
                    </select>
                    <small id="Help" class="form-text text-muted fs-9">Please select the Task/Bounty status Active - InActive - Closed </small>
                    </div>
                   
       </div>
 
  
  </div>
     <div class="card-footer d-flex justify-content-end py-2 px-9"> 
    <?php if($b['id']) { ?>  
        <input class="btn btn-primary btn-sm me-2" type="submit" name="submit" value="Edit Task/Bounty">
        <input type="hidden" name="id" value="<?php echo $b['id'] ?>">
        <input type="hidden" name="lang_id" value="<?php echo $lang ?>">
        <input type="hidden" name="action" value="update">
    <?php } else { ?>
        <input class="btn btn-primary btn-sm me-2" type="submit" name="submit" value="Add Task/Bounty"> 
        <input type="hidden" name="lang_id" value="<?php echo $lang ?>">
        <input type="hidden" name="action" value="add">
    <?php } ?>
</div>
</div>
</form>
       
       <script>
            $("#faucetdiv").<? echo $details['faucet'] == 'true' ? "show" : "hide" ?>();
$("#faucet").click(function() {
    if($(this).is(":checked")) {
        $("#faucetdiv").show();
        $("#faucet_currency").attr('required', true);
    } else {
        $("#faucet_currency").attr('required', false);
        $("#faucetdiv").hide();
    }
});
       </script>
        <?php
        }
     }else{
    ?>                   
<?php


// Language selector at the top of the card
?>
<div class="card mb-2">
    <div class="card-header min-h-unset py-2">
        <div class="d-flex justify-content-between align-items-center">
            <h3 class="card-title align-items-start flex-column m-0">
                <span class="card-label fw-bold text-gray-900">Tasks and Bounties</span>
                <span class="text-gray-500 mt-1 fw-semibold fs-6"></span>
            </h3>
            
            <div class="d-flex align-items-center gap-3">
                <!-- Language Selector -->
                <form action="" method="GET" class="me-3">
                    <input type="hidden" name="page" value="tasks">
                    <select name="lang" class="form-select form-select-sm form-select-solid w-200px" 
                            onchange="this.form.submit()"
                            data-control="select2"
                            data-placeholder="Select Language">
                        <?php  
                        $l = mysqli_query($DB_CONN, "SELECT * FROM languagues WHERE status = 1");
                        while ($lan = mysqli_fetch_assoc($l)): 
                        ?>
                            <option value="<?php echo $lan['id']; ?>"
                                    <?php echo ($lan['id'] == $lang) ? 'selected' : ''; ?>>
                                <?php echo htmlspecialchars($lan['name']); ?>
                            </option>
                        <?php endwhile; ?>
                    </select>
                </form>

                <!-- Add New Task Button -->
                <a href="admin?page=tasks&action=edit" class="btn btn-sm btn-primary btn-active-light py-1">
                    <i class="ki-duotone ki-plus fs-2"></i> Task/Bounty
                </a>

                <?php if ($lang != 1): ?>
                    <!-- Translate All Button -->
                    <form action="" method="POST" class="d-inline">
                        <input type="hidden" name="action" value="translate_all">
                        <input type="hidden" name="lang_id" value="<?php echo $lang; ?>">
                        <button type="submit" class="btn btn-sm btn-info btn-active-light py-1">
                            <i class="ki-duotone ki-translate fs-2"></i> Translate All
                        </button>
                    </form>
                <?php endif; ?>
            </div>
        </div>
    </div>
    
    <div class="card-body">     
        <table class="table table-striped table-bordered display dataTable table-hover table-sm" id="default_order">
            <thead>
                <tr>
                    <th width="8%">ID</th>
                    <th width="15%">Type</th>
                    <th width="30%">Title</th>
                    <th width="50%">Content</th>
                    <th width="5%">Status</th>
                    <th width="5%">Actions</th>
                </tr>
            </thead>
            <tbody>
            <?php
            $lang = isset($_GET['lang']) ? (int)$_GET['lang'] : 1;
            if ($lang == 1) {
                // For default language, show original tasks
                $q = mysqli_query($DB_CONN, "SELECT * FROM tasks WHERE lang_id = 1");
            } else {
                // For other languages, show translations if they exist, or originals if they don't
                $q = mysqli_query($DB_CONN, "
                    SELECT 
                        t1.*, 
                        COALESCE(t2.id, t1.id) as display_id,
                        COALESCE(t2.name, t1.name) as display_name,
                        COALESCE(t2.content, t1.content) as display_content,
                        COALESCE(t2.status, t1.status) as display_status,
                        CASE WHEN t2.id IS NULL THEN 0 ELSE 1 END as is_translated
                    FROM tasks t1
                    LEFT JOIN tasks t2 ON t1.id = t2.translation_of AND t2.lang_id = $lang
                    WHERE t1.lang_id = 1
                ");
            }

            while ($query = mysqli_fetch_assoc($q)) {
                $isTranslated = isset($query['is_translated']) ? $query['is_translated'] : 1;
                ?>
                <tr <?php echo !$isTranslated ? 'class="table-warning"' : ''; ?>>
                    <td><?php echo $query['display_id'] ?? $query['id']; ?></td>
                    <td><?php echo $query['type'] ? 'Bounty' : 'Task'; ?></td>     
                    <td><?php echo $query['display_name'] ?? $query['name']; ?></td>  
                    <td><?php echo $query['display_content'] ?? $query['content']; ?></td>    
                    <td>
                        <?php 
                        $status = $query['display_status'] ?? $query['status'];
                        echo $status ? '<span class="badge badge-success">Active</span>' : 
                                     '<span class="badge badge-danger">InActive</span>'; 
                        ?>
                    </td>  
                    <td>
                        <div class="d-flex justify-content-end flex-shrink-0">
                         <a href="?page=tasks&action=edit&id=<?php echo $query['id']; ?>&lang=<?php echo $lang; ?>" 
                   class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm me-1">
                    <i class="ki-duotone ki-pencil fs-2">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                </a>

                            <!-- Delete Button -->
                            <form action="" method="post" id="form_<?php echo $query['id']; ?>">
                                <input type="hidden" name="action" value="delete">
                                <input type="hidden" name="id" value="<?php echo $query['id']; ?>">
                                <button type="submit" name="submit" 
                                        onclick="return confirm('Do you Really Want to Delete?')" 
                                        class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm">
                                    <i class="ki-duotone ki-trash fs-2">
                                        <span class="path1"></span>
                                        <span class="path2"></span>
                                        <span class="path3"></span>
                                        <span class="path4"></span>
                                        <span class="path5"></span>
                                    </i>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                <?php
            }
            ?>
            </tbody>
        </table>
    </div>         
</div>
                                            <!--end::Form-->
                                        </div>
                                    
     <? }?>

<?
}
if ($_GET['page'] == 'tap')
{?>
<form method="post">
    <div class="card mt-3 mb-5">
        <div class="card-header min-h-unset py-2" role="button">
            <div class="card-title m-0">
                <h3 class="fw-bold m-0 fs-5">TapTap</h3>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9"> Game Name</label>
                    </div>
                </div>
                <div class="col-md-8">
                    <input type="text" name="name" value="<?php echo $b["name"] ?>" class="form-control form-control-sm" required="">
                    <small id="emailHelp" class="form-text text-muted fs-9">EnterTask/Bounty name - Will be shown to users while viewing and claiming.</small>
                </div>
                <div class="separator separator-dashed my-2"></div>
                 
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="fs-9"> Tap Currency: </label>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <select class="form-select form-select-sm form-select-solid" name="limit_currency" id="limit_currency">
                                <option value=""> Allow all Currencies</option>
                                <?php $select_method = mysqli_query($DB_CONN, "SELECT * from currencies where de_pm_id != 0");
                while ($row_method = mysqli_fetch_assoc($select_method))
                { ?>
                                    <option value="<?php echo $row_method['id'] ?>" <? echo $plan['limit_currency'] == $row_method['id'] ? " selected" : "" ?>> <?php echo $row_method['name'] ?> </option>
                            <?php
                } ?>
                                        
                                    </select>
                            <small id="emailHelp" class="form-text text-muted fs-9">Will be active via this currency only.</small>
                        </div>
                   <!--currencies -->
                     <div class="separator separator-dashed my-2 "></div>
                      
    
                    <div class="col-md-4 ">
                        <div class="form-group">
                            <label class="fs-9">Limit User Count:</label>
                        </div>
                    </div>
                    <div class="col-md-4 ">
                        <input type="text" name="details[limit_user_deposits_count]" value="<? echo $details['limit_user_deposits_count'] ?>" class="form-control form-control-sm" />
                        <label class="form-check-label fs-9" for="limit_user_deposits_count">Limit Invest/Faucet (per user) (leave empty to skip)</label>
                    </div>
                     <div class="col-md-4 ">
                        <select class="form-select form-select-sm" name="details[limit_user_deposits_count_per]">
                            <option value="" >None</option>
                            <option value="hours"  <? echo $details['limit_user_deposits_count_per'] == "hours" ? " selected" : "" ?>>Per Hour</option>
                            <option value="days" <? echo $details['limit_user_deposits_count_per'] == "days" ? " selected" : "" ?>>Per Day</option>
                            <option value="weeks" <? echo $details['limit_user_deposits_count_per'] == "weeks" ? " selected" : "" ?>>Per Week</option>
                            <option value="bi-weeks" <? echo $details['limit_user_deposits_count_per'] == "bi-weeks" ? " selected" : "" ?>>Per Bi-Week</option>
                            <option value="months" <? echo $details['limit_user_deposits_count_per'] == "months" ? " selected" : "" ?>>Per Month</option>
                             <option value="years" <? echo $details['limit_user_deposits_count_per'] == "years" ? " selected" : "" ?>>Per Year</option>
                        </select>
                        <label class="form-check-label fs-9" for="limit_user_deposits_count_per">Limit User Active Deposits Amount Per Hour, Day, Week, Bi-Weeks, Months, Year</label>
                    </div>
                     <div class="separator separator-dashed my-2 "></div>
                  <div class="col-md-12 faucet_auto ">
                       <div class="table-responsive">
                    <table  class="table editable-table table-bordered table-striped m-b-0 table-sm" id="mainTable">
                        <thead class="">
                            <tr>
                                
                                <th>Details</th>
                                <th class="text-center" >Tap Amount</th>
                                <th class="text-center" >Tap Earning Type</th>
                                
                         <th class="text-center" >Tap</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                  <b>Base Tap Amount</b> (For Active / Non Active Users)
                                </td>
                                 <td>
                                   <input type="text" name="details[faucet][0][amount]" placeholder="Amount" value="<?php echo $details['faucet']['0']['amount'] ?>" class="form-control form-control-sm">
                               </td>
                               
                                <td>
                                    <select class="form-select form-select-sm" name="details[faucet][0][type]">
                            <option value="0"  <? echo $details['faucet']['0']['type'] == "0" ? " selected" : "" ?>>Real Balance (Can be Invest / Withdraw)</option>
                            <option value="1" <? echo $details['faucet']['0']['type'] == "1" ? " selected" : "" ?>> Faucet Balance (Can be used to Invest only)</option>
                           
                        </select>
                               </td>
                            </tr>
                          
                     
                            <?php $a = mysqli_query($DB_CONN, "SELECT * FROM `packages` where etype !='4' ");
          while ($pl = mysqli_fetch_assoc($a))
          
          { $fid = $pl['id']; ?> 
          <tr>
              <td>Facuet Amount for Users Invested in <?php echo $pl['name'] ?></td>
               <td><input type="text" name="details[faucet][<?php echo $pl['id'] ?>][amount]" placeholder="Amount" value="<?php echo $details['faucet'][$fid]['amount'] ?>" class="form-control form-control-sm"> </td>
                 <td>
                <select class="form-select form-select-sm" name="details[faucet][<?php echo $pl['id'] ?>][type]">
        <option value="0"  <? echo $details['faucet'][$fid]['type'] == "0" ? " selected" : "" ?>>Real Balance Faucet (Can be Invest / Withdraw)</option>
        <option value="1" <? echo $details['faucet'][$fid]['type'] == "1" ? " selected" : "" ?>> Faucet Balance (Can be used to Invest only)</option>
       
    </select>
           </td>
            <td>
                <select class="form-select form-select-sm" name="details[faucet][<?php echo $pl['id'] ?>][do]">
        <option value="0"  <? echo $details['faucet'][$fid]['do'] == "0" ? " selected" : "" ?>>Override Base Amount</option>
        <option value="1" <? echo $details['faucet'][$fid]['do'] == "1" ? " selected" : "" ?>> Add in Base Amount</option>
       
    </select>
           </td>
          </tr>
           <?php
          } ?>
        
        </tbody>
        </table>
         </div>
         
    </div>
            <div class="separator separator-dashed my-2 rest"></div>
    <div id="referral" class="table-responsive">
         <div class="fs-9 fw-semibold text-gray-500">To Set Levels and Tiers please reffer to <a  href="admin?page=referral">referral settings.</a></div>
    <div class="table-responsive">
    <table class="table table-striped table-bordered">
    <thead>
        <tr class="fw-bold text-muted bg-light">
            <td rowspan="2" class="align-middle">Tiers</td>
            <td colspan="<?php echo $referral_settings['system'] == 'normal' ? '1' : '5' ?>" class="text-center">Account Tier Name</td>
            <?php for ($i = 1; $i <= $referral_settings['levels']; $i++) { ?>
                <td class="text-center">Level <?= $i ?></td>
            <?php } ?>
        </tr>
        <tr class="fw-bold text-muted bg-light">
            <td colspan="<?php echo $referral_settings['system'] == 'normal' ? '1' : '5' ?>" class="text-center text-muted">Tier name (Can be any)</td>
            <?php for ($i = 1; $i <= $referral_settings['levels']; $i++) { ?>
                <td class="text-center text-muted">Commission (%)</td>
            <?php } ?>
        </tr>
    </thead>
    <tbody>
        <?php for ($i = 1; $i <= $referral_settings['tiers']; $i++) { ?>
            <tr>
                <td rowspan="<?php echo $referral_settings['system'] == 'normal' ? '1' : '3' ?>" class="align-middle">Tier <?= $i ?></td>
                <td colspan="<?php echo $referral_settings['system'] == 'normal' ? '1' : '5' ?>">
                    <input type="text" 
                           name="details[referral][tier][<?= $i ?>][name]" 
                           value="<?php echo isset($details['referral']['tier'][$i]['name']) ? $details['referral']['tier'][$i]['name'] : 'Tier '.$i; ?>" 
                           class="form-control form-control-sm" />
                </td>
                <?php for ($l = 1; $l <= $referral_settings['levels']; $l++) { ?>
                    <td rowspan="<?php echo $referral_settings['system'] == 'normal' ? '1' : '3' ?>" class="align-middle">
                        <input type="number" 
                               name="details[referral][tier][<?= $i ?>][level][<?= $l ?>]" 
                               value="<?php echo isset($details['referral']['tier'][$i]['level'][$l]) ? $details['referral']['tier'][$i]['level'][$l] : ''; ?>" 
                               class="form-control form-control-sm" />
                    </td>
                <?php } ?>
            </tr>
            <?php if ($referral_settings['system'] == 'ranges') { ?>
                <tr>
                    <td>User Investment</td>
                    <td>Referral Investments</td>
                    <td>No of Sponsors</td>
                    <td>No of Total Team</td>
                    <td>No of Indirect Referrals</td>
                </tr>
                <tr>
                    <td>
                        <input type="number" 
                               name="details[referral][tier][<?= $i ?>][invested]" 
                               value="<?php echo isset($details['referral']['tier'][$i]['invested']) ? $details['referral']['tier'][$i]['invested'] : ''; ?>" 
                               class="form-control form-control-sm" />
                    </td>
                    <td>
                        <input type="number" 
                               name="details[referral][tier][<?= $i ?>][investments]" 
                               value="<?php echo isset($details['referral']['tier'][$i]['investments']) ? $details['referral']['tier'][$i]['investments'] : ''; ?>" 
                               class="form-control form-control-sm" />
                    </td>
                    <td>
                        <input type="text" 
                               name="details[referral][tier][<?= $i ?>][sponsors]" 
                               value="<?php echo isset($details['referral']['tier'][$i]['sponsors']) ? $details['referral']['tier'][$i]['sponsors'] : ''; ?>" 
                               class="form-control form-control-sm" />
                    </td>
                    <td>
                        <input type="text" 
                               name="details[referral][tier][<?= $i ?>][referrals]" 
                               value="<?php echo isset($details['referral']['tier'][$i]['referrals']) ? $details['referral']['tier'][$i]['referrals'] : ''; ?>" 
                               class="form-control form-control-sm" />
                    </td>
                    <td>
                        <input type="text" 
                               name="details[referral][tier][<?= $i ?>][indirect_referrals]" 
                               value="<?php echo isset($details['referral']['tier'][$i]['indirect_referrals']) ? $details['referral']['tier'][$i]['indirect_referrals'] : ''; ?>" 
                               class="form-control form-control-sm" />
                    </td>
                </tr>
            <?php } ?>
        <?php } ?>
    </tbody>
</table>
         </div>
         <div class="separator separator-dashed my-2"></div>
                  <div class="row faucet">
                          <div class="col-md-3 ">
                        <div class="form-group">
                            <label class="fs-9">Limit Total Faucet Amount :</label>
                        </div>
                    </div>
                    <div class="col-md-4 ">
                        <input type="text" name="details[limit_faucet_amount]" value="<? echo $details['limit_faucet_amount'] ?>" class="form-control form-control-sm" />
                        <label class="form-check-label fs-9" for="limit_faucet_amount">Total Faucet Amount to be Claimed by all users (leave empty to skip)</label>
                    </div>
                     <div class="col-md-5 ">
                        <select class="form-select form-select-sm" name="details[limit_faucet_amount_per]">
                            <option value="" >None</option>
                            <option value="hours"  <? echo $details['limit_faucet_amount_per'] == "hours" ? " selected" : "" ?>>Per Hour</option>
                            <option value="days" <? echo $details['limit_faucet_amount_per'] == "days" ? " selected" : "" ?>>Per Day</option>
                            <option value="weeks" <? echo $details['limit_faucet_amount_per'] == "weeks" ? " selected" : "" ?>>Per Week</option>
                            <option value="bi-weeks" <? echo $details['limit_faucet_amount_per'] == "bi-weeks" ? " selected" : "" ?>>Per Bi-Week</option>
                            <option value="months" <? echo $details['limit_faucet_amount_per'] == "months" ? " selected" : "" ?>>Per Month</option>
                             <option value="years" <? echo $details['limit_faucet_amount_per'] == "years" ? " selected" : "" ?>>Per Year</option>
                        </select>
                        <label class="form-check-label fs-9" for="limit_faucet_amount_per">Limit Total Faucet Amount to be Claimed Per Hour, Day, Week, Bi-Weeks, Months, Year</label>
                    </div>
                         <div class="separator separator-dashed my-2"></div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="fs-9">Status:</label>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <select class="form-select form-select-sm" required="" name="status">
                        <option value="1" <? echo $b['status'] == "1" ? " selected" : "" ?>>Active</option>
                        <option value="0" <? echo $b['status'] == "0" ? " selected" : "" ?>>In-Active</option>
                        <option value="2" <? echo $b['status'] == "2" ? " selected" : "" ?>>Closed</option>
    
                    </select>
                    <small id="Help" class="form-text text-muted fs-9">Please select the Task/Bounty status Active - InActive - Closed </small>
                    </div>
                    </div> 
            </div>
        </div>
    </div>
</form>

<?
}
if ($_GET['page'] == 'games')
{
     if (isset($_POST['submit']) && isset($_POST['action']) && $_POST['action'] == "update")
        {
            $details = mysqli_real_escape_string($DB_CONN, json_encode($_POST['details']));
            $update = mysqli_query($DB_CONN, "UPDATE games SET name = '{$_POST['name']}', instructions = '{$_POST['content']}' , details = '{$details}', image_url = '{$_POST['image_url']}',status = '{$_POST['status']}',amount_min = '{$_POST['amount_min']}',amount_max = '{$_POST['amount_max']}',win_amount = '{$_POST['win_amount']}',win_percentage= '{$_POST['win_percentage']}',principal_return = '{$_POST['principal_return']}',winning_chance = '{$_POST['winning_chance']}' WHERE id='{$_POST['id']}'") or die(mysqli_error($DB_CONN));
            if ($update){
                $ID = $_POST['id'];
               $alert = true;
            $alert_class = 'alert alert-success alert-dismissible alert-custom';
            $alert_message = 'Updated Successfully!';
            //header("Location: admin?page=plans&action=edit&id={$ID}");
            echo "<script>window.location.href='admin?page=games&action=edit&id={$ID}&alert_message=Added Successfully!&alert_class=alert alert-success alert-dismissible alert-custom'</script>";
            }
            else
            {
                $alert = true;
            $alert_class = 'alert alert-danger alert-dismissible alert-custom';
            $alert_message = 'Error';
            //header("Location: admin?page=plans&action=edit&id={$ID}");
            echo "<script>window.location.href='admin?page=games&action=edit&id={$ID}&alert_message=Error!&alert_class=alert alert-danger'</script>";
            }
        }    
    if (isset($_GET['action']) && $_GET['action'] == 'edit')
    {
        $b = mysqli_query($DB_CONN, "select * from games where id = {$_GET['id']}");
        $b = mysqli_fetch_assoc($b);
         $details = json_decode($b['details'], true);
        if (true)
        {
             if(isset($_GET['alert_message']) && $_GET['alert_message']) {
                    $alert = true;
                        $alert_class = $_GET['alert_class'];
                        $alert_message = $_GET['alert_message'];
                 
             }
             if ($alert)
                        {
                            echo '<div class="' . $alert_class . '">' . $alert_message . '</div>';
                        }
?>     
<form method="POST">               
    <div class="card mt-3 mb-5">
        <div class="card-header min-h-unset py-2" role="button">
  <? if($b['id']) { ?>
  <div class="card-title m-0">
                <h3 class="fw-bold m-0 fs-5">Edit <?php echo $b["game"] ?> Game</h3>
            </div>
  <? } else { ?>
 <div class="card-title m-0">
                <h3 class="fw-bold m-0 fs-5">Add Task / Bounty</h3>
            </div>
  <? } ?>
    </div>
  <div class="card-body">
       <div class="row">
           
                
               
                 <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9"> Game Name</label>
                    </div>
                </div>
                <div class="col-md-8">
                    <input type="text" name="name" value="<?php echo $b["name"] ?>" class="form-control form-control-sm" required="">
                    <small id="emailHelp" class="form-text text-muted fs-9">EnterTask/Bounty name - Will be shown to users while viewing and claiming.</small>
                </div>
                <div class="separator separator-dashed my-2"></div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9">Image Url for This Game (if any)</label>
                    </div>
                </div>
                <div class="col-md-8">
                    <input type="text" name="image_url" value="<?php echo $b["image_url"] ?>" class="form-control form-control-sm">
                    <small id="emailHelp" class="form-text text-muted fs-9">If you want to show any Image Banner for this Game.</small>
                </div>
                <div class="separator separator-dashed my-2"></div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9"> Enter Instructions of this Game</label>
                    </div>
                </div>
             <div class="col-md-8">
                 <textarea rows="5" name="content" class="form-control form-control-sm"><?php echo $b["instructions"] ?></textarea> 
                 <small id="Help" class="form-text text-muted fs-9">Add Instructions for your Game</small>
                 </div>
             
           <div class="separator separator-dashed my-2"></div>
           <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9"> Winning Chance (%)</label>
                    </div>
                </div>
                <div class="col-md-8">
                    <input type="text" name="winning_chance" value="<?php echo $b["winning_chance"] ?>" class="form-control form-control-sm" required="">
                    <small id="emailHelp" class="form-text text-muted fs-9">EnterTask/Bounty name - Will be shown to users while viewing and claiming.</small>
                </div>
            <div class="separator separator-dashed my-2"></div>
           <div class="col-md-3">
                    <div class="form-group">
                        <label class="fs-9"> Amount Minimum(<?=$preferences['symbol'] ?>):</label>
                    </div>
                </div>
                 <div class="col-md-3">
                    <input type="text" name="amount_min" value="<?php echo $b["amount_min"] ?>" class="form-control form-control-sm">
                    <small id="emailHelp" class="form-text text-muted fs-9">Minimum Amount for Bounty/Task.</small>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="fs-9"> Amount Maximum(<?=$preferences['symbol'] ?>):</label>
                    </div>
                </div>
                 <div class="col-md-3">
                    <input type="text" name="amount_max" value="<?php echo $b["amount_max"] ?>" class="form-control form-control-sm">
                    <small id="emailHelp" class="form-text text-muted fs-9">Maximum Amount for Bounty/Task.</small>
                </div>
                 <div class="separator separator-dashed my-2"></div>
             <div class="col-md-3">
                    <div class="form-group">
                        <label class="fs-9"> Win Amount(<?=$preferences['symbol'] ?>):</label>
                    </div>
                </div>
                 <div class="col-md-3">
                    <input type="text" name="win_amount" value="<?php echo $b["win_amount"] ?>" class="form-control form-control-sm">
                    <small id="emailHelp" class="form-text text-muted fs-9">Minimum Amount for Bounty/Task.</small>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="fs-9"> Win percentage(%):</label>
                    </div>
                </div>
                 <div class="col-md-3">
                    <input type="text" name="win_percentage" value="<?php echo $b["win_percentage"] ?>" class="form-control form-control-sm">
                    <small id="emailHelp" class="form-text text-muted fs-9">Maximum Amount for Bounty/Task.</small>
                </div>
                 <div class="separator separator-dashed my-2"></div>
                 <table>
                     <thead>
                     <tr>
                         <td>Min</td>
                         <td>Max</td>
                         <td>Chance</td>
                     </tr>
                      <?php for ($i = 0;$i <=10 ;$i++)
        { ?>
            
             <tr>
               
                <td ><input type="text" name="details[game][<?=$i?>][min]" value="<?php echo $details['game'][$i]['min']; ?>" class="form-control form-control-sm" /></td>
                 <td ><input type="text" name="details[game][<?=$i?>][max]" value="<?php echo $details['game'][$i]['max']; ?>" class="form-control form-control-sm" /></td>
                  <td ><input type="text" name="details[game][<?=$i?>][chance]" value="<?php echo $details['game'][$i]['chance']; ?>" class="form-control form-control-sm" /></td>
                  
      
            </tr>
            <? } ?>
                     <tbody>
                          <tr>
                         <td>Min</td>
                         <td>Max</td>
                         <td>Chance</td>
                     </tr>
                     </tbody>
                 </table>
        <div class="row" id="">
                
     
            
            <div class="col-md-4">
                <label class="fs-9"> Type </label>
            </div>
            <div class="col-md-8">
                  <select class="form-select form-select-sm" name="details[type]">
                             <option value="0" <?=$details['type'] == '0' ? 'selected' : '' ?>>Account Balance</option>
                            <option value="1" <?=$details['type'] == '1' ? 'selected' : '' ?>> Faucet Balance </option>
                           
                        </select>
             <small id="emailHelp" class="form-text text-muted fs-9">Can choose Account Balance or Faucet Balance.</small>
            </div>
            <div class="separator separator-dashed my-2"></div>
        <div class="col-md-4">
                            <div class="form-group">
                                <label class="fs-9">  Currency: </label>
                            </div>
                        </div>
                       <div class="col-md-8">
                            <select class="form-select form-select-sm form-select-solid" name="details[curreny]" id="faucet_currency">
                                <?php $select_method = mysqli_query($DB_CONN, "SELECT * from currencies where de_pm_id != 0");
                while ($row_method = mysqli_fetch_assoc($select_method))
                { ?>
                                    <option value="<?php echo $row_method['id'] ?>" <? echo $details['curreny'] == $row_method['id'] ? " selected" : "" ?>> <?php echo $row_method['name'] ?> </option>
                            <?php
                } ?>
                                        
                                    </select>
                            <small id="emailHelp" class="form-text text-muted fs-9">Will be given via this currency only.</small>
                            </div>
                   <div class="separator separator-dashed my-2"></div>
        <div class="col-md-4">
              <label class="fs-9"> Game Particpate Memo</label>
                </div>
        
        <div class="col-md-8">
                    <input type="text" name="details[memo]" class="form-control form-control-sm" value="<?=$details['memo'] ? : "#faucet_amount# for completing Task/Bounty" ;  ?>">
                    <label class="form-check-label fs-9" for="memo">Available Short Code #faucet_amount# </label>
                     <small class="fs-9"> Enter Reward Balance you want to Give user after review.</small>
                </div>
             </div>
            
               
              
               
               
                 <div class="separator separator-dashed my-2"></div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="fs-9">Status:</label>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <select class="form-select form-select-sm" required="" name="status">
                        <option value="1" <? echo $b['status'] == "1" ? " selected" : "" ?>>Active</option>
                        <option value="0" <? echo $b['status'] == "0" ? " selected" : "" ?>>In-Active</option>
                        <option value="2" <? echo $b['status'] == "2" ? " selected" : "" ?>>Closed</option>
    
                    </select>
                    <small id="Help" class="form-text text-muted fs-9">Please select the Task/Bounty status Active - InActive - Closed </small>
                    </div>
       </div>
 
  
  </div>
       <div class="card-footer d-flex justify-content-end py-2 px-9"> 
        <? if($b['id']) { ?>  <input class="btn btn-primary btn-sm me-2" type="submit" name="submit" value="Edit Game ">
          <input type="hidden" name="id" value="<?php echo $b['id'] ?>"> 
           <input type="hidden" name="action" value="update">  <? } else { ?>
             <input class="btn btn-primary btn-sm me-2" type="submit" name="submit" value="Edit Game "> 
              <input type="hidden" name="action" value="add">  <? } ?>
          </div>   
           </div>
       </form>
       
       <script>
            $("#faucetdiv").<? echo $details['faucet'] == 'true' ? "show" : "hide" ?>();
$("#faucet").click(function() {
    if($(this).is(":checked")) {
        $("#faucetdiv").show();
        $("#faucet_currency").attr('required', true);
    } else {
        $("#faucet_currency").attr('required', false);
        $("#faucetdiv").hide();
    }
});
       </script>
        <?php
        }
     }else{
    ?>                   
       <div class="card mb-2">
                                        <div class="card-header min-h-unset py-2">
                                            <h3 class="card-title align-items-start flex-column m-0">
                                                 <span class="card-label fw-bold text-gray-900">Games</span>
                                               <span class="text-gray-500 mt-1 fw-semibold fs-6">Configure settings for your games.</span>
                                            </h3>
                                           
                                        </div>
                                <div class="card-body">
            <table  class="table table-striped table-bordered display dataTable table-hover table-sm" id="default_order">
              <thead>
                <tr>
               
                  <th class="min-w-275px">Name</th>
                  <th>Min Amount</th>
                   <th>Max Amount</th>
                  <th>Winning Chance</th>
                  <th class="min-w-125px ps-5 ">Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
              <?php
              $q = mysqli_query($DB_CONN, "select * from games");
    while ($query = mysqli_fetch_assoc($q))
    {
?>
                  <tr>
          
                  <td ><?php echo $query['name'] ?></td>  
                  <td ><?php echo $query['amount_min'] ?></td>    
                  <td><?php echo $query['amount_max'] ?></td>
                  <td><?php echo $query['winning_chance'] ?></td>
                  <td><?php echo $query['status'] ? '<span class="badge badge-success">Active</span>' : '<span class="badge badge-danger">InActive</span>'; ?></td>  
                  <td>
                    <div class="d-flex justify-content-end flex-shrink-0">
                
                        <a  href="?page=games&action=edit&id=<?php echo $query['id'] ?>" class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm me-1">
                            <i class="ki-duotone ki-pencil fs-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                        </a>
                     
                </div>
            </td>
                </tr>
                  <?php
    }
?>
              </tbody>
              <tfoot>
      <tr>
               
                  <th class="min-w-275px">Name</th>
                  <th>Min Amount</th>
                   <th>Max Amount</th>
                  <th>Winning Chance</th>
                  <th class="min-w-125px ps-5 ">Status</th>
                  <th>Actions</th>
                </tr>
        </tfoot>
            </table>
            


                                    </div>         
                                         </div>
                                            <!--end::Form-->
                                        </div>
                                    
     <? }?>


<?
}
if ($_GET['page'] == 'plans')
{
    $diff_in_seconds = array(
        'hourly' => 3600,
        'daily' => 86400,
        'weekly' => 86400 * 7,
        'bi-weekly' => 86400 * 14,
        'monthly' => 86400 * 30,
        '2monthly' => 86400 * 60,
        '3monthly' => 86400 * 90,
        '6monthly' => 86400 * 180,
        'yearly' => 86400 * 365
    );
    if ($_POST['frequency'] == "hours")
    {
        $sec_value = 3600 * $_POST['earning_duration'];
        $_POST['earning_duration'] = 1;
    }
    elseif ($_POST['frequency'] == "days")
    {
        $sec_value = 86400 * $_POST['earning_duration'];
        $_POST['earning_duration'] = 1;
    }
    elseif ($_POST['frequency'] == "weeks")
    {
        $sec_value = 86400 * 7 * $_POST['earning_duration'];
        $_POST['earning_duration'] = 1;
    }
    elseif ($_POST['frequency'] == "bi-weeks")
    {
        $sec_value = 86400 * 14 * $_POST['earning_duration'];
        $_POST['earning_duration'] = 1;
    }
    elseif ($_POST['frequency'] == "months")
    {
        $sec_value = 86400 * 30 * $_POST['earning_duration'];
        $_POST['earning_duration'] = 1;
    }
    else
    {
        $sec_value = $diff_in_seconds[$_POST['frequency']];
    }
    if($_POST['etype'] == '0') {
        $_POST['percent_min'] = $_POST['percent_max'];
    }
    $ID = "";

    if (isset($_POST['submit']) && isset($_POST['action']) && $_POST['action'] == "update")
    {
        $planECORD = mysqli_query($DB_CONN, "SELECT id from packages where id='{$_POST['package_id']}'");
        if (mysqli_num_rows($planECORD) > 0)
        {
            $earning_days = mysqli_real_escape_string($DB_CONN, json_encode($_POST['earning_days']));
            $details = mysqli_real_escape_string($DB_CONN, json_encode($_POST['details']));
            $_POST['actual_percent_min'] = $_POST['percent_min'];
            $_POST['actual_percent_max'] = $_POST['percent_max'];
            $_POST['earning_duration'] = $_POST['earning_duration'] ? $_POST['earning_duration'] : 100000;
            $_POST['description'] = ($_POST['description']);
            $_POST['name'] = ($_POST['name']);
            $Update = mysqli_query($DB_CONN, "UPDATE  packages set  `name`='{$_POST['name']}', `frequency`='{$_POST['frequency']}', `earnings_mon_fri`='{$_POST['earnings_mon_fri']}', `principal_return`='{$_POST['principal_return']}',`principal_hold`='{$_POST['principal_hold']}', `parent_plan`='{$_POST['parent_plan']}', `parent_plan_type`='{$_POST['parent_plan_type']}',duration='{$_POST['earning_duration']}',allowprincipal='{$_POST['allowprincipal']}',limit_currency='{$_POST['limit_currency']}',etype='{$_POST['etype']}' ,diff_in_seconds='{$sec_value}', status = '{$_POST['status']}', earning_days = '{$earning_days}', referral = '{$_POST['referral']}', referral_compound = '{$_POST['referral_compound']}', earning_limit = '{$_POST['earning_limit']}', `description`='{$_POST['description']}', details = '{$details}' where id='{$_POST['package_id']}'") or die(mysqli_error($DB_CONN));
            if ($Update)
            {
                $ID = $_POST['package_id'];
                mysqli_query($DB_CONN, "delete from package_plans where package_id='{$_POST['package_id']}'") or die(mysqli_error($DB_CONN));
            
                foreach ($_POST['pname'] as $key => $value)
                {
                    //!empty($value) && $value !=''
                    if (true && !empty($value))
                    {
                        mysqli_query($DB_CONN, "INSERT INTO `package_plans`(`id`, `package_id`, `name`, `range_min`, `range_max`, `percent_min`, `percent_max`, `actual_min`, `actual_max`) VALUES ('{$_POST['plan_id'][$key]}', '{$_POST['package_id']}','{$value}','{$_POST['range_min'][$key]}','{$_POST['range_max'][$key]}','{$_POST['percent_min'][$key]}','{$_POST['percent_max'][$key]}','{$_POST['actual_percent_min'][$key]}','{$_POST['actual_percent_max'][$key]}')") or die(mysqli_error($DB_CONN));
                    }

                }
                $alert = true;
                $alert_class = 'alert alert-success alert-dismissible alert-custom';
                $alert_message = 'Updated Successfully!';
                updateSiteData($siteURL);
            }
            else
            {
                $alert = true;
                $alert_class = 'alert alert-danger alert-dismissible alert-custom';
                $alert_message = 'Deleted Successfully!';
            }
        }
    }

    if (isset($_POST['submit']) && isset($_POST['action']) && $_POST['action'] == "add")
    {
        $earning_days = mysqli_real_escape_string($DB_CONN, json_encode($_POST['earning_days']));
        $_POST['actual_percent_min'] = $_POST['percent_min'];
        $_POST['actual_percent_max'] = $_POST['percent_max'];
        $_POST['earning_duration'] = $_POST['earning_duration'] ? $_POST['earning_duration'] : 100000;
        $_POST['description'] = ($_POST['description']);
        $_POST['name'] = ($_POST['name']);
        $details = mysqli_real_escape_string($DB_CONN, json_encode($_POST['details']));
        $insert = mysqli_query($DB_CONN, "INSERT INTO `packages`(name, description, frequency, principal_return,duration,diff_in_seconds,allowprincipal,etype,earnings_mon_fri, status, principal_hold, earning_days, referral, referral_compound,earning_limit,parent_plan,parent_plan_type,details,limit_currency)
        VALUES ('{$_POST['name']}','{$_POST['description']}','{$_POST['frequency']}','{$_POST['principal_return']}','{$_POST['earning_duration']}','{$sec_value}','{$_POST['allowprincipal']}','{$_POST['etype']}','{$_POST['earnings_mon_fri']}','{$_POST['status']}','{$_POST['principal_hold']}','{$earning_days}','{$_POST['referral']}','{$_POST['referral_compound']}','{$_POST['earning_limit']}','{$_POST['parent_plan']}','{$_POST['parent_plan_type']}','{$details}','{$_POST['limit_currency']}')") or die(mysqli_error($DB_CONN));
        if ($insert)
        {
            $ID = mysqli_insert_id($DB_CONN);
            foreach ($_POST['pname'] as $key => $value)
            {
                //!empty($value) && $value !=''
                if (true && !empty($value))
                {
                    mysqli_query($DB_CONN, "INSERT INTO `package_plans`( `package_id`, `name`, `range_min`, `range_max`, `percent_min`, `percent_max`, `actual_min`, `actual_max`) VALUES ('{$ID}','{$value}','{$_POST['range_min'][$key]}','{$_POST['range_max'][$key]}','{$_POST['percent_min'][$key]}','{$_POST['percent_max'][$key]}','{$_POST['actual_percent_min'][$key]}','{$_POST['actual_percent_max'][$key]}')") or die(mysqli_error($DB_CONN));
                }
            }
            $alert = true;
            $alert_class = 'alert alert-success alert-dismissible alert-custom';
            $alert_message = 'Added Successfully!';
            //header("Location: admin?page=plans&action=edit&id={$ID}");
            echo "<script>window.location.href='admin?page=plans&action=edit&id={$ID}&alert_message=Added Successfully!&alert_class=alert alert-success alert-dismissible alert-custom'</script>";
            updateSiteData($siteURL);
        }
        else
        {
            $alert = true;
            $alert_class = 'alert alert-danger alert-dismissible alert-custom';
            $alert_message = 'Error! Please try again.';
        }
    }
    if (isset($_GET['action']) && $_GET['action'] == 'edit')
    {
        $plan = mysqli_query($DB_CONN, "select * from packages where id = {$_GET['id']}");
        $plan = mysqli_fetch_assoc($plan);
        $details = json_decode($plan['details'], true);
        if (true)
        {

?>
  
 <?php if(isset($_GET['alert_message']) && $_GET['alert_message']) {
        $alert = true;
            $alert_class = $_GET['alert_class'];
            $alert_message = $_GET['alert_message'];
     
 }
 if ($alert)
            {
                echo '<div class="' . $alert_class . '">' . $alert_message . '</div>';
            }
?>                                          
<form method="POST">
    <div class="card">
        <div class="card-header min-h-unset py-2" role="button">
            <? if($plan['id']) { ?>
  <div class="card-title m-0">
                <h3 class="fw-bold m-0 fs-5">Edit Investment Package</h3>
            </div>
  <? } else { ?>
 <div class="card-title m-0">
                <h3 class="fw-bold m-0 fs-5">Add Investment Package</h3>
            </div>
  <? } ?>
          
            
        </div>

        <div class="card-body py-3">
            <div class="row">
                   
                 <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9"> Select Plan Type</label>
                    </div>
                </div>
                <div class="col-md-8">
                    <select class="form-select form-select-sm" name="etype" id="etype">
                        <option value="0" <? echo $plan['etype'] == "0" ? " selected" : "" ?>>Fixed Earnings</option>
                        <option value="1" <? echo $plan['etype'] == "1" ? " selected" : "" ?>>Variable/Floating Earnings (Random for each User)</option>
                        <option value="2" <? echo $plan['etype'] == "2" ? " selected" : "" ?>>Variable/Floating Earnings (Same for all Users)</option>
                        <option value="3" <? echo $plan['etype'] == "3" ? " selected" : "" ?>>Manual </option>
                        <option value="4" <? echo $plan['etype'] == "4" ? " selected" : "" ?>>Facuet</option>
                    </select>
                    <small class="form-text text-muted fs-9">Fixed - Will give Flat % Rate earning | Variable - will give earnings in Percentage Range | Manual - earnings will given via <a  href="admin?page=earnings">Earning Page.</a></small>
                </div>
                    <div class="separator separator-dashed my-2"></div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="fs-9"> Package Name</label>
                    </div>
                </div>
                <div class="col-md-8">
                    <input type="text" name="name" value="<?php echo $plan['name'] ?>" class="form-control form-control-sm" required/>
                    <small id="emailHelp" class="form-text text-muted fs-9">Enter Investment Package name - Will be shown to users while making investment / Claiming Faucet / Participating Lottery.</small>
                </div>
                <div class="col-md-4 rest">
                    <div class="form-group">
                        <label class="fs-9"> Package Period</label>
                    </div>
                </div>
                <div class="col-md-8 rest">
                    <select class="form-select form-select-sm" name="frequency">
                        <option value="hourly"<? echo $plan['frequency'] == "hourly" ? " selected" : "" ?>>Hourly</option>
                    <option value="daily"<? echo $plan['frequency'] == "daily" ? " selected" : "" ?>>Daily</option>
                    <option value="weekly"<? echo $plan['frequency'] == "weekly" ? " selected" : "" ?>>Weekly</option>
                    <option value="bi-weekly"<? echo $plan['frequency'] == "bi-weekly" ? " selected" : "" ?>>Bi-Weekly</option>
                    <option value="monthly"<? echo $plan['frequency'] == "monthly" ? " selected" : "" ?>>Monthly</option>
                    <option value="2monthly"<? echo $plan['frequency'] == "2monthly" ? " selected" : "" ?>>Every 2 Months</option>
                    <option value="3monthly"<? echo $plan['frequency'] == "3monthly" ? " selected" : "" ?>>Every 3 Months</option>
                    <option value="6monthly"<? echo $plan['frequency'] == "6monthly" ? " selected" : "" ?>>Every 6 Months</option>
                    <option value="yearly"<? echo $plan['frequency'] == "yearly" ? " selected" : "" ?>>Yearly</option>
                    <option value="days"<? echo $plan['frequency'] == "days" ? " selected" : "" ?>>After Specified Days</option>
                    <option value="hours"<? echo $plan['frequency'] == "hours" ? " selected" : "" ?>>After Specified Hours</option>
                    <option value="weeks" <? echo $plan['frequency'] == "weeks" ? " selected" : "" ?>>After Specified Weeks</option>
                    <option value="bi-weeks" <? echo $plan['frequency'] == "bi-weeks" ? " selected" : "" ?>>After Specified Bi-Weeks</option>
                    <option value="months" <? echo $plan['frequency'] == "months" ? " selected" : "" ?>>After Specified Months</option>
                                            </select>
                    </select>
                    <small class="form-text text-muted fs-9">Select the Frequency / Period for Plan (Hourly, Daily, Weekly, Bi-Weekly, Monthly, Every 2 Months, Every 3 Months, Every 6 Months, Yearly)</small>
                </div>
                <div class="separator separator-dashed my-2"></div>
                <div class="col-md-4 rest">
                    <div class="form-group">
                        <label class="fs-9"> Package Duration</label>
                    </div>
                </div>
                <div class="col-md-4 rest" id="duration">
                    <input type="text" name="earning_duration" value="<?php
            if ($plan['frequency'] == "hours")
            {
                $plan['duration'] = $plan['diff_in_seconds'] / 3600;
            }
            elseif ($plan['frequency'] == "days")
            {
                $plan['duration'] = $plan['diff_in_seconds'] / 86400;
            }
            elseif ($plan['frequency'] == "weeks")
            {
                $plan['duration'] = $plan['diff_in_seconds'] / 86400 * 7;
            }
            elseif ($plan['frequency'] == "bi-weeks")
            {
                $plan['duration'] = $plan['diff_in_seconds'] / 86400 * 14;
            }
            elseif ($plan['frequency'] == "months")
            {
                $plan['duration'] = $plan['diff_in_seconds'] / 86400 * 30;
            }
            else
            {
                $plan['duration'] = $plan['duration'];
            }
            echo $plan['duration'] ?>" class="form-control form-control-sm" />
                    <small id="emailHelp" class="form-text text-muted fs-9">Number of Period  (leave empty for unlimited)</small>
                </div>
               <div class="col-md-4 rest">
                    <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="lifetime" id="lifetime" value="1" <? echo $plan['duration'] == "100000" ? " checked" : "" ?>>
                    <label class="form-check-label fs-9" for="lifetime">Without any time limit (<b class="fs-7">Lifetime</b>)</label>
                </div>
                  
                </div>
         
                <div class="separator separator-dashed my-2 rest"></div>
                <div class="table-responsive rest">
                    <table  class="table editable-table table-bordered table-striped m-b-0 table-sm" id="mainTable">
                        <thead class="">
                            <tr>
                                <th></th>
                                <th>Plans</th>
                                <th colspan="2" class="text-center" >Amount Range</th>
                                <th colspan="2" class="text-center" id="range">Percent Range <small class="fs-9"></small></th>
                                <th colspan="2" class="text-center" id="percent">Percent  <small class="fs-9">(%)</small></th>
                            </tr>
                        </thead>
                        <tbody>

<?php
            $j = 1;
            $plansd = mysqli_query($DB_CONN, "SELECT * from package_plans where package_id='{$plan['id']}' order by id asc");
            if(mysqli_num_rows($plansd)) {
            while ($plans = mysqli_fetch_assoc($plansd))
            { ?> 
                            <tr>
                                <td><a  onclick="fieldRemove(this);" class="btn btn-sm btn-primary add_another">-</a> <? if($plan['id']) { ?> <input type="hidden" name="plan_id[]" value="<?php echo $plans['id'] ?>"> <? } ?></td>
                                <td>
                                    <input type="text" name="pname[]" value="<?php echo $plans['name'] ?>" class="form-control form-control-sm rate_name" />
                                </td>

                                <td >
                                    <input type="text" name="range_min[]" placeholder="Min Amount" value="<?php echo $plans['range_min'] ?>" class="form-control form-control-sm" />
                                </td>
                                <td>
                                    <input type="text" name="range_max[]" placeholder="Max Amount" value="<?php echo $plans['range_max'] ?>" class="form-control rangefield form-control-sm" />
                                </td>

                                <td class="min">
                                    <input type="text" name="percent_min[]" placeholder="Min Percent" value="<?php echo $plans['percent_min'] ?>" class="form-control  form-control-sm" />
                                </td>
                                <td class="max">
                                    <input type="text" name="percent_max[]" placeholder="Max Percent" value="<?php echo $plans['percent_max'] ?>" class="form-control maxfield form-control-sm" />
                                </td>
                                <!-- <td class="perce">
                                    <input type="text" name="percent_max[]" placeholder="Percent"  value="<?php echo $plans['percent_max'] ?>" class="form-control  form-control-sm" />
                                </td> -->
                            </tr>
                            
                        <?
            }} else {
                ?>
                <tr>
                    <td><a  onclick="fieldRemove(this);" class="btn btn-sm btn-primary add_another">-</a> <input type="hidden" name="plan_id[]" value="<?php echo $plans['id'] ?>"></td>
                    <td>
                        <input type="text" name="pname[]" value="Plan 1" class="form-control form-control-sm rate_name" />
                    </td>

                     <td >
                        <input type="text" name="range_min[]" placeholder="Min Amount" value="<?php echo $plans['range_min'] ?>" class="form-control form-control-sm" />
                    </td>
                    <td>
                        <input type="text" name="range_max[]" placeholder="Max Amount" value="<?php echo $plans['range_max'] ?>" class="form-control rangefield form-control-sm" />
                    </td>

                    <td class="min">
                        <input type="text" name="percent_min[]" placeholder=" Min Percent" value="<?php echo $plans['percent_min'] ?>" class="form-control  form-control-sm" />
                    </td>
                    <td class="max">
                        <input type="text" name="percent_max[]" placeholder=" Max Percent" value="<?php echo $plans['percent_max'] ?>" class="form-control maxfield form-control-sm" />
                    </td>
                    <!-- <td class="perce">
                                    <input type="text" name="percent_max[]" placeholder="Percent"  value="<?php echo $plans['percent_max'] ?>" class="form-control form-control-sm" />
                                </td> -->
                </tr>
                <?
            } ?>
                            <tr class="text-center" id="rfield_last" >
                                <th colspan=6><input type=button value="+"  onclick="fieldAdd()" class="btn-sm btn-primary btn"></th>
                            </tr>
                           
                            <tr id="rfield_tpl" style="display:none">
                                <td><a  onclick="fieldRemove(this)" class="btn btn-sm btn-primary add_another">-</a></td>
                                <td>
                                    <input type="text" name="pname[]" class="form-control form-control-sm rate_name" />
                                </td>

                                 <td >
                                    <input type="text" name="range_min[]" placeholder="Min Amount" class="form-control form-control-sm" />
                                </td>
                                <td>
                                    <input type="text" name="range_max[]" placeholder="Max Amount" class="form-control rangefield form-control-sm" />
                                </td>

                                <td class="min">
                                    <input type="text" name="percent_min[]" placeholder=" Min Percent" class="form-control  form-control-sm" />
                                </td>
                                <td class="max">
                                    <input type="text" name="percent_max[]" placeholder=" Max Percent" class="form-control maxfield form-control-sm" />
                                </td>
                                <!-- <td class="perce">
                                    <input type="text" name="percent_max[]" placeholder="Percent"  class="form-control  form-control-sm" />
                                </td> -->
                            </tr>
                          
                            

                      
                        </tbody>
                                       
                    </table>
                </div>
                
                <script>
function fieldAdd() {
    var hr = document.getElementById("mainTable");
    var rn = hr.getElementsByClassName("rate_name");
    var tpl1 = document.getElementById("rfield_tpl");
    var tpl = tpl1.cloneNode(true);
    
    // Clear all input fields within the cloned row
    var inputs = tpl.getElementsByTagName("input");
    for (var i = 0; i < inputs.length; i++) {
        if (inputs[i].type === 'text') {
            inputs[i].value = "";
        }
    }
    
    tpl.getElementsByClassName("rate_name")[0].value = "Plan " + rn.length;
    var lst = document.getElementById("rfield_last");
    var prt = lst.parentNode;
    tpl.style.display = "table-row";
    tpl.removeAttribute("style"); // Ensure the cloned row is visible
    tpl.id = "";
    prt.insertBefore(tpl, lst);
}
function fieldRemove(o) {
    var tr = o.parentNode.parentNode;
    var bd = tr.parentNode;
    bd.removeChild(tr);
}

                </script>

            </div>
            <div class="separator separator-dashed my-2 rest"></div>
                <div class="row">
                 
                    
                    <div class="col-md-12 faucet_auto ">
                       <div class="table-responsive">
                    <table  class="table editable-table table-bordered table-striped m-b-0 table-sm" id="mainTable">
                        <thead class="">
                            <tr>
                                
                                <th>Details</th>
                                <th class="text-center" >Faucet Amount</th>
                                <th class="text-center" >Faucet Earning Type</th>
                                
                         <th class="text-center" >Faucet</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                  <b>Base Faucet Amount</b> (For Active / Non Active Users)
                                </td>
                                 <td>
                                   <input type="text" name="details[faucet][0][amount]" placeholder="Amount" value="<?php echo $details['faucet']['0']['amount'] ?>" class="form-control form-control-sm">
                               </td>
                               
                                <td>
                                    <select class="form-select form-select-sm" name="details[faucet][0][type]">
                            <option value="0"  <? echo $details['faucet']['0']['type'] == "0" ? " selected" : "" ?>>Real Balance Faucet (Can be Invest / Withdraw)</option>
                            <option value="1" <? echo $details['faucet']['0']['type'] == "1" ? " selected" : "" ?>> Faucet Balance (Can be used to Invest only)</option>
                           
                        </select>
                               </td>
                            </tr>
                          
                     
                            <?php $a = mysqli_query($DB_CONN, "SELECT * FROM `packages` where etype !='4' ");
          while ($pl = mysqli_fetch_assoc($a))
          
          { $fid = $pl['id']; ?> 
          <tr>
              <td>Facuet Amount for Users Invested in <?php echo $pl['name'] ?></td>
               <td><input type="text" name="details[faucet][<?php echo $pl['id'] ?>][amount]" placeholder="Amount" value="<?php echo $details['faucet'][$fid]['amount'] ?>" class="form-control form-control-sm"> </td>
                 <td>
                                    <select class="form-select form-select-sm" name="details[faucet][<?php echo $pl['id'] ?>][type]">
                            <option value="0"  <? echo $details['faucet'][$fid]['type'] == "0" ? " selected" : "" ?>>Real Balance Faucet (Can be Invest / Withdraw)</option>
                            <option value="1" <? echo $details['faucet'][$fid]['type'] == "1" ? " selected" : "" ?>> Faucet Balance (Can be used to Invest only)</option>
                           
                        </select>
                               </td>
                                <td>
                                    <select class="form-select form-select-sm" name="details[faucet][<?php echo $pl['id'] ?>][do]">
                            <option value="0"  <? echo $details['faucet'][$fid]['do'] == "0" ? " selected" : "" ?>>Override Base Amount</option>
                            <option value="1" <? echo $details['faucet'][$fid]['do'] == "1" ? " selected" : "" ?>> Add in Base Amount</option>
                           
                        </select>
                               </td>
          </tr>
           <?php
          } ?>
        
                        </tbody>
                        </table>
                         </div>
                         
                    </div>
         
                  <div class="row faucet">
                          <div class="col-md-3 ">
                        <div class="form-group">
                            <label class="fs-9">Limit Total Faucet Amount :</label>
                        </div>
                    </div>
                    <div class="col-md-4 ">
                        <input type="text" name="details[limit_faucet_amount]" value="<? echo $details['limit_faucet_amount'] ?>" class="form-control form-control-sm" />
                        <label class="form-check-label fs-9" for="limit_faucet_amount">Total Faucet Amount to be Claimed by all users (leave empty to skip)</label>
                    </div>
                     <div class="col-md-5 ">
                        <select class="form-select form-select-sm" name="details[limit_faucet_amount_per]">
                            <option value="" >None</option>
                            <option value="hours"  <? echo $details['limit_faucet_amount_per'] == "hours" ? " selected" : "" ?>>Per Hour</option>
                            <option value="days" <? echo $details['limit_faucet_amount_per'] == "days" ? " selected" : "" ?>>Per Day</option>
                            <option value="weeks" <? echo $details['limit_faucet_amount_per'] == "weeks" ? " selected" : "" ?>>Per Week</option>
                            <option value="bi-weeks" <? echo $details['limit_faucet_amount_per'] == "bi-weeks" ? " selected" : "" ?>>Per Bi-Week</option>
                            <option value="months" <? echo $details['limit_faucet_amount_per'] == "months" ? " selected" : "" ?>>Per Month</option>
                             <option value="years" <? echo $details['limit_faucet_amount_per'] == "years" ? " selected" : "" ?>>Per Year</option>
                        </select>
                        <label class="form-check-label fs-9" for="limit_faucet_amount_per">Limit Total Faucet Amount to be Claimed Per Hour, Day, Week, Bi-Weeks, Months, Year</label>
                    </div>
                     
                    </div> 
                    
                       <div class="col-md-12 rest">
                        <div class="d-flex flex-stack">
                            <div class="d-flex">
                                <div class="d-flex flex-column">
                                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Increase Profit Percentage on each accural</a>
                                    <div class="fs-9 fw-semibold text-gray-500">Toggle to enable and disable</div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-end">
                                <div class="form-check form-check-solid form-check-custom form-switch">
                                    <input class="form-check-input w-45px h-30px" type="checkbox" name="details[increase]" id="increase" value="true" <? echo $details['increase'] == 'true' ? "checked" : "" ?>/>
                                    <label class="form-check-label fs-9" for="increase"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="increasediv">
                         <div class="separator separator-dashed my-2"></div>
                        <div class="row">
                         <div class="col-md-4">
                            <div class="form-group">
                            <label class="fs-9">Enter the percentage you want to increase on each accural:</label>
                        </div>
                        </div>
                        <div class="col-md-8">
                            <input type="text" name="details[increase_percentage]" value="<? echo $details['increase_percentage'] ?>" class="form-control form-control-sm" />
                            <small id="emailHelp" class="form-text text-muted fs-9">(must enter value of percentage )</small>
                        </div>
                        
                        <div class="separator separator-dashed my-2"></div>
                          
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="fs-9">Earning Limit Total Percentage(%) to close the plan:</label>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <input type="text" name="earning_limit" value="<? echo $plan['earning_limit'] ?>" class="form-control form-control-sm" />
                        <label class="form-check-label fs-9" for="earning_limit">Earning Limit % (per user) for ex 200% the package will be (leave empty to skip)</label>
                    </div>
                    </div>
                     </div>
                      <div class="separator separator-dashed my-2 rest"></div>
                    <div class="col-md-12 rest">
                        <div class="d-flex flex-stack">
                            <div class="d-flex">
                                <div class="d-flex flex-column">
                                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Return Principal on Completion</a>
                                    <div class="fs-9 fw-semibold text-gray-500">Toggle to enable and disable</div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-end">
                                <div class="form-check form-check-solid form-check-custom form-switch">
                                    <input class="form-check-input w-45px h-30px" type="checkbox" name="principal_return" id="principal_return" value="1" <? echo $plan['principal_return'] == 1 ? "checked" : "" ?>/>
                                    <label class="form-check-label fs-9" for="principal_return"></label>
                                </div>
                            </div>
                        </div>
                    </div>
    
                    <div id="return" class="row">
                        <div class="separator separator-dashed my-2"></div>
                       <div class="col-md-4">
                            
                            <div class="form-group">
                            <label class="fs-9">Enter the percentage you want to hold on principal return:</label>
                        </div>
                        </div>
                      
                        <div class="col-md-8">
                            <input type="text" name="principal_hold" value="<? echo $plan['principal_hold'] ?>" class="form-control form-control-sm" />
                            <small id="emailHelp" class="form-text text-muted fs-9">hold % of Amount on return of principal (leave empty to skip)</small>
                        </div>
                        
                        <div class="separator separator-dashed my-2"></div>
                        <div class="d-flex flex-stack">
                            <div class="d-flex">
                                <div class="d-flex flex-column">
                                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Users can Enable/Disable Auto Reinvest option.</a>
                                    <div class="fs-9 fw-semibold text-gray-500">If option to enable on invest page and disable on invested (invest_list.tpl) page.</div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-end">
                                <div class="form-check form-check-solid form-check-custom form-switch">
                                    <input class="form-check-input w-45px h-30px" type="checkbox" name="details[auto_reinvest]" id="auto_reinvest" value="1" <? echo $details['auto_reinvest'] == 1 ? "checked" : "" ?>/>
                                    <label class="form-check-label fs-9" for="auto_reinvest"></label>
                                </div>
                            </div>
                        </div>
                    </div>
    
                    <div class="separator separator-dashed my-2 rest"></div>
    
                    <div class="col-md-12 rest">
                        <div class="d-flex flex-stack">
                            <div class="d-flex">
                                <div class="d-flex flex-column">
                                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Allow Principal Release</a>
                                    <div class="fs-9 fw-semibold text-gray-500">Toggle to enable and disable</div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-end">
                                <div class="form-check form-check-solid form-check-custom form-switch">
                                    <input class="form-check-input w-45px h-30px" type="checkbox" name="allowprincipal" id="allowprincipal" value="1" <? echo $plan['allowprincipal'] == 1 ? 'checked' : '' ?> />
                                    <label class="form-check-label fs-9" for="allowprincipal"></label>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                    <div id="release" class="row">
                        <div class="separator separator-dashed my-2"></div>
                        <div class="col-md-12">
                        <div class="d-flex flex-stack">
                            <div class="d-flex">
                                <div class="d-flex flex-column">
                                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Principal Release Full amount only</a>
                                    <div class="fs-9 fw-semibold text-gray-500">Toggle to enable and disable</div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-end">
                                <div class="form-check form-check-solid form-check-custom form-switch">
                                    <input class="form-check-input w-45px h-30px" type="checkbox" name="details[allowprincipalfull]" id="allowprincipalfull" value="1" <? echo $details['allowprincipalfull'] ? 'checked' : '' ?> />
                                    <label class="form-check-label fs-9" for="allowprincipalfull"></label>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                    <div class="separator separator-dashed my-2"></div>
                        <div class="col-md-8">
                            <table  class="table table-sm">
                            <tbody>
                                <tr>
                                    <th>Investment Duration (days):</th>
                                    <td><input type="input" name="details[depositduration][]" value="<? echo $details['depositduration'][0] ?>" class="form-control form-control-sm" size="4" /></td>
                                    <td><input type="input" name="details[depositduration][]" value="<? echo $details['depositduration'][1] ?>" class="form-control form-control-sm" size="4" /></td>
                                    <td><input type="input" name="details[depositduration][]" value="<? echo $details['depositduration'][2] ?>" class="form-control form-control-sm" size="4" /></td>
                                    <td><input type="input" name="details[depositduration][]" value="<? echo $details['depositduration'][3] ?>" class="form-control form-control-sm" size="4" /></td>
                                </tr>
                                <tr>
                                    <th>Principal Release Fee (%):</th>
                                    <td><input type="input" name="details[withdrawalfee][]" value="<? echo $details['withdrawalfee'][0] ?>" class="form-control form-control-sm" size="4" /></td>
                                    <td><input type="input" name="details[withdrawalfee][]" value="<? echo $details['withdrawalfee'][1] ?>" class="form-control form-control-sm" size="4" /></td>
                                    <td><input type="input" name="details[withdrawalfee][]" value="<? echo $details['withdrawalfee'][2] ?>" class="form-control form-control-sm" size="4" /></td>
                                    <td><input type="input" name="details[withdrawalfee][]" value="<? echo $details['withdrawalfee'][3] ?>" class="form-control form-control-sm" size="4" /></td>
                                </tr>
                            </tbody>
                            </table>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="fs-9"> Principal Release Period</label>
                                <input type="text" name="details[principal_release_period]" value="<? echo $details['principal_release_period'] ?>" class="form-control form-control-sm" />
                                <label class="form-check-label fs-9" for="principal_return">days from deposit start (leave empty to skip limit)</label>
                            </div>
                        </div>
                               <div class="separator separator-dashed my-2"></div>
                        <div class="col-md-12">
                        <div class="d-flex flex-stack">
                            <div class="d-flex">
                                <div class="d-flex flex-column">
                                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Principal Release Direct to pending withdraw</a>
                                    <div class="fs-9 fw-semibold text-gray-500">Toggle to enable and disable principal release direct to pending withdraw</div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-end">
                                <div class="form-check form-check-solid form-check-custom form-switch">
                                    <input class="form-check-input w-45px h-30px" type="checkbox" name="details[release_to_pending]" id="release_to_pending" value="1" <? echo $details['release_to_pending'] ? 'checked' : '' ?> />
                                    <label class="form-check-label fs-9" for="release_to_pending"></label>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                    </div>
                    <div class="separator separator-dashed my-2 rest"></div>
                    <div class="col-md-12 rest">
                        <div class="d-flex flex-stack">
                            <div class="d-flex">
                                <div class="d-flex flex-column">
                                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Allow Compounding</a>
                                    <div class="fs-9 fw-semibold text-gray-500">Toggle to enable and disable</div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-end">
                                <div class="form-check form-check-solid form-check-custom form-switch">
                                    <input class="form-check-input w-45px h-30px" type="checkbox" name="details[compound_enable]" id="compound_enable" value="true" <? echo $details['compound_enable'] ? 'checked' : '' ?> />
                                    <label class="form-check-label fs-9" for="compound_enable"></label>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                     <div id="compound" class="row">
                        <div class="separator separator-dashed my-2"></div>
                        <div class="col-md-12">
                        <div class="d-flex flex-stack">
                            <div class="d-flex">
                                <div class="d-flex flex-column">
                                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Return Compounded Amount on Deposit End</a>
                                    <div class="fs-9 fw-semibold text-gray-500">Toggle to enable and disable</div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-end">
                                <div class="form-check form-check-solid form-check-custom form-switch">
                                    <input class="form-check-input w-45px h-30px" type="checkbox" name="details[compound_end]" id="compound_end" value="true" <? echo $details['compound_end'] ? 'checked' : '' ?> />
                                    <label class="form-check-label fs-9" for="compound_end"></label>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                    <div class="separator separator-dashed my-2"></div>
                        <div class="col-md-2">
                          <div class="form-group">
                            <label class="fs-9">Compound Investment Amount Limits</label>
                        </div>
                        </div>
                        <div class="col-md-2">
                          <div class="form-group">
                            <label class="fs-9"> Compound Min ($)</label>
                        </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                               
                                <input type="text" name="details[compound_min]" value="<? echo $details['compound_min'] ?>" class="form-control form-control-sm" />
                                <label class="form-check-label fs-9" for="principal_return">(leave empty to skip limit)</label>
                            </div>
                        </div>
                        <div class="col-md-2">
                          <div class="form-group">
                             <label class="fs-9"> Compound Max ($)</label>
                        </div>
                        </div>
                          <div class="col-md-3">
                            <div class="form-group">
                              
                                <input type="text" name="details[compound_max]" value="<? echo $details['compound_max'] ?>" class="form-control form-control-sm" />
                                <label class="form-check-label fs-9" for="principal_return">(leave empty to skip limit)</label>
                            </div>
                        </div>
                    <div class="separator separator-dashed my-2"></div>
                        <div class="col-md-2">
                          <div class="form-group">
                            <label class="fs-9">Compounding Percent Limits</label>
                        </div>
                        </div>
                        <div class="col-md-2">
                          <div class="form-group">
                            <label class="fs-9"> Compound  Min (%)</label>
                        </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                               
                                <input type="text" name="details[compound_percent_min]" value="<? echo $details['compound_percent_min'] ?>" class="form-control form-control-sm" />
                                <label class="form-check-label fs-9" for="principal_return">(leave empty to skip limit)</label>
                            </div>
                        </div>
                        <div class="col-md-2">
                          <div class="form-group">
                             <label class="fs-9"> Compound Max (%)</label>
                        </div>
                        </div>
                          <div class="col-md-3">
                            <div class="form-group">
                              
                                <input type="text" name="details[compound_percent_max]" value="<? echo $details['compound_percent_max'] ?>" class="form-control form-control-sm" />
                                <label class="form-check-label fs-9" for="principal_return">(leave empty to skip limit)</label>
                            </div>
                        </div>
              
                     </div>
                    <div class="separator separator-dashed my-2 rest"></div>
                    <div class="col-md-4 rest">
                        <div class="form-group">
                            <label class="fs-9">Earning Days</label>
                        </div>
                    </div>
                    <div class="col-md-8 rest">
                        <select class="form-select form-select-sm" name="earnings_mon_fri" id="earnings">
                            <option value="0" <? echo $plan['earnings_mon_fri'] == "0" ? " selected" : "" ?>>7 Days a week</option>
                            <option value="1" <? echo $plan['earnings_mon_fri'] == "1" ? " selected" : "" ?>>Work days earnings only(Mon-Fri)</option>
                            <option value="2" <? echo $plan['earnings_mon_fri'] == "2" ? " selected" : "" ?>>Select Days</option>
                        </select>
                        <small id="emailHelp" class="form-text text-muted fs-9">7 Days a week | Work days earnings only(Mon-Fri) | Select Days for earnings</small>
                    </div>
                    <div id="days" class="row">
                        <?php
                $earning_days = json_decode($plan['earning_days'], true);
    ?>
                        <div class="col-md-2"><label class="fs-9">Select Earning Days</label></div>
                        <div class="col-md-10">
                            <div class="btn-group" data-toggle="buttons">
                                <label class="btn">
                                    <div class="custom-control custom-checkbox mr-sm-2">
                                        <input type="checkbox" class="custom-control-input" name="earning_days[Monday]" id="checkbox0" <?=$earning_days['Monday'] ? 'checked=""' : '' ?> />
                                        <label class="custom-control-label" for="checkbox0">Monday</label>
                                    </div>
                                </label>
                                <label class="btn">
                                    <div class="custom-control custom-checkbox mr-sm-2">
                                        <input type="checkbox" class="custom-control-input" name="earning_days[Tuesday]" <?=$earning_days['Tuesday'] ? 'checked=""' : '' ?> id="checkbox1" />
                                        <label class="custom-control-label" for="checkbox1">Tuesday</label>
                                    </div>
                                </label>
                                <label class="btn">
                                    <div class="custom-control custom-checkbox mr-sm-2">
                                        <input type="checkbox" class="custom-control-input" name="earning_days[Wednesday]" <?=$earning_days['Wednesday'] ? 'checked=""' : '' ?> id="checkbox2" />
                                        <label class="custom-control-label" for="checkbox2">Wednesday</label>
                                    </div>
                                </label>
                                <label class="btn">
                                    <div class="custom-control custom-checkbox mr-sm-2">
                                        <input type="checkbox" class="custom-control-input" name="earning_days[Thursday]" <?=$earning_days['Thursday'] ? 'checked=""' : '' ?> id="checkbox3" />
                                        <label class="custom-control-label" for="checkbox3">Thursday</label>
                                    </div>
                                </label>
                                <label class="btn">
                                    <div class="custom-control custom-checkbox mr-sm-2">
                                        <input type="checkbox" class="custom-control-input" name="earning_days[Friday]" <?=$earning_days['Friday'] ? 'checked=""' : '' ?> id="checkbox4" />
                                        <label class="custom-control-label" for="checkbox4">Friday</label>
                                    </div>
                                </label>
                                <label class="btn">
                                    <div class="custom-control custom-checkbox mr-sm-2">
                                        <input type="checkbox" class="custom-control-input" name="earning_days[Saturday]" <?=$earning_days['Saturday'] ? 'checked=""' : '' ?> id="checkbox5" />
                                        <label class="custom-control-label" for="checkbox5">Saturday</label>
                                    </div>
                                </label>
                                <label class="btn">
                                    <div class="custom-control custom-checkbox mr-sm-2">
                                        <input type="checkbox" class="custom-control-input" name="earning_days[Sunday]" <?=$earning_days['Sunday'] ? 'checked=""' : '' ?> id="checkbox6" />
                                        <label class="custom-control-label" for="checkbox6">Sunday</label>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
    
                    <div class="separator separator-dashed my-2 rest"></div>
    
                    <div class="col-md-4 rest">
                        <div class="form-group">
                            <label class="fs-9">Require "parent" Package Investment</label>
                        </div>
                    </div>
                    <div class="col-md-4 rest">
                        <select class="form-select form-select-sm" name="parent_plan">
                            <option value="0">None</option>
                            <?php $a = mysqli_query($DB_CONN, "SELECT * FROM `packages` ");
                while ($pl = mysqli_fetch_assoc($a))
                { ?>
                            <option value="<?php echo $pl['id'] ?>" <? echo $plan['parent_plan'] == $pl['id'] ? " selected" : "" ?> > <?php echo $pl['name'] ?> </option>
                    <?php
                } ?>
                        </select>
                        <small id="emailHelp" class="form-text text-muted fs-9">If selected user will be forced to Investment in parent plan in order to obtain this package.</small>
                    </div>
                    <div class="col-md-4 rest">
                        <select class="form-select form-select-sm" name="parent_plan_type">
                            <option value="0" <? echo $plan['parent_plan_type'] == "0" ? " selected" : "" ?>>Active Investment Only</option>
                            <option value="1" <? echo $plan['parent_plan_type'] == "1" ? " selected" : "" ?>>Active / Expired Investement</option>
                           
                        </select>
                        <label class="form-check-label fs-9" for="parent_plan_type">Select if you require user to have an acitve investment in Parent Plan or Active/Expire.</label>
                    </div>
    
                    <div class="separator separator-dashed my-2 "></div>
    
                    <div class="col-md-4 ">
                        <div class="form-group">
                            <label class="fs-9">Limit User Count:</label>
                        </div>
                    </div>
                    <div class="col-md-4 ">
                        <input type="text" name="details[limit_user_deposits_count]" value="<? echo $details['limit_user_deposits_count'] ?>" class="form-control form-control-sm" />
                        <label class="form-check-label fs-9" for="limit_user_deposits_count">Limit Invest/Faucet (per user) (leave empty to skip)</label>
                    </div>
                     <div class="col-md-4 ">
                        <select class="form-select form-select-sm" name="details[limit_user_deposits_count_per]">
                            <option value="" >None</option>
                            <option value="hours"  <? echo $details['limit_user_deposits_count_per'] == "hours" ? " selected" : "" ?>>Per Hour</option>
                            <option value="days" <? echo $details['limit_user_deposits_count_per'] == "days" ? " selected" : "" ?>>Per Day</option>
                            <option value="weeks" <? echo $details['limit_user_deposits_count_per'] == "weeks" ? " selected" : "" ?>>Per Week</option>
                            <option value="bi-weeks" <? echo $details['limit_user_deposits_count_per'] == "bi-weeks" ? " selected" : "" ?>>Per Bi-Week</option>
                            <option value="months" <? echo $details['limit_user_deposits_count_per'] == "months" ? " selected" : "" ?>>Per Month</option>
                             <option value="years" <? echo $details['limit_user_deposits_count_per'] == "years" ? " selected" : "" ?>>Per Year</option>
                        </select>
                        <label class="form-check-label fs-9" for="limit_user_deposits_count_per">Limit User Active Deposits Amount Per Hour, Day, Week, Bi-Weeks, Months, Year</label>
                    </div>
                    <div class="separator separator-dashed my-2 rest"></div>
                    <div class="col-md-4 rest">
                        <div class="form-group">
                            <label class="fs-9">Limit User Active Investment Amount:</label>
                        </div>
                    </div>
                    <div class="col-md-4 rest">
                        <input type="text" name="details[limit_user_deposits_amount]" value="<? echo $details['limit_user_deposits_amount'] ?>" class="form-control form-control-sm" />
                        <label class="form-check-label fs-9" for="limit_user_deposits_amount">Limit amount (per user) (leave empty to skip)</label>
                    </div>
                    
                    <div class="col-md-4 rest">
                        <select class="form-select form-select-sm" name="details[limit_user_deposits_amount_per]">
                            <option value="">None</option>
                             <option value="hours"  <? echo $details['limit_user_deposits_amount_per'] == "hours" ? " selected" : "" ?>>Per Hour</option>
                            <option value="days" <? echo $details['limit_user_deposits_amount_per'] == "days" ? " selected" : "" ?>>Per Day</option>
                            <option value="weeks" <? echo $details['limit_user_deposits_amount_per'] == "weeks" ? " selected" : "" ?>>Per Week</option>
                            <option value="bi-weeks" <? echo $details['limit_user_deposits_amount_per'] == "bi-weeks" ? " selected" : "" ?>>Per Bi-Week</option>
                            <option value="months" <? echo $details['limit_user_deposits_amount_per'] == "months" ? " selected" : "" ?>>Per Month</option>
                             <option value="years" <? echo $details['limit_user_deposits_amount_per'] == "years" ? " selected" : "" ?>>Per Year</option>
                        </select>
                        <label class="form-check-label fs-9" for="limit_user_deposits_amount_per">Limit User Active Investment Amount Per Hour, Day, Week, Bi-Weeks, Months, Year</label>
                    </div>
                    
                    <div class="separator separator-dashed my-2 rest"></div>
                    <div class="col-md-4 rest">
                        <div class="form-group">
                            <label class="fs-9">Delay earning for some days since Investment:</label>
                        </div>
                    </div>
                    <div class="col-md-8 rest">
                        <input type="text" name="details[earning_delay]" value="<? echo $details['earning_delay'] ?>" class="form-control form-control-sm" />
                        <label class="form-check-label fs-9" for="earning_delay"> no of days to delay earnings after Investment(leave empty to disable this feature)</label>
                    </div>
             
                    <div class="separator separator-dashed my-2 rest"></div>
                     <div class="col-md-12 rest">
                       <div class="d-flex flex-stack">
                            <div class="d-flex">
                                <div class="d-flex flex-column">
                                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Use Dedicated Referral Commission for this Plan</a>
                                    <div class="fs-9 fw-semibold text-gray-500">If enabled referral commission of this package this will override system <a  href="admin?page=referral">referral settings.</a></div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-end">
                                <div class="form-check form-check-solid form-check-custom form-switch">
                                    <input class="form-check-input w-45px h-30px" type="checkbox" name="details[referralc]" id="referralc" value="1" <? echo $details['referralc'] ? 'checked' : '' ?>>
                                    <label class="form-check-label fs-9" for="referralc"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                   <div class="separator separator-dashed my-2 rest"></div>
                    <div id="referral" class="table-responsive">
                         <div class="fs-9 fw-semibold text-gray-500">To Set Levels and Tiers please reffer to <a  href="admin?page=referral">referral settings.</a></div>
    <div class="table-responsive">
        <table class="table table-striped table-bordered">
    <thead>
        <tr class="fw-bold text-muted bg-light">
            <td rowspan="2" class="align-middle">Tiers</td>
            <td colspan="1" class="text-center">Account Tier Name</td>
            <?php for ($i = 1; $i <= $referral_settings['levels']; $i++) { ?>
                <td class="text-center">Level <?= $i ?></td>
            <?php } ?>
        </tr>
        <tr class="fw-bold text-muted bg-light">
            <td colspan="1" class="text-center text-muted">Tier name (Can be any)</td>
            <?php for ($i = 1; $i <= $referral_settings['levels']; $i++) { ?>
                <td class="text-center text-muted">Commission (%)</td>
            <?php } ?>
        </tr>
    </thead>
    <tbody>
        <?php for ($i = 1; $i <= $referral_settings['tiers']; $i++) { ?>
            <tr>
                <td rowspan="1" class="align-middle">Tier <?= $i ?></td>
                <td colspan="1">
                    <input type="text" 
                            readonly
                           value="<?php echo isset($referral_settings['tier'][$i]['name']) ? $referral_settings['tier'][$i]['name'] : 'Tier '.$i; ?>" 
                           class="form-control form-control-sm" />
                </td>
                <?php for ($l = 1; $l <= $referral_settings['levels']; $l++) { ?>
                    <td rowspan="1" class="align-middle">
                        <input type="number" 
                               name="details[referral][tier][<?= $i ?>][level][<?= $l ?>]" 
                               value="<?php echo isset($details['referral']['tier'][$i]['level'][$l]) ? $details['referral']['tier'][$i]['level'][$l] : ''; ?>" 
                               class="form-control form-control-sm" />
                    </td>
                <?php } ?>
            </tr>
            <?php if (false) { //$referral_settings['system'] == 'ranges' ?>
                <tr>
                    <td>User Investment</td>
                    <td>Referral Investments</td>
                    <td>No of Sponsors</td>
                    <td>No of Total Team</td>
                    <td>No of Indirect Referrals</td>
                </tr>
                <tr>
                    <td>
                        <input type="number" 
                               name="details[referral][tier][<?= $i ?>][invested]" 
                               value="<?php echo isset($details['referral']['tier'][$i]['invested']) ? $details['referral']['tier'][$i]['invested'] : ''; ?>" 
                               class="form-control form-control-sm" />
                    </td>
                    <td>
                        <input type="number" 
                               name="details[referral][tier][<?= $i ?>][investments]" 
                               value="<?php echo isset($details['referral']['tier'][$i]['investments']) ? $details['referral']['tier'][$i]['investments'] : ''; ?>" 
                               class="form-control form-control-sm" />
                    </td>
                    <td>
                        <input type="text" 
                               name="details[referral][tier][<?= $i ?>][sponsors]" 
                               value="<?php echo isset($details['referral']['tier'][$i]['sponsors']) ? $details['referral']['tier'][$i]['sponsors'] : ''; ?>" 
                               class="form-control form-control-sm" />
                    </td>
                    <td>
                        <input type="text" 
                               name="details[referral][tier][<?= $i ?>][referrals]" 
                               value="<?php echo isset($details['referral']['tier'][$i]['referrals']) ? $details['referral']['tier'][$i]['referrals'] : ''; ?>" 
                               class="form-control form-control-sm" />
                    </td>
                    <td>
                        <input type="text" 
                               name="details[referral][tier][<?= $i ?>][indirect_referrals]" 
                               value="<?php echo isset($details['referral']['tier'][$i]['indirect_referrals']) ? $details['referral']['tier'][$i]['indirect_referrals'] : ''; ?>" 
                               class="form-control form-control-sm" />
                    </td>
                </tr>
            <?php } ?>
        <?php } ?>
    </tbody>
</table>
         </div>
         <div class="separator separator-dashed my-2"></div>
         <div class="row">
           <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9">Increase Investment according to Referral (%) :</label>
                </div>
            </div>
            <div class="col-md-8">
                <input type="text" name="referral_compound" value="<? echo $plan['referral_compound'] ?>" class="form-control form-control-sm" />
                <label class="form-check-label fs-9" for="referral_compound"> Increase Investment according to referral Investment (leave empty to skip)</label>
            </div>
            </div>
            <div class="separator separator-dashed my-2"></div>
        </div>
    <div class="col-md-12 rest">
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Cash Back Bonus</a>
                    <div class="fs-9 fw-semibold text-gray-500">Instant Earning on making Investment in this paln</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="details[cashback_bonus]" id="cashback_bonus" value="true" <? echo $details['cashback_bonus'] == 'true' ? "checked" : "" ?>>
                    <label class="form-check-label fs-9" for="cashback_bonus"></label>
                </div>
            </div>
        </div>
    </div>
    <div id="cashback" class="row" style="">
         <div class="separator separator-dashed my-2"></div>
       <div class="col-md-2">
            <div class="form-group">
            <label class="fs-9">Fixed Amount Bonus ($) :</label>
        </div>
        </div>
        <div class="col-md-4">
            <input type="amount" name="details[cashback_bonus_amount]" value="<? echo $details['cashback_bonus_amount'] ?>" class="form-control form-control-sm" />
        <label class="form-check-label fs-9" for="referral_compound">Bonus as Fixed Amount ($) (leave empty to skip)</label>
        </div>
         <div class="col-md-2">
              <label class="fs-9">Percentage Bonus (%) :</label>
        </div>
        <div class="col-md-4">
            <input type="amount" name="details[cashback_bonus_percentage]" value="<? echo $details['cashback_bonus_percentage'] ?>" class="form-control form-control-sm" />
        <label class="form-check-label fs-9" for="referral_compound"> Percentage (%) of Investment as Bonus (leave empty to skip)</label>
        </div>
        <div class="separator separator-dashed my-2"></div>
       <div class="col-md-2">
            <div class="form-group">
            <label class="fs-9">Fixed Amount Bonus Memo :</label>
        </div>
        </div>
        <div class="col-md-4">
            <input type="amount" name="details[cashback_bonus_amount_memo]" value="<? echo $details['cashback_bonus_amount_memo'] ? : 'CashBack Bonus from #plan#'; ?>" class="form-control form-control-sm" />
        <label class="form-check-label fs-9" for="referral_compound">Available variables: #plan# - #bonus_amount#</label>
        </div>
         <div class="col-md-2">
              <label class="fs-9">Percentage Bonus Memo :</label>
        </div>
        <div class="col-md-4">
            <input type="amount" name="details[cashback_bonus_percentage_memo]" value="<? echo $details['cashback_bonus_percentage_memo'] ? : '#bonus_percentage#% CashBack Bonus from #plan#'; ?>" class="form-control form-control-sm" />
        <label class="form-check-label fs-9" for="referral_compound">Available variables: #plan# - #bonus_amount# , #bonus_percentage#</label>
        </div>
    </div>
    <? if ($referral_settings['system'] == 'ranges') { ?>
     <div class="separator separator-dashed my-2 "></div>
        <div class="col-md-4">
            <div class="form-group">
                <label class="fs-9"> Limit Tier: </label>
            </div>
        </div>
        <div class="col-md-8">
            <select class="form-select form-select-sm form-select-solid" name="limit_tier" id="limit_tier">
                <option value=""> Allow all Tiers</option>
                <?php foreach ($referral_settings['tier'] as $key => $tier) { ?>
                    <option value="<?php echo $key ?>" <? echo $plan['limit_tier'] == $key ? " selected" : "" ?>> <?php echo $tier['name'] ?> </option>
                <?php } ?>  
            </select>
            <small id="emailHelp" class="form-text text-muted fs-9">Will be active if user is on this tier and upgrade user tier must be active.</small>
        </div>
    <? } ?>
     <div class="separator separator-dashed my-2 "></div>
        <div class="col-md-4">
            <div class="form-group">
                <label class="fs-9"> Limit Currency: </label>
            </div>
        </div>
        <div class="col-md-8">
            <select class="form-select form-select-sm form-select-solid" name="limit_currency" id="limit_currency">
                <option value=""> Allow all Currencies</option>
                <?php $select_method = mysqli_query($DB_CONN, "SELECT * from currencies where de_pm_id != 0");
                while ($row_method = mysqli_fetch_assoc($select_method))
                { ?>
                <option value="<?php echo $row_method['id'] ?>" <? echo $plan['limit_currency'] == $row_method['id'] ? " selected" : "" ?>> <?php echo $row_method['name'] ?> </option>
            <?php } ?>  
            </select>
            <small id="emailHelp" class="form-text text-muted fs-9">Will be active via this currency only.</small>
        </div>
   <!--currencies -->

     <div class="separator separator-dashed my-2 rest"></div>
     <div class="col-md-3 rest">
        <div class="form-group">
            <label class="fs-9">Investment Source Limits:</label>
        </div>
    </div>
    <div class="col-md-3 rest">
       <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-7 text-gray-900 text-hover-primary fw-bold">Accept Investment from Payment Processings</a>
                   
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="details[accept_processings]" id="accept_processings" value="1" <? echo $details['accept_processings'] ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="accept_processings"></label>
                </div>
            </div>
        </div>
      
    </div>
    <div class="col-md-3 rest">
       <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-7 text-gray-900 text-hover-primary fw-bold">Accept Investment from account balance</a>
                   
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="details[accept_account_balance]" id="accept_account_balance" value="1" <? echo $details['accept_account_balance'] ? 'checked' : '' ?>   >
                    <label class="form-check-label fs-9" for="accept_account_balance"></label>
                </div>
            </div>
        </div>
      
    </div>
      
    <div class="col-md-3 rest">
       <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-7 text-gray-900 text-hover-primary fw-bold">Accept Investment from Faucet Balance</a>
                   
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="details[accept_faucet_balance]" id="accept_faucet_balance" value="1" <? echo $details['accept_faucet_balance'] ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="accept_faucet_balance"></label>
                </div>
            </div>
        </div>
      
    </div>
     <div class="separator separator-dashed my-2"></div>
    <div class="col-md-4">
        <div class="form-group">
            <label class="fs-9">Earning History Memo :</label>
        </div>
    </div>
    <div class="col-md-8">
        <input type="text" name="details[memo]" value="<? echo $details['memo'] ? : 'Earning from - #plan# - #invested_amount# - #percent# '; ?>" class="form-control form-control-sm" />
        <label class="form-check-label fs-9" for="memo">Available variables: #plan# - #invested_amount# - #percent# - #faucet_amount#</label>
    </div>
 
  
     <div class="separator separator-dashed my-2"></div>
    <div class="col-md-4">
        <div class="form-group">
            <label class="fs-9">Status:</label>
        </div>
    </div>
    <div class="col-md-8">
        <select class="form-select form-select-sm" required="" name="status">
        <option value="1" <? echo $plan['status'] == "1" ? " selected" : "" ?>>Active</option>
        <option value="0" <? echo $plan['status'] == "0" ? " selected" : "" ?>>In-Active</option>
        <option value="2" <? echo $plan['status'] == "2" ? " selected" : "" ?>>Closed</option>

    </select>
    <small id="Help" class="form-text text-muted fs-9">Please select the package status Active - InActive - Closed </small>
    </div>
        <div class="separator separator-dashed my-2"></div>

    <div class="col-md-4">
        <div class="form-group">
            <label class="fs-9"> Description</label>
        </div>
    </div>
    <div class="col-md-8"><textarea rows="2" name="description" class="form-control form-control-sm" spellcheck="false"><?php echo $plan['description'] ?></textarea> <small id="Help" class="form-text text-muted fs-9">Add Description for your Package</small></div>

    <div class="separator separator-dashed my-2"></div>
    
    <table  class="table table-rounded table-bordered gy-1 gs-5">
        <thead>
            <tr>
                <th class="title text-center text-primary" colspan="4">Profit Calculator</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <th class="align-middle" style="width: 20%">Principal</th>
                <td class="align-middle" style="width: 30%"><span id="principal"></span></td>
                <th class="align-middle" style="width: 20%">Profit</th>
                <td class="align-middle" style="width: 30%"><span id="profit"></span></td>
            </tr>
            <tr>
                <th class="align-middle">Plan Percentage</th>
                <td><span id="percentage"></span></td>
                <th class="align-middle">Total ROI</th>
                <td><span id="roi"></span></td>
            </tr>
        </tbody>
        <tfoot>
            <tr>
                <td class="align-middle">Deposit Amount</td>
                <td colspan="2"><input type="number" placeholder="" id="dep_min" class="form-control form-control-sm form-control-solid"></td>
                <td><button class="btn btn-sm btn-primary" id="calculateButton" type="button">Calculate</button></td>
            </tr>
        </tfoot>
    </table>
  <script>
   document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('calculateButton').addEventListener('click', function() {
                const depositAmount = parseFloat(document.getElementById('dep_min').value);

                if (isNaN(depositAmount) || depositAmount <= 0) {
                    alert('Please enter a valid Deposit Amount.');
                    return;
                }

                const rows = document.querySelectorAll('#mainTable tbody tr');
                const etype = parseInt(document.getElementById('etype').value);
                let totalProfit = 0;

                rows.forEach(row => {
                    const percentMinInput = row.querySelector('input[name="percent_min[]"]');
                    const percentMaxInput = row.querySelector('input[name="percent_max[]"]');
                    const rangeMinInput = row.querySelector('input[name="range_min[]"]');
                    const rangeMaxInput = row.querySelector('input[name="range_max[]"]');

                    if (percentMinInput && percentMaxInput && rangeMinInput && rangeMaxInput) {
                        const percentMin = parseFloat(percentMinInput.value);
                        const percentMax = parseFloat(percentMaxInput.value);
                        const rangeMin = parseFloat(rangeMinInput.value);
                        const rangeMax = parseFloat(rangeMaxInput.value);

                        if (depositAmount >= rangeMin && depositAmount <= rangeMax) {
                            let profitPercentage = percentMax;
                            if (etype === 1 || etype === 2) { // Variable Earnings
                                profitPercentage = percentMin + Math.random() * (percentMax - percentMin);
                            }
                            totalProfit += (depositAmount * profitPercentage) / 100;
                        }
                    }
                });

                const totalRoi = depositAmount + totalProfit;
                const totalPercentage = (totalProfit / depositAmount) * 100;

                document.getElementById('principal').textContent = `$${depositAmount.toFixed(2)}`;
                document.getElementById('profit').textContent = `$${totalProfit.toFixed(2)}`;
                document.getElementById('percentage').textContent = `${totalPercentage.toFixed(2)}%`;
                document.getElementById('roi').textContent = `$${totalRoi.toFixed(2)}`;
            });
        });
    </script>     
                    
                    
                </div>
        </div>
       <div class="card-footer d-flex justify-content-end py-2 px-9">
  <? if($plan['id']) { ?>
  <input class="btn btn-primary btn-sm me-2" type="submit" name="submit" value="Edit Package ">
  <input type="hidden" name="package_id" value="<?php echo $plan['id'] ?>">
  <input type="hidden" name="action" value="update">
  <? } else { ?>
  <input class="btn btn-primary btn-sm me-2" type="submit" name="submit" value="Add Package ">
  <input type="hidden" name="action" value="add">
  <? } ?>
</div>
    </div>
</form>
<script>

$(function() {
    <? echo $plan['etype'] ? "range_div('{$plan['etype']}')" : "range_div('0')" ?>
    
    $('#etype').change(function(){
         range_div($('#etype').val())
    });
});
function range_div(va) {
    if(va == '0') {
        $('#percent').show(); 
        $('#range').hide();
        $('.faucet').hide();
        $('.faucet_auto').hide();
        $('.faucet_m').hide();
        $('.rest').show();
        $('.min').hide();
        $('.maxfield').attr("placeholder", "Percent");
        $("#limit_currency").attr('required', false);
        $("#accept_account_balance").attr('checked', true);
         $("#accept_processings").attr('checked', true);
    } else if(va == '1' || va == '2') {
        $('#percent').hide();
        $('.faucet').hide();
        $('.faucet_auto').hide();
        $('.faucet_m').hide();
        $('.rest').show();
        $('#range').show();
        $('.min').show();
        $('.max').show();
        $('.maxfield').attr("placeholder", "Max Percent");
        $("#limit_currency").attr('required', false);
        $("#accept_account_balance").attr('checked', true);
        $("#accept_processings").attr('checked', true);
    }else if(va == '3') {
        $('#percent').hide(); 
        $('#range').hide();
        $('.faucet').hide();
        $('.faucet_auto').hide();
        $('.faucet_m').hide();
        $('.rest').show();
        $('.min').hide();
        $('.max').hide();
        $("#limit_currency").attr('required', false);
    }else if(va == '4') {
        $('.rest').hide();
        $('.faucet').show();
        $('.faucet_auto').show();
        $("#limit_currency").attr('required', true);
    } else {
        $('#percent').show(); 
        $('#range').hide();
        $('.faucet').hide();
        $('.faucet_auto').hide();
        $('.faucet_m').hide();
        $('.rest').show();
        $('.min').hide();
        $('.maxfield').attr("placeholder", "Percent");
        $("#limit_currency").attr('required', false);
        $("#accept_account_balance").attr('checked', true);
        $("#accept_processings").attr('checked', true);
    }
}
</script>

<script>
   $('.faucet_auto').<? if($plan['etype'] == '4' && $details['faucet_type'] == 'auto') { echo "show"; }else{ echo "hide"; } ?>(); 
    $('.faucet_m').<? if($plan['etype'] == '4' && $details['faucet_type'] == 'auto') { echo "hide"; }else{ echo "show"; } ?>();
$(function() {
    $('#faucet_type').change(function(){
        if($('#faucet_type').val() == 'auto') {
            $('.faucet_auto').show(); 
             $('.faucet_m').hide();
        } else {
           $('.faucet_auto').hide();
         $('.faucet_m').show();
        } 
    });
});
</script>
<script>
   $('#days').<? echo $plan['earnings_mon_fri'] == 2 ? "show" : "hide" ?>(); 
$(function() {
    $('#earnings').change(function(){
        if($('#earnings').val() == '2') {
            $('#days').show(); 
        } else {
            $('#days').hide(); 
        } 
    });
});
</script>
<script>
$("#increasediv").<? echo $details['incease'] == 'true' ? "show" : "hide" ?>();
$("#increase").click(function() {
    if($(this).is(":checked")) {
        $("#increasediv").show();
    } else {
        $("#increasediv").hide();
    }
});
  </script>
<script>
$("#return").<? echo $plan['principal_return'] == 1 ? "show" : "hide" ?>();
$("#principal_return").click(function() {
    if($(this).is(":checked")) {
        $("#return").show();
    } else {
        $("#return").hide();
    }
});
  </script>
<script>
   $("#release").<? echo $plan['allowprincipal'] == 1 ? "show" : "hide" ?>();
$("#allowprincipal").click(function() {
    if($(this).is(":checked")) {
        $("#release").show();
    } else {
        $("#release").hide();
    }
});
  </script> 
<script>
   $("#compound").<? echo $details['compound_enable'] == 'true' ? "show" : "hide" ?>();
$("#compound_enable").click(function() {
    if($(this).is(":checked")) {
        $("#compound").show();
    } else {
        $("#compound").hide();
    }
});
  </script> 
     <script>
   $("#referral").<? echo $details['referralc'] == '1' ? "show" : "hide" ?>();
$("#referralc").click(function() {
    if($(this).is(":checked")) {
        $("#referral").show();
    } else {
        $("#referral").hide();
    }
});
  </script>
<script>
   $("#cashback").<? echo $details['cashback_bonus'] == 'true' ? "show" : "hide" ?>();
$("#cashback_bonus").click(function() {
    if($(this).is(":checked")) {
        $("#cashback").show();
    } else {
        $("#cashback").hide();
    }
});
  </script>                                       
     <script>
$("#duration").<? echo $plan['duration'] == '100000' ? "hide" : "show" ?>();
$("#lifetime").click(function() {
    if($(this).is(":checked")) {
        $("#duration").hide();
    } else {
        $("#duration").show();
    }
});
  </script>                                 
  <script>
    if ( window.history.replaceState ) {
        window.history.replaceState( null, null, window.location.href );
    }
</script> 
   
   
        
  <?php
        }
    }
    else
    {
   if (isset($_GET['action'])) {
    if ($_GET['action'] == 'up') {
        mysqli_query($DB_CONN, "update packages set sort = sort + 1 where id = '{$_GET['id']}'");
    } elseif ($_GET['action'] == 'down') {
        mysqli_query($DB_CONN, "update packages set sort = sort - 1 where id = '{$_GET['id']}'");
    } elseif ($_GET['action'] == 'delete' && isset($_GET['id'])) {
        $plan_id = $_GET['id'];
        
        // Delete related plan details first
        mysqli_query($DB_CONN, "DELETE FROM package_plans WHERE package_id = '{$plan_id}'");
        
        // Then delete the main plan
        mysqli_query($DB_CONN, "DELETE FROM packages WHERE id = '{$plan_id}'");
        
        // Use JavaScript redirect instead of header()
        echo "<script>window.location.href='admin?page=plans';</script>";
        exit;
    }


} ?>

<div class="card shadow-sm mb-5">
    <div class="card-header py-3">
        <div class="card-title m-0">
            <h3 class="fw-bold text-gray-900 m-0">Investment Plans</h3>
        </div>
        <div class="card-toolbar">
            <a href="admin?page=plans&action=edit" class="btn btn-sm btn-primary">
                <i class="ki-duotone ki-plus fs-2 me-1">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
                New Plan
            </a>
        </div>
    </div>
    
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-rounded table-row-bordered table-striped gy-3 gs-3 border-0 align-middle">
                <thead class="bg-light">
                    <tr class="fw-bold text-gray-800 border-bottom border-gray-200">
                        <th style="width: 80px;">Order</th>
                        <th>Plan Details</th>
                        <th>Deposit</th>
                        <th>Profit</th>
                        <th style="width: 100px;" class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <?php
                    $up = mysqli_query($DB_CONN, "SELECT * FROM `packages` ORDER BY sort DESC");
                    if (mysqli_num_rows($up)) {
                        while ($plan = mysqli_fetch_assoc($up)) {
                            $pd = mysqli_query($DB_CONN, "SELECT * FROM `package_plans` where package_id = '{$plan['id']}'");
                            $details = json_decode($plan['details'], true);
                    ?>
                    <tr class="border-bottom">        
                        <td class="text-center">
                            <div class="btn-group-vertical btn-group-sm">
                                <a href="admin?page=plans&id=<?=$plan['id']?>&action=up" class="btn btn-sm btn-icon btn-light-primary btn-active-primary">
                                    <i class="ki-duotone ki-arrow-up fs-2">
                                        <span class="path1"></span>
                                        <span class="path2"></span>
                                    </i>
                                </a>
                                <a href="admin?page=plans&id=<?=$plan['id']?>&action=down" class="btn btn-sm btn-icon btn-light-primary btn-active-primary mt-1">
                                    <i class="ki-duotone ki-arrow-down fs-2">
                                        <span class="path1"></span>
                                        <span class="path2"></span>
                                    </i>
                                </a>
                            </div>
                        </td>
                        
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="d-flex flex-column">
                                    <a href="#" class="text-gray-900 fw-bold text-hover-primary fs-6 mb-1"><?=$plan['name']?></a>
                                    <span class="badge badge-light-<?php 
                                    if ($plan['etype'] == '0') {
                                        echo 'primary">Fixed';
                                    } elseif ($plan['etype'] == '1') {
                                        echo 'info">Variable';
                                    } elseif ($plan['etype'] == '2') {
                                        echo 'warning">Variable';
                                    } elseif ($plan['etype'] == '3') {
                                        echo 'success">Manual';
                                    } else {
                                        echo 'secondary">Unknown';
                                    }
                                    ?></span>
                                </div>
                            </div>
                        </td>
                        
                        <td>
                            <div class="d-flex flex-column">
                                <?php
                                $pl = mysqli_query($DB_CONN, "SELECT MIN(range_min) AS min, MAX(range_max) as max FROM package_plans WHERE package_id = '{$plan['id']}' and name != ''");
                                while ($deposit = mysqli_fetch_assoc($pl)) {
                                    echo "<span class='badge badge-light fw-semibold fs-7 mb-1'>
                                        <i class='ki-duotone ki-dollar fs-8 me-1'><span class='path1'></span><span class='path2'></span></i>
                                        Min: {$deposit['min']} - Max: {$deposit['max']}
                                    </span>";
                                }
                                
                                $userCount = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT COUNT(id) as c FROM `package_deposits` where package_id = '{$plan['id']}' and txn_id != '' "))['c'];
                                $totalAmount = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT sum(amount) as c FROM `package_deposits` where package_id = '{$plan['id']}'"))['c'];
                                ?>
                                
                                <div class="d-flex align-items-center mt-2">
                                    <span class="badge badge-circle badge-light-primary me-2"><?=number_format($userCount)?></span>
                                    <span class="text-gray-600 fs-7">Users</span>
                                    <span class="bullet bullet-dot bg-gray-400 mx-2"></span>
                                    <span class="fw-semibold fs-7 text-gray-800">Total: $<?=number_format($totalAmount, $preferences['round'])?></span>
                                </div>
                            </div>
                        </td>
                        
                        <td>
                            <div class="d-flex flex-column">
                                <div class="badge badge-light-success p-2 mb-2 text-start">
                                    <?php
                                    mysqli_data_seek($pd, 0); // Reset pointer
                                    while ($plans = mysqli_fetch_assoc($pd)) {
                                        if ($plans['range_min'] && $plan['etype'] == 0) {
                                            echo "<span class='fw-bold'>{$plans['percent_min']}%</span>";
                                        } elseif ($plans['range_min'] && ($plan['etype'] == 1 || $plan['etype'] == 2)) {
                                            echo "<span class='fw-bold'>{$plans['percent_min']}% - {$plans['percent_max']}%</span>";
                                        }
                                    }
                                    
                                    $full = '100';
                                    $duration = $full - $plan['principal_hold'];
                                    $diff = ($plan['diff_in_seconds'] / 3600);
                                    $period = $diff / 24;
                                    
                                    echo " / ";
                                    
                                    if ($plan['frequency'] == 'hours') {
                                        echo 'After ' . $plan['duration'] . ' Hour';
                                    } elseif ($plan['frequency'] == 'days') {
                                        echo 'After ' . $period . ' Day';
                                    } elseif ($plan['frequency'] == 'weeks') {
                                        echo 'After ' . $period . ' Week';
                                    } elseif ($plan['frequency'] == 'bi-weeks') {
                                        echo 'After ' . $period . ' Bi Week';
                                    } elseif ($plan['frequency'] == 'months') {
                                        echo 'After ' . $period . ' Month';
                                    } else {
                                        echo ucfirst($plan['frequency']);
                                    }
                                    
                                    if ($period > 1) echo 's';
                                    ?>
                                </div>
                                
                                <div class="d-flex align-items-center">
                                    <span class="fs-7 text-gray-600 me-2">Accruals:</span>
                                    <span class="badge badge-light fw-semibold fs-7"><?=$plan['duration']?></span>
                                    
                                    <?php if ($plan['principal_return'] == '1') { ?>
                                        <span class="bullet bullet-dot bg-gray-400 mx-2"></span>
                                        <span class="badge badge-light-info fw-semibold fs-7">
                                            Return <?=$duration?>% Principal
                                        </span>
                                    <?php } ?>
                                </div>
                                
                                <?php if ($plan['allowprincipal'] == '1') { ?>
                                    <div class="mt-2">
                                        <span class="badge badge-light-warning">
                                            <i class="ki-duotone ki-check fs-7 me-1">
                                                <span class="path1"></span>
                                                <span class="path2"></span>
                                            </i>
                                            Principal Release Allowed
                                        </span>
                                    </div>
                                <?php } ?>
                            </div>
                        </td>
                        
                        <td class="text-end">
                            <a href="admin?page=plans&action=edit&id=<?=$plan['id']?>" class="btn btn-icon btn-sm btn-light-primary btn-active-primary me-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Edit">
                                <i class="ki-duotone ki-pencil fs-2">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                            </a>
                           <a href="admin?page=plans&action=delete&id=<?=$plan['id']?>" class="btn btn-icon btn-sm btn-light-danger btn-active-danger" data-bs-toggle="tooltip" data-bs-placement="top" title="Delete" onclick="return confirm('Are you sure you want to delete this plan?');">
                                <i class="ki-duotone ki-trash fs-2">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                    <span class="path3"></span>
                                    <span class="path4"></span>
                                    <span class="path5"></span>
                                </i>
                            </a>
                        </td>
                    </tr>
                    
                    <tr class="bg-light-secondary">
                        <td colspan="5" class="py-2">
                            <div class="ms-5">
                                <?php
                                $pl = mysqli_query($DB_CONN, "SELECT * FROM package_plans WHERE package_id = '{$plan['id']}' and name != ''");
                                while ($plans = mysqli_fetch_assoc($pl)) {
                                ?>
                                <div class="d-flex align-items-center mb-1">
                                    <i class="ki-duotone ki-arrow-right fs-7 text-gray-600 me-2">
                                        <span class="path1"></span>
                                        <span class="path2"></span>
                                    </i>
                                    <span class="text-gray-800 fw-semibold fs-7"><?=$plans['name']?></span>
                                    <span class="badge badge-light-primary mx-2">From: $<?=$plans['range_min']?></span>
                                    <span class="badge badge-light-success">Profit: <?=$plans['percent_max']?>%</span>
                                </div>
                                <?php } ?>
                            </div>
                        </td>
                    </tr>
                    <?php
                        } // End while
                    } else {
                    ?>
                    <tr>
                        <td colspan="5" class="text-center py-5">
                            <div class="d-flex flex-column align-items-center">
                                <i class="ki-duotone ki-information-5 fs-3x text-gray-400 mb-3">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                    <span class="path3"></span>
                                </i>
                                <span class="text-gray-600 fw-semibold fs-6">No Investment Plans found</span>
                                <a href="admin?page=plans&action=edit" class="btn btn-sm btn-primary mt-3">
                                    <i class="ki-duotone ki-plus fs-2 me-1">
                                        <span class="path1"></span>
                                        <span class="path2"></span>
                                    </i>
                                    Add New Plan
                                </a>
                            </div>
                        </td>
                    </tr>
                    <?php } ?>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" tabindex="-1" id="deleteModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-gray-800">Are you sure you want to delete this investment plan? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                <a href="#" id="confirmDeleteBtn" class="btn btn-danger">Delete Plan</a>
            </div>
        </div>
    </div>
</div>

<script>
function confirmDelete(id) {
    document.getElementById('confirmDeleteBtn').href = 'admin?page=plans&action=delete&id=' + id;
    var deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    deleteModal.show();
}
</script>
<?
    } ?>
                                            
<?
}
if ($_GET['page'] == 'earnings')
{ ?>
    <?php
    if (isset($_POST['submit']))
    {
        // mysqli_query($DB_CONN,"INSERT into representative (user_id) VALUES ('{$_POST['username']}')");
        foreach ($_POST['percent'] as $key => $value)
        {
            if ($value)
            {
                daily_earning($key, $value);
                $insert_representative = true;
            }
        }
        if ($insert_representative)
        {
            echo '<br><div class="alert alert-success">
              Issued Successfully ! 
        </div>';
        }

    }
?>
<div class="card mb-2">
    <div class="card-header min-h-unset py-2">
        <h3 class="card-title align-items-start flex-column m-0">
            <span class="card-label fw-bold text-gray-900">Issue Earnings</span>
            <span class="text-gray-500 mt-1 fw-semibold fs-6">Issue Earnings fro Plans with <b>Manual</b> earning type.</span>
        </h3>
    </div>
<form method="POST" action="" >
 <div class="card-body">
     <div class="table-responsive">
        <table  class="table table-row-dashed border-gray-300 align-middle gy-6 table-sm">
            <thead>
                <tr>
                    <th>Active Users</th>
                    <th>Package</th>
                    <th>Earning (%)</th>
                </tr>
                </thead>
                <?php $select_user = mysqli_query($DB_CONN, "SELECT *, (SELECT COUNT(user_id) from package_deposits WHERE package_id = packages.id and status = 1) as users from packages where etype = 3");
    while ($row = mysqli_fetch_assoc($select_user))
    { ?>
            <tr>
                <td><?=$row['users'] ?></td>
                <td><input type="text" class="form-control form-control-sm form-control-solid" name="package" value="<?=$row['name'] ?>" readonly></td>
                <td><input type="text" class="form-control form-control-sm form-control-solid" name="percent[<?=$row['id'] ?>]" value=""></td>
                <td></td>
            </tr>
<?php } ?>      
            </table>
</div>
</div>

<div class="card-footer d-flex justify-content-end py-2 px-9">
        <input type="submit" name="submit" class="btn btn-primary btn-sm" value="Issue Earning">
</div>
            </form>
    </div>
                    
<?
}
if ($_GET['page'] == 'report')
{
$_POST = $_GET;
$w = "";
if(isset($_POST['payment_method_id']) && count($_POST['payment_method_id'])) {
    $w .= " and transactions.payment_method_id in (".implode(",", $_POST['payment_method_id']).") ";
}
if(isset($_POST['search']) && $_POST['search']) {
    $_POST['search'] = str_replace(" ", "%", $_POST['search']);
    $w .= " and (amount like '%{$_POST['search']}%' or txn_id like '%{$_POST['search']}%' or username like '%{$_POST['search']}%' or transactions.id like '%{$_POST['search']}%') ";
}
if(isset($_POST['txn_type']) && $_POST['txn_type']) {
    $w .= " and transactions.txn_type = '{$_POST['txn_type']}' ";
}
if(isset($_POST['start_date']) && $_POST['start_date']) {
    $w .= " and date(transactions.created_at) >= '{$_POST['start_date']}' ";
}
if(isset($_POST['end_date']) && $_POST['end_date']) {
    $w .= " and date(transactions.created_at) <= '{$_POST['end_date']}' ";
}
if(isset($_POST['user_id']) && $_POST['user_id']) {
    $w .= " and transactions.user_id = '{$_POST['user_id']}'";
}
$query = "SELECT transactions.*, 
    users.username, users.email,
    currencies.name as currency, currencies.chain_url, currencies.symbol,
    packages.name as packagename
  FROM `transactions`
  LEFT JOIN users ON transactions.user_id = users.id  
  LEFT JOIN currencies ON transactions.payment_method_id = currencies.id
  LEFT JOIN packages ON transactions.package_id = packages.id
  WHERE 1=1 $w
  ORDER BY transactions.id DESC";
$d = mysqli_query($DB_CONN, $query);

$total_amount = 0;  
$total_count = mysqli_num_rows($d);        
?>
<table class="table table-row-dashed table-row-gray-300 align-middle ">
    <thead>
        <tr class="fw-bold">
            <th>ID</th>
            <th>User</th>
            <th>Currency</th>
            <th>Amount</th>
            <th>Type</th>  
            <th>Created</th>
        </tr>
    </thead>
    <tbody>
        <? while ($tx = mysqli_fetch_assoc($d)) { 
            $total_amount += $tx['amount'];
            ?>
            <tr>
                <td><?=$tx['id']?></td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="d-flex justify-content-start flex-column">
                            <a href="admin?page=user&id=<?=$tx['user_id']?>&view=overview" class="text-dark fw-bold text-hover-primary mb-1 fs-6"><?=$tx['username']?></a>
                            <a href="admin?page=user&id=<?=$tx['user_id']?>&view=overview" class="text-muted text-hover-primary fw-semibold d-block fs-7"><?=$tx['email']?></a>
                        </div>
                    </div>                                    
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="symbol symbol-30px me-5">
                            <img src="images/icons/<?=$tx['payment_method_id']?>.svg" alt="<?=$tx['currency']?>">
                        </div>
                        <div class="d-flex justify-content-start flex-column">
                            <span class="text-dark fw-bold d-block fs-6"><?=$tx['currency']?></span>
                            <span class="text-muted fw-semibold d-block fs-7">Symbol: <?=$tx['symbol']?></span>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="text-dark fw-bold d-block fs-6"><?=fiat($tx['amount'])?></span>
                    <span class="text-muted fw-semibold d-block fs-7">Fee: <?=fiat($tx['fee'])?></span>  
                </td>
                <td><?=getBadge($tx['txn_type'])?></td>
                <td>
                    <span class="text-dark fw-bold d-block fs-7"><?=$tx['created_at']?></span>
                    <span class="text-muted fw-semibold d-block fs-7"><?=time_elapsed_string($tx['created_at'], true)?></span>
                </td>
                <td>
                    <div class="d-flex align-items-center mt-2">
                        <span class="badge badge-light-<?=$tx['status'] == '1' ? 'success' : 'info'?> ms-2"><?=$tx['status'] == '1' ? 'Done' : 'Pending'?></span>
                    </div>
                </td>
            </tr>
            <tr>
        <? } ?>
    </tbody>
    <tfoot>
        <tr>
            <th class="text-end  fw-semibold">Total Count:</th>
            <th class=" fw-bold"><?=number_format($total_count)?></th>
            <th class="text-end  fw-semibold">Total Amount:</th>
            <th class=" fw-bold"><?=fiat($total_amount)?></th>
            <th colspan="3">&nbsp;</th>
        </tr>  
    </tfoot>
</table>
<?    
} if ($_GET['page'] == 'transactions')
{ ?>
<form action="#" id="topsearch">
    <!--begin::Card-->
    <div class="card mb-7">
        <!--begin::Card body-->
        <div class="card-body p-0">
            <!--begin::Compact form-->
            <div class="d-flex align-items-center">
                <!--begin::Input group-->
                <div class="position-relative w-md-900px me-md-2">
                    <!--begin::Svg Icon | path: images/icons/duotune/general/gen021.svg-->
                    <span class="svg-icon svg-icon-3 svg-icon-gray-500 position-absolute top-50 translate-middle ms-6">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <rect opacity="0.5" x="17.0365" y="15.1223" width="8.15546" height="2" rx="1" transform="rotate(45 17.0365 15.1223)" fill="currentColor" />
                            <path
                                d="M11 19C6.55556 19 3 15.4444 3 11C3 6.55556 6.55556 3 11 3C15.4444 3 19 6.55556 19 11C19 15.4444 15.4444 19 11 19ZM11 5C7.53333 5 5 7.53333 5 11C5 14.4667 7.53333 17 11 17C14.4667 17 17 14.4667 17 11C17 7.53333 14.4667 5 11 5Z"
                                fill="currentColor"
                            />
                        </svg>
                    </span>
                    <!--end::Svg Icon-->
                    <input type="text" class="form-control form-control-solid ps-10" name="search" value="" placeholder="Search Address/Transaction/Order" />
                </div>
                <!--end::Input group-->
                <!--begin:Action-->
                <div class="d-flex align-items-center">
                    <input type="hidden" name="last_id" value="0">
                    <input type="hidden" name="user_id" value="<?=$_GET['user_id']?>" >
                    <button type="submit" class="btn btn-primary me-5">Search</button>
                    <a  id="kt_horizontal_search_advanced_link" class="btn btn-link" data-bs-toggle="collapse" href="#kt_advanced_search_form">Advanced Search</a>
                </div>
                <!--end:Action-->
            </div>
            <!--end::Compact form-->
            <!--begin::Advance form-->
            <div class="collapse" id="kt_advanced_search_form">
                <!--begin::Separator-->
                <div class="separator separator-dashed  my-2"></div>
                <!--end::Separator-->
                <!--begin::Row-->
                <div class="row g-8 mb-8">
                    <!--begin::Col-->
                    <div class="col-xxl-4">
                        <label class="fs-6 form-label fw-bolder text-dark">Payments Methods</label>
                        <select class="js-example-basic-multiple form-select form-select-solid" name="payment_method_id[]" multiple="multiple">
                         <?php $select_method = mysqli_query($DB_CONN, "SELECT *from currencies where de_pm_id != 0");
                            while ($row_method = mysqli_fetch_assoc($select_method)) { ?>
                            <option value="<?php echo $row_method['id'] ?>"> <?php echo $row_method['name'] ?> </option>
                            <?php } ?>
                        </select>
                    </div>
                    <div class="col-xxl-3">
                        <label class="fs-6 form-label fw-bolder text-dark">Users</label>
                        <select class="form-select form-select-solid" name="fake" >
                        <option value="NOT IN (SELECT id from users WHERE auto_withdraw = 4)">Real Only</option>
                         <option value="!=1">Real and Dummy Only</option>
                          <option value="IN (SELECT id from users WHERE auto_withdraw = 4)">Dummy Only</option>
                        </select>
                    </div> 
                    <!--end::Col-->
                    <!--begin::Col-->
                    <div class="col-xxl-5">
                        <!--begin::Row-->
                        <div class="row g-8">
                            <!--begin::Col-->
                            <div class="col-lg-6">
                                <label class="fs-6 form-label fw-bolder text-dark">Transaction Type</label>
                                <!--begin::Select-->
                                <select class="form-select form-select-solid" data-control="select2" data-placeholder="Transaction Type" data-hide-search="true" name="txn_type" >
                                    <option value="">All</option>
                                        <option value="deposit" <?=$_GET['txn_type'] == 'deposit' ? 'selected' : ''?>>Deposit</option>
                                        <option value="invest" <?=$_GET['txn_type'] == 'invest' ? 'selected' : ''?>>Investment</option>
                                        <option value="earning" <?=$_GET['txn_type'] == 'earning' ? 'selected' : ''?>>Earning</option>
                                        <option value="referral" <?=$_GET['txn_type'] == 'referral' ? 'selected' : ''?>>Referral</option>
                                        <option value="binary" <?=$_GET['txn_type'] == 'binary' ? 'selected' : ''?>>Binary</option>
                                        <option value="withdraw" <?=$_GET['txn_type'] == 'withdraw' ? 'selected' : ''?>>Withdraw</option>
                                        <option value="transfer" <?=$_GET['txn_type'] == 'transfer' ? 'selected' : ''?>>Transfer</option>
                                        <option value="exchange" <?=$_GET['txn_type'] == 'exchange' ? 'selected' : ''?>>Exchange</option>
                                        <option value="bonus" <?=$_GET['txn_type'] == 'bonus' ? 'selected' : ''?>>Bonus</option>
                                        <option value="penalty" <?=$_GET['txn_type'] == 'penalty' ? 'selected' : ''?>>Penalty</option>
                                        <option value="return" <?=$_GET['txn_type'] == 'return' ? 'selected' : ''?>>Return</option>
                                        <option value="release" <?=$_GET['txn_type'] == 'release' ? 'selected' : ''?>>release</option>
                                        <option value="release" <?=$_GET['txn_type'] == 'faucet' ? 'selected' : ''?>>Faucet</option>
                                </select>
                                <!--end::Select-->
                            </div>
                            <!--end::Col-->
                            <!--begin::Col-->
                            <div class="col-lg-6">
                                <label class="fs-6 form-label fw-bolder text-dark">Select Status</label>
                                <!--begin::Radio group-->
                                <div class="nav-group nav-group-fluid">
                                    <!--begin::Option-->
                                    <label class="fs-9">
                                        <input type="radio" class="btn-check" name="type" value="all" checked="checked" />
                                        <span class="btn btn-sm btn-color-muted btn-active btn-active-primary fw-bolder px-4">All</span>
                                    </label>
                                    <!--end::Option-->
                                    <!--begin::Option-->
                                    <label class="fs-9">
                                        <input type="radio" class="btn-check" name="type" value="paid" />
                                        <span class="btn btn-sm btn-color-muted btn-active btn-active-primary fw-bolder px-4">Paid</span>
                                    </label>
                                    <!--end::Option-->
                                    <!--begin::Option-->
                                    <label class="fs-9">
                                        <input type="radio" class="btn-check" name="type" value="unpaid" />
                                        <span class="btn btn-sm btn-color-muted btn-active btn-active-primary fw-bolder px-4">Unpaid</span>
                                    </label>
                                    <!--end::Option-->
                                </div>
                                <!--end::Radio group-->
                            </div>
                            <!--end::Col-->
                        </div>
                        <!--end::Row-->
                    </div>
                <!-- </div>
                <div class="row"> -->
                    <!--end::Col-->
                    <div class="col-xxl-5">
                        <label class="fs-6 form-label fw-bolder text-dark">Start Date</label>
                        <input type="date" class="form-control form-control-solid ps-10" name="start_date" id="start_date" value="" />
                    </div>
                    <div class="col-xxl-5">
                        <label class="fs-6 form-label fw-bolder text-dark">End Date</label>
                        <input type="date" class="form-control form-control-solid ps-10" name="end_date" id="end_date" value="" />
                    </div>
                    <div class="col-xxl-2">
                        <label class="fs-6 form-label fw-bolder text-dark"></label><br>
                        <button type="button" class="btn btn-primary me-5" onclick="show_report()">View Report</button>
                    </div>
                </div>
                <!--end::Row-->
                <!--begin::Row-->

                <!--end::Row-->
            </div>
            <!--end::Advance form-->
        </div>
        <!--end::Card body-->
    </div>
    <!--end::Card-->
</form>

<!--begin::Tab Content-->
<div class="tab-content">
    <!--begin::Tab pane-->
<div class="card mb-2">
    <div class="card-header min-h-unset py-2">
        <h3 class="card-title align-items-start flex-column m-0">
             <span class="card-label fw-bold text-gray-900">Transactions</span>
           <span class="text-gray-500 mt-1 fw-semibold fs-6"></span>
        </h3>
         
    </div>
<div class="card-body">
    <!--begin::Table container-->
    <div class="table-responsive">
        <!--begin::Table-->
        <table  class="table table-row-dashed  table-hover align-middle gs-0 gy-4 my-0 transactiontable">
            <!--begin::Table head-->
            <thead>
                <tr class="border-bottom-0">
                    <th class="p-0 ">ID</th>
                    <th class="p-0 ">Username</th>
                    <th class="p-0 ">Currency</th>
                    <th class="p-0 ">Amount</th>
                    <th class="p-0 ">Type</th>
                    <th class=" p-0 ">Timestamp</th>
                    <th class=" text-end">Action</th>
                </tr>
            </thead>
            <!--end::Table head-->
            <!--begin::Table body-->
            <tbody>

            </tbody>
            <tfoot>
                <tr>
                    <td colspan="9" class="text-center"><input type="button" class="btn btn-primary lmore" onclick="load_transactions()" value="Load More"></td>
                </tr>
            </tfoot>
            <!--end::Table body-->
        </table>
        <!--end::Table-->
    </div>
    <!--end::Table container-->
    </div>
    <!--begin::Body-->
</div>
    <!--end::Tab pane-->
</div>
<!--end::Tab Content-->

    
    <div class="modal fade" id="edit_transaction" tabindex="-1" style="display: none;" aria-hidden="true">
        <!--begin::Modal dialog-->
        <div class="modal-dialog modal-dialog-centered mw-650px">
            <!--begin::Modal content-->
            <div class="modal-content">
                <!--begin::Modal header-->
                <div class="modal-header" id="kt_modal_create_api_key_header">
                    <!--begin::Modal title-->
                    <div class="d-flex align-items-center">
                                                                
            <!--begin::Name-->
            <div class="d-flex justify-content-start flex-column">
                <a   class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6"  >Edit <span class="t_id"></span></a>
                <a   class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                <span class="text-gray-900">Currency</span>: <span class="t_c"></span> | <span class="text-gray-900">Username</span>: <span class="t_u"></span>  | <span class="text-gray-900">Type</span>: <span class="t_t"></span></a>
            </div>
            <!--end::Name-->
        </div>
                
                    <!--end::Modal title-->
                    <!--begin::Close-->
                    <div class="btn btn-sm btn-icon btn-active-color-primary" data-bs-dismiss="modal">
                        <!--begin::Svg Icon | path: images/icons/duotune/arrows/arr061.svg-->
                        <span class="svg-icon svg-icon-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <rect opacity="0.5" x="6" y="17.3137" width="16" height="2" rx="1" transform="rotate(-45 6 17.3137)" fill="currentColor"></rect>
                                <rect x="7.41422" y="6" width="16" height="2" rx="1" transform="rotate(45 7.41422 6)" fill="currentColor"></rect>
                            </svg>
                        </span>
                        <!--end::Svg Icon-->
                    </div>
                    <!--end::Close-->
                </div>
                <!--end::Modal header-->
                <!--begin::Form-->
    
            
                    <!--begin::Modal body-->
                    <div class="modal-body py-10 px-lg-17">
                        <!--begin::Scroll-->
                        <div class="scroll-y me-n7 pe-7" id="kt_modal_create_api_key_scroll" data-kt-scroll="true" data-kt-scroll-activate="{default: false, lg: true}" data-kt-scroll-max-height="auto">
                            <!--begin::Notice-->
                        
                            <!--end::Notice-->
                <form id="edit_transaction_form" class="form fv-plugins-bootstrap5 fv-plugins-framework" method="post">
         
                    <div class="form-group is-empty">
                        <label for="amount" class="control-label ajax_label">
                            Amount
                        </label>
                        <input type="text" required="required" placeholder="Amount" name="amount" id="amount" class="form-control form-control-solid">
                       
                    </div>
                    <div class="form-group is-empty">
                        <label for="detail" class="control-label ajax_label">
                           Detail
                        </label>
                        <input type="text" required="required" placeholder="Details" name="detail" id="detail" class="form-control form-control-solid">
                       
                    </div>
                    <div class="form-group is-empty">
                        <label for="txn_id" class="control-label ajax_label">
                            Transaction ID
                        </label>
                        <input type="text" required="required" placeholder="Transaction ID" name="txn_id" id="txn_id"  required class="form-control form-control-solid">
                       
                    </div>
                     
                            </div>
                            <!--end::Scroll-->
                        </div>
                        <!--end::Modal body-->
                        <!--begin::Modal footer-->
                        <div class="modal-footer flex-center">
                            <!--begin::Button-->
                            <button type="reset" id="kt_modal_create_api_key_cancel" class="btn btn-light me-3" data-bs-dismiss="modal">Discard</button>
                            <!--end::Button-->
                            <!--begin::Button-->
                            <button type="submit" id="kt_modal_create_api_key_submit" class="btn btn-primary">
                                <span class="indicator-label">Submit</span>
                                <!-- <span class="spinner-border spinner-border-sm align-middle ms-2"></span></span> -->
                            </button>
                            <!--end::Button-->
                        </div>
                        <!--end::Modal footer-->
                        <input type="hidden" name="action" value="update">
                        <input type="hidden" name="id" value="">
                    <div></div></form>
                    <!--end::Form-->
                </div>
                <!--end::Modal content-->
            </div>
            <!--end::Modal dialog-->
                                    </div>
  <script type="text/javascript">
    $(document).ready(function() {
    $('.js-example-basic-multiple').select2();
});
var last_id = 0;
$("#edit_transaction_form").submit(function(e) {
    e.preventDefault();
    var form = $(this);
    $.ajax({
        type: "POST",
        url: "?page=ajax&h=edit_transaction",
        data: form.serialize(),
        success: function(data)
        {
          if(data.status) {
            Swal.fire({
        text: "Transaction Updated Successfully",
        icon: "success",
        buttonsStyling: false,
        confirmButtonText: "Ok, got it!",
        customClass: {
            confirmButton: "btn btn-primary"
        }
    });
            $("#edit_transaction").modal('hide');
            $("#edit_transaction_form").trigger('reset');
            // load_transactions();
          } else {
            alert("Server Error");
          }
        }
    });
});
function edit_transaction(id,username,currency,txn_type,amount, detail, txn_id) {
     $(".t_id").html(id);
    $(".t_u").html(username);
    $(".t_c").html(currency);
    $(".t_t").html(txn_type);
    $("#edit_transaction input[name=amount]").val(amount);
    $("#edit_transaction input[name=detail]").val(detail);
    $("#edit_transaction input[name=txn_id]").val(txn_id);
    $("#edit_transaction input[name=id]").val(id);
    $("#edit_transaction").modal('show');
}
function load_transactions() {
    $("#loader").show();
    $.ajax({
        async: true,
        url:'?page=ajax&h=transactions',
        type:'POST',
        data: $("#topsearch").serialize(),
        success:function(data) {
            $(".transactiontable tbody").append(data.data);
            last_id = data.last_id;
            $("input[name=last_id]").val(data.last_id);
            $("#loader").hide();
         if(data.last_id == 0) {
                $(".lmore").hide();
            }
         }
        });
}
function show_report() {
    var url = '?page=report&h=transactions&'+$("#topsearch").serialize();
    console.log(url);
    window.open(url, '_blank');
}
$(function() {
    load_transactions();
});

$( "#topsearch" ).submit(function( event ) {
    $(".transactiontable tbody").html('');
    $("input[name=last_id]").val(0);
    last_id = 0;
    load_transactions();
    event.preventDefault();
})

</script>   

<?
}
if ($_GET['page'] == 'transaction')
{ ?>

    <!--begin::Card-->
    <div class="card">
        <div class="card-header border-0 pt-5">
        <h3 class="card-title align-items-start flex-column">
            <span class="card-label fw-bold fs-3 mb-1">Add Transaction</span>

            <span class="text-muted mt-1 fw-semibold fs-7">Add Transaction for Bonus, Investment, Earnings, Commission and Penalty</span>
        </h3>
        
    </div>
<!--begin::Card body-->
<div class="card-body p-12">
    <!--begin::Form-->
<?php
    if (isset($_POST['submit']))
    {
       $ch = validateAdminAuth($admin_settings, $_POST['alternative_passphrase'], null, false);
        if ($ch):
            $to = $_POST['to'];
            switch ($to)
            {
                case 'users':
                    $usernames = $_POST['usernames'];
                    $user_ids = explode("\n", $usernames);
                    $users = array();
                    foreach ($user_ids as $key => $value)
                    {
                        $value = trim($value);
                        $u = mysqli_query($DB_CONN, "select * from users where username = '{$value}' limit 1");
                        if (mysqli_num_rows($u))
                        {
                            $us = mysqli_fetch_assoc($u);
                            $users[$us['id']] = $us['username'];
                        }
                    }
                break;
                case 'all':
                    $u = mysqli_query($DB_CONN, "select * from users");
                    while ($us = mysqli_fetch_assoc($u))
                    {
                        $users[$us['id']] = $us['username'];
                    }
                break;
                case 'active':
                    $u = mysqli_query($DB_CONN, "SELECT * FROM `users` where id in (SELECT user_id from package_deposits where status = 1)");
                    while ($us = mysqli_fetch_assoc($u))
                    {
                        $users[$us['id']] = $us['username'];
                    }
                break;
                case 'passive':
                    $u = mysqli_query($DB_CONN, "SELECT * FROM `users` where id not in (SELECT user_id from package_deposits where status = 1)");
                    while ($us = mysqli_fetch_assoc($u))
                    {
                        $users[$us['id']] = $us['username'];
                    }
                break;
            }
            $type = $_POST['trans_type'];
            $payment_method_id = $_POST['payment_method_id'];
            $amount = $_POST['amount'];
            switch ($type)
            {
                case 'bonus':
                    foreach ($users as $userid => $value)
                    {
                        $detail = "Bonus {$_POST['desc']}";
                        $earnings = mysqli_query($DB_CONN, "INSERT INTO transactions (`detail`, user_id,package_id,plan_id, payment_method_id,amount,status,txn_type, ref_id) Values('{$detail}','{$userid}','','','{$payment_method_id}','{$amount}',1,'bonus', '-1')") or die(mysqli_error($DB_CONN));
                        add_balance($userid, $payment_method_id, $amount);
                        if (isset($_POST['inform']) && $_POST['inform']) sendmail("bonus", $userid, array(), array('data' => $amount));
                    }
                    echo "<div class='alert alert-success'> <strong>Success - </strong> Bonus added Successfully </div>";
                    break;
                case 'deposit':
                    foreach ($users as $userid => $value)
                    {
                        $dt = date("Y-m-d H:i:s");
                        $user_id = $userid;
                        $package_id = ($_POST['package_id']);
                        $txn_id = ($_POST['txn_id']);
                        $deposit = $amount;
                        $package_= mysqli_query($DB_CONN,"SELECT * from packages where status=1 AND id='{$package_id}'") or die(mysqli_error($DB_CONN));
                        $ch = true;
                    if (isset($_POST['balance_deduct']) && $_POST['balance_deduct']) {
                        $u = mysqli_fetch_array(mysqli_query($DB_CONN, "SELECT balance from user_balances where user_id = '{$user_id}' and payment_method_id = '{$payment_method_id}'"))[0];
                        if($u < $deposit) {
                            echo "<div class='alert alert-danger'> <strong>Fail - </strong> Balance not sufficient </div>";
                            $ch = false;
                        }
                    }
                      if(mysqli_num_rows($package_)>0 && $ch)
                      {
                          $package=mysqli_fetch_assoc($package_);
                          $details = json_decode($package['details'], true);
                          $plan_name = $package['name'];
                          $days = $package['duration'];
                          $plan_= mysqli_query($DB_CONN,"SELECT MIN(range_min) as min, MAX(range_max) as max from package_plans where package_id='{$package_id}' and range_min != '' and range_max != ''");
                          $plan=mysqli_fetch_assoc($plan_);
                          $method = mysqli_query($DB_CONN, "SELECT * from currencies where id = '{$payment_method_id}'");
                          $method = mysqli_fetch_assoc($method);
                          $currency = $method['name'];
                          $symbol = $method['symbol'];
                          $pm = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT * FROM `payment_methods` where id = '{$method['de_pm_id']}'"));
                          $func = check_deposit($deposit, $package, $plan, $user_id, $method, $payment_method_id, $details);
                          $eligible1 = $func[0];
                          $fee = $func[1];
                          if ($eligible1) 
                           {
                            $plan__= mysqli_query($DB_CONN,"SELECT * from package_plans where range_min <= {$deposit} and range_max >= {$deposit} AND package_id='{$package_id}' ");
                               if (mysqli_num_rows($plan__)>0) 
                              {    $count=true;
                                $PLAN=mysqli_fetch_assoc($plan__);
                                 if($PLAN['range_max']>=$deposit & $PLAN['range_min']<=$deposit & $count)
                                 {
                                    mysqli_query($DB_CONN,"INSERT INTO package_deposits (user_id,package_id,plan_id,amount,fee,status,payment_method_id,datetime,ip, auto_reinvest) VALUES ('{$user_id}','{$package_id}','{$PLAN['id']}','{$deposit}','{$fee}',0,'{$payment_method_id}','{$dt}','{$ip}', '{$_POST['auto_reinvest']}')");
                                    $id = mysqli_insert_id($DB_CONN);
                                    $txn_id = $_POST['txn_id'] ? : "$currency.' Account Balance";
                                    activate_package($id, $deposit, $fee, $txn_id, $user_id, $payment_method_id, $package_id, $PLAN['id'], $method, '', 'invest', $_POST['refferal']);
                                    // if (isset($_POST['inform']) && $_POST['inform'])
                                    //  sendmail("invest_user_notification", $id);
                                    if (isset($_POST['balance_deduct']) && $_POST['balance_deduct'])
                                        add_balance($user_id, $payment_method_id, -$deposit);
                                    echo "<div class='alert alert-success'> <strong>Success - </strong> Funds added Successfully </div>";
                                 }
                             }
                           }
                        }
                    }
                    break;
                    break;
                case 'earning':
                    foreach ($users as $userid => $value)
                    {
                        $detail = "Bonus Earning {$_POST['desc']}";
                        $earnings = mysqli_query($DB_CONN, "INSERT INTO transactions (`detail`, user_id,package_id,plan_id, payment_method_id,amount,status,txn_type, ref_id) Values('{$detail}','{$userid}','','','{$payment_method_id}','{$amount}',1, 'earning', '-1')") or die(mysqli_error($DB_CONN));
                        add_balance($userid, $payment_method_id, $amount);
                    }
                    echo "<div class='alert alert-success'> <strong>Success - </strong> Earning added Successfully </div>";
                    break;
                case 'commissions':
                    foreach ($users as $userid => $value)
                    {
                        $detail = "Referral commission {$_POST['desc']}";
                        mysqli_query($DB_CONN, "INSERT INTO `transactions`(`detail`, `user_id`, `amount`, `payment_method_id`,`txn_type`, `ref_id`) VALUES ('{$detail}','{$userid}','{$amount}', '{$payment_method_id}', 'referral', '-1')");
                        add_balance($userid, $payment_method_id, $amount);
                        if (isset($_POST['inform']) && $_POST['inform'])
                            sendmail("referral_commision_notification", $userid, array(), array('amount' => $amount));
                    }
                    echo "<div class='alert alert-success'> <strong>Success - </strong> Commission added Successfully </div>";
                    break;
                case 'penalty':
                    foreach ($users as $userid => $value)
                    {
                        $detail = "Penalty {$_POST['desc']}";
                        $earnings = mysqli_query($DB_CONN, "INSERT INTO transactions (`detail`, user_id,package_id,plan_id, payment_method_id,amount,status,txn_type, ref_id) Values('{$detail}','{$userid}','','','{$payment_method_id}','{$amount}',1, 'penalty', '-1')");
                        add_balance($userid, $payment_method_id, -$amount);
                        if (isset($_POST['inform']) && $_POST['inform']) sendmail("penalty", $userid, array(), array('amount' => $amount));
                    }
                    echo " <div class='alert alert-success'> <strong>Success - </strong> Penalty added Successfully </div>";
                    break;
                case 'withdraw_request':
                  $method = mysqli_query($DB_CONN, "SELECT * from currencies where id = '{$payment_method_id}'");
                  $method = mysqli_fetch_assoc($method);
                    foreach ($users as $userid => $value)
                    {
                        $detail = "Withdraw Requested {$_POST['desc']}";
                        $earnings = mysqli_query($DB_CONN, "INSERT INTO transactions (`detail`, user_id,package_id,plan_id, payment_method_id,amount,status,txn_type, ref_id) VALUES('{$detail}','{$userid}','','','{$payment_method_id}','{$amount}',0, 'withdraw', '-1')");
                        if($_POST['balance_deduct'])
                            add_balance($userid, $payment_method_id, -$amount);
                        if (isset($_POST['inform']) && $_POST['inform'])
                            sendmail("withdraw_request_user_notification", $userid, array(), array('amount' => $amount, 'account' => $method['name'], 'address' => '', 'dt' => $dt));
                    }
                    echo " <div class='alert alert-success'> <strong>Success - </strong> Withdraw added Successfully </div>";
                    break;
                }
            endif;
        }

?>
                            <? if ($admin_settings['anpass'])
        { ?>
                    <form method="POST" action="">
                        <div class="row">
                             <div class="col-md-2">
                                        <div class="form-group">
                                            <label class="fs-9"> Transaction Type </label>
                                        </div>
                                    </div>
                              <div class="col-md-6">
                                            <select name="trans_type" class="form-control form-select" onchange="chng_type()" <?=isset($_GET['type']) ? 'readonly' : '' ?>>
                                            <option value="bonus" <?=$_GET['type'] == 'b' ? 'selected' : '' ?>>Bonus</option>
                                            <option value="deposit" <?=$_GET['type'] == 'bonus' ? 'selected' : '' ?>>Invest</option>
                                            <option value="earning" <?=$_GET['type'] == 'e' ? 'selected' : '' ?>>Earning</option>
                                            <option value="commissions" <?=$_GET['type'] == 'c' ? 'selected' : '' ?>>Referral Commission</option>
                                            <option value="penalty" <?=$_GET['type'] == 'p' ? 'selected' : '' ?>>Penalty</option>
                                            <option value="withdraw_request" <?=$_GET['type'] == 'w' ? 'selected' : '' ?>>Withdraw Request</option>
                                        </select>
                                        <small id="emailHelp" class="form-text text-muted fs-9">Select Transaction Type</small>
                                    </div>
                                    <div class="col-md-4">
                                           <div class="alert alert-danger py-0 Bonus" role="alert">
                                            <small class="mb-0"><b>Bonus</b> will be added to user account balance, which can be used to withdraw to make a new deposit</small> 
                                        </div>
                                          <div class="alert alert-success py-0 add" role="alert">
                                            <small class="mb-0"><b>Add Funds</b> will be added as a new active deposit for a user and user can withdraw that amount until he recieves earning</small> 
                                        </div>
                                        <div class="alert alert-warning py-0 Earnings" role="alert">
                                            <small class="mb-0"><b>Earnings</b> will be added to users account balance, which can be used to withdraw to make a new deposit</small> 
                                        </div>
                                        <div class="alert alert-secondary py-0 Referral" role="alert">
                                            <small class="mb-0"><b>Referral Commission</b> will be added to users account balance, which can be used to withdraw to make a new deposit</small> 
                                        </div>
                                        <div class="alert alert-primary py-0 Penalty" role="alert">
                                            <small class="mb-0"><b>Penalty</b> will be deducted from users account balance, it will not affect his active deposit amount.</small> 
                                        </div>

                                    </div>
                                    </div>
                                    <div class="row">
                                          <div class="col-md-2 package">
                                        <div class="form-group">
                                            <label class="fs-9"> Select Package  </label>
                                        </div>
                                    </div>
                                        <div class="col-md-6 package">
                                            <select name="package_id" class="form-control">
                                                <option value="">-- Select Investment Plan --</option>
                                                <?php
            $package_ = mysqli_query($DB_CONN, "select * from packages order by id desc") or die(mysqli_error($DB_CONN));
            while ($package = mysqli_fetch_assoc($package_))
            {
                echo "<option value=\"{$package['id']}\">{$package['name']}</option>";
            }
?>
                                            </select>
                                            <small id="emailHelp" class="form-text text-muted fs-9">Please select Package in which you want to deposit.</small>
                                        </div>
                                   <div class="col-md-4">
                                        <div class="alert alert-primary py-0 package" role="alert">
                                            <small class="mb-0"><b>Plan</b> Select the Investment Plan in which you want to make deposit</small> 
                                        </div>

                                    </div>
                       </div>
                            <div class="row package" >
                                       <div class="col-md-2">
                                        <div class="form-group">
                                            <label class="fs-9"> Transaction </label>
                                        </div>
                                    </div>
                                        <div class="col-md-10">
                                            <input type="text" name="txn_id" value=""  class="form-control"  />
                                             <small id="emailHelp" class="form-text text-muted fs-9">Transaction If any (For Deposits)</small>
                                        </div>
                                       </div> 
                                <div class="row">
                                            <div class="col-md-2">
                                        <div class="form-group">
                                            <label class="fs-9"> Send to </label>
                                        </div>
                                    </div>
                                        <div class="col-md-10">
                                            <select name="to" id="to_inpt" class="form-control" onchange="toggle_users()" required>
                                                <option value="">Select Option</option>
                                                <option value="all">All users</option>
                                                <option value="active">All users which have made a deposit</option>
                                                <option value="passive">All users which have not made a deposit</option>
                                                <option value="users" <?=isset($_GET['user_id']) ? 'selected' : '' ?>>Specified users (enter usernames below)</option>
                                            </select>
                                            <small id="emailHelp" class="form-text text-muted fs-9">Please select user option</small>
                                        </div>
                                        <div class="col-md-2 users" >
                                        <div class="form-group">
                                            <label class="fs-9"> Enter Usernames </label>
                                        </div>
                                    </div>
                                        <div class="col-md-10 users" >
                                            <textarea name="usernames" class="form-control" rows="5" <?=isset($_GET['user_id']) ? 'readonly' : '' ?>><?=isset($_GET['user_id']) ? $_GET['user_id'] : '' ?></textarea>
                                            <small id="emailHelp" class="form-text text-muted fs-9">One username per line</small>
                                        </div>
                                      </div>  
                                      
                                        <div class="row">
                                       <div class="col-md-2">
                                        <div class="form-group">
                                            <label class="fs-9"> Description </label>
                                        </div>
                                    </div>
                                        <div class="col-md-10">
                                            <input type="text" name="desc" value="" autocomplete="new-password" class="form-control"  />
                                             <small id="emailHelp" class="form-text text-muted fs-9">Description will be added in users earning/penalty</small>
                                        </div>
                                       </div>       <!--end::Form-->
                                                </div>
                                                <!--end::Card body-->
                                            </div>
                                            <!--end::Card-->
                                    </div>
                                        <!--begin::Sidebar-->
                                        <div class="flex-lg-auto min-w-lg-300px">
                                            <!--begin::Card-->
                                            <div class="card" data-kt-sticky="true" data-kt-sticky-name="invoice" data-kt-sticky-offset="{default: false, lg: '200px'}" data-kt-sticky-width="{lg: '250px', lg: '300px'}" data-kt-sticky-left="auto" data-kt-sticky-top="150px" data-kt-sticky-animation="false" data-kt-sticky-zindex="95">
                                                <!--begin::Card body-->
                                                <div class="card-body p-10">
                                                    
                                                    <div class="row">
                                                          <div class="col-md-2">
                                        <div class="form-group">
                                            <label class="fs-9"> Amount (<?=$preferences['symbol'] ?>) </label>
                                        </div>

                                    </div>
                                        <div class="col-md-10">
                                            <input type="text" required="" name="amount" value="" class="form-control" />
                                            <small id="emailHelp" class="form-text text-muted fs-9">Please enter the transaction amount</small>
                                        </div>
                                                    </div>
                                                        <div class="separator separator-dashed mb-8"></div>
                                                        
                                                    <!--begin::Input group-->
                                                    <div class="mb-10">
                                                        <!--begin::Label-->
                                                        <label class="form-label fw-bold fs-8 text-gray-700">Payment method</label>
                                                        <!--end::Label-->
                                                        <!--begin::Select-->
                                                
                                                         <select name="payment_method_id" class="form-select form-select-solid">
                <?php $select_method = mysqli_query($DB_CONN, "SELECT *from currencies where de_pm_id != 0");
            while ($row_method = mysqli_fetch_assoc($select_method))
            { ?>
                        <option value="<?php echo $row_method['id'] ?>"> <?php echo $row_method['name'] ?> </option>
                <?php
            } ?>  
            </select>
            <small id="emailHelp" class="form-text text-muted fs-9">Please select Payment method in which you want to add transaction</small>
                                                    </div>
                                                    <!--end::Input group-->
                                                    <!--begin::Separator-->
                                                    <div class="separator separator-dashed mb-8"></div>
                                                    <!--end::Separator-->
                                                    <!--begin::Input group-->
                                                    <div class="mb-8">
                                                        <!--begin::Option-->
                                                        <label class="form-check form-switch form-switch-sm form-check-custom form-check-solid flex-stack mb-5">
                                                            <span class="form-check-label ms-0 fw-bold fs-8 text-gray-700">Add Referral Commission</span>
                                                            <input class="form-check-input" type="checkbox" name="refferal" value="1">
                                                        </label>
                                                        <!--end::Option-->
                                                        <!--begin::Option-->
                                                        <label class="form-check form-switch form-switch-sm form-check-custom form-check-solid flex-stack mb-5">
                                                            <span class="form-check-label ms-0 fw-bold fs-8 text-gray-700">Send Notification</span>
                                                            <input class="form-check-input" type="checkbox" name="inform" value="1">
                                                        </label>
                                                        <!--end::Option-->
                                                        <!--begin::Option-->
                                                        <label class="form-check form-switch form-switch-sm form-check-custom form-check-solid flex-stack mb-5">
                                                            <span class="form-check-label ms-0 fw-bold fs-8 text-gray-700">Balance Deduct</span>
                                                            <input class="form-check-input" type="checkbox" name="balance_deduct" value="1">
                                                        </label>
                                                        <!--end::Option-->
                                                        
                                                    </div>
                                                    <!--end::Input group-->
                                                    <!--begin::Separator-->
                                                    <div class="separator separator-dashed mb-8"></div>
                                                    <!--end::Separator-->
                                                    <? if ($admin_settings['anpass'])
            { ?>
                                                    <div class="row">
                                <div class="col-md-2">
                                        <div class="form-group">
                                            <label class="fs-9">  Code </label>
                                        </div>
                                    </div>
                                        <div class="col-md-10 ">
                                            <input required="" type="password" name="alternative_passphrase" autocomplete="new-password" class="form-control nosize"  />
                                        <small id="emailHelp" class="form-text text-muted fs-9">Please enter Admin Alternative Passpharse you setup in your site settings </small>
                                    </div>
                                        </div>
                                    <?
            } ?>
                                        <div class="separator separator-dashed mb-8"></div>
                                                    <!--begin::Actions-->
                                                    <div class="mb-0">
                                                        <!--begin::Row-->
                                                    
                                                        <!--end::Row-->
                                                        <button type="submit" name="submit" class="btn btn-primary w-100" id="kt_invoice_submit_button">
                                                        <i class="ki-duotone ki-triangle fs-3">
                                                            <span class="path1"></span>
                                                            <span class="path2"></span>
                                                            <span class="path3"></span>
                                                        </i>Make Transaction</button>
                                                    </div>
                                                    <!--end::Actions-->
                                                </div>
                                                <!--end::Card body-->
                                            </div>
                                            <!--end::Card-->
                                        </div>
                                        <!--end::Sidebar-->
                                
                

                        
                          
<?
        }
        else
        {
            echo "<div class='alert alert-warning'>
  Please setup Alternate Password in <a  translate='no' href='admin?page=admin' class='alert-link'>admin Settings</a> to use this page.
</div>";
        }
?>      
<script>
$(document).ready(function() {
    $('#user_id').select2();
    toggle_users();
    chng_type();
});
function toggle_users() {
    var v = $("#to_inpt").val();
    if(v == 'users')
        $(".users").show();
    else
        $(".users").hide();
}
function chng_type() {
    $("input[name=balance_deduct]").prop('checked', false);
    var t = $("select[name=trans_type]").val();
    $(".package").hide();
    $(".add").hide();
    $(".Bonus").hide();
    $(".Earnings").hide();
    $(".Referral").hide();
    $(".Penalty").hide();
    if(t == 'bonus') { 
        $(".Bonus").show();
    } else if(t == 'deposit') {
        $(".package").show();
        $(".add").show();
    } else if(t == 'earning') {
        $(".Earnings").show();
    } else if(t == 'commissions') {
        $(".Referral").show();
    } else if(t == 'penalty') {
        $(".Penalty").show();
    } else if(t == 'withdraw_request') {
        $("input[name=balance_deduct]").prop('checked', true);
    }
}
</script>
<?
    }
    if ($_GET['page'] == 'referral')
    { ?>

<?php
        $select_detail = mysqli_query($DB_CONN, "select * from preferences");
        $row_detail = mysqli_fetch_assoc($select_detail);
        $referral_settings = json_decode($row_detail['referral_settings'], true);
        $idd = $row_detail['id'];
        if (isset($_POST['submit']))
        {
           $alter = validateAdminAuth($admin_settings, $_POST['alternative_passphrase'], 'referral');

        if ($alter){
            $referral_settings = mysqli_real_escape_string($DB_CONN, json_encode($_POST['referral_settings']));
            $update_referral = mysqli_query($DB_CONN, "UPDATE preferences set referral_settings='{$referral_settings}' WHERE id='$idd'");

            if ($update_referral)
            {
                echo '<div class="alert alert-success">
      Updated Successfully ! 
</div>';
updateSiteData($siteURL);
            }

            $select_detail = mysqli_query($DB_CONN, "select * from preferences");
            $row_detail = mysqli_fetch_assoc($select_detail);
            $referral_settings = json_decode($row_detail['referral_settings'], true);
            $idd = $row_detail['id'];
        }
        }

        $select_detail = mysqli_query($DB_CONN, "select * from preferences");
        $row_detail = mysqli_fetch_assoc($select_detail);
        $referral_settings = json_decode($row_detail['referral_settings'], true);
?>                                              
                                            <form method="POST">                                            
 <div class="card">
    <div class="card-header min-h-unset py-2" role="button" >
                                            <div class="card-title m-0">
                                                <h3 class="fw-bold m-0 fs-5">Referral Settings</h3>
                                            </div>
                                        </div>
                                        
                                        <div class="card-body py-3">
                                            <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Referral Program Status</a>
                    <div class="fs-9 fw-semibold text-gray-500">Toggle the usage of referral Program.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="referral_settings[enable]" id="enable" value="true" <?=$referral_settings['enable'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="enable"></label>
                </div>
            </div>
        </div>
          <div class="separator separator-dashed my-2"></div>
          <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Profit Share System</a>
                    <div class="fs-9 fw-semibold text-gray-500">Toggle the usage of profit share system.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="referral_settings[profit_share]" id="profit_share" value="true" <?=$referral_settings['profit_share'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="profit_share"></label>
                </div>
            </div>
        </div>
          <div class="separator separator-dashed my-2"></div>
        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">If Referral Link Redirect to Register Page</a>
                    <div class="fs-9 fw-semibold text-gray-500">If a user is coming from referral link redirect to register page instead of home page..</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="referral_settings[redirect]" id="redirect" value="true" 
                    <?=$referral_settings['redirect'] == 'true' ? 'checked' : '' ?>> 
                    <label class="form-check-label fs-9" for="redirect"></label>
                </div>
            </div>
        </div>
        <div class="separator separator-dashed my-2"></div>
        
                                            <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Force an Upline/Sponsor during register</a>
                    <div class="fs-9 fw-semibold text-gray-500">Defines whether a user must have an upline to register.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="referral_settings[sponsor_must]" id="sponsor_must" value="true" <?=$referral_settings['sponsor_must'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="sponsor_must"></label>
                </div>
            </div>
        </div>
        
         <div class="separator separator-dashed my-2"></div>
                                            <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Show users traffic/registration stats</a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable for your users to view their referral link traffic to your site and how many visitors became them referrals.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="referral_settings[show_came_from]" id="show_came_from" value="true" <?=$referral_settings['show_came_from'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="show_came_from"></label>
                </div>
            </div>
        </div>
        <div class="separator separator-dashed my-2"></div>
                                            <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Pay referral commission to active users only</a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable if you wish referral commision be paid to users who made a deposit only.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="referral_settings[active_users]" id="active_users" value="1" <?=$referral_settings['active_users'] == '1' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="active_users"></label>
                </div>
            </div>
        </div>
        <div class="separator separator-dashed my-2"></div>
                                            <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Use active users only:</a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable if you wish referrals ranges counts from referrals who made a deposit only.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="referral_settings[count_referral]" id="count_referral" value="1" <?=$referral_settings['count_referral'] == '1' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="count_referral"></label>
                </div>
            </div>
        </div>
        <div class="separator separator-dashed my-2"></div>
                                            <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Referral Commission from Account balance</a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable if you do not want referral commission will be added to upline if user deposits from account balance made.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="referral_settings[reffrom_balance]" id="reffrom_balance" value="1" <?=$referral_settings['reffrom_balance'] == '1' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="reffrom_balance"></label>
                </div>
            </div>
        </div>
        
        <div class="separator separator-dashed my-2"></div>
                                           <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9"> Pay fixed referral commision amount ($) </label>
                </div>
            </div>
            <div class="col-md-8">
                <input type="amount" name="referral_settings[fixed_commission]" class="form-control form-control-sm" value="<?=$referral_settings['fixed_commission'] ?>">
                <small id="emailHelp" class="form-text text-muted fs-9">Fee to be deducted while deposit from account balance.</small>
            </div>
        </div>
        
         <div class="separator separator-dashed my-2"></div>
                                           <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9"> Referral Commission Memo  </label>
                </div>
            </div>
            <div class="col-md-8">
                <input type="amount" name="referral_settings[memo]" class="form-control form-control-sm" value="<?=$referral_settings['memo'] ? :"#ref_percentage#% Referral Commission from #ref_username# on Level #ref_level# (#ref_tier#)"; ?>">
                <small id="emailHelp" class="form-text text-muted fs-9">Availabel shortcodes : #ref_username# - #fullname# - #ref_percentage# - #ref_level# - #ref_tier# .</small>
            </div>
        </div>
    
         <div class="separator separator-dashed my-2"></div>
                                            <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Show Referral Banners</a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable for your users referral banners.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="referral_settings[show_banners]" id="show_banners" value="true" <?=$referral_settings['show_banners'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="show_banners"></label>
                </div>
            </div>
        </div>
        
    <div id="bannersDiv" style="display: <?=$referral_settings['show_banners'] == 'true' ? 'block' : 'none' ?>">
         <div class="separator separator-dashed my-2"></div>
     <div class="row mb-8">
        <div class="col-lg-4">
            <div class="d-flex flex-column">
                <label class="fs-6 fw-bold mb-2">Referral Banners</label>
                <div class="text-muted fs-7">Upload banners for your referral program</div>
            </div>
        </div>
        <div class="col-lg-8">
            <div id="banner-images-container" class="d-flex flex-wrap gap-3">
                <?php if (isset($referral_settings['banners']) && is_array($referral_settings['banners'])): ?>
                    <?php foreach ($referral_settings['banners'] as $index => $banner): ?>
                        <div class="image-input-group position-relative">
                            <button type="button" class="btn btn-icon btn-danger btn-sm position-absolute start-0 top-0 remove-banner-group" style="margin-left: -12px; margin-top: -12px; z-index: 5;">
                                <i class="ki-duotone ki-trash fs-2">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                    <span class="path3"></span>
                                    <span class="path4"></span>
                                    <span class="path5"></span>
                                </i>
                            </button>
                            <div class="image-input image-input-outline" data-kt-image-input="true">
                                <div class="image-input-wrapper banner-preview"
                                    style="background-image: url('<?= htmlspecialchars($banner['image'] ?? '') ?>'); <?= isset($banner['size']) ? "width: {$banner['size']}px; height: " . ($banner['size'] === '468' ? '60px' : ($banner['size'] === '728' ? '90px' : '125px')) . ";" : '' ?>">
                                </div>
                                <label class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                                       data-kt-image-input-action="change" data-bs-toggle="modal" data-bs-target="#kt_modal_100">
                                    <i class="ki-duotone ki-pencil fs-7">
                                        <span class="path1"></span><span class="path2"></span>
                                    </i>
                                </label>
                                <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                                      data-kt-image-input-action="remove" data-bs-toggle="tooltip" title="Remove Image">
                                    <i class="ki-outline ki-cross fs-2"></i>
                                </span>
                            </div>
                            <input type="hidden" class="banner-image-url" name="referral_settings[banners][<?= $index ?>][image]" 
                                   value="<?= htmlspecialchars($banner['image'] ?? '') ?>">
                            <div class="mt-3">
                                <input type="text" class="form-control form-control-sm mb-2" 
                                       name="referral_settings[banners][<?= $index ?>][name]" 
                                       value="<?= htmlspecialchars($banner['name'] ?? '') ?>" 
                                       placeholder="Banner Name">
                                <select class="form-select form-select-sm banner-size-select" 
                                        name="referral_settings[banners][<?= $index ?>][size]">
                                    <option value="125x125" <?= ($banner['size'] ?? '') === '125x125' ? 'selected' : '' ?>>125x125 px - Square Banner</option>
                                    <option value="160x600" <?= ($banner['size'] ?? '') === '160x600' ? 'selected' : '' ?>>160x600 px - Wide Skyscraper</option>
                                    <option value="300x250" <?= ($banner['size'] ?? '') === '300x250' ? 'selected' : '' ?>>300x250 px - Medium Rectangle</option>
                                    <option value="336x280" <?= ($banner['size'] ?? '') === '336x280' ? 'selected' : '' ?>>336x280 px - Large Rectangle</option>
                                    <option value="468x60" <?= ($banner['size'] ?? '') === '468x60' ? 'selected' : '' ?>>468x60 px - Banner</option>
                                    <option value="728x90" <?= ($banner['size'] ?? '') === '728x90' ? 'selected' : '' ?>>728x90 px - Leaderboard</option>
                                    <option value="320x50" <?= ($banner['size'] ?? '') === '320x50' ? 'selected' : '' ?>>320x50 px - Mobile Banner</option>
                                </select>
                            </div>
                        </div>
                    <?php endforeach; ?>
                <?php endif; ?>
            </div>

            <button type="button" id="add-more-banners" class="btn btn-light-primary btn-sm mt-3">
                <i class="ki-duotone ki-plus fs-2"></i>Add More Banners
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const showBannersCheckbox = document.getElementById('show_banners');
    const bannersDiv = document.getElementById('bannersDiv');

    if (showBannersCheckbox) {
        showBannersCheckbox.addEventListener('change', function() {
            bannersDiv.style.display = this.checked ? 'block' : 'none';
        });
    }

    document.getElementById('add-more-banners').addEventListener('click', function() {
        const container = document.getElementById('banner-images-container');
        const newIndex = container.children.length;
        const newImageGroup = document.createElement('div');
        newImageGroup.className = 'image-input-group position-relative';
        
        newImageGroup.innerHTML = `
            <button type="button" class="btn btn-icon btn-danger btn-sm position-absolute start-0 top-0 remove-banner-group" style="margin-left: -12px; margin-top: -12px; z-index: 5;">
                <i class="ki-duotone ki-trash fs-2">
                    <span class="path1"></span>
                    <span class="path2"></span>
                    <span class="path3"></span>
                    <span class="path4"></span>
                    <span class="path5"></span>
                </i>
            </button>
            <div class="image-input image-input-outline" data-kt-image-input="true">
                <div class="image-input-wrapper banner-preview w-125px h-125px"
                    style="background-image: url('bitders/assets/placeholder.svg')">
                </div>
                <label class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                       data-kt-image-input-action="change" data-bs-toggle="modal" data-bs-target="#kt_modal_100">
                    <i class="ki-duotone ki-pencil fs-7">
                        <span class="path1"></span><span class="path2"></span>
                    </i>
                </label>
                <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" 
                      data-kt-image-input-action="remove" data-bs-toggle="tooltip" title="Remove Image">
                    <i class="ki-outline ki-cross fs-2"></i>
                </span>
            </div>
            <input type="hidden" class="banner-image-url" name="referral_settings[banners][${newIndex}][image]" value="">
            <div class="mt-3">
                <input type="text" class="form-control form-control-sm mb-2" 
                       name="referral_settings[banners][${newIndex}][name]" 
                       placeholder="Banner Name">
                <select class="form-select form-select-sm banner-size-select" 
                        name="referral_settings[banners][${newIndex}][size]">
                    <option value="125x125">125x125 px - Square Banner</option>
                    <option value="160x600">160x600 px - Wide Skyscraper</option>
                    <option value="300x250">300x250 px - Medium Rectangle</option>
                    <option value="336x280">336x280 px - Large Rectangle</option>
                    <option value="468x60">468x60 px - Banner</option>
                    <option value="728x90">728x90 px - Leaderboard</option>
                    <option value="320x50">320x50 px - Mobile Banner</option>
                </select>
            </div>
        `;
        
        container.appendChild(newImageGroup);
        
        if (typeof KTImageInput !== 'undefined') {
            KTImageInput.createInstances();
        }

        // Add event listener for the new size select
        const newSelect = newImageGroup.querySelector('.banner-size-select');
        newSelect.addEventListener('change', updateBannerSize);
    });

    // Handle banner size changes
    function updateBannerSize(e) {
        const select = e.target;
        const wrapper = select.closest('.image-input-group').querySelector('.banner-preview');
        const size = select.value;
        const [width, height] = size.split('x');
        
        wrapper.style.width = `${width}px`;
        wrapper.style.height = `${height}px`;
    }

    // Add event listeners to existing size selects
    document.querySelectorAll('.banner-size-select').forEach(select => {
        select.addEventListener('change', updateBannerSize);
    });

    // Handle banner removal
    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-banner-group')) {
            const imageGroup = e.target.closest('.image-input-group');
            imageGroup.remove();
            
            // Reindex remaining banners
            const container = document.getElementById('banner-images-container');
            const remainingBanners = container.querySelectorAll('.image-input-group');
            remainingBanners.forEach((banner, index) => {
                const imageInput = banner.querySelector('.banner-image-url');
                const nameInput = banner.querySelector('[name$="[name]"]');
                const sizeSelect = banner.querySelector('[name$="[size]"]');
                
                if (imageInput) imageInput.name = `referral_settings[banners][${index}][image]`;
                if (nameInput) nameInput.name = `referral_settings[banners][${index}][name]`;
                if (sizeSelect) sizeSelect.name = `referral_settings[banners][${index}][size]`;
            });
        }
    });
});
</script>
</div>
</div>
                                        
     <div class="card mt-2">
         <script language=javascript>
function go(p)
{
  document.opts.page.value = p;
  document.opts.submit();
}
</script>
   <div class="card-header min-h-unset py-0">
    <h3 class="card-title align-items-start flex-column">
        <span class="card-label fw-bold fs-3 mb-1">Referral System</span>
        <span class="text-muted mt-1 fw-semibold fs-7"></span>
    </h3>
    <div class="card-toolbar" >
        <ul class="nav" role="tablist">
                    <li class="nav-item" >
                     <label  class="form-label">Levels</label>
    <select class="form-select form-select-sm" name="referral_settings[levels]" >

<?php for ($i = 1; $i <= 20; $i++): ?>
    <option value="<?php echo $i; ?>" <?php echo $referral_settings['levels'] == $i ? 'selected' : '' ?>><?php echo $i; ?></option>
<?php endfor; ?>
</select>
    </li> 
    <li class="nav-item mx-5" >
    <label  class="form-label ">Tiers</label>
<select class="form-select form-select-sm"  name="referral_settings[tiers]" >

<?php for ($i = 1; $i <= 20; $i++): ?>
    <option value="<?php echo $i; ?>" <?php echo $referral_settings['tiers'] == $i ? 'selected' : '' ?>><?php echo $i; ?></option>
<?php endfor; ?>
</select>
</li>
<li class="nav-item" >
<label  class="form-label">System</label>
    <select class="form-select form-select-sm"  name="referral_settings[system]" >
    <option value="normal" <?php echo $referral_settings['system'] == 'normal' ? 'selected' : '' ?>>Normal</option>
    <option value="ranges"  <?php echo $referral_settings['system'] == 'ranges' ? 'selected' : '' ?>>Ranges</option>
   
</select>
    </li>
        <li class="nav-item mx-2" >
 <input class="btn btn-primary btn-sm mt-6" type="submit" name="submit" value="UPDATE ">
    </li>
    
</ul>
    </div>
</div>
<div class="card-body py-3">
  
    <div class="table-responsive">
        <table class="table table-striped table-bordered">
    <!-- Header row with main column groups -->
    <tr class="fw-bold text-muted bg-light">
        <td rowspan="2" class="align-middle">Tiers</td>
        <td colspan="<?php echo $referral_settings['system'] == 'normal' ? '1' : '5' ?>" class="text-center">Account Tier Name</td>
        <?php for ($i = 1; $i <= $referral_settings['levels']; $i++) { ?>
            <td class="text-center">Level <?= $i ?></td>
        <?php } ?>
    </tr>
    <!-- Subheader row -->
    <tr class="fw-bold text-muted bg-light">
        <td colspan="<?php echo $referral_settings['system'] == 'normal' ? '1' : '5' ?>" class="text-center text-muted">Tier name (Can be any)</td>
        <?php for ($i = 1; $i <= $referral_settings['levels']; $i++) { ?>
            <td class="text-center text-muted">Commission (%)</td>
        <?php } ?>
    </tr>

    <?php for ($i = 1; $i <= $referral_settings['tiers']; $i++) { ?>
        <!-- Tier <?= $i ?> Name Row -->
        <tr>
            <td rowspan="<?php echo $referral_settings['system'] == 'normal' ? '1' : '3' ?>" class="align-middle">Tier <?= $i ?></td>
            <td colspan="<?php echo $referral_settings['system'] == 'normal' ? '1' : '5' ?>">
                <input type="text" name="referral_settings[tier][<?= $i ?>][name]" 
                       value="<?php echo isset($referral_settings['tier'][$i]['name']) ? $referral_settings['tier'][$i]['name'] : 'Tier '.$i; ?>" 
                       class="form-control form-control-sm" />
            </td>
            <?php for ($l = 1; $l <= $referral_settings['levels']; $l++) { ?>
                <td rowspan="<?php echo $referral_settings['system'] == 'normal' ? '1' : '3' ?>">
                    <input type="text" name="referral_settings[tier][<?= $i ?>][level][<?= $l ?>]" 
                           value="<?php echo isset($referral_settings['tier'][$i]['level'][$l]) ? $referral_settings['tier'][$i]['level'][$l] : ''; ?>" 
                           class="form-control form-control-sm" />
                </td>
            <?php } ?>
        </tr>
        
        <?php if ($referral_settings['system'] == 'ranges') { ?>
            <!-- Tier <?= $i ?> Headers Row -->
            <tr>
                <td>User Investment</td>
                <td>Referral Investments</td>
                <td>No of Sponsors</td>
                <td>No of Total Team</td>
                <td>No of Indirect Referrals</td>
            </tr>
            <!-- Tier <?= $i ?> Values Row -->
            <tr>
                <td>
                    <input type="text" name="referral_settings[tier][<?= $i ?>][invested]" 
                           value="<?php echo isset($referral_settings['tier'][$i]['invested']) ? $referral_settings['tier'][$i]['invested'] : ''; ?>" 
                           class="form-control form-control-sm" />
                </td>
                <td>
                    <input type="text" name="referral_settings[tier][<?= $i ?>][investments]" 
                           value="<?php echo isset($referral_settings['tier'][$i]['investments']) ? $referral_settings['tier'][$i]['investments'] : ''; ?>" 
                           class="form-control form-control-sm" />
                </td>
                <td>
                    <input type="text" name="referral_settings[tier][<?= $i ?>][sponsors]" 
                           value="<?php echo isset($referral_settings['tier'][$i]['sponsors']) ? $referral_settings['tier'][$i]['sponsors'] : ''; ?>" 
                           class="form-control form-control-sm" />
                </td>
                <td>
                    <input type="text" name="referral_settings[tier][<?= $i ?>][referrals]" 
                           value="<?php echo isset($referral_settings['tier'][$i]['referrals']) ? $referral_settings['tier'][$i]['referrals'] : ''; ?>" 
                           class="form-control form-control-sm" />
                </td>
                <td>
                    <input type="text" name="referral_settings[tier][<?= $i ?>][indirect_referrals]" 
                           value="<?php echo isset($referral_settings['tier'][$i]['indirect_referrals']) ? $referral_settings['tier'][$i]['indirect_referrals'] : ''; ?>" 
                           class="form-control form-control-sm" />
                </td>
            </tr>
        <?php } ?>
    <?php } ?>
</table>
     </div>
      <?php if($referral_settings['system'] == 'ranges'){ ?>
       <div class="separator separator-dashed my-2"></div>
            <div class="d-flex flex-stack">
        <div class="d-flex">
            <div class="d-flex flex-column">
                <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">If any of Range trigger Upgrade User Tier</a>
                <div class="fs-9 fw-semibold text-gray-500">if any of User Investment, Referral Investments, No of Active Referral trigger Upgrade the Tier for User .</div>
            </div>
        </div>
        <div class="d-flex justify-content-end">
            <div class="form-check form-check-solid form-check-custom form-switch">
                <input class="form-check-input w-45px h-30px" type="checkbox" name="referral_settings[trigger]" id="trigger" value="true" <?=$referral_settings['trigger'] == 'true' ? 'checked' : '' ?>>
                <label class="form-check-label fs-9" for="trigger"></label>
            </div>
        </div>
    </div>
    <?php } ?>
    <div class="separator separator-dashed my-2"></div>
                                           <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9"> Min Deposit Amount ($) </label>
                </div>
            </div>
            <div class="col-md-8">
                <input type="amount" name="referral_settings[min_deposit]" class="form-control form-control-sm" value="<?=$referral_settings['min_deposit'] ?>">
                <small id="emailHelp" class="form-text text-muted fs-9">Min Deposit amount. For ex. if set 10$ then all deposits less then 10$ will not be provided referral.</small>
            </div>
        </div>
        
           <div class="separator separator-dashed my-2"></div>
                                           <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9"> Max referral commission amount ($) </label>
                </div>
            </div>
            <div class="col-md-8">
                <input type="amount" name="referral_settings[max_commission]" class="form-control form-control-sm" value="<?=$referral_settings['max_commission'] ?>">
                <small id="emailHelp" class="form-text text-muted fs-9">Max Referral commission amount. For ex. if set 100$ commission higher than $100 will not be added.</small>
            </div>
        </div>
          </div>
                        
      <?php if ($admin_settings['page']['referral']) { ?>
     
     <div class="row card card-body">
         <div class="row">
            <div class="col-md-2">
                <div class="form-group">
                    <label class="fs-9"> Current Alternate Password </label>
                </div>
            </div>
          
            <div class="col-md-10">
                <input type="password" name="alternative_passphrase" value="" class="form-control form-control-sm" required=""/>
                <small id="emailHelp" class="form-text text-muted fs-9"> </small>
            </div>
            </div>
           </div>
  <? } ?>              
            <div class="card-footer d-flex justify-content-end py-2 px-9">
      <input class="btn btn-primary btn-sm me-2" type="submit" name="submit" value="UPDATE ">
   
</div>                              
                                        
                                            
                                            
                                            
                                                </div>  <!--end::dflex -->
    </form>
  
<?
    }
    if ($_GET['page'] == 'push_alerts')
    {

    if (isset($_POST['submit']))
    {
        $push = mysqli_real_escape_string($DB_CONN, json_encode($_POST['push']));
        $update_alert = mysqli_query($DB_CONN, "UPDATE preferences set alerts_settings ='{$push}' limit 1");
        if ($update_alert)
        {
            echo '<br><div class="alert alert-success">
      Updated Successfully ! 
</div>';
        }
    }
    $pref = mysqli_query($DB_CONN, "select * from preferences where id='1' limit 1") or die(mysqli_error($DB_CONN));
    $push = json_decode(mysqli_fetch_assoc($pref) ['alerts_settings'], true);


?>
 <div class="card mb-2">
                                        <div class="card-header min-h-unset py-2">
                                            <div class="card-title m-0">
                                                <h3 class="card-title align-items-start flex-column m-0">
                                                        <span class="card-label fw-bold text-gray-900">Push Alerts Settings</span>
                                                        <span class="text-gray-500 mt-1 fw-semibold fs-6">Push Alerts Templates can be edited on <a  href="admin?page=templates">Alerts Templates page</a></span>
                                                    </h3>
                                            </div>
                                        </div>
                                <div class="card-body">
                                    <form method="POST">
                                          <div class="row">
                         
                            
                     
  <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Enable Push Alerts</a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable to send Push Alerts to users</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="push[enable]" id="trigger" value="true" <?=$push['enable'] == 'true' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="trigger"></label>
                </div>
            </div>
        </div>
 <div class="separator separator-dashed my-2"></div>   
<div class="row mt-5" id="one">
        <label class="fs-5 mb-3"> One Signal Push Alerts  </label>
<div class="col-md-2">
      <label class="fs-9"> One Signal App ID </label>
    </div>
    <div class="col-md-10">
      <input type="text" style="border: 1px solid lightgrey" name="push[onesignal_app_id]" value="<?php echo $push['onesignal_app_id'] ?>" class="form-control form-control-sm">
      <small class="help-block text-muted">go to settings --> Keys & IDS. OneSignal App ID</small>
</div>
<div class="separator separator-dashed my-2"></div>
<div class="col-md-2">
      <label class="fs-9"> One Signal Rest API Key </label>
    </div>
    <div class="col-md-10">
      <input type="text" style="border: 1px solid lightgrey" name="push[onesignal_app_key]" value="<?php echo $push['onesignal_app_key'] ?>" class="form-control form-control-sm">
      <small class="help-block text-muted">go to settings --> Keys & IDS. Copy Rest API KEY</small>
    </div>

</div>

<div class="row mt-5" id="VAPID">
        <label class="fs-5 mb-3">VAPID Push Alerts  </label>
<div class="col-md-2">
      <label class="fs-9"> VAPID App ID </label>
    </div>
    <div class="col-md-10">
      <input type="text" style="border: 1px solid lightgrey" name="push[VAPID_PUBLIC_KEY]" value="<?php echo $push['VAPID_PUBLIC_KEY'] ?>" class="form-control form-control-sm">
      <small class="help-block text-muted">go to settings --> Keys & IDS. OneSignal App ID</small>
</div>
<div class="separator separator-dashed my-2"></div>
<div class="col-md-2">
      <label class="fs-9"> VAPID Rest API Key </label>
    </div>
    <div class="col-md-10">
      <input type="text" style="border: 1px solid lightgrey" name="push[VAPID_PRIVATE_KEY]" value="<?php echo $push['VAPID_PRIVATE_KEY'] ?>" class="form-control form-control-sm">
      <small class="help-block text-muted">go to settings --> Keys & IDS. Copy Rest API KEY</small>
    </div>

</div>



                                </div>
                                 </div>
<div class="card-footer d-flex justify-content-end py-2 px-9">
      <input class="btn btn-primary btn-sm me-2" type="submit" name="submit" value="UPDATE " >
      <input class="btn btn-secondary btn-sm" type="button" onclick="test_settings()" value="Test Settings" >
</div>
</form> 
                                       
                                </div>
                                </div>
                                
                                
 
                    <script>
  function test_settings() {
    window.open("admin?page=email&test=true&url="+$('input[name=smtp_host]').val()+"&port="+$('input[name=smtp_port]').val()+"&user="+$('input[name=smtp_user]').val()+"&pass="+$('input[name=smtp_pass]').val()+"&sec="+$('input[name=smtp_sec]').val(), "", "width=400,height=400");
  }
  function mail_ch(va) {
    if(va == 1) {
      $("#one").show();
      $("#push").hide();
    } else {
      $("#one").hide();
      $("#push").show();
    }
  }
</script>
<?
    }
    if ($_GET['page'] == 'emails')
    {
        echo getMetronicMailbox();
?>


<?
    }
    if ($_GET['page'] == 'email')
    {
?>

                                            
<?php
        $select_detail = mysqli_query($DB_CONN, "select * from preferences");
        $row_detail = mysqli_fetch_assoc($select_detail);
        $email_settings = json_decode($row_detail['email_settings'], true);
        $idd = $row_detail['id'];

        if (isset($_POST['submit']))
        {
            if ($_POST['email_settings']['smtp_pass'] != $email_settings['smtp_pass'] && $_POST['email_settings']['smtp_pass'])
                $_POST['email_settings']['smtp_pass'] = encrypt_decrypt('encrypt', $_POST['email_settings']['smtp_pass']);
          if ($_POST['email_settings']['imap_pass'] != $email_settings['imap_pass'] && $_POST['email_settings']['imap_pass'])
                $_POST['email_settings']['imap_pass'] = encrypt_decrypt('encrypt', $_POST['email_settings']['imap_pass']);
            if($_POST['email_settings']['type'] == 0)
                unset($_POST['email_settings']['smtp_host']);
            $email_settings = mysqli_real_escape_string($DB_CONN, json_encode($_POST['email_settings']));
            $update_email = mysqli_query($DB_CONN, "UPDATE preferences set email_settings='{$email_settings}' WHERE id='$idd'");

            if ($update_email)
            {
                echo '<div class="alert alert-success">
      Updated Successfully ! 
</div>';
updateSiteData($siteURL);
            }
            $select_detail = mysqli_query($DB_CONN, "select * from preferences");
            $row_detail = mysqli_fetch_assoc($select_detail);
            $email_settings = json_decode($row_detail['email_settings'], true);
            $idd = $row_detail['id'];

        }

?>
 <div class="card mb-2">
                                        <div class="card-header min-h-unset py-2">
                                            <div class="card-title m-0">
                                                <h3 class="card-title align-items-start flex-column m-0">
                                                        <span class="card-label fw-bold text-gray-900">Email Settings</span>
                                                        <span class="text-gray-500 mt-1 fw-semibold fs-6">Email Templates can be edited on <a  href="admin?page=templates">Email Templates page</a></span>
                                                    </h3>
                                            </div>
                                        </div>
                                <div class="card-body">
                                    <form method="POST">
                                          <div class="row">
                            <div class="col-md-2">
                            <div class="form-group">
                                <label for="system_email" class="control-label">From email</label>
                              </div>
                            </div>
                                <div class="col-md-10">
                                    <input type="email" class="form-control form-control-sm input-md-5" name="email_settings[from_email]" id="system_email"  value="<?php echo $email_settings['from_email'] ?>">
                                    <small id="system_email_help" class="help-block text-muted">All site messages will be sent from this email account</small>
                                </div>
                             <div class="col-md-2">
                            <div class="form-group">
                                <label for="support_email" class="control-label">Support email</label>
                              </div>
                            </div>
                                <div class="col-md-10">
                                    <input type="email" class="form-control form-control-sm input-md-5" name="email_settings[email]" id="support_email"  value="<?php echo $email_settings['email'] ?>">
                                    <small id="support_email_help" class="help-block text-muted">All support messages will be sent to this email account</small>
                                </div>
                            
                            
                            <div class="separator separator-dashed my-2"></div>    
<div class="mb-3">
    <div class="d-flex flex-stack">
        <div class="d-flex align-items-center">
            <div>
                <span class="fs-6 text-gray-900 fw-bold">Use Email Queue </span>
                <div class="fs-7 text-gray-500">System will work fast if email queue is being used.</div>
            </div>
        </div>
        <div class="form-check form-switch">
            <input class="form-check-input w-45px h-30px" type="checkbox" name="email_settings[queue]" id="queue" value="true" 
                <?php echo $email_settings['queue'] == 'true' ? 'checked' : '' ?> 
               >
        </div>
    </div>
</div>
                     <div class="separator separator-dashed my-2"></div>    

<div class="col-md-2">
      <label class="fs-9"> Mail Through </label>
    </div>
    <div class="col-md-10">
      <select name="email_settings[type]" class="form-select form-select-sm" onchange="mail_ch(this.value)">
        <option value="0" <?php echo $email_settings['type'] == 0 ? 'selected' : '' ?>>PHP mail() function</option>
        <option value="1" <?php echo $email_settings['type'] == 1 ? 'selected' : '' ?>>SMTP Server</option>
      </select>
      <small class="text-muted">Php Mail Fucntion or SMTP</small>
</div>
<div class="row mt-5" id="smtp" <? if ($email_settings['smtp_host'] == '') echo 'style="display: none;"'; ?>>
    <div class="col-md-2">
        <label class="fs-9"> SMTP HOST </label>
    </div>
    <div class="col-md-10">
        <input type="text" name="email_settings[smtp_host]" value="<?php echo $email_settings['smtp_host'] ?>" class="form-control form-control-sm">
        <small class="help-block text-muted">mail.domain.com or your smtp host name</small>
    </div>
    <div class="col-md-2">
        <label class="fs-9"> SMTP USER </label>
    </div>
    <div class="col-md-10">
        <input type="text" name="email_settings[smtp_user]" value="<?php echo $email_settings['smtp_user'] ?>" class="form-control form-control-sm">
        <small class="help-block text-muted">admin@yourdomain.com or the smtp username</small>
    </div>
    <div class="col-md-2">
        <label class="fs-9"> SMTP PASS </label>
    </div>
    <div class="col-md-10">
        <input type="password" name="email_settings[smtp_pass]" value="<?php echo $email_settings['smtp_pass'] ?>" class="form-control form-control-sm">
        <small class="help-block text-muted">smtp password</small>
    </div>
    <div class="col-md-2">
        <label> SMTP Protocol</label>
    </div>
    <div class="col-md-10">
        <input type="text" name="email_settings[smtp_sec]" value="<?php echo $email_settings['smtp_sec'] ?>" class="form-control form-control-sm">
        <small class="help-block text-muted">Type TLS or SSL - SSL (Secure Socket Layer) and TLS (Transport Layer Security)</small>
    </div>
    <div class="col-md-2">
        <label class="fs-9"> SMTP PORT </label>
    </div>
    <div class="col-md-10">
        <input type="text" name="email_settings[smtp_port]" value="<?php echo $email_settings['smtp_port'] ?>" class="form-control form-control-sm">
        <small class="help-block text-muted">For TLS port is 587 and for SSL it's 465. Type port according to your smtp provider setting.</small>
    </div>
    
    <div class="col-12 mt-5">
        <button type="button" class="btn btn-sm btn-light-primary" onclick="testSmtpConnection()">
            <span class="indicator-label">
                Test SMTP Connection
            </span>
            <span class="indicator-progress">
                Please wait... <span class="spinner-border spinner-border-sm align-middle ms-2"></span>
            </span>
        </button>
    </div>
</div>
<div class="separator separator-dashed my-2"></div>    
<div class="mb-3">
    <div class="d-flex flex-stack">
        <div class="d-flex align-items-center">
            <div>
                <span class="fs-6 text-gray-900 fw-bold">Setup IMAP </span>
                <div class="fs-7 text-gray-500">Setup IMAP to receive emails in Telegram.</div>
            </div>
        </div>
        <div class="form-check form-switch">
            <input class="form-check-input w-45px h-30px" type="checkbox" name="email_settings[imap]" id="imapToggle" value="true" 
                <?php echo $email_settings['imap'] == 'true' ? 'checked' : '' ?> 
                onchange="toggleImapSettings(this)">
        </div>
    </div>
</div>

<div class="row mt-5" id="imapSettings" style="display: <?php echo $email_settings['imap'] == 'true' ? 'flex' : 'none'; ?>">
    <div class="col-md-2">
        <label class="fs-9"> IMAP HOST </label>
    </div>
    <div class="col-md-10">
        <input type="text" name="email_settings[imap_host]" value="<?php echo $email_settings['imap_host'] ?>" class="form-control form-control-sm">
        <small class="help-block text-muted">imap.domain.com or your imap host name</small>
    </div>

    <div class="col-md-2">
        <label class="fs-9"> IMAP USER </label>
    </div>
    <div class="col-md-10">
        <input type="text" name="email_settings[imap_user]" value="<?php echo $email_settings['imap_user'] ?>" class="form-control form-control-sm">
        <small class="help-block text-muted">admin@yourdomain.com or the imap username</small>
    </div>

    <div class="col-md-2">
        <label class="fs-9"> IMAP PASS </label>
    </div>
    <div class="col-md-10">
        <input type="password" name="email_settings[imap_pass]" value="<?php echo $email_settings['imap_pass'] ?>" class="form-control form-control-sm">
        <small class="help-block text-muted">imap password</small>
    </div>

    <div class="col-md-2">
        <label class="fs-9"> IMAP Protocol</label>
    </div>
    <div class="col-md-10">
        <select name="email_settings[imap_secure]" class="form-select form-select-sm">
            <option value="ssl" <?php echo ($email_settings['imap_secure'] ?? 'ssl') == 'ssl' ? 'selected' : ''; ?>>SSL</option>
            <option value="tls" <?php echo ($email_settings['imap_secure'] ?? '') == 'tls' ? 'selected' : ''; ?>>TLS</option>
        </select>
        <small class="help-block text-muted">SSL is recommended and default</small>
    </div>

    <div class="col-md-2">
        <label class="fs-9"> IMAP PORT </label>
    </div>
    <div class="col-md-10">
        <input type="text" name="email_settings[imap_port]" value="<?php echo $email_settings['imap_port'] ?? '993' ?>" class="form-control form-control-sm">
        <small class="help-block text-muted">Default port is 993 for SSL</small>
    </div>

    <div class="col-12 mt-5">
        <button type="button" class="btn btn-sm btn-light-primary" onclick="testImapConnection()">
            <span class="indicator-label">
                Test IMAP Connection
            </span>
            <span class="indicator-progress">
                Please wait... <span class="spinner-border spinner-border-sm align-middle ms-2"></span>
            </span>
        </button>
    </div>
</div>
<div class="separator separator-dashed my-2"></div>
 <div class="col-md-2 mt-2">
                            <div class="form-group">
                                <label for="site_email_header" class="control-label">Site email header</label>
                              </div>
                            </div>
                                <div class="col-md-10 mt-2">
                                <textarea class="form-control form-control-sm input-md-6" name="email_settings[header]" id="site_email_header" rows="10" placeholder=""><?php echo $email_settings['header']; ?></textarea>
                                <small class="help-block text-muted">Text and HTML both supported</small>
                                </div>
                                <div class="separator separator-dashed my-2"></div>
                            <div class="col-md-2 mt-2">
                            <div class="form-group">
                                <label for="site_email_footer" class="control-label">Site email footer</label>
                              </div>
                            </div>
                                <div class="col-md-10 mt-2">
                                <textarea class="form-control form-control-sm input-md-6" name="email_settings[footer]" id="site_email_footer" rows="10" placeholder=""><?=$email_settings['footer'] ?></textarea>
                                 <small class="help-block text-muted">Text and HTML both supported</small>
                                </div>
                                </div>
                               
<div class="card-footer d-flex justify-content-end py-2 px-9">
      <input class="btn btn-primary btn-sm me-2" type="submit" name="submit" value="UPDATE " >
</div>
</form> 
                                       
                                </div>
                                </div>
                                  </div>
                                
 
                    <script>
  
  function mail_ch(va) {
    if(va == 1) {
      $("#smtp").show();
    } else {
      $("#smtp").hide();
    }
  }
</script>
<script>
// Toggle IMAP settings visibility
function toggleImapSettings(checkbox) {
    const imapSettings = document.getElementById('imapSettings');
    imapSettings.style.display = checkbox.checked ? 'flex' : 'none';
    
    // Clear fields if disabled
    if (!checkbox.checked) {
        const inputs = imapSettings.querySelectorAll('input[type="text"], input[type="password"]');
        inputs.forEach(input => input.value = '');
    }
}
function testSmtpConnection() {
    const btn = event.target;
    
    const fields = {
        smtp_host: document.querySelector('input[name="email_settings[smtp_host]"]').value,
        smtp_user: document.querySelector('input[name="email_settings[smtp_user]"]').value,
        smtp_pass: document.querySelector('input[name="email_settings[smtp_pass]"]').value,
        smtp_secure: document.querySelector('input[name="email_settings[smtp_sec]"]').value,
        smtp_port: document.querySelector('input[name="email_settings[smtp_port]"]').value
    };

    if (!fields.smtp_host || !fields.smtp_user || !fields.smtp_pass) {
        Swal.fire({
            text: "Please fill in all required SMTP fields.",
            icon: "error",
            buttonsStyling: false,
            confirmButtonText: "Ok, got it!",
            customClass: {
                confirmButton: "btn btn-primary"
            }
        });
        return;
    }

    btn.setAttribute("data-kt-indicator", "on");
    btn.disabled = true;

    $.ajax({
        url: 'admin?page=test_smtp_connection',
        type: 'POST',
        data: fields,
        dataType: 'json',
        cache: false,
        headers: {
            'Cache-Control': 'no-cache'
        },
        success: function(response) {
            let message = response.message || 'Unknown response';
            let icon = response.success ? "success" : "error";

            Swal.fire({
                text: message,
                icon: icon,
                buttonsStyling: false,
                confirmButtonText: "Ok, got it!",
                customClass: {
                    confirmButton: "btn btn-primary"
                }
            });
        },
        error: function(xhr, status, error) {
            let errorMessage = "Connection error: ";
            
            // Log everything for debugging
            console.error('SMTP Test Error:', {
                status: xhr.status,
                statusText: xhr.statusText,
                responseText: xhr.responseText,
                error: error
            });

            try {
                const response = xhr.responseText ? JSON.parse(xhr.responseText) : null;
                errorMessage += response?.message || error || "Unknown error occurred";
            } catch (e) {
                if (xhr.status === 500) {
                    errorMessage += "Internal server error. Please check server logs.";
                } else if (xhr.status === 404) {
                    errorMessage += "Test endpoint not found.";
                } else {
                    errorMessage += "Server returned an invalid response.";
                }
            }

            Swal.fire({
                text: errorMessage,
                icon: "error",
                buttonsStyling: false,
                confirmButtonText: "Ok, got it!",
                customClass: {
                    confirmButton: "btn btn-primary"
                }
            });
        },
        complete: function() {
            btn.removeAttribute("data-kt-indicator");
            btn.disabled = false;
        }
    });
}
// Test IMAP connection
function testImapConnection() {
    const btn = event.target;
    const fields = {
        imap_host: document.querySelector('input[name="email_settings[imap_host]"]').value,
        imap_user: document.querySelector('input[name="email_settings[imap_user]"]').value,
        imap_pass: document.querySelector('input[name="email_settings[imap_pass]"]').value,
        imap_secure: document.querySelector('select[name="email_settings[imap_secure]"]').value,
        imap_port: document.querySelector('input[name="email_settings[imap_port]"]').value
    };

    // Validate fields
    if (!fields.imap_host || !fields.imap_user || !fields.imap_pass) {
        Swal.fire({
            text: "Please fill in all required IMAP fields.",
            icon: "error",
            buttonsStyling: false,
            confirmButtonText: "Ok, got it!",
            customClass: {
                confirmButton: "btn btn-primary"
            }
        });
        return;
    }

    // Show loading state
    btn.setAttribute("data-kt-indicator", "on");
    btn.disabled = true;

    // Test connection
    $.ajax({
        url: 'admin?page=test_imap_connection',
        type: 'POST',
        data: fields,
        dataType: 'json',
        success: function(response) {
            let message = response.message || 'Unknown response';
            let icon = response.success ? "success" : "error";

            if (!response.success && response.details && response.details.last_error) {
                message += '\n\nDetails: ' + response.details.last_error;
            }

            Swal.fire({
                text: message,
                icon: icon,
                buttonsStyling: false,
                confirmButtonText: "Ok, got it!",
                customClass: {
                    confirmButton: "btn btn-primary"
                }
            });
        },
        error: function(xhr, status, error) {
            Swal.fire({
                text: "Connection error: " + (error || "Unknown error occurred"),
                icon: "error",
                buttonsStyling: false,
                confirmButtonText: "Ok, got it!",
                customClass: {
                    confirmButton: "btn btn-primary"
                }
            });
        },
        complete: function() {
            // Hide loading state
            btn.removeAttribute("data-kt-indicator");
            btn.disabled = false;
        }
    });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    const imapToggle = document.getElementById('imapToggle');
    if (imapToggle) {
        toggleImapSettings(imapToggle);
    }
});
</script>
<?
    }
    if ($_GET['page'] == 'security')
    { ?>

                                            
<?php
        $select_detail = mysqli_query($DB_CONN, "select * from preferences");
        $row_detail = mysqli_fetch_assoc($select_detail);
        $security_settings = json_decode($row_detail['security_settings'], true);
        $captcha_settings = json_decode($row_detail['captcha_settings'], true);
        $idd = $row_detail['id'];

        if (isset($_POST['submit']))
        {

            $security_settings = mysqli_real_escape_string($DB_CONN, json_encode($_POST['security_settings']));
            $captcha_settings = mysqli_real_escape_string($DB_CONN, json_encode($_POST['captcha_settings']));
            $update_security = mysqli_query($DB_CONN, "UPDATE preferences set captcha_settings='{$captcha_settings}', security_settings = '{$security_settings}' WHERE id='$idd'");
            if ($update_security)
            {
                echo '<div class="alert alert-success">
      Updated Successfully ! 
</div>';
            }

        }
        $select_detail = mysqli_query($DB_CONN, "select * from preferences");
        $row_detail = mysqli_fetch_assoc($select_detail);
        $security_settings = json_decode($row_detail['security_settings'], true);
        $captcha_settings = json_decode($row_detail['captcha_settings'], true);
        $idd = $row_detail['id'];
?>
  <form method="POST">
 <div class="card mb-2">
    <div class="card-header min-h-unset py-2">
        <div class="card-title m-0">
            <h3 class="fw-bold m-0 fs-5">Security Settings</h3>
        </div>
    </div>
      
    <div class="card-body py-3">
        
   <div class="row">
            <div class="col-md-2">
                <div class="form-group">
                    <label class="fs-9">Admin Session timeout </label>
                </div>
            </div>
            <div class="col-md-10">
                <input type="number" name="security_settings[admin_session]" value="<?=$security_settings['admin_session'] ?? '15' ?>" class="form-control form-control-sm" />
                <small id="emailHelp" class="form-text text-muted fs-9">Enter Admin Session Minutes after which session will be destroyed ( logout )</small>
            </div>
        </div>
        <div class="row">
            <div class="col-md-2">
                <div class="form-group">
                    <label class="fs-9">User Session timeout </label>
                </div>
            </div>
            <div class="col-md-10">
                <input type="number" name="security_settings[user_session]" value="<?=$security_settings['user_session'] ?? '15' ?>" class="form-control form-control-sm" />
                <small id="emailHelp" class="form-text text-muted fs-9">Enter User Session Minutes after which session will be destroyed ( logout )</small>
            </div>
        </div>
         <div class="separator separator-dashed my-2"></div>  
      <div class="row">
            <div class="col-md-2">
                <div class="form-group">
                    <label class="fs-9"> Minimal Password Length </label>
                </div>
            </div>
            <div class="col-md-10">
                <input type="number" name="security_settings[password_length]" value="<?=$security_settings['password_length'] ?>" class="form-control form-control-sm" />
                <small id="emailHelp" class="form-text text-muted fs-9">(leave empty to skip limits)</small>
            </div>
        </div>
      <div class="separator separator-dashed my-2"></div>  
        <!--begin::Item-->
        <div class="row">
            <div class="col-md-2">
                <div class="form-group">
                    <label class="fs-9"> Allow max login attempts </label>
                </div>
            </div>
            <div class="col-md-10">
                <input type="number" name="security_settings[max_attempts_signin]" class="form-control form-control-sm" value="<?=$security_settings['max_attempts_signin'] ? $security_settings['max_attempts_signin'] : 0 ?>">
                <small id="emailHelp" class="form-text text-muted fs-9">If login attemps higher than this no- Ip will be blacklisted and user won't be able to login for Ban time.</small>
            </div>
        </div>
        
        <div class="separator separator-dashed my-2"></div>
        
          <div class="row">
            <div class="col-md-2">
                <div class="form-group">
                    <label class="fs-9"> Ban time for exceeding max login attempts (minutes) </label>
                </div>
            </div>
            <div class="col-md-10">
                <input type="number" name="security_settings[banned_timeout_signin]" class="form-control form-control-sm" value="<?=$security_settings['banned_timeout_signin'] ? $security_settings['banned_timeout_signin'] : 0 ?>">
                <small id="emailHelp" class="form-text text-muted fs-9"> Ban time for exceeding max login attempts in minutes</small>
            </div>
        </div>
        <!--end::Item-->
 <div class="separator separator-dashed my-2"></div>
       <div class="row">
     <div class="col-md-2">
      <label class="fs-9"> Captcha </label>
    </div>
    <div class="col-md-10">
        <select class="form-select form-select-sm"  id="captcha" name="captcha_settings[captcha_id]">
        <option value="0" <?php echo $captcha_settings['captcha_id'] == '0' ? 'selected' : '' ?>>Disabled</option>
        <option value="1" <?php echo $captcha_settings['captcha_id'] == '1' ? 'selected' : '' ?>>Google Recaptcha</option>
        <option value="2" <?php echo $captcha_settings['captcha_id'] == '2' ? 'selected' : '' ?>>H Captcha</option>
        <option value="3" <?php echo $captcha_settings['captcha_id'] == '3' ? 'selected' : '' ?>>Cloudflare Captcha</option>
        <option value="4" <?php echo $captcha_settings['captcha_id'] == '4' ? 'selected' : '' ?>>Image Captcha</option>
      </select>
      <small class="text-muted">Select Google Recaptcha | hCaptcha | Cloudflare Captcha | ImageCaptcha</small>
</div>

<div class="py-5" <? if ($captcha_settings['captcha_id'] == '0') echo 'style="display: none;"'; ?>>
 <label class="form-check form-check-custom form-check-solid align-items-start">
                                                        <!--begin::Input-->
                                                        <input class="form-check-input me-3" type="checkbox" name="captcha_settings[page][login]" value="1"  <?php if ($captcha_settings['page']['login'] == '1') echo 'checked'; ?>>
                                                        <!--end::Input-->
                                                        <!--begin::Label-->
                                                        <span class="form-check-label d-flex flex-column align-items-start">
                                                            <span class="fw-bold fs-6 mb-0">Login Page</span>
                                                    
                                                        </span>
                                                        <!--end::Label-->
                                                    </label>
                    <div class="separator separator-dashed my-2"></div>                                
                <label class="form-check form-check-custom form-check-solid align-items-start">
                                                        <!--begin::Input-->
                                                        <input class="form-check-input me-3" type="checkbox" name="captcha_settings[page][register]" value="1"  <?php if ($captcha_settings['page']['register'] == '1') echo 'checked'; ?>>
                                                        <!--end::Input-->
                                                        <!--begin::Label-->
                                                        <span class="form-check-label d-flex flex-column align-items-start">
                                                            <span class="fw-bold fs-6 mb-0">Register Page</span>
                                                            
                                                        </span>
                                                        <!--end::Label-->
                                                    </label>
                <div class="separator separator-dashed my-2"></div>                                        
                <label class="form-check form-check-custom form-check-solid align-items-start">
                                                        <!--begin::Input-->
                                                        <input class="form-check-input me-3" type="checkbox" name="captcha_settings[page][forgot]" value="1"  <?php if ($captcha_settings['page']['forgot'] == '1') echo 'checked'; ?>>
                                                        <!--end::Input-->
                                                        <!--begin::Label-->
                                                        <span class="form-check-label d-flex flex-column align-items-start">
                                                            <span class="fw-bold fs-6 mb-0">Forgot Password Page</span>
                                                        
                                                        </span>
                                                        <!--end::Label-->
                                                    </label>
                <div class="separator separator-dashed my-2"></div>                                        
                <label class="form-check form-check-custom form-check-solid align-items-start">
                                                        <!--begin::Input-->
                                                        <input class="form-check-input me-3" type="checkbox" name="captcha_settings[page][contact]" value="1"  <?php if ($captcha_settings['page']['contact'] == '1') echo 'checked'; ?>>
                                                        <!--end::Input-->
                                                        <!--begin::Label-->
                                                        <span class="form-check-label d-flex flex-column align-items-start">
                                                            <span class="fw-bold fs-6 mb-0">Contact Page</span>
                                                        
                                                        </span>
                                                        <!--end::Label-->
                                                    </label>
                <div class="separator separator-dashed my-2"></div> 
            
                            
     </div> 

<div id="recaptcha" <? if ($captcha_settings['captcha_id'] != '1') echo 'style="display: none;"'; ?>>
    <h5 class="page-title">Recaptcha Settings</h5>
    <div class="row">
        <div class="col-md-2">
            <div class="form-group">
                <label class="fs-9"> Recaptcha Site Key </label>
            </div>
        </div>
        <div class="col-md-10">
            <input type="text" name="captcha_settings[google][gsitekey]" value="<?php echo $captcha_settings['google']['gsitekey'] ?>" class="form-control form-control-sm" />
            <small id="emailHelp" class="form-text text-muted fs-9">
                you can get new recaptcha site key from <a  href="https://www.google.com/recaptcha/admin/" target="_blank">https://www.google.com/recaptcha/admin/</a> select reCAPTCHA v2 and "i'm not robot" chalange
            </small>
        </div>
        <div class="col-md-2">
            <div class="form-group">
                <label class="fs-9"> Recaptcha Secret Key </label>
            </div>
        </div>
        <div class="col-md-10">
            <input type="text" name="captcha_settings[google][gserverkey]" value="<?php echo $captcha_settings['google']['gserverkey'] ?>" class="form-control form-control-sm" />
            <small id="emailHelp" class="form-text text-muted fs-9">Paste Secret Key above</small>
        </div>
    </div>
</div>


<div id="hcaptcha" <? if ($captcha_settings['captcha_id'] != '2') echo 'style="display: none;"'; ?>>
    <h5 class="page-title">hCaptcha Settings</h5>
    <div class="row">
        <div class="col-md-2">
            <div class="form-group">
                <label class="fs-9"> hCaptcha Site Key </label>
            </div>
        </div>
        <div class="col-md-10">
            <input type="text" name="captcha_settings[hcaptcha][hsitekey]" value="<?php echo $captcha_settings['hcaptcha']['hsitekey'] ?>" class="form-control form-control-sm" />
            <small id="emailHelp" class="form-text text-muted fs-9">
                you can get new hCaptcha site key from <a  href="https://dashboard.hcaptcha.com/welcome" target="_blank">https://dashboard.hcaptcha.com/welcome</a> select site key
            </small>
        </div>
        <div class="col-md-2">
            <div class="form-group">
                <label class="fs-9"> hCaptcha Secret Key </label>
            </div>
        </div>
        <div class="col-md-10">
            <input type="text" name="captcha_settings[hcaptcha][hsecretkey]" value="<?php echo $captcha_settings['hcaptcha']['hsecretkey'] ?>" class="form-control form-control-sm" />
            <small id="emailHelp" class="form-text text-muted fs-9"> you can get new hCaptcha secret key from <a  href="https://dashboard.hcaptcha.com/welcome" target="_blank">https://dashboard.hcaptcha.com/welcome</a> select generate to get a new key</small>
        </div>
    </div>
</div>



 <div id="ccaptcha" <? if ($captcha_settings['captcha_id'] != '3') echo 'style="display: none;"'; ?>>
    <h5 class="page-title">Cloudflare Turnstile Settings</h5>
    <small class="fs-9">Go to Cloudflare Click on Turnstile -> Add Site -> Enter Site name -> Enter domain -> select managed -> Create</small>
    <div class="row">
        <div class="col-md-2">
            <div class="form-group">
                <label class="fs-9"> Cloudflare Turnstile Site Key </label>
            </div>
        </div>
        <div class="col-md-10">
            <input type="text" name="captcha_settings[cloudflare][csitekey]" value="<?php echo $captcha_settings['cloudflare']['csitekey'] ?>" class="form-control form-control-sm" />
            <small id="emailHelp" class="form-text text-muted fs-9">
               Paste Site key here
            </small>
        </div>
        <div class="col-md-2">
            <div class="form-group">
                <label class="fs-9"> Cloudflare Turnstile Secret Key </label>
            </div>
        </div>
        <div class="col-md-10">
            <input type="text" name="captcha_settings[cloudflare][csecretkey]" value="<?php echo $captcha_settings['cloudflare']['csecretkey'] ?>" class="form-control form-control-sm" />
            <small id="emailHelp" class="form-text text-muted fs-9"> Paste Secret key here</small>
        </div>
    </div>
</div>



<div id="icaptcha" <? if ($captcha_settings['captcha_id'] != '4') echo 'style="display: none;"'; ?>>
    <h5 class="page-title">Turning Captcha Image Settings</h5>
    <div class="row">

                <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Show numbers only in the validation image</a>
                    <div class="fs-9 fw-semibold text-gray-500">No Alphabets will be shown to validation only Numbers</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="captcha_settings[image][numbers]" id="numbers" value="1" <?php if ($captcha_settings['image']['numbers'] == '1') echo 'checked'; ?>>
                    <label class="form-check-label fs-9" for="numbers"></label>
                </div>
            </div>
        </div>
               
                                                    
            <div class="separator separator-dashed my-2"></div> 
                 <div class="col-md-3">
                     <label  class="col-form-label">Image Height</label>
                        <input type="text" class="form-control form-control-sm" name="captcha_settings[image][image_height]" value="<?=$captcha_settings['image']['image_height'] ?>">
                    </div>
                    
                    <div class="col-md-3">
                     <label  class="col-form-label">Image Width</label>
                        <input type="text" class="form-control form-control-sm" name="captcha_settings[image][image_width]" value="<?=$captcha_settings['image']['image_width'] ?>">
                    </div>
                    
                    <div class="col-md-3">
                     <label  class="col-form-label">Font Size </label>
                        <input type="text" class="form-control form-control-sm" name="captcha_settings[image][font_size]" value="<?=$captcha_settings['image']['font_size'] ?>">
                    </div>
                    <div class="col-md-3">
                     <label  class="col-form-label">Image Characters</label>
                        <input type="text" class="form-control form-control-sm" name="captcha_settings[image][image_char]" value="<?=$captcha_settings['image']['image_char'] ?>">
                    </div>
                    
                    <div class="separator separator-dashed my-2"></div> 
                    <div class="col-md-2">
                <div class="form-group">
                    <label for="example-text-input" class="col-form-label">Turing image text color:</label>
                </div>
            </div>
            <div class="col-md-5">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="captcha_settings[image][random_text]" id="random_text" value="1"  <?php if ($captcha_settings['image']['random_text'] == '1') echo 'checked'; ?>>
                    <label class="form-check-label fs-9" for="random_text">Random Text Color</label>
                </div>
                 </div>
                    <div class="col-md-5">
                        <input type="color" class="form-control form-control-sm" name="captcha_settings[image][textcolor]" value="<?=$captcha_settings['image']['textcolor'] ?>">
                    </div>
                    
                    <div class="separator separator-dashed my-2"></div> 
               <div class="col-md-2">
                <div class="form-group">
                    <label for="example-text-input" class="col-form-label">Turing image bg color:</label>
                </div>
            </div>
            <div class="col-md-5">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="captcha_settings[image][random_bg]" id="random_bg" value="1"  <?php if ($captcha_settings['image']['random_bg'] == '1') echo 'checked'; ?>>
                    <label class="form-check-label fs-9" for="random_bg">Random Background Color</label>
                </div>
                 </div>
                    <div class="col-md-5">
                        <input type="color" class="form-control form-control-sm" name="captcha_settings[image][bgcolor]" value="<?=$captcha_settings['image']['bgcolor'] ?>">
                    </div>
                    <div class="separator separator-dashed my-2"></div> 
               <div class="col-md-2">
                <div class="form-group">
                    <label for="example-text-input" class="col-form-label">Turing image lines color:</label>
                </div>
            </div>
            <div class="col-md-5">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="captcha_settings[image][random_line]" id="random_line" value="1"   <?php if ($captcha_settings['image']['random_line'] == '1') echo 'checked'; ?>>
                    <label class="form-check-label fs-9" for="random_line">Random lines Color</label>
                </div>
                 </div>
                    <div class="col-md-5">
                        <input type="color" class="form-control form-control-sm" name="captcha_settings[image][linecolor]" value="<?=$captcha_settings['image']['linecolor'] ?>">
                    </div>
    </div>
</div>


            
               
</div> 
</div>
<div class="card-footer d-flex justify-content-end py-2 px-9">
      <input class="btn btn-primary btn-sm me-2" type="submit" name="submit" value="UPDATE" >

</div>

</div>
 </form>
 
 
 
                
    <script>
    
    $(function() {
   $("#captcha").change(function() {
        var val = $(this).val();
        if ( this.value == '0')
      {
        $("#recaptcha").hide();
        $("#hcaptcha").hide();
        $("#ccaptcha").hide();
         $("#icaptcha").hide();
      }
      else if ( this.value == '1')
      {
        $("#recaptcha").show();
        $("#hcaptcha").hide();
        $("#ccaptcha").hide();
         $("#icaptcha").hide();
      }
      else if ( this.value == '2')
      {
        $("#recaptcha").hide();
        $("#hcaptcha").show();
        $("#ccaptcha").hide();
         $("#icaptcha").hide();
      }
     else if ( this.value == '3')
      {
        $("#recaptcha").hide();
        $("#hcaptcha").hide();
        $("#ccaptcha").show();
         $("#icaptcha").hide();
      }
     else if ( this.value == '4')
      {
        $("#recaptcha").hide();
        $("#hcaptcha").hide();
        $("#ccaptcha").hide();
         $("#icaptcha").show();
      }
    });
});
</script>

<?
    }
    if ($_GET['page'] == 'users')
    {
        $alert = false;
        $alert_class = '';
        $alert_message = '';
        if (isset($_POST['submit']))
        {
            $add_datetime = date("Y-m-d H:i:s");
            $username = ($_POST['username']);
            $email = ($_POST['email']);
            $password = md5(($_POST['password']));
            $full_name = ($_POST['fullname']);
            $sponsor = ($_POST['sponsor']);
            $cUser = mysqli_query($DB_CONN, "select * from users where username='{$username}' limit 1") or die(mysqli_error($DB_CONN));
            if ($cUser && !mysqli_num_rows($cUser) > 0)
            {
                $upd_query = "INSERT into users (username, email, password, fullname, sponsor, status) values('{$username}', '{$email}', '{$password}', '{$full_name}', '{$sponsor}', '1')";
                if (mysqli_query($DB_CONN, $upd_query) or die(mysqli_error($DB_CONN)))
                {
                    $id = mysqli_insert_id($DB_CONN);
                    sendmail("registration", $id);
                    $alert = true;
                    $alert_class = 'alert alert-success alert-dismissible alert-custom';
                    $alert_message = 'Registered Successfully!';
                }
            }
            else
            {
                $alert = true;
                $alert_class = 'alert alert-danger alert-dismissible alert-custom';
                $alert_message = 'Username already exists.';
            }
        }
?>

                                                                     <?php
        if ($alert)
        {
?>
            <div class="<?=$alert_class
?>">
                <?=$alert_message
?>
            </div>
            
            <?php
        }
?>
                        
                                    <!--end::Form-->
                                    <!--begin::Toolbar-->
<form action="#" method="post" id="topsearch">
    <!--begin::Card-->
    <div class="card mb-7">
        <!--begin::Card body-->
        <div class="card-body">
            <!--begin::Compact form-->
            <div class="d-flex align-items-center">
                <!--begin::Input group-->
                <div class="position-relative w-md-900px me-md-2">
                    <!--begin::Svg Icon | path: images/icons/duotune/general/gen021.svg-->
                    <span class="svg-icon svg-icon-3 svg-icon-gray-500 position-absolute top-50 translate-middle ms-6">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <rect opacity="0.5" x="17.0365" y="15.1223" width="8.15546" height="2" rx="1" transform="rotate(45 17.0365 15.1223)" fill="currentColor" />
                            <path
                                d="M11 19C6.55556 19 3 15.4444 3 11C3 6.55556 6.55556 3 11 3C15.4444 3 19 6.55556 19 11C19 15.4444 15.4444 19 11 19ZM11 5C7.53333 5 5 7.53333 5 11C5 14.4667 7.53333 17 11 17C14.4667 17 17 14.4667 17 11C17 7.53333 14.4667 5 11 5Z"
                                fill="currentColor"
                            />
                        </svg>
                    </span>
                    <!--end::Svg Icon-->
                    <input type="text" class="form-control form-control-solid ps-10" name="search" value="" placeholder="Search Username/Email" />
                </div>
                <!--end::Input group-->
                <!--begin:Action-->
                <div class="d-flex align-items-center">
                    <input type="hidden" name="last_id" value="0">
                    <button type="submit" class="btn btn-primary me-5">Search</button>
                    <a  id="kt_horizontal_search_advanced_link" class="btn btn-link" data-bs-toggle="collapse" href="#kt_advanced_search_form">Advanced Search</a>
                </div>
                <!--end:Action-->
            </div>
            <!--end::Compact form-->
            <!--begin::Advance form-->
            <div class="collapse" id="kt_advanced_search_form">
                <!--begin::Separator-->
                <div class="separator separator-dashed mt-9 mb-6"></div>
                <!--end::Separator-->
                <!--begin::Row-->
                <div class="row g-8 mb-8">
                    <!--begin::Col-->
                    <div class="col-xxl-3">
                        <label class="fs-6 form-label fw-bolder text-dark">Show Entries</label>
                        <select class="form-select form-select-solid" name="show" >
                        <option value="10">10</option>
                         <option value="20">20</option>
                          <option value="50">50</option>
                           <option value="100">100</option>
                         
                        </select>
                    </div>
                    
                     <div class="col-xxl-3">
                        <label class="fs-6 form-label fw-bolder text-dark">Users</label>
                        <select class="form-select form-select-solid" name="fake" >
                        <option value="NOT IN (SELECT id from users WHERE auto_withdraw = 4)">Real Only</option>
                         <option value="!=1">Real and Dummy Only</option>
                          <option value="IN (SELECT id from users WHERE auto_withdraw = 4)">Dummy Only</option>
                        </select>
                    </div>
                    <!--end::Col-->
                    <!--begin::Col-->
                    <div class="col-xxl-6">
                        <!--begin::Row-->
                        <div class="row g-8">
                            <!--begin::Col-->
                            <div class="col-lg-6">
                                <label class="fs-6 form-label fw-bolder text-dark">Order </label>
                                <!--begin::Select-->
                                <select class="form-select form-select-solid" data-placeholder="Order" name="orderby" >
                                   <option value="id desc">ID DESC</option>    
                                     <option value="id asc">ID ASC</option>
                                    <option value="username asc">Username ASC</option>
                                    <option value="username desc">Username DESC</option>
                                    <option value="created_at ASC">Registration ASC</option>
                                    <option value="created_at desc">Registration DESC</option>
                                    <option value="balance ASC">Balance ASC</option>
                                    <option value="balance desc">Balance DESC</option>
                                    <option value="invest ASC">Invested ASC</option>
                                    <option value="invest desc">Invested DESC</option>
                                    <option value="earnings ASC">Earnings ASC</option>
                                    <option value="earnings desc">Earnings DESC</option>
                                    <option value="referral ASC">Referral ASC</option>
                                    <option value="referral desc">Referral DESC</option>
                                    <option value="withdraw ASC">Withdraw ASC</option>
                                    <option value="withdraw desc">Withdraw DESC</option>
                                    <option value="faucet ASC">Faucet ASC</option>
                                    <option value="faucet desc">Faucet DESC</option>
                                </select>
                                <!--end::Select-->
                            </div>
                            <!--end::Col-->
                            <!--begin::Col-->
                            <div class="col-lg-6">
                                <label class="fs-6 form-label fw-bolder text-dark">Select Status</label>
                                <!--begin::Radio group-->
                                <div class="nav-group nav-group-fluid">
                                    <!--begin::Option-->
                                    <label class="fs-9">
                                        <input type="radio" class="btn-check" name="status" value="" <?=!$_GET['status'] ? 'checked' : '' ?> />
                                        <span class="btn btn-sm btn-color-muted btn-active btn-active-primary fw-bolder px-4">All</span>
                                    </label>
                                    <!--end::Option-->
                                    <!--begin::Option-->
                                    <label class="fs-9">
                                        <input type="radio" class="btn-check" name="status" value="1" <?=$_GET['status'] == 1 ? 'checked' : '' ?> />
                                        <span class="btn btn-sm btn-color-muted btn-active btn-active-primary fw-bolder px-4">Active</span>
                                    </label>
                                    <!--end::Option-->
                                    <!--begin::Option-->
                                    <label class="fs-9">
                                        <input type="radio" class="btn-check" name="status" value="0" <?=$_GET['status'] == 0 ? 'checked' : '' ?> />
                                        <span class="btn btn-sm btn-color-muted btn-active btn-active-primary fw-bolder px-4">Inactive</span>
                                    </label>
                                    
                                    <label class="fs-9">
                                        <input type="radio" class="btn-check" name="status" value="2" <?=$_GET['status'] == 2 ? 'checked' : '' ?> />
                                        <span class="btn btn-sm btn-color-muted btn-active btn-active-primary fw-bolder px-4">Blocked</span>
                                    </label>
                                    <!--end::Option-->
                                </div>
                                <!--end::Radio group-->
                            </div>
                            <!--end::Col-->
                        </div>
                        <!--end::Row-->
                    </div>
                    <!--end::Col-->
                </div>
                <!--end::Row-->
                <!--begin::Row-->

                <!--end::Row-->
            </div>
            <!--end::Advance form-->
        </div>
        <!--end::Card body-->
    </div>
    <!--end::Card-->
</form>

    <!--end::Toolbar-->
    <!--begin::Tab Content-->
    <div class="tab-content">
        <!--begin::Tab pane-->
    <div class="card card-flush h-xl-100">
                <!--begin::Header-->
                <div class="card-header pt-7">
                    <!--begin::Title-->
                    <h4 class="card-title align-items-start flex-column">
                        <span class="card-label fw-bolder text-gray-800">Users </span>
                        <span class="text-gray-400 mt-1 fw-bold fs-7">Active : <?php echo $b = mysqli_num_rows(mysqli_query($DB_CONN, "select * from users where status = 1 and id != 1")) ?></span>
                    </h4>
                    <!--end::Title-->
                    <!--begin::Toolbar-->
            <div class="card-toolbar">
                <a  href="#" class="btn btn-sm fw-bold btn-primary" data-bs-toggle="modal" data-bs-target="#kt_modal_new_target">Add New User</a>
                </div>  
                </div>
                <div class="card-body py-3">
                    <div class="table-responsive">
                         <div id="loader" style="display:none;">
    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000;"></div>
    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1001;">
    <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
    </div>
    </div>
    </div>
        <table  class="table table-row-dashed align-middle gs-0 gy-4 my-0 depositstable">
            <thead>
                <tr class="border-bottom-0">
                    <th class="p-0 ">ID</th>
                    <th class="p-0 ">User Details</th>
                    <th class="p-0 ">Balances</th>
                    <th class="p-0 ">Status</th>
                    <th class="p-0 text-end align-middle">Action</th>
                
                </tr>
            </thead>
            <tbody>
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="9" class="text-center"><input type="button" class="btn btn-primary lmore" onclick="load_deposit()" value="Load More"></td>
                </tr>
            </tfoot>
        </table>
    </div>
    </div>
    </div>
    </div>
                            
    <div class="modal fade " id="kt_modal_new_target" tabindex="-1" >
            <!--begin::Modal dialog-->
            <div class="modal-dialog modal-dialog-centered mw-650px">
                <!--begin::Modal content-->
                <div class="modal-content rounded">
                    <!--begin::Modal header-->
                    <div class="modal-header pb-0 border-0 justify-content-end">
                        <!--begin::Close-->
                        <div class="btn btn-sm btn-icon btn-active-color-primary" data-bs-dismiss="modal">
                            <i class="ki-duotone ki-cross fs-1">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                        </div>
                        <!--end::Close-->
                    </div>
                    <!--begin::Modal header-->
                    <!--begin::Modal body-->
                    <div class="modal-body scroll-y px-10 px-lg-15 pt-0 pb-15">
                        <!--begin:Form-->
                        <form  class="form fv-plugins-bootstrap5 fv-plugins-framework" method="POST">
                            <!--begin::Heading-->
                            <div class="mb-13 text-center">
                                <!--begin::Title-->
                                <h1 class="mb-3">Add new user</h1>
                                <!--end::Title-->
                                <!--begin::Description-->
                                <div class="text-muted fw-semibold fs-5">User will be added to your userlist as an active user .</div>
                                <!--end::Description-->
                            </div>
                            <!--end::Heading-->
                            <!--begin::Input group-->
                            <div class="d-flex flex-column mb-8 fv-row fv-plugins-icon-container">
                                <!--begin::Label-->
                                <label class="d-flex align-items-center fs-6 fw-semibold mb-2">
                                    <span class="required">Full Name</span>
                                
                                </label>
                                <!--end::Label-->
                                <input type="text" class="form-control form-control-solid" placeholder="Enter Full Name" name="fullname">
                        </div>
                        
                            <!--begin::Input group-->
                            <div class="d-flex flex-column mb-8 fv-row fv-plugins-icon-container">
                                <!--begin::Label-->
                                <label class="d-flex align-items-center fs-6 fw-semibold mb-2">
                                    <span class="required">Username</span>
                                
                                </label>
                                <!--end::Label-->
                                <input type="text" class="form-control form-control-solid" placeholder="Enter username" name="username">
                        </div>
                        
                            <!--begin::Input group-->
                            <div class="d-flex flex-column mb-8 fv-row fv-plugins-icon-container">
                                <!--begin::Label-->
                                <label class="d-flex align-items-center fs-6 fw-semibold mb-2">
                                    <span class="required">email</span>
                                
                                </label>
                                <!--end::Label-->
                                <input type="email" class="form-control form-control-solid" placeholder="Enter email" name="email">
                        </div>
                        
                            <!--begin::Input group-->
                            
                        
                    
                            <div class="text-center">
                            
                                <button type="submit" name="submit" class="btn btn-primary ">
                                 Submit
                                 
                            
                                </button>
                            </div>
                            <!--end::Actions-->
                        </form>
                        <!--end:Form-->
                    </div>
                    <!--end::Modal body-->
                </div>
                <!--end::Modal content-->
            </div>
            <!--end::Modal dialog-->
        </div>
<script type="text/javascript">
    $(document).ready(function() {
    $('.js-example-basic-multiple').select2();
});
var last_id = 0;
function del_user(id) {
    Swal.fire({
        html: `You are about to delete a <strong>User</strong> <br> This action is irreversible <br> All Data related to this user will be deleted from database.`,
        icon: "info",
        buttonsStyling: false,
        showCancelButton: true,
        confirmButtonText: "Delete It!",
        cancelButtonText: 'Nope, cancel it',
        customClass: {
            confirmButton: "btn btn-primary",
            cancelButton: 'btn btn-danger'
        }
    }).then(function(isConfirm) {
        if (isConfirm.isConfirmed) {
            $.ajax({
                type: "POST",
                url: "?page=ajax&h=del_user",
                data: {id:id},
                dataType: 'json',
                success: function(data) {
                    if(data.status) {
                        // Reset last_id and clear table before reloading
                        last_id = 0;
                        $("input[name=last_id]").val(0);
                        $(".depositstable tbody").empty();
                        load_deposit();
                    } else {
                        alert("Server Error");
                    }
                }
            });
        }
    });
}
function ban_user(id) {
    Swal.fire({
        html: `You are about to Block a <strong>user</strong> `,
        icon: "info",
        buttonsStyling: false,
        showCancelButton: true,
        confirmButtonText: "Block this User!",
        cancelButtonText: 'Nope, cancel it',
        customClass: {
            confirmButton: "btn btn-primary",
            cancelButton: 'btn btn-danger'
        }
    }).then(function(isConfirm) {
        if (isConfirm.isConfirmed) {
            $.ajax({
                type: "POST",
                url: "?page=ajax&h=ban_user",
                data: {id:id},
                dataType: 'json',
                success: function(data) {
                    if(data.status) {
                        // Reset last_id and clear table before reloading
                        last_id = 0;
                        $("input[name=last_id]").val(0);
                        $(".depositstable tbody").empty();
                        load_deposit();
                    } else {
                        alert("Server Error");
                    }
                }
            });
        }
    });
}

function unban_user(id) {
    Swal.fire({
        html: `You are about to <strong>UnBlock</strong> a <strong>user</strong> `,
        icon: "info",
        buttonsStyling: false,
        showCancelButton: true,
        confirmButtonText: "UnBlock this User!",
        cancelButtonText: 'Nope, cancel it',
        customClass: {
            confirmButton: "btn btn-primary",
            cancelButton: 'btn btn-danger'
        }
    }).then(function(isConfirm) {
        if (isConfirm.isConfirmed) {
            $.ajax({
                type: "POST",
                url: "?page=ajax&h=unban_user",
                data: {id:id},
                dataType: 'json',
                success: function(data) {
                    if(data.status) {
                        // Reset last_id and clear table before reloading
                        last_id = 0;
                        $("input[name=last_id]").val(0);
                        $(".depositstable tbody").empty();
                        load_deposit();
                    } else {
                        alert("Server Error");
                    }
                }
            });
        }
    });
}
function load_deposit() {
    $("#loader").show();
    
    $.ajax({
        url: '?page=ajax&h=users',
        type: 'POST',
        dataType: 'json',
        data: $("#topsearch").serialize(),
        success: function(data) {
            // If last_id is 0, clear the table first
            if (last_id === 0) {
                $(".depositstable tbody").empty();
            }
            $(".depositstable tbody").append(data.data);
            last_id = data.last_id;
            $("input[name=last_id]").val(data.last_id);
            if(data.last_id == 0) {
                $(".lmore").hide();
            }
        },
        error: function(xhr, status, error) {
            console.error('Load deposit failed:', error);
        },
        complete: function() {
            $("#loader").hide();
        }
    });
}

$(function() {
    load_deposit();
});
$( "#topsearch" ).submit(function( event ) {
    $(".depositstable tbody").html('');
    $("input[name=last_id]").val(0);
    last_id = 0;
    load_deposit();
    event.preventDefault();
})



</script>
<?
    }
    if ($_GET['page'] == 'ip_checks')
    { ?>
    
                        <div class="card mb-5 mb-lg-10">
                            <!--begin::Card header-->
                            <div class="card-header min-h-unset p-0">
                                <!--begin::Heading-->
                                <div class="card-title">
                                    <h3>Users Ip Check</h3>
                                </div>
                                <!--end::Heading-->

                                <!--end::Toolbar-->
                            </div>
                            <!--end::Card header-->

                            <!--begin::Card body-->
                            <div class="card-body p-0">
                                <!--begin::Table wrapper-->
                                <div class="table-responsive">
                                    <!--begin::Table-->
                                    <table  class="table align-middle table-hover table-row-bordered table-row-solid gy-4 gs-9">
                                        <!--begin::Thead-->
                                        <thead class="border-gray-200 fs-5 fw-semibold bg-lighten">
                                            <tr>
                                                <th class="min-w-250px ">Ip</th>
                                                <th class="min-w-250px text-start">Users</th>
                                               
                                               
                                            </tr>
                                        </thead>
                                        <!--end::Thead-->
                                        <!--begin::Tbody-->
                                        <tbody class="fw-6 fw-semibold text-gray-600">
                                            <?php
        $l = mysqli_query($DB_CONN, "SELECT ll.ip, COUNT(DISTINCT u.id) AS num_users FROM login_report ll JOIN users u ON u.id = ll.user_id GROUP BY ll.ip ORDER BY num_users DESC, ll.ip");
        while ($login = mysqli_fetch_assoc($l))
        {
?>
                                                        <tr>
                                                            <td  class="p-0 border-gray-500 text-end">
                                                              <a href="admin?page=login_reports&ip=<?=$login['ip'] ?>" class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6" target="_blank"><span class="badge badge-light-primary fs-7 fw-bold"><?=$login['ip'] ?></span>  </a> 
                                                                </td>
                                                                  <td  class="p-0 border-gray-500">
                                                                      <?=$login['num_users'] ?>
                                                                </td>
                                                          
                                                        </tr>
                                                     <?
        } ?>
                                        </tbody>
                                        <!--end::Tbody-->
                                    </table>

                                    <!--end::Table-->
                                </div>
                                <!--end::Table wrapper-->
                            </div>
                            <!--end::Card body-->
<?
    }
    if ($_GET['page'] == 'login_reports')
    { 
    if (isset($_GET['ip'])) {
    $ip_address = $_GET['ip'];  
    }?>        

                        <div class="card mb-5 mb-lg-10">
                            <!--begin::Card header-->
                            <div class="card-header min-h-unset p-0">
                                <!--begin::Heading-->
                               <h3 class="card-title align-items-start flex-column m-0">
                                                        <span class="card-label fw-bold text-gray-900">Login Sessions</span>
                                                  <? if($ip_address) {?>      <span class="text-gray-500 mt-1 fw-semibold fs-6">Login Sessions for <span class="badge badge-light-warning fs-7 fw-bold"><?=$ip_address?></span></span> <? } ?>
                                                    </h3>
                                <!--end::Heading-->
                                
                                <!--end::Toolbar-->
                            </div>
                            <!--end::Card header-->

                            <!--begin::Card body-->
                            <div class="card-body p-0">
                                <!--begin::Table wrapper-->
                                <div class="table-responsive">
                                    <!--begin::Table-->
                                    <table  class="table align-middle table-hover table-row-bordered table-row-solid gy-4 gs-9">
                                        <!--begin::Thead-->
                                        <thead class="border-gray-200 fs-5 fw-semibold bg-lighten">
                                            <tr>
                                                <th class="min-w-250px">User</th>
                                                <th class="min-w-150px">Ip</th>
                                                <th class="min-w-100px">Location</th>
                                                <th class="min-w-150px">Browser</th>
                                                <th class="min-w-150px">OS</th>
                                                <th class="min-w-150px">Time</th>
                                               
                                            </tr>
                                        </thead>
                                        <!--end::Thead-->
                                        <!--begin::Tbody-->
                                        <tbody class="fw-6 fw-semibold text-gray-600">
                                            <form id="userForm">
                                            <?php
                                            if($ip_address){
                                                 $l = mysqli_query($DB_CONN, "select *,(select username from users where id =login_report.user_id ) as username, (select email from users where id = login_report.user_id ) as email from login_report where user_id !=1 and ip='{$ip_address}' GROUP BY user_id");
                                            }else{
        $l = mysqli_query($DB_CONN, "select *,(select username from users where id =login_report.user_id ) as username, (select email from users where id = login_report.user_id ) as email from login_report where user_id !=1 order by id desc limit 100");
                                            }
        while ($login = mysqli_fetch_assoc($l))
        {
?>
                                                        <tr>
                                                            <td rowspan="2" class="p-0 border-gray-500">
                                                            <div class="d-flex align-items-center ps-5">
                                                                
                                                                
                                                                    <!--begin::Name-->
                                                                    <div class="d-flex justify-content-start flex-column">
                                                                        <a  href="admin?page=user&id=<?=$login['user_id'] ?>&view=overview" target="_blank" class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6"> <? if($ip_address){ ?>  <input class="user-checkbox" type="checkbox" name="user_ids[]" value="<?php echo $login['user_id']; ?>">
     <? } ?>    <?=$login['username'] ?></a>
                                                                        <a  href="#" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                                                                        <span class="text-gray-900">Email</span>:   <?=$login['email'] ?></a>
                                                                    
                                                                        
                                                                    
                                                                        
                                                                    </div>
                                                                    <!--end::Name-->
                                                                </div>
                                                            </td>
                                                            <td class="p-0 ">
                                                                <a  href="#" class="text-hover-primary text-gray-600">    <span class="badge badge-light-primary fs-7 fw-bold"><? echo $login['ip']; ?></span></a>
                                                            </td>
                                                            <td class="p-0 ">
                                                            <? echo $login['city']; ?>/<? echo $login['country']; ?>
                                                            </td>
                                                            <td class="p-0 "><? echo $login['browser']; ?></td>
                                                            <td class="p-0 "><? echo $login['os']; ?></td>
                                                        
                                                            <td class="p-0 "> <?php $dt = date("M d, Y h:i:s A", strtotime($login['datetime']));
            echo time_elapsed_string($dt, true); ?></td>
                                                            
                                                        </tr>
                                                        <tr>
                                                          <td class="p-0 border-gray-500"><span class="text-muted fw-semibold text-muted d-block fs-7">Useragent</span></td> 
                                                          <td colspan="4 " class="p-0 border-gray-500"><? echo $login['useragent']; ?> </td>
                                                        </tr>
                                                     <?
        } ?>
                                        </tbody>
                                        <!--end::Tbody-->
                                    </table>
                                    <button type="button" class="btn btn-primary btn-sm" id="selectAllButton">Select All Users</button>
  <button type="button" class="btn btn-warning btn-sm" id="blockButton" onclick="blockOrSuspendUsers('block')">Block Selected Users</button>
    <button type="button" class="btn btn-info btn-sm" id="suspendButton" onclick="blockOrSuspendUsers('suspend')">Disable Instant/Auto Withdaw</button>
</form>
                                    <!--end::Table-->
                                </div>
                                <!--end::Table wrapper-->
                            </div>
                            <!--end::Card body-->
                           <script>
document.getElementById('selectAllButton').addEventListener('click', function() {
    var checkboxes = document.querySelectorAll('.user-checkbox');
    var allChecked = true;
    for (var checkbox of checkboxes) {
        if (!checkbox.checked) {
            allChecked = false;
            break;
        }
    }

    for (var checkbox of checkboxes) {
        checkbox.checked = !allChecked;
    }

    this.textContent = allChecked ? 'Select All Users' : 'Deselect All Users';
});

function blockOrSuspendUsers(action) {
    var form = document.getElementById('userForm');
    var formData = new FormData(form);
    formData.append('action', action); // Append the action type to the form data

    var button = action === 'block' ? document.getElementById('blockButton') : document.getElementById('suspendButton');
    var originalText = button.textContent;
    button.disabled = true;
    button.textContent = 'Processing...';

    fetch('admin?page=block_users_by_ip', {
        method: 'POST',
        body: formData
    })
    .then(response => response.text())
    .then(data => {
        console.log(data);
        alert(data); // Display success or error message
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = originalText;
    });
}
</script>
<?
    }
    if ($_GET['page'] == 'kyc')
    { ?>                  
<div class="card mb-2">
<div class="card-header min-h-unset py-2">
    <h3 class="card-title align-items-start flex-column m-0">
        <span class="card-label fw-bold text-gray-900">KYC Requests</span>
        <span class="text-gray-500 mt-1 fw-semibold fs-6">To see All KYC details go to <a  href="admin?page=kyc">Users KYC page</a></span>
    </h3>
</div>
<form method="POST" action="">
     <div class="card-body">
         <div class="table-responsive">
            <table  class="table table-row-dashed border-gray-300 align-middle gy-6 table-sm">
                <thead>
                <tr>
                    <th>User</th>
                    <th>Name</th>
                    <th>Details</th>
                    <th>Documents</th>
                    <th>Status</th>
                </tr>
                </thead>
            <tbody>
     <?php
        $cUser = mysqli_query($DB_CONN, "SELECT * FROM `users` WHERE kyc_data != ''");
        while ($row_User = mysqli_fetch_assoc($cUser))
        {
            $kyc_data = json_decode($row_User['kyc_data'], true);
?>
        <tr>

                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                    
                                    
                                        <!--begin::Name-->
                                        <div class="d-flex justify-content-start flex-column">
                                            <a  href="admin?page=user&id=<?php echo $row_User['id']; ?>&view=overview" class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6"><?php echo $row_User['username']; ?></a>
                                            <a  href="#" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                                            <span class="text-gray-900">Email</span>:   <?php echo $row_User['email']; ?></a>
                                        </div>
                                        <!--end::Name-->
                                    </div>
                                </td>
                                                            
                                                            
                            <td> <?=$kyc_data['name']; ?> </td>
                             <td>
                                <div class="d-flex align-items-center">
                                    <!--begin::Name-->
                                    <div class="d-flex justify-content-start flex-column">
                                    
                                        <a  href="#" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                                        <span class="text-gray-900">Document</span>:    <?=$kyc_data['document']; ?></a>
                                        <a  href="#" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                                        <span class="text-gray-900">Document No</span>:     <?=$kyc_data['docnumber']; ?></a>
                                        <a  href="#" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                                        <span class="text-gray-900">Country</span>:     <?=$kyc_data['country']; ?></a>
                                        <a  href="#" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                                        <span class="text-gray-900">Address</span>:     <?=$kyc_data['address']; ?></a>
                                        
                                    </div>
                                    <!--end::Name-->
                                </div>
                            </td>
                             <td>
                            <div class="d-flex align-items-center">
                                <!--begin::Name-->
                                <div class="d-flex justify-content-start flex-column">
                                    <a  href="<?=$kyc_data['front_image']; ?>" target="_blank" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                                    <span class="text-gray-900">Doc Front Image</span>:     <img src="<?=$kyc_data['front_image']; ?>" width="10px"></a>
                                    <a  href="<?=$kyc_data['back_image']; ?>" target="_blank" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                                    <span class="text-gray-900">Doc Back Image</span>:  <img src="<?=$kyc_data['back_image']; ?>" width="10px"></a>
                                        <a  href="<?=$kyc_data['address_image']; ?>" target="_blank" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                                    <span class="text-gray-900">Address Proof</span>:   <img src="<?=$kyc_data['address_image']; ?>" width="10px"></a>
                                </div>
                                <!--end::Name-->
                            </div>
                        </td>

    <td>
        <? if($row_User['kyc'] == 2) { ?>
        <div class="d-flex justify-content-end flex-shrink-0">
        <form method="POST" action="">
        <input type="hidden" name="hide_id" value="<?php echo $row_User['id'] ?>" >  
        <button type="submit" class="btn btn-sm btn-light-success btn-icon-success  hover-scale me-2" name="approve"  ><i class="ki-duotone ki-verify fs-1"><span class="path1"></span><span class="path2"></span></i></button>  </form> 
        <form method="POST" action="">
        <input type="hidden" name="hide_id" value="<?php echo $row_User['id'] ?>" >  
        <button type="submit" class="btn btn-sm btn-light-danger btn-icon-danger    hover-scale" name="reject"  ><i class="ki-duotone ki-cross-square fs-1"><span class="path1"></span><span class="path2"></span></i> </button>  </form> 
         </div>
     <? } ?>
         </td>
    </tr>  
<? } ?>         
            </tbody></table>
</div>
</div>
    </div>
<?
    }
   if ($_GET['page'] == 'newsletter') { 
?>
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header min-h-unset py-2">
                <ul class="nav nav-tabs card-header-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#emailNewsletter">Email Newsletter</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#telegramNewsletter">Telegram Newsletter</a>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content">
                    <!-- Email Newsletter Tab -->
                    <div class="tab-pane fade show active" id="emailNewsletter">
                        <form id="emailNewsletterForm">
                            <div class="row">
                                <div class="col-md-2 mb-2">
                                    <label class="fs-9">Send to</label>
                                </div>
                                <div class="col-md-10 mb-2">
                                    <select name="type" class="form-control form-control-sm" id="type">
                                        <option value="1">All users</option>
                                        <option value="2">Specific User</option>
                                        <option value="3">Active Users</option>
                                        <option value="4">Non Active Users</option>
                                        <option value="5">Users who haven't made deposit</option>
                                        <option value="6">Users who have made deposit (active only)</option>
                                        <?php 
                                        $select_user = mysqli_query($DB_CONN, "SELECT * FROM `packages` WHERE status = 1");
                                        while ($row_user = mysqli_fetch_assoc($select_user)) { 
                                        ?>
                                        <option value="<?php echo $row_user['id'] ?>">
                                            Users who have made deposit in -> <?php echo $row_user['name'] ?>
                                        </option>
                                        <?php } ?>
                                    </select>
                                </div>
                                
                                <div id="rowu" style="display:none;">
                                    <div class="row">
                                        <div class="col-md-2 mb-2">
                                            <label class="fs-9">Username</label>
                                        </div>
                                        <div class="col-md-10 mb-2">
                                            <select name="username" class="form-control form-control-sm">
                                                <?php 
                                                $select_user = mysqli_query($DB_CONN, "SELECT * FROM users WHERE id != 1");
                                                while ($row_user = mysqli_fetch_assoc($select_user)) { 
                                                ?>
                                                <option value="<?php echo $row_user['id'] ?>">
                                                    <?php echo $row_user['username'] ?>
                                                </option>
                                                <?php } ?>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-2 mb-2">
                                    <label class="fs-9">Subject</label>
                                </div>
                                <div class="col-md-10 mb-2">
                                    <input type="text" name="subject" class="form-control form-control-sm" required>
                                </div>

                                <div class="col-md-2 mb-2">
                                    <label class="fs-9">Message</label>
                                </div>
                                <div class="col-md-10 mb-2">
                                    <textarea class="form-control form-control-sm" name="message" rows="5" required></textarea>
                                </div>
                            </div>
                        </form>
                        <div class="mt-3">
                            <button type="button" class="btn btn-primary" id="sendEmailNewsletter">Send Newsletter</button>
                            <button type="button" class="btn btn-secondary" id="testEmailNewsletter">Test Newsletter</button>
                        </div>
                    </div>

                    <!-- Telegram Newsletter Tab -->
                    <div class="tab-pane fade" id="telegramNewsletter">
                        <form id="telegramNewsletterForm" enctype="multipart/form-data">
                            <div class="row">
                               <div class="col-md-12 mb-3">
                                        <label class="form-label">Message Content</label>
                                      
                                        <textarea name="content" rows="5" class="form-control form-control-sm" required></textarea>
                                          <div class="small text-muted mb-2">
                                            You can include links using:
                                           
                                            1. Markdown style: <code>[Click here](https://example.com)</code>
                                            2. Or add buttons below for external links
                                        </div>
                                    </div>

                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Newsletter Image</label>
                                    <div class="image-input image-input-outline" data-kt-image-input="true" 
                                         style="background-image: url('svg/avatars/blank.svg')">
                                        <div class="image-input-wrapper w-200px" id="newsletter-image-preview"
                                             style="background-image: url('bitders/assets/placeholder.svg')">
                                        </div>
                                        <label class="btn btn-icon btn-circle btn-color-muted btn-active-color-primary w-25px h-25px bg-body shadow"
                                               data-kt-image-input-action="change"
                                               data-bs-toggle="modal"
                                               data-bs-target="#kt_modal_100"
                                               title="Choose newsletter image">
                                            <i class="ki-duotone ki-pencil fs-6"><span class="path1"></span><span class="path2"></span></i>
                                        </label>
                                        <span class="btn btn-icon btn-circle btn-color-muted btn-active-color-primary w-25px h-25px bg-body shadow"
                                              data-kt-image-input-action="cancel"
                                              data-bs-toggle="tooltip"
                                              data-bs-dismiss="click"
                                              title="Cancel image">
                                            <i class="ki-outline ki-cross fs-3"></i>
                                        </span>
                                        <span class="btn btn-icon btn-circle btn-color-muted btn-active-color-primary w-25px h-25px bg-body shadow"
                                              data-kt-image-input-action="remove"
                                              data-bs-toggle="tooltip"
                                              data-bs-dismiss="click"
                                              title="Remove image">
                                            <i class="ki-outline ki-cross fs-3"></i>
                                        </span>
                                        <input type="hidden" name="selected_image" id="newsletter_image_url">
                                    </div>
                                </div>

                                <div class="col-md-12 mb-3">
                                    <h5>Buttons</h5>
                                    <div id="buttons-container-nl">
                                        <!-- Button inputs will be added here -->
                                    </div>
                                    <button type="button" class="btn btn-sm btn-primary add_another_faqs py-0" onclick="addButtonNL()">Add Another Button</button>
                                </div>

                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Mode</label>
                                    <select name="mode" class="form-select form-select-sm" id="telegramMode">
                                        <option value="test">Test</option>
                                        <option value="channel">Channel</option>
                                        <option value="live">All Users</option>
                                    </select>
                                </div>
                            </div>
                        </form>
                        <div class="mt-3">
                            <button type="button" class="btn btn-primary btn-sm" onclick="sendNewsletter('test')">Send Test</button>
                            <button type="button" class="btn btn-success btn-sm" id="sendAllButton" onclick="sendNewsletter('live')" style="display: none;">Send to All Users</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Email Newsletter Scripts
    $('#type').change(function() {
        $('#rowu').toggle($(this).val() === '2');
    });
    
    function handleEmailSubmit(isTest = false) {
        var $btn = isTest ? $('#testEmailNewsletter') : $('#sendEmailNewsletter');
        var originalText = $btn.html();
        
        var formData = new FormData($('#emailNewsletterForm')[0]);
        formData.append('test', isTest);
        
        if (!$('#emailNewsletterForm')[0].checkValidity()) {
            $('#emailNewsletterForm')[0].reportValidity();
            return;
        }
        
        $.ajaxSetup({
            contentType: "application/x-www-form-urlencoded; charset=UTF-8"
        });
        
        $('#sendEmailNewsletter, #testEmailNewsletter').prop('disabled', true);
        $btn.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sending...');
        
        $.ajax({
            url: '?page=send_newsletter',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    let message = response.message + '<br><br>';
                    
                    if (response.users && response.users.length > 0) {
                        message += '<div style="max-height: 200px; overflow-y: auto;">';
                        response.users.forEach(function(username) {
                            message += `<div class="text-success">✓ Sent to ${username}</div>`;
                        });
                        
                        if (response.failed_users && response.failed_users.length > 0) {
                            response.failed_users.forEach(function(username) {
                                message += `<div class="text-danger">✗ Failed to send to ${username}</div>`;
                            });
                        }
                        message += '</div>';
                    }
                    
                    Swal.fire({
                        html: message,
                        icon: "success",
                        buttonsStyling: false,
                        confirmButtonText: "Ok, got it!",
                        customClass: {
                            confirmButton: "btn btn-primary"
                        }
                    });
                    
                    if (!isTest) {
                        $('#emailNewsletterForm')[0].reset();
                    }
                } else {
                    Swal.fire({
                        text: response.message || 'Failed to send newsletter',
                        icon: "error",
                        buttonsStyling: false,
                        confirmButtonText: "Ok, got it!",
                        customClass: {
                            confirmButton: "btn btn-primary"
                        }
                    });
                }
            },
            error: function() {
                Swal.fire({
                    text: 'Server error occurred',
                    icon: "error",
                    buttonsStyling: false,
                    confirmButtonText: "Ok, got it!",
                    customClass: {
                        confirmButton: "btn btn-primary"
                    }
                });
            },
            complete: function() {
                $('#sendEmailNewsletter, #testEmailNewsletter').prop('disabled', false);
                $btn.html(originalText);
            }
        });
    }
    
    $('#sendEmailNewsletter').click(function() {
        Swal.fire({
            text: 'Are you sure you want to send this newsletter?',
            icon: "question",
            showCancelButton: true,
            buttonsStyling: false,
            confirmButtonText: "Yes, send it!",
            cancelButtonText: "No, cancel",
            customClass: {
                confirmButton: "btn btn-primary",
                cancelButton: "btn btn-active-light"
            }
        }).then((result) => {
            if (result.isConfirmed) {
                handleEmailSubmit(false);
            }
        });
    });
    
    $('#testEmailNewsletter').click(function() {
        handleEmailSubmit(true);
    });

    // Telegram Newsletter Scripts
    let buttonCounter = 0;

    window.addButtonNL = function() {
        const container = $('#buttons-container-nl');
        const newButton = document.createElement('div');
        newButton.className = 'button-input mb-3';
        newButton.innerHTML = `
            <div class="row">
                <div class="col-md-3">
                    <input type="text" class="form-control form-control-sm" name="button_text[]" placeholder="Button Name">
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm" name="button_type[]">
                        <option value="url">URL</option>
                        <option value="callback_data">callback_data</option>
                        <option value="web_app">WebApp URL</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control form-control-sm" name="button_data[]" placeholder="Button Action">
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm" name="button_position[]">
                        <option value="separate" selected="">Separate Row</option>
                        <option value="same">Same Row</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-sm btn-danger remove-button" onclick="removeButton(this)">×</button>
                </div>
            </div>
        `;
        container.append(newButton);
        buttonCounter++;
    };

    window.removeButton = function(button) {
        $(button).closest('.button-input').remove();
        buttonCounter--;
    };

    $('#telegramMode').on('change', function() {
        const mode = $(this).val();
        const sendAllButton = $('#sendAllButton');
        
        if (mode === 'live') {
            Swal.fire({
                title: 'Are you sure?',
                text: "This will send the newsletter to all users!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, continue!',
                cancelButtonText: 'No, cancel!',
                reverseButtons: true
            }).then((result) => {
                if (!result.isConfirmed) {
                    $(this).val('test');
                    sendAllButton.hide();
                }
            });
            sendAllButton.show();
        } else {
            sendAllButton.hide();
        }
    });


    // Telegram newsletter sending function
    window.sendNewsletter = function(mode) {
        const form = document.getElementById('telegramNewsletterForm');
        const formData = new FormData(form);
        const selectedMode = document.getElementById('telegramMode').value;
        formData.set('mode', selectedMode);
        
        const button = mode === 'test' ? 
            $('button[onclick="sendNewsletter(\'test\')"]') : 
            $('#sendAllButton');
        
        button.attr('data-kt-indicator', 'on').prop('disabled', true);
        
        $.ajax({
            url: 'admin.php?page=tgnews',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                button.removeAttr('data-kt-indicator').prop('disabled', false);
                
                const result = typeof response === 'string' ? JSON.parse(response) : response;
                
                if (result.success) {
                    Swal.fire({
                        text: result.message,
                        icon: "success",
                        buttonsStyling: false,
                        confirmButtonText: "Ok, got it!",
                        customClass: {
                            confirmButton: "btn btn-primary"
                        }
                    });
                    


                    // Log details if available
                    if (result.details) {
                        console.log('Success count:', result.details.success_count);
                        console.log('Fail count:', result.details.fail_count);
                        if (result.details.errors.length > 0) {
                            console.log('Errors:', result.details.errors);
                        }
                    }
                } else {
                    Swal.fire({
                        text: result.message || "Failed to send newsletter",
                        icon: "error",
                        buttonsStyling: false,
                        confirmButtonText: "Ok, got it!",
                        customClass: {
                            confirmButton: "btn btn-primary"
                        }
                    });
                }
            },
            error: function(xhr, status, error) {
                button.removeAttr('data-kt-indicator').prop('disabled', false);
                Swal.fire({
                    text: "An error occurred while sending the newsletter.",
                    icon: "error",
                    buttonsStyling: false,
                    confirmButtonText: "Ok, got it!",
                    customClass: {
                        confirmButton: "btn btn-primary"
                    }
                });
                console.error('Ajax error:', status, error);
            }
        });
    };

    // Add initial button row for Telegram newsletter
    addButtonNL();
});</script>


<?php }
    if ($_GET['page'] == 'pending_investments')
    {
        if (isset($_POST['submit']))
        {
           $alter = validateAdminAuth($admin_settings, $_POST['alternative_passphrase'], 'pending_deposit');
        if ($alter){
            $r_id = $_POST['r_id'];
            $tex_id = $_POST['tex_id'];
            $user_id = $_POST['user_id'];
            $amounte = $_POST['amount'];
            $dep = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT * from package_deposits where id = '{$r_id}'"));
            $currency = mysqli_query($DB_CONN, "SELECT * from currencies where id = '{$dep['payment_method_id']}'");
            $currency = mysqli_fetch_assoc($currency);
            extract(deposit_fee($currency, $amounte));
            if($eligible1){
                $currency = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT * from currencies where id = '{$dep['payment_method_id']}'"));
                activate_package($r_id, $amounte, $fee, $tex_id, $dep['user_id'], $dep['payment_method_id'], $dep['package_id'], $dep['plan_id'], $currency);
                $alert = true;
                $alert_class = 'alert alert-success alert-dismissible alert-custom';
                $alert_message = 'Approved Successfully!';
            }
        } 
        } 
        if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['deny'])) {
            $hide_id = intval($_POST['hide_id']);
            $sql = "UPDATE package_deposits SET status = 2 WHERE id = ?";
            $stmt = $DB_CONN->prepare($sql);
            $stmt->bind_param("i", $hide_id);
        
            if ($stmt->execute()) {
                $alert = true;
                $alert_class = 'alert alert-success alert-dismissible alert-custom';
                $alert_message = 'Denied Successfully!';
            } else {
                echo "Error updating status: " . $DB_CONN->error;
            }
        
            $stmt->close();
         }
?>


                                                            <div class="card">
                                <div class="card-header min-h-unset py-2">
                                            <!--begin::Card title-->
                                            <h3 class="card-title align-items-start flex-column m-0">
                                                        <span class="card-label fw-bold text-gray-900">Pending Investments</span>
                                                    
                                                    </h3>
                                            <!--end::Card title-->
                                        </div>
                                <div class="card-body">
            <?php if ($alert)  {?>
            <div class="<?=$alert_class?>">
                <?=$alert_message?>
            </div>
            <?php  }?>

           <div class="table-responsive">
                <table  class="table table-sm table-striped table-bordered display dataTable no-footer" id="example" >
                                        <thead class="">
        <tr>
            <th> ID  </th>
        <th> Username  </th>
    
        <th> Amount / Currency</th>
        <th> Package </th>
    
        <th> Address/TXN ID </th>
        <th> Date  Time </th>
        <th>Action </th>
    
        </tr>
    </thead>


    <tbody>
       <?php    if ($_GET['view'] == 'all') {
        $cUser = mysqli_query($DB_CONN, "SELECT *, (select username from users where id = package_deposits.user_id) as username, (select oauth_uid from users where id = package_deposits.user_id) as oauth_uid, (select sponsor from users where id = package_deposits.user_id) as sponsor, (select auto_withdraw from users where id = package_deposits.user_id) as auto_withdraw, (select 2fa from users where id = package_deposits.user_id) as 2fa, (select email from users where id = package_deposits.user_id) as email, (SELECT name from currencies where id = package_deposits.payment_method_id) as payment_method, (SELECT address_url from currencies where id = package_deposits.payment_method_id) as address_url, (SELECT de_pm_id from currencies where id = package_deposits.payment_method_id) as processor, (SELECT name from packages where id = package_deposits.package_id) as package FROM `package_deposits` where status = 2 and last_earningDateTime is NULL and payment_method_id in (SELECT id FROM `currencies` WHERE de_pm_id !=0 ) order by id desc");
        while ($row_User = mysqli_fetch_assoc($cUser))
        {
            $slct_sponsor = mysqli_fetch_assoc(mysqli_query($DB_CONN, "select * from users where id='{$row_User['sponsor']}'"));
            $processor = mysqli_fetch_assoc(mysqli_query($DB_CONN, "select name from payment_methods where id='{$row_User['processor']}'"));
            $currencies = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT u.*, c.address_url     FROM users u    JOIN currencies c ON u.payment_method_id = c.id"))
            
?>
        <tr>
            <td> <?php echo $row_User['id'] ?>  </td>
            <td> username: <b><a  href="admin?page=user&id=<?php echo $row_User['user_id'] ?>&view=overview"><?php echo $row_User['username'] ?></a><?php echo isset($row_User['oauth_uid']) ? '<span class="badge badge-light-primary badge-sm">' . $row_User['oauth_uid'] . '</span>' : ''; ?></b><br> <small class="fs-9">email:<?php echo $row_User['email'] ?> <br>sponsor:<?php if ($row_User['sponsor'] == 0)
            {
                echo "N/A";
            }
            else
            { ?><b><a  href="admin?page=user&id=<?php echo $row_User['sponsor'] ?>&view=overview"><?php echo $slct_sponsor['username'] ?></a></b> <?php
            } ?></a> <br>
             <?
            $w = user_withdraw_status($row_User['auto_withdraw']);
            $tfa = user_2fa_status($row_User['2fa']);
             echo "W: $w | 2FA: $tfa"; ?>   </small></td>
            
            <td> <b><?=$preferences['symbol'] ?><?php echo amount_format($row_User['amount']) ?> </b> <img width="20px" src="images/icons/<?php echo $row_User['payment_method_id'] ?>.svg"/><?php echo $row_User['payment_method'] ?> <br>Processor: <?php echo $processor['name'] ?> </td>
    
            <td> <?php echo $row_User['package'] ?> </td>
        
            <td>  <a  href="<?php echo $row_User['address_url']. $row_User['address']; ?>/" target="_blank"><? echo $row_User['address'];?></a> <br><?php echo $row_User['ip'] ?>   <br> <?php echo $row_User['txn_id'] ?>  </td>
           <td class="p-0">
                                                                                <span class="text-gray-900 fw-bold d-block fs-7"><?php echo date('d-m-Y H:i:s', strtotime($row_User['datetime'])); ?></span>
                                                                                <span class="text-muted fw-semibold d-block fs-8"><?php $dt = date("M d, Y h:i:s A", strtotime($row_User['datetime']));
            echo time_elapsed_string($dt, true); ?> </span>
                                                                            </td>
           
            <td> 
            <?php if ($row_User['status'] == '0' || $row_User['status'] == '2'  ){ ?>
            <div class="d-flex justify-content-end flex-shrink-0">
            <a href="#" title="Approve" class="btn btn-sm btn-light-success btn-icon-success  hover-scale me-2" data-bs-toggle="modal" data-bs-target="#myModal<?php echo $row_User['id'] ?>" >
                    <i class="ki-duotone ki-verify fs-1"><span class="path1"></span><span class="path2"></span></i> </a> 
            <form method="POST" action="">
            <input type="hidden" name="hide_id" value="<?php echo $row_User['id'] ?>" >  
            <button type="submit" class="btn btn-sm btn-light-danger btn-icon-danger    hover-scale" name="deny"  ><i class="ki-duotone ki-cross-square fs-1"><span class="path1"></span><span class="path2"></span></i> </button>  </form> 
            </div>
             <?php }  else    {  echo "Expired"; } ?>
                 </td>       
        </tr>
    <?php
        } }?>


    <?php

        $cUser = mysqli_query($DB_CONN, "SELECT *, (select username from users where id = package_deposits.user_id) as username, (select oauth_uid from users where id = package_deposits.user_id) as oauth_uid, (select sponsor from users where id = package_deposits.user_id) as sponsor, (select auto_withdraw from users where id = package_deposits.user_id) as auto_withdraw, (select 2fa from users where id = package_deposits.user_id) as 2fa, (select email from users where id = package_deposits.user_id) as email, (SELECT name from currencies where id = package_deposits.payment_method_id) as payment_method, (SELECT address_url from currencies where id = package_deposits.payment_method_id) as address_url, (SELECT de_pm_id from currencies where id = package_deposits.payment_method_id) as processor, (SELECT name from packages where id = package_deposits.package_id) as package FROM `package_deposits` where status = 0 and last_earningDateTime is NULL and payment_method_id in (SELECT id FROM `currencies` WHERE de_pm_id !=0 ) order by id desc LIMIT 100");
        while ($row_User = mysqli_fetch_assoc($cUser))
        {
            $slct_sponsor = mysqli_fetch_assoc(mysqli_query($DB_CONN, "select * from users where id='{$row_User['sponsor']}'"));
            $processor = mysqli_fetch_assoc(mysqli_query($DB_CONN, "select name from payment_methods where id='{$row_User['processor']}'"));
            
?>
               <tr>
            <td> <?php echo $row_User['id'] ?>  </td>
            <td> username: <b><a  href="admin?page=user&id=<?php echo $row_User['user_id'] ?>&view=overview"><?php echo $row_User['username'] ?></a><?php echo isset($row_User['oauth_uid']) ? '<span class="badge badge-light-primary badge-sm">' . $row_User['oauth_uid'] . '</span>' : ''; ?></b><br> <small class="fs-9">email:<?php echo $row_User['email'] ?> <br>sponsor:<?php if ($row_User['sponsor'] == 0)
            {
                echo "N/A";
            }
            else
            { ?><b><a  href="admin?page=user&id=<?php echo $row_User['sponsor'] ?>&view=overview"><?php echo $slct_sponsor['username'] ?></a></b> <?php
            } ?></a> <br>
             <?
            $w = user_withdraw_status($row_User['auto_withdraw']);
            $tfa = user_2fa_status($row_User['2fa']);
             echo "W: $w | 2FA: $tfa"; ?>   </small></td>
            
            <td> <b><?=$preferences['symbol'] ?><?php echo amount_format($row_User['amount']) ?> </b> <img width="20px" src="images/icons/<?php echo $row_User['payment_method_id'] ?>.svg"/><?php echo $row_User['payment_method'] ?> <br>Processor: <?php echo $processor['name'] ?> </td>
    
            <td> <?php echo $row_User['package'] ?> </td>
        
            <td>  <a  href="<?php echo $row_User['address_url']. $row_User['address']; ?>/" target="_blank"><? echo $row_User['address'];?></a> <br><?php echo $row_User['ip'] ?>   <br> <?php echo $row_User['txn_id'] ?>  </td>
           <td class="p-0">
                                                                                <span class="text-gray-900 fw-bold d-block fs-7"><?php echo date('d-m-Y H:i:s', strtotime($row_User['datetime'])); ?></span>
                                                                                <span class="text-muted fw-semibold d-block fs-8"><?php $dt = date("M d, Y h:i:s A", strtotime($row_User['datetime']));
            echo time_elapsed_string($dt, true); ?> </span>
                                                                            </td>
           
            <td> 
            <?php if ($row_User['status'] == '0' || $row_User['status'] == '2'  ){ ?>
            <div class="d-flex justify-content-end flex-shrink-0">
            <a href="#" title="Approve" class="btn btn-sm btn-light-success btn-icon-success  hover-scale me-2" data-bs-toggle="modal" data-bs-target="#myModal<?php echo $row_User['id'] ?>" >
                    <i class="ki-duotone ki-verify fs-1"><span class="path1"></span><span class="path2"></span></i> </a> 
            <form method="POST" action="">
            <input type="hidden" name="hide_id" value="<?php echo $row_User['id'] ?>" >  
            <button type="submit" class="btn btn-sm btn-light-danger btn-icon-danger    hover-scale" name="deny"  ><i class="ki-duotone ki-cross-square fs-1"><span class="path1"></span><span class="path2"></span></i> </button>  </form> 
            </div>
             <?php }  else    {  echo "Expired"; } ?>
                 </td>       
      
        </tr>
    <?php
        } ?>






    </tbody>
</table>
</div>
</div></div>     
                                            
<?php $cUser = mysqli_query($DB_CONN, "SELECT *, (select username from users where id = package_deposits.user_id) as username, (select oauth_uid from users where id = package_deposits.user_id) as oauth_uid, (select sponsor from users where id = package_deposits.user_id) as sponsor, (select auto_withdraw from users where id = package_deposits.user_id) as auto_withdraw, (select 2fa from users where id = package_deposits.user_id) as 2fa, (select email from users where id = package_deposits.user_id) as email, (SELECT name from currencies where id = package_deposits.payment_method_id) as payment_method, (SELECT address_url from currencies where id = package_deposits.payment_method_id) as address_url, (SELECT de_pm_id from currencies where id = package_deposits.payment_method_id) as processor, (SELECT name from packages where id = package_deposits.package_id) as package FROM `package_deposits` where status in (0,1,2) and last_earningDateTime is NULL and payment_method_id in (SELECT id FROM `currencies` WHERE de_pm_id !=0 ) order by id desc");
        while ($row_User = mysqli_fetch_assoc($cUser))
        { ?>
      <div id="myModal<?php echo $row_User['id'] ?>" class="modal fade"  tabindex="-1" aria-modal="true" role="dialog" >
  <div class="modal-dialog">
    <!-- Modal content-->
    <div class="modal-content">
        <form method="POST" action="" >
            <div class="modal-header"> 
<div class="d-flex align-items-center">
            <!--begin::Name-->
            <div class="d-flex justify-content-start flex-column">
                <a  class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6">Approve Investment <span class=""> #<? echo $row_User['id'] ?> </span></a>
                <a  class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                <span class="text-gray-900">Currency</span>: <span class=""><?php echo $row_User['payment_method'] ?>  </span> | <span class="text-gray-900">Plan</span>: <span class=""><?php echo $row_User['package'] ?></span></a>
            </div>
            <!--end::Name-->
        </div>
        <div class="btn btn-icon btn-sm btn-active-light-primary ms-2" data-bs-dismiss="modal" aria-label="Close">
                    <i class="ki-duotone ki-cross fs-1"><span class="path1"></span><span class="path2"></span></i>
                </div>
                <!--end::Close-->
            </div>
      <div class="modal-body">
        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9"> Amount: </label>
                </div>
            </div>
            <div class="col-md-8">
               <input type="number" max="1000" name="amount" class="form-control form-control-sm" placeholder="0.00" value="<?php echo $row_User['amount'] ?>">
                <small id="emailHelp" class="form-text text-muted fs-9"> The amount  of investment</small>
            </div>
        </div>
        <div class="separator separator-dashed my-2"></div>
        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9"> Transaction ID: </label>
                </div>
            </div>
            <div class="col-md-8">
               <input type="text" max="1000" name="tex_id" class="form-control form-control-sm" required placeholder="0xxx" value="<?php echo $row_User['txn_id'] ?>">
                <small id="emailHelp" class="form-text text-muted fs-9"> Transaction URL</small>
            </div>
        </div>
    
        
  
        <input type="hidden" name="user_id" value="<?php echo $row_User['user_id'] ?>" >
        <input type="hidden" name="r_id" value="<?php echo $row_User['id'] ?>" >
        <?php if ($admin_settings['page']['pending_deposit']) { ?>
     
 
         <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9"> Current Alternate Password </label>
                </div>
            </div>
          
            <div class="col-md-8">
                <input type="password" name="alternative_passphrase" value="" class="form-control form-control-sm" autocomplete="new-password" required=""/>
                <small id="emailHelp" class="form-text text-muted fs-9"> </small>
            </div>
            </div>
      
  <? } ?>
      </div>
      <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
          
        <input type="submit" name="submit" class="btn btn-success" value="Submit" >
       
      </div>
      </form>
    </div>

  </div>
</div>
<? }?>
<?
   
    }
    if ($_GET['page'] == 'pending_withdrawals')
    {
        $log = array();
        if (isset($_POST['deny']))
        {
        $alter = validateAdminAuth($admin_settings, $_POST['alternative_passphrase'], 'pending_withdraw');
        if ($alter){
            $hide_id = $_POST['hide_id'];
            $update_tex = mysqli_query($DB_CONN, "UPDATE transactions set status='2' WHERE id='$hide_id' and status = 0");
            $pp = mysqli_query($DB_CONN, "SELECT * FROM `transactions` where id = '{$hide_id}'") or die(mysqli_error($DB_CONN));
            $perfect = mysqli_fetch_assoc($pp);
            $amount = $perfect['amount'];
            $user_id = $perfect['user_id'];
            add_balance($user_id, $perfect['payment_method_id'], $amount);
        }
        }
        if (isset($_POST['submit']))
        {
            $alter = validateAdminAuth($admin_settings, $_POST['alternative_passphrase'], 'pending_withdraw');
            if ($alter){
            $r_id = $_POST['r_id'];
            $w = mysqli_query($DB_CONN, "select * from transactions WHERE id='$r_id'");
            $with = mysqli_fetch_assoc($w);
            $method = mysqli_query($DB_CONN, "SELECT * from currencies where id = '{$with['payment_method_id']}'");
            $method = mysqli_fetch_assoc($method);
            $tex_id = $_POST['tex_id'];
            $user_id = $_POST['user_id'];
            $amount = $_POST['amount'];
            $address = $with['address'];
            $methodpm = $method['name'];
            $memo = str_replace(array("#address#","#method#", "#txn_id#"), array($address ,$methodpm, $tex_id), $withdraw_settings['manual_memo']);
            $update_tex = mysqli_query($DB_CONN, "UPDATE transactions set status='1',txn_id='$tex_id',amount='$amount',address='$address',detail='$memo' WHERE id='$r_id' and status = 0");
            sendmail("withdraw_user_notification", $user_id, array(), array('amount' => $amount, 'txn_id' => $tex_id, 'account' => $method['name'], 'tx_url' => '', 'address' => $with['address']));
        }
        }
        $msg = "";
        if (isset($_POST['payment']))
        {
            $alter = validateAdminAuth($admin_settings, $_POST['alternative_passphrase'], 'pending_withdraw');
            if ($alter){
            $log = array();
            foreach ($_POST['check'] as $a => $b)
            {
            $query = "SELECT 
                t.*, 
                u.wallets as wallets,
                u.id as user_id,
                u.username as username,
                u.wi_pm_id as user_payment_method,
                c.name as currency_name,
                c.symbol,
                c.wi_pm_id as default_payment_method,
                COALESCE(
                    (SELECT currencies FROM payment_methods WHERE id = u.wi_pm_id AND u.wi_pm_id NOT IN (2, 6, 17)),
                    (SELECT currencies FROM payment_methods WHERE id = c.wi_pm_id)
                ) as currencies
            FROM transactions t
            INNER JOIN users u ON u.id = t.user_id
            INNER JOIN currencies c ON c.id = t.payment_method_id
            WHERE t.id = '{$a}' AND t.status = 0
            LIMIT 1";
            
            $result = mysqli_query($DB_CONN, $query) or die(mysqli_error($DB_CONN));
            $data = mysqli_fetch_assoc($result);
            
            if ($data) {
                $amount = $data['amount'] - $data['fee'];
                $payment_method_id = ($data['user_payment_method'] && !in_array($data['default_payment_method'], array(2, 6, 17))) 
                    ? $data['user_payment_method'] 
                    : $data['default_payment_method'];
                
                $system = json_decode($data['currencies'], true);
                if(!$data['address']) {
                    $data['wallets'] = json_decode($data['wallets'], true);
                    $field = strtolower(str_replace(' ', '', $data['currency_name']));
                    $data['address'] = $data['wallets'][$field] ?? null;
                }
                $processor = new PaymentProcessor($payment_method_id, $system, $DB_CONN, $preferences, $siteURL, $g_alert, $main_link, $siteName);
                $tx_id = $processor->processWithdrawal($data['address'], $amount, $data['id'], $data['symbol']);

                $memo = str_replace(array("#address#","#method#", "#txn_id#"), array($data['address'] ,$data['currency_name'], $tx_id), $withdraw_settings['manual_memo']);
                $log[] = $wid;
                if ($tx_id)
                {
                    $user = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT * from users where id = '{$data['user_id']}'"));
                    $msg .= "Payment sent to {$data['username']} with TXN ID: {$tx_id}<br>";
                    mysqli_query($DB_CONN, "UPDATE `transactions` set status = '1',detail='$memo', txn_id = '{$tx_id}' where id = {$a}");
                    sendmail("withdraw_user_notification", $data['user_id'], $user, array('amount' => $amount, 'txn_id' => $tx_id, 'account' => $data['currency_name'], 'tx_url' => '', 'address' => $data['address']));
                }
                else
                {
                    $msg .= "Error in Sending Payment to {$data['username']}<br>" . print_r($tx_id) . "<br>";
                }
            }
            }
           }
        }
        if (isset($_POST['remove']))
        {
        $alter = validateAdminAuth($admin_settings, $_POST['alternative_passphrase'], 'pending_withdraw');
        if ($alter){
            foreach ($_POST['check'] as $a => $b)
            {
                $pp = mysqli_query($DB_CONN, "SELECT * FROM `transactions` where id = '{$a}' and status = 0") or die(mysqli_error($DB_CONN));
                $perfect = mysqli_fetch_assoc($pp);
                $amount = $perfect['amount'];
                $user_id = $perfect['user_id'];
                add_balance($user_id, $perfect['payment_method_id'], $amount);
                mysqli_query($DB_CONN, "DELETE from transactions where id = '{$a}'");
                $msg .= "Withdraw deleted # {$a}";
            }
        }
        }
        if (isset($_POST['process']))
        {
       $alter = validateAdminAuth($admin_settings, $_POST['alternative_passphrase'], 'pending_withdraw');

        if ($alter){
            foreach ($_POST['check'] as $a => $b)
            {
                mysqli_query($DB_CONN, "UPDATE `transactions` set status = 1, detail = 'Withdraw Processed' where id = {$a} and status = 0");
                $msg .= "Withdraw mark as completed # {$a}";
            }
        }}  ?>


              <div class="card">      
        <div class="card-header min-h-unset py-2">
                    <!--begin::Card title-->
                    <h3 class="card-title align-items-start flex-column m-0">
                                <span class="card-label fw-bold text-gray-900">Pending Withdrawals</span>
                            
                            </h3>
                    <!--end::Card title-->
                </div>                               
        <div class="card-body">
                <?=$msg
?>
                <?
        if (count($log) > 0)
        {
            foreach ($log as $with_id)
            {
                $w = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT * FROM `payment_log` WHERE with_id = '{$with_id}' order by id desc limit 1"));
                echo "PAYMENT LOG FOR Withdraw # {$with_id}: {$w['detail']}<br>\n";
            }
        }
?>

<form method="post">
<div class="table-responsive">
    <table  class="table table-sm table-striped table-bordered display dataTable no-footer">
        <thead>
            <tr>
                <th>ID</th>
                <th>Select</th>
                <th>User Details</th>
                <th>Amount Details</th>
                <th>Account Details</th>
                <th>Time Stamp</th>
                <th>Actions</th>
            </tr>
        </thead><tbody>
    <?php $cUser = mysqli_query($DB_CONN, "select *, (select name from currencies where id = transactions.payment_method_id) as method,(select wi_pm_id from currencies where id = transactions.payment_method_id) as processor,
    (select symbol from currencies where id = transactions.payment_method_id) as symbol from transactions where status='0' and txn_type='withdraw'");
        while ($row_User = mysqli_fetch_assoc($cUser))
        {
            $slct_user = mysqli_fetch_assoc(mysqli_query($DB_CONN, "select * from users where id='{$row_User['user_id']}'"));
            $processor = mysqli_fetch_assoc(mysqli_query($DB_CONN, "select * from payment_methods where id='{$row_User['processor']}'"));
            $processor_u = mysqli_fetch_assoc(mysqli_query($DB_CONN, "select * from payment_methods where id='{$slct_user['wi_pm_id']}'"));
            $result = mysqli_query($DB_CONN, "select * from transactions where user_id = '{$row_User['user_id']}' AND ref_id = -1  ");
            if ($result && mysqli_num_rows($result) > 0) {
                    $slct_pak = true;
                } else {
                    $slct_pak = false;
                }
            $slct_sponsor = mysqli_fetch_assoc(mysqli_query($DB_CONN, "select username from users where id='{$slct_user['sponsor']}'"));
            $log = mysqli_fetch_assoc(mysqli_query($DB_CONN, "select * from payment_log where with_id='{$row_User['id']}'"))
?>
        <tr >
    <td><?php echo $row_User['id']; ?></td>
    <td <?php if ($slct_pak) { ?>style="background:red;"<?php } ?>>
        <input type="checkbox" name="check[<?php echo $row_User['id']; ?>]" id="check_<?php echo $row_User['id']; ?>" value="1">
    </td>
    <td>
        Username: <b><a  href="admin?page=user&id=<?php echo $slct_user['id']; ?>&view=overview"><?php echo $slct_user['username']; ?></a></b><br>
        <small class="fs-9">
            Email: <?php echo $slct_user['email']; ?><br>
            Sponsor: <b>
                <?php if ($slct_user['sponsor'] == 0) {
                    echo "n/a";
                } else { ?>
                    <a  href="admin?page=user&id=<?php echo $slct_user['sponsor']; ?>&view=overview"><?php echo $slct_sponsor['username']; ?></a>
                <?php } ?>
            </b><br>
            <?php 
            $w = user_withdraw_status($row_User['auto_withdraw']);
            $tfa = user_2fa_status($row_User['2fa']);
            echo "W: $w | 2FA: $tfa"; 
            ?>   
        </small>
    </td>
      <td>
    <div class="d-flex align-items-center">
        <!--begin::Avatar-->
        <div class="symbol me-5">
            <img alt="" src="images/icons/<?php echo $row_User['payment_method_id']; ?>.svg" width="15px"><br>
            <a  href="#" class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6"><?php echo $row_User['method']; ?></a>
        </div>
        <!--end::Avatar-->
        <!--begin::Name-->
        <div class="d-flex justify-content-start flex-column">
            <a  href="#" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                <span class="text-gray-900">Symbol</span>: <?php echo $row_User['symbol']; ?>
            </a>
            <a  href="#" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                <span class="text-gray-900">Requested</span>: <?=$preferences['symbol']; ?><?php echo amount_format($row_User['amount']); ?>
            </a>
            <a  href="#" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                <span class="text-gray-900">Fee</span>: <?php echo amount_format($row_User['fee']); ?>
            </a>
            <a  href="#" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                <span class="text-gray-900">Pay</span>: <?=$preferences['symbol']; ?><?php echo amount_format($row_User['amount'] - $row_User['fee']); ?>
            </a>
            <a  href="#" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                <span class="text-gray-900"><?php echo $row_User['symbol']; ?></span>: <?php $final = $row_User['amount'] - $row_User['fee']; echo number_format(fromcurrency($final, $row_User['symbol']), 8); ?>
            </a>
        </div>
        <!--end::Name-->
    </div>
</td>

<td>
    <? if($row_User['address']) { ?>
    <a href="<?php echo $row_User['address_url'] . $row_User['address']; ?>/" target="_blank"><?php echo $row_User['address']; ?></a><br>
    <?php  if ($slct_pak) { ?><b  style="color:red;">This user was awarded bonus/invest/deposit/earning from admin.</b><?php } ?> <br>
    Active Deposit: <b>$<?php echo number_format(mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT sum(amount) as c FROM `package_deposits` where status = 1 and user_id = '{$row_User['user_id']}'"))['c'], $preferences['round']); ?></b><br>
    Account Balance: <b>$<?php echo number_format($slct_user['balance']); ?></b><br>
    Processor: <b><span class="badge bg-primary"><?php echo $processor['name']; ?></span> <?php if ($processor_u['name']) { ?>/ <span class="badge bg-warning"><?php echo $processor_u['name']; ?></span> <?php } ?></b><br>
<? } else {
    $wallets = json_decode($slct_user['wallets'], true);
    foreach ($wallets as $key => $value) {
        if($value)
            echo "<strong>{$key}:</strong>$value<br>";
    }
} ?>
</td>

<td>
    <span class="text-gray-900 fw-bold d-block fs-7"><?php echo $row_User['timestamp']; ?></span>
    <span class="text-muted fw-semibold d-block fs-8"><?php $dt = date("M d, Y h:i:s A", strtotime($row_User['timestamp'])); echo time_elapsed_string($dt, true); ?></span>

    <?php if ($row_User['ref_id']) { ?>
        <span class="text-gray-900 fw-bold d-block fs-7">Timer</span>
        <span class="text-muted fw-semibold d-block fs-8"><?php echo $row_User['ref_id']; ?> Minutes</span>
    <?php } ?>
</td>

    <?php if ($row_User['status'] == '0')
    { ?>
        <td>
            <div class="d-flex justify-content-end flex-shrink-0">
            <a href="#" title="Approve" class="btn btn-sm btn-light-success btn-icon-success  hover-scale me-2" data-bs-toggle="modal" data-bs-target="#myModal<?php echo $row_User['id'] ?>" >
            <i class="ki-duotone ki-verify fs-1"><span class="path1"></span><span class="path2"></span></i> </a> 
       
    <form method="POST" action="">
    <input type="hidden" name="hide_id" value="<?php echo $row_User['id'] ?>" >  
    <button type="submit" class="btn btn-sm btn-light-danger btn-icon-danger    hover-scale" name="deny"  ><i class="ki-duotone ki-cross-square fs-1"><span class="path1"></span><span class="path2"></span></i> </button>  </form> 
     </div>
         </td>
<?php
    }
    else
    {
        echo "<td> Approved </td>";
    } ?>
    
</tr>
<?php if ($log) {?>
<tr>
    <td colspan="3">Payment Log Error.</td>
    <td colspan="4"><?php echo $log['detail'] ?></td>
</tr>
<? }?>

<?php
} ?>
</tbody>
</table>


<center class="mt-10"> 
<?php if ($admin_settings['page']['pending_withdraw']) { ?>
     
     <div class="row card card-body">
         <div class="row">
            <div class="col-md-2">
                <div class="form-group">
                    <label class="fs-9"> Current Alternate Password </label>
                </div>
            </div>
          
            <div class="col-md-10">
                <input type="password" name="alternative_passphrase" value="" class="form-control form-control-sm" autocomplete="new-password" required=""/>
                <small id="emailHelp" class="form-text text-muted fs-9"> </small>
            </div>
            </div>
           </div>
  <? } ?>
  <input type="button" value="Select all" class="btn btn-primary btn-sm" onclick="select_all_transactions()"> &nbsp; 
<input type="submit" value="Mass payment selected" name="payment" class="btn btn-success btn-sm"> &nbsp;
<input type="submit" value="Remove selected" name="remove" class="btn btn-warning btn-sm"> &nbsp; 
<input type="submit" value="Set selected as processed" name="process" class="btn btn-info btn-sm"><br><br>


</div>
</form>
</div>
</div>


 <?php $cUser = mysqli_query($DB_CONN, "select *, (select name from currencies where id = transactions.payment_method_id) as method,(select wi_pm_id from currencies where id = transactions.payment_method_id) as processor,
    (select symbol from currencies where id = transactions.payment_method_id) as symbol from transactions where status='0' and txn_type='withdraw'");
        while ($row_User = mysqli_fetch_assoc($cUser))
        { ?>
<div id="myModal<?php echo $row_User['id'] ?>" class="modal fade" role="dialog" aria-modal="true" tabindex="-1">
 <div class="modal-dialog modal-dialog-centered mw-650px">

    <div class="modal-content">
            <div class="modal-header"> 
              
<div class="d-flex align-items-center">
                                                                
            <!--begin::Name-->
            <div class="d-flex justify-content-start flex-column">
                <a  class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6">Approve Withdraw Manually <span class=""> #<? echo $row_User['id'] ?> </span></a>
                <a  class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                <span class="text-gray-900">Currency</span>: <span class=""><?php echo $row_User['method'] ?>  </span> | <span class="text-gray-900">Amount</span>: <span class=""><?php echo $row_User['amount'] ?></span></a>
            </div>
            <!--end::Name-->
        </div>
        <div class="btn btn-icon btn-sm btn-active-light-primary ms-2" data-bs-dismiss="modal" aria-label="Close">
                    <i class="ki-duotone ki-cross fs-1"><span class="path1"></span><span class="path2"></span></i>
                </div>
                <!--end::Close-->
            </div>

    <!-- Modal content-->
    <div class="modal-content">

        <form method="POST" action="" >
      <div class="modal-body">
            <input type="hidden" name="user_id" value="<?php echo $row_User['user_id'] ?>" >
        <input type="hidden" name="r_id" value="<?php echo $row_User['id'] ?>" >
   
       <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9"> Address: </label>
                </div>
            </div>
            <div class="col-md-8">
               <input type="text" class="form-control form-control-sm" value="<?php echo $row_User['address'] ?>">
                <small id="emailHelp" class="form-text text-muted fs-9"> Transaction Address</small>
            </div>
        </div> 
          <div class="separator separator-dashed my-2"></div>
    <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9"> Amount: </label>
                </div>
            </div>
            <div class="col-md-8">
               <input type="text" name="amount" class="form-control form-control-sm" value="<?php echo $row_User['amount'] ?>">
                <small id="emailHelp" class="form-text text-muted fs-9"> Amount to Pay <b><?php echo $row_User['symbol']; ?></span>: <?php $final = $row_User['amount'] - $row_User['fee']; echo number_format(fromcurrency($final, $row_User['symbol']), 8); ?></b></small>
            </div>
        </div>
         <div class="separator separator-dashed my-2"></div>
             <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9"> Transaction ID: </label>
                </div>
            </div>
            <div class="col-md-8">
               <input type="text" class="form-control form-control-sm" name="tex_id" value="Enter Transaction ID" required placeholder="0xxx">
                <small id="emailHelp" class="form-text text-muted fs-9"> Enter Transaction ID for the Payment</small>
            </div>
        </div>
         <div class="separator separator-dashed my-2"></div>
             <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9"> Transaction URL: </label>
                </div>
            </div>
            <div class="col-md-8">
               <input type="text" class="form-control form-control-sm" name="txn_url" value="Enter Transaction URL">
                <small id="emailHelp" class="form-text text-muted fs-9"> Enter Transaction URL if any</small>
            </div>
        </div>
       
      </div>
      <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
        <input type="submit" name="submit" class="btn btn-success" value="Submit" >
        
      </div>
      </form>
    </div>

  </div>
</div>
</div>
<? }?>
<script type="text/javascript">
var a = true;
function select_all_transactions() {
    $("input[type=checkbox]").prop('checked', a);
    if(a == true)
        a = false;
    else
        a = true;
}
</script>


<!-- Modal -->
<?
    }


if ($_GET['page'] == 'expiring_investments') 
{ ?>
                                    <!--end::Form-->
                                    <!--begin::Toolbar-->
                            <form action="#" method="post" id="topsearch">
                                    <!--begin::Card-->
                                    <div class="card mb-7">
                                        <!--begin::Card body-->
                                        <div class="card-body">
                                            <!--begin::Compact form-->
                                            <div class="d-flex align-items-center">
                                                <!--begin::Input group-->
                                                <div class="position-relative w-md-900px me-md-2">
                                                    <!--begin::Svg Icon | path: images/icons/duotune/general/gen021.svg-->
                                                    <span class="svg-icon svg-icon-3 svg-icon-gray-500 position-absolute top-50 translate-middle ms-6">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                                                            <rect opacity="0.5" x="17.0365" y="15.1223" width="8.15546" height="2" rx="1" transform="rotate(45 17.0365 15.1223)" fill="currentColor" />
                                                            <path
                                                                d="M11 19C6.55556 19 3 15.4444 3 11C3 6.55556 6.55556 3 11 3C15.4444 3 19 6.55556 19 11C19 15.4444 15.4444 19 11 19ZM11 5C7.53333 5 5 7.53333 5 11C5 14.4667 7.53333 17 11 17C14.4667 17 17 14.4667 17 11C17 7.53333 14.4667 5 11 5Z"
                                                                fill="currentColor"
                                                            />
                                                        </svg>
                                                    </span>
                                                    <!--end::Svg Icon-->
                                                    <input type="text" class="form-control form-control-solid ps-10" name="search" value="" placeholder="Search Amount/Txn" />
                                                </div>
                                                <!--end::Input group-->
                                                <!--begin:Action-->
                                                <div class="d-flex align-items-center">
                                                    <input type="hidden" name="last_id" value="0">
                                                    <button type="submit" class="btn btn-primary me-5">Search</button>
                                                    <a  id="kt_horizontal_search_advanced_link" class="btn btn-link" data-bs-toggle="collapse" href="#kt_advanced_search_form">Advanced Search</a>
                                                </div>
                                                <!--end:Action-->
                                            </div>
                                            <!--end::Compact form-->
                                            <!--begin::Advance form-->
                                            <div class="collapse" id="kt_advanced_search_form">
                                                <!--begin::Separator-->
                                                <div class="separator separator-dashed mt-9 mb-6"></div>
                                                <!--end::Separator-->
                                                <!--begin::Row-->
                                                <div class="row g-8 mb-8">
                                                    <!--begin::Col-->
                                                    <div class="col-xxl-3">
                                                        <label class="fs-6 form-label fw-bolder text-dark">Show Entries</label>
                                                        <select class="form-select form-select-solid" name="show" >
                                                        <option value="50">50</option>
                                                         <option value="100">100</option>
                                                          <option value="200">200</option>
                                                           <option value="500">500</option>
                                                         
                                                        </select>
                                                    </div>
                                                    
                                                     <div class="col-xxl-3">
                                                        <label class="fs-6 form-label fw-bolder text-dark">Data</label>
                                                        <select class="form-select form-select-solid" name="fake" >
                                                        <option value="NOT IN (SELECT id from users WHERE auto_withdraw = 4)">Real Only</option>
                                                         <option value="!=1">Real and Dummy Only</option>
                                                          <option value="IN (SELECT id from users WHERE auto_withdraw = 4)">Dummy Only</option>
                                                        </select>
                                                    </div>
                                                    <!--end::Col-->
                                                    <!--begin::Col-->
                                                    <div class="col-xxl-6">
                                                        <!--begin::Row-->
                                                        <div class="row g-8">
                                                            <!--begin::Col-->
                                                            <div class="col-lg-6">
                                                                <label class="fs-6 form-label fw-bolder text-dark">Order </label>
                                                                <!--begin::Select-->
                                                                <select class="form-select form-select-solid" data-placeholder="Order" name="orderby" >
                                                                     <option value="last_earningDateTime ASC">Last Earning ASC</option>
                                                                   <option value="last_earningDateTime desc">Last Earning DESC</option>
                                                                    <option value="datetime ASC">DateTime ASC</option>
                                                                    <option value="datetime desc">DateTime DESC</option>
                                                                    
                                                                </select>
                                                                <!--end::Select-->
                                                            </div>
                                                            <!--end::Col-->
                                                            <!--begin::Col-->
                                                                 <div class="col-lg-6">
                                                                <label class="fs-6 form-label fw-bolder text-dark">Select User Account Status</label>
                                                                <!--begin::Radio group-->
                                                              <div class="nav-group nav-group-fluid">
                                                                    <!--begin::Option-->
                                                                    <label class="fs-9">
                                                                        <input type="radio" class="btn-check" name="status" value="" checked="">
                                                                        <span class="btn btn-sm btn-color-muted btn-active btn-active-primary fw-bolder px-4">All</span>
                                                                    </label>
                                                                    <!--end::Option-->
                                                                    <!--begin::Option-->
                                                                    <label class="fs-9">
                                                                        <input type="radio" class="btn-check" name="status" value="1">
                                                                        <span class="btn btn-sm btn-color-muted btn-active btn-active-primary fw-bolder px-4">Active</span>
                                                                    </label>
                                                                    <!--end::Option-->
                                                                    <!--begin::Option-->
                                                                    <label class="fs-9">
                                                                        <input type="radio" class="btn-check" name="status" value="0" >
                                                                        <span class="btn btn-sm btn-color-muted btn-active btn-active-primary fw-bolder px-4">Inactive</span>
                                                                    </label>
                                                                    
                                                                    <label class="fs-9">
                                                                        <input type="radio" class="btn-check" name="status" value="2">
                                                                        <span class="btn btn-sm btn-color-muted btn-active btn-active-primary fw-bolder px-4">Blocked</span>
                                                                    </label>
                                                                    <!--end::Option-->
                                                                </div>
                                                                <!--end::Radio group-->
                                                            </div>
                                                            
                                                     
                                                            <!--end::Col-->
                                                        </div>
                                                        
                                                        
                                                    </div>
                                                    <!--end::Col-->
                                                    
                                                    <div class="col-lg-4">
                                                     <label class="fs-6 form-label fw-bolder text-dark">Select Users</label>
                                                          <select class="form-select form-select-solid" name="user" >
                                                                    <option value="">Select user</option>
                                                         <?php $select_method = mysqli_query($DB_CONN, "SELECT distinct user_id, (SELECT users.username from users where id = package_deposits.user_id) as name FROM package_deposits where status = 1");
    while ($row_method = mysqli_fetch_assoc($select_method))
    { ?>
                        <option value="<?php echo $row_method['user_id'] ?>"> <?php echo $row_method['name'] ?> </option>
                <?php
    } ?>
                                                        </select>
                                                        
                                                        
                                               </div>
                                                      <div class="col-lg-4">
                                                                
                                                                 <label class="fs-6 form-label fw-bolder text-dark">Select Investment Plans </label>
                                                                <!--begin::Select-->
                                                            
                                                                 <select class="form-select form-select-solid" name="plan">
                                                                      <option value="">Select Investment Plan</option>
                                                         <?php $select_method = mysqli_query($DB_CONN, "SELECT distinct package_id, (SELECT packages.name from packages where id = package_deposits.package_id) as name FROM `package_deposits` where status = 1");
    while ($row_method = mysqli_fetch_assoc($select_method))
    { ?>
                        <option value="<?php echo $row_method['package_id'] ?>"> <?php echo $row_method['name'] ?> </option>
                <?php
    } ?>
                                                        </select>
                                                        
                                                              
                                                            </div>
                                                             <div class="col-lg-4">
                                                                   <label class="fs-6 form-label fw-bolder text-dark">Select Currencies </label>
                                               <select class="js-example-basic-multiple form-select form-select-solid" name="payment_method_id[]" multiple="multiple">
                                                         <?php $select_method = mysqli_query($DB_CONN, "SELECT distinct payment_method_id, (SELECT currencies.name from currencies where id = package_deposits.payment_method_id) as name FROM package_deposits");
    while ($row_method = mysqli_fetch_assoc($select_method))
    { ?>
                        <option value="<?php echo $row_method['payment_method_id'] ?>"> <?php echo $row_method['name'] ?> </option>
                <?php
    } ?>
                                                        </select>
                                                </div>
                                               </div>
                                                <!--end::Row-->
                                                <!--begin::Row-->

                                                <!--end::Row-->
                                            </div>
                                            <!--end::Advance form-->
                                        </div>
                                        <!--end::Card body-->
                                    </div>
                                    <!--end::Card-->
                                </form>

                                    <!--end::Toolbar-->
                                    <!--begin::Tab Content-->
                                    <div class="tab-content">
                                        <!--begin::Tab pane-->
                                <div class="card card-flush h-xl-100">
                                                <!--begin::Header-->
                                            
                                                <!--end::Header-->
                                                <!--begin::Body-->
                                                <div class="card-body py-3">
                                                    <!--begin::Table container-->
                                                    <div class="table-responsive">
                                                        <!--begin::Table-->
                                                        <table  class="table table-row-dashed align-middle gs-0 gy-4 my-0 expiringtable">
                                                            <!--begin::Table head-->
                                                            <thead>
                                                                <tr class="border-bottom-0">
                                                                    <th class="p-0 ">ID</th>
                                                                    <th class="p-0 ">User Details</th>
                                                                    <th class="p-0 ">Plan Details</th>
                                                                    <th class="p-0 ">Next Accural</th>
                                                                    <th class="p-0  align-middle">Expiry</th>
                                                                    <th class="p-0  align-middle">DateTime</th>
                                                                
                                                                </tr>
                                                            </thead>
                                                            <!--end::Table head-->
                                                            <!--begin::Table body-->
                                                            <tbody>
                                                                
                                                            
                                                            
                                                            
                                                            </tbody>
                                                            <tfoot>
                                                                <tr>
                                                                    <td colspan="9" class="text-center"><input type="button" class="btn btn-primary lmore" onclick="load_deposit()" value="Load More"></td>
                                                                </tr>
                                                            </tfoot>
                                                            <!--end::Table body-->
                                                        </table>
                                                        <!--end::Table-->
                                                    </div>
                                                    <!--end::Table container-->
                                                </div>
                                                <!--begin::Body-->
                                            </div>
                                        <!--end::Tab pane-->
                                    </div>
                            
<script type="text/javascript">
    $(document).ready(function() {
    $('.js-example-basic-multiple').select2();
});
var last_id = 0;


function load_deposit() {
    $.ajax({
        async: true,
        url:'?page=ajax&h=expiring',
        type:'POST',
        data: $("#topsearch").serialize(),
        success:function(data) {
            $(".expiringtable tbody").html(data.data);
            last_id = data.last_id;
            $("input[name=last_id]").val(data.last_id);
            $("#loader").hide();
         if(data.last_id == 0) {
                $(".lmore").hide();
            }
        }
    });
}
$(function() {
    load_deposit();
});
$( "#topsearch" ).submit(function( event ) {
    $(".expiringtable tbody").html('');
    $("input[name=last_id]").val(0);
    last_id = 0;
    load_deposit();
    event.preventDefault();
})



</script>

                                                        
<? }
    if ($_GET['page'] == 'pending_kyc')
    {
        if (isset($_POST['reject']))
        {
            $hide_id = $_POST['hide_id'];
            $update_tex = mysqli_query($DB_CONN, "UPDATE users set kyc='0' WHERE id='$hide_id'");
        }
        if (isset($_POST['approve']))
        {
            $hide_id = $_POST['hide_id'];
            $update_tex = mysqli_query($DB_CONN, "UPDATE users set kyc='1' WHERE id='$hide_id'");
        }
        ?>                  
<div class="card mb-2">
            <div class="card-header min-h-unset py-2">
                <h3 class="card-title align-items-start flex-column m-0">
                    <span class="card-label fw-bold text-gray-900">Pending KYC Requests</span>
                    <span class="text-gray-500 mt-1 fw-semibold fs-6">To see All KYC details go to <a  href="admin?page=kyc">Users KYC page</a></span>
                </h3>
            </div>
                <form method="POST" action="">
                     <div class="card-body">
                         <div class="table-responsive">
                <table  class="table table-row-dashed border-gray-300 align-middle gy-6 table-sm">
                    <thead>
                    <tr>
                    <th>User</th>
                    <th>Name</th>
                    <th>Details</th>
                    <th>Documents</th>
                    <th>Status</th>
                    
                </tr>
                </thead>
                                        <tbody>
                                                <?php
        $cUser = mysqli_query($DB_CONN, "SELECT * FROM `users` WHERE kyc = 2");
        while ($row_User = mysqli_fetch_assoc($cUser))
        {
            $kyc_data = json_decode($row_User['kyc_data'], true);
?>
        <tr>

          <tr>
            <td>
                <div class="d-flex align-items-center">
                    <!--begin::Name-->
                    <div class="d-flex justify-content-start flex-column">
                        <a  href="admin?page=user&id=<?php echo $row_User['id']; ?>&view=overview" class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6"><?php echo $row_User['username']; ?></a>
                        <a  href="#" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                        <span class="text-gray-900">Email</span>:   <?php echo $row_User['email']; ?></a>
                    </div>
                    <!--end::Name-->
                </div>
            </td>
                                                
        <td> <?=$kyc_data['name']; ?> </td>
         <td>
            <div class="d-flex align-items-center">
            <!--begin::Name-->
            <div class="d-flex justify-content-start flex-column">            
                <a  href="#" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                <span class="text-gray-900">Document</span>:    <?=$kyc_data['document']; ?></a>
                <a  href="#" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                <span class="text-gray-900">Document No</span>:     <?=$kyc_data['docnumber']; ?></a>
                <a  href="#" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                <span class="text-gray-900">Country</span>:     <?=$kyc_data['country']; ?></a>
                <a  href="#" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                <span class="text-gray-900">Address</span>:     <?=$kyc_data['address']; ?></a>
            </div>
            <!--end::Name-->
        </div>
    </td>
     <td>
    <div class="d-flex align-items-center">
        <!--begin::Name-->
        <div class="d-flex justify-content-start flex-column">
            <a  href="<?=$kyc_data['front_image']; ?>" target="_blank" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
            <span class="text-gray-900">Doc Front Image</span>:     <img src="<?=$kyc_data['front_image']; ?>" width="10px"></a>
            <a  href="<?=$kyc_data['back_image']; ?>" target="_blank" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
            <span class="text-gray-900">Doc Back Image</span>:  <img src="<?=$kyc_data['back_image']; ?>" width="10px"></a>
                <a  href="<?=$kyc_data['address_image']; ?>" target="_blank" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
            <span class="text-gray-900">Address Proof</span>:   <img src="<?=$kyc_data['address_image']; ?>" width="10px"></a>
        </div>
        <!--end::Name-->
    </div>
</td>

    <td>
        <? if($row_User['kyc'] == 2) { ?>
        <div class="d-flex justify-content-end flex-shrink-0">
        <form method="POST" action="">
        <input type="hidden" name="hide_id" value="<?php echo $row_User['id'] ?>" >  
        <button type="submit" class="btn btn-sm btn-light-success btn-icon-success  hover-scale me-2" name="approve"  ><i class="ki-duotone ki-verify fs-1"><span class="path1"></span><span class="path2"></span></i></button>  </form> 
        <form method="POST" action="">
        <input type="hidden" name="hide_id" value="<?php echo $row_User['id'] ?>" >  
        <button type="submit" class="btn btn-sm btn-light-danger btn-icon-danger    hover-scale" name="reject"  ><i class="ki-duotone ki-cross-square fs-1"><span class="path1"></span><span class="path2"></span></i> </button>  </form> 
         </div>
     <? } ?>
         </td>
                        </tr>
                                    
<?
        } ?>

                
            </tbody></table>
</div>
</div>


    
                                                            
                                                    </div>
<?} 
if ($_GET['page'] == 'products') { 
$alert = false;
$action = $_POST['action'] ?? $_GET['action'] ?? '';  // Check POST first, then GET
$product_id = intval($_GET['id'] ?? $_POST['id'] ?? 0);

if (($action == 'edit' || $action == 'update') && $product_id > 0) {
        $stmt = $DB_CONN->prepare("SELECT * FROM products WHERE id = ?");
        $stmt->bind_param("i", $product_id);
        $stmt->execute();
        $result = $stmt->get_result();
        $product = $result->fetch_assoc();
        $product['categories'] = getCategories($product_id, 'product');

        $faq_stmt = $DB_CONN->prepare("SELECT * FROM faqs WHERE product_id = ?");
        $faq_stmt->bind_param("i", $product_id);
        $faq_stmt->execute();
        $ffaqs = $faq_stmt->get_result()->fetch_all(MYSQLI_ASSOC);
        $changelog_stmt = $DB_CONN->prepare("SELECT * FROM changelogs WHERE product_id = ?");
        $changelog_stmt->bind_param("i", $product_id);
        $changelog_stmt->execute();
        $changelogs = $changelog_stmt->get_result()->fetch_all(MYSQLI_ASSOC);
}


if ($action === 'delete' && isset($_POST['id'])) {  
    $product_id = intval($_POST['id']);

    $delete_changelogs = "DELETE FROM changelogs WHERE product_id = $product_id";
    if (!mysqli_query($DB_CONN, $delete_changelogs)) {
        echo "Error deleting changelogs: " . mysqli_error($DB_CONN);
    }

    // Delete from faqs
    $delete_faqs = "DELETE FROM faqs WHERE product_id = $product_id";
    if (!mysqli_query($DB_CONN, $delete_faqs)) {
        echo "Error deleting FAQs: " . mysqli_error($DB_CONN);
    }

    $delete_product = "DELETE FROM products WHERE id = $product_id";
    if (!mysqli_query($DB_CONN, $delete_product)) {
        echo "Error deleting product: " . mysqli_error($DB_CONN);
    } else {
        $alert = true;
          $alert_class = 'alert alert-success alert-dismissible alert-custom';
         $alert_message = 'Product and related data deleted successfully';
    }
}

if ($_SERVER['REQUEST_METHOD'] === 'POST') {

$description = cleanContent($_POST['description']);

$features = $_POST['features'] ?? [];
$features = array_filter($features); 
$featuresJson = json_encode($features);


$name = $_POST['name'];
$slug = $_POST['slug'];
$lang_id = $lang_id;
$short_description = $_POST['short_description'];
$image_url = $_POST['image_url'];
$version = $_POST['version'];
$demo_url = $_POST['demo_url'];
$price = $_POST['price'];
$discount_price = $_POST['discount_price'];
$currency = $_POST['currency'];
$download_url = $_POST['download_url'];
$install_url = $_POST['install_url'];
$release_notes_url = $_POST['release_notes_url'];
$requirements = $_POST['requirements'];
$documentation_url = $_POST['documentation_url'];
$award = $_POST['award'];
$seo_robots = $_POST['seo_robots'] ? :'no';
$include_in_sitemap = $_POST['include_in_sitemap'] ? :'no';
$schema_type = $_POST['schema_type'] ? :'';
$created_at = date('Y-m-d H:i:s');
$updated_at = date('Y-m-d H:i:s');
$status = $_POST['status'];
$category_ids = $_POST['categories'] ?? [];
$screenshots = [];
if (isset($_FILES['screenshot_file']) && is_array($_FILES['screenshot_file']['name'])) {
    for ($i = 0; $i < count($_FILES['screenshot_file']['name']); $i++) {
        if ($_FILES['screenshot_file']['error'][$i] == UPLOAD_ERR_OK) {
            $upload_dir = 'images/products/screenshots/';
            $new_name = uniqid() . '-' . $_FILES['screenshot_file']['name'][$i];
            $file_path = $upload_dir . $new_name;
            if (move_uploaded_file($_FILES['screenshot_file']['tmp_name'][$i], $file_path)) {
                $screenshots[] = [
                    'url' => $file_path,
                    'caption' => $_POST['screenshot_caption'][$i] ?? ''
                ];
            }
        }
    }
}
if (isset($_POST['existing_screenshot']) && is_array($_POST['existing_screenshot'])) {
    foreach ($_POST['existing_screenshot'] as $index => $existing_url) {
        $screenshots[] = [
            'url' => $existing_url,
            'caption' => $_POST['screenshot_caption'][$index] ?? ''
        ];
    }
}
$screenshots_json = json_encode($screenshots);
$update_stmt = $DB_CONN->prepare("UPDATE products SET screenshots = ? WHERE id = ?");
$update_stmt->bind_param("si", $screenshots_json, $product_id);
$update_stmt->execute();
if ($action === 'add') {
    $stmt = $DB_CONN->prepare("INSERT INTO products (
        name, slug, short_description, description, features, 
        version, demo_url, demo_details, price, discount_price, 
        currency, download_url, install_url, release_notes_url, requirements, 
        documentation_url, award, seo_robots, include_in_sitemap, schema_type, 
        image_url, screenshots, lang_id, status
    ) VALUES (
        ?, ?, ?, ?, ?, 
        ?, ?, ?, ?, ?, 
        ?, ?, ?, ?, ?, 
        ?, ?, ?, ?, ?, 
        ?, ?, ?, ?
    )");


    $stmt->bind_param(
        "ssssssssddssssssssssssii", 
        $name, $slug, $short_description, $description, $featuresJson,
        $version, $demo_url, $demo_details, $price, $discount_price,
        $currency, $download_url, $install_url, $release_notes_url, $requirements,
        $documentation_url, $award, $seo_robots, $include_in_sitemap, $schema_type,
        $image_url, $screenshots, $lang_id, $status
    );
} elseif ($action === 'edit') {
    $stmt = $DB_CONN->prepare("UPDATE products SET 
        name=?, slug=?, short_description=?, description=?, features=?,
        version=?, demo_url=?, demo_details=?, price=?, discount_price=?,
        currency=?, download_url=?, install_url=?, release_notes_url=?, requirements=?,
        documentation_url=?, award=?, seo_robots=?, include_in_sitemap=?, schema_type=?,
        image_url=?, screenshots=?, lang_id=?, status=?
        WHERE id=?
    ");
    

    
    $stmt->bind_param(
        "ssssssssddssssssssssssiii",
        $name, $slug, $short_description, $description, $featuresJson,
        $version, $demo_url, $demo_details, $price, $discount_price,
        $currency, $download_url, $install_url, $release_notes_url, $requirements,
        $documentation_url, $award, $seo_robots, $include_in_sitemap, $schema_type,
        $image_url, $screenshots, $lang_id, $status, $product_id
    );
}

   if ($stmt->execute()) {
        $affected_rows = $stmt->affected_rows;
        $product_id = $_POST['action'] == 'update' ? $product_id : $DB_CONN->insert_id;

        // Handle categories
        manageFAQs($product_id, 'product');
        addCategoriesToItem($product_id, 'product', $category_ids);

        if ($affected_rows > 0) {
             $alert = true;
            $alert_class = 'alert alert-success alert-dismissible alert-custom';
            $alert_message = 'Product item ' . ($action == 'update' ? 'updated' : 'added') . ' successfully!';
            echo "<script>window.location.href='admin?page=products&action=edit&id={$product_id}&alert_message={$alert_message}&alert_class={$alert_class}'</script>";
        } else {
             $alert = true;
            $alert_class = 'alert alert-warning alert-dismissible alert-custom';
            $alert_message = 'No changes were made to the Product item.';
        }
    } else {
         $alert = true;
        $alert_class = 'alert alert-danger alert-dismissible alert-custom';
        $alert_message = 'Error ' . ($action == 'update' ? 'updating' : 'adding') . ' Product item: ' . $stmt->error;
    }


    if (isset($_POST['changelog_version']) && isset($_POST['changelog_detail']) && isset($_POST['changelog_date'])) {
        $existing_changelogs_stmt = $DB_CONN->prepare("SELECT id FROM changelogs WHERE product_id = ?");
        $existing_changelogs_stmt->bind_param("i", $product_id);
        $existing_changelogs_stmt->execute();
        $existing_changelogs_result = $existing_changelogs_stmt->get_result();
        
        $existing_changelog_ids = [];
        while ($row = $existing_changelogs_result->fetch_assoc()) {
            $existing_changelog_ids[] = $row['id'];
        }
    
        $insert_changelog_stmt = $DB_CONN->prepare("INSERT INTO changelogs (product_id, version, detail, date) VALUES (?, ?, ?, ?)");
        $update_changelog_stmt = $DB_CONN->prepare("UPDATE changelogs SET version = ?, detail = ?, date = ? WHERE id = ?");
    
        // Process each changelog entry
        foreach ($_POST['changelog_version'] as $key => $version) {
           // $detail = str_replace(["\r\n", "\r", "\n"], "\n", $_POST['changelog_detail'][$key]);
            $detail = $_POST['changelog_detail'][$key];
            $date = $_POST['changelog_date'][$key];
            
            if (empty($date)) {
                $date = date('Y-m-d'); 
            } else {
                $formatted_date = date('Y-m-d', strtotime($date));
                if ($formatted_date) {
                    $date = $formatted_date;
                } else {
                    $date = date('Y-m-d'); 
                }
            }
    
            $changelog_id = isset($_POST['changelog_id'][$key]) ? $_POST['changelog_id'][$key] : null;
    
            if ($changelog_id && in_array($changelog_id, $existing_changelog_ids)) {
                // Update existing changelog
                mysqli_query($DB_CONN, "UPDATE changelogs SET version = '{$version}', detail = '{$detail}', date = '{$date}' WHERE id = '{$changelog_id}'");
    
                $existing_changelog_ids = array_diff($existing_changelog_ids, [$changelog_id]);
            } else {
                // Insert new changelog
                mysqli_query($DB_CONN, "INSERT INTO changelogs (product_id, version, detail, date) VALUES ('{$product_id}', '{$version}', '{$detail}', '{$date}')");
    
            }
        }
    
        // Delete removed changelogs
        if (!empty($existing_changelog_ids)) {
            $delete_changelog_stmt = $DB_CONN->prepare("DELETE FROM changelogs WHERE id = ?");
            foreach ($existing_changelog_ids as $changelog_id) {
                $delete_changelog_stmt->bind_param("i", $changelog_id);
                $delete_changelog_stmt->execute();
            }
        }
    }
   
}

 $result = $DB_CONN->query("SELECT * FROM products");

?>
<?php if(isset($_GET['alert_message']) && $_GET['alert_message']) {
        $alert = true;
            $alert_class = $_GET['alert_class'];
            $alert_message = $_GET['alert_message'];
     
 }
?>  
    <?php if ($alert): ?>
        <div class="<?php echo $alert_class; ?>" role="alert">
            <?php echo $alert_message; ?>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    <?php endif; ?>

 <?php if ($action == 'add' || $action == 'edit'):

    ?>
   <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet" />
    <form id="kt_ecommerce_add_product_form" class="form d-flex flex-column flex-lg-row fv-plugins-bootstrap5 fv-plugins-framework" method="post" enctype="multipart/form-data"  >
                                        <!--begin::Aside column-->
                                        <div class="d-flex flex-column gap-7 gap-lg-10 w-100 w-lg-300px mb-7 me-lg-10">
                                            <!--begin::Thumbnail settings-->
                                            <div class="card card-flush py-4">
                                                <!--begin::Card header-->
                                                <div class="card-header">
                                                    <!--begin::Card title-->
                                                    <div class="card-title">
                                                        <h2>Featured Image</h2>
                                                    </div>
                                                    <!--end::Card title-->
                                                </div>
                                                <!--end::Card header-->
                                                <!--begin::Card body-->
                                                <div class="card-body text-center pt-0">
                                                    <!--begin::Image input-->
                                                    <!--begin::Image input placeholder-->
                                                    <style>.image-input-placeholder { background-image: url('assets/media/svg/files/blank-image.svg'); } [data-bs-theme="dark"] .image-input-placeholder { background-image: url('assets/media/svg/files/blank-image-dark.svg'); }</style>
                                                    <!--end::Image input placeholder-->
      <div class="image-input image-input-outline" data-kt-image-input="true" 
             style="background-image: url('svg/avatars/blank.svg')">
            <!--begin::Image preview wrapper-->
            <div class="image-input-wrapper w-200px " id="main-image-preview"
             style="background-image: url('<?= ($product && $product['image_url']) ? htmlspecialchars($product['image_url']) : 'bitders/assets/placeholder.svg' ?>')">
        </div>
            <!--end::Image preview wrapper-->

                    <label class="btn btn-icon btn-circle btn-color-muted btn-active-color-primary w-25px h-25px bg-body shadow"
               data-kt-image-input-action="change"
               data-bs-toggle="modal"
               data-bs-target="#kt_modal_100"
               title="Change main image">
            <i class="ki-duotone ki-pencil fs-6"><span class="path1"></span><span class="path2"></span></i>
        </label>
        <!--end::Edit button-->
        <!--begin::Cancel button-->
        <span class="btn btn-icon btn-circle btn-color-muted btn-active-color-primary w-25px h-25px bg-body shadow"
              data-kt-image-input-action="cancel"
              data-bs-toggle="tooltip"
              data-bs-dismiss="click"
              title="Cancel image">
            <i class="ki-outline ki-cross fs-3"></i>
        </span>
        <!--end::Cancel button-->
        <!--begin::Remove button-->
        <span class="btn btn-icon btn-circle btn-color-muted btn-active-color-primary w-25px h-25px bg-body shadow"
              data-kt-image-input-action="remove"
              data-bs-toggle="tooltip"
              data-bs-dismiss="click"
              title="Remove image">
            <i class="ki-outline ki-cross fs-3"></i>
        </span>
            <!--end::Remove button-->
        </div>
           <input type="hidden" id="selected_image_url" name="image_url" value="<?= ($product && $product['image_url']) ? htmlspecialchars($product['image_url']) : '' ?>">                                          <!--end::Image input-->
                                                    <!--begin::Description-->
                                                    <div class="text-muted fs-7">Featured Image for your Product / Service. All Images are Accepted</div>
                                                    <!--end::Description-->
                                                </div>
                                                <!--end::Card body-->
                                            </div>
                                            <!--end::Thumbnail settings-->
                                            <!--begin::Status-->
                                            <div class="card card-flush py-0">
                                                <!--begin::Card header-->
                                                <div class="card-header min-h-unset py-2">
                                                    <!--begin::Card title-->
                                                    <div class="card-title m-0">
                                                        <h2>Status</h2>
                                                    </div>
                                                    <!--end::Card title-->
                                                    <!--begin::Card toolbar-->
                                                    <div class="card-toolbar">
                                                        <div class="rounded-circle bg-success w-15px h-15px" id="kt_ecommerce_add_product_status"></div>
                                                    </div>
                                                    <!--begin::Card toolbar-->
                                                </div>
                                                <!--end::Card header-->
                                                <!--begin::Card body-->
                                                <div class="card-body pt-0">
                                                    <!--begin::Select2-->
                                                   <select class="form-select form-select-sm mb-2 " name="status">
                                                    <option value="0" <?= $product && $product['status'] === '0' ? 'selected' : '' ?>>Draft</option>
                                                    <option value="1" <?= $product && $product['status'] === '1' ? 'selected' : '' ?>>Publish</option>
                                                   </select>
                                                    <!--end::Select2-->
                                                    <!--begin::Description-->
                                                    <div class="text-muted fs-7">Set the product status.</div>
                                                    <!--end::Description-->
                                                  
                                                    <!--end::Datepicker-->
                                                </div>
                                                <!--end::Card body-->
                                            </div>
                                            
                                             <div class="card card-flush py-0">
                                                <!--begin::Card header-->
                                                <div class="card-header min-h-unset py-2">
                                                    <!--begin::Card title-->
                                                    <div class="card-title m-0">
                                                        <h2>SEO Robots</h2>
                                                    </div>
                                                
                                                </div>
                                                <!--end::Card header-->
                                                <!--begin::Card body-->
                                                <div class="card-body pt-0">
                                                    <!--begin::Select2-->
                                                 <select class="form-select form-select-sm mb-2" name="seo_robots">
    <option value="no" <?= $product && $product['seo_robots'] === 'no' ? 'selected' : '' ?>>No</option>
    <option value="yes" <?= $product && $product['seo_robots'] === 'yes' ? 'selected' : '' ?>>Yes</option>
</select>
                                                    <!--end::Select2-->
                                                    <!--begin::Description-->
                                                    <div class="text-muted fs-7"> All robots to index or follow</div>
                                                    <!--end::Description-->
                                                  
                                                    <!--end::Datepicker-->
                                                </div>
                                                <!--end::Card body-->
                                            </div>
                                             <div class="card card-flush py-0">
                                                <!--begin::Card header-->
                                                <div class="card-header min-h-unset py-2">
                                                    <!--begin::Card title-->
                                                    <div class="card-title m-0">
                                                        <h2>Sitemap</h2>
                                                    </div>
                                              
                                                </div>
                                                <!--end::Card header-->
                                                <!--begin::Card body-->
                                                <div class="card-body pt-0">
                                                    <!--begin::Select2-->
                                               
                                                   <select class="form-select form-select-sm mb-2" name="include_in_sitemap">
    <option value="no" <?= $product && $product['include_in_sitemap'] === 'no' ? 'selected' : '' ?>>No</option>
    <option value="yes" <?= $product && $product['include_in_sitemap'] === 'yes' ? 'selected' : '' ?>>Yes</option>
</select>
                                                    <!--end::Select2-->
                                                    <!--begin::Description-->
                                                    <div class="text-muted fs-7"> Allow to be add in Sitemap.</div>
                                                    <!--end::Description-->
                                                  
                                                    <!--end::Datepicker-->
                                                </div>
                                                <!--end::Card body-->
                                            </div>
                                             <div class="card card-flush py-0">
                                                <!--begin::Card header-->
                                                <div class="card-header min-h-unset py-2">
                                                    <!--begin::Card title-->
                                                    <div class="card-title m-0">
                                                        <h2>Type</h2>
                                                    </div>
                                              
                                                </div>
                                                <!--end::Card header-->
                                                <!--begin::Card body-->
                                                <div class="card-body pt-0">
                                                    <!--begin::Select2-->
                                               
                                                   <select class="form-select form-select-sm mb-2" name="schema_type">
    <option value="softwareapplication" <?= $product && $product['schema_type'] === 'softwareapplication' ? 'selected' : '' ?>>SoftwareApplication</option>
    <option value="product" <?= $product && $product['schema_type'] === 'product' ? 'selected' : '' ?>>Product</option>
</select>
                                                    <!--end::Select2-->
                                                    <!--begin::Description-->
                                                    <div class="text-muted fs-7"> Type of Product.</div>
                                                    <!--end::Description-->
                                                  
                                                    <!--end::Datepicker-->
                                                </div>
                                                <!--end::Card body-->
                                            </div>
                                            <!--end::Status-->
                                            <!--begin::Category & tags-->
                                            <div class="card card-flush py-0">
                                                <!--begin::Card header-->
                                                <div class="card-header">
                                                    <!--begin::Card title-->
                                                    <div class="card-title">
                                                        <h2>Product Category</h2>
                                                    </div>
                                                    <!--end::Card title-->
                                                </div>
                                                <!--end::Card header-->
                                                <!--begin::Card body-->
                                                <div class="card-body pt-0">
                                                    <!--begin::Input group-->
                                          
                                                    <!--end::Label-->
                                                    <!--begin::Select2-->
                                                    <div class="mb-3">
    <label for="categories" class="form-label">Categories:</label>
    <?php
    $all_categories = getAllCategories();
    $item_categories = $action == 'edit' ? $product['categories'] : [];
    $item_category_ids = array_column($item_categories, 'id');
    foreach ($all_categories as $category) {
        $checked = in_array($category['id'], $item_category_ids) ? 'checked' : '';
        echo "<div class='form-check'>
                <input class='form-check-input' type='checkbox' name='categories[]' value='{$category['id']}' id='category_{$category['id']}' $checked>
                <label class='form-check-label' for='category_{$category['id']}'>{$category['name']} ({$category['slug']})</label>
              </div>";
    }
    ?>
   
</div>
  <div class="mt-2">
       <button type="button" class="btn btn-sm btn-secondary mt-1" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
    <i class="ki-duotone ki-plus fs-2"></i>Add New Category
</button>
    </div>
                                                 
                                                </div>

                                            </div>

                                        </div>
                                        <!--end::Aside column-->
                                        <!--begin::Main column-->
                                        <div class="d-flex flex-column flex-row-fluid gap-7 gap-lg-10">
                                            <!--begin:::Tabs-->
                                           
                                            <!--end:::Tabs-->
                                            <!--begin::Tab content-->
                                            <div class="tab-content">
                                                <!--begin::Tab pane-->
                                                <div class="tab-pane fade active show" id="kt_ecommerce_add_product_general" role="tab-panel">
                                                    <div class="d-flex flex-column gap-7 gap-lg-10">
                                                        <!--begin::General options-->
                                                        <div class="card card-flush py-4">
                                                            <!--begin::Card header-->
                                                           
                                                            <!--end::Card header-->
                                                            <!--begin::Card body-->
                                                            <div class="card-body pt-0">
                                                                 <div class="mb-10">
                <label class="required form-label" for="name">Name</label>
                <input type="text" class="form-control form-control-solid" id="name" name="name" value="<?= $product ? htmlspecialchars($product['name']) : '' ?>" required>
                <small class="text-muted">e.g., Bitders Hyip Pro Script</small>
            </div>

            <div class="mb-10">
                <label class="required form-label" for="slug">Slug</label>
                <input type="text" class="form-control form-control-solid" id="slug" name="slug" value="<?= $product ? htmlspecialchars($product['slug']) : '' ?>" required>
                <small class="text-muted">e.g., bitders-hyip-pro-script</small>
            </div>

            <div class="mb-10">
                <label class="required form-label" for="short_description">Short Description</label>
                <input type="text" class="form-control form-control-solid bitder-editor" id="bitderseditor" name="short_description" value="<?= $product ? ($product['short_description']) : '' ?>" required>
                <small class="text-muted">e.g., Premium High Yield Investment Program Script for 2024 and beyond.</small>
            </div>

            <div class="mb-10">
                <label class="form-label" for="description">Description</label>
                <div class="form-control" id="kt_docs_quill_basic">
        <?php echo $product['description'] ?? ''; ?>
    </div>
               <textarea name="description" id="hiddenContent" style="display:none;"></textarea>
           
                <small class="text-muted">Detailed description of your product</small>
            </div>

<script>
// Initialize Quill
var quill = new Quill('#kt_docs_quill_basic', {
    modules: {
        toolbar: {
            container: [
                [{ header: [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                ['blockquote', 'code-block'],
                [{ list: 'ordered' }, { list: 'bullet' }],
                [{ script: 'sub' }, { script: 'super' }],
                [{ indent: '-1' }, { indent: '+1' }],
                [{ direction: 'rtl' }],
                [{ size: ['small', false, 'large', 'huge'] }],
                [{ color: [] }, { background: [] }],
                [{ align: [] }],
                ['link', 'image', 'video'],
                ['clean']
            ],
            handlers: {
                'image': function() {
                    $('#kt_modal_100').modal('show');
                }
            }
        }
    },
    placeholder: 'Type your text here...',
    theme: 'snow'
});

document.addEventListener('DOMContentLoaded', function() {
    // Create toggle button
    const editorContainer = document.querySelector('#kt_docs_quill_basic').parentNode;
    const toggleButton = document.createElement('button');
    toggleButton.textContent = 'Toggle Source Code';
    toggleButton.className = 'btn btn-light-primary btn-sm mt-2';
    toggleButton.type = 'button';
    editorContainer.appendChild(toggleButton);

    // Create source code textarea
    const sourceTextarea = document.createElement('textarea');
    sourceTextarea.className = 'form-control form-control-solid mt-2';
    sourceTextarea.style.display = 'none';
    sourceTextarea.style.height = '300px';
    editorContainer.appendChild(sourceTextarea);

    // Get hidden content element
    const hiddenContent = document.querySelector('#hiddenContent');

    // Set initial content
    var initialContent = `<?php echo htmlspecialchars_decode($product['description'] ?? ''); ?>`;
    quill.clipboard.dangerouslyPasteHTML(initialContent);
    
    // Initialize hidden content with initial value
    hiddenContent.value = initialContent;

    // Toggle functionality
    let isSourceView = false;
    toggleButton.onclick = function() {
        isSourceView = !isSourceView;
        
        if (isSourceView) {
            sourceTextarea.value = quill.root.innerHTML;
            quill.container.style.display = 'none';
            sourceTextarea.style.display = 'block';
        } else {
            quill.root.innerHTML = sourceTextarea.value;
            sourceTextarea.style.display = 'none';
            quill.container.style.display = 'block';
        }
        
        // Update hidden content
        updateHiddenContent();
    };

    // Function to update hidden content
    function updateHiddenContent() {
        hiddenContent.value = isSourceView ? sourceTextarea.value : quill.root.innerHTML;
    }

    // Update hidden content on editor changes
    quill.on('text-change', function() {
        if (!isSourceView) {
            updateHiddenContent();
        }
    });

    // Update hidden content when source code changes
    sourceTextarea.addEventListener('input', function() {
        updateHiddenContent();
    });

    // Add form submit handler
    const form = hiddenContent.closest('form');
    if (form) {
        form.addEventListener('submit', function() {
            // Ensure hidden content is updated before submit
            updateHiddenContent();
        });
    }
});
</script>
                                                    
                                                                <!--end::Input group-->
                                                            </div>
                                                            <!--end::Card header-->
                                                        </div>
<div class="card card-flush py-4">
    <!--begin::Card header-->
    <div class="card-header">
        <div class="card-title">
            <h2>Features</h2>
        </div>
    </div>
    <!--end::Card header-->
    <!--begin::Card body-->
    <div class="card-body pt-0">
        <!--begin::Input group-->
        <div id="features-section" class="mb-10">
            <label class="form-label" for="features">Features</label>
            <div id="features-list">
                <?php 
        $features = $product ? json_decode($product['features'], true) : [];
        if ($features && is_array($features)): 
            foreach ($features as $index =>
                $feature): ?>
                <div class="feature-item mb-3">
                    <div class="input-group">
                        <input type="text" class="form-control" name="features[]" value="<?= htmlspecialchars($feature) ?>" placeholder="Enter a feature" />
                        <button type="button" class="btn btn-light-danger" onclick="this.closest('.feature-item').remove();">
                            <i class="ki-duotone ki-trash fs-5"><span class="path1"></span><span class="path2"></span><span class="path3"></span><span class="path4"></span><span class="path5"></span></i>
                        </button>
                    </div>
                </div>
                <?php 
            endforeach; 
        endif; 
        ?>
            </div>
            <div class="form-group mt-3">
                <button type="button" class="btn btn-light-primary" onclick="addFeatureItem()"><i class="ki-duotone ki-plus fs-2"></i>Add Feature</button>
            </div>
        </div>
        <!--end::Input group-->
        <!--begin::Description-->
        <div class="text-muted fs-7">Set the product media gallery.</div>
        <!--end::Description-->
    </div>
    <!--end::Card header-->
</div>

<!--end::General options-->
<div class="card card-flush py-4">
    <!--begin::Card header-->
    <div class="card-header">
        <div class="card-title">
            <h2>FAQs</h2>
        </div>
    </div>
    <!--end::Card header-->
    <!--begin::Card body-->
    <div class="card-body pt-0">
        <!--begin::Input group-->
        <div class="mb-10">
            <h3 class="fw-bold mb-5">FAQs</h3>
            <div id="faq-section">
                <?php if ($product && !empty($ffaqs)): ?>
                <?php foreach ($ffaqs as $faqq): ?>
                <div class="faq-item mb-2">
                    <div class="row">
                        <div class="col-md-5 mb-2">
                            <input type="text" class="form-control form-control-sm" name="faq_question[]" placeholder="Question" value="<?= htmlspecialchars($faqq['question']) ?>" />
                        </div>
                        <div class="col-md-6 mb-2">
                            <textarea type="text" class="form-control form-control-sm" name="faq_answer[]" placeholder="Answer" rows="2"><?= htmlspecialchars($faqq['answer']) ?> </textarea>
                        </div>
                        <div class="col-md-1">
                            <button type="button" class="btn btn-sm btn-light-danger" onclick="this.closest('.faq-item').remove();">
                                <i class="ki-duotone ki-trash fs-5"><span class="path1"></span><span class="path2"></span><span class="path3"></span><span class="path4"></span><span class="path5"></span></i>
                            </button>
                        </div>
                    </div>
                </div>
                <?php endforeach; ?>
                <?php else: ?>
                <div class="faq-item mb-2">
                    <div class="row">
                        <div class="col-md-5 mb-2">
                            <input type="text" class="form-control form-control-sm" name="faq_question[]" placeholder="Question" />
                        </div>
                        <div class="col-md-6 mb-2">
                            <textarea class="form-control form-control-sm" name="faq_answer[]" placeholder="Answer" rows="2"></textarea>
                        </div>
                        <div class="col-md-1">
                            <button type="button" class="btn btn-sm btn-icon btn-light-danger p-2" onclick="this.closest('.faq-item').remove();">
                                <i class="ki-duotone ki-trash fs-2"><span class="path1"></span><span class="path2"></span><span class="path3"></span><span class="path4"></span><span class="path5"></span></i>
                            </button>
                        </div>
                    </div>
                </div>
                <?php endif; ?>
                <div class="form-group mt-2">
                    <button type="button" class="btn btn-light-primary btn-sm" onclick="addFaqItem()"><i class="ki-duotone ki-plus fs-2"></i>Add FAQ</button>
                </div>
            </div>
        </div>
        <!--end::Input group-->
        <!--begin::Description-->
        <div class="text-muted fs-7">Set the product media gallery.</div>
        <!--end::Description-->
    </div>
    <!--end::Card header-->
</div>

<!--begin::Media-->
<div class="card card-flush py-4">
    <!--begin::Card header-->
    <div class="card-header">
        <div class="card-title">
            <h2>Media</h2>
        </div>
    </div>
    <!--end::Card header-->
    <!--begin::Card body-->
    <div class="card-body pt-0">
        <!--begin::Input group-->
        <div class="mb-10">
            <h3 class="fw-bold mb-5">Screenshots</h3>
            <div id="screenshots-section">
                <?php 
        $screenshots = $product['screenshots'];
        if (is_string($screenshots)) {
            $screenshots = json_decode($screenshots, true);
        }
        if ($product && !empty($screenshots)): 
        ?>
                <?php foreach ($screenshots as $index =>
                $screenshot): ?>
                <div class="screenshot-item mb-5">
                    <div class="row">
                        <div class="col-md-5 mb-3">
                            <input type="file" class="form-control" name="screenshot_file[]" />
                            <?php if (isset($screenshot['url'])): ?>
                            <img src="<?= htmlspecialchars($screenshot['url']) ?>" alt="Screenshot" class="img-thumbnail mt-2" style="max-width: 100px;" />
                            <input type="hidden" name="existing_screenshot[]" value="<?= htmlspecialchars($screenshot['url']) ?>" />
                            <?php endif; ?>
                        </div>
                        <div class="col-md-5 mb-3">
                            <textarea type="text" class="form-control" name="screenshot_caption[]" placeholder="Caption" value="<?= htmlspecialchars($screenshot['caption'] ?? '') ?>">
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-sm btn-light-danger" onclick="this.closest('.screenshot-item').remove();">
                                <i class="ki-duotone ki-trash fs-5"><span class="path1"></span><span class="path2"></span><span class="path3"></span><span class="path4"></span><span class="path5"></span></i>
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            <?php endforeach; ?>
        <?php endif; ?>
    </div>
    <button type="button" class="btn btn-light-primary" onclick="addScreenshotItem()">
        <i class="ki-duotone ki-plus fs-2"></i>Add Screenshot
    </button>
</div>
                                                                <!--end::Input group-->
                                                                <!--begin::Description-->
                                                                <div class="text-muted fs-7">Set the product media gallery.</div>
                                                                <!--end::Description-->
                                                            </div>
                                                            <!--end::Card header-->
                                                        </div>
                                                        
                                                        
                                                        <div class="card card-flush py-4" id="digital">
                                                            <!--begin::Card header-->
                                                            <div class="card-header">
                                                                <div class="card-title">
                                                                    <h2>Digital product Details</h2>
                                                                </div>
                                                            </div>
                                                            <!--end::Card header-->
                                                            <!--begin::Card body-->
                                                            <div class="card-body pt-0">
                                                                <!--begin::Input group-->
                                                                  <div class="mb-10">
                                                                       <div class="mb-10">
                <label class="form-label" for="version">Version</label>
                <input type="text" class="form-control form-control-solid" id="version" name="version" value="<?= $product ? htmlspecialchars($product['version']) : '' ?>">
                <small class="text-muted">e.g., 1.0</small>
            </div>
            
                <label class="form-label" for="demo_url">Demo URL</label>
                <input type="url" class="form-control form-control-solid" id="demo_url" name="demo_url" value="<?= $product ? htmlspecialchars($product['demo_url']) : '' ?>">
                <small class="text-muted">e.g., https://demo.bitders.com</small>
            </div>

            <div class="mb-10">
                <label class="form-label" for="download_url">Download URL</label>
                <input type="url" class="form-control form-control-solid" id="download_url" name="download_url" value="<?= $product ? htmlspecialchars($product['download_url']) : '' ?>">
                <small class="text-muted">e.g., https://bitders.com/download/hyip-script</small>
            </div>

            <div class="mb-10">
                <label class="form-label" for="install_url">Install Guide URL</label>
                <input type="url" class="form-control form-control-solid" id="install_url" name="install_url" value="<?= $product ? htmlspecialchars($product['install_url']) : '' ?>">
                <small class="text-muted">e.g., https://bitders.com/install-guide</small>
            </div>

            <div class="mb-10">
                <label class="form-label" for="release_notes_url">Release Notes URL</label>
                <input type="url" class="form-control form-control-solid" id="release_notes_url" name="release_notes_url" value="<?= $product ? htmlspecialchars($product['release_notes_url']) : '' ?>">
                <small class="text-muted">e.g., https://bitders.com/release-notes</small>
            </div>

            <div class="mb-10">
                <label class="form-label" for="requirements">System Requirements</label>
                <input type="text" class="form-control form-control-solid" id="requirements" name="requirements" value="<?= $product ? htmlspecialchars($product['requirements']) : '' ?>">
                <small class="text-muted">e.g., PHP 7.4+, MySQL 5.7+</small>
            </div>

            <div class="mb-10">
                <label class="form-label" for="documentation_url">Documentation URL</label>
                <input type="url" class="form-control form-control-solid" id="documentation_url" name="documentation_url" value="<?= $product ? htmlspecialchars($product['documentation_url']) : '' ?>">
                <small class="text-muted">e.g., https://bitders.com/documentation</small>
            </div>

            <div class="mb-10">
                <label class="form-label" for="award">Award</label>
                <input type="text" class="form-control form-control-solid" id="award" name="award" value="<?= $product ? htmlspecialchars($product['award']) : '' ?>">
                <small class="text-muted">e.g., Best HYIP Script 2024</small>
            </div>
<div id="changelog-section">
    <h3 class="fw-bold mb-5">Changelogs</h3>
    <div class="changelog-items-container">
        <?php if ($product && !empty($changelogs)): ?>
            <?php foreach ($changelogs as $changelog): ?>
                <div class="changelog-item mb-5">
                    <div class="row">
                        <input type="hidden" name="changelog_id[]" value="<?= htmlspecialchars($changelog['id']) ?>">
                        <div class="col-md-2 mb-3">
                            <input type="text" class="form-control" name="changelog_version[]" placeholder="Version" value="<?= htmlspecialchars($changelog['version']) ?>">
                        </div>
                        <div class="col-md-2 mb-3">
                            <input type="date" class="form-control" name="changelog_date[]" 
                                   value="<?= date('Y-m-d', strtotime($changelog['date'])) ?>" 
                                   placeholder="Date">
                        </div>
                        <div class="col-md-8 mb-3">
                      
                            <textarea name="changelog_detail[]" class="form-control" ><?= htmlspecialchars($changelog['detail']) ?>
                            </textarea>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-sm btn-light-danger" onclick="this.closest('.changelog-item').remove();">
                                <i class="ki-duotone ki-trash fs-5"><span class="path1"></span><span class="path2"></span><span class="path3"></span><span class="path4"></span><span class="path5"></span></i>
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
                <?php endforeach; ?>
                <?php endif; ?>
                <div class="form-group mt-5">
                    <button type="button" class="btn btn-light-primary" onclick="addNewChangelogItem()"><i class="ki-duotone ki-plus fs-2"></i>Add Changelog</button>
                </div>
            </div>
        </div>

      <script>

   function addNewChangelogItem() {
    const container = document.querySelector('.changelog-items-container');
    
    const newItem = document.createElement('div');
    newItem.className = 'changelog-item mb-5';
    newItem.innerHTML = `
        <div class="row">
            <input type="hidden" name="changelog_id[]" value="">
            <div class="col-md-2 mb-3">
                <input type="text" class="form-control" name="changelog_version[]" placeholder="Version" value="">
            </div>
            <div class="col-md-2 mb-3">
                <input type="date" class="form-control" name="changelog_date[]" value="" placeholder="Date">
            </div>
            <div class="col-md-8 mb-3">
                <textarea name="changelog_detail[]" class="form-control" placeholder="Details"></textarea>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-sm btn-light-danger" onclick="this.closest('.changelog-item').remove();">
                    <i class="ki-duotone ki-trash fs-5">
                        <span class="path1"></span><span class="path2"></span><span class="path3"></span><span class="path4"></span><span class="path5"></span>
                    </i>
                    Delete
                </button>
            </div>
        </div>
    `;
    
    container.insertBefore(newItem, container.querySelector('.form-group'));
}
</script>

        <!--end::Input group-->
        <!--begin::Description-->
        <div class="text-muted fs-7">Set the product media gallery.</div>
        <!--end::Description-->
    </div>
    <!--end::Card header-->
</div>
<!--end::Media-->
<!--begin::Pricing-->
<div class="card card-flush py-4">
    <!--begin::Card header-->
    <div class="card-header">
        <div class="card-title">
            <h2>Pricing</h2>
        </div>
    </div>
    <!--end::Card header-->
    <!--begin::Card body-->
    <div class="card-body pt-0">
        <!--begin::Input group-->
        <div class="mb-10 fv-row fv-plugins-icon-container">
            <!--begin::Label-->
            <label class="required form-label">Base Price</label>
            <!--end::Label-->
            <!--begin::Input-->
            <input type="number" step="0.01" class="form-control form-control-solid" id="price" name="price" value="<?= $product ? htmlspecialchars($product['price']) : '' ?>" required />
            <!--end::Input-->
            <!--begin::Description-->
            <div class="text-muted fs-7">Set the product price. e.g., 150.00</div>
            <!--end::Description-->
            <div class="mb-10">
                <label class="form-label" for="currency">Currency</label>
                <input type="text" class="form-control form-control-solid" id="currency" name="currency" value="<?= $product ? htmlspecialchars($product['currency']) : 'USD' ?>" />
                <small class="text-muted">e.g., USD</small>
            </div>

            <!--end::Input group-->
            <!--begin::Input group-->
            <div class="fv-row mb-10">
                <!--begin::Label-->
                <label class="fs-6 fw-semibold mb-2">
                    Discount Type
                    <span
                        class="ms-1"
                        data-bs-toggle="tooltip"
                        aria-label="Select a discount type that will be applied to this product"
                        data-bs-original-title="Select a discount type that will be applied to this product"
                        data-kt-initialized="1"
                    >
                        <i class="ki-duotone ki-information-5 text-gray-500 fs-6">
                            <span class="path1"></span>
                            <span class="path2"></span>
                            <span class="path3"></span>
                        </i>
                    </span>
                </label>
                <!--End::Label-->
                <!--begin::Row-->
                <div class="row row-cols-1 row-cols-md-3 row-cols-lg-1 row-cols-xl-3 g-9" data-kt-buttons="true" data-kt-buttons-target="[data-kt-button='true']" data-kt-initialized="1">
                    <!--begin::Col-->
                    <div class="col">
                        <!--begin::Option-->
                        <label class="btn btn-outline btn-outline-dashed btn-active-light-primary active d-flex text-start p-6" data-kt-button="true">
                            <!--begin::Radio-->
                            <span class="form-check form-check-custom form-check-solid form-check-sm align-items-start mt-1">
                                <input class="form-check-input" type="radio" name="discount_option" value="1" checked="checked" />
                            </span>
                            <!--end::Radio-->
                            <!--begin::Info-->
                            <span class="ms-5">
                                <span class="fs-4 fw-bold text-gray-800 d-block">No Discount</span>
                            </span>
                            <!--end::Info-->
                        </label>
                        <!--end::Option-->
                    </div>
                    <!--end::Col-->
                    <!--begin::Col-->
                    <div class="col">
                        <!--begin::Option-->
                        <label class="btn btn-outline btn-outline-dashed btn-active-light-primary d-flex text-start p-6" data-kt-button="true">
                            <!--begin::Radio-->
                            <span class="form-check form-check-custom form-check-solid form-check-sm align-items-start mt-1">
                                <input class="form-check-input" type="radio" name="discount_option" value="2" />
                            </span>
                            <!--end::Radio-->
                            <!--begin::Info-->
                            <span class="ms-5">
                                <span class="fs-4 fw-bold text-gray-800 d-block">Percentage %</span>
                            </span>
                            <!--end::Info-->
                        </label>
                        <!--end::Option-->
                    </div>
                    <!--end::Col-->
                    <!--begin::Col-->
                    <div class="col">
                        <!--begin::Option-->
                        <label class="btn btn-outline btn-outline-dashed btn-active-light-primary d-flex text-start p-6" data-kt-button="true">
                            <!--begin::Radio-->
                            <span class="form-check form-check-custom form-check-solid form-check-sm align-items-start mt-1">
                                <input class="form-check-input" type="radio" name="discount_option" value="3" />
                            </span>
                            <!--end::Radio-->
                            <!--begin::Info-->
                            <span class="ms-5">
                                <span class="fs-4 fw-bold text-gray-800 d-block">Fixed Price</span>
                            </span>
                            <!--end::Info-->
                        </label>
                        <!--end::Option-->
                    </div>
                    <!--end::Col-->
                </div>
                <!--end::Row-->
            </div>
            <!--end::Input group-->
            <!--begin::Input group-->
            <div class="d-none mb-10 fv-row" id="kt_ecommerce_add_product_discount_percentage">
                <!--begin::Label-->
                <label class="form-label">Set Discount Percentage</label>
                <!--end::Label-->
                <!--begin::Slider-->
                <div class="d-flex flex-column text-center mb-5">
                    <div class="d-flex align-items-start justify-content-center mb-7">
                        <span class="fw-bold fs-3x" id="kt_ecommerce_add_product_discount_label">10</span>
                        <span class="fw-bold fs-4 mt-1 ms-2">%</span>
                    </div>
                    <div id="kt_ecommerce_add_product_discount_slider" class="noUi-sm noUi-target noUi-ltr noUi-horizontal noUi-txt-dir-ltr">
                        <div class="noUi-base">
                            <div class="noUi-connects"></div>
                            <div class="noUi-origin" style="transform: translate(-90.9091%, 0px); z-index: 4;">
                                <div class="noUi-handle noUi-handle-lower" data-handle="0" tabindex="0" role="slider" aria-orientation="horizontal" aria-valuemin="1.0" aria-valuemax="100.0" aria-valuenow="10.0" aria-valuetext="10.00">
                                    <div class="noUi-touch-area"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--end::Slider-->
                <!--begin::Description-->
                <div class="text-muted fs-7">Set a percentage discount to be applied on this product.</div>
                <!--end::Description-->
            </div>
            <!--end::Input group-->
            <!--begin::Input group-->
            <div class="d-none mb-10 fv-row" id="kt_ecommerce_add_product_discount_fixed">
                <!--begin::Label-->
                <label class="form-label">Fixed Discounted Price</label>
                <!--end::Label-->
                <!--begin::Input-->
                <input type="number" step="0.01" class="form-control form-control-solid" id="discount_price" name="discount_price" value="<?= $product ? htmlspecialchars($product['discount_price']) : '' ?>" />
                <!--end::Input-->
                <!--begin::Description-->
                <div class="text-muted fs-7">Set the discounted product price. The product will be reduced at the determined fixed price</div>
                <!--end::Description-->
            </div>
            <!--end::Input group-->
            <!--begin::Tax-->

            <!--end:Tax-->
        </div>
    </div>
    <!--end::Card header-->
</div>


                                                    </div>
                                                </div>
                                                <!--end::Tab pane-->
                                                <!--begin::Tab pane-->
                                         
                                                <!--end::Tab pane-->
                                            </div>
                                            <!--end::Tab content-->
                                             <div class="d-flex justify-content-end">
                                            
                                                <!--begin::Button-->
                                                <input type="hidden" name="action" value="<?php echo $action == 'edit' ? 'update' : 'add'; ?>">
                    <?php if ($action == 'edit'): ?>
                        <input type="hidden" name="id" value="<?php echo $product_id; ?>">
                    <?php endif; ?>
                    <button type="submit" name="submit" class="btn btn-primary"><?php echo $action == 'edit' ? 'Update' : 'Add'; ?> Product</button>
                    <a href="admin?page=products" class="btn btn-secondary">Cancel</a>
                                                <!--end::Button-->
                                            </div>
                                            
                                            
                                           
                                        </div>
                                        <!--end::Main column-->
                                    </form>

<script>
function addFeatureItem() {
    const featuresList = document.getElementById('features-list');
    const newFeatureItem = document.createElement('div');
    newFeatureItem.className = 'feature-item mb-3';
    newFeatureItem.innerHTML = `
        <div class="input-group">
            <input type="text" class="form-control" name="features[]" placeholder="Enter a feature">
            <button type="button" class="btn btn-light-danger" onclick="this.closest('.feature-item').remove();">
                <i class="ki-duotone ki-trash fs-5"><span class="path1"></span><span class="path2"></span><span class="path3"></span><span class="path4"></span><span class="path5"></span></i>
            </button>
        </div>
    `;
    featuresList.appendChild(newFeatureItem);
}
function addScreenshotItem() {
    var screenshotHtml = `
        <div class="screenshot-item mb-5">
            <div class="row">
                <div class="col-md-5 mb-3">
                    <input type="file" class="form-control" name="screenshot_file[]">
                </div>
                <div class="col-md-5 mb-3">
                    <input type="text" class="form-control" name="screenshot_caption[]" placeholder="Caption">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-sm btn-light-danger" onclick="this.closest('.screenshot-item').remove();">
                        <i class="ki-duotone ki-trash fs-5"><span class="path1"></span><span class="path2"></span><span class="path3"></span><span class="path4"></span><span class="path5"></span></i>
                        Delete
                    </button>
                </div>
            </div>
        </div>
    `;
    document.getElementById('screenshots-section').insertAdjacentHTML('beforeend', screenshotHtml);
}
</script>
 <?php else:
 ?>
<div class="card">
    <div class="card-header border-0 pt-6">
        <!--begin::Card title-->
        <div class="card-title">
            <!--begin::Search-->
            <div class="d-flex align-items-center position-relative my-1">
                <i class="ki-duotone ki-magnifier fs-3 position-absolute ms-4">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
                <input type="text" 
                       class="form-control form-control-solid w-250px ps-12" 
                       placeholder="Search Products..."
                       id="searchInput">
            </div>
            <!--end::Search-->
        </div>
        <!--begin::Card title-->
        
        <!--begin::Card toolbar-->
        <div class="card-toolbar">
            <div class="d-flex justify-content-end">
                <!--begin::Add News-->
               <a href="admin?page=products&amp;action=add" class="btn btn-sm btn-light-primary">
                    <span class="svg-icon svg-icon-2">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect opacity="0.5" x="11.364" y="20.364" width="16" height="2" rx="1" transform="rotate(-90 11.364 20.364)" fill="currentColor"></rect>
                            <rect x="4.36396" y="11.364" width="16" height="2" rx="1" fill="currentColor"></rect>
                        </svg>
                    </span>
                    Add New Product
                </a>
                <!--end::Add News-->
            </div>
        </div>
        <!--end::Card toolbar-->
    </div>

    <div class="card-body pt-0">
        <!--begin::Table container-->
        <div class="table-responsive">
            <!--begin::Table-->
            <table class="table table-row-dashed table-row-gray-300 align-middle gs-0 gy-4" id="news_table">
                <!--begin::Table head-->
                <thead>
                    <tr class="fw-bold text-muted">
                        
                        <th class="min-w-80px text-muted">ID</th>
                        <th class="min-w-200px text-muted">Title</th>
                        <th class="min-w-125px text-muted">Date</th>
                        <th class="min-w-100px text-end text-muted">Actions</th>
                    </tr>
                </thead>
                <!--end::Table head-->

                <!--begin::Table body-->
                <tbody>
                    <?php while ($row = $result->fetch_assoc()): ?>
                        <tr>
                          
                            <td>
                                <span class="text-dark fw-bold text-hover-primary d-block fs-7">
                                    <?php echo htmlspecialchars($row['id']); ?>
                                </span>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="symbol symbol-45px me-5">
                                        <img src="<?php echo htmlspecialchars($row['image_url']); ?>" 
                                             alt="<?php echo htmlspecialchars($row['name']); ?>"
                                             onerror="this.src='bitders/assets/logo.svg'"/>
                                    </div>
                                    <div class="d-flex flex-column">
                                        <a href="admin?page=news&action=edit&id=<?php echo $row['id']; ?>" 
                                           class="text-gray-900 fw-bold d-block fs-7">
                                            <?php echo htmlspecialchars($row['name']); ?>
                                        </a>
                                        <span class="text-muted fw-semibold text-muted d-block fs-7">  <?php echo $row['slug']; ?></span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex flex-column">
                                    <span class="text-dark fw-bold">
                                        <?php echo date('M d, Y', strtotime($row['created_at'])); ?>
                                    </span>
                                    <span class="text-muted fw-semibold text-muted d-block fs-7">
                                        <?php echo date('h:i A', strtotime($row['created_at'])); ?>
                                    </span>
                                </div>
                            </td>
                            <td class="text-end">
                                <div class="d-flex flex-end">
                                    <!-- Preview -->
                                    <a href="products/<?php echo htmlspecialchars($row['slug']); ?>" 
                                       target="_blank"
                                       class="btn btn-icon btn-bg-light btn-active-color-warning btn-sm me-1"
                                       data-bs-toggle="tooltip"
                                       title="Preview">
                                        <i class="ki-duotone ki-eye fs-2">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                            <span class="path3"></span>
                                        </i>
                                    </a>
                                    
                                    <!-- Edit -->
                                    <a href="admin?page=products&action=edit&id=<?php echo $row['id']; ?>" 
                                       class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm me-1"
                                       data-bs-toggle="tooltip"
                                       title="Edit">
                                        <i class="ki-duotone ki-pencil fs-2">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                        </i>
                                    </a>
                                    
                                    <!-- Delete -->
                                    <button type="button" 
                                            class="btn btn-icon btn-bg-light btn-active-color-danger btn-sm"
                                            onclick="confirmDelete(<?php echo $row['id']; ?>)"
                                            data-bs-toggle="tooltip"
                                            title="Delete">
                                        <i class="ki-duotone ki-trash fs-2">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                            <span class="path3"></span>
                                            <span class="path4"></span>
                                            <span class="path5"></span>
                                        </i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    <?php endwhile; ?>
                </tbody>
                <!--end::Table body-->
            </table>
            <!--end::Table-->
        </div>
        <!--end::Table container-->
    </div>
</div>

<!-- Delete Form Template (Hidden) -->
<form id="deleteForm" action="" method="post" style="display: none;">
    <input type="hidden" name="action" value="delete">
    <input type="hidden" name="id" value="">
</form>

<script>
"use strict";

// Initialize tooltips
var initTooltips = function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
};

// Search functionality
var initSearch = function() {
    const searchInput = document.getElementById('searchInput');
    const table = document.getElementById('news_table');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

    searchInput.addEventListener('keyup', function(e) {
        const searchText = e.target.value.toLowerCase();

        for (let row of rows) {
            const titleCell = row.querySelector('td:nth-child(3)');
            const title = titleCell.textContent.toLowerCase();

            if (title.includes(searchText)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }
    });
};

// Select all functionality
var initSelectAll = function() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('tbody .form-check-input');

    selectAllCheckbox.addEventListener('change', function() {
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    });
};

// Delete confirmation
var confirmDelete = function(id) {
    Swal.fire({
        text: "Are you sure you want to delete this news item?",
        icon: "warning",
        showCancelButton: true,
        buttonsStyling: false,
        confirmButtonText: "Yes, delete!",
        cancelButtonText: "No, cancel",
        customClass: {
            confirmButton: "btn fw-bold btn-danger",
            cancelButton: "btn fw-bold btn-active-light-primary"
        }
    }).then(function(result) {
        if (result.isConfirmed) {
            const form = document.getElementById('deleteForm');
            form.querySelector('input[name="id"]').value = id;
            form.submit();
        }
    });
};

// Initialize components
document.addEventListener('DOMContentLoaded', function() {
    initTooltips();
    initSearch();
    initSelectAll();
});
</script>

     <?php endif; ?> 
 
    

<?
    }
    if ($_GET['page'] == 'license')
{
$action = isset($_GET['action']) ? $_GET['action'] : '';
$id = isset($_GET['id']) ? intval($_GET['id']) : 0;
$redirect = false;
// Handle form submission
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $user_id = $_POST['user_id'];
    $product = $_POST['product'];
    $domain = $_POST['domain'];
    $telegram = $_POST['telegram'];
    $graph = $_POST['graph'];
    $status = $_POST['status'];

     if ($action === 'add') {
        $stmt = $DB_CONN->prepare("INSERT INTO license (user_id, product, domain, telegram, graph, datetime, status) VALUES (?, ?, ?, ?, ?, NOW(), ?)");
        $stmt->bind_param("iisiii", $user_id, $product, $domain, $telegram, $graph, $status);
    } elseif ($action === 'edit') {
        $stmt = $DB_CONN->prepare("UPDATE license SET user_id = ?, product = ?, domain = ?, telegram = ?, graph = ?, status = ? WHERE id = ?");
        $stmt->bind_param("iisiiii", $user_id, $product, $domain, $telegram, $graph, $status, $id);
    }

     if ($stmt->execute()) {
        $success_message = ($action === 'add') ? 'Added Successfully!' : 'Updated Successfully!';
        $_SESSION['success_message'] = $success_message;
        $redirect = true;
       
    } else {
        echo "Error: " . $stmt->error;
    }
}
if ($redirect) {
    echo "<script>window.location.href = '" . $_SERVER['PHP_SELF'] . "?page=license';</script>";
    exit;
}
 if (isset($_SESSION['success_message'])) {
        echo '<div class="alert alert-success">' . $_SESSION['success_message'] . '</div>';
        unset($_SESSION['success_message']);
    }

    // Display error message if it exists
    if (isset($error_message)) {
        echo '<div class="alert alert-danger">' . $error_message . '</div>';
    }
// Display the appropriate content based on the action
if ($action === '' || $action === 'list') {

    // List licenses
    $result = $DB_CONN->query("SELECT * FROM license ORDER BY id DESC");
    ?>
    <h2>License List</h2>
    <a href="admin?page=license&action=add" class="btn btn-primary">Add New License</a>
    <table class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>User ID</th>
                <th>Product</th>
                <th>Domain</th>
                <th>Telegram</th>
                <th>Graph</th>
                <th>Date</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <?php while ($row = $result->fetch_assoc()): ?>
            <tr>
                <td><?= $row['id'] ?></td>
                <td><?= $row['user_id'] ?></td>
                <td><?= $row['product'] ?></td>
                <td><?= $row['domain'] ?></td>
                <td><?= $row['telegram'] ?></td>
                <td><?= $row['graph'] ?></td>
                <td><?= $row['datetime'] ?></td>
                <td><?= $row['status'] ?></td>
                <td>
                    <a href="admin?page=license&action=edit&id=<?= $row['id'] ?>" class="btn btn-sm btn-primary">Edit</a>
                </td>
            </tr>
            <?php endwhile; ?>
        </tbody>
    </table>
    <?php
} elseif ($action === 'add' || $action === 'edit') {
    // Add or Edit license
    $license = null;
    if ($action === 'edit' && $id) {
        $stmt = $DB_CONN->prepare("SELECT * FROM license WHERE id = ?");
        $stmt->bind_param("i", $id);
        $stmt->execute();
        $result = $stmt->get_result();
        $license = $result->fetch_assoc();
    }
    ?>
    <h2><?= $action === 'add' ? 'Add New License' : 'Edit License' ?></h2>
    <form method="post">
        <div class="form-group">
            <label for="user_id">User ID</label>
            <input type="number" class="form-control" id="user_id" name="user_id" value="<?= $license ? $license['user_id'] : '' ?>" required>
        </div>
        <div class="form-group">
            <label for="product">Product</label>
            <input type="number" class="form-control" id="product" name="product" value="<?= $license ? $license['product'] : '' ?>" required>
        </div>
        <div class="form-group">
            <label for="domain">Domain</label>
            <input type="text" class="form-control" id="domain" name="domain" value="<?= $license ? $license['domain'] : '' ?>" required>
        </div>
        <div class="form-group">
            <label for="telegram">Telegram</label>
            <input type="number" class="form-control" id="telegram" name="telegram" value="<?= $license ? $license['telegram'] : '' ?>" required>
        </div>
        <div class="form-group">
            <label for="graph">Graph</label>
            <input type="number" class="form-control" id="graph" name="graph" value="<?= $license ? $license['graph'] : '' ?>" required>
        </div>
        <div class="form-group">
            <label for="status">Status</label>
            <input type="number" class="form-control" id="status" name="status" value="<?= $license ? $license['status'] : '' ?>" required>
        </div>
        
         <input type="hidden" name="id" value="<?= $id ?>">
        <button type="submit" class="btn btn-primary"><?= $action === 'add' ? 'Add License' : 'Update License' ?></button>
    </form>
    <?php
}

$DB_CONN->close();
?>?>

<?
    }
    if ($_GET['page'] == 'manage_pages')
{
    $query = "SELECT seo_links,datetime FROM preferences WHERE id='1'";
$result = mysqli_query($DB_CONN, $query);
$row = mysqli_fetch_assoc($result);
$seo_links = json_decode($row['seo_links'], true) ?: [];

if (isset($_POST['submit'])) {
    $new_seo_links = mysqli_real_escape_string($DB_CONN, json_encode($_POST['seo_links']));
    $update_seo = mysqli_query($DB_CONN, "UPDATE preferences SET seo_links='{$new_seo_links}' WHERE id='1'");
    if ($update_seo) {
        echo '<div class="alert alert-success">Updated Successfully!</div>';
        updateSiteData($siteURL);
        $query = "SELECT seo_links FROM preferences WHERE id='1'";
        $result = mysqli_query($DB_CONN, $query);
        $row = mysqli_fetch_assoc($result);
        $seo_links = json_decode($row['seo_links'], true) ?: [];
    } else {
        echo '<div class="alert alert-danger">Update Failed!</div>';
    }
}

$robotsOptions = ['index, follow', 'noindex, follow', 'noindex, nofollow'];
$schemaTypeOptions = ['WebPage','AboutPage','FAQPage', 'Blog', 'ProductsPage', 'Offer', 'ContactPage'];
$sitemapOptions = ['yes', 'no'];
$normalFields = ['title', 'description', 'keywords', 'image', 'robots', 'schema_type', 'sitemap', 'modified'];
$userFields = ['title', 'description'];
?>
<div class="card">
    <div class="card-header border-0 pt-6">
        <div class="card-title">
            <div class="d-flex align-items-center position-relative">
                <i class="ki-duotone ki-magnifier fs-3 position-absolute ms-4">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
                <input type="text" class="form-control form-control-solid w-250px ps-12" placeholder="Search pages...">
            </div>
        </div>
        <div class="card-toolbar">
            <div class="d-flex justify-content-end gap-2">
                <button type="submit" form="seoForm" name="submit" class="btn btn-light-primary">
                    <i class="ki-duotone ki-save-2 fs-2">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                    Save Changes
                </button>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPageModal">
                    <i class="ki-duotone ki-plus fs-2">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                    Add New Page
                </button>
            </div>
        </div>
    </div>

    <div class="card-body py-4">
      <form id="seoForm" method="post">
    <div class="table-responsive">
        <table class="table align-middle table-row-dashed fs-6 gy-5">
            <thead>
                <tr class="text-start text-muted fw-bold fs-7 text-uppercase gs-0">
                    <th class="min-w-125px">Page</th>
                    <th class="min-w-125px">URL Rename</th>
                    <?php foreach ($normalFields as $field): ?>
                        <th class="min-w-150px"><?= ucfirst($field) ?></th>
                    <?php endforeach; ?>
                    <th class="text-end min-w-70px">Actions</th>
                </tr>
            </thead>
            <tbody class="text-gray-600 fw-semibold">
                <?php foreach ($extra_pages as $page => $pageData): ?>
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="symbol symbol-35px me-3">
                                    <div class="symbol-label bg-light-primary">
                                        <i class="ki-duotone ki-document fs-2 text-primary">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                        </i>
                                    </div>
                                </div>
                                <div class="d-flex flex-column">
                                    <span class="text-gray-800 mb-1"><?= htmlspecialchars(ucfirst($page)) ?></span>
                                    <span class="text-gray-400 fs-7"><?= htmlspecialchars($pageData['template']) ?></span>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="position-relative">
                                <input type="text" name="seo_links[<?= $page ?>]" 
                                       class="form-control form-control-sm form-control-solid"
                                       value="<?= htmlspecialchars($seo_links[$page] ?? '') ?>">
                                       <small class="text-muted">Rename</small>
                            </div>
                        </td>

                        <?php 
                        $fields = ($pageData['type'] === 'normal') ? $normalFields : 
                                 ($pageData['type'] === 'user' ? ['title', 'description'] : []);
                        foreach ($fields as $field):
                            $fieldName = "{$page}_{$field}";
                            $value = $seo_links[$fieldName] ?? '';
                        ?>
                        <td>
                            <?php
                            // Handle each field type
                            switch($field):
                                case 'title':
                            ?>
                                <div class="d-flex flex-column gap-2">
                                    <input type="text" name="seo_links[<?= $fieldName ?>]" 
                                           class="form-control form-control-sm form-control-solid seo-title" 
                                           value="<?= htmlspecialchars($value) ?>"
                                           data-bs-toggle="tooltip"
                                           title="Page title for SEO">
                                    <div class="seo-suggestion title-suggestion fs-7"></div>
                                </div>
                            <?php
                                break;
                                case 'description':
                            ?>
                                <div class="d-flex flex-column gap-2">
                                    <textarea name="seo_links[<?= $fieldName ?>]" 
                                              class="form-control form-control-sm form-control-solid seo-description" 
                                              rows="2"
                                              data-bs-toggle="tooltip"
                                              title="Meta description for SEO"><?= htmlspecialchars($value) ?></textarea>
                                    <div class="seo-suggestion description-suggestion fs-7"></div>
                                </div>
                            <?php
                                break;
                                case 'keywords':
                            ?>
                                <div class="d-flex flex-column gap-2">
                                    <textarea name="seo_links[<?= $fieldName ?>]" 
                                              class="form-control form-control-sm form-control-solid seo-keywords" 
                                              rows="2"
                                              data-bs-toggle="tooltip"
                                              title="Keywords for SEO"><?= htmlspecialchars($value) ?></textarea>
                                    <div class="seo-suggestion keywords-suggestion fs-7"></div>
                                </div>
                            <?php
                                break;
                                case 'image':
?>
    <div class="d-flex flex-column gap-2">
        <div class="image-input image-input-outline" data-kt-image-input="true">
            <div class="image-input-wrapper w-200px h-125px" id="image-preview-<?= $fieldName ?>"
                 style="background-image: url('<?= htmlspecialchars($value ?: 'bitders/assets/placeholder.svg') ?>');">
            </div>
            
            <label class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow"
                   data-kt-image-input-action="change"
                   data-bs-toggle="modal"
                   data-bs-target="#kt_modal_100"
                   title="Change image">
                <i class="ki-duotone ki-pencil fs-7">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
            </label>
            
            <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow"
                  data-kt-image-input-action="cancel"
                  data-bs-toggle="tooltip"
                  data-bs-dismiss="click"
                  title="Cancel image">
                <i class="ki-outline ki-cross fs-2"></i>
            </span>
            
            <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow"
                  data-kt-image-input-action="remove"
                  data-bs-toggle="tooltip"
                  data-bs-dismiss="click"
                  title="Remove image">
                <i class="ki-outline ki-cross fs-2"></i>
            </span>
        </div>
        
        <input type="hidden" 
               id="image-input-<?= $fieldName ?>"
               name="seo_links[<?= $fieldName ?>]"
               value="<?= htmlspecialchars($value) ?>"
               data-original-value="<?= htmlspecialchars($value) ?>">
        
        <div class="text-muted fs-7">
            Recommended: 1200x628px for social media
        </div>
    </div>
<?php
    break;
                                case 'robots':
                            ?>
                                <select name="seo_links[<?= $fieldName ?>]" 
                                        class="form-select form-select-sm form-select-solid robots-select" 
                                        id="<?= $fieldName ?>"
                                        data-control="select2"
                                        data-hide-search="true">
                                    <?php foreach ($robotsOptions as $option): ?>
                                        <option value="<?= $option ?>" <?= $value == $option ? 'selected' : '' ?>><?= $option ?></option>
                                    <?php endforeach; ?>
                                </select>
                            <?php
                                break;
                                case 'schema_type':
        ?>
        <select name="seo_links[<?= $fieldName ?>]" 
                class="form-select form-select-sm form-select-solid"
                data-control="select2"
                data-hide-search="true"
                data-bs-toggle="tooltip"
                title="Select schema type for structured data">
            <?php foreach ($schemaTypeOptions as $option): ?>
                <option value="<?= $option ?>" <?= $value == $option ? 'selected' : '' ?>>
                    <?= $option ?>
                </option>
            <?php endforeach; ?>
        </select>
        <?php
        break;
                                
                                case 'sitemap':
                            ?>
                                <div class="form-check form-switch form-check-custom form-check-solid">
                                    <input class="form-check-input sitemap-switch h-20px w-30px" 
                                           type="checkbox" 
                                           name="seo_links[<?= $fieldName ?>]" 
                                           value="yes" 
                                           id="<?= $fieldName ?>" 
                                           <?= $value == 'yes' ? 'checked' : '' ?> />
                                    <label class="form-check-label ms-2" for="<?= $fieldName ?>">
                                        <?= $value == 'yes' ? 'Include' : 'Exclude' ?>
                                    </label>
                                </div>
                            <?php
                                break;
                                case 'modified':
                                    $templateFile = __DIR__ . "/tmpl/{$template}";
                                    $fileModTime = null;
                                    if (file_exists($templateFile) && is_readable($templateFile)) {
                                        $fileModTime = filemtime($templateFile);
                                    }
                                    $fileModDate = $fileModTime ? date('Y-m-d H:i:s', $fileModTime) : '';
                                    if (empty($value)) {
                                        $displayTime = $fileModDate ?: ($row['datetime'] ?? '');
                                    } else {
                                        if ($fileModDate && strtotime($fileModDate) > strtotime($value)) {
                                            $displayTime = $fileModDate;
                                        } else {
                                            $displayTime = $value;
                                        }
                                    }
                            ?>
                                <div class="position-relative">
                                    <div class="input-group input-group-solid">
                                        <input type="datetime-local"
                                               id="datetime_<?= $fieldName ?>"
                                               name="seo_links[<?= $fieldName ?>]"
                                               class="form-control form-control-sm form-control-solid"
                                               value="<?= htmlspecialchars(date('Y-m-d\TH:i', strtotime($displayTime))) ?>"
                                               data-bs-toggle="tooltip"
                                               title="Last modified date">
                                        <button type="button" 
                                                class="btn btn-icon btn-light-primary"
                                                onclick="setToday('datetime_<?= $fieldName ?>')"
                                                data-bs-toggle="tooltip"
                                                title="Set to current date">
                                            <i class="ki-duotone ki-calendar fs-2">
                                                <span class="path1"></span>
                                                <span class="path2"></span>
                                            </i>
                                        </button>
                                    </div>
                                    <?php if ($fileModDate): ?>
                                    <div class="fs-7 text-muted mt-2">
                                        Template last modified: <?= date('Y-m-d H:i', strtotime($fileModDate)) ?>
                                    </div>
                                    <?php endif; ?>
                                </div>
                            <?php
                                break;
                                default:
                            ?>
                                <input type="text" 
                                       name="seo_links[<?= $fieldName ?>]" 
                                       class="form-control form-control-sm form-control-solid" 
                                       value="<?= htmlspecialchars($value) ?>">
                            <?php
                                break;
                            endswitch;
                            ?>
                        </td>
                        <?php endforeach;
                        
                        // Handle empty fields
                        $emptyFields = array_diff($normalFields, $fields);
                        foreach ($emptyFields as $field): ?>
                            <td></td>
                        <?php endforeach; ?>

                        <td class="text-end">
                            <button type="button" 
                                    class="btn btn-icon btn-light-danger btn-active-danger btn-sm delete-page" 
                                    data-page-key="<?= htmlspecialchars($page) ?>"
                                    data-bs-toggle="tooltip"
                                    title="Delete page">
                                <i class="ki-duotone ki-trash fs-2">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                    <span class="path3"></span>
                                    <span class="path4"></span>
                                    <span class="path5"></span>
                                </i>
                            </button>
                        </td>
                    </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    </div>
</form>
    </div>
</div>

<!-- Add Page Modal -->
<div class="modal fade" id="addPageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="fw-bold">Add New Page</h2>
                <div class="btn btn-icon btn-sm btn-active-light-primary ms-2" data-bs-dismiss="modal">
                    <i class="ki-duotone ki-cross fs-1"><span class="path1"></span><span class="path2"></span></i>
                </div>
            </div>
            <div class="modal-body">
                <form id="addPageForm" class="form">
                    <div class="mb-5">
                        <label class="form-label required">Page Name</label>
                        <input type="text" class="form-control" id="page_key" name="page_key" required>
                        <div class="text-muted fs-7 mt-2">No spaces allowed. Example: myhomepage</div>
                    </div>
                    <div class="mb-5">
                        <label class="form-label">Template Name</label>
                        <input type="text" class="form-control form-control-solid" id="template_name" name="template_name" readonly>
                    </div>
                    <div class="mb-5">
                        <label class="form-label required">Page Type</label>
                        <select class="form-select" id="page_type" name="page_type" required data-control="select2" data-hide-search="true">
                            <option value="normal">Front End</option>
                            <option value="user">User End</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="addPageButton">
                    <span class="indicator-label">Add Page</span>
                    <span class="indicator-progress">Please wait... 
                        <span class="spinner-border spinner-border-sm align-middle ms-2"></span>
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize tooltips
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
});

// Update template name as user types page name
document.getElementById('page_key').addEventListener('input', function() {
    let pageName = this.value.replace(/\s+/g, '');
    this.value = pageName;
    document.getElementById('template_name').value = pageName + '.tpl';
});

// Add page functionality
document.getElementById('addPageButton').addEventListener('click', function() {
    const button = this;
    const form = document.getElementById('addPageForm');
    const pageKeyInput = document.getElementById('page_key');
    const pageName = pageKeyInput.value.trim();
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    if (pageName === '') {
        Swal.fire({
            text: "Page name cannot be empty.",
            icon: "error",
            buttonsStyling: false,
            confirmButtonText: "Ok, got it!",
            customClass: {
                confirmButton: "btn btn-primary"
            }
        });
        return;
    }
    
    if (pageName.includes(' ')) {
        Swal.fire({
            text: "Page name cannot contain spaces.",
            icon: "error",
            buttonsStyling: false,
            confirmButtonText: "Ok, got it!",
            customClass: {
                confirmButton: "btn btn-primary"
            }
        });
        return;
    }
    
    // Show loading state
    button.setAttribute('data-kt-indicator', 'on');
    button.disabled = true;
    
    var formData = new FormData(form);
    fetch('?page=add_expage', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        button.removeAttribute('data-kt-indicator');
        button.disabled = false;
        
        if (data.success) {
            Swal.fire({
                text: "Page added successfully!",
                icon: "success",
                buttonsStyling: false,
                confirmButtonText: "Ok, got it!",
                customClass: {
                    confirmButton: "btn btn-primary"
                }
            }).then(function() {
                location.reload();
            });
        } else {
            Swal.fire({
                text: "Error: " + data.message,
                icon: "error",
                buttonsStyling: false,
                confirmButtonText: "Ok, got it!",
                customClass: {
                    confirmButton: "btn btn-primary"
                }
            });
        }
    });
});

// Delete page functionality
document.querySelectorAll('.delete-page').forEach(button => {
    button.addEventListener('click', function() {
        const pageKey = this.getAttribute('data-page-key');
        
        Swal.fire({
            text: "Are you sure you want to delete this page?",
            icon: "warning",
            showCancelButton: true,
            buttonsStyling: false,
            confirmButtonText: "Yes, delete it!",
            cancelButtonText: "No, cancel",
            customClass: {
                confirmButton: "btn btn-danger",
                cancelButton: "btn btn-active-light"
            }
        }).then((result) => {
            if (result.isConfirmed) {
                fetch('?page=delete_expage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'page_key=' + encodeURIComponent(pageKey)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            text: "Page deleted successfully!",
                            icon: "success",
                            buttonsStyling: false,
                            confirmButtonText: "Ok, got it!",
                            customClass: {
                                confirmButton: "btn btn-primary"
                            }
                        }).then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire({
                            text: "Error: " + data.message,
                            icon: "error",
                            buttonsStyling: false,
                            confirmButtonText: "Ok, got it!",
                            customClass: {
                                confirmButton: "btn btn-primary"
                            }
                        });
                    }
                });
            }
        });
    });
});

// SEO Suggestions functionality
document.addEventListener('DOMContentLoaded', function() {
    const siteName = "<?= addslashes($siteName) ?>";
    const titles = document.querySelectorAll('.seo-title');
    const descriptions = document.querySelectorAll('.seo-description');
    const keywords = document.querySelectorAll('.seo-keywords');
    const canonicals = document.querySelectorAll('.seo-canonical');
    const sitemapSwitches = document.querySelectorAll('.sitemap-switch');

    // Helper function to create badge HTML
    function createBadge(message, type) {
        return `<span class="badge badge-light-${type} fs-8 fw-semibold">${message}</span>`;
    }

    function updateSuggestion(element, suggestionElement, maxLength, type) {
        let currentLength = element.value.length;
        let remainingChars = maxLength - currentLength;

        switch(type) {
            case 'title':
                const siteNameAddition = ` - ${siteName}`;
                const totalLength = currentLength + siteNameAddition.length;
                remainingChars = maxLength - totalLength;
                
                if (remainingChars >= 0) {
                    suggestionElement.innerHTML = createBadge(
                        `${remainingChars} characters left (including "${siteNameAddition}")`,
                        'success'
                    );
                } else {
                    suggestionElement.innerHTML = createBadge(
                        `${Math.abs(remainingChars)} characters over limit (including "${siteNameAddition}")`,
                        'danger'
                    );
                }
                break;

            case 'keywords':
                const keywordCount = element.value.split(',').filter(k => k.trim() !== '').length;
                if (keywordCount <= 5) {
                    suggestionElement.innerHTML = createBadge(
                        `${keywordCount} keywords (recommended: 3-5)`,
                        'success'
                    );
                } else {
                    suggestionElement.innerHTML = createBadge(
                        `${keywordCount} keywords (consider reducing)`,
                        'warning'
                    );
                }
                break;

            case 'canonical':
                if (element.value.trim() !== '') {
                    suggestionElement.innerHTML = createBadge(
                        'Canonical URL set',
                        'success'
                    );
                } else {
                    suggestionElement.innerHTML = createBadge(
                        'Consider setting a canonical URL',
                        'warning'
                    );
                }
                break;

            default:
                if (remainingChars >= 0) {
                    suggestionElement.innerHTML = createBadge(
                        `${remainingChars} characters left`,
                        'success'
                    );
                } else {
                    suggestionElement.innerHTML = createBadge(
                        `${Math.abs(remainingChars)} characters over limit`,
                        'danger'
                    );
                }
        }
    }

    // Initialize and handle SEO field events
    function initializeSEOField(elements, maxLength, type) {
        elements.forEach(element => {
            const suggestionElement = element.nextElementSibling;
            if (suggestionElement) {
                element.addEventListener('input', () => updateSuggestion(element, suggestionElement, maxLength, type));
                updateSuggestion(element, suggestionElement, maxLength, type);
            }
        });
    }

    initializeSEOField(titles, 60, 'title');
    initializeSEOField(descriptions, 160, 'description');
    initializeSEOField(keywords, 0, 'keywords');
    initializeSEOField(canonicals, 0, 'canonical');

    // Handle sitemap switches
    sitemapSwitches.forEach(function(switchElem) {
        const robotsSelect = switchElem.closest('tr').querySelector('.robots-select');
        
        function updateRobotsSelect(switchElem, robotsSelect) {
            if (robotsSelect) {
                robotsSelect.value = switchElem.checked ? 'index, follow' : 'noindex, nofollow';
                // Trigger Select2 update if using Select2
                $(robotsSelect).trigger('change');
            }
        }

        // Initial state
        updateRobotsSelect(switchElem, robotsSelect);

        // Handle changes
        switchElem.addEventListener('change', function() {
            updateRobotsSelect(this, robotsSelect);
            const label = this.nextElementSibling;
            if (label) {
                label.textContent = this.checked ? 'Include' : 'Exclude';
            }
        });
    });
});

// Set today's date function
function setToday(inputId) {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    
    const formattedDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
    const input = document.getElementById(inputId);
    
    if (input) {
        input.value = formattedDateTime;
    }
}

// Initialize search functionality
const searchInput = document.querySelector('input[placeholder="Search pages..."]');
if (searchInput) {
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            const pageName = row.querySelector('.text-gray-800').textContent.toLowerCase();
            const template = row.querySelector('.text-gray-400').textContent.toLowerCase();
            
            if (pageName.includes(searchTerm) || template.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
}

// Initialize Select2 for dropdowns
$(document).ready(function() {
    $('.form-select').select2({
        minimumResultsForSearch: -1 // Disable search for small dropdowns
    });
});
</script>
<?
    }

    if ($_GET['page'] == 'top_refer')
    { ?>    

                                
                    

                                    <!--end::Toolbar-->
                                    <!--begin::Tab Content-->
                                    <div class="tab-content">
                                        <!--begin::Tab pane-->
                                <div class="card card-flush h-xl-100">
                                                <!--begin::Header-->
                                                <div class="card-header pt-7">
                                                    <!--begin::Title-->
                                                    <h4 class="card-title align-items-start flex-column">
                                                        <span class="card-label fw-bolder text-gray-800">Top Referrals </span>
                                                        <span class="text-gray-400 mt-1 fw-bold fs-7">View Top Referrals Users with there Referral Tree.</span>
                                                    </h4>
                                                    <!--end::Title-->
                                                    <!--begin::Toolbar-->
                                                
                                                    <!--end::Toolbar-->
                                                </div>
                                                <!--end::Header-->
                                                <!--begin::Body-->
                                                <div class="card-body py-3">
                                                    <!--begin::Table container-->
                                                    <div class="table-responsive">
                                                        <!--begin::Table-->
                                                        <table class="table table-row-dashed align-middle gs-0 gy-4 my-0 ">
                                                    
                                   
                                        <thead class="fw-bold text-muted bg-light">
        <tr>
        <th> Username  </th>
        <th> Total Referrals  </th>
        <th> Active Investments </th>
        <th> Total  Investments </th>
        <th> View User </th>
        
        </tr>
    </thead>


    <tbody>
        <?php
        $cUser = mysqli_query($DB_CONN, "SELECT COUNT(*) as users, sponsor FROM `users` where sponsor != 0 GROUP by sponsor ORDER BY `users` DESC ");
        while ($row_User = mysqli_fetch_assoc($cUser))
        {
            $user_id = $row_User['sponsor'];

            $active_deposits = mysqli_query($DB_CONN, "SELECT SUM(amount) AS amount_sum , COUNT(*) as users from package_deposits WHERE user_id  in (select id from users where sponsor = '{$user_id}') AND status='1'");
            $total_deposits = mysqli_query($DB_CONN, "SELECT SUM(amount) AS amount_sum , COUNT(*) as users from package_deposits WHERE user_id  in (select id from users where sponsor = '{$user_id}') and last_earningDateTime");
            $t_deposits = mysqli_fetch_assoc($total_deposits);
            $row_deposits = mysqli_fetch_assoc($active_deposits);
            $sum = $row_deposits['amount_sum'];
            $tsum = $t_deposits['amount_sum'];
?>
        <tr>

            <td><a href="admin.php?page=user&id=<?php echo $user_id ?>&view=overview" class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6">   <?php echo get_username($user_id); ?> </a></td>
            <td> <?php echo $row_User['users']; ?>  </td>
            <td><div class="flex-grow-1 me-2">
                                                                <a href="pages/user-profile/overview.html" class="text-gray-800 text-hover-success fs-6 fw-bold"><?php echo number_format((float)$sum, $preferences['round']) ?> </a>
                                                                <span class="text-muted fw-bold d-block fs-7 fw-semibold"> Users: <span class="badge badge-secondary"><?php echo $row_deposits['users'] ?></span> </span>
                                                            </div>
                                                             </td>
                <td><div class="flex-grow-1 me-2">
                                                                <a href="pages/user-profile/overview.html" class="text-gray-800 text-hover-success fs-6 fw-bold"><?php echo number_format((float)$tsum, $preferences['round']) ?>  </a>
                                                                <span class="text-muted fw-bold d-block fs-7 fw-semibold"> Users: <span class="badge badge-secondary"><?php echo $t_deposits['users'] ?></span> </span>
                                                            </div>
                                                             </td>
            
            <td> <button class="btn btn-sm btn-primary"   data-bs-toggle="modal" data-bs-target="#myModal<?php echo $user_id ?>"> View Users </button> 
            <button class="btn btn-sm btn-primary"  onclick="javascript:window.open('admin.php?page=user&id=<?php echo $user_id ?>&view=tree', '_blank');" > View Referral Tree </button> </td>
            
        </tr>



<div class="modal fade" tabindex="-1" id="myModal<?php echo $user_id ?>">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">View Users</h3>

                <!--begin::Close-->
                <div class="btn btn-icon btn-sm btn-active-light-primary ms-2" data-bs-dismiss="modal" aria-label="Close">
                    <i class="ki-duotone ki-cross fs-1"><span class="path1"></span><span class="path2"></span></i>
                </div>
                <!--end::Close-->
            </div>

            <div class="modal-body">
                                                
                 <?php $select_users = mysqli_query($DB_CONN, "SELECT * from users where sponsor={$row_User['sponsor']}");
            while ($row_slct = mysqli_fetch_assoc($select_users))
            {

                $active_deposits = mysqli_query($DB_CONN, "SELECT SUM(amount) AS amount_sum from package_deposits WHERE user_id='{$row_slct['id']}' AND status='1'");
                $row_deposits = mysqli_fetch_assoc($active_deposits);
                $to_deposits = mysqli_query($DB_CONN, "SELECT SUM(amount) AS amount_sum from package_deposits WHERE user_id='{$row_slct['id']}' AND last_earningDateTime");
                $t_deposits = mysqli_fetch_assoc($to_deposits);
                $sum = $row_deposits['amount_sum'];
                $tsum = $t_deposits['amount_sum']; ?>
             
                                                    <!--begin::Item-->
                                                    <div class="d-flex align-items-sm-center mb-1">
                                                    
                                                        <!--end::Symbol-->
                                                        <!--begin::Section-->
                                                        <div class="d-flex align-items-center flex-row-fluid flex-wrap">
                                                            <div class="flex-grow-1 me-2">
                                                                <a href="admin.php?page=user&id=<?php echo $row_slct['id']; ?>&view=overview" target="_blank" class="text-gray-800 text-hover-primary fs-6 fw-bold"><?php echo $row_slct['username']; ?> 
                                                                
                                                                
                                                                
                                                                <?php if ($row_deposits['amount_sum']) {?>
                                                                <a  title="Invested & Active">
                                                                    <i class="ki-duotone ki-dollar fs-1 text-success">
                                                                        <span class="path1"></span>
                                                                        <span class="path2"></span>
                                                                        <span class="path3"></span>
                                                                    </i>
                                                                </a>
                                                                <? }elseif($t_deposits['amount_sum']){ ?>
                                                                <a  title="Invested">
                                                                    <i class="ki-duotone ki-dollar fs-1">
                                                                        <span class="path1"></span>
                                                                        <span class="path2"></span>
                                                                        <span class="path3"></span>
                                                                    </i>
                                                                </a>
                                                                <? }?></a>
                                                                <span class="text-muted fw-semibold d-block fs-7">Total: <?php echo number_format((float)$tsum, $preferences['round']) ?></span>
                                                            </div>
                                                            
                                                            <span class="<? if ($sum == 0) { echo "badge badge-light fw-bold my-2"; } else { echo "badge badge-success fw-bold my-2 "; } ?>" ><?php echo number_format((float)$sum, $preferences['round']) ?>$</span>
                                                        </div>
                                                        <!--end::Section-->
                                                    </div>
                                                    <!--end::Item-->
                                                
                                                
            
                <?php
            } ?>
               
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
              
            </div>
        </div>
    </div>
</div>

 
            
      
  

    <?php
        } ?>
    </tbody>

                                                        </table>
                                                        <!--end::Table-->
                                                    </div>
                                                    <!--end::Table container-->
                                                </div>
                                                <!--begin::Body-->
                                            </div>
                                        <!--end::Tab pane-->
                                    </div>
                            
<?
    }
    if ($_GET['page'] == 'currencies')
    { ?>

                                        <!--begin::Content-->
                                    <div class="card mb-5 mb-xl-10">
                                        <!--begin::Card header-->
                                        <div class="card-header min-h-unset py-2" role="button" data-bs-toggle="collapse" data-bs-target="#kt_account_profile_details" aria-expanded="true" aria-controls="kt_account_profile_details">
                                            <!--begin::Card title-->
                                            <div class="card-title m-0">
                                                <h3 class="fw-bold m-0 fs-5">Payment Methods / Currencies</h3>
                                                
                                            </div>
                                            <!--end::Card title-->
                                            <div class="card-toolbar">
                                                <a  href="#" class="btn btn-sm fw-bold btn-primary" data-bs-toggle="modal" data-bs-target="#kt_modal_create_app">Add New Currencies</a>
                                            </div>
                                        </div>
                                        <!--begin::Card header-->
                                        <!--begin::Content-->
                                        <div id="kt_account_settings_profile_details" class="collapse show">
                                            
                                    <div class="card-body py-3">
                                        <div class="table-responsive" data-select2-id="select2-data-145-mo44">
                                                <!--begin::Table-->
                                                
                                                <table  class="table table-striped align-middle gs-0 gy-4 currencies_table">
                                                    <!--begin::Thead-->
                                                    <thead class="fw-bold text-muted bg-light">
                                                        <tr>
                                                            <th class="">Name</th>
                                                            <th class="">Rate</th>
                                                            <th class="">Deposit</th>
                                                            
                                                            <th class="">Withdraw</th>
                                                            <th class="">Status</th>
                                                        
                                                            <th class="text-end ">Action</th>
                                                        </tr>
                                                    </thead>
                                                    <!--end::Thead-->
                                                    <!--begin::Tbody-->
                                                    <tbody class="fs-6 fw-bold text-gray-600">
                                                        
                                                    </tbody>
                                                    <!--end::Tbody-->
                                                </table>
                                                <!--end::Table-->
                                            </div>
                                            <!--end::Table wrapper-->
                                            
                                            
                                        
                                        </div>
                                        <!--end::Content-->
                                    </div>
                                        <!--end::Content-->
                                        <!--begin::Sidebar-->
                                
                                        <!--end::Sidebar-->
                                    </div>
                            
                                    

   
                                    
<div class="modal fade" id="currency_template" tabindex="-1" style="display: none;" aria-hidden="true">
    <!--begin::Modal dialog-->
    <div class="modal-dialog modal-dialog-centered mw-650px">
        <!--begin::Modal content-->
        <div class="modal-content">
            <!--begin::Modal header-->
            <div class="modal-header">
                <div class="d-flex align-items-center">
                    <!--begin::Name-->
                    <div class="d-flex justify-content-start flex-column">
                        <a  class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6">Details for <span class="c_name"></span></a>
                        <a  class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                            <span class="text-gray-900">Symbol</span>: <span class="c_symbol"></span> | <span class="text-gray-900">Rate</span>: <span class="c_rate"></span>
                        </a>
                    </div>
                    <!--end::Name-->
                </div>

                <!--begin::Close-->
                <div class="btn btn-icon btn-sm btn-active-light-primary ms-2" data-bs-dismiss="modal" aria-label="Close">
                    <i class="ki-duotone ki-cross fs-1"><span class="path1"></span><span class="path2"></span></i>
                </div>
                <!--end::Close-->
            </div>
            <!--end::Modal header-->
            <!--begin::Form-->

            <!--begin::Modal body-->
            <div class="modal-body py-10 px-lg-17">
                <!--begin::Scroll-->

                <!--begin::Notice-->

                <!--end::Notice-->
                <div class="table-responsive">
                    <table  class="table table-rounded table-bordered gy-1 gs-5">
                        <tbody id="tdata"></tbody>
                    </table>
                </div>

                <!--end::Scroll-->
            </div>
            <!--end::Modal body-->
            <!--begin::Modal footer-->
            <div class="modal-footer flex-center">
                <!--begin::Button-->
                <button type="reset" id="kt_modal_create_api_key_cancel" class="btn btn-light me-3" data-bs-dismiss="modal">Close</button>
                <!--end::Button-->
            </div>
            <!--end::Modal footer-->
            <div></div>
            <!--end::Form-->
        </div>
        <!--end::Modal content-->
    </div>
    <!--end::Modal dialog-->
</div>
 <div class="modal fade " tabindex="-1" id="edit_currency"  >
    <div class="modal-dialog modal-dialog-centered mw-650px">
        <div class="modal-content">
            <div class="modal-header"> 
              
<div class="d-flex align-items-center">
                                                                
            <!--begin::Name-->
            <div class="d-flex justify-content-start flex-column">
                <a   class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6"  >Edit <span class="c_name"></span></a>
                <a   class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                <span class="text-gray-900">Ticker</span>: <span class="c_symbol"></span> |  <span class="text-gray-900">Symbol</span>: <span class="c_symbol"></span> |<span class="text-gray-900">Rate</span>: <span class="c_rate"></span></a>
            </div>
            <!--end::Name-->
        </div>
                                                                
                <!--begin::Close-->
                <div class="btn btn-icon btn-sm btn-active-light-primary ms-2" data-bs-dismiss="modal" aria-label="Close">
                    <i class="ki-duotone ki-cross fs-1"><span class="path1"></span><span class="path2"></span></i>
                </div>
                <!--end::Close-->
            </div>

            <div class="modal-body">
                                                
                 <form id="edit_currency_form" class="form fv-plugins-bootstrap5 fv-plugins-framework" method="post">
                     
        <table  class="table table-rounded table-bordered gy-1 gs-5">
            
            <tbody>          
            <tr>
    <th class="title">Currency Name</th>
    <td colspan="3">
        <input type="text" placeholder="Currency Name" name="name" id="name" class="form-control form-control-sm form-control-solid">
    </td>
</tr>
            <tr>
    <th class="title">Currency Ticker</th>
    <td colspan="3">
        <input type="text" placeholder="Currency Ticker" name="ticker" id="ticker" class="form-control form-control-sm form-control-solid">
    </td>
</tr>
            <tr>
            <th class="title text-center text-primary" colspan="4">Invest/Deposit </th>
        </tr>
        <tr>
            <th class="title" colspan="2">Invest/Deposit Settings:</th>
           
             <th class="title" colspan="2">
                 <select class="form-select form-select-sm form-select-solid" name="de_pm_id">
            <option value="0">Disable</option>
            <? $m = mysqli_query($DB_CONN, "SELECT * FROM `payment_methods` WHERE deposit_allow and json_length(currencies) and status ");
        while ($value = mysqli_fetch_assoc($m))
        {
?>
                <option value="<?=$value['id'] ?>"><?=$value['name'] ?></option>
                <?
        } ?>
        </select></th>
        </tr>
        <tr>
            <th class="title text-center" colspan="4">Invest/Deposit  Limits</th>
        </tr>
        <tr>
            <th style="width: 30%">Min ($)</th>
            <td style="width: 20%" class="text-end"><input type="amount"  placeholder="" name="dep_min" id="dep_min" class="form-control form-control-sm form-control-solid"></td>
            <th style="width: 30%">Max ($)</th>
            <td style="width: 20%" class="text-end"><input type="amount"  placeholder="" name="dep_max" id="dep_max" class="form-control form-control-sm form-control-solid"></td>
        </tr>
        <tr>
            <th class="title  text-center" colspan="4">Invest/Deposit  Fees</th>
        </tr>
        <tr>
            <th>Fee (%)</th>
            <td class="text-end"><input type="amount"  placeholder="" name="dep_fee_per" id="dep_fee_per" class="form-control form-control-sm form-control-solid"></td>
            <th>Additional Fee ($)</th>
            <td class="text-end"><input type="amount"  placeholder="" name="dep_fee_amount" id="dep_fee_amount" class="form-control form-control-sm form-control-solid"></td>
        </tr>
        <tr>
            <th>Min ($)</th>
            <td class="text-end"><input type="amount"  placeholder="" name="dep_fee_min" id="dep_fee_min" class="form-control form-control-sm form-control-solid"></td>
            <th>Max ($)</th>
            <td class="text-end"><input type="amount"  placeholder="" name="dep_fee_max" id="dep_fee_max" class="form-control form-control-sm form-control-solid"></td>
        </tr>
        
        <tr>
            <th class="  text-center " colspan="4"><span class="badge badge-light-primary">Invest/Deposit Bonus</span></th>  
        </tr>
        <tr>
            <th>Bonus (%)</th>
            <td class="text-end"><input type="amount"  placeholder="" name="dep_bonus_per" id="dep_bonus_per" class="form-control form-control-sm form-control-solid"></td>
            <th>Additional Bonus ($)</th>
            <td class="text-end"><input type="amount"  placeholder="" name="dep_bonus_amount" id="dep_bonus_amount" class="form-control form-control-sm form-control-solid"></td>
        </tr>
        <tr>
            <th class=" title text-start " colspan="4"><span class="">Default Address (In Case of Processor Failure or for Manual Payments)</span></th>  
        </tr>
        <tr>
            <td class="title">Default Address</td>
            <td colspan="3"><input type="text"  placeholder="Currency Default Address (If processor error.)" name="address" id="address" class="form-control form-control-sm form-control-solid"></td>
        </tr>
            <tr>
            <th class="title text-center text-info" colspan="4">Withdraw</th>
        </tr>
        <tr>
            <th class="title" colspan="2">Withdraw Settings</th>
             <th class="title" colspan="2"><select class="form-select form-select-sm form-select-solid" name="wi_pm_id">
               <option value="0">Disable</option>
                <? $w = mysqli_query($DB_CONN, "SELECT * FROM `payment_methods` WHERE withdraw_allow and json_length(currencies) and status and withdraw");
        while ($value = mysqli_fetch_assoc($w))
        {
?>
                    <option value="<?=$value['id'] ?>"><?=$value['name'] ?></option>
                    <?
        } ?>
            </select></th>
        </tr>
         <tr>
            <th class="title  text-center" colspan="4">Withdraw Limits</th>
        </tr>
       <tr>
            <th style="width: 30%">Min ($)</th>
            <td style="width: 20%" class="text-end"><input type="amount"  placeholder="" name="with_min" id="with_min" class="form-control form-control-sm form-control-solid"></td>
            <th style="width: 30%">Max ($)</th>
            <td style="width: 20%" class="text-end"><input type="amount"  placeholder="" name="with_max" id="with_max" class="form-control form-control-sm form-control-solid"></td>
        </tr>
        <tr>
            <th class="title  text-center" colspan="4">Withdraw Fees</th>
        </tr>
                <tr>
            <th>Fee (%)</th>
            <td class="text-end"><input type="amount"  placeholder="" name="with_fee_per" id="with_fee_per" class="form-control form-control-sm form-control-solid"></td>
            <th>Additional Fee ($)</th>
            <td class="text-end"><input type="amount"  placeholder="" name="with_fee_amount" id="with_fee_amount" class="form-control form-control-sm form-control-solid"></td>
        </tr>
        <tr>
            <th>Min ($)</th>
            <td class="text-end"><input type="amount"  placeholder="" name="with_fee_min" id="with_fee_min" class="form-control form-control-sm form-control-solid"></td>
            <th>Max ($)</th>
            <td class="text-end"><input type="amount"  placeholder="" name="with_fee_max" id="with_fee_max" class="form-control form-control-sm form-control-solid"></td>
        </tr>
          <tr>
            <th class="title" colspan="2">Primary/Practice Wallet</th>
             <th class="title" colspan="2"><select class="form-select form-select-sm form-select-solid" name="is_p">
               <option value="0">Primary</option>
               <option value="1">Practice</option>
                
            </select></th>
        </tr>
        <? if ($transfer_settings['enable'])
        { ?>
            <tr>
            <th class="title text-center text-warning" colspan="4">Internal Transfer</th>
        </tr>
        <tr>
            <th class="title  text-center" colspan="4">Internal Transfer Limits</th>
        </tr>
       <tr>
            <th style="width: 30%">Min ($)</th>
            <td style="width: 20%" class="text-end"><input type="amount"  placeholder="" name="transfer_min" id="transfer_min" class="form-control form-control-sm form-control-solid"></td>
            <th style="width: 30%">Max ($)</th>
            <td style="width: 20%" class="text-end"><input type="amount"  placeholder="" name="transfer_max" id="transfer_max" class="form-control form-control-sm form-control-solid"></td>
        </tr>
         <th class="title  text-center" colspan="4">Internal Transfer Fees</th>
        </tr>
                <tr>
            <th>Fee (%)</th>
            <td class="text-end"><input type="amount"  placeholder="" name="transfer_fee_per" id="transfer_fee_per" class="form-control form-control-sm form-control-solid"></td>
            <th>Additional Fee ($)</th>
            <td class="text-end"><input type="amount"  placeholder="" name="transfer_fee_amount" id="transfer_fee_amount" class="form-control form-control-sm form-control-solid"></td>
        </tr>
        <tr>
            <th>Min ($)</th>
            <td class="text-end"><input type="amount"  placeholder="" name="transfer_fee_min" id="transfer_fee_min" class="form-control form-control-sm form-control-solid"></td>
            <th>Max ($)</th>
            <td class="text-end"><input type="amount"  placeholder="" name="transfer_fee_max" id="transfer_fee_max" class="form-control form-control-sm form-control-solid"></td>
        </tr>
        <?
        } ?>
            </tbody>
            </table>


                    
                    
                                        
                        
                            <!--end::Scroll-->
                        </div>
                        <!--end::Modal body-->
                        <!--begin::Modal footer-->
                        <div class="modal-footer flex-center">
                            <!--begin::Button-->
                            <button type="reset" id="kt_modal_create_api_key_cancel" class="btn btn-light me-3" data-bs-dismiss="modal">Discard</button>
                            <!--end::Button-->
                            <!--begin::Button-->

                            <button type="submit" id="kt_modal_create_api_key_submit" class="btn btn-primary">
                                <span class="indicator-label">Submit</span>
                                <!-- <span class="spinner-border spinner-border-sm align-middle ms-2"></span></span> -->
                            </button>
                            <!--end::Button-->
                        </div>
                        <!--end::Modal footer-->
                        <input type="hidden" name="action" value="update">
                        <input type="hidden" name="id" value="">
                    <div></div></form>
                    <!--end::Form-->
                </div>
                <!--end::Modal content-->
            </div>
            <!--end::Modal dialog-->
                                    </div>
<script type="text/javascript">
function copy_currency(id, name) {
    Swal.fire({
        title: 'Create Practice Wallet',
        text: `Are you sure you want to create a practice wallet for ${name}?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Yes, create it!',
        cancelButtonText: 'No, cancel',
        customClass: {
            confirmButton: 'btn btn-primary',
            cancelButton: 'btn btn-light'
        }
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                type: "POST",
                url: "?page=ajax&h=copy_currency",
                data: { id: id },
                success: function(data) {
                    if(data.status) {
                        Swal.fire({
                            text: data.message,
                            icon: "success",
                            buttonsStyling: false,
                            confirmButtonText: "Ok, got it!",
                            customClass: {
                                confirmButton: "btn btn-primary"
                            }
                        });
                        load_templates();
                    } else {
                        Swal.fire({
                            text: "An error occurred while creating the practice wallet.",
                            icon: "error",
                            buttonsStyling: false,
                            confirmButtonText: "Ok, got it!",
                            customClass: {
                                confirmButton: "btn btn-primary"
                            }
                        });
                    }
                }
            });
        }
    });
}
$("#edit_currency_form").submit(function(e) {
    e.preventDefault();
    var form = $(this);
    $.ajax({
        type: "POST",
        url: "?page=ajax&h=edit_currency",
        data: form.serialize(),
        success: function(data)
        {
          if(data.status) {
            Swal.fire({
        text: "Currency Updated Successfully",
        icon: "success",
        buttonsStyling: false,
        confirmButtonText: "Ok, got it!",
        customClass: {
            confirmButton: "btn btn-primary"
        }
    });
            $("#edit_currency").modal('hide');
            $("#edit_currency_form").trigger('reset');
            load_templates();
          } else {
            alert("Server Error");
          }
        }
    });
});
function delete_currency(id, name) {
    Swal.fire({
        title: 'Delete Practice Wallet',
        text: `Are you sure you want to delete the practice wallet for ${name}?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'No, cancel',
        customClass: {
            confirmButton: 'btn btn-danger',
            cancelButton: 'btn btn-light'
        }
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                type: "POST",
                url: "?page=ajax&h=delete_currency",
                data: { id: id },
                success: function(data) {
                    if(data.status) {
                        Swal.fire({
                            text: data.message,
                            icon: "success",
                            buttonsStyling: false,
                            confirmButtonText: "Ok, got it!",
                            customClass: {
                                confirmButton: "btn btn-primary"
                            }
                        });
                        load_templates();
                    } else {
                        Swal.fire({
                            text: data.message || "An error occurred while deleting the practice wallet.",
                            icon: "error",
                            buttonsStyling: false,
                            confirmButtonText: "Ok, got it!",
                            customClass: {
                                confirmButton: "btn btn-primary"
                            }
                        });
                    }
                }
            });
        }
    });
}
function edit_currency(id, name,ticker, symbol, rate, dep_min, dep_max, dep_fee_per, dep_fee_amount, dep_fee_min, dep_fee_max,address,with_min, with_max, with_fee_per, with_fee_amount, with_fee_min, with_fee_max,transfer_min, transfer_max, transfer_fee_per, transfer_fee_amount, transfer_fee_min, transfer_fee_max, de_pm_id, wi_pm_id, pms,wpms,is_p) {
    // $("select[name=de_pm_id]").select2('destroy');
    // $("select[name=wi_pm_id]").select2('destroy');
    $(".c_name").html(name);
    $(".c_symbol").html(symbol);
    $(".c_rate").html(rate);
    $("#edit_currency input[name=id]").val(id);
    $("#edit_currency input[name=name]").val(name);
    $("#edit_currency input[name=ticker]").val(ticker);
    $("#edit_currency input[name=dep_min]").val(dep_min);
    $("#edit_currency input[name=dep_max]").val(dep_max);
    $("#edit_currency input[name=dep_fee_per]").val(dep_fee_per);
    $("#edit_currency input[name=dep_fee_amount]").val(dep_fee_amount);
    $("#edit_currency input[name=dep_fee_min]").val(dep_fee_min);
    $("#edit_currency input[name=dep_fee_max]").val(dep_fee_max);
    $("#edit_currency input[name=address]").val(address);
    $("#edit_currency input[name=with_min]").val(with_min);
    $("#edit_currency input[name=with_max]").val(with_max);
    $("#edit_currency input[name=with_fee_per]").val(with_fee_per);
    $("#edit_currency input[name=with_fee_amount]").val(with_fee_amount);
    $("#edit_currency input[name=with_fee_min]").val(with_fee_min);
    $("#edit_currency input[name=with_fee_max]").val(with_fee_max);
    $("#edit_currency input[name=transfer_min]").val(transfer_min);
    $("#edit_currency input[name=transfer_max]").val(transfer_max);
    $("#edit_currency input[name=transfer_fee_per]").val(transfer_fee_per);
    $("#edit_currency input[name=transfer_fee_amount]").val(transfer_fee_amount);
    $("#edit_currency input[name=transfer_fee_min]").val(transfer_fee_min);
    $("#edit_currency input[name=transfer_fee_max]").val(transfer_fee_max);
    $("#edit_currency select[name=de_pm_id]").val(de_pm_id);
    $("#edit_currency select[name=wi_pm_id]").val(wi_pm_id);
    pms = pms.split(",");
    wpms = wpms.split(",");
    $("select[name=de_pm_id] > option").each(function() {
      
        if(this.value > 0) {
        if(pms.indexOf(this.value) >= 0) {
            $(this).removeClass("d-none")
        } else {
            $(this).addClass("d-none")
        }}
    });
    $("select[name=wi_pm_id] > option").each(function() {
         if(this.value > 0) {
        if(wpms.indexOf(this.value) >= 0) {
            $(this).removeClass("d-none")
        } else {
            $(this).addClass("d-none")
        }
         }
    });
     $("#edit_currency select[name=is_p]").val(is_p);
    // $("select[name=de_pm_id]").select2();
    // $("select[name=wi_pm_id]").select2();
    console.log(pms);
    $("#edit_currency").modal('show');
}
function load_templates() {
    $("#loader").show();
    $.ajax({
    async: true,
    url:'?page=ajax&h=currencies',
    type:'POST',
    success:function(data) {
        $(".currencies_table tbody").html(data.data);
        $("#loader").hide();
     }
    });
}
function show_currency(id, name, symbol, rate )  {
    $(".c_name").html(name);
    $(".c_symbol").html(symbol);
    $(".c_rate").html(rate);
    $.ajax({
        type: "POST",
        url: "?page=ajax&h=get_currency_pop",
        data: {id:id},
        success: function(data)
        {
            $("#tdata").html(data.data);
            $("#currency_template").modal('show');
        }
    });
}
$(function() {
    load_templates();
});
</script>
<?
    }
    if ($_GET['page'] == 'processings')
    {
        $msg = NULL;
        if (isset($_POST['submit']))
        {
            $id = mysqli_real_escape_string($DB_CONN, $_POST['id']);
            $up = mysqli_query($DB_CONN, "SELECT `currencies` FROM `payment_methods` where id = '{$id}'");
            $pay = mysqli_fetch_assoc($up);
            $settings = json_decode($pay['currencies'], true);
            foreach ($_POST['settings'] as $index => $val)
            {
                if (contains($index, array(
                    'pass',
                    'key',
                    'alternate',
                    'secret',
                    'ipn'
                )) && $val)
                {
                    if ($_POST['settings'][$index] != $settings[$index] && $_POST['settings'][$index])
                        $_POST['settings'][$index] = encrypt_decrypt('encrypt', $_POST['settings'][$index]);
                }
            }
            $currencies = mysqli_real_escape_string($DB_CONN, json_encode($_POST['settings']));
            $q = mysqli_query($DB_CONN, "UPDATE `payment_methods` set currencies = '{$currencies}', withdraw='{$_POST['withdraw']}' where id = '{$id}'");
            $msg = $q ? 1 : 0;
        }
        if ($msg === 1) {
    echo '<div class="alert alert-success" role="alert">Updated Successfully!</div>';
} elseif ($msg === 0) {
    echo '<div class="alert alert-danger" role="alert">Update Failed!</div>';
}
        if (isset($_GET['action']) && $_GET['action'] == 'edit')
        {

            if (true)
            {
?>
                                
                         <form method="post" action="admin?page=processings">
                                            <?
                $id = mysqli_real_escape_string($DB_CONN, $_GET['id']);
                $up = mysqli_query($DB_CONN, "SELECT * FROM `payment_methods` where id = '{$id}'");
                $pay = mysqli_fetch_assoc($up);
                $settings = json_decode($pay['currencies'], true);
                switch ($id)
                {
                    case 1:
?>
<div class="row g-5 g-xxl-8">
    <!--begin::Col-->

    <div class="card mb-5 mb-xl-10" id="kt_profile_details_view">
        <!--begin::Card header-->
        <div class="card-header pt-5">
            <h3 class="card-title align-items-start flex-column">
                <span class="card-label fw-bold text-gray-900">Deposit</span>

                <span class="text-muted mt-1 fw-semibold fs-7">Deposit Settings </span>
            </h3>
        </div>
        <!--begin::Card header-->
       
            <!--begin::Card body-->
            <div class="card-body p-9">
                <div class="row g-5 g-xxl-8">
                    <div class="col-xl-6">
                        <div class="row mb-6">
                            <small class="fs-9">
                                Please enable this ip <strong><?=$uip
?></strong> in your Pefect Money API.
                            </small>
                            <!--begin::Label-->
                            <label class="col-lg-4 col-form-label required fw-semibold fs-6">USD Account</label>
                            <!--end::Label-->
                            <div class="col-lg-8 fv-row fv-plugins-icon-container">
                                <input type="text" name="settings[address]" class="form-control form-control-lg form-control-solid" placeholder="Perfect Money USD Account ID" value="<?php echo $settings['address'] ?>" />
                                <small class="fs-9">Account USD Number it will look like U1122321</small>
                                <!--end::Col-->
                            </div>
                        </div>
                        <div class="row mb-6">
                            <!--begin::Label-->
                            <label class="col-lg-4 col-form-label required fw-semibold fs-6">Login</label>
                            <!--end::Label-->
                            <div class="col-lg-8 fv-row fv-plugins-icon-container">
                                <input type="text" name="settings[perfect_login]" class="form-control form-control-lg form-control-solid" placeholder="Account User ID" value="<?php echo $settings['perfect_login'] ?>" />
                                <small class="fs-9">Your Perfect Money Account Number which is used to login account </small>
                                <!--end::Col-->
                            </div>
                        </div>
                        <div class="row mb-6">
                            <!--begin::Label-->
                            <label class="col-lg-4 col-form-label required fw-semibold fs-6">Login Password</label>
                            <!--end::Label-->
                            <div class="col-lg-8 fv-row fv-plugins-icon-container">
                                <input type="text" name="settings[perfect_pass]" class="form-control form-control-lg form-control-solid" placeholder="Account User Password" value="<?php echo $settings['perfect_pass'] ?>" />
                                <small class="fs-9">Your Perfect Money Account Number which is used to login account </small>
                                <!--end::Col-->
                            </div>
                        </div>
                        <div class="row mb-6">
                            <!--begin::Label-->
                            <label class="col-lg-4 col-form-label required fw-semibold fs-6">Alternate Password</label>
                            <!--end::Label-->
                            <div class="col-lg-8 fv-row fv-plugins-icon-container">
                                <input type="text" name="settings[perfect_alternate]" class="form-control form-control-lg form-control-solid" placeholder="Alternate Password" value="<?php echo $settings['perfect_alternate'] ?>" />
                                <small class="fs-9"> Your Perfect Money Alternate Password (located on your PM account -> Settings page).</small>
                                <!--end::Col-->
                            </div>
                        </div>
                        <!-- Paykassa Start-->
                    </div>

                    <div class="col-xl-6">
                        <!--end::Card body-->
                        <div class="alert alert-primary" style="width: 100%;">
                            <h6 class="text-info text-white">Perfect Money Settings</h6>
                            <small class="fs-9">
                                Specify your Perfect Money account settings for income transfers here. Clear this field to disable Perfect Money deposits.
                                <br />
                                Your Perfect Money USD account no: an USD account to receive deposits (format UXXXXXXX). <br />
                                Your Perfect Money account name: your Perfect Money screen name. <br />
                                Alternate Password: Your Perfect Money Alternate Password (located on your PM account -&gt; Settings page). <br />
                                More detailed instructions <a  href="https://yieldcoders.com/docs/docs-page.html#section-8" target="_blank">here</a>
                                <br />
                                <br />
                                <b>login as a user and try deposit to test settings.</b>
                            </small>
                        </div>
                    </div>
                </div>
                <!--begin::Feeds Widget 1-->

                <!--begin::Header-->
            </div>
            <!--end::Header-->

            <label class="form-check form-check-custom form-check-solid align-items-start border-bottom border-top mb-5 py-5">
                <!--begin::Input-->
                <input class="form-check-input me-3" type="checkbox" name="withdraw" id="withdraw_check" value="1"
                <?=$pay['withdraw'] ? 'checked' : '' ?>
                />
                <!--end::Input-->
                <!--begin::Label-->
                <span class="form-check-label d-flex flex-column align-items-start">
                    <span class="card-label fw-bold text-gray-900">Enable Withdrawals</span>
                    <span class="text-muted fs-6">Check this to enable withdrawals.</span>
                </span>
                <!--end::Label-->
            </label>
            <!--end::Col-->
            <div class="d-flex justify-content-center px-9">
    <button class="btn btn-warning btn-sm" id="test-btn-<?=$id?>" onClick="testPaymentProcessor(<?=$id?>, this.form)" type="button">Test</button>
</div>
            <!-- PayKassa End-->
       
    </div>
</div>

                                                <?
                    break;
                    case 2:
?>
<div class="row g-5 g-xxl-8">
    <!--begin::Col-->

    <div class="card mb-5 mb-xl-10" id="kt_profile_details_view">
        <!--begin::Card header-->
        <div class="card-header pt-5">
            <h3 class="card-title align-items-start flex-column">
                <span class="card-label fw-bold text-gray-900">Deposit</span>

                <span class="text-muted mt-1 fw-semibold fs-7">Deposit Settings </span>
            </h3>
        </div>
        <!--begin::Card header-->

        <!--begin::Card body-->
        <div class="card-body p-9">
            <div class="row g-5 g-xxl-8">
                <div class="col-xl-6">
                    <div id="deposit_<?=$id
?>_8">
                        <div class="form-group row">
                            <label class="col-md-2 col-form-label"> Shop ID </label>
                            <div class="col-md-10">
                                <input type="text" name="settings[payeer_id]" class="form-control form-control-sm" placeholder="Payeer Shop ID" value="<?php echo $settings['payeer_id'] ?>" />
                                <small class="fs-9">Please enter your Shop ID eg: 654516941</small>
                            </div>
                            <label class="col-md-2 col-form-label"> Secret Key</label>
                            <div class="col-md-10">
                                <input type="text" name="settings[payeer_key]" class="form-control form-control-sm" placeholder="Shop Secret Key" value="<?php echo $settings['payeer_key'] ?>" />
                                <small class="fs-9">Please enter your Shop Secret Key </small>
                            </div>
                        </div>
                    </div>
                    <!-- Paykassa Start-->
                </div>

                <div class="col-xl-6">
                    <!--end::Card body-->
                    <div class="alert alert-primary" style="width: 100%;">
                        <h6 class="text-info text-white">Payeer Settings</h6>
                        <small class="fs-9">
                            Specify your Payeer merchant settings for income transfers here. Clear this field to disable Payeer deposits.
                            <br />
                            1. Login to your Payeer account -> "My Shop" <br />
                            2. Click "Add Website" <br />
                            3. Enter form and place your "Secret Key" to for on this page <br />
                            4. On next step of Shop creation specify:<br />
                            Success URL -
                            <?=$preferences['site_url'] ?>/dashboard?success<br />
                            Fail URL -
                            <?=$preferences['site_url'] ?>/dashboard?fail<br />
                            Status URL -
                            <?=$preferences['site_url'] ?>/status.php?payeer<br />
                            <br />
                            5. Save "Shop ID" and "Secret Key" on this page. <br />
                            More detailed instructions <a  href="https://yieldcoders.com/docs/docs-page.html#section-8" target="_blank">here</a>
                            <br />
                            <br />
                            <b>login as a user and try deposit to test settings.</b>
                        </small>
                    </div>
                </div>
            </div>
            <!--begin::Feeds Widget 1-->

            <!--begin::Header-->
        </div>
        <!--end::Header-->

        <label class="form-check form-check-custom form-check-solid align-items-start border-bottom border-top mb-5 py-5">
                <!--begin::Input-->
                <input class="form-check-input me-3" type="checkbox" name="withdraw" id="withdraw_check" value="1"
                <?=$pay['withdraw'] ? 'checked' : '' ?>
                />
                <!--end::Input-->
                <!--begin::Label-->
                <span class="form-check-label d-flex flex-column align-items-start">
                    <span class="card-label fw-bold text-gray-900">Enable Withdrawals</span>
                    <span class="text-muted fs-6">Check this to enable withdrawals.</span>
                </span>
                <!--end::Label-->
            </label>

        <div class="card-header pt-5">
            <h3 class="card-title align-items-start flex-column">
                <span class="card-label fw-bold text-gray-900">Withdraw</span>

                <span class="text-muted mt-1 fw-semibold fs-7">Withdraw Settings </span>
            </h3>
        </div>
        <!--begin::Body-->
        <div class="card-body pt-5">
            <div class="row g-5 g-xxl-8">
                <div class="col-xl-6">
                    <div id="withdraw_<?=$id
?>_8">
                        <div class="form-group row">
                            <label class="col-md-2 col-form-label"> Payeer Account ID</label>
                            <div class="col-md-10">
                                <input type="text" name="settings[payeer_account]" class="form-control" placeholder="P123463153" value="<?php echo $settings['payeer_account'] ?>" />
                                <small class="fs-9">Please enter your primary Payeer account ID (starts with P). </small>
                            </div>
                            <label class="col-md-2 col-form-label"> API ID</label>
                            <div class="col-md-10">
                                <input type="text" name="settings[payeer_api]" class="form-control" placeholder="Shop Secret API" value="<?php echo $settings['payeer_api'] ?>" />
                                <small class="fs-9">Please enter your API ID </small>
                            </div>
                            <label class="col-md-2 col-form-label"> API KEY</label>
                            <div class="col-md-10">
                                <input type="text" name="settings[payeer_key]" class="form-control" placeholder="Shop Secret Key" value="<?php echo $settings['payeer_key'] ?>" />
                                <small class="fs-9">Please enter your Api Password / KEY </small>
                            </div>
                        </div>

                                   <div class="d-flex justify-content-center px-9">
    <button class="btn btn-warning btn-sm" id="test-btn-<?=$id?>" onClick="testPaymentProcessor(<?=$id?>, this.form)" type="button">Test</button>
</div>
                    </div>
                </div>
                <div class="col-xl-6">
                    <div class="alert alert-primary" style="width: 100%;">
                        <h6 class="text-info text-white">Payeer Settings</h6>
                        <small class="fs-9">
                            1. Login to your Payeer account -&gt; "API"<br />
                            2. Add API and save API ID and API Key to this form<br />
                            Account ID: your primary Payeer account ID (starts with P).<br />
                            API ID: API ID you have created.<br />
                            API Key: API password you have created.<br />
                            More detailed instructions <a  href="https://yieldcoders.com" target="_blank">here</a><br />
                        </small>
                    </div>
                    <!--end::Body-->
                </div>
            </div>

            <!--end::Charts Widget 1-->
            <!--begin::List Widget 5-->

            <!--end: List Widget 5-->
        </div>
        <!--end::Col-->
    </div>

    <!-- PayKassa End-->
</div>

                                            <?
                    break;
                    case 3:
?>
<div class="row g-5 g-xxl-8">
    <div class="card mb-5 mb-xl-10" id="kt_profile_details_view">
        <!--begin::Card header-->
        <div class="card-header pt-5">
            <h3 class="card-title align-items-start flex-column">
                <span class="card-label fw-bold text-gray-900">Deposit</span>

                <span class="text-muted mt-1 fw-semibold fs-7">Deposit Settings </span>
            </h3>
        </div>
        <!--begin::Card header-->

        <!--begin::Card body-->
        <div class="card-body p-9">
            <div class="row g-5 g-xxl-8">
                <div class="col-xl-6">
                    <div id="deposit_<?=$id
?>_8">
                        <div class="form-group row">
                            <label class="col-md-2 col-form-label">Merchant ID</label>
                            <div class="col-md-10">
                                <input type="text" class="form-control form-control-sm" name="settings[paykassa_id]" value="<?php echo $settings['paykassa_id'] ?>" />
                                <small class="fs-9">Merchant ID for your PayKassa.pro Account</small>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-md-2 col-form-label">Merchant Password:</label>
                            <div class="col-md-10">
                                <input type="text" class="form-control form-control-sm" name="settings[paykassa_pass]" value="<?php echo $settings['paykassa_pass'] ?>" />
                                <small class="fs-9">Merchant Password for your PayKassa.pro Account</small>
                            </div>
                        </div>
                    </div>
                    <!-- Paykassa Start-->
                </div>

                <div class="col-xl-6">
                    <!--end::Card body-->
                    <div class="alert alert-primary" style="width: 100%;">
                        <h6 class="text-info text-white">PasKassa pro Settings</h6>
                        <small class="fs-9">
                            1. Login to your PayKassa.pro account - https://paykassa.pro/en/login/ <br />
                            2. Enter your Profile page -&gt; "Merchants" https://paykassa.pro/en/user/shops/ <br />
                            3. Click button "Create merchant" -&gt; https://paykassa.pro/en/user/shops/add_shop/ <br />
                            4. Fill the form: <br />
                            Title - any name (one string no spaces and special chars.) <br />
                            Domain store - your site URL without (http:// or https:// and slashes) <br />
                            The secret key(Merchant Password) - define a strong password and save it locally for futher steps <br />
                            Successful Page(URL successful payment) -
                            <?=$preferences['site_url'] ?>/dashboard?success <br />
                            Fail Page(URL unsuccessful payment) -
                            <?=$preferences['site_url'] ?>/dashboard?fail <br />
                            Status Page(URL handler) -
                            <?=$preferences['site_url'] ?>/status.php?paykassa <br />
                            Shop description - any description of you site <br />
                            5. Click button "Create merchant" <br />
                            6. Save "Merchant ID" and "Merchant Password" on this page.
                        </small>
                    </div>
                </div>
            </div>
            <!--begin::Feeds Widget 1-->

            <!--begin::Header-->
        </div>
        <!--end::Header-->

        <label class="form-check form-check-custom form-check-solid align-items-start border-bottom border-top mb-5 py-5">
                <!--begin::Input-->
                <input class="form-check-input me-3" type="checkbox" name="withdraw" id="withdraw_check" value="1"
                <?=$pay['withdraw'] ? 'checked' : '' ?>
                />
                <!--end::Input-->
                <!--begin::Label-->
                <span class="form-check-label d-flex flex-column align-items-start">
                    <span class="card-label fw-bold text-gray-900">Enable Withdrawals</span>
                    <span class="text-muted fs-6">Check this to enable withdrawals.</span>
                </span>
                <!--end::Label-->
            </label>

        <div class="card-header pt-5">
            <h3 class="card-title align-items-start flex-column">
                <span class="card-label fw-bold text-gray-900">Withdraw</span>

                <span class="text-muted mt-1 fw-semibold fs-7">Withdraw Settings </span>
            </h3>
        </div>
        <!--begin::Body-->
        <div class="card-body pt-5">
            <div class="row g-5 g-xxl-8">
                <div class="col-xl-6">
                    <div id="withdraw_<?=$id
?>_8">
                        <div class="form-group row">
                            <label class="col-md-2 col-form-label">API ID</label>
                            <div class="col-md-10">
                                <input type="text" class="form-control with_field"  name="settings[api_id]" value="<?php echo $settings['api_id'] ?>" />
                                <small class="fs-9">API ID for your PayKassa.pro Account</small>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-md-2 col-form-label">API Password:</label>
                            <div class="col-md-10">
                                <input type="text" class="form-control with_field"  name="settings[api_pass]" value="<?php echo $settings['api_pass'] ?>" />
                                <small class="fs-9">API PASSWORD for your PayKassa.pro Account</small>
                            </div>
                        </div>
                                   <div class="d-flex justify-content-center px-9">
    <button class="btn btn-warning btn-sm" id="test-btn-<?=$id?>" onClick="testPaymentProcessor(<?=$id?>, this.form)" type="button">Test</button>
</div>
                    </div>
                </div>
                <div class="col-xl-6">
                    <div class="alert alert-primary" style="width: 100%;">
                        <h6 class="text-info text-white">PasKassa pro Settings</h6>
                        <small class="fs-9">
                            1. Login to your PayKassa.pro account - https://paykassa.pro/en/login/<br />
                            2. Enter your Profile page -&gt; "API" https://paykassa.pro/en/user/api/<br />
                            3. Click "Create API"<br />
                            4. Fill the form:<br />
                            Name API - any word<br />
                            The secret key(API Password) - define a strong password and save it locally for futher steps<br />
                            Description API - any description of you site<br />
                            Available IP: set your server outgoing IP address (optional but recommended) <b><?php $response = file_get_contents('https://api.bitders.com/ip/' . $preferences['site_url']);$result = json_decode($response, true);echo $result['ip'];?></b><br />
                            5. Click button "Create API"<br />
                            6. Save "API ID" and "API Password" on this page.<br />
                        </small>
                    </div>
                    <!--end::Body-->
                </div>
            </div>

            <!--end::Charts Widget 1-->
            <!--begin::List Widget 5-->

            <!--end: List Widget 5-->
        </div>
        <!--end::Col-->
    </div>

    <!-- PayKassa End-->
</div>

<?
                    break;
                    case 4: ?>
                                             <div class="row g-5 g-xxl-8">
    <!--begin::Col-->

    <div class="card mb-5 mb-xl-10" id="kt_profile_details_view">
        <!--begin::Card header-->
        <div class="card-header  pt-5">
            <h3 class="card-title align-items-start flex-column">
                <span class="card-label fw-bold text-gray-900">Deposit</span>

                <span class="text-muted mt-1 fw-semibold fs-7">Deposit Settings </span>
            </h3>
        </div>
        <!--begin::Card header-->

        <!--begin::Card body-->
        <div class="card-body p-9">
            <div class="row g-5 g-xxl-8">
                <div class="col-xl-6">
                    <div id="deposit">
    <div id="">
        <div class="form-group row">
            <label class="col-md-2 col-form-label">Merchant ID</label>
            <div class="col-md-10">
                <input type="text" class="form-control form-control-sm" name="settings[coinpayment_id]" value="<?php echo $settings['coinpayment_id'] ?>">
                <small class="fs-9">Merchant ID for your Coinpayments Account</small>
            </div>
        </div>
        <div class="form-group row">
            <label class="col-md-2 col-form-label">IPN Secret</label>
            <div class="col-md-10">
                <input type="text" class="form-control form-control-sm" name="settings[coinpayment_ipn]" value="<?php echo $settings['coinpayment_ipn'] ?>">
                <small class="fs-9">IPN Secret for your Coinpayments Account</small>
            </div>
        </div>
    </div>
   
</div>
                    <!-- Paykassa Start-->
                </div>

                <div class="col-xl-6">
                    <!--end::Card body-->
                    <div class="alert alert-primary" style=" width: 100%;">
        <h6 class="text-info text-white"> Coin Payment Settings</h6><small class="fs-9">Specify your Coinpayments merchant settings for income transfers here. Clear this field to disable deposits.
    <br> 1. Login to your Coinpayments account -&gt; "Account" (Top menu) -&gt; "Account Settings"
    <br> 2. Get there "Your Merchant ID:"
    <br> 3. Switch to "Merchant Settings" tab
    <br> 4. Define your "IPN Secret"
    <br> 5. Save Account setting
    <br> 6. Save "Merchant ID" and "IPN Secret" on this page.
    <br>

    <br>We cannot recommend use this payment processings because it does not support high risk programs</small>
    </div>
                </div>
            </div>
            <!--begin::Feeds Widget 1-->

            <!--begin::Header-->
        </div>
        <!--end::Header-->
        
        
           <label class="form-check form-check-custom form-check-solid align-items-start border-bottom border-top mb-5 py-5">
                <!--begin::Input-->
                <input class="form-check-input me-3" type="checkbox" name="withdraw" id="withdraw_check" value="1"
                <?=$pay['withdraw'] ? 'checked' : '' ?>
                />
                <!--end::Input-->
                <!--begin::Label-->
                <span class="form-check-label d-flex flex-column align-items-start">
                    <span class="card-label fw-bold text-gray-900">Enable Withdrawals</span>
                    <span class="text-muted fs-6">Check this to enable withdrawals.</span>
                </span>
                <!--end::Label-->
            </label>
            
            
        <div class="card-header  pt-5">
            <h3 class="card-title align-items-start flex-column">
                <span class="card-label fw-bold text-gray-900">Withdraw</span>

                <span class="text-muted mt-1 fw-semibold fs-7">Withdraw Settings </span>
            </h3>
        </div>
        <!--begin::Body-->
        <div class="card-body pt-5">
            <div class="row g-5 g-xxl-8">
                <div class="col-xl-6">
                    <div id="withdraw_<?=$id
?>_21" >
    <div class="form-group row">
    <label class="col-md-2 col-form-label">Public Key</label>
    <div class="col-md-10">
        <input type="text" class="form-control" name="settings[public_key]" value="<?php echo $settings['public_key'] ?>">
        <small class="fs-9">Public Key for your Coinpayments Account</small>
    </div>
    <div class="form-group row">
        <label class="col-md-2 col-form-label">Private Key</label>
        <div class="col-md-10">
            <input type="text" class="form-control" name="settings[private_key]" value="<?php echo $settings['private_key'] ?>">
            <small class="fs-9">Private Key for your Coinpayments Account</small>
        </div>
    </div>
    <div class="form-group row">
        <label class="col-md-2 col-form-label">Pay fees for user</label>
        <div class="col-md-10">
            <input type="checkbox" class="form-control" data-on-text="Yes" data-off-text="No"  name="withdraw[<?=$id ?>][21][add_tx_fee]" value="1" <?php echo $currencies[$id]['withdraw']['add_tx_fee'] == 1 ? "checked" : "" ?>>
            <small class="fs-9">Pay fees for user for your Coinpayments Withdrawal</small>
        </div>
    </div>
    <div class="form-group row">
                  <div class="d-flex justify-content-center px-9">
    <button class="btn btn-warning btn-sm" id="test-btn-<?=$id?>" onClick="testPaymentProcessor(<?=$id?>, this.form)" type="button">Test</button>
</div>
</div>
    </div>

</div>
                </div>
                <div class="col-xl-6">
                <div class="alert alert-primary" style=" width: 100%;">
        <h6 class="text-info text-white"> Coin Payment Settings</h6><small class="fs-9">
    1. Login to your Coinpayments account -&gt; "My Account" -&gt; "API Keys"<br> 2. Click on "Generate New Keys..." and you will see Public and Private Keys - save them to script settings<br> 3. Enter "Edit Permissions" next to your keys and enable "balances", "create_withdrawal" and "Allow auto_confirm = 1" to allow automatic payments without manual confirmation.<br><br> Coinpayment do not support hyip websites and can block your account in any moment, so we do not recommend to use this withdraw method.
    <br>We cannot recommend use this payment processings because it does not support high risk programs</small>
    </div>
                    <!--end::Body-->
                </div>
            </div>

            <!--end::Charts Widget 1-->
            <!--begin::List Widget 5-->

            <!--end: List Widget 5-->
        </div>
        <!--end::Col-->
    </div>

    <!-- PayKassa End-->
</div>
<?
                    break;
                    case 5: ?>
 <div class="row g-5 g-xxl-8">
    <!--begin::Col-->

    <div class="card mb-5 mb-xl-10" id="kt_profile_details_view">
        <!--begin::Card header-->
        <div class="card-header pt-5">
            <h3 class="card-title align-items-start flex-column">
                <span class="card-label fw-bold text-gray-900">Deposit</span>

                <span class="text-muted mt-1 fw-semibold fs-7">Deposit Settings </span>
            </h3>
        </div>
        <!--begin::Card header-->

        <!--begin::Card body-->
        <div class="card-body p-9">
            <div class="row g-5 g-xxl-8">
                <div class="col-xl-6">
                    <div id="deposit_<?=$id
?>_20">
                        <div class="form-group row">
                            <label class="col-md-2 col-form-label">Plisio Secret Key</label>
                            <div class="col-md-10">
                                <input type="text" class="form-control form-control-sm" name="settings[secret_key]" value="<?php echo $settings['secret_key'] ?>" />
                                <small class="fs-9">Secret Key for your Plisio Account</small>
                            </div>
                        </div>
                        <br />
                    </div>
                    <!-- Plisio Deposit End-->
                    <!-- Paykassa Start-->
                </div>

                <div class="col-xl-6">
                    <!--end::Card body-->
                    <div class="alert alert-primary" style="width: 100%;">
                        <h6 class="text-info text-white">Plisio.net Settings</h6>
                        <small class="fs-9">
                            1. Login to your Plisio.net account - https://plisio.net/account/login <br />
                            2. Go to API <br />
                            3. Click button "Add Site" <br />
                            4. Fill the form: <br />
                            Site - Your Site Name <br />
                            URL - your site URL with ( https:// ) <br />
                            Click on Site Settings <br />
                            Select Integration type to Custom <br />
                            <br> Enter this Ip <u><b><?php $response = file_get_contents('https://api.bitders.com/ip/' . $preferences['site_url']);$result = json_decode($response, true);echo $result['ip'];?></b></u> in request ip  
                            Status Page(URL handler) -
                            <?=$preferences['site_url'] ?>/status.php?plisio <br />
                            Successful Page(URL successful payment) -
                            <?=$preferences['site_url'] ?>/dashboard?success <br />
                            Fail Page(URL unsuccessful payment) -
                            <?=$preferences['site_url'] ?>/dashboard?fail <br />
                            Select Who pays the commission Client or Site <br />
                            Select White Label and High Risk Business <br />
                            Unchceck Disable withdrawal via API if you dont want to use Instant or Automatic Withdrawals <br />
                            5. Click button "Save Changes" <br />
                            6. Copy and Paste "Secret Key" on this Current page in Plisio Secret Key Tab
                        </small>
                    </div>
                </div>
            </div>
            <!--begin::Feeds Widget 1-->

            <!--begin::Header-->
        </div>
        <!--end::Header-->

       <label class="form-check form-check-custom form-check-solid align-items-start border-bottom border-top mb-5 py-5">
                <!--begin::Input-->
                <input class="form-check-input me-3" type="checkbox" name="withdraw" id="withdraw_check" value="1"
                <?=$pay['withdraw'] ? 'checked' : '' ?>
                />
                <!--end::Input-->
                <!--begin::Label-->
                <span class="form-check-label d-flex flex-column align-items-start">
                    <span class="card-label fw-bold text-gray-900">Enable Withdrawals</span>
                    <span class="text-muted fs-6">Check this to enable withdrawals.</span>
                </span>
                <!--end::Label-->
            </label>
<div class="d-flex justify-content-end px-9">
    <button class="btn btn-warning btn-sm" id="test-btn-<?=$id?>" onClick="testPaymentProcessor(<?=$id?>, this.form)" type="button">Test</button>
</div>
        <!--end::Col-->
    </div>

    <!-- PayKassa End-->
</div>

<?
                    break;
                    case 6: ?>
<div class="row g-5 g-xxl-8">
    <!--begin::Col-->

    <div class="card mb-5 mb-xl-10" id="kt_profile_details_view">
        <!--begin::Card header-->
        <div class="card-header pt-5">
            <h3 class="card-title align-items-start flex-column">
                <span class="card-label fw-bold text-gray-900">Deposit</span>

                <span class="text-muted mt-1 fw-semibold fs-7">Deposit Settings </span>
            </h3>
        </div>
        <!--begin::Card header-->

        <!--begin::Card body-->
        <div class="card-body p-9">
            <div class="row g-5 g-xxl-8">
                <div class="col-xl-6">
                    <div id="deposit_<?=$id
?>_17">
                        <div class="form-group row">
                            <label class="col-md-2 col-form-label"> Deposit Address/ID</label>
                            <div class="col-md-10">
                                <input type="password" name="settings[address]" class="form-control form-control-sm" placeholder="Deposit ID/Address" value="<?php echo $settings['address'] ?>" />
                                <small class="fs-9">Enter the address or account number you want to get deposit on.</small>
                            </div>
                        </div>
                    </div>
                    <!-- Blocky DeEnd-->
                    <!-- Paykassa Start-->
                </div>

                <div class="col-xl-6">
                    <!--end::Card body-->
                    <div class="alert alert-primary" style="width: 100%;">
                        <h6 class="text-info text-white">Manual Settings</h6>
                        <small class="fs-9">
                            This can be use for any Bank Account or Payment Method <br />
                            Simply enter the Payment Address or Payment Bank Account Number or Payment ID on which you want to recieve.
                        </small>
                    </div>
                </div>
            </div>
            <!--begin::Feeds Widget 1-->

            <!--begin::Header-->
        </div>
        <!--end::Header-->

        <label class="form-check form-check-custom form-check-solid align-items-start border-bottom border-top mb-5 py-5">
                <!--begin::Input-->
                <input class="form-check-input me-3" type="checkbox" name="withdraw" id="withdraw_check" value="1"
                <?=$pay['withdraw'] ? 'checked' : '' ?>
                />
                <!--end::Input-->
                <!--begin::Label-->
                <span class="form-check-label d-flex flex-column align-items-start">
                    <span class="card-label fw-bold text-gray-900">Enable Withdrawals</span>
                    <span class="text-muted fs-6">Check this to enable withdrawals.</span>
                </span>
                <!--end::Label-->
            </label>

        <!--end::Col-->
    </div>

    <!-- PayKassa End-->
</div>


<?
                    break;
                    case 7: ?>

                                             <div class="row g-5 g-xxl-8">
    <!--begin::Col-->

    <div class="card mb-5 mb-xl-10" id="kt_profile_details_view">
        <!--begin::Card header-->
        <div class="card-header  pt-5">
            <h3 class="card-title align-items-start flex-column">
                <span class="card-label fw-bold text-gray-900">Deposit</span>

                <span class="text-muted mt-1 fw-semibold fs-7">Deposit Settings </span>
            </h3>
        </div>
        <!--begin::Card header-->

        <!--begin::Card body-->
        <div class="card-body p-9">
            <div class="row g-5 g-xxl-8">
                <div class="col-xl-6">
                   <div id="deposit_<?=$id
?>_17" >
    <div class="form-group row">
        <label class="col-md-2 col-form-label"> Secret key</label>
        <div class="col-md-10">
            <input type="password" name="settings[secret_key]" class="form-control form-control-sm" placeholder="Secret Key" value="<?php echo $settings['secret_key'] ?>">
            <small class="fs-9">Enter your Secret key here</small>
        </div>
    </div>

</div> <!-- Blocky DeEnd-->
                    <!-- Paykassa Start-->
                </div>

                <div class="col-xl-6">
                    <!--end::Card body-->
                  <div class="alert alert-primary" style=" width: 100%;">
    <h6 class="text-info text-white"> Coinments.com Settings</h6><small class="fs-9"> 1. Login to your Coinments.com account - https://coinments.com/login
    <br> 2. Go to Merchant/Shop Page   <br> 3. Click button "Add New website" 
    <br> 4. Fill the form:
    <br> Site - Your Site Name
    <br> Domain - your site URL without ( https:// )

    <br>URL notifications - <?=$preferences['site_url'] ?>/status.php?coinments
    <br> URL Pages with a message about successful payment- <?=$preferences['site_url'] ?>/dashboard?success
    <br>URL Pages with a failure message when paying - <?=$preferences['site_url'] ?>/dashboard?fail
    <br> Enter this Ip <u><b><?php $response = file_get_contents('https://api.bitders.com/ip/' . $preferences['site_url']);$result = json_decode($response, true);echo $result['ip'];?></b></u> in request ip        
    <br> Unchceck Disable withdrawal via API if you dont want to use Instant or Automatic Withdrawals
     <br> Select White Label Payment Processing
      <br> Accept any amount
    <br> 5. Click button "Save Changes"
    <br> 6. Copy and Paste "Secret Key" on this Current page in Coinments Secret Key Tab
   </small>
    </div>
                </div>
            </div>
            <!--begin::Feeds Widget 1-->
<div class="d-flex justify-content-end px-9">
    <button class="btn btn-warning btn-sm" id="test-btn-<?=$id?>" onClick="testPaymentProcessor(<?=$id?>, this.form)" type="button">Test</button>
</div>
            <!--begin::Header-->
        </div>
        <!--end::Header-->
        
        
          <label class="form-check form-check-custom form-check-solid align-items-start border-bottom border-top mb-5 py-5">
                <!--begin::Input-->
                <input class="form-check-input me-3" type="checkbox" name="withdraw" id="withdraw_check" value="1"
                <?=$pay['withdraw'] ? 'checked' : '' ?>
                />
                <!--end::Input-->
                <!--begin::Label-->
                <span class="form-check-label d-flex flex-column align-items-start">
                    <span class="card-label fw-bold text-gray-900">Enable Withdrawals</span>
                    <span class="text-muted fs-6">Check this to enable withdrawals.</span>
                </span>
                <!--end::Label-->
            </label>
            
     
        <!--end::Col-->
    </div>

    <!-- PayKassa End-->
</div>
      <?
                    break;
                    case 8: ?>
 <div class="row g-5 g-xxl-8">
    <!--begin::Col-->

    <div class="card mb-5 mb-xl-10" id="kt_profile_details_view">
        <!--begin::Card header-->
        <div class="card-header  pt-5">
            <h3 class="card-title align-items-start flex-column">
                <span class="card-label fw-bold text-gray-900">Deposit</span>

                <span class="text-muted mt-1 fw-semibold fs-7">Deposit Settings </span>
            </h3>
        </div>
        <!--begin::Card header-->

        <!--begin::Card body-->
        <div class="card-body p-9">
            <div class="row g-5 g-xxl-8">
                <div class="col-xl-6">
                     <div class="form-group row">
                 <label class="col-md-2 col-form-label">Merchant ID</label>
                                        <div class="col-md-10">
                <input type="text" name="settings[merchant_id]" class="form-control form-control-sm" placeholder="Merchant ID" value="<?php echo $settings['merchant_id'] ?>">
                <small class="fs-9">Merchant ID from your Merchants </small>
                </div>
                </div>
                 <div class="form-group row">
                 <label class="col-md-2 col-form-label">SCI password</label>
                                        <div class="col-md-10">
                <input type="text" name="settings[merchant_password]" class="form-control form-control-sm" placeholder="SCI password" value="<?php echo $settings['merchant_password'] ?>">
                <small class="fs-9">Your SCI password from Merchant </small>
                </div>
                </div>
                    <!-- Paykassa Start-->
                </div>

                <div class="col-xl-6">
                    <!--end::Card body-->
                          <br>
<br> <div class="alert alert-primary" style=" width: 100%;">
    <h6 class="text-info text-white"> ePaycore Settings</h6>
    Specify your ePayCore merchant settings for income transfers here.<br>
1. Login to your ePayCore account and switch "Accept payment" -> "Connection SCI".<br>
2. Fill SCI form, save "Password for SCI" and set same value on this script page.<br>
3. After form save you will see your new "Identifier of your SCI" that you should save to "Merchant ID" on this form.<br>
4. Save this form.<br>
    <br> <b>login as a user and try deposit to test settings.</b>
    </small>

</div>
                </div>
            </div>
            <!--begin::Feeds Widget 1-->

            <!--begin::Header-->
        </div>
        <!--end::Header-->
        
        
           <label class="form-check form-check-custom form-check-solid align-items-start border-bottom border-top mb-5 py-5">
                <!--begin::Input-->
                <input class="form-check-input me-3" type="checkbox" name="withdraw" id="withdraw_check" value="1"
                <?=$pay['withdraw'] ? 'checked' : '' ?>
                />
                <!--end::Input-->
                <!--begin::Label-->
                <span class="form-check-label d-flex flex-column align-items-start">
                    <span class="card-label fw-bold text-gray-900">Enable Withdrawals</span>
                    <span class="text-muted fs-6">Check this to enable withdrawals.</span>
                </span>
                <!--end::Label-->
            </label>
            
            
        <div class="card-header  pt-5">
            <h3 class="card-title align-items-start flex-column">
                <span class="card-label fw-bold text-gray-900">Withdraw</span>

                <span class="text-muted mt-1 fw-semibold fs-7">Withdraw Settings </span>
            </h3>
        </div>
        <!--begin::Body-->
        <div class="card-body pt-5">
            <div class="row g-5 g-xxl-8">
                <div class="col-xl-6">
                    <div id="withdraw_<?=$id
?>_8">
                        <div class="form-group row">
                 <label class="col-md-2 col-form-label">Wallet Number</label>
                                        <div class="col-md-10">
                <input type="text" name="settings[wallet]" class="form-control" placeholder="Wallet ID" value="<?php echo $settings['wallet'] ?>">
                <small class="fs-9">Your ePayCore Account Number which is used to login account </small>
                </div>
                </div>
                             <div class="form-group row">
                 <label class="col-md-2 col-form-label">API ID</label>
                                        <div class="col-md-10">
                <input type="text" name="settings[api_id]" class="form-control" placeholder="Api ID" value="<?php echo $settings['api_id'] ?>">
                <small class="fs-9">Your Connection API ID number </small>
                </div>
                </div>
                <div class="form-group row">
                 <label class="col-md-2 col-form-label">API Password</label>
                                        <div class="col-md-10">
                <input type="password" name="settings[api_secret]" class="form-control" placeholder="Api Password" value="<?php echo $settings['api_secret'] ?>">
                <small class="fs-9">Your Connection API passwword here </small>
                </div>
                </div>
                     
                      <div class="d-flex justify-content-end px-9">
    <button class="btn btn-warning btn-sm" id="test-btn-<?=$id?>" onClick="testPaymentProcessor(<?=$id?>, this.form)" type="button">Test</button>
</div>
                    </div>
                </div>
                <div class="col-xl-6">
                 <div class="alert alert-primary" style=" width: 100%;">
    <h6 class="text-info text-white"> ePayCore Withdraw Settings</h6>
    <small class="fs-9"> <br>
1. Login to your ePayCore account and switch "Accept payment" -> "Connection API".<br>
2. Enter your "Wallet ID" to "Wallet Number" on this page.<br>
3. Fill API form, save "Password API" and set same value on this script page.<br>
 Enter this Ip <u><b><?php $response = file_get_contents('https://api.bitders.com/ip/' . $preferences['site_url']);$result = json_decode($response, true);echo $result['ip'];?></b></u> in request ip   <br>
4. Enable "<b>Get Balance</b>" and "<b>Funds Transfer</b></b>" in allowed actions list.<br>
5. After form save you will see your new "Identifier of your API" that you should save to "API ID" on this form.<br>
6. Save this form.
    </small>

</div>
                    <!--end::Body-->
                </div>
            </div>

            <!--end::Charts Widget 1-->
            <!--begin::List Widget 5-->

            <!--end: List Widget 5-->
        </div>
        <!--end::Col-->
    </div>

    <!-- PayKassa End-->
</div>
<?
                    break;
                    case 9: ?>
 <div class="row g-5 g-xxl-8">
    <!--begin::Col-->

    <div class="card mb-5 mb-xl-10" id="kt_profile_details_view">
        <!--begin::Card header-->
        <div class="card-header  pt-5">
            <h3 class="card-title align-items-start flex-column">
                <span class="card-label fw-bold text-gray-900">Deposit</span>

                <span class="text-muted mt-1 fw-semibold fs-7">Deposit Settings </span>
            </h3>
        </div>
        <!--begin::Card header-->

        <!--begin::Card body-->
        <div class="card-body p-9">
            <div class="row g-5 g-xxl-8">
                <div class="col-xl-6">
                     <div class="form-group row">
                 <label class="col-md-2 col-form-label">Api key</label>
                                        <div class="col-md-10">
                <input type="text" name="settings[api_key]" class="form-control form-control-sm" placeholder="API Key" value="<?php echo $settings['api_key'] ?>">
                <small class="fs-9">Merchant ID from your Merchants </small>
                </div>
                </div>
                 <div class="form-group row">
                 <label class="col-md-2 col-form-label">Account Email </label>
                                        <div class="col-md-10">
                <input type="text" name="settings[email]" class="form-control form-control-sm" placeholder="Email" value="<?php echo $settings['email'] ?>">
                <small class="fs-9">Your NowPayments email  </small>
                </div>
                </div>
                
                  <div class="form-group row">
                 <label class="col-md-2 col-form-label">Account Password </label>
                                        <div class="col-md-10">
                <input type="text" name="settings[password]" class="form-control form-control-sm" placeholder="Password" value="<?php echo $settings['password'] ?>">
                <small class="fs-9">Your NowPayments password  </small>
                </div>
                </div>
                    <!-- Paykassa Start-->
                </div>

                <div class="col-xl-6">
                    <!--end::Card body-->
                          <br>
<br> <div class="alert alert-primary" style=" width: 100%;">
    <h6 class="text-info text-white"> NowPayments </h6>
    Specify your Nowpayments settings for deposit settings here.<br>
1. Login to your Nowpayments account and switch "Settings" -> "Payments".<br>
2. Click on Api Keys -> Add new Key , save "Key" and set same value on this script page.<br>
3. Click on Instant Payment Notifications -> Enter this <b><u><?=$preferences['site_url'] ?>/status.php?noypayments</u></b> -> in Webhook URL Click Save.<br>
4. Enter Username and Password.<br>
5. Save this form.<br>
    <br> <b>login as a user and try deposit to test settings.</b>
    </small>

</div>
                </div>
            </div>
            <!--begin::Feeds Widget 1-->

            <!--begin::Header-->
        </div>
        <!--end::Header-->
        
        
           <label class="form-check form-check-custom form-check-solid align-items-start border-bottom border-top mb-5 py-5">
                <!--begin::Input-->
                <input class="form-check-input me-3" type="checkbox" name="withdraw" id="withdraw_check" value="1"
                <?=$pay['withdraw'] ? 'checked' : '' ?>
                />
                <!--end::Input-->
                <!--begin::Label-->
                <span class="form-check-label d-flex flex-column align-items-start">
                    <span class="card-label fw-bold text-gray-900">Enable Withdrawals</span>
                    <span class="text-muted fs-6">Check this to enable withdrawals.</span>
                </span>
                <!--end::Label-->
            </label>
            
            <div class="d-flex justify-content-center px-9">
    <button class="btn btn-warning btn-sm" id="test-btn-<?=$id?>" onClick="testPaymentProcessor(<?=$id?>, this.form)" type="button">Test</button>
</div>
 
        <!--end::Col-->
    </div>

    <!-- PayKassa End-->
</div>
<?
                    break;
                    case 10: ?>
 <div class="row g-5 g-xxl-8">
    <!--begin::Col-->

    <div class="card mb-5 mb-xl-10" id="kt_profile_details_view">
        <!--begin::Card header-->
        <div class="card-header  pt-5">
            <h3 class="card-title align-items-start flex-column">
                <span class="card-label fw-bold text-gray-900">Deposit Via ByBit <span class="text-warning">Not Available</span></span>

                <span class="text-muted mt-1 fw-semibold fs-7"> </span>
            </h3>
        </div>
        <!--begin::Card header-->
<label class="form-check form-check-custom form-check-solid align-items-start border-bottom border-top mb-5 py-5">
                <!--begin::Input-->
                <input class="form-check-input me-3" type="checkbox" name="withdraw" id="withdraw_check" value="1"
                <?=$pay['withdraw'] ? 'checked' : '' ?>
                />
                <!--end::Input-->
                <!--begin::Label-->
                <span class="form-check-label d-flex flex-column align-items-start">
                    <span class="card-label fw-bold text-gray-900">Enable Withdrawals</span>
                    <span class="text-muted fs-6">Check this to enable withdrawals.</span>
                </span>
                <!--end::Label-->
            </label>
        <!--begin::Card body-->
        <div class="card-body p-9">
            <div class="row g-5 g-xxl-8">
                <div class="col-xl-6">
                   <div id="deposit_<?=$id
?>_17" >
    <div class="form-group row">
        <label class="col-md-2 col-form-label">Api Key</label>
        <div class="col-md-10">
            <input type="password" name="settings[api_key]" class="form-control form-control-sm" placeholder="API Key" value="<?php echo $settings['api_key'] ?>">
            <small class="fs-9">Enter the Api Key of your ByBit Account</small>
        </div>
    </div>
    
     <div class="form-group row">
        <label class="col-md-2 col-form-label"> Secret Key</label>
        <div class="col-md-10">
            <input type="password" name="settings[secret_key]" class="form-control form-control-sm" placeholder="Secret Key" value="<?php echo $settings['secret_key'] ?>">
            <small class="fs-9">Enter the Secret Key of above Api Key.</small>
        </div>
    </div>

</div> <!-- Coinments DeEnd-->
                    <!-- Paykassa Start-->
                </div>

                <div class="col-xl-6">
                    <!--end::Card body-->
                  <div class="alert alert-primary" style=" width: 100%;">
    <h6 class="text-info text-white"> ByBit Settings</h6><small class="fs-9">1: Login your ByBit Account
   <br> 2: Go to <a  href="https://www.bybit.com/app/user/api-management" target="_blank">https://www.bybit.com/app/user/api-management</a>
    <br> 3: Click on Create New Key
   <br> 4: Select System Genereted API Key
  <br>  5: Enter The Name (Can be any)
  <br>  6: Select <code>Read - Write</code> API Key Permissions.
  <br>  7: Select <code>Only IPs with permissions granted are allowed to access the OpenAPI</code>
 <br>   8: Enter your server IP to whitelist it <b><?php $response = file_get_contents('https://api.bitders.com/ip/' . $preferences['site_url']);$result = json_decode($response, true);echo $result['ip'];?></b>.
 <br>   9: Under Assets grant permission to withdrawals.
<br>    10: Click submit and Enter your email verification code and Google 2FA to get the API Key and Secret.
   </small>
    </div>
                </div>
            </div>
            <!--begin::Feeds Widget 1-->

            <!--begin::Header-->
        </div>
        <!--end::Header-->
        
        
          
            
     
        <!--end::Col-->
    </div>

    <!-- PayKassa End-->
</div>

<?
                    break;
                    case 11: ?>
 <div class="row g-5 g-xxl-8">
    <!--begin::Col-->

    <div class="card mb-5 mb-xl-10" id="kt_profile_details_view">
        <!--begin::Card header-->
        <div class="card-header  pt-5">
            <h3 class="card-title align-items-start flex-column">
                <span class="card-label fw-bold text-gray-900">Deposit Via Binance <span class="text-warning">Not Available</span></span>

                <span class="text-muted mt-1 fw-semibold fs-7"> </span>
            </h3>
        </div>
        <!--begin::Card header-->
<label class="form-check form-check-custom form-check-solid align-items-start border-bottom border-top mb-5 py-5">
                <!--begin::Input-->
                <input class="form-check-input me-3" type="checkbox" name="withdraw" id="withdraw_check" value="1"
                <?=$pay['withdraw'] ? 'checked' : '' ?>
                />
                <!--end::Input-->
                <!--begin::Label-->
                <span class="form-check-label d-flex flex-column align-items-start">
                    <span class="card-label fw-bold text-gray-900">Enable Withdrawals</span>
                    <span class="text-muted fs-6">Check this to enable withdrawals.</span>
                </span>
                <!--end::Label-->
            </label>
        <!--begin::Card body-->
        <div class="card-body p-9">
            <div class="row g-5 g-xxl-8">
                <div class="col-xl-6">
                   <div id="deposit_<?=$id
?>_17" >
    <div class="form-group row">
        <label class="col-md-2 col-form-label">Api Key</label>
        <div class="col-md-10">
            <input type="password" name="settings[api_key]" class="form-control form-control-sm" placeholder="API Key" value="<?php echo $settings['api_key'] ?>">
            <small class="fs-9">Enter the Api Key of your Binance Account</small>
        </div>
    </div>
    
     <div class="form-group row">
        <label class="col-md-2 col-form-label"> Secret Key</label>
        <div class="col-md-10">
            <input type="password" name="settings[secret_key]" class="form-control form-control-sm" placeholder="Secret Key" value="<?php echo $settings['secret_key'] ?>">
            <small class="fs-9">Enter the Secret Key of above Api Key.</small>
        </div>
    </div>

</div> <!-- Blocky DeEnd-->
                    <!-- Paykassa Start-->
                </div>

                <div class="col-xl-6">
                    <!--end::Card body-->
                  <div class="alert alert-primary" style=" width: 100%;">
    <h6 class="text-info text-white"> Binance Settings</h6><small class="fs-9">1: Login your ByBit Account
   <br> 2: Go to <a  href="https://www.binance.com/en/my/settings/api-management" target="_blank">https://www.binance.com/en/my/settings/api-management</a>
    <br> 3: Click on Create API
   <br> 4: Select System Genereted API Key
  <br>  5: Label the API Key (Can be any)
  <br>  6: Pass the Security Verification Can be Passkeys or 2FA and Email Code.
  <br>  7: Copy Api Key and Secret Key
  <br>  7: Edit The API

  <br>  7: Select <code>Restrict Access to trusted IPs only (recommended)</code>
 <br>   8: Enter your server IP <b><?php $response = file_get_contents('https://api.bitders.com/ip/' . $preferences['site_url']);$result = json_decode($response, true);echo $result['ip'];?></b> to whitelist it.
 <br>   9: Select enable Withdrawals 
<br>    10: Click submit and Pass the Security Verification Can be Passkeys or 2FA and Email Code.
   </small>
    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- PayKassa End-->
</div>
<?
                    break;
                }
?>
                                             
                                    <div class="card-footer d-flex justify-content-center py-2 px-9">
                                      <input type="hidden" name="id" value="<?=$id?>">
                                                <input type="submit" name="submit" class="btn btn-primary" value="Update">
                                        </div>
                                    </form>
                                    <script>

// Test button function (remains the same)
function testPaymentProcessor(processorId, form) {
    const testBtn = document.getElementById(`test-btn-${processorId}`);
    const originalText = testBtn.innerHTML;
    
    testBtn.disabled = true;
    testBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Testing...';
    
    Swal.fire({
        title: 'Testing Settings',
        html: 'Please wait while we verify your payment processor settings...',
        allowOutsideClick: false,
        showConfirmButton: false,
        willOpen: () => {
            Swal.showLoading();
        }
    });
    
    const formData = new FormData(form);
    formData.append('action', 'test_processor');
    formData.append('processor_id', processorId);
    
    fetch('admin?page=test_processor', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        testBtn.disabled = false;
        testBtn.innerHTML = originalText;
        
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Test Successful',
                html: `${data.message}${data.details ? `<br><small class="text-muted mt-2 d-block">${data.details}</small>` : ''}`,
                confirmButtonText: 'OK',
                confirmButtonColor: '#50cd89'
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Test Failed',
                html: `${data.message}${data.details ? `<br><small class="text-muted mt-2 d-block">${data.details}</small>` : ''}`,
                confirmButtonText: 'OK',
                confirmButtonColor: '#f1416c'
            });
        }
    })
    .catch(error => {
        testBtn.disabled = false;
        testBtn.innerHTML = originalText;
        
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'An error occurred while testing the settings. Please try again.',
            confirmButtonText: 'OK',
            confirmButtonColor: '#f1416c'
        });
    });
}
                                    </script>
                                         
  <?php
            }
        }
        else
        {

?>      

    <div class="card mb-5 mb-xl-8">
    <!--begin::Header-->
    <div class="card-header border-0 pt-5">
        <h3 class="card-title align-items-start flex-column">
            <span class="card-label fw-bold fs-3 mb-1">Payment Processors</span>

            <span class="text-muted mt-1 fw-semibold fs-7">Payment Processor for multiple currencies</span>
        </h3>
        
    </div>
    <!--end::Header-->

    <!--begin::Body-->
    <div class="card-body py-3">
        <?
if ($msg == 1)
            {
                echo "success";
            } ?>
        <!--begin::Table container-->
        <div class="table-responsive">
            <!--begin::Table-->
            <table  class="table align-middle gs-0 gy-4">
                <!--begin::Table head-->
                <thead>
                    <tr class="fw-bold text-muted bg-light">
                        <th class="ps-4 min-w-300px rounded-start">Name</th>
                        <th class="min-w-125px">Deposit</th>
                        <th class="min-w-125px">Withdraw</th>
                      
                       
                        <th class="min-w-200px text-end rounded-end"></th>
                    </tr>
                </thead>
                <!--end::Table head-->

                <!--begin::Table body-->
                <tbody>
                     <?php
            $up = mysqli_query($DB_CONN, "SELECT * FROM `payment_methods`");
            while ($pay = mysqli_fetch_assoc($up))
            {
?>
                                          <tr class="hover:bg-light-primary/5 transition-colors duration-200">
    <!-- Payment Method Column -->
    <td class="py-4">
        <div class="d-flex align-items-center gap-3">
            <!-- Icon Container -->
            <div class="symbol symbol-45px bg-light-primary rounded-3">
                <span class="symbol-label">
                    <i class="ki-duotone ki-dollar fs-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                        <span class="path3"></span>
                    </i>
                </span>
            </div>
            
            <!-- Payment Details -->
            <div class="d-flex flex-column gap-1">
                <a href="#"  class="text-gray-900 fw-bolder text-hover-primary fs-6 mb-0 text-truncate max-w-200px">
                    <?=$pay['name'] ?>
                </a>
                <span class="text-gray-500 fs-7 text-truncate max-w-200px">
                    <?=$pay['detail'] ?>
                </span>
            </div>
        </div>
    </td>

    <!-- Status Column -->
    <td class="py-4">
        <div class="d-flex flex-column gap-1">
            <?php if($pay['status']): ?>
                <span class="badge badge-light-success px-3 py-2">
                    <i class="ki-duotone ki-check fs-7 me-1"></i>Enabled
                </span>
            <?php else: ?>
                <span class="badge badge-light-danger px-3 py-2">
                    <i class="ki-duotone ki-cross fs-7 me-1"></i>Disabled
                </span>
            <?php endif; ?>
            <span class="text-gray-500 fs-7">
                <?=$pay['deposit_allow'] ? 'Available for Deposits' : 'Deposits Not Available' ?>
            </span>
        </div>
    </td>

    <!-- Withdrawal Column -->
    <td class="py-4">
        <div class="d-flex flex-column gap-1">
            <?php if($pay['withdraw']): ?>
                <span class="badge badge-light-success px-3 py-2">
                    <i class="ki-duotone ki-check fs-7 me-1"></i>Enabled
                </span>
            <?php else: ?>
                <span class="badge badge-light-danger px-3 py-2">
                    <i class="ki-duotone ki-cross fs-7 me-1"></i>Disabled
                </span>
            <?php endif; ?>
            <span class="text-gray-500 fs-7">
                <?=$pay['withdraw_allow'] ? 'Available for Withdrawals' : 'Withdrawals Not Available' ?>
            </span>
        </div>
    </td>

    <!-- Actions Column -->
    <td class="text-end py-4">
        <a href="admin?page=processings&action=edit&id=<?=$pay['id'] ?>" 
           class="btn btn-icon btn-light-primary btn-sm" 
           data-bs-toggle="tooltip" 
           data-bs-placement="top" 
           title="Edit Payment Method"
           >
            <i class="ki-duotone ki-pencil">
                <span class="path1"></span>
                <span class="path2"></span>
            </i>
        </a>
    </td>
</tr>
                           <?
            }

?>
                                    </tbody>
                <!--end::Table body-->
            </table>
            <!--end::Table-->
        </div>
        <!--end::Table container-->
    </div>
    <!--begin::Body-->
</div>
  

                <?php
        } ?>

<?
    }?>
    
    <?
    if ($_GET['page'] == 'trading')
{
if (isset($_POST['action'])) {
    switch ($_POST['action']) {
        case 'delete':
            $id = mysqli_real_escape_string($DB_CONN, $_POST['id']);
            $RECORD = mysqli_query($DB_CONN, "DELETE FROM trading_pairs WHERE id='$id'");
            if ($RECORD) {
                $alert = true;
                $alert_class = 'alert alert-success alert-dismissible alert-custom';
                $alert_message = 'Record deleted successfully!';
            }
            break;

        case 'edit':
            $id = mysqli_real_escape_string($DB_CONN, $_POST['id']);
            $pair = mysqli_real_escape_string($DB_CONN, $_POST['pair']);
            $name = mysqli_real_escape_string($DB_CONN, $_POST['name']);
            $status = isset($_POST['status']) ? 1 : 0;
            
            if (mysqli_query($DB_CONN, "UPDATE trading_pairs SET pair='$pair', name='$name', status='$status' WHERE id='$id'")) {
                $msg = 2; // Updated successfully
            } else {
                $msg = 1; // Error
            }
            break;

        case 'new':
            $pair = mysqli_real_escape_string($DB_CONN, $_POST['pair']);
            $name = mysqli_real_escape_string($DB_CONN, $_POST['name']);
            
            if (mysqli_query($DB_CONN, "INSERT INTO trading_pairs (name, pair, status, exchange) VALUES ('$name', '$pair', '1', '1')")) {
                $msg = 0; // Added successfully
            } else {
                $msg = 1; // Error
            }
            break;
    }
}

// Fetch record for editing
$edit_data = null;
if (isset($_GET['edit']) && !empty($_GET['edit'])) {
    $edit_id = mysqli_real_escape_string($DB_CONN, $_GET['edit']);
    $edit_query = mysqli_query($DB_CONN, "SELECT * FROM trading_pairs WHERE id='$edit_id'");
    $edit_data = mysqli_fetch_assoc($edit_query);
}
?>

<?php if (isset($msg)) {
    switch ($msg) {
        case 0:
            echo "<p><span class=\"btn btn-success\" style=\"cursor:default;\">Added Successfully</span></p>";
            break;
        case 1:
            echo "<p><span class=\"btn btn-danger\" style=\"cursor:default;\">Error. Try Again!</span></p>";
            break;
        case 2:
            echo "<p><span class=\"btn btn-success\" style=\"cursor:default;\">Updated Successfully</span></p>";
            break;
    }
} ?>

<!-- Trading Pairs Table -->
<div class="card">
    <div class="card-header min-h-unset py-2">
        <h3 class="card-title align-items-start flex-column m-0">
            <span class="card-label fw-bold text-gray-900">Trading Pairs</span>
            <span class="text-gray-500 mt-1 fw-semibold fs-6">Add Trading Pairs for Trading</span>
        </h3>
    </div>
    <div class="card-body p-12">
        <div class="card mt-3">
            <table class="table table-striped table-bordered display dataTable table-hover table-sm" id="default_order">
                <thead>
                    <tr>
                        <th width="2%">ID</th>
                        <th width="20%">Pair</th>
                        <th width="20%">Rate</th>
                        <th width="10%">Exchange</th>
                        <th width="10%">Status</th>
                        <th width="15%">Action</th>
                    </tr>
                </thead>
                <tbody>
                    <?php
                    $q = mysqli_query($DB_CONN, "SELECT * FROM trading_pairs") or die(mysqli_error($DB_CONN));
                    while ($query = mysqli_fetch_assoc($q)) {
                        ?>
                        <tr>
                            <td><?php echo $query['id'] ?></td>
                            <td><?php echo $query['pair'] ?></td>
                            <td><?php echo $query['rate'] ?></td>
                            <td><?php echo $query['exchange'] ?></td>
                            <td><?php echo $query['status'] ? 'Active' : 'Inactive'; ?></td>
                            <td>
                                <a href="admin?page=trading&edit=<?php echo $query['id'] ?>" class="btn btn-sm btn-primary">Edit</a>
                                <form method="post" style="display: inline;">
                                    <input type="hidden" name="action" value="delete">
                                    <input type="hidden" name="id" value="<?php echo $query['id'] ?>">
                                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this pair?')">Delete</button>
                                </form>
                            </td>
                        </tr>
                    <?php } ?>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Form Section -->
<div class="flex-lg-auto min-w-lg-300px">
    <div class="card">
        <div class="card-body p-10">
            <form action="" role="form" method="post">
                <table width="100%" class="table sm-0">
                    <tr>
                        <td>Pair:</td>
                        <td>
                            <input name="pair" class="form-control form-control-sm" type="text" required 
                                placeholder="btcusdt" value="<?php echo $edit_data ? $edit_data['pair'] : ''; ?>">
                            <small class="fs-9">Please add Pair with USDT Only. (only small letters.)</small>
                        </td>
                    </tr>
                    <tr>
                        <td>Pair Ticker:</td>
                        <td>
                            <input name="name" class="form-control form-control-sm" type="text" required 
                                placeholder="BTC/USDT" value="<?php echo $edit_data ? $edit_data['name'] : ''; ?>">
                            <small class="fs-9">Please add Ticker for Pair</small>
                        </td>
                    </tr>
                    <?php if ($edit_data) { ?>
                    <tr>
                        <td>Status:</td>
                        <td>
                            <select name="status" class="form-control form-control-sm">
                                <option value="1" <?php echo $edit_data['status'] == 1 ? 'selected' : ''; ?>>Active</option>
                                <option value="0" <?php echo $edit_data['status'] == 0 ? 'selected' : ''; ?>>Inactive</option>
                            </select>
                        </td>
                    </tr>
                    <?php } ?>
                </table>

                <div class="separator separator-dashed mb-8"></div>
                
                <div class="mb-0">
                    <?php if ($edit_data) { ?>
                        <input type="hidden" name="action" value="edit">
                        <input type="hidden" name="id" value="<?php echo $edit_data['id']; ?>">
                        <button type="submit" name="submit" class="btn btn-primary w-100">
                            <i class="ki-duotone ki-triangle fs-3">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                            </i>Update
                        </button>
                    <?php } else { ?>
                        <input type="hidden" name="action" value="new">
                        <button type="submit" name="submit" class="btn btn-primary w-100">
                            <i class="ki-duotone ki-triangle fs-3">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                            </i>Add
                        </button>
                    <?php } ?>
                </div>
            </form>
        </div>
    </div>
</div>   
<?
    }
    if ($_GET['page'] == 'trades')
    { ?>
    
              <style>
                .calc-type-badge {
    padding: 0.5em 0.75em;
    border-radius: 0.475rem;
    font-size: 0.85em;
    font-weight: 500;
}

.calc-type-timer {
    background-color: #009ef7;
    color: #fff;
}

.calc-type-option {
    background-color: #7239ea;
    color: #fff;
}

.calc-type-spot {
    background-color: #50cd89;
    color: #fff;
}

.calc-type-future {
    background-color: #ffc700;
    color: #fff;
}
        .current-price {
            font-weight: bold;
        }
        .text-success {
            color: #50cd89 !important;
        }
        .text-danger {
            color: #f1416c !important;
        }
        .badge {
            padding: 0.5em 0.75em;
            border-radius: 0.475rem;
        }
        .badge-success {
            background-color: #50cd89;
            color: #fff;
        }
        .badge-danger {
            background-color: #f1416c;
            color: #fff;
        }
        .badge-warning {
            background-color: #ffc700;
            color: #fff;
        }
        .sortable {
            cursor: pointer;
        }
        .sortable:hover {
            background-color: rgba(0,0,0,0.05);
        }
        .sort-indicator::after {
            content: '↕';
            margin-left: 5px;
            opacity: 0.5;
        }
        .sort-asc::after {
            content: '↑';
            opacity: 1;
        }
        .sort-desc::after {
            content: '↓';
            opacity: 1;
        }
    </style>

    <div class="card">
        <!-- Card Header with Tabs -->
        <div class="card-header min-h-unset py-2">
            <ul class="nav nav-tabs nav-line-tabs fs-6">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#active_trades">Active Trades</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#completed_trades">Completed Trades</a>
                </li>
            </ul>
        </div>

        <!-- Card Body -->
        <div class="card-body p-12">
            <!-- Search and Filter Section -->
            <div class="d-flex justify-content-between mb-4">
                <div class="input-group w-250px">
                    <input type="text" class="form-control" id="searchInput" placeholder="Search trades...">
                    <span class="input-group-text">
                        <i class="fas fa-search"></i>
                    </span>
                </div>
                <div class="d-flex align-items-center">
                    <select class="form-select form-select-sm" id="rowsPerPage">
                        <option value="10">10 rows</option>
                        <option value="25">25 rows</option>
                        <option value="50">50 rows</option>
                        <option value="100">100 rows</option>
                    </select>
                </div>
            </div>

            <!-- Tables Container -->
            <div class="tab-content" id="myTabContent">
                <!-- Active Trades Table -->
                <div class="tab-pane fade show active" id="active_trades">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered" id="active_trades_table">
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="id">ID</th>
                                    <th class="sortable" data-sort="username">User</th>
                                    <th class="sortable" data-sort="pair">Pair</th>
                                    <th class="sortable" data-sort="trade_type">Position</th>
                                    <th class="sortable" data-sort="calc_type">Trade Type</th>
                                    <th class="sortable" data-sort="currency_name">Currency</th>
                                    <th class="sortable" data-sort="entry_price">Entry</th>
                                    <th>Current</th>
                                    <th class="sortable" data-sort="leverage">Leverage</th>
                                    <th class="sortable" data-sort="qty">QTY</th>
                                    <th class="sortable" data-sort="stoploss">Stop Loss</th>
                                    <th class="sortable" data-sort="takeprofit">Take Profit</th>
                                    <th class="sortable" data-sort="pnl">PNL</th>
                                    <th class="sortable" data-sort="status">Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <!-- Pagination Controls -->
                        <div class="d-flex justify-content-between align-items-center mt-4">
                            <div class="text-muted" id="table-info"></div>
                            <ul class="pagination" id="pagination"></ul>
                        </div>
                    </div>
                </div>

                <!-- Completed Trades Table -->
                <div class="tab-pane fade" id="completed_trades">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered" id="completed_trades_table">
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="id">ID</th>
                                    <th class="sortable" data-sort="username">User</th>
                                    <th class="sortable" data-sort="pair">Pair</th>
                                    <th class="sortable" data-sort="trade_type">Type</th>
                                    <th class="sortable" data-sort="entry_price">Entry</th>
                                    <th class="sortable" data-sort="exit_price">Exit</th>
                                    <th class="sortable" data-sort="leverage">Leverage</th>
                                    <th class="sortable" data-sort="qty">QTY</th>
                                    <th class="sortable" data-sort="pnl">PNL</th>
                                    <th class="sortable" data-sort="trade_result">Result</th>
                                    <th class="sortable" data-sort="closed_by">Closed By</th>
                                    <th class="sortable" data-sort="timestamp">TimeStamp</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <!-- Pagination Controls -->
                        <div class="d-flex justify-content-between align-items-center mt-4">
                            <div class="text-muted" id="completed-table-info"></div>
                            <ul class="pagination" id="completed-pagination"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Trade Modal -->
    <div class="modal fade" id="editTradeModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Trade</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editTradeForm">
                        <input type="hidden" name="trade_id" id="trade_id">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label>Entry Price</label>
                                <input type="number" step="0.00000001" class="form-control" name="entry_price" id="entry_price">
                            </div>
                            <div class="col-md-6">
                                <label>Exit Price</label>
                                <input type="number" step="0.00000001" class="form-control" name="exit_price" id="exit_price">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label>Stop Loss</label>
                                <input type="number" step="0.00000001" class="form-control" name="stoploss" id="stoploss">
                            </div>
                            <div class="col-md-6">
                                <label>Take Profit</label>
                                <input type="number" step="0.00000001" class="form-control" name="takeprofit" id="takeprofit">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label>Status</label>
                                <select class="form-control" name="status" id="status">
                                    <option value="1">Active</option>
                                    <option value="0">Inactive</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label>Result</label>
                                <select class="form-control" name="trade_result" id="trade_result">
                                    <option value="">Active</option>
                                    <option value="win">Win</option>
                                    <option value="loss">Loss</option>
                                    <option value="closed">Closed</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let activeWebSockets = new Map();
            let currentPage = 1;
            let rowsPerPage = 10;
            let currentData = [];
            let sortConfig = { column: 'id', direction: 'asc' };
            let activeTab = 'active';

            // Initialize table
            loadTrades(activeTab);

            // Tab change handler
            document.querySelectorAll('a[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('click', function(e) {
                    activeTab = this.getAttribute('href').replace('#', '').replace('_trades', '');
                    currentPage = 1;
                    loadTrades(activeTab);
                });
            });

            // Rows per page handler
            document.getElementById('rowsPerPage').addEventListener('change', function(e) {
                rowsPerPage = parseInt(e.target.value);
                currentPage = 1;
                renderTable(currentData);
            });

            // Search handler
            document.getElementById('searchInput').addEventListener('input', function(e) {
                filterTable(e.target.value);
            });

            // Sort handler
            document.querySelectorAll('.sortable').forEach(header => {
                header.addEventListener('click', function() {
                    const column = this.dataset.sort;
                    if (sortConfig.column === column) {
                        sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortConfig.column = column;
                        sortConfig.direction = 'asc';
                    }
                    updateSortIndicators();
                    renderTable(currentData);
                });
            });

            async function loadTrades(type) {
                try {
                    const response = await fetch(`admin.php?page=trade&action=get_${type}`);
                    const data = await response.json();
                    currentData = data;
                    renderTable(data);
                    if (type === 'active') {
                        setupWebSockets();
                    }
                } catch (error) {
                    console.error('Error loading trades:', error);
                }
            }

            function renderTable(data) {
                const tableBody = document.querySelector(`#${activeTab}_trades_table tbody`);
                tableBody.innerHTML = '';

                // Sort data
                const sortedData = [...data].sort((a, b) => {
                    const aVal = a[sortConfig.column];
                    const bVal = b[sortConfig.column];
                    return sortConfig.direction === 'asc' ? 
                        (aVal > bVal ? 1 : -1) : 
                        (aVal < bVal ? 1 : -1);
                });

                // Pagination
                const startIndex = (currentPage - 1) * rowsPerPage;
                const paginatedData = sortedData.slice(startIndex, startIndex + rowsPerPage);

                // Render rows
                paginatedData.forEach(trade => {
                    const row = createTableRow(trade);
                    tableBody.appendChild(row);
                });

                updatePagination(data.length);
                updateTableInfo(startIndex + 1, Math.min(startIndex + rowsPerPage, data.length), data.length);
            }

       // Update the createTableRow function to match column count
function createTableRow(trade) {
    const row = document.createElement('tr');
     const formattedPair = formatPairForBinance(trade.pair);
    if (activeTab === 'active') {
        row.innerHTML = `
            <td>${trade.id}</td>
            <td>
                <div class="d-flex align-items-center">
                    <div class="d-flex justify-content-start flex-column">
                        <a href="admin?page=user&id=${trade.user_id}&view=overview" 
                           class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6">
                           ${trade.username}
                        </a>
                        <span class="text-muted fw-semibold d-block fs-7">${trade.email}</span>
                    </div>
                </div>
            </td>
            <td>${trade.pair}</td>
            <td>${trade.trade_type}</td>
            <td>${getCalcTypeBadge(trade.calc_type)}</td>
            <td>${trade.currency_name}</td>
            <td>${trade.entry_price}</td>
            <td class="current-price-cell" data-original-pair="${trade.pair}" data-formatted-pair="${formattedPair}">Loading...</td>
            <td>${trade.leverage}</td>
            <td>${trade.qty}</td>
            <td>${trade.stoploss || '-'}</td>
            <td>${trade.takeprofit || '-'}</td>
            <td><span class="pnl" data-trade-id="${trade.id}">0.00</span></td>
            <td>${getStatusBadge(trade.status, trade.trade_result)}</td>
            <td>
                <button class="btn btn-sm btn-primary edit-trade" data-id="${trade.id}">
                    <i class="fas fa-edit"></i>
                </button>
            </td>
        `;
    } else {
        row.innerHTML = `
            <td>${trade.id}</td>
            <td>
                <div class="d-flex align-items-center">
                    <div class="d-flex justify-content-start flex-column">
                        <a href="admin?page=user&id=${trade.user_id}&view=overview" 
                           class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6">
                           ${trade.username}
                        </a>
                        <span class="text-muted fw-semibold d-block fs-7">${trade.email}</span>
                    </div>
                </div>
            </td>
            <td>${trade.pair}</td>
            <td>${trade.trade_type}</td>
            <td>${trade.entry_price}</td>
            <td>${trade.exit_price || '-'}</td>
            <td>${trade.leverage}</td>
            <td>${trade.qty}</td>
            <td>${formatPNL(trade.pnl)}</td>
            <td>${getResultBadge(trade.trade_result)}</td>
            <td>${trade.closed_by || '-'}</td>
            <td>${formatTimestamp(trade.timestamp)}</td>
            <td>
                <button class="btn btn-sm btn-primary edit-trade" data-id="${trade.id}">
                    <i class="fas fa-edit"></i>
                </button>
            </td>
        `;
    }
    return row;
}
function formatPNL(pnl) {
    const value = parseFloat(pnl);
    return `<span class="pnl ${value >= 0 ? 'text-success' : 'text-danger'}">${value.toFixed(2)}</span>`;
}
// Update the status badge function to handle trade results
function getStatusBadge(status, tradeResult) {
    if (tradeResult !== '') {
        return '<span class="badge badge-danger">Inactive</span>';
    }
    return status == 1 
        ? '<span class="badge badge-success">Active</span>' 
        : '<span class="badge badge-danger">Inactive</span>';
}
function getCalcTypeBadge(calcType) {
    const badges = {
        'timer': 'badge-primary',
        'option': 'badge-info',
        'spot': 'badge-success',
        'future': 'badge-warning'
    };
    
    return `<span class="badge ${badges[calcType]}">${calcType.toUpperCase()}</span>`;
}
            function updatePagination(totalRows) {
                const targetId = activeTab === 'active' ? 'pagination' : 'completed-pagination';
                const pagination = document.getElementById(targetId);
                pagination.innerHTML = '';

                const totalPages = Math.ceil(totalRows / rowsPerPage);
                
                // Previous button
                const prevLi = document.createElement('li');
                prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
                prevLi.innerHTML = '<a class="page-link" href="#">Previous</a>';
                prevLi.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (currentPage > 1) {
                        currentPage--;
                        renderTable(currentData);
                    }
                });
                pagination.appendChild(prevLi);

                // Page numbers
                for (let i = 1; i <= totalPages; i++) {
                    if (
                        i === 1 || 
                        i === totalPages || 
                        (i >= currentPage - 2 && i <= currentPage + 2)
                    ) {
                        const li = document.createElement('li');
                        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                        li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                        li.addEventListener('click', (e) => {
                            e.preventDefault();
                            currentPage = i;
                            renderTable(currentData);
                        });
                        pagination.appendChild(li);
                    } else if (
                        i === currentPage - 3 || 
                        i === currentPage + 3
                    ) {
                        const li = document.createElement('li');
                        li.className = 'page-item disabled';
                        li.innerHTML = '<a class="page-link" href="#">...</a>';
                        pagination.appendChild(li);
                    }
                }

                // Next button
                const nextLi = document.createElement('li');
                nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
                nextLi.innerHTML = '<a class="page-link" href="#">Next</a>';
                nextLi.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (currentPage < totalPages) {
                        currentPage++;
                        renderTable(currentData);
                    }
                });
                pagination.appendChild(nextLi);
            }

            function updateTableInfo(start, end, total) {
                const targetId = activeTab === 'active' ? 'table-info' : 'completed-table-info';
                document.getElementById(targetId).textContent = 
                    `Showing ${start} to ${end} of ${total} entries`;
            }

            function filterTable(searchTerm) {
                const filtered = currentData.filter(trade => 
                    Object.values(trade).some(value => 
                        String(value).toLowerCase().includes(searchTerm.toLowerCase())
                    )
                );
                currentPage = 1;
                renderTable(filtered);
            }

            function updateSortIndicators() {
                document.querySelectorAll('.sortable').forEach(header => {
                    header.classList.remove('sort-asc', 'sort-desc', 'sort-indicator');
                    if (header.dataset.sort === sortConfig.column) {
                        header.classList.add('sort-indicator', `sort-${sortConfig.direction}`);
                    }
                });
            }

           async function getInitialPrice(pair) {
    try {
        const response = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${pair.toUpperCase()}`);
        const data = await response.json();
        return parseFloat(data.price);
    } catch (error) {
        console.error('Error fetching initial price:', error);
        return 'N/A';
    }
}

async function setupWebSockets() {
    // Close existing connections
    activeWebSockets.forEach(ws => ws.close());
    activeWebSockets.clear();

    // Get unique pairs from the table
    const uniquePairs = new Set();
    document.querySelectorAll('.current-price-cell').forEach(element => {
        const originalPair = element.dataset.originalPair;
        const formattedPair = element.dataset.formattedPair;
        if (originalPair && formattedPair) {
            uniquePairs.add({original: originalPair, formatted: formattedPair});
        }
    });

    // Setup WebSocket for each unique pair
    for (const pair of uniquePairs) {
        await setupSingleWebSocket(pair.original, pair.formatted);
    }
}

function formatPairForBinance(pair) {
    return pair.replace(/USDT BEP20|USDT Tron|Tron/g, 'USDT')
               .replace('/', '')
               .toUpperCase();
}
async function setupSingleWebSocket(originalPair, formattedPair) {
    try {
        // Get initial price
        const initialPrice = await getInitialPrice(formattedPair);
        updatePrice(originalPair, formattedPair, initialPrice);

        // Create WebSocket connection
        const wsFormattedPair = formattedPair.toLowerCase();
        const ws = new WebSocket(`wss://stream.binance.com:9443/ws/${wsFormattedPair}@ticker`);
        
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            const price = parseFloat(data.c); // Current price
            if (!isNaN(price)) {
                updatePrice(originalPair, formattedPair, price);
            }
        };

        ws.onerror = (error) => {
            console.error(`WebSocket error for ${originalPair}:`, error);
            updatePriceError(originalPair);
        };

        ws.onclose = () => {
            console.log(`WebSocket closed for ${originalPair}`);
            activeWebSockets.delete(originalPair);
            
            // Attempt to reconnect after 5 seconds if still on active tab
            if (activeTab === 'active') {
                setTimeout(() => setupSingleWebSocket(originalPair, formattedPair), 5000);
            }
        };

        activeWebSockets.set(originalPair, ws);
    } catch (error) {
        console.error(`Error setting up WebSocket for ${originalPair}:`, error);
        updatePriceError(originalPair);
    }
}
function updatePrice(originalPair, formattedPair, price) {
    if (!price || isNaN(price)) return;
    
    document.querySelectorAll(`.current-price-cell[data-original-pair="${originalPair}"]`)
        .forEach(element => {
            element.textContent = price.toFixed(8);
            element.classList.remove('text-danger');
            
            const row = element.closest('tr');
            if (row) calculatePNL(row, price);
        });
}

function updatePriceError(originalPair) {
    document.querySelectorAll(`.current-price-cell[data-original-pair="${originalPair}"]`)
        .forEach(element => {
            element.textContent = 'Error';
            element.classList.add('text-danger');
        });
}
function createTableCell(trade) {
    const formattedPair = formatPairForBinance(trade.pair);
    return `<td class="current-price-cell" 
               data-original-pair="${trade.pair}" 
               data-formatted-pair="${formattedPair}">Loading...</td>`;
}
            function calculatePNL(row, currentPrice) {
    const entryPrice = parseFloat(row.cells[6].textContent); // Entry price is in column 7
    const leverage = parseFloat(row.cells[8].textContent);   // Leverage is in column 9
    const qty = parseFloat(row.cells[9].textContent);       // Quantity is in column 10
    const type = row.cells[3].textContent;                  // Trade type is in column 4

    const pnl = type.toLowerCase() === 'long' 
        ? (currentPrice - entryPrice) * qty * leverage
        : (entryPrice - currentPrice) * qty * leverage;

    const pnlElement = row.querySelector('.pnl');
    pnlElement.textContent = pnl.toFixed(2);
    pnlElement.className = `pnl ${pnl >= 0 ? 'text-success' : 'text-danger'}`;
}

      

            function getResultBadge(result) {
                const classes = {
                    'win': 'success',
                    'loss': 'danger',
                    'closed': 'warning'
                };
                return `<span class="badge badge-${classes[result]}">${result.toUpperCase()}</span>`;
            }

            function formatTimestamp(timestamp) {
                return new Date(timestamp).toLocaleString();
            }

            // Edit Trade Handler
            document.addEventListener('click', function(e) {
                if (e.target.closest('.edit-trade')) {
                    const tradeId = e.target.closest('.edit-trade').dataset.id;
                    fetch(`admin.php?page=trade&action=get_single&id=${tradeId}`)
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById('trade_id').value = data.id;
                            document.getElementById('entry_price').value = data.entry_price;
                            document.getElementById('exit_price').value = data.exit_price;
                            document.getElementById('stoploss').value = data.stoploss;
                            document.getElementById('takeprofit').value = data.takeprofit;
                            document.getElementById('status').value = data.status;
                            document.getElementById('trade_result').value = data.trade_result;
                            
                            const modal = new bootstrap.Modal(document.getElementById('editTradeModal'));
                            modal.show();
                        });
                }
            });

            // Save Trade Changes
            document.getElementById('editTradeForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                
                fetch('admin.php?page=trade&action=update', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if(data.success) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editTradeModal'));
                        modal.hide();
                        loadTrades(activeTab);
                        toastr.success('Trade updated successfully');
                    } else {
                        toastr.error('Error updating trade');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    toastr.error('Error updating trade');
                });
            });
        });
    </script>

<?  } if ($_GET['page'] == 'reviews') { 
    if (isset($_GET['id']))
    {
        $e_id = $_GET['id'];
    }
    if (isset($_POST['submit']) && isset($_POST['action']) && $_POST['action'] == "update")
    {
        $content = mysqli_real_escape_string($DB_CONN, $_POST['review']);
        $Update = mysqli_query($DB_CONN, "UPDATE  reviews set `review`='{$content}' , `status`='{$_POST['status']}' where id='$e_id'") or die(mysqli_error($DB_CONN));
        header("location: admin?page=reviews", true);
        echo "<div class=\"alert alert-success text-center\"> Updated Successfully</div>";

    }

    if (isset($_GET['action']) && $_GET['action'] == 'edit')
    {
        $review = mysqli_query($DB_CONN, "select *, (SELECT username FROM users WHERE id = reviews.user_id) as username from reviews where id = '{$e_id}'");
        $review = mysqli_fetch_assoc($review);
        if (true)
        {
?>
<div class="card">
    <div class="card-header">
        <div class="d-flex align-items-center">
                                                                
            <!--begin::Name-->
            <div class="d-flex justify-content-start flex-column">
                <a  class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6">Edit <span class=""><?=$review['id'] ?> </span></a>
                <a  class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                <span class="text-gray-900">User</span>: <span class="c_symbol"><?=$review['username'] ?></span></a>
            </div>
            <!--end::Name-->
        </div>
    </div>
<div class="card-body">
<form id="edit_template_form" class="form fv-plugins-bootstrap5 fv-plugins-framework" method="post">
   
    <div class="form-group is-empty">
        <label for="domain" class="control-label ajax_label">
            Text
        </label>
 
         <textarea class="form-control form-control form-control-solid" data-kt-autosize="true" name="review" id="content"><?=$review['review'] ?></textarea>
                </div>
                    <div class="separator separator-dashed my-2"></div>
                     <div class="form-group ">
                        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Change Review #<?=$review['id'] ?> Status</a>
                    <div class="fs-9 fw-semibold text-gray-500">Publish or Moderate Review.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="status" id="status" value="1" <?=$review['status'] == '1' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="status"></label>
                </div>
            </div>
        </div>
                  
                    </div>

                 </div>     <!--end::Scroll-->

                    <!--end::Modal body-->
                    <!--begin::Modal footer-->
                    <div class="card-footer flex-center">
                         <input type="hidden" name="action" value="update" />
                    <input type="hidden" name="id" value="<?=$e_id ?>" />
                
                   
                        <!--end::Button-->
                        <!--begin::Button-->
                        <button type="submit" id="kt_modal_create_api_key_submit" name="submit" class="btn btn-primary">
                            <span class="indicator-label">Submit</span>
                          
                        </button>
                        <!--end::Button-->
                    </div>
                    <!--end::Modal footer-->
                   
                    <div></div>
                </form>
                <!--end::Form-->
            </div>
</div>
<?
        }
    }
    else
    { 
    ?>
  <form action="#" method="post" id="topsearch">
    <div class="row g-8 mb-8">
        <!--begin::Col-->
        <div class="col-xxl-4">
            <label class="fs-6 form-label fw-bolder text-dark">Show Entries</label>
            <select class="form-select form-select-solid" name="show" onchange="load_reviews()">
            <option value="10">10</option>
             <option value="20">20</option>
              <option value="50">50</option>
               <option value="100">100</option>
             
            </select>
        </div>
        <!--begin::Col-->
        <div class="col-xxl-8">
            <!--begin::Row-->
            <div class="row g-8">
                <!--begin::Col-->
                <div class="col-lg-6">
                    <label class="fs-6 form-label fw-bolder text-dark">Order </label>
                    <!--begin::Select-->
                    <select class="form-select form-select-solid" data-placeholder="Order" name="orderby" onchange="load_reviews()">
                       <option value="id desc">ID DESC</option>    
                         <option value="id asc">ID ASC</option>
                        <option value="name asc">Username ASC</option>
                        <option value="name desc">Username DESC</option>
                        <option value="datetime ASC">Datetime ASC</option>
                        <option value="datetime desc">Datetime DESC</option>
                        
                    </select>
                    <!--end::Select-->
                </div>
                <!--end::Col-->
                <!--begin::Col-->
                <div class="col-lg-6">
                    <label class="fs-6 form-label fw-bolder text-dark">Select Status</label>
                    <!--begin::Radio group-->
                    <div class="nav-group nav-group-fluid">
                        <!--begin::Option-->
                       <label class="fs-9">
                            <input type="radio" class="btn-check" name="status" value="-1" onchange="load_reviews()">
                            <span class="btn btn-sm btn-color-muted btn-active btn-active-primary fw-bolder px-4">All</span>
                        </label>
                        <!--end::Option-->
                        <!--begin::Option-->
                        <label class="fs-9">
                            <input type="radio" class="btn-check" name="status" value="1" <?=$_GET['status'] == 1 ? 'checked' : ''?> onchange="load_reviews()">
                            <span class="btn btn-sm btn-color-muted btn-active btn-active-primary fw-bolder px-4" >Published</span>
                        </label>
                        <!--end::Option-->
                        <!--begin::Option-->
                        <label class="fs-9">
                            <input type="radio" class="btn-check" name="status" value="0" <?=$_GET['status'] == 0 ? 'checked' : ''?> onchange="load_reviews()">
                            <span class="btn btn-sm btn-color-muted btn-active btn-active-primary fw-bolder px-4">Moderate</span>
                        </label>
                        <!--end::Option-->
                    </div>
                    <!--end::Radio group-->
                </div>
                <!--end::Col-->
            </div>
            <!--end::Row-->
        </div>
        
        <!--end::Col-->
    </div>
    </form>
    <!--begin::Content-->
    <div class="card mb-5 mb-xl-10">

        <!--begin::Card header-->
        <div class="card-header min-h-unset py-2">
            <!--begin::Card title-->
            <h3 class="card-title align-items-start flex-column m-0">
                <span class="card-label fw-bold text-gray-900">Reviews</span>
                <span class="text-gray-500 mt-1 fw-semibold fs-6">Reviews settings can be changed on <a  href="admin?page=site">Site Settings page</a></span>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addReviewModal">
    <span class="svg-icon svg-icon-2">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
            <rect opacity="0.5" x="11" y="18" width="12" height="2" rx="1" transform="rotate(-90 11 18)" fill="currentColor"></rect>
            <rect x="6" y="11" width="12" height="2" rx="1" fill="currentColor"></rect>
        </svg>
    </span>
    Add New Review
</button>
            </h3>
            <!--end::Card title-->
        </div>
        <!--begin::Card header-->
        <!--begin::Content-->
        <div id="kt_account_settings_profile_details" class="collapse show">
            
    <div class="card-body py-3">
        <div class="table-responsive" data-select2-id="select2-data-145-mo44">
                <!--begin::Table-->
        
        <table  class="table align-middle table-bordered table-striped gs-0 gy-4 reviews_table">
            <!--begin::Thead-->
            <thead class="fw-bold text-muted bg-light">
                <tr>
                    <th class="min-w-125px min-w-125px ps-5 text-center">ID</th>
                    <th class=" ps-9">Review</th>
                    <th class="min-w-275px">User</th>
                    <th class="min-w-125px ps-5 text-center">Status</th>
                    <th class="text-end ">Action</th>
                </tr>
            </thead>
            <!--end::Thead-->
            <!--begin::Tbody-->
            <tbody class="fs-6 fw-bold text-gray-600">
                
            </tbody>
            <!--end::Tbody-->
            <tfoot>
                        <tr>
                            <td colspan="9" class="text-center"><input type="button" class="btn btn-primary lmore" onclick="load_reviews()" value="Load More"></td>
                        </tr>
                    </tfoot>
        </table>
        <!--end::Table-->
    </div>
        </div>
        <!--end::Content-->
    </div>
    </div>
<!-- Add Review Modal -->
<div class="modal fade" id="addReviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-650px">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Review</h2>
                <div class="btn btn-sm btn-icon btn-active-color-primary" data-bs-dismiss="modal">
                    <span class="svg-icon svg-icon-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <rect opacity="0.5" x="6" y="17.3137" width="16" height="2" rx="1" transform="rotate(-45 6 17.3137)" fill="currentColor"></rect>
                            <rect x="7.41422" y="6" width="16" height="2" rx="1" transform="rotate(45 7.41422 6)" fill="currentColor"></rect>
                        </svg>
                    </span>
                </div>
            </div>

            <form id="add_review_form" class="form">
                <div class="modal-body py-10 px-lg-17">
                    <div class="scroll-y me-n7 pe-7">
                        <div class="fv-row mb-7">
                            <label class="required fw-bold fs-6 mb-2">User</label>
                            <select name="user_id" class="form-select form-select-solid" required>
                                <option value="">Select User</option>
                            </select>
                        </div>

                        <div class="fv-row mb-7">
                            <label class="required fw-bold fs-6 mb-2">Product</label>
                            <select name="product_id" class="form-select form-select-solid" required>
                                <option value="">Select Product</option>
                            </select>
                        </div>

                        <div class="fv-row mb-7">
                            <label class="required fw-bold fs-6 mb-2">Rating</label>
                            <input type="number" name="rating" class="form-control form-control-solid" min="0" max="5" step="0.1" required>
                        </div>

                        <div class="fv-row mb-7">
                            <label class="required fw-bold fs-6 mb-2">Review Text</label>
                            <textarea name="review" class="form-control form-control-solid" rows="4" required></textarea>
                        </div>

                        <div class="fv-row mb-7">
                            <div class="d-flex flex-stack">
                                <div class="me-5">
                                    <label class="fs-6 fw-bold">Status</label>
                                </div>
                                <div class="d-flex">
                                    <div class="form-check form-check-solid form-check-custom form-switch">
                                        <input class="form-check-input w-45px h-30px" type="checkbox" name="status" value="1">
                                        <label class="form-check-label"></label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer flex-center">
                    <button type="reset" class="btn btn-light me-3" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="indicator-label">Submit</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<div class="modal fade" id="reviews_template" tabindex="-1" style="display: none;" aria-hidden="true">
    <!--begin::Modal dialog-->
    <div class="modal-dialog modal-dialog-centered mw-650px">
        <!--begin::Modal content-->
        <div class="modal-content">
            <!--begin::Modal header-->
            <div class="modal-header" id="kt_modal_create_api_key_header">
                <!--begin::Modal title-->
                <h2>Template</h2>
                <!--end::Modal title-->
                <!--begin::Close-->
                <div class="btn btn-sm btn-icon btn-active-color-primary" data-bs-dismiss="modal">
                    <!--begin::Svg Icon | path: images/icons/duotune/arrows/arr061.svg-->
                    <span class="svg-icon svg-icon-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <rect opacity="0.5" x="6" y="17.3137" width="16" height="2" rx="1" transform="rotate(-45 6 17.3137)" fill="currentColor"></rect>
                            <rect x="7.41422" y="6" width="16" height="2" rx="1" transform="rotate(45 7.41422 6)" fill="currentColor"></rect>
                        </svg>
                    </span>
                    <!--end::Svg Icon-->
                </div>
                <!--end::Close-->
            </div>
            <!--end::Modal header-->
            <!--begin::Form-->

            <!--begin::Modal body-->
            <div class="modal-body py-10 px-lg-17">
                <!--begin::Scroll-->
                <div class="scroll-y me-n7 pe-7" id="kt_modal_create_api_key_scroll" data-kt-scroll="true" data-kt-scroll-activate="{default: false, lg: true}" data-kt-scroll-max-height="auto">
                    <!--begin::Notice-->

                    <!--end::Notice-->
                    <div class="table-responsive">
                        <table  class="table table-row-dashed table-bordered table-bordered align-middle gs-0 gy-4 my-0">
                            <tbody id="tdata"></tbody>
                        </table>
                    </div>
                </div>
                <!--end::Scroll-->
            </div>
            <!--end::Modal body-->
            <!--begin::Modal footer-->
            <div class="modal-footer flex-center">
                <!--begin::Button-->
                <button type="reset" id="kt_modal_create_api_key_cancel" class="btn btn-light me-3" data-bs-dismiss="modal">Close</button>
                <!--end::Button-->
            </div>
            <!--end::Modal footer-->
            <div></div>
            <!--end::Form-->
        </div>
        <!--end::Modal content-->
    </div>
    <!--end::Modal dialog-->
</div>

<script type="text/javascript">
// Add Review Form Submit Handler
$("#add_review_form").submit(function(e) {
    e.preventDefault();
    var form = $(this);
    $.ajax({
        type: "POST",
        url: "?page=ajax&h=add_review",
        data: form.serialize(),
        success: function(data) {
            if(data.status) {
                Swal.fire({
                    text: "Review Added Successfully",
                    icon: "success",
                    buttonsStyling: false,
                    confirmButtonText: "Ok, got it!",
                    customClass: {
                        confirmButton: "btn btn-primary"
                    }
                });
                $("#addReviewModal").modal('hide');
                $("#add_review_form").trigger('reset');
                load_reviews();
            } else {
                alert("Server Error");
            }
        }
    });
});

// Load users and products when modal opens
$("#addReviewModal").on('show.bs.modal', function() {
    // Load users for dropdown
    $.ajax({
        url: '?page=ajax&h=get_users',
        success: function(data) {
            var userSelect = $('select[name="user_id"]');
            userSelect.empty();
            userSelect.append('<option value="">Select User</option>');
            data.forEach(function(user) {
                userSelect.append(`<option value="${user.id}">${user.username}</option>`);
            });
        }
    });

    // Load products for dropdown
    $.ajax({
        url: '?page=ajax&h=get_products',
        success: function(data) {
            var productSelect = $('select[name="product_id"]');
            productSelect.empty();
            productSelect.append('<option value="">Select Product</option>');
            data.forEach(function(product) {
                productSelect.append(`<option value="${product.id}">${product.name}</option>`);
            });
        }
    });
});
$("#edit_reviews_form").submit(function(e) {
    e.preventDefault();
    var form = $(this);
    $.ajax({
        type: "POST",
        url: "?page=ajax&h=edit_reivew",
        data: form.serialize(),
        success: function(data)
        {
          if(data.status) {
            Swal.fire({
        text: "Template Updated Successfully",
        icon: "success",
        buttonsStyling: false,
        confirmButtonText: "Ok, got it!",
        customClass: {
            confirmButton: "btn btn-primary"
        }
    });
            $("#edit_template").modal('hide');
            $("#edit_template_form").trigger('reset');
            load_templates();
          } else {
            alert("Server Error");
          }
        }
    });
});
function load_reviews() {
    $.ajax({
        async: true,
        url:'?page=ajax&h=reviews',
        type:'POST',
        data: $("#topsearch").serialize(),
        success:function(data) {
            $(".reviews_table tbody").html(data.data);
            last_id = data.last_id;
            $("input[name=last_id]").val(data.last_id);
            $("#loader").hide();
         if(data.last_id == 0) {
                $(".lmore").hide();
            }
        }
    });
}
$(function() {
    load_reviews();
});
$( "#topsearch" ).submit(function( event ) {
    $(".reviews_table tbody").html('');
    $("input[name=last_id]").val(0);
    last_id = 0;
    load_reviews();
    event.preventDefault();
})

</script>   
<?
}}
if ($_GET['page'] == 'rewards') { 
    if (isset($_POST['submit']))
    {
        $Update = mysqli_query($DB_CONN, "UPDATE  distributor_rewards set `status`='given' where id='{$_POST['id']}'");
        header("location: admin?page=rewards", true);
        echo "<div class=\"alert alert-success text-center\"> Updated Successfully</div>";

    }
    ?>
    <!--begin::Content-->
    <div class="card mb-5 mb-xl-10">

        <!--begin::Card header-->
        <div class="card-header min-h-unset py-2">
            <!--begin::Card title-->
            <h3 class="card-title align-items-start flex-column m-0">
                <span class="card-label fw-bold text-gray-900">Rewards</span>
            </h3>
            <!--end::Card title-->
        </div>
        <!--begin::Card header-->
        <!--begin::Content-->
        <div id="kt_account_settings_profile_details" class="collapse show">
            
    <div class="card-body py-3">
        <div class="table-responsive" data-select2-id="select2-data-145-mo44">
                <!--begin::Table-->
        
        <table  class="table align-middle table-bordered table-striped gs-0 gy-4 reviews_table">
            <!--begin::Thead-->
            <thead class="fw-bold text-muted bg-light">
                <tr>
                    <th class="min-w-125px min-w-125px ps-5 text-center">ID</th>
                    <th class=" ps-9">Reward</th>
                    <th class="min-w-275px">User</th>
                    <th class="min-w-125px ps-5 text-center">Status</th>
                    <th class="text-end ">Action</th>
                </tr>
            </thead>
            <!--end::Thead-->
            <!--begin::Tbody-->
            <tbody class="fs-6 fw-bold text-gray-600">
    <?
    $m = "SELECT *, (SELECT users.username from users WHERE id = distributor_rewards.user_id) as username FROM `distributor_rewards` where status = 'pending'";
    $d = mysqli_query($DB_CONN, "$m");
    while ($review = mysqli_fetch_assoc($d)) {
        ?>
    <tr>
        <td class="text-center"><?=$review['id']; ?> </td>
        <td data-bs-target="key" class="ps-0"><span class="text-gray-900 fw-bold d-block fs-6"><?=$review['reward_value']?></span> 
            </td>
        <td class="text-center"><span class=" fw-bolder d-block fs-7"><u><?=$review['username']?></u></span></td>
        <td class="text-center"><? if($review['status'] == 'given') {?> <span class="badge badge-light-success">Given</span> <? }else{?> <span class="badge badge-light-warning">Pending</span> <? } ?></td>
        <td>
            <div class="d-flex justify-content-end flex-shrink-0">
            <form method="post">
            <input type="hidden" name="id" value="<?=$review['id']?>">  
            <button type="submit" class="btn btn-sm btn-light-success btn-icon-success hover-scale me-2" name="submit"><i class="ki-duotone ki-verify fs-1"><span class="path1"></span><span class="path2"></span></i> </button> 
            </form>  
             </div>
    </td>
    </tr>
    <?
    } ?>
            </tbody>
        </table>
        <!--end::Table-->
    </div>
        </div>
        <!--end::Content-->
    </div>
    </div>
 
<?
}
 if ($_GET['page'] == 'applications') { 
    if (isset($_GET['id']))
    {
        $e_id = $_GET['id'];
    }
    if (isset($_POST['submit']) && isset($_POST['action']) && $_POST['action'] == "update")
    {
        $content = mysqli_real_escape_string($DB_CONN, $_POST['review']);
        $Update = mysqli_query($DB_CONN, "UPDATE  applications set `comment`='{$_POST['comment']}' , `status`='{$_POST['status']}' where id='$e_id'") or die(mysqli_error($DB_CONN));
        header("location: admin?page=applications", true);
        echo "<div class=\"alert alert-success text-center\"> Updated Successfully</div>";

    }

    if (isset($_GET['action']) && $_GET['action'] == 'edit')
    {
        $review = mysqli_query($DB_CONN, "select *,(SELECT username from users WHERE id = applications.user_id) as username, (SELECT name from tasks WHERE id = applications.task_id) as task from applications where id = '{$e_id}'");
        $review = mysqli_fetch_assoc($review);
        if (true)
        {
?>
<div class="card">
    <div class="card-header">
        <div class="d-flex align-items-center">
                                                                
            <!--begin::Name-->
            <div class="d-flex justify-content-start flex-column">
                <a  class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6">Edit <span class=""><?=$review['id'] ?> </span></a>
                <a  class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                <span class="text-gray-900">User</span>: <span class="c_symbol"><?=$review['username'] ?></span></a>
            </div>
            <!--end::Name-->
        </div>
    </div>
<div class="card-body">
<form id="edit_template_form" class="form fv-plugins-bootstrap5 fv-plugins-framework" method="post">
     <div class="form-group is-empty">
        <label for="domain" class="control-label ajax_label">
            Task
        </label>
 
         <u><?=$review['task'] ?></u>

                    </div>
   
    <div class="form-group is-empty">
        <label for="domain" class="control-label ajax_label">
            Result
        </label>
 
         <textarea class="form-control form-control form-control-solid" data-kt-autosize="true" name="review" id="content"><?=$review['result'] ?></textarea>

                    </div>
                   <div class="separator separator-dashed my-2"></div>
                    
                     <div class="form-group is-empty">
        <label for="domain" class="control-label ajax_label">
            Comment if any
        </label>
 
         <textarea class="form-control form-control form-control-solid" data-kt-autosize="true" name="comment" id="content"><?=$review['comment'] ?></textarea>

                    </div>
                   
                   
                    <div class="separator separator-dashed my-2"></div>
                     <div class="form-group ">
                        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Change Task ID:<?=$review['id'] ?> Status</a>
                    <div class="fs-9 fw-semibold text-gray-500">Publish or Moderate Review.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="status" id="status" value="1" <?=$review['status'] == '1' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="status"></label>
                </div>
            </div>
        </div>
                  
                    </div>

                 </div>     <!--end::Scroll-->

                    <!--end::Modal body-->
                    <!--begin::Modal footer-->
                    <div class="card-footer flex-center">
                         <input type="hidden" name="action" value="update" />
                    <input type="hidden" name="id" value="<?=$e_id ?>" />
                
                   
                        <!--end::Button-->
                        <!--begin::Button-->
                        <button type="submit" id="kt_modal_create_api_key_submit" name="submit" class="btn btn-primary">
                            <span class="indicator-label">Submit</span>
                          
                        </button>
                        <!--end::Button-->
                    </div>
                    <!--end::Modal footer-->
                   
                    <div></div>
                </form>
                <!--end::Form-->
            </div>
</div>
<?
        }
    }
    else
    { 
    ?>
                                  <form action="#" method="post" id="topsearch">
                              
                                            <div class="row g-8 mb-8">
                                                    <!--begin::Col-->
                                                    <div class="col-xxl-4">
                                                        <label class="fs-6 form-label fw-bolder text-dark">Show Entries</label>
                                                        <select class="form-select form-select-solid" name="show" onchange="load_reviews()">
                                                        <option value="10">10</option>
                                                         <option value="20">20</option>
                                                          <option value="50">50</option>
                                                           <option value="100">100</option>
                                                         
                                                        </select>
                                                    </div>
                                                    
                                                    
                                                    <!--end::Col-->
                                                    <!--begin::Col-->
                                                    <div class="col-xxl-8">
                                                        <!--begin::Row-->
                                                        <div class="row g-8">
                                                            <!--begin::Col-->
                                                            <div class="col-lg-6">
                                                                <label class="fs-6 form-label fw-bolder text-dark">Order </label>
                                                                <!--begin::Select-->
                                                                <select class="form-select form-select-solid" data-placeholder="Order" name="orderby" onchange="load_reviews()">
                                                                   <option value="id desc">ID DESC</option>    
                                                                     <option value="id asc">ID ASC</option>
                                                                    <option value="name asc">Username ASC</option>
                                                                    <option value="name desc">Username DESC</option>
                                                                    <option value="datetime ASC">Datetime ASC</option>
                                                                    <option value="datetime desc">Datetime DESC</option>
                                                                    
                                                                </select>
                                                                <!--end::Select-->
                                                            </div>
                                                            <!--end::Col-->
                                                            <!--begin::Col-->
                                                            <div class="col-lg-6">
                                                                <label class="fs-6 form-label fw-bolder text-dark">Select Status</label>
                                                                <!--begin::Radio group-->
                                                                <div class="nav-group nav-group-fluid">
                                                                    <!--begin::Option-->
                                                                   <label class="fs-9">
                                                                        <input type="radio" class="btn-check" name="status" value="-1" onchange="load_reviews()">
                                                                        <span class="btn btn-sm btn-color-muted btn-active btn-active-primary fw-bolder px-4">All</span>
                                                                    </label>
                                                                    <!--end::Option-->
                                                                    <!--begin::Option-->
                                                                    <label class="fs-9">
                                                                        <input type="radio" class="btn-check" name="status" value="1" <?=$_GET['status'] == 1 ? 'checked' : ''?> onchange="load_reviews()">
                                                                        <span class="btn btn-sm btn-color-muted btn-active btn-active-primary fw-bolder px-4" >Published</span>
                                                                    </label>
                                                                    <!--end::Option-->
                                                                    <!--begin::Option-->
                                                                    <label class="fs-9">
                                                                        <input type="radio" class="btn-check" name="status" value="0" <?=$_GET['status'] == 0 ? 'checked' : ''?> onchange="load_reviews()">
                                                                        <span class="btn btn-sm btn-color-muted btn-active btn-active-primary fw-bolder px-4">Moderate</span>
                                                                    </label>
                                                                    <!--end::Option-->
                                                                </div>
                                                                <!--end::Radio group-->
                                                            </div>
                                                          
                                                           
                                                         
                                                            <!--end::Col-->
                                                        </div>
                                                        <!--end::Row-->
                                                    </div>
                                                   
                                                    <!--end::Col-->
                                                </div>
                                               
                                                </form>
                                            <!--begin::Content-->
                                    <div class="card mb-5 mb-xl-10">
                                
                                        <!--begin::Card header-->
                                        <div class="card-header min-h-unset py-2">
                                            <!--begin::Card title-->
                                            <h3 class="card-title align-items-start flex-column m-0">
                                                        <span class="card-label fw-bold text-gray-900">Applications</span>
                                                        <span class="text-gray-500 mt-1 fw-semibold fs-6">Applications settings can be changed on <a  href="admin?page=site">Site Settings page</a></span>
                                                    </h3>
                                            <!--end::Card title-->
                                        </div>
                                        <!--begin::Card header-->
                                        <!--begin::Content-->
                                        <div id="kt_account_settings_profile_details" class="collapse show">
                                            
                                    <div class="card-body py-3">
                                        <div class="table-responsive" data-select2-id="select2-data-145-mo44">
                                                <!--begin::Table-->
                                                
                                                <table  class="table align-middle table-bordered table-striped gs-0 gy-4 reviews_table">
                                                    <!--begin::Thead-->
                                                    <thead class="fw-bold text-muted bg-light">
                                                        <tr>
                                                                <th class="min-w-125px min-w-125px ps-5 text-center">ID</th>
                                                            <th class=" ps-9">Task/Bounty</th>
                                                            
                                                            <th class="min-w-275px">User</th>
                                                        
                                                            <th class="min-w-275px">Result</th>
                                                            
                                                            <th class="min-w-125px ps-5 text-center">Status</th>
                                                        
                                                            <th class="text-end ">Action</th>
                                                        </tr>
                                                    </thead>
                                                    <!--end::Thead-->
                                                    <!--begin::Tbody-->
                                                    <tbody class="fs-6 fw-bold text-gray-600">
                                                        
                                                    </tbody>
                                                    <!--end::Tbody-->
                                                    <tfoot>
                                                                <tr>
                                                                    <td colspan="9" class="text-center"><input type="button" class="btn btn-primary lmore" onclick="load_reviews()" value="Load More"></td>
                                                                </tr>
                                                            </tfoot>
                                                </table>
                                                <!--end::Table-->
                                            </div>
                                            <!--end::Table wrapper-->
                                            
                                            
                                        
                                        </div>
                                        <!--end::Content-->
                                    </div>
                                        <!--end::Content-->
                                        <!--begin::Sidebar-->
                                
                                        <!--end::Sidebar-->
                                    </div>
                                


<div class="modal fade" id="reviews_template" tabindex="-1" style="display: none;" aria-hidden="true">
    <!--begin::Modal dialog-->
    <div class="modal-dialog modal-dialog-centered mw-650px">
        <!--begin::Modal content-->
        <div class="modal-content">
            <!--begin::Modal header-->
            <div class="modal-header" id="kt_modal_create_api_key_header">
                <!--begin::Modal title-->
                <h2>Template</h2>
                <!--end::Modal title-->
                <!--begin::Close-->
                <div class="btn btn-sm btn-icon btn-active-color-primary" data-bs-dismiss="modal">
                    <!--begin::Svg Icon | path: images/icons/duotune/arrows/arr061.svg-->
                    <span class="svg-icon svg-icon-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <rect opacity="0.5" x="6" y="17.3137" width="16" height="2" rx="1" transform="rotate(-45 6 17.3137)" fill="currentColor"></rect>
                            <rect x="7.41422" y="6" width="16" height="2" rx="1" transform="rotate(45 7.41422 6)" fill="currentColor"></rect>
                        </svg>
                    </span>
                    <!--end::Svg Icon-->
                </div>
                <!--end::Close-->
            </div>
            <!--end::Modal header-->
            <!--begin::Form-->

            <!--begin::Modal body-->
            <div class="modal-body py-10 px-lg-17">
                <!--begin::Scroll-->
                <div class="scroll-y me-n7 pe-7" id="kt_modal_create_api_key_scroll" data-kt-scroll="true" data-kt-scroll-activate="{default: false, lg: true}" data-kt-scroll-max-height="auto">
                    <!--begin::Notice-->

                    <!--end::Notice-->
                    <div class="table-responsive">
                        <table  class="table table-row-dashed table-bordered table-bordered align-middle gs-0 gy-4 my-0">
                            <tbody id="tdata"></tbody>
                        </table>
                    </div>
                </div>
                <!--end::Scroll-->
            </div>
            <!--end::Modal body-->
            <!--begin::Modal footer-->
            <div class="modal-footer flex-center">
                <!--begin::Button-->
                <button type="reset" id="kt_modal_create_api_key_cancel" class="btn btn-light me-3" data-bs-dismiss="modal">Close</button>
                <!--end::Button-->
            </div>
            <!--end::Modal footer-->
            <div></div>
            <!--end::Form-->
        </div>
        <!--end::Modal content-->
    </div>
    <!--end::Modal dialog-->
</div>

<script type="text/javascript">
$("#edit_reviews_form").submit(function(e) {
    e.preventDefault();
    var form = $(this);
    $.ajax({
        type: "POST",
        url: "?page=ajax&h=edit_reivew",
        data: form.serialize(),
        success: function(data)
        {
          if(data.status) {
            Swal.fire({
        text: "Template Updated Successfully",
        icon: "success",
        buttonsStyling: false,
        confirmButtonText: "Ok, got it!",
        customClass: {
            confirmButton: "btn btn-primary"
        }
    });
            $("#edit_template").modal('hide');
            $("#edit_template_form").trigger('reset');
            load_templates();
          } else {
            alert("Server Error");
          }
        }
    });
});
function load_reviews() {
    $.ajax({
        async: true,
        url:'?page=ajax&h=applications',
        type:'POST',
        data: $("#topsearch").serialize(),
        success:function(data) {
            $(".reviews_table tbody").html(data.data);
            last_id = data.last_id;
            $("input[name=last_id]").val(data.last_id);
            $("#loader").hide();
         if(data.last_id == 0) {
                $(".lmore").hide();
            }
        }
    });
}
$(function() {
    load_reviews();
});
$( "#topsearch" ).submit(function( event ) {
    $(".reviews_table tbody").html('');
    $("input[name=last_id]").val(0);
    last_id = 0;
    load_reviews();
    event.preventDefault();
})

</script>   
<?
    } ?>

   
        
<?  }
 if ($_GET['page'] == 'faucets') { 
    if (isset($_GET['id']))
    {
        $e_id = $_GET['id'];
    }
    if (isset($_POST['submit']) && isset($_POST['action']) && $_POST['action'] == "update")
    {
        $content = mysqli_real_escape_string($DB_CONN, $_POST['review']);
        $Update = mysqli_query($DB_CONN, "UPDATE  transactions set  `status`='{$_POST['status']}' where id='$e_id'") or die(mysqli_error($DB_CONN));
        header("location: admin?page=reviews", true);
        echo "<div class=\"alert alert-success text-center\"> Updated Successfully</div>";

    }

    if (isset($_GET['action']) && $_GET['action'] == 'edit')
    {
        $review = mysqli_query($DB_CONN, "select * from transactions  where id = '{$e_id}'");
        $review = mysqli_fetch_assoc($review);
        if (true)
        {
?>
<div class="card">
    <div class="card-header">
        <div class="d-flex align-items-center">
                                                                
            <!--begin::Name-->
            <div class="d-flex justify-content-start flex-column">
                <a  class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6">Edit <span class=""><?=$review['id'] ?> </span></a>
                <a  class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                <span class="text-gray-900">User</span>: <span class="c_symbol"><?=$review['uname'] ?></span></a>
            </div>
            <!--end::Name-->
        </div>
    </div>
<div class="card-body">
<form id="edit_template_form" class="form fv-plugins-bootstrap5 fv-plugins-framework" method="post">
   
    <div class="form-group is-empty">
        <label for="domain" class="control-label ajax_label">
            Text
        </label>
 
         <textarea class="form-control form-control form-control-solid" data-kt-autosize="true" name="review" id="content"><?=$review['review'] ?></textarea>

                    </div>
                   
                   
                    <div class="separator separator-dashed my-2"></div>
                     <div class="form-group ">
                        <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Change <?=$review['id'] ?> Status</a>
                    <div class="fs-9 fw-semibold text-gray-500">Publish or Moderate Review.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="status" id="status" value="1" <?=$review['status'] == '1' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="status"></label>
                </div>
            </div>
        </div>
                  
                    </div>

                 </div>     <!--end::Scroll-->

                    <!--end::Modal body-->
                    <!--begin::Modal footer-->
                    <div class="card-footer flex-center">
                         <input type="hidden" name="action" value="update" />
                    <input type="hidden" name="id" value="<?=$e_id ?>" />
                
                   
                        <!--end::Button-->
                        <!--begin::Button-->
                        <button type="submit" id="kt_modal_create_api_key_submit" name="submit" class="btn btn-primary">
                            <span class="indicator-label">Submit</span>
                          
                        </button>
                        <!--end::Button-->
                    </div>
                    <!--end::Modal footer-->
                   
                    <div></div>
                </form>
                <!--end::Form-->
            </div>
</div>
<?
        }
    }
    else
    { ?>
                                
                                            <!--begin::Content-->
                                <div class="card">
    <div class="card-body p-0">
    <div class="table-responsive">
    <!--begin::Table-->
    <table  class="table table-rounded table-row-dashed  table-hover  table- gs-7">
                                                            <!--begin::Table head-->
                                                            <thead>
                                                                <tr class="fw-bold text-muted bg-light border-bottom border-gray-300">
                                                                    <th class=" ">ID</th>
                                                                    <th class="">Type</th>
                                                                    <th class="">Currency</th>
                                                                    <th class="">Amount</th>
                                                                    <th class="  ">Timestamp</th>
                
            </tr>
        </thead>
        <!--end::Table head-->
        <!--begin::Table body-->
        <tbody>
        <? $d = mysqli_query($DB_CONN, "SELECT *, (SELECT name FROM currencies WHERE id =  transactions.payment_method_id) as currency FROM `transactions` WHERE txn_type='faucet'  order by id desc");
                if (mysqli_num_rows($d))
                {
                    while ($tx = mysqli_fetch_assoc($d))
                    {
                     $sponsor = mysqli_fetch_assoc(mysqli_query($DB_CONN, "select username from users where id='{$tx['sponsor']}'"));
          $package = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT * from packages where id = '{$tx['package_id']}'"));
      $details = json_decode($package['details'], true);
       if ($details['faucet_type']=='auto'){?>
    
    <tr >
             <td class=" px-5 py-0  align-middle border-gray-500" <?if($tx['txn_id']){?>rowspan="3"<?}else{?>rowspan="2"<?}?> class="ps-0"><?=$tx['id']?></td>
                <td>
             
            </td>
        
        <td class="p-0">
                
                                                                <div class="d-flex align-items-center">
                                                                    <!--begin::Avatar-->
                                                                    <div class="symbol symbol-30px me-5">
                                                                        <img alt="<?=$tx['cname']?>" src="images/icons/<?=$tx['payment_method_id']?>.svg" width="15px">
                                                                    </div>
                                                                    <!--end::Avatar-->
                                                                    <!--begin::Name-->
                                                                    <div class="d-flex justify-content-start flex-column">
                                                                        <a  href="#" class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6">  <?=$tx['currency']?></a>
                                                                        <a  href="#" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                                                                        <span class="text-gray-900">Symbol</span>:  <?=$tx['symbol']?></a>
                                                                    </div>
                                                                    <!--end::Name-->
                                                                </div>
            
            </td >
            <td class="p-0">
                <a  class="text-gray-900 fw-bold text-hover-primary d-block mb-1 fs-6"><?=fiat($tx['amount'])?></a>
                <span class="text-muted fw-semibold text-muted d-block fs-7">Fee: <?=fiat($tx['fee'])?></span>
                
            
            </td>
            
            <td class="p-0">
                                                                                <span class="text-gray-900 fw-bold d-block fs-7"><?=$tx['timestamp'] ?></span>
                                                                                <span class="text-muted fw-semibold d-block fs-8"><?php $dt = date("M d, Y h:i:s A", strtotime($tx['timestamp']));
            echo time_elapsed_string($dt, true); ?></span>
                                                                            </td>
                                                                            
            </tr> 
         <tr >
            <td class="pb-1 pt-1 <? if($tx['txn_id']){?>  <? }else{ ?>border-gray-500<? } ?>">Details</td>
              <td class="pb-1 pt-1 <? if($tx['txn_id']){?>  <? }else{ ?>border-gray-500<? } ?>" colspan="6">
                                                                <span  class="badge badge-sm badge-light fs-12"><?=$tx['detail']?></span>
                                                            
                                                            </td>
                                                        
                                                        
        </tr>
    
    <tr >
            <td class="pb-1 pt-1 border-gray-500">Transaction</td>
            <td class="pb-1 pt-1 border-gray-500" colspan="6" ><span class="text-muted fw-semibold text-muted  fs-7"><?=$tx['packagename']?>    <?      switch($tx['status']) {
        case '0':?>
                <span class="badge badge-light-info">Pending</span>
         <? ; break; case '1'     ?>    
            <span class="badge badge-light-success"> Done</span>
            <? ; break; }?></span><a  href="<?=$tx['chain_url']?><?=$tx['txn_id']?>" target="_blank"><span class="badge badge-sm badge-light"><?=$tx['txn_id']?></span></a></td>
            
        </tr>
        <tr>
            <td> Faucet:</td>
             <td> <?=$details['faucet']['task']?>:</td>
        </tr>
        
<? }} ?>
                    
                                                            </tbody>
                                
     <?
}
else
{ ?>
        <tfoot>
                                                            
            <tr>
                <td> No Transactions found</td>
            </tr>                                           
                
                </tfoot>      
                <?
} ?>                            
                                                            <!--end::Table body-->
                                                        </table>
                                                        <!--end::Table-->
                                                    </div>
</div></div>
                                





<?
    } ?>

   
        
<?  } if ($_GET['page'] == 'support')
    {
        if (isset($_POST['ticket']))
        {
            $message = mysqli_real_escape_string($DB_CONN, $_POST['message']);
            $subject = mysqli_real_escape_string($DB_CONN, $_POST['subject']);
            $user_id = mysqli_real_escape_string($DB_CONN, $_POST['user_id']);
            mysqli_query($DB_CONN, "insert into tickets(subject, user_id,status) values('{$subject}', '{$user_id}','1')");
            $id = mysqli_insert_id($DB_CONN);
            mysqli_query($DB_CONN, "insert into ticket_replies(ticket_id,user_id, message, type) values('$id','{$user_id}' , '{$message}', 1)");
            $id = md5($id);
            $msg = "Ticket Created";
            $status = 'Open';
             sendmail("user_ticket_message", $user_id, false, array('id' => $id, 'msg' => $message, 'subject' => $subject, 'status' => $status ));
        }
        if (isset($_GET['id']))
        {
            if (isset($_GET['id']))
            {
                $id =$_GET['id'];
                $t = mysqli_query($DB_CONN, "select *, (select username from users where id = tickets.user_id) as user, (select type from ticket_replies where ticket_id = tickets.id order by id asc limit 1) as type from tickets where md5(id) = '{$id}'");
                $ticket = mysqli_fetch_assoc($t);
                $ticket_id = $ticket['id'];
                $user_id = $ticket['user_id'];
            }
            $id = $ticket_id;
            $eid = md5($id); 
            if (isset($_POST['submit']))
            {
                $message = mysqli_real_escape_string($DB_CONN, $_POST['message']);
                $q = mysqli_query($DB_CONN, "insert into ticket_replies(ticket_id, message, type) values('$id', '{$message}', 1)");
                
                if ($_POST['submit'] == 'close')   {
                    mysqli_query($DB_CONN, "update tickets set status = 2 where id = '{$id}'");
                        $msg = "Ticket Closed";
                        $status = 'Closed';
                        sendmail("user_ticket_reply", $user_id, false, array('id' => $eid, 'msg' => $message, 'subject' => $ticket['subject'], 'status' => $status ));
                }else
                    mysqli_query($DB_CONN, "update tickets set status = 1 where id = '{$id}'");
                $msg = "Ticket Updated";
                $status = 'Replied';
                sendmail("user_ticket_reply", $user_id, false, array('id' => $eid, 'msg' => $message, 'subject' => $ticket['subject'], 'status' => $status ));
            }

?>              
<div class="card" id="kt_chat_messenger">
    <!--begin::Card header-->
    <div class="card-header" id="kt_chat_messenger_header">
        <!--begin::Title-->
        <div class="card-title">
            <!--begin::User-->
            <div class="d-flex justify-content-center flex-column me-3">
                <a   class="fs-4 fw-bold  me-1 mb-2 lh-1"><span class="text-gray-900">Ticket:</span> <?=$ticket['subject'] ?></a>
                <span class="fs-7 fw-semibold text-muted">Created : <?=$ticket['datetime'] ?></span>
                <!--begin::Info-->
                <div class="mb-0 lh-1">
                    <span class="badge badge-success badge-circle w-10px h-10px me-1"></span>
                    <a  class="text-gray-900 fs-7" href="admin?page=user&id=<?=$ticket['user_id'] ?>&page=overview" target="_blank">User: <span class="fs-6 fw-semibold text-muted"> <?=$ticket['user'] ?></span></a>
                
                </div>
                <!--end::Info-->
            </div>
        
            <!--end::User-->
        </div>
        <!--end::Title-->
        <!--begin::Card toolbar-->
            
            <div class="card-toolbar">
               
                <? switch ($ticket['status'])
            {
                case 0:
                    echo '<span class="badge badge-success">Opened</span>';
                break;
                case 1:
                    echo '<span class="badge badge-warning">In Progress</span>';
                break;
                case 2:
                    echo '<span class="badge badge-danger">Closed</span>';
                break;
            } ?>
                        </div>
            </div>
            <!--end::Card header-->
            <?php if (isset($msg))
            {
                echo '<p class="btn btn-success btn-lg">' . $msg . '</p>';
            }
?>
                                                <!--begin::Card body-->
    <div class="card-body" id="kt_chat_messenger_body">
        <!--begin::Messages-->
        <div class="scroll-y me-n5 pe-5 h-300px h-lg-auto" data-kt-element="messages" data-kt-scroll="true" data-kt-scroll-activate="{default: false, lg: true}" data-kt-scroll-max-height="auto" data-kt-scroll-dependencies="#kt_header, #kt_app_header, #kt_app_toolbar, #kt_toolbar, #kt_footer, #kt_app_footer, #kt_chat_messenger_header, #kt_chat_messenger_footer" data-kt-scroll-wrappers="#kt_content, #kt_app_content, #kt_chat_messenger_body" data-kt-scroll-offset="5px" style="max-height: 505px;">
            <!--begin::Message(in)-->
            <?php
            $r = mysqli_query($DB_CONN, "select *,(select username from users where id = ticket_replies.user_id ) as username from ticket_replies where ticket_id = '{$id}'");
            while ($reply = mysqli_fetch_assoc($r))
            {

?>
                                        <? switch ($reply['type'])
                {
                    case 0: ?>
<div class="d-flex  justify-content-start  mb-10">
    <!--begin::Wrapper-->
    <div class="d-flex flex-column align-items-start">
        <!--begin::User-->
        <div class="d-flex align-items-center mb-2">
            <!--begin::Avatar-->
            
            <!--end::Avatar-->
            <!--begin::Details-->
            <div class="ms-3">
                <a  href="#" class="fs-5 fw-bold text-gray-900 text-hover-primary me-1"><?=$reply['username'] ?></a>
                <span class="text-muted fs-7 mb-1"><?php $dt = date("M d, Y h:i:s A", strtotime($reply['datetime'])); echo time_elapsed_string($dt, true); ?></span>
            </div>
            <!--end::Details-->
        </div>
        <!--end::User-->
        <!--begin::Text-->
        <div class="p-5 rounded bg-light-info text-gray-900 fw-semibold mw-lg-400px text-start" data-kt-element="message-text"><?=$reply['message'] ?></div>
        <!--end::Text-->
    </div>
    <!--end::Wrapper-->
</div>
<!--end::Message(in)-->         
                                <?;
                    break;
                    case 1:
?>                              <!--begin::Message(out)-->
                                                        <div class="d-flex justify-content-end mb-10">
                                                            <!--begin::Wrapper-->
                                                            <div class="d-flex flex-column align-items-end">
                                                                <!--begin::User-->
                                                                <div class="d-flex align-items-center mb-2">
                                                                    <!--begin::Details-->
                                                                    <div class="me-3">
                                                                        <span class="text-muted fs-7 mb-1"><?php $dt = date("M d, Y h:i:s A", strtotime($reply['datetime']));
                        echo time_elapsed_string($dt, true); ?></span>
                                                                        <a  href="#" class="fs-5 fw-bold text-gray-900 text-hover-primary ms-1">Admin</a>
                                                                    </div>
                                                                    <!--end::Details-->
                                                                    <!--begin::Avatar-->
                                                                    
                                                                    <!--end::Avatar-->
                                                                </div>
                                                                <!--end::User-->
                                                                <!--begin::Text-->
                                                                <div class="p-5 rounded bg-light-primary text-gray-900 fw-semibold mw-lg-400px text-end" data-kt-element="message-text"><?=$reply['message'] ?></div>
                                                                <!--end::Text-->
                                                            </div>
                                                            <!--end::Wrapper-->
                                                        </div>
                                                        <!--end::Message(out)-->
                                                        <!--begin::Message(in)-->
                                                        
                                    <?;
                    break;
                }
            }
?>  
                            
                                                    </div>
                                                    <!--end::Messages-->
                                                </div>
                                                <!--end::Card body-->
                                                <!--begin::Card footer-->
                                                <div class="card-footer pt-4" id="kt_chat_messenger_footer">
                                                    
                                <form method="post">
                            
                                                    
                                                    <textarea class="form-control form-control-flush mb-3" rows="1" name="message" placeholder="Enter your Reply here"></textarea>
                                                    
                                                        <div class="d-flex justify-content-end py-6 px-9">
                                                    
                                                        <button type="submit" class="btn btn-primary me-2"  name="submit"    >Reply</button>
                                                        <button type="submit" class="btn btn-secondary" name="submit"  value="close"   >Reply & Close</button>
                                                        
                                                        </div>
                                                    
                                                
                                                    </form>
                                                    
                                                    
                                                    <!--end::Toolbar-->
                                                </div>
                                                <!--end::Card footer-->
                                            </div>
                                            
                
            <?
        }
        else
        { ?>
            
                                    <div class="card mb-5 mb-xl-10">
                                        <!--begin::Card header-->
                                        <div class="card-header min-h-unset py-2" role="button" data-bs-toggle="collapse" data-bs-target="#kt_account_profile_details" aria-expanded="true" aria-controls="kt_account_profile_details">
                                            <!--begin::Card title-->
                                            <div class="card-title m-0">
                                                <h3 class="fw-bold m-0 fs-5">Support Tickets</h3>
                                            </div>
                                            <!--end::Card title-->
                                            <div class="card-toolbar">
                                                 <a  href="#" class="btn btn-sm fw-bold btn-primary" data-bs-toggle="modal" data-bs-target="#kt_modal_create_app">Create Ticket</a>
                                            </div>
                                        </div>
                                        <!--begin::Card header-->
                                        
                                        <div class="row g-5 g-xl-8">
                                        <div class="col-xl-3">
                                            <!--begin::Statistics Widget 5-->
                                            <a  href="#" class="card bg-body hoverable card-xl-stretch mb-xl-8">
                                                <!--begin::Body-->
                                                <div class="card-body p-2">
                                                    <i class="ki-duotone ki-chart-simple text-primary fs-2x ms-n1">
                                                        <span class="path1"></span>
                                                        <span class="path2"></span>
                                                        <span class="path3"></span>
                                                        <span class="path4"></span>
                                                    </i>
                                                        <div class="text-gray-900 fw-bold fs-2 mb-2 mt-1"><?=number_format($preferences['total_tickets']) ?></div>
    <div class="fw-semibold text-gray-400">Total Tickets</div>
                                                </div>
                                                <!--end::Body-->
                                            </a>
                                            <!--end::Statistics Widget 5-->
                                        </div>
                                        <div class="col-xl-3">
                                            <!--begin::Statistics Widget 5-->
                                            <a  href="#" class="card bg-dark hoverable card-xl-stretch mb-xl-8">
                                                <!--begin::Body-->
                                                <div class="card-body p-2">
                                                    <i class="ki-duotone ki-cheque text-gray-100 fs-2x ms-n1">
                                                        <span class="path1"></span>
                                                        <span class="path2"></span>
                                                        <span class="path3"></span>
                                                        <span class="path4"></span>
                                                        <span class="path5"></span>
                                                        <span class="path6"></span>
                                                        <span class="path7"></span>
                                                    </i>
                                                    <div class="text-gray-100 fw-bold fs-2 mb-2 mt-1"><?=number_format($preferences['pending_tickets']) ?></div>
<div class="fw-semibold text-gray-100">In Progress</div>
                                                </div>
                                                <!--end::Body-->
                                            </a>
                                            <!--end::Statistics Widget 5-->
                                        </div>
                                        <div class="col-xl-3">
                                            <!--begin::Statistics Widget 5-->
                                            <a  href="#" class="card bg-warning hoverable card-xl-stretch mb-xl-8">
                                                <!--begin::Body-->
                                                <div class="card-body p-2">
                                                    <i class="ki-duotone ki-briefcase text-white fs-2x ms-n1">
                                                        <span class="path1"></span>
                                                        <span class="path2"></span>
                                                    </i>
                                                   <div class="text-white fw-bold fs-2 mb-2 mt-1"><?=number_format($preferences['closed_tickets']) ?></div>
<div class="fw-semibold text-white">Completed</div>
                                                </div>
                                                <!--end::Body-->
                                            </a>
                                            <!--end::Statistics Widget 5-->
                                        </div>
                                        <div class="col-xl-3">
                                            <!--begin::Statistics Widget 5-->
                                            <a  href="#" class="card bg-info hoverable card-xl-stretch mb-5 mb-xl-8">
                                                <!--begin::Body-->
                                                <div class="card-body p-2">
                                                    <i class="ki-duotone ki-chart-pie-simple text-white fs-2x ms-n1">
                                                        <span class="path1"></span>
                                                        <span class="path2"></span>
                                                    </i>
                                                   <div class="text-white fw-bold fs-2 mb-2 mt-1"><?=number_format($preferences['new_tickets']) ?></div>
<div class="fw-semibold text-white">Pending</div>
                                                </div>
                                                <!--end::Body-->
                                            </a>
                                            <!--end::Statistics Widget 5-->
                                        </div>
                                    </div>
                                        <!--begin::Content-->
                                        <div id="kt_account_settings_profile_details" class="collapse show">
                                            
                                    <div class="card-body py-3">
                                        <div class="table-responsive">
                                    <table  id="default_order" class="table table-striped table-bordered">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Subject</th>
                                                <th>Last Message</th>
                                                <th>Username</th>
                                                <th>Status</th>
                                                <th>Created by</th>
                                                <th>Opened Date</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <?php
            $t = mysqli_query($DB_CONN, "select *, (select username from users where id = tickets.user_id) as user, (select message from ticket_replies where ticket_id = tickets.id order by id desc limit 1) as message, (select type from ticket_replies where ticket_id = tickets.id order by id asc limit 1) as type from tickets order by id desc");
            while ($ticket = mysqli_fetch_assoc($t))
            {
?>
                                            <tr>
                                                <td><a  href="admin?page=support&id=<?=md5($ticket['id']) ?>" class="font-bold link"><?=md5($ticket['id']) ?></a></td><td><a  href="admin?page=support&id=<?=md5($ticket['id']) ?>" class="font-medium link"><?=$ticket['subject'] ?></a></td>
                                                <td><?=$ticket['message'] ?></td>
                                                <td><a  href="admin?page=user&id=<?=$ticket['user_id'] ?>&view=overview" target="_blank"><?=$ticket['user'] ?></a></td>
                                                <td>
                                                    <? switch ($ticket['status'])
                {
                    case 0:
                        echo '<span class="badge badge-success">Opened</span>';
                    break;
                    case 1:
                        echo '<span class="badge badge-warning">In Progress</span>';
                    break;
                    case 2:
                        echo '<span class="badge badge-danger">Closed</span>';
                    break;
                } ?>
                                                    </td>
                                                <td><? echo $ticket['type'] ? "Agent" : "User" ?></td>
                                                <td><?=date("M d, Y H:i:s", strtotime($ticket['datetime'])) ?></td>
                                            </tr>
                                            
                                            <?php
            } ?>
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <th>ID</th>
                                                <th>Subject</th>
                                                <th>Last Message</th>
                                                <th>Username</th>
                                                <th>Status</th>
                                                <th>Created by</th>
                                                <th>Opened Date</th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                                            
                                            
                                        
                                        </div>
                                        <!--end::Content-->
                                    </div>
                        
            
                                        <!--end::Sidebar-->
                                    </div>
                                    
                                    <div class="modal fade " id="kt_modal_create_app" tabindex="-1" >
            <!--begin::Modal dialog-->
            <div class="modal-dialog modal-dialog-centered mw-900px">
                <!--begin::Modal content-->
                <div class="modal-content">
                    <!--begin::Modal header-->
                    <div class="modal-header">
                        <!--begin::Modal title-->
                        <h2>Create a Ticket</h2>
                        <!--end::Modal title-->
                        <!--begin::Close-->
                        <div class="btn btn-sm btn-icon btn-active-color-primary" data-bs-dismiss="modal">
                            <i class="ki-duotone ki-cross fs-1">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                        </div>
                        <!--end::Close-->
                    </div>
                    <!--end::Modal header-->
                    <!--begin::Modal body-->
                    <div class="modal-body py-lg-10 px-lg-10">
                        <!--begin::Stepper-->
    <form method="POST">
<div class="row">
    <div class="col-md-2 mb-2">
            <label class="fs-9"> User Name </label> 
        </div>
        <div class="col-md-10 mb-2">
            <select name="user_id" class="form-select ">
                <?php $select_user = mysqli_query($DB_CONN, "SELECT *from users");
            while ($row_user = mysqli_fetch_assoc($select_user))
            { ?>
                        <option value="<?php echo $row_user['id'] ?>"> <?php echo $row_user['username'] ?> </option>
                <?php
            } ?>    
            </select> 
</div>
<div class="col-md-2 mb-2">
            <label class="fs-9"> Subject </label> 
        </div>
        <div class="col-md-10 mb-2">
            <input type="text" name="subject" id="subject" class="form-control"> 
        </div>
<div class="col-md-2 mb-2">
            <label class="fs-9"> Message </label>
        </div>
        <div class="col-md-10 mb-2">
            <textarea id="mymce" name="message" class="form-control"></textarea>
</div>
</div>
</div>
<div class="modal-footer">
        <input type="submit" name="ticket" class="btn btn-primary" value="Create Ticket">
        </div> 
            </form>
                        <!--end::Stepper-->
                    </div>
                    <!--end::Modal body-->
                </div>
                <!--end::Modal content-->
            </div>
    
                                     <?
        } ?>    
                            
                        
<?
    }
    if ($_GET['page'] == 'user')
    {
        if (isset($_GET['id']))
        {
            $user_id = $_GET['id'];
            $select_detail = mysqli_query($DB_CONN, "select *, (SELECT sum(amount) FROM `transactions` where txn_type = 'referral' AND user_id = users.id) as referral, (SELECT country FROM `login_report` where user_id = users.id order by login_report.datetime limit 1 ) as countryip, (SELECT sum(amount) FROM `transactions` where txn_type = 'invest' AND user_id = users.id) as invest,(SELECT sum(amount) FROM `package_deposits` where status = '1' AND user_id = users.id) as activeinvest, (SELECT sum(amount) FROM `transactions` where txn_type = 'withdraw' AND user_id = users.id) as withdraw, (SELECT sum(amount) FROM `transactions` where txn_type = 'earning' AND user_id = users.id) as earnings, (SELECT sum(amount) FROM `transactions` where txn_type = 'faucet' AND user_id = users.id) as faucetclaimed, (SELECT sum(balance) FROM `user_balances` where user_id = users.id) as balance, (SELECT sum(faucet) FROM `user_balances` where user_id = users.id) as faucetbalance, (SELECT name FROM `payment_methods` where id = users.wi_pm_id) as processor FROM `users` where id= '$user_id'");
            $row_detail = mysqli_fetch_assoc($select_detail);

            $slct_sponsor = mysqli_fetch_assoc(mysqli_query($DB_CONN, "select username from users where id='{$row_detail['sponsor']}' "));
        
?>

                                    <!--begin::Navbar-->
                                    <div class="card mb-5 mb-xxl-8">
                                        <div class="card-body pt-9 pb-0">
                                            <!--begin::Details-->
                                            <div class="d-flex flex-wrap flex-sm-nowrap">
                                                <!--begin: Pic-->
                                            
                                                <!--end::Pic-->
                                                <!--begin::Info-->
                                                <div class="flex-grow-1">
                                                    <!--begin::Title-->
                                                    <div class="d-flex justify-content-between align-items-start flex-wrap mb-2" >
                                                        <!--begin::User-->
                                                        <div class="d-flex flex-column">
                                                            <!--begin::Name-->
                                                            <div class="d-flex align-items-center mb-2">
                                                                <a   class="text-gray-900 text-hover-primary fs-2 fw-bold me-1"><?php echo $row_detail['username'] ?></a>
                                                                <a  >
                                                                    <i class="ki-duotone ki-verify fs-1 text-primary">
                                                                        <span class="path1"></span>
                                                                        <span class="path2"></span>
                                                                    </i>
                                                                </a>
                                                                <?if($row_detail['kyc'] == '1'){ ?>                                                            
                                                                    <i class="ki-duotone ki-fingerprint-scanning fs-2 text-success" title="KYC">
                                                                         <span class="path1"></span>
                                                                         <span class="path2"></span>
                                                                         <span class="path3"></span>
                                                                         <span class="path4"></span>
                                                                         <span class="path5"></span>
                                                                    </i>
                                                            
                                                             
                                                                <?php } if ($row_detail['invest'] && $row_detail['activeinvest']) {?>
                                                                <a  title="Invested & Active">
                                                                    <i class="ki-duotone ki-dollar fs-1 text-success">
                                                                        <span class="path1"></span>
                                                                        <span class="path2"></span>
                                                                        <span class="path3"></span>
                                                                    </i>
                                                                </a>
                                                                <? }elseif($row_detail['invest']){ ?>
                                                                <a  title="Invested">
                                                                    <i class="ki-duotone ki-dollar fs-1">
                                                                        <span class="path1"></span>
                                                                        <span class="path2"></span>
                                                                        <span class="path3"></span>
                                                                    </i>
                                                                </a>
                                                                <? }?>
                                                                
                                                            </div>
                                                            <!--end::Name-->
                                                            <!--begin::Info-->
                                                            <div class="d-flex flex-wrap fw-semibold fs-6 mb-1 pe-2">
                                                                <a  href="#" class="d-flex align-items-center text-gray-500 text-hover-primary me-5 mb-2" title="Full Name">
                                                                <i class="ki-duotone ki-profile-circle fs-4 me-1">
                                                                    <span class="path1"></span>
                                                                    <span class="path2"></span>
                                                                    <span class="path3"></span>
                                                                </i><?php echo $row_detail['fullname'] ?></a>
                                                                <a  href="#" class="d-flex align-items-center text-gray-500 text-hover-primary me-5 mb-2" title="Country">
                                                                <i class="ki-duotone ki-geolocation fs-4 me-1">
                                                                    <span class="path1"></span>
                                                                    <span class="path2"></span>
                                                                </i><?php echo $row_detail['countryip'] ?></a>
                                                                
                                                                    <a  href="#" class="d-flex align-items-center text-gray-500 text-hover-primary me-5 mb-2" title="2FA">
                                                                <i class="ki-duotone ki-duotone ki-shield-tick fs-4 me-1">
                                                                    <span class="path1"></span>
                                                                    <span class="path2"></span>
                                                                </i><?php if ($row_detail['2fa'] != '')
            { ?> 2FA Enabled <?
            }
            else
            { ?>  2FA Disabled <?
            } ?> </a>
                                                                    <a  href="#" class="d-flex align-items-center text-gray-500 text-hover-primary mb-2" title="Withdraw">
                                                            <i class="ki-duotone ki-bank fs-4 me-1">
 <span class="path1"></span>
 <span class="path2"></span>

</i>    <?php if ($row_detail['auto_withdraw'] == '1')
            {
                echo "Auto Enabled";

            }
            elseif ($row_detail['auto_withdraw'] == '2')
            {
                echo " Auto Disable  ";
            }
            elseif ($row_detail['auto_withdraw'] == '3')
            {
                echo " Instant Disabled";
            }elseif ($row_detail['auto_withdraw'] == '4')
            {
                echo "Fake Hash ";
            }
            else
            
            {
                echo "Default";
            } ?></a>
                                                                
                                                            </div>
                                                            <div class="d-flex flex-wrap fw-semibold fs-6 mb-1 pe-2">
                                                                <?php if($row_detail['sponsor']) { ?>   <a  href="admin?page=user&id=<?php echo $row_detail['sponsor'] ?>&view=overview" class="d-flex align-items-center text-gray-500 text-hover-primary me-5 mb-2" title="Sponsor/Upline">
                                                            <i class="ki-duotone ki-profile-user fs-4 me-1">
                                                                    <span class="path1"></span>
                                                                    <span class="path2"></span>
                                                                    <span class="path3"></span>
                                                                </i><?php echo $slct_sponsor['username'] ?></a><? } ?>
                                                                <a  href="#" class="d-flex align-items-center text-gray-500 text-hover-primary me-5 mb-2" title="Email">
                                                            <i class="ki-duotone ki-sms fs-4 me-1">
                                                                    <span class="path1"></span>
                                                                    <span class="path2"></span>
                                                                    <span class="path3"></span>
                                                                </i><?php echo $row_detail['email'] ?></a>
                                                        
                                                                
                                                                    
                                                                
                                                                    
                                                                
                                                            </div>
                                                            <div class="d-flex flex-wrap fw-semibold fs-6 mb-1 pe-2">
                                                                <?php if($row_detail['tier']) { ?>  <a  href="#" class="d-flex align-items-center text-gray-500 text-hover-primary me-5 mb-2" title="Referral Tier">
                                                                <i class="ki-duotone ki-user-tick ">
                                                                     <span class="path1"></span>
                                                                     <span class="path2"></span>
                                                                     <span class="path3"></span>
                                                                    </i>Ref Tier : <?php echo get_tier($row_detail['id']) ?></a><? } ?>
                                                                    <?php if($row_detail['level']) { ?> <a  href="#" class="d-flex align-items-center text-gray-500 text-hover-primary me-5 mb-2" title="Referral Tier">
                                                                <i class="ki-duotone ki-user-tick ">
                                                                     <span class="path1"></span>
                                                                     <span class="path2"></span>
                                                                     <span class="path3"></span>
                                                                    </i>Level : <?php echo get_level($row_detail['id']) ?></a><? } ?>
                                                            <?php if($row_detail['came_from']) { ?> <a  href="#" class="d-flex align-items-center text-gray-500 text-hover-primary me-5 mb-2" title="Came From">
                                                                Came From: <?php echo $row_detail['came_from']; ?></a> <? } ?>
                                                                
                                                                    
                                                                
                                                                    
                                                                
                                                            </div>
                                                            
                                                            <!--end::Info-->
                                                        </div>
                                                        <!--end::User-->
                                                        <!--begin::Actions-->
                                                        <div class="d-flex my-4">
                                                        
                                                
                                                            <!--begin::Menu-->
                                                    
                                                            <!--end::Menu-->
                                                        </div>
                                                        <!--end::Actions-->
                                                    </div>
                                                    <!--end::Title-->
                                                    <!--begin::Stats-->
                                                
                                                    <!--end::Stats-->
                                                </div>
                                                <!--end::Info-->
                                            </div>
                                            <!--end::Details-->
                                            <!--begin::Navs-->
                                            <ul class="nav nav-stretch nav-line-tabs nav-line-tabs-2x border-transparent fs-5 fw-bold">
                                                <!--begin::Nav item-->
                                                <li class="nav-item mt-2">
                                                    <a  class="nav-link text-active-primary ms-0 me-10 py-5 <? if ($_GET['view'] == 'overview')
            { ?>active <?
            } ?>" href="admin?page=user&id=<?=$user_id ?>&view=overview">Overview</a>
                                                </li>
                                                <!--end::Nav item-->
                                                <!--begin::Nav item-->
                                                <li class="nav-item mt-2">
                                                    <a  class="nav-link text-active-primary ms-0 me-10 py-5 <? if ($_GET['view'] == 'tree')
            { ?>active <?
            } ?>" href="admin?page=user&id=<?=$user_id ?>&view=tree">Referral Tree</a>
                                                </li>
                                                <!--end::Nav item-->
                                                <!--begin::Nav item-->
                                                <li class="nav-item mt-2">
                                                    <a  class="nav-link text-active-primary ms-0 me-10 py-5 <? if ($_GET['view'] == 'transactions')
            { ?>active <?
            } ?>" href="admin?page=user&id=<?=$user_id ?>&view=transactions">Transactions</a>
                                                </li>
                                                <!--end::Nav item-->
                                                <!--begin::Nav item-->
                                                <li class="nav-item mt-2">
                                                    <a  class="nav-link text-active-primary ms-0 me-10 py-5 <? if ($_GET['view'] == 'investments')
            { ?>active <?
            } ?>" href="admin?page=user&id=<?=$user_id ?>&view=investments">Investments</a>
                                                </li>
                                                <!--end::Nav item-->
                                                <!--begin::Nav item-->
                                                <li class="nav-item mt-2">
                                                    <a  class="nav-link text-active-primary ms-0 me-10 py-5 <? if ($_GET['view'] == 'edit')
            { ?>active <?
            } ?>" href="admin?page=user&id=<?=$user_id ?>&view=edit">Edit Profile</a>
                                                </li>
                                                <!--end::Nav item-->
                                                <!--begin::Nav item-->
                                                <li class="nav-item mt-2">
                                                    <a  class="nav-link text-active-primary ms-0 me-10 py-5 <? if ($_GET['view'] == 'logs')
            { ?>active <?
            } ?>" href="admin?page=user&id=<?=$user_id ?>&view=logs">Login Report</a>
                                                </li>
                                                
                                                <li class="nav-item mt-2">
                                                    <a  class="nav-link text-active-primary ms-0 me-10 py-5 <? if ($_GET['view'] == 'activities')
            { ?>active <?
            } ?>" href="admin?page=user&id=<?=$user_id ?>&view=activities">Activities</a>
                                                </li>
                                                <!--end::Nav item-->
                                            </ul>
                                            <!--begin::Navs-->
                                        </div>
                                    </div>
                                    <!--end::Navbar-->
                            
                                    <? if ($_GET['view'] == 'overview')

            { ?>                
                                    <!--begin::Row-->
                                    <div class="row g-5 g-xxl-8">
                                      
                                        <!--begin::Col-->
                                        <div class="col-xl-6">
                                    

                                            <div class="card mb-5 mb-xl-10" id="kt_profile_details_view">
    <!--begin::Card header-->
   <div class="card-header border-0 pt-5">
        <h3 class="card-title align-items-start flex-column">
            <span class="card-label fw-bold text-gray-900">Balances</span>

            <span class="text-muted mt-1 fw-semibold fs-7">Balances Details </span>
        </h3>

        <div class="card-toolbar">
            <!--begin::Menu-->
            <button type="button" class="btn btn-sm btn-icon btn-color-primary btn-active-light-primary" data-kt-menu-trigger="click" data-kt-menu-placement="bottom-end">
                <i class="ki-duotone ki-category fs-6"><span class="path1"></span><span class="path2"></span><span class="path3"></span><span class="path4"></span></i>            </button>
            
<!--begin::Menu 3-->
<div class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-800 menu-state-bg-light-primary fw-semibold w-200px py-3" data-kt-menu="true">
    <!--begin::Heading-->
    <div class="menu-item px-3">
        <div class="menu-content text-muted pb-2 px-3 fs-7 text-uppercase">
            Payments
        </div>
    </div>

    <!--end::Menu item-->
</div>
<!--end::Menu 3-->
            <!--end::Menu-->
        </div>
    </div>
    <!--begin::Card header-->

    <!--begin::Card body-->
                        <div class="card-body p-9">
    <div class="d-flex align-items-center mb-8 border-bottom">
        <div class="flex-grow-1">
            <a  href="admin?page=transactions&user_id=<?=$user_id?>" class="text-gray-800 text-hover-primary fw-bold fs-6" data-bs-toggle="tooltip" data-bs-placement="top" title="View" target="_blank">
               <i class="ki-duotone ki-notepad fs-2">
                        <span class="path1"></span>
                <span class="path2"></span>
                <span class="path3"></span>
                <span class="path4"></span>
                <span class="path5"></span>
            </i>
                Account Balance
            </a>
     
        </div>

        <!--end::Description-->
        <span class="badge badge-light-primary my-2 fs-5 fw-bold"><?php echo fiat($row_detail['balance']) ?></span>
    </div>
    <div class="d-flex align-items-center mb-2 border-bottom">
        <div class="flex-grow-1">
            <a  href="admin?page=transactions&user_id=<?=$user_id?>&txn_type=earnings" class="text-gray-800 text-hover-primary fw-bold fs-6" data-bs-toggle="tooltip" data-bs-placement="top" title="View" target="_blank">
               <i class="ki-duotone ki-notepad fs-2">
                        <span class="path1"></span>
                <span class="path2"></span>
                <span class="path3"></span>
                <span class="path4"></span>
                <span class="path5"></span>
            </i>
                Total Investments
            </a>
        
        </div>

        <!--end::Description-->
        <span class="badge badge-light-info fs-8 fw-bold"><?php echo fiat($row_detail['invest']) ?></span>
    </div>
    <div class="d-flex align-items-center mb-2 border-bottom">
        <div class="flex-grow-1">
            <a  href="admin?page=transactions&user_id=<?=$user_id?>&txn_type=invest" class="text-gray-800 text-hover-primary fw-bold fs-6" data-bs-toggle="tooltip" data-bs-placement="top" title="View" target="_blank">
               <i class="ki-duotone ki-notepad fs-2">
                        <span class="path1"></span>
                <span class="path2"></span>
                <span class="path3"></span>
                <span class="path4"></span>
                <span class="path5"></span>
            </i>
                Active Investments</a>
           
        </div>
          <a  href="admin?page=transaction&user_id=<?php echo $row_detail['username'] ?>&type=bonus" class=" me-1" target="_blank"><i class="ki-duotone text-success ki-message-add fs-1">
 <span class="path1"></span>
 <span class="path2"></span>
 <span class="path3"></span>
</i></a>
        <a  href="admin?page=user&id=<?=$user_id?>&view=investments" class="btn btn-sm btn-success py-1 px-2 me-1 fs-9">Manage</a>
        <!--end::Description-->
        <span class="badge badge-light-success my-2 fs-6 fw-bold"><?php echo fiat($row_detail['activeinvest']) ?></span>
        
    </div>
    <div class="d-flex align-items-center mb-2 border-bottom">
        <div class="flex-grow-1">
            <a  href="admin?page=transactions&user_id=<?=$user_id?>&txn_type=deposit" class="text-gray-800 text-hover-primary fw-bold fs-6" data-bs-toggle="tooltip" data-bs-placement="top" title="View" target="_blank">
               <i class="ki-duotone ki-notepad fs-2">
                        <span class="path1"></span>
                <span class="path2"></span>
                <span class="path3"></span>
                <span class="path4"></span>
                <span class="path5"></span>
            </i>
              Total  Deposits
            </a>
 
        </div>
        <!--end::Description-->
        <span class="badge badge-light-info fs-8 fw-bold"><?php echo fiat($row_detail['topup']) ?></span>
    </div>
    <div class="d-flex align-items-center mb-2 border-bottom">
        <div class="flex-grow-1">
            <a  href="admin?page=transactions&user_id=<?=$user_id?>&txn_type=earning" class="text-gray-800 text-hover-primary fw-bold fs-6" data-bs-toggle="tooltip" data-bs-placement="top" title="View" target="_blank">
               <i class="ki-duotone ki-notepad fs-2">
                        <span class="path1"></span>
                <span class="path2"></span>
                <span class="path3"></span>
                <span class="path4"></span>
                <span class="path5"></span>
            </i>
               Total Earnings
            </a>
     
        </div>
        <!--end::Description-->
          <a  href="admin?page=transaction&user_id=<?php echo $row_detail['username'] ?>&type=e" class=" me-1" target="_blank"><i class="ki-duotone text-info ki-message-add fs-1">
 <span class="path1"></span>
 <span class="path2"></span>
 <span class="path3"></span>
</i></a>
        <span class="badge badge-light-success fs-7 fw-bold"><?php echo fiat($row_detail['earnings']) ?></span>
    </div>
    <div class="d-flex align-items-center mb-2 border-bottom">
        <div class="flex-grow-1">
            <a  href="admin?page=transactions&user_id=<?=$user_id?>&txn_type=referral" class="text-gray-800 text-hover-primary fw-bold fs-6" data-bs-toggle="tooltip" data-bs-placement="top" title="View" target="_blank">
                <i class="ki-duotone ki-notepad fs-2">
                        <span class="path1"></span>
                <span class="path2"></span>
                <span class="path3"></span>
                <span class="path4"></span>
                <span class="path5"></span>
            </i>
             Total  Commissions
            </a>
       
        </div>
         <a  href="admin?page=transaction&user_id=<?php echo $row_detail['username'] ?>&type=c" class=" me-1" target="_blank"><i class="ki-duotone text-info ki-message-add fs-1">
 <span class="path1"></span>
 <span class="path2"></span>
 <span class="path3"></span>
</i></a>
        <!--end::Description-->
        <span class="badge badge-light-info fs-8 fw-bold"><?php echo fiat($row_detail['referral']) ?></span>
    </div>
    <div class="d-flex align-items-center mb-2 border-bottom">
        <div class="flex-grow-1">
            <a  href="admin?page=transactions&user_id=<?=$user_id?>&txn_type=bonus" class="text-gray-800 text-hover-primary fw-bold fs-6" data-bs-toggle="tooltip" data-bs-placement="top" title="View" target="_blank">
               <i class="ki-duotone ki-notepad fs-2">
                        <span class="path1"></span>
                <span class="path2"></span>
                <span class="path3"></span>
                <span class="path4"></span>
                <span class="path5"></span>
            </i>
              Total  Bonuses
            </a>
      
        </div>
          <a  href="admin?page=transaction&user_id=<?php echo $row_detail['username'] ?>&type=b" class=" me-1" target="_blank"><i class="ki-duotone text-info ki-message-add fs-1">
 <span class="path1"></span>
 <span class="path2"></span>
 <span class="path3"></span>
</i></a>
        <!--end::Description-->
        <span class="badge badge-light-info fs-8 fw-bold"><?php echo fiat($row_detail['bonus']) ?></span>
    </div>
    <div class="d-flex align-items-center mb-2 border-bottom">
        <div class="flex-grow-1">
            <a  href="admin?page=transactions&user_id=<?=$user_id?>&txn_type=penalty" class="text-gray-800 text-hover-primary fw-bold fs-6" data-bs-toggle="tooltip" data-bs-placement="top" title="View" target="_blank">
                <i class="ki-duotone ki-notepad fs-2">
                        <span class="path1"></span>
                <span class="path2"></span>
                <span class="path3"></span>
                <span class="path4"></span>
                <span class="path5"></span>
            </i>
              Total  Penalties
            </a>
       
        </div>
          <a  href="admin?page=transaction&user_id=<?php echo $row_detail['username'] ?>&type=p" class=" me-1" target="_blank"><i class="ki-duotone text-warning ki-message-add fs-1">
 <span class="path1"></span>
 <span class="path2"></span>
 <span class="path3"></span>
</i></a>
        <!--end::Description-->
        <span class="badge badge-light-warning fs-8 fw-bold"><?php echo fiat($row_detail['penalty']) ?></span>
    </div>
    <div class="d-flex align-items-center mb-2 border-bottom">
        <div class="flex-grow-1">
            <a  href="admin?page=transactions&user_id=<?=$user_id?>&txn_type=withdraw" class="text-gray-800 text-hover-primary fw-bold fs-6" data-bs-toggle="tooltip" data-bs-placement="top" title="View" target="_blank">
               <i class="ki-duotone ki-notepad fs-2">
                        <span class="path1"></span>
                <span class="path2"></span>
                <span class="path3"></span>
                <span class="path4"></span>
                <span class="path5"></span>
            </i>
              Total  Withdrawals
            </a>
       
        </div>
        <a  href="admin?page=transaction&user_id=<?php echo $row_detail['username'] ?>&type=w" class=" btn btn-sm btn-danger py-1 px-2 me-1 fs-9" target="_blank"> Request </a>
        <!--end::Description-->
        <span class="badge badge-light-danger fs-6 fw-bold"><?php echo fiat($row_detail['withdraw']) ?></span>
    </div>
    <div class="d-flex align-items-center mb-2 border-bottom">
        <div class="flex-grow-1">
            <a  href="admin?page=pending_withdrawals" class="text-gray-800 text-hover-primary fw-bold fs-6" data-bs-toggle="tooltip" data-bs-placement="top" title="View" target="_blank">
               <i class="ki-duotone ki-notepad fs-2">
                        <span class="path1"></span>
                <span class="path2"></span>
                <span class="path3"></span>
                <span class="path4"></span>
                <span class="path5"></span>
            </i>
             Pending Withdraw
            </a>
    
        </div>
        <!--end::Description-->
        <span class="badge badge-light-warning fs-5 fw-bold"><?php echo fiat($row_detail['withdrawpending']) ?></span>
    </div>
    <div class="d-flex align-items-center mb-2 border-bottom">
        <div class="flex-grow-1">
            <a  href="admin?page=pending_withdrawals" class="text-gray-800 text-hover-primary fw-bold fs-6" data-bs-toggle="tooltip" data-bs-placement="top" title="View" target="_blank">
               <i class="ki-duotone ki-notepad fs-2">
                        <span class="path1"></span>
                <span class="path2"></span>
                <span class="path3"></span>
                <span class="path4"></span>
                <span class="path5"></span>
            </i>
             Faucet Balance
            </a>
    
        </div>
        <!--end::Description-->
        <span class="badge badge-light-warning fs-5 fw-bold"><?php echo fiat($row_detail['faucetbalance']) ?></span>
    </div>
    <div class="d-flex align-items-center mb-2 border-bottom">
        <div class="flex-grow-1">
            <a  href="admin?page=pending_withdrawals" class="text-gray-800 text-hover-primary fw-bold fs-6" data-bs-toggle="tooltip" data-bs-placement="top" title="View" target="_blank">
               <i class="ki-duotone ki-notepad fs-2">
                        <span class="path1"></span>
                <span class="path2"></span>
                <span class="path3"></span>
                <span class="path4"></span>
                <span class="path5"></span>
            </i>
             Fauet Claimed
            </a>
    
        </div>
        <!--end::Description-->
        <span class="badge badge-light-warning fs-5 fw-bold"><?php echo fiat($row_detail['faucetclaimed']) ?></span>
    </div>
</div>

    <!--end::Card body-->     
</div>

                                            <!--begin::Feeds Widget 1-->
                                    
                        
                                        </div>
                                        <!--end::Col-->
                                        <!--begin::Col-->
                                        <div class="col-xl-6">
                                            <!--begin::Charts Widget 1-->
                                        <div class="card  mb-xl-8">
    <!--begin::Header-->
    <div class="card-header border-0 pt-5">
        <h3 class="card-title align-items-start flex-column">
            <span class="card-label fw-bold text-gray-900">Wallets</span>

            <span class="text-muted mt-1 fw-semibold fs-7">Wallets and Balances</span>
        </h3>

        <div class="card-toolbar">
            <!--begin::Menu-->
            <button type="button" class="btn btn-sm btn-icon btn-color-primary btn-active-light-primary" data-kt-menu-trigger="click" data-kt-menu-placement="bottom-end">
                <i class="ki-duotone ki-category fs-6"><span class="path1"></span><span class="path2"></span><span class="path3"></span><span class="path4"></span></i>            </button>
            
<!--begin::Menu 3-->
<div class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-800 menu-state-bg-light-primary fw-semibold w-200px py-3" data-kt-menu="true">
    <!--begin::Heading-->
    <div class="menu-item px-3">
        <div class="menu-content text-muted pb-2 px-3 fs-7 text-uppercase">
            Payments
        </div>
    </div>

    <!--end::Menu item-->
</div>
<!--end::Menu 3-->
            <!--end::Menu-->
        </div>
    </div>
    <!--end::Header-->

    <!--begin::Body-->
    <div class="card-body pt-5">

         <?php
        
            $wallets = json_decode($row_detail['wallets'], true);
$p = mysqli_query($DB_CONN, "SELECT * FROM `currencies` WHERE de_pm_id or wi_pm_id group by name order by id");

while($pm = mysqli_fetch_assoc($p)) {
    $bal = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT * FROM `user_balances` WHERE payment_method_id ='{$pm['id']}' and user_id = '$user_id'"));
  $str = strtolower(str_replace(' ','',$pm['name']));
if($bal || $wallets[$str]){
?>            
            <!--begin::Item-->
            <div class="d-flex align-items-sm-center mb-2">
                <!--begin::Symbol-->
                <div class="symbol symbol-40px me-1">
                    <span class="symbol-label">
                        <img src="images/icons/<?=$pm['id'] ?>.svg" class="h-50 align-self-center" alt="">                         
                    </span>
                </div>
                <!--end::Symbol-->

                <!--begin::Section-->
                <div class="d-flex align-items-center flex-row-fluid flex-wrap">                    
                    <div class="flex-grow-1 me-2">
                        <a  href="#" class="text-gray-800 text-hover-primary fs-6 fw-bold">   <?=$pm['name'] ?></a>
                        
                        <span class="text-muted fw-semibold d-block fs-7"><?php echo $wallets[$str] ?></span>
                    </div>                     

                    <span class="badge <?php if($bal){?>badge-success <?}else{?> badge-light <?} ?> my-2 fs-7"><?php echo amount_format($bal['balance']) ?></span> 
                    <a  href="admin?page=user&id=<?=$user_id?>&view=exchange&amount=<?php echo amount_format($bal['balance']) ?>&currency=<?=$pm['id'] ?>" class=" btn btn-sm btn-warning py-1 px-2 ms-1 fs-9" target="_blank"> Exchange </a>
                    
                </div>
                <!--end::Section-->                
            </div>
            <!--end::Item-->
           
                   <?
        
}}
?>

    </div>
    <!--end::Body-->
</div>

                    <!--end::Charts Widget 1-->
                                            <!--begin::List Widget 5-->
                                    
                                            <!--end: List Widget 5-->
                                        </div>
                                        <!--end::Col-->
                                    </div>
                                    <!--end::Row-->
                                    <div class="row g-5 g-xxl-8">
                                        <div class="card mb-5 mb-lg-10">
    <!--begin::Card header-->
    <div class="card-header min-h-unset p-0">
        <!--begin::Heading-->
        <div class="card-title py-2">
             <span class="fs-9 "> Last 10</span> <h3> Transactions </h3>
          
        </div>
        <!--end::Heading-->

        <!--begin::Toolbar-->
        <div class="card-toolbar">
          

            <a  href="admin?page=user&id=<?=$user_id
?>&view=transactions" class="btn btn-sm btn-primary my-1">
                View All
            </a>
        </div>
        <!--end::Toolbar-->
    </div>
    <!--end::Card header-->

    <!--begin::Card body-->
   <div class="card">
    <div class="card-body p-0">
    <div class="table-responsive">
                                                        <!--begin::Table-->
                                                        <table  class="table table-rounded table-row-dashed  table-hover  table- gs-7">
                                                            <!--begin::Table head-->
                                                            <thead>
                                                                <tr class="fw-bold text-muted bg-light border-bottom border-gray-300">
                                                                    <th class=" ">ID</th>
                                                                    <th class="">Type</th>
                                                                    <th class="">Currency</th>
                                                                    <th class="">Amount</th>
                                                                    <th class="  ">Timestamp</th>
                                                                    
                                                                </tr>
                                                            </thead>
                                                            <!--end::Table head-->
                                                            <!--begin::Table body-->
                                                            <tbody>
                                                            <? $d = mysqli_query($DB_CONN, "SELECT *, (SELECT name FROM currencies WHERE id =  transactions.payment_method_id) as currency, (SELECT chain_url FROM currencies WHERE id =  transactions.payment_method_id) as chain_url FROM `transactions` WHERE user_id ='$user_id'    order by id desc limit 10");
                if (mysqli_num_rows($d))
                {
                    while ($tx = mysqli_fetch_assoc($d))
                    { ?>
    
    <tr >
             <td class=" px-5 py-0  align-middle border-gray-500" <?if($tx['txn_id']){?>rowspan="3"<?}else{?>rowspan="2"<?}?> class="ps-0"><?=$tx['id']?></td>
                <td class="p-0 text-center align-middle">
             <? echo getBadge($tx['txn_type']); ?>
            </td>
        
            
        <td class="p-0">
                
                                                                <div class="d-flex align-items-center">
                                                                    <!--begin::Avatar-->
                                                                    <div class="symbol symbol-30px me-5">
                                                                        <img alt="<?=$tx['cname']?>" src="images/icons/<?=$tx['payment_method_id']?>.svg" width="15px">
                                                                    </div>
                                                                    <!--end::Avatar-->
                                                                    <!--begin::Name-->
                                                                    <div class="d-flex justify-content-start flex-column">
                                                                        <a  href="#" class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6">  <?=$tx['currency']?></a>
                                                                        <a  href="#" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                                                                        <span class="text-gray-900">Symbol</span>:  <?=$tx['symbol']?></a>
                                                                    </div>
                                                                    <!--end::Name-->
                                                                </div>
            
            </td >
            <td class="p-0">
                <a  class="text-gray-900 fw-bold text-hover-primary d-block mb-1 fs-6"><?=fiat($tx['amount'])?></a>
                <span class="text-muted fw-semibold text-muted d-block fs-7">Fee: <?=fiat($tx['fee'])?></span>
                
            
            </td>
            
            <td class="p-0">
                                                                                <span class="text-gray-900 fw-bold d-block fs-7"><?=$tx['timestamp'] ?></span>
                                                                                <span class="text-muted fw-semibold d-block fs-8"><?php $dt = date("M d, Y h:i:s A", strtotime($tx['timestamp']));
            echo time_elapsed_string($dt, true); ?></span>
                                                                            </td>
                                                                            
            </tr> 
         <tr >
            <td class="pb-1 pt-1 <? if($tx['txn_id']){?>  <? }else{ ?>border-gray-500<? } ?>">Details</td>
              <td class="pb-1 pt-1 <? if($tx['txn_id']){?>  <? }else{ ?>border-gray-500<? } ?>" colspan="6">
                                                                <span  class="badge badge-sm badge-light fs-12"><?=$tx['detail']?></span>
                                                            
                                                            </td>
                                                        
                                                        
        </tr>
    <? if ($tx['txn_id'])
    { ?>
    <tr >
            <td class="pb-1 pt-1 border-gray-500">Transaction</td>
            <td class="pb-1 pt-1 border-gray-500" colspan="6" ><span class="text-muted fw-semibold text-muted  fs-7"><?=$tx['packagename']?>    <?      switch($tx['status']) {
        case '0':?>
                <span class="badge badge-light-info">Pending</span>
         <? ; break; case '1'     ?>    
            <span class="badge badge-light-success"> Done</span>
            <? ; break; }?></span><a  href="<?=$tx['chain_url']?><?=$tx['txn_id']?>" target="_blank"><span class="badge badge-sm badge-light"><?=$tx['txn_id']?></span></a></td>
            
        </tr>
        <?
    }
} ?>
                    
                                                            </tbody>
                                
     <?
}
else
{ ?>
        <tfoot>
                                                            
            <tr>
                <td> No Transactions found</td>
            </tr>                                           
                
                </tfoot>      
                <?
} ?>                            
                                                            <!--end::Table body-->
                                                        </table>
                                                        <!--end::Table-->
                                                    </div>
</div></div>
    <!--end::Card body-->
</div>
                                            <div class="card mb-5 mb-lg-10">
    <!--begin::Card header-->
    <div class="card-header  min-h-unset p-0">
        <!--begin::Heading-->
        <div class="card-title">
           <span class="fs-9 "> Last 10</span> <h3> Sessions </h3>
        </div>
        <!--end::Heading-->

        <!--begin::Toolbar-->
        <div class="card-toolbar">
          

            <a  href="admin?page=user&id=<?=$user_id
?>&view=logs" class="btn btn-sm btn-primary my-1">
                View All
            </a>
        </div>
        <!--end::Toolbar-->
    </div>
    <!--end::Card header-->

    <!--begin::Card body-->
    <div class="card-body p-0">
        <!--begin::Table wrapper-->
        <div class="table-responsive">
            <!--begin::Table-->
            <table  class="table align-middle table-sm table-row-bordered table-hover table-row-solid gy-4 gs-9">
                <!--begin::Thead-->
                        <thead class="border-gray-200 fs-5 fw-semibold bg-lighten">
                                                        <tr>
                                                            <th class="min-w-150px">Ip</th>
                                                            <th class="min-w-100px">Location</th>
                                                            <th class="min-w-150px">Browser</th>
                                                            <th class="min-w-150px">OS</th>
                                                            <th class="min-w-150px">Time</th>
                                                        </tr>
                                                    </thead>
                                                    <!--end::Thead-->
                                                    <!--begin::Tbody-->
                                                    <tbody class="fw-6 fw-semibold text-gray-600">
                                                         <?php
                $l = mysqli_query($DB_CONN, "select * from login_report where user_id = '$user_id' order by id desc Limit 10");
                while ($login = mysqli_fetch_assoc($l))
                {
?>
                                                        <tr>
                                                            <td class="p-0  " rowspan="2">
                                                                <a   href="admin?page=login_reports&ip=<? echo $login['ip']; ?>" target="_blank" class="text-hover-primary text-gray-600">    <span class="badge badge-light-primary fs-7 fw-bold"><? echo $login['ip']; ?></span></a>
                                                            </td>
                                                            <td class="p-0 ">
                                                            <? echo $login['country']; ?>/<? echo $login['city']; ?>
                                                            </td class="p-0 ">
                                                            <td class="p-0 "><? echo $login['browser']; ?></td>
                                                            <td class="p-0 "><? echo $login['os']; ?></td>
                                                        
                                                            <td class="p-0 "> <?php $dt = date("M d, Y h:i:s A", strtotime($login['datetime']));
                    echo time_elapsed_string($dt, true); ?></td>
                                                        </tr>
                                                        <tr class="p-0 ">
                                                          <td class="p-0 "><span class="text-muted fw-semibold text-muted d-block fs-7">Useragent</span></td> 
                                                          <td colspan="4" class="p-0 "><? echo $login['useragent']; ?> </td>
                                                        </tr>
                                                     <?
                } ?>     
                </tbody>
                <!--end::Tbody-->
            </table>
            <!--end::Table-->
        </div>
        <!--end::Table wrapper-->
    </div>
    <!--end::Card body-->
</div>
                                    </div>
                <?
            }
                if ($_GET['view'] == 'exchange')
            {  
         
           $from_c_currency = $_GET['currency'];
           $from_c_amount = $_GET['amount'];
           $from_currency=$post['from_currency'];
            $to_currency=$post['to_currency'];
            $from_amount=$post['from_amount'];
            $exchange = $post['fee'];
      $balance = $userinfo['balances'][$post['from_currency']];
      $to_amount = $from_amount*((100-$exchange)/100);
      if($from_c_amount >= $from_amount) {
        if($post['action'] == 'exchange') {
            add_balance($userinfo['id'], $from_currency, -$from_amount);
            add_balance($userinfo['id'], $to_currency, $to_amount);
            $rep = array("#from_currency#", "#to_currency#", "#from_amount#", "#to_amount#");
            $with = array($exchange['fcurrency'], $exchange['tcurrency'], $from_amount, $to_amount);
            $detailf = str_replace($rep, $with, $exchange_settings['from_memo']);
            $detailt = str_replace($rep, $with, $exchange_settings['to_memo']);
            $fee = $from_amount - $to_amount;
            mysqli_query($DB_CONN, "INSERT INTO `transactions`(`user_id`, `amount`, `fee`, `txn_type`, `am_type`, `payment_method_id`, `detail`, `ip`) VALUES ('{$userinfo['id']}','{$from_amount}', '0', 'exchange', 'out', '{$from_currency}', '{$detailf}', '{$ip}')");
            mysqli_query($DB_CONN, "INSERT INTO `transactions`(`user_id`, `amount`, `fee`, `txn_type`, `am_type`, `payment_method_id`, `detail`, `ip`) VALUES ('{$userinfo['id']}','{$to_amount}', '{$fee}', 'exchange', 'in', '{$to_currency}', '{$detailt}', '{$ip}')");
            sendmail("exchange_user_notification", $userinfo['id'], $userinfo, array("from_currency" => $exchange['fcurrency'], "to_currency" => $exchange['tcurrency'], "amount_from" => $from_amount, "amount_to" => $to_amount));
            call_alert(81); //Balance Exchanged Successfully
        } 
      } 
            ?>                
            <form method="post">
                <input type="hidden" name="action" value="exchange" />
            <div class="card my-4">
              <div class="card-header min-h-unset py-2">
                                            <div class="card-title m-0">
                                                <h3 class="fw-bold m-0 fs-5">Exchange Currency Balance of <?=$row_detail['username']?></h3>
                                            </div>
                                        </div>
                <div class="card-body">
               
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Currency</label>
                                <select name="from_currency" onchange="change_payment()" required="" class="form-select">
                                    <option value="">Select From Currency</option>
                                    <?php
        
            $wallets = json_decode($row_detail['wallets'], true);
$p = mysqli_query($DB_CONN, "SELECT * FROM `currencies` WHERE de_pm_id or wi_pm_id group by name order by id");

while($pm = mysqli_fetch_assoc($p)) {
    $bal = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT * FROM `user_balances` WHERE payment_method_id ='{$pm['id']}' and user_id = '$user_id'"));
  $str = strtolower(str_replace(' ','',$pm['name']));
if($bal){
?>
   <option value="<?=$pm['id'] ?>" <? if ($from_c_currency == $pm['id'] ) {  ?> selected <? } ?>><?=$pm['name'] ?> <?php echo amount_format($bal['balance']) ?></option>
                                                                                                 <? }} ?>
                                                                                   </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Amount of user</label>
                                <input type="number" class="form-control" required="" value="<? echo $from_c_amount; ?>" name="from_amount" placeholder="">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Select Currency user will receive</label>
                                <select name="to_currency" required="" class="form-select">
                                    <option value="">Select To Currency</option>
                                     <?php
        
            $wallets = json_decode($row_detail['wallets'], true);
$p = mysqli_query($DB_CONN, "SELECT * FROM `currencies` WHERE de_pm_id or wi_pm_id group by name order by id");

while($pm = mysqli_fetch_assoc($p)) {
    $bal = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT * FROM `user_balances` WHERE payment_method_id ='{$pm['id']}' and user_id = '$user_id'"));
  $str = strtolower(str_replace(' ','',$pm['name']));

?>
  <option value="<?=$pm['id'] ?>" data-balance=""><?=$pm['name'] ?> <?php echo amount_format($bal['balance']) ?></option>
                                                                                                 <? } ?>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Amount user will receive</label>
                                <input type="number" onkeyup="getrate('to')" step="0.00000001" min="0.00000001" class="form-control" value="" name="to_amount" placeholder="">
                            </div>
                        </div>
                        <div class="col-md-12">
                             <label class="form-label">Fee</label>
                                <input type="number"  class="form-control" value="" name="from_amount" placeholder="">
                            </div>
                            <div class="col-md-12">
                             <label class="form-label">Detail</label>
                                <input type="text"  class="form-control" required="" value="" name="from_amount" placeholder="">
                            </div>
                    </div>
                </div>
                <div class="card-footer text-muted">
                    <input type="hidden" name="action" value="confirm">
                    <button type="submit" name="submit" class="btn btn-primary">Exchange Now</button>
                </div>
            </div>
        </form>   
        
        
                                    <?
            }
                if ($_GET['view'] == 'request_withdraw')

            { ?>
        <div class="card">
    <div class="card-header min-h-unset py-2">
        <div class="card-title m-0">
            <h3 class="fw-bold m-0 fs-5">
                Request Withdraw for
                <?=$row_detail['username']?>
            </h3>
        </div>
    </div>
    <div class="card-body">
        <table  class="table table-rounded table-row-dashed table-hover table- gs-7">
            <thead>
                <tr>
                    <td>Select</td>
                    <td>Currency</td>
                    <td>Balance</td>
                    <td>Wallet</td>
                </tr>
            </thead>
            <tbody>
                <?php
        
            $wallets = json_decode($row_detail['wallets'], true);
$p = mysqli_query($DB_CONN, "SELECT * FROM `currencies` WHERE de_pm_id or wi_pm_id group by name order by id");

while($pm = mysqli_fetch_assoc($p)) {
    $bal = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT * FROM `user_balances` WHERE payment_method_id ='{$pm['id']}' and user_id = '$user_id'"));
  $str = strtolower(str_replace(' ','',$pm['name']));
if($bal){
?>
                <tr>
                    <td><input type="radio" name="ec" value="<?=$pm['id'] ?>" /></td>
                    <td>
                        <div class="symbol symbol-20px me-1">
                            <span class="symbol-label">
                                <img src="images/icons/<?=$pm['id'] ?>.svg" width="15px" class="h-20 align-self-center" alt="" />
                            </span>
                        </div>
                        <?=$pm['name'] ?>
                    </td>
                    <td>
                        <span class="badge <?php if($bal){?>badge-success <?}else{?> badge-light <?} ?> my-2 fs-7"><?php echo amount_format($bal['balance']) ?></span>
                    </td>
                    <td><?php echo $wallets[$str] ?></td>
                </tr>

                <?
        
}}
?>
            </tbody>
        </table>
        <div class="row">
            <div class="col-md-2">
                <label class=""> Amount</label>
            </div>
            <div class="col-md-10">
                <input type="text" name="amount" class="form-control form-control-sm" />
            </div>
        </div>
    </div>
    <div class="card-footer">
        <div class="row">
            <div class="col-md-4"><input class="btn btn-primary btn-sm" type="submit" name="submit" value="Request" />&nbsp;</div>
        </div>
    </div>
</div>

            <?
            } if ($_GET['view'] == 'tree')

            { ?>
            <div class="row g-5 g-xl-10 mb-5 mb-xl-10">
                <div class="col-xl-4">
                    
                </div>
                <div class="col-xl-8">
                     <div class="card">
                <div class="card-header min-h-unset py-2">
                                            <div class="card-title m-0">
                                                <h3 class="fw-bold m-0 fs-5">Referral Tree of <?=$row_detail['username']?></h3>
                                            </div>
                                        </div>
                <div class="card-body p-0">
                <div id="chart-container"></div>
                </div>
            </div>
            
<div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">User Info</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <table  class="table">
            <tbody id="modalbody"></tbody>
        </table>
      </div>
      <!-- <div class="modal-footer">
        <button type="button" class="btn btn-primary">Save changes</button>
      </div> -->
    </div>
  </div>
</div>
                </div>
                
            </div>
           
<style>
#chart-container {
  position: relative;
/*  height: 420px;*/
/*  border: 1px solid #aaa;*/
  margin: 0.5rem;
  overflow: auto;
  text-align: center;
}
.orgchart .node .title {
  height: unset;
  text-align: left;
  line-height: 40px;
  width: 150px;
}
.orgchart .node .content {
  text-align: left;
  padding: 5px;
}
.orgchart .node .title {
    background-color: rgb(252 243 0) !important;
    color: #072ac8 !important;
}
.orgchart .node .content .symbol {
  color: #aaa;
  margin-right: 20px;
}
.orgchart .node .title .parentNodeSymbol::before {
    color: #072ac8 !important;
}

.oci-leader::before, .oci-leader::after {
  background-color: rgba(217, 83, 79, 0.8);
}
.orgchart .node {
  cursor: pointer !important;
}
.orgchart .node .avatar {
  width: 60px;
  height: 60px;
  border-radius: 30px;
  float: left;
  margin: 5px;
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/orgchart/4.0.1/css/jquery.orgchart.min.css" integrity="sha512-eHom9br32mysJgzeaf3n9xBNqishtyx8+1Y/CQSzWpCsD0NlgWrDzXmvTuR84LAvVknXa6nJnGJcau7C9PWh2A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<script type="text/javascript" src="bitders/assets/orgchart.min.js"></script>
<script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
<script type="text/javascript">
$(function() {
  
  var datascource = {
      'id': '<?=$row_detail['id']?>',
      'name': '<?=$row_detail['username']?>',
      'title': '<?=$row_detail['fullname']?>',
      'content': '<?=$row_detail['email']?>',
      'children': <?
      $child = array();
      $u = mysqli_query($DB_CONN, "SELECT * from users where sponsor = '{$user_id}'");
      $i = 0;
  while ($left = mysqli_fetch_assoc($u)) {
    $child[$i]['id'] = $left['id'];
    $child[$i]['name'] = $left['username'];
    $child[$i]['title'] = $left['fullname'];
    $child[$i]['content'] = $left['email'];
    $child[$i]['relationship'] = '001';
    $i++;
  }
  echo json_encode($child);
      ?>
    };

    var ajaxURLs = {
      'children': '?page=sptree&id='
    };
    var options = {
      'data' : datascource,
      'pan': true,
      'zoom': true,
      'ajaxURL': ajaxURLs,
      'nodeContent': 'title',
      'nodeId': 'id',
      'createNode': function($node, data) {
        $node.on('click', function() {
          openuserinfo($node[0].id)
        })
         
          $node.find('.content').prepend($node.find('.symbol'));
      },
    }
    $('#chart-container').orgchart(options);
} );

function openuserinfo(id) {
  $.ajax({
    type        : 'GET',
    url         : 'bitders/assets/user_details.php?user_id='+id,
  }).done(function(data) {
    $("#modalbody").html(data);
    $("#userModal").modal('toggle');
  });
}

</script>

<?
}
if ($_GET['view'] == 'transactions')
{    
    if (isset($_POST['submit']))
    {
       $amount = $_POST['amount'];
        $fee = $_POST['fee'];
        $payment_method_id = $_POST['payment_method_id'];
        $txn_type = $_POST['txn_type'];
        $detail = $_POST['detail'];
        $txn_id = $_POST['txn_id'];
        $txn_url = $_POST['txn_url'];
        $id = $_POST['id'];
        $status = $_POST['status'];
        $current_result = mysqli_query($DB_CONN, "SELECT amount, payment_method_id FROM transactions WHERE id = '{$id}'");
        if ($current_result) {
        $current_data = mysqli_fetch_assoc($current_result);
        $current_amount = $current_data['amount'];
        $current_payment_method_id = $current_data['payment_method_id'];
        
        if ($amount != $current_amount) {
                $balance_change = $amount - $current_amount;
                add_balance($user_id, $payment_method_id, $balance_change);
            }

            // Adjust balance if the payment method has changed
            if ($payment_method_id != $current_payment_method_id) {
                add_balance($user_id, $payment_method_id, $amount);
                add_balance($user_id, $current_payment_method_id, -$amount);
            }
            
        }
   
       $result = mysqli_query($DB_CONN, "UPDATE transactions set `payment_method_id` = '{$payment_method_id}', `amount` = '{$amount}', `fee` = '{$fee}', `txn_type` = '{$txn_type}',`tx_url` = '{$txn_url}',`txn_id` = '{$txn_id}', `detail` = '{$detail}', `status` = '{$status}' WHERE id = '{$id}'");
        
        if (!$result) {
    // Query failed, output the error
    echo "Error executing query: " . mysqli_error($DB_CONN);
} else {
    echo "Query executed successfully.";
}
    } ?>

<div class="card">
    <div class="card-body p-0">
    <div class="table-responsive">
    <!--begin::Table-->
    <table  class="table table-rounded table-row-dashed  table-hover  table- gs-7">
                                                            <!--begin::Table head-->
                                                            <thead>
                                                                <tr class="fw-bold text-muted bg-light border-bottom border-gray-300">
                                                                    <th class=" ">ID</th>
                                                                    <th class="">Type</th>
                                                                    <th class="">Currency</th>
                                                                    <th class="">Amount</th>
                                                                    <th class="  ">Timestamp</th>
                
            </tr>
        </thead>
        <!--end::Table head-->
        <!--begin::Table body-->
        <tbody>
        <? $d = mysqli_query($DB_CONN, "SELECT *, (SELECT name FROM currencies WHERE id =  transactions.payment_method_id) as currency FROM `transactions` WHERE user_id ='$user_id'    order by id desc");
                if (mysqli_num_rows($d))
                {
                    while ($tx = mysqli_fetch_assoc($d))
                    { ?>
    
    <tr >
             <td class=" px-5 py-0  align-middle border-gray-500" <?if($tx['txn_id']){?>rowspan="3"<?}else{?>rowspan="2"<?}?> class="ps-0"><?=$tx['id']?>  <a   <?if($tx['txn_type'] == 'invest'){?> href="admin?page=user&id=<?=$user_id?>&view=investments" <? }else{ ?>data-bs-toggle="modal" data-bs-target="#kt_modal_<?=$tx['id'] ?>" <? } ?>  class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm me-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Edit">
                <i class="ki-duotone ki-pencil fs-2">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
            </a></td>
                <td>
              <? echo getBadge($tx['txn_type']); ?>
            </td>
        
        <td class="p-0">
                
                                                                <div class="d-flex align-items-center">
                                                                    <!--begin::Avatar-->
                                                                    <div class="symbol symbol-30px me-5">
                                                                        <img alt="<?=$tx['cname']?>" src="images/icons/<?=$tx['payment_method_id']?>.svg" width="15px">
                                                                    </div>
                                                                    <!--end::Avatar-->
                                                                    <!--begin::Name-->
                                                                    <div class="d-flex justify-content-start flex-column">
                                                                        <a  href="#" class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6">  <?=$tx['currency']?></a>
                                                                        <a  href="#" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                                                                        <span class="text-gray-900">Symbol</span>:  <?=$tx['symbol']?></a>
                                                                    </div>
                                                                    <!--end::Name-->
                                                                </div>
            
            </td >
            <td class="p-0">
                <a  class="text-gray-900 fw-bold text-hover-primary d-block mb-1 fs-6"><?=fiat($tx['amount'])?></a>
                <span class="text-muted fw-semibold text-muted d-block fs-7">Fee: <?=fiat($tx['fee'])?></span>
                
            
            </td>
            
            <td class="p-0">
                                                                                <span class="text-gray-900 fw-bold d-block fs-7"><?=$tx['timestamp'] ?></span>
                                                                                <span class="text-muted fw-semibold d-block fs-8"><?php $dt = date("M d, Y h:i:s A", strtotime($tx['timestamp']));
            echo time_elapsed_string($dt, true); ?></span>
                                                                            </td>
                                                                            
            </tr> 
         <tr >
            <td class="pb-1 pt-1 <? if($tx['txn_id']){?>  <? }else{ ?>border-gray-500<? } ?>">Details</td>
              <td class="pb-1 pt-1 <? if($tx['txn_id']){?>  <? }else{ ?>border-gray-500<? } ?>" colspan="6">
                                                                <span  class="badge badge-sm badge-light fs-12"><?=$tx['detail']?></span>
                                                            
                                                            </td>
                                                        
                                                        
        </tr>
    <? if ($tx['txn_id'])
    { ?>
    <tr >
            <td class="pb-1 pt-1 border-gray-500">Transaction</td>
            <td class="pb-1 pt-1 border-gray-500" colspan="6" ><span class="text-muted fw-semibold text-muted  fs-7"><?=$tx['packagename']?>    <?      switch($tx['status']) {
        case '0':?>
                <span class="badge badge-light-info">Pending</span>
         <? ; break; case '1'     ?>    
            <span class="badge badge-light-success"> Done</span>
            <? ; break; }?></span><a  href="<?=$tx['chain_url']?><?=$tx['txn_id']?>" target="_blank"><span class="badge badge-sm badge-light"><?=$tx['txn_id']?></span></a></td>
            
        </tr>
        <?
    }  ?>
  <div class="modal fade" tabindex="-1" id="kt_modal_<?=$tx['id'] ?>">
    <div class="modal-dialog">
        <div class="modal-content">
           <div class="modal-header"> 
              
<div class="d-flex align-items-center">
                                                                
            <!--begin::Name-->
            <div class="d-flex justify-content-start flex-column">
                <a  class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6">Edit <span class=""><?=$tx['id'] ?></span></a>
                <a  class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                <span class="text-gray-900">Currency</span>: <span class=""><?=$tx['currency'] ?></span> | <span class="text-gray-900">Transaction Type</span>: <span class=""><?=ucfirst($tx['txn_type']) ?></span></a>
            </div>
            <!--end::Name-->
        </div>
                                                                
                <!--begin::Close-->
                <div class="btn btn-icon btn-sm btn-active-light-primary ms-2" data-bs-dismiss="modal" aria-label="Close">
                    <i class="ki-duotone ki-cross fs-1"><span class="path1"></span><span class="path2"></span></i>
                </div>
                <!--end::Close-->
            </div>

            <div class="modal-body">
              <form method="post">  
              <input type="hidden" value="<?=$tx['id'] ?>" name="id"> 
               <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9"> Change Currency: </label>
                </div>
            </div>
            <div class="col-md-8">
                <select class="form-select form-select-sm form-select-solid" name="payment_method_id">
            <?php $select_method = mysqli_query($DB_CONN, "SELECT * from currencies where de_pm_id != 0");
            while ($row_method = mysqli_fetch_assoc($select_method))
            { ?>
                        <option value="<?php echo $row_method['id'] ?>" <? echo $row_method['id'] == $tx['payment_method_id'] ? 'selected' : '' ?> > <?php echo $row_method['name'] ?> </option>
                <?php
            } ?>
                            
                        </select>
                <small id="emailHelp" class="form-text text-muted fs-9">Change Currency of this transacstion.</small>
            </div>
        </div>
        <div class="separator separator-dashed my-2"></div>
                <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9"> Change Transaction Type: </label>
                </div>
            </div>
            <div class="col-md-8">
                <select class="form-select form-select-sm form-select-solid" name="txn_type">
            <?php $sql = "SHOW COLUMNS FROM transactions LIKE 'txn_type'";
$result = $DB_CONN->query($sql);

$enumValues = [];
if ($result->num_rows > 0) {
    $row = $result->fetch_assoc();
    preg_match('/enum\((.*)\)$/', $row['Type'], $matches);
    if (isset($matches[1])) {
        $enumValues = str_getcsv($matches[1], ',', "'");
    }
} 
foreach ($enumValues as $value):
             ?>
                        <option value="<?= htmlspecialchars($value) ?>" <? echo htmlspecialchars($value) == $tx['txn_type'] ? 'selected' : '' ?> > <?=ucfirst($value) ?></option>
                <?php endforeach; ?>
                            
                        </select>
                <small id="emailHelp" class="form-text text-muted fs-9">change transaction type accordingly..</small>
            </div>
        </div>
         <? if ($tx['txn_id'] || $tx['txn_type'] == 'withdraw' )
    { ?>
        <div class="separator separator-dashed my-2"></div>
         <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9"> Change Transaction ID: </label>
                </div>
            </div>
            <div class="col-md-8">
                 <input type="text" name="txn_id" class="form-control form-control-sm" value="<?=$tx['txn_id']?>">
                <small id="emailHelp" class="form-text text-muted fs-9"> Change Transaction ID</small>
                     
               
            </div>
        </div>
        <div class="separator separator-dashed my-2"></div>
         <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9"> Change Transaction URL: </label>
                </div>
            </div>
            <div class="col-md-8">
                 <input type="text" name="txn_url" class="form-control form-control-sm" value="<?=$tx['txn_url']?>">
                <small id="emailHelp" class="form-text text-muted fs-9"> Change Transaction ID</small>
                     
               
            </div>
        </div>
        <? }  ?>

         <div class="separator separator-dashed my-2"></div>
         <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9"> Change Detail: </label>
                </div>
            </div>
            <div class="col-md-8">
                 <input type="text" name="detail" class="form-control form-control-sm" value="<?=$tx['detail']?>">
                <small id="emailHelp" class="form-text text-muted fs-9"> Change details of this accordingly</small>
                     
               
            </div>
        </div>

        <div class="separator separator-dashed my-2"></div>
                <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9">  Amount: </label>
                </div>
            </div>
            <div class="col-md-8">
               <input type="number"  name="amount" class="form-control form-control-sm"  value="<?=$tx['amount']?>">
                <small id="emailHelp" class="form-text text-muted fs-9"> Funds will return to the user's account balance</small>
            </div>
        </div>
                <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9">  Fee: </label>
                </div>
            </div>
            <div class="col-md-8">
               <input type="number"  name="fee" class="form-control form-control-sm"  value="<?=$tx['fee']?>">
                <small id="emailHelp" class="form-text text-muted fs-9"> Funds will return to the user's account balance</small>
            </div>
        </div>
          <div class="separator separator-dashed my-2"></div>
                   <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Status</a>
                    <div class="fs-9 fw-semibold text-gray-500">Pending or Completed Status of the Transaction.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="status" id="status"  value="1"
                    <?=$tx['status'] == '1' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="status"> Pending / Completed</label>
                </div>
            </div>
        </div>

            </div>
            <div class="modal-footer">
                <input type="hidden" name="user_id" value="<?=$de['user_id']?>">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-primary" name="submit">Save changes</button>
            </div>
            </form>
        </div>
    </div>
</div>    

                    
                                                            </tbody>
                                
     <?
}
}
else
{ ?>
        <tfoot>
                                                            
            <tr>
                <td> No Transactions found</td>
            </tr>                                           
                
                </tfoot>      
                <?
} ?>                            
                                                            <!--end::Table body-->
                                                        </table>
                                                        <!--end::Table-->
                                                    </div>
</div></div>

<?
}
if ($_GET['view'] == 'investments')
{
    if (isset($_POST['submit']))
    {
        $amount = $_POST['amount'];
        $c_amount = $_POST['c_amount'];
        $payment_method_id = $_POST['payment_method_id'];
        $package_id = $_POST['package_id'];
        $plan_id = $_POST['plan_id'];
        $id = $_POST['id'];
        $txn_id = $_POST['txn_id'];
        $detail = $_POST['detail'];
        $status = $_POST['status'];
        if(!$amount || $amount < 0)
            $amount = 0;
        $result = $DB_CONN->query("SELECT amount FROM transactions WHERE id = '{$id}'");
        $current_amount = 0;
        if ($result->num_rows > 0) {
            $row = $result->fetch_assoc();
            $current_amount = $row['amount'];
        }    
        mysqli_query($DB_CONN, "UPDATE package_deposits set payment_method_id = '{$payment_method_id}', amount = amount - '{$amount}', package_id = '{$package_id}', plan_id = '{$plan_id}',txn_id = '{$txn_id}', status = '{$status}' where id = '{$id}'");
        mysqli_query($DB_CONN, "UPDATE transactions set payment_method_id = '{$payment_method_id}', amount = amount - {$amount}, package_id = {$package_id}, plan_id = '{$plan_id}', status = '{$status}' where ref_id = '{$id}'");
        add_balance($_POST['user_id'], $payment_method_id, $amount);
        if($current_amount != $c_amount){
          mysqli_query($DB_CONN, "UPDATE package_deposits set payment_method_id = '{$payment_method_id}', amount = '{$c_amount}', package_id = '{$package_id}', plan_id = '{$plan_id}', status = '{$status}' where id = '{$id}'");
        mysqli_query($DB_CONN, "UPDATE transactions set payment_method_id = '{$payment_method_id}', amount = {$c_amount}, package_id = {$package_id}, plan_id = '{$plan_id}',txn_id = '{$txn_id}',detail = '{$detail}', status = '{$status}' where ref_id = '{$id}'");  
        }
    }
?>
<div class="card">
    <div class="card-body p-0">
    <div class="table-responsive">
    <!--begin::Table-->
    <table  class="table table-rounded table-striped border gs-7">
        <!--begin::Table head-->
        <thead>
            <tr class="fw-bold text-muted bg-light border-bottom border-gray-300">
                <th class=" ">ID</th>
                <th class="text-start ">Plan</th>
                <th class=" ">Amount</th>
                <th class=" ">Accurals</th>
                <th class=" ">Next Accural</th>
                <th class=" ">Expiry</th>
                <th class="">DateTime</th>
                <th class="">Action</th>
            </tr>
        </thead>
        <!--end::Table head-->
        <!--begin::Table body-->
        <tbody>
            <?
$d = mysqli_query($DB_CONN, "SELECT *, (SELECT currencies.name from currencies where id = package_deposits.payment_method_id) as currency FROM `package_deposits` where user_id = '{$row_detail['id']}' and (status = 1 or avail > 0) order by id desc");
    if (mysqli_num_rows($d))
    {
        while($de = mysqli_fetch_assoc($d)) {
      $package = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT * from packages where id = '{$de['package_id']}'"));
      $details = json_decode($package['details'], true);
      $plan = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT * from package_plans where id = '{$de['plan_id']}'"));
      $rem = strtotime($de['last_earningDateTime'])+(($package['duration'] - $package['avail'])*$package['diff_in_seconds'])-time();
      $next = strtotime($de['last_earningDateTime'])+$package['diff_in_seconds'];
      $last_day = date('l', strtotime($de['last_earningDateTime']));
      $exclude_days = array();
      if($package['earnings_mon_fri'] == 1) {
        if($last_day == 'Friday')
          $next += (86400*2);
        $exclude_days[] = 'Saturday';
        $exclude_days[] = 'Sunday';
      }
      $next_day = date('l', $next);
      if($package['earnings_mon_fri'] == 2) {
        $earning_days = json_decode($package['earning_days'], true);
        $days_loop = array('Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday');
        foreach ($days_loop as $day) {
          if($earning_days[$day] != 'on') {
            $exclude_days[] = $day;
            if($day == $next_day)
              $next += 86400;
          }
        }
      }
      $exclude_days = array_unique($exclude_days);
      $current_time = time();
      $dtCurrent = DateTime::createFromFormat('U', $current_time);
      $dtCreate = DateTime::createFromFormat('U', $next);
      $diff = $dtCurrent->diff($dtCreate);
      $interval = $diff->format("%d days %h hours %i minutes");
      $interval = preg_replace('/(^0| 0) (days|hours|minutes)/', '', $interval);
      $de['expiry'] = date("Y-m-d H:i:s", addDays($de['datetime'], $package['duration'], $package['diff_in_seconds'], $exclude_days));
      $de['last_earning_time'] = $de['avail'] > 0 ? date("Y-m-d H:i:s", strtotime($de['last_earningDateTime'])) : 0;
      $de['next_earning'] = max($interval, 0);
      $de['reinvest'] = $details['auto_reinvest'];
      $de['datetime'] = date("m-d-y H:i:s", strtotime($de['datetime']));
      $de['profit'] = ($plan['percent_max'] / 100)*$de['amount'];
      $de['total_profit'] = $de['profit']*$package['duration'];
      $de['percentage'] = $plan['percent_max'];
      $de['total_percentage'] = $plan['percent_max']*$package['duration'];
      $de['name'] = $package['name'];
      $de['duration'] = $package['duration'];
      $e = mysqli_query($DB_CONN, "SELECT * FROM `transactions` WHERE ref_id = '{$de['id']}' and txn_type = 'earning' ");
      while ($earning = mysqli_fetch_assoc($e))
        $de['earning'][] = $earning;
      $de['allowprincipal'] = $package['allowprincipal'];
      $release = false;
      if($details['principal_release_period']) {
        $rt = strtotime($de['datetime'])+($details['principal_release_period']*86400);
        if($rt <= time())
          $release = true;
        else
          $de['release_time'] = date("Y-m-d H:i:s", $rt);
      } else {
        foreach ($details['depositduration'] as $key => $duration) {
        $duration = (int)$duration;
        if($duration > 0) {
          if((strtotime($de['datetime'])+($duration*86400)) <= time()) {
          $release = true;
          break;
        }}}
        if($details['depositduration'][0]) {
          $rt = strtotime($de['datetime'])+($details['depositduration'][0]*86400);
          $de['release_time'] = date("Y-m-d H:i:s", $rt);
        }
      }
      $de['release'] = $release;
?>
                 <tr class="align-middle text-center <?php if ($de['status'] == 1)
            {
                echo 'bg-success ';
            } ?>" <? if ($de['txn_id'])
            { ?>rowspan="2" <?
            } ?>>
                     <td ><?=$de['id'] ?></td>
                    
                     <td class=" text-start"><?=$de['name'] ?></td>
                     <td class=" text-start"><span class="badge badge-light-success"><? $preferences['currency'] ?><?=fiat($de['amount'], $de['payment_method_id']) ?></span></td>
                     <td><?=$de['avail'] ?> / <?=$de['duration'] ?></td>
                     <td><?=max($interval, 0) ?></td>
                     <td><?=$de['expiry']?></td>
                     <td><?=$de['datetime'] ?></td>
                      <td><a  data-bs-toggle="modal" data-bs-target="#kt_modal_<?=$de['id'] ?>"  class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm me-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Edit">
                <i class="ki-duotone ki-pencil fs-2">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
            </a></td>
                     
                 </tr>
             
                 <? if ($de['txn_id'])
            { ?>
        <tr>
            <td colspan="2"><span class="text-muted fw-semibold text-muted d-block fs-7">Transaction</span></td>
            <td colspan="6"><?=$de['txn_id'] ?></td>
        </tr>
        <?
            } ?>
<div class="modal fade" tabindex="-1" id="kt_modal_<?=$de['id'] ?>">
    <div class="modal-dialog">
        <div class="modal-content">
           <div class="modal-header"> 
              
<div class="d-flex align-items-center">
                                                                
            <!--begin::Name-->
            <div class="d-flex justify-content-start flex-column">
                <a  class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6">Edit <span class=""><?=$de['id'] ?></span></a>
                <a  class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                <span class="text-gray-900">Currency</span>: <span class=""><?=$de['currencies'] ?></span> | <span class="text-gray-900">Plan</span>: <span class=""><?=$de['name'] ?></span></a>
            </div>
            <!--end::Name-->
        </div>
                                                                
                <!--begin::Close-->
                <div class="btn btn-icon btn-sm btn-active-light-primary ms-2" data-bs-dismiss="modal" aria-label="Close">
                    <i class="ki-duotone ki-cross fs-1"><span class="path1"></span><span class="path2"></span></i>
                </div>
                <!--end::Close-->
            </div>

            <div class="modal-body">
              <form method="post">  
              <input type="hidden" value="<?=$de['id'] ?>" name="id"> 
                <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9"> Change Currency: </label>
                </div>
            </div>
            <div class="col-md-8">
                <select class="form-select form-select-sm form-select-solid" name="payment_method_id">
            <?php $select_method = mysqli_query($DB_CONN, "SELECT * from currencies where de_pm_id != 0");
            while ($row_method = mysqli_fetch_assoc($select_method))
            { ?>
                        <option value="<?php echo $row_method['id'] ?>" <? echo $row_method['id'] == $de['payment_method_id'] ? 'selected' : '' ?> > <?php echo $row_method['name'] ?> </option>
                <?php
            } ?>
                            
                        </select>
                <small id="emailHelp" class="form-text text-muted fs-9">Fee to be deducted while deposit from account balance.</small>
            </div>
        </div>
        <div class="separator separator-dashed my-2"></div>
         <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9"> Change Package: </label>
                </div>
            </div>
            <div class="col-md-8">
                <select class="form-select form-select-sm form-select-solid" name="package_id" id="package_id" onchange="changeplans(this.value)">
            <?php $p_ids = array();
            $a = mysqli_query($DB_CONN, "SELECT * FROM `packages` where etype IN (0,1,2) order by sort desc");
            while ($pl = mysqli_fetch_assoc($a))
            {
                $p_ids[] = $pl['id'];
                ?>
                <option value="<?php echo $pl['id'] ?>" <? echo $pl['id'] == $de['package_id'] ? 'selected' : '' ?>> <?php echo $pl['name'] ?> </option>
                <?php
            }
            $p_ids = implode(",", $p_ids); ?>
                            
                        </select>
                <small id="emailHelp" class="form-text text-muted fs-9">Fee to be deducted while deposit from account balance.</small>
            </div>
        </div>
        <div class="separator separator-dashed my-2"></div>
         <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9"> Change Plan: </label>
                </div>
            </div>
            <div class="col-md-8">
                <select class="form-select form-select-sm form-select-solid" name="plan_id" id="plan_id">
            <?php $a = mysqli_query($DB_CONN, "SELECT * FROM `package_plans` where package_id in ($p_ids)");
            while ($pl = mysqli_fetch_assoc($a))
            { if($pl['range_min']) { ?>
                <option value="<?php echo $pl['id'] ?>" data-package="<?php echo $pl['package_id'] ?>" <? echo $pl['id'] == $de['plan_id'] ? 'selected' : '' ?>> <?php echo $pl['name'] ?> (<?php echo $pl['range_min'] ?>-<?php echo $pl['range_max'] ?>) </option>
                <?php
            }} ?></select>
            </div>
        </div>
        <div class="separator separator-dashed my-2"></div>
                <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9"> Release Amount: </label>
                </div>
            </div>
            <div class="col-md-8">
               <input type="number" max="<?=$de['amount']?>" name="amount" class="form-control form-control-sm" placeholder="<?=number_format(0, $preferences['round']) ?>" value="">
                <small id="emailHelp" class="form-text text-muted fs-9"> Funds will return to the user's account balance</small>
            </div>
        </div>
        <div class="separator separator-dashed my-2"></div>
                <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9"> Change Investment Amount: </label>
                </div>
            </div>
            <div class="col-md-8">
               <input type="number"  name="c_amount" class="form-control form-control-sm" placeholder="<?=number_format(0, $preferences['round']) ?>" value="<?=$de['amount']?>">
                <small id="emailHelp" class="form-text text-muted fs-9"> Funds will return to the user's account balance</small>
            </div>
        </div>
        <div class="separator separator-dashed my-2"></div>
                <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9"> Change Transaction ID: </label>
                </div>
            </div>
            <div class="col-md-8">
               <input type="text"  name="txn_id" class="form-control form-control-sm"  value="<?=$de['txn_id']?>">
                <small id="emailHelp" class="form-text text-muted fs-9"> Funds will return to the user's account balance</small>
            </div>
        </div>
        <div class="separator separator-dashed my-2"></div>
                <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="fs-9"> Change Transaction Detail: </label>
                </div>
            </div>
            <div class="col-md-8">
                 <? $c = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT detail FROM transactions WHERE ref_id='{$de['id']}'"));  ?>
               <input type="text"  name="detail" class="form-control form-control-sm" value="<?=$c['detail'];?>">
                <small id="emailHelp" class="form-text text-muted fs-9"> Funds will return to the user's account balance</small>
            </div>
        </div>
          <div class="separator separator-dashed my-2"></div>
                   <div class="d-flex flex-stack">
            <div class="d-flex">
                <div class="d-flex flex-column">
                    <a  class="fs-8 text-gray-900 text-hover-primary fw-bold">Status</a>
                    <div class="fs-9 fw-semibold text-gray-500">Enable or Disable the Investment.</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="form-check form-check-solid form-check-custom form-switch">
                    <input class="form-check-input w-45px h-30px" type="checkbox" name="status" id="status"  value="1"
                    <?=$de['status'] == '1' ? 'checked' : '' ?>>
                    <label class="form-check-label fs-9" for="status"></label>
                </div>
            </div>
        </div>

            </div>
            <div class="modal-footer">
                <input type="hidden" name="user_id" value="<?=$de['user_id']?>">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-primary" name="submit">Save changes</button>
            </div>
            </form>
        </div>
    </div>
</div>      
<?
        } 
    }
    else
    { ?>
        <tfoot>
                                                            
            <tr>
                <td> No Deposits found</td>
            </tr>                                           
                
                </tfoot>      
<? } ?>
        </tbody>
    </table>
</div>
</div></div>
<script type="text/javascript">
function changeplans(va) {
    console.log(va);
    $('#plan_id option').hide();
    $('#plan_id option[data-package="'+va+'"]').show();
    $('#plan_id').val('');
    $('#plan_id').trigger('change');
}
</script>
<?
}
if ($_GET['view'] == 'edit')

{ ?>
    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header border-0 pt-5">
        <h3 class="card-title align-items-start flex-column">
            <span class="card-label fw-bold text-gray-900">Edit <?php echo $row_detail['username'] ?></span>

            <span class="text-muted mt-1 fw-semibold fs-7">Profile Details </span>
        </h3>

    </div>
                                <div class="card-body pt-0">
<hr>
<?php
if (isset($_POST['submit'])) {
    $q = "update users set ";
    $numItems = count($_POST) - 1;
    $i = 0;
    if ($_POST['password'] != '') {
        $_POST['password'] = password_hash($_POST['password'], PASSWORD_DEFAULT);
    } else {
        unset($_POST['password']);
    }
    $js = array();
    foreach ($_POST as $a => $b) {
        if ($a == 'payment') {
            $b = mysqli_real_escape_string($DB_CONN, json_encode($b));
            $a = 'wallets';
        }
        if ($a != "submit") {
            $js[] = "$a = '$b'";
        }
    }
    $q .= implode(", ", $js);
    $q .= " where id = '{$user_id}'";

    $update_user = mysqli_query($DB_CONN, $q);

    if ($update_user) {
        echo "<div class=\"alert alert-success\">User Updated Successfully</div>";
    } else {
        // Display error message
        $error_message = mysqli_error($DB_CONN);
        echo "<div class=\"alert alert-danger\">Error updating user: $error_message</div>";
    }

    $select_detail = mysqli_query($DB_CONN, "select * from users where id='$user_id'");
    $row_detail = mysqli_fetch_assoc($select_detail);
}
?>
<form method="POST">
    <div class="row mb-3">
    <label class="col-md-2 col-form-label fs-6" for="logo-image-preview_url">Profile</label>
    <div class="col-md-10">
        <!--begin::Image input-->
        <div class="image-input image-input-outline" data-kt-image-input="true" 
             style="background-image: url('svg/avatars/blank.svg')">
            <!--begin::Image preview wrapper-->
            <div class="image-input-wrapper w-100px h-100px" id="logo-image-preview"
             style="background-image: url('<?= $row_detail['photo'] ?: 'bitders/assets/placeholder.svg' ?>')">
        </div>
            <!--end::Image preview wrapper-->

                    <label class="btn btn-icon btn-circle btn-color-muted btn-active-color-primary w-25px h-25px bg-body shadow"
               data-kt-image-input-action="change"
               data-bs-toggle="modal"
               data-bs-target="#kt_modal_100"
               title="Change main image">
            <i class="ki-duotone ki-pencil fs-6"><span class="path1"></span><span class="path2"></span></i>
        </label>
        <!--end::Edit button-->
        <!--begin::Cancel button-->
        <span class="btn btn-icon btn-circle btn-color-muted btn-active-color-primary w-25px h-25px bg-body shadow"
              data-kt-image-input-action="cancel"
              data-bs-toggle="tooltip"
              data-bs-dismiss="click"
              title="Cancel image">
            <i class="ki-outline ki-cross fs-3"></i>
        </span>
        <!--end::Cancel button-->
        <!--begin::Remove button-->
        <span class="btn btn-icon btn-circle btn-color-muted btn-active-color-primary w-25px h-25px bg-body shadow"
              data-kt-image-input-action="remove"
              data-bs-toggle="tooltip"
              data-bs-dismiss="click"
              title="Remove image">
            <i class="ki-outline ki-cross fs-3"></i>
        </span>
            <!--end::Remove button-->
        </div>
        <!--end::Image input-->
      <div class="form-text">According to your theme or site..</div>
      <input type="hidden" id="logo-image-preview_url" name="photo" value="<?= $row_detail['photo'] ?>" data-original-value="<?= $row_detail['photo'] ?>"> 
    </div>
</div>
    <div class="row">
        
        <div class="col-md-6"> 
        <div class="col-md-6">
                <label class="fs-9"> Full Name </label>
            </div>
            <div class="col-md-10 pb-1">
            <input type="text" name="fullname" value="<?php echo $row_detail['fullname'] ?>" class="form-control form-control-sm">
                    </div>
                         <div class="col-md-6">  
            <label class="fs-9"> User Slug </label>
            </div>
            <div class="col-md-10 pb-1">
            <input type="text" name="slug" value="<?php echo $row_detail['slug'] ?>" class="form-control form-control-sm">
            </div>
                    <div class="col-md-6">  
            <label class="fs-9"> User Name </label>
            </div>
            <div class="col-md-10 pb-1">
            <input type="text" name="username" value="<?php echo $row_detail['username'] ?>" class="form-control form-control-sm">
            </div>
<div class="col-md-6">
            <label class="fs-9"> Password </label>
            </div>
            <div class="col-md-10 pb-1 position-relative">
            <input 
                type="password" 
                name="password" 
                id="password"
                placeholder="Enter New Password to Update" 
                class="form-control form-control-sm"
            >
            
            <!-- Toggle icon -->
            <span class="btn btn-sm btn-icon position-absolute translate-middle-y top-50 end-0" 
                  onclick="togglePassword()" 
                  style="cursor: pointer;">
                <i class="ki-duotone ki-eye fs-2">
                    <span class="path1"></span>
                    <span class="path2"></span>
                    <span class="path3"></span>
                </i>
            </span>
            </div>
            
            <div class="col-md-6">
            <label class="fs-9"> Transaction Code</label>
            </div>
            <div class="col-md-10 pb-1">
            <input type="text" name="pin_code" value="<?php echo $row_detail['pin_code'] ?>" placeholder="" class="form-control form-control-sm">
            </div>
<div class="col-md-6">
            <label class="fs-9"> User Email </label>
            </div>
            <div class="col-md-10 pb-1">
            <input type="text" name="email" value="<?php echo $row_detail['email'] ?>" class="form-control form-control-sm">
            </div>
<div class="col-md-6">
            <label class="fs-9"> Question </label>
            </div>
            <div class="col-md-10 pb-1">
            <input type="text" name="question" value="<?php echo $row_detail['question'] ?>" class="form-control form-control-sm">
            </div>
<div class="col-md-6">
            <label class="fs-9"> Answer </label>
            </div>
            <div class="col-md-10 pb-1">
            <input type="text" name="answer" value="<?php echo $row_detail['answer'] ?>" class="form-control form-control-sm">
            </div>
            <div class="col-md-6">
            <label class="fs-9"> TimeZone </label>
            </div>
            <div class="col-md-10 pb-1">
            <input type="text" name="answer" value="<?php echo $row_detail['timezone'] ?>" class="form-control form-control-sm">
            </div>
        <?php
        $wallets = json_decode($row_detail['wallets'], true);
        $p = mysqli_query($DB_CONN, "SELECT *, REPLACE(lower(name), ' ', '') as field FROM `currencies` WHERE de_pm_id or wi_pm_id group by name order by id");
while($pm = mysqli_fetch_assoc($p)) {
  $pm1 = mysqli_query($DB_CONN, "SELECT name, REPLACE(lower(name), ' ', '') as field FROM `payment_methods` where id in ({$pm['pms']}) and status = 1");
  $str = $pm['field'];
  if(BINARY_MODE) {
  while ($pms = mysqli_fetch_assoc($pm1)) {
    $str = $pms['field'];
?>
<div class="col-md-6">
<label class="fs-9"> <? echo $pms['name']?> Wallet </label>
</div>
<div class="col-md-10 pb-1">
    <div class="input-group input-group-sm input-group-solid ">
    <span class="input-group-text" id="basic-addon1"><img src="images/icons/<?=$pm['id'] ?>.svg" width="15px"></span>
   <input type="text" name="payment[<? echo $str ?>]" value="<?php echo $wallets[$str] ?>" placeholder="<? echo $pms['name']?> wallet" class="form-control form-control-sm">
</div>

</div>
<?
   }} else {
    ?>
<div class="col-md-6">
<label class="fs-9"> <? echo $pm['name']?> Wallet </label>
</div>
<div class="col-md-10 pb-1">
    <div class="input-group input-group-sm input-group-solid ">
    <span class="input-group-text" id="basic-addon1"><img src="images/icons/<?=$pm['id'] ?>.svg" width="15px"></span>
   <input type="text" name="payment[<? echo $str ?>]" value="<?php echo $wallets[$str] ?>" placeholder="<? echo $pm['name']?> wallet" class="form-control form-control-sm">
</div>

</div>
<?
if ($pm['name'] == 'Ripple')
{
?>
            <div class="col-md-6">
                <label class="fs-9"> <?=$pm['name'] ?> Tag </label>
                </div>
                <div class="col-md-10 pb-1">
    <div class="input-group input-group-sm input-group-solid ">
    <span class="input-group-text" id="basic-addon1"><img src="images/icons/12.svg" width="15px"></span>
   <input type="text" name="payment[ripple_tag]" value="<?php echo $row_detail['ripple_tag'] ?>" placeholder="<? echo $pm['name']?> TAG" class="form-control form-control-sm">
</div>

</div>
<?
}
   } }
?>          </div>

        <div class="col-md-6">
            <div class="col-md-6">
            <label class="fs-9"> 2FA Enable Or Disable </label>
</div>
            <div class="col-md-10 pb-1">
            <select name="2fa" class="form-select form-select-sm form-select-solid" >
                <option value="" <?=$row_detail['2fa'] == "" ? "selected" : "" ?>>Disable</option>
                <option value="<?=$row_detail['2fa'] ?>" <?=$row_detail['2fa'] != "" ? "selected" : "" ?>>Enable</option>
            </select>
            </div>
                 <div class="col-md-6">
            <label class="fs-9"> Auto Reinvest Enable Or Disable </label>
</div>
            <div class="col-md-10 pb-1">
            <select name="reinvest" class="form-select form-select-sm form-select-solid" >
                <option value="0" <?=$row_detail['reinvest'] == "0" ? "selected" : "" ?>>Enabled</option>
                <option value="1" <?=$row_detail['reinvest'] == "1" ? "selected" : "" ?>>Disable</option>
            </select>
            </div>
               <div class="col-md-6">
            <label class="fs-9"> Support System Enable Or Disable </label>
</div>
            <div class="col-md-10 pb-1">
            <select name="support" class="form-select form-select-sm form-select-solid" >
                <option value="0" <?=$row_detail['support'] == "0" ? "selected" : "" ?>>Enabled</option>
                <option value="1" <?=$row_detail['support'] == "1" ? "selected" : "" ?>>Disable</option>
                    <option value="2" <?=$row_detail['support'] == "2" ? "selected" : "" ?>>Restrict</option>
            </select>
            </div>
            <div class="col-md-6">
            <label class="fs-9"> Sponsor </label>
</div>
            <div class="col-md-10 pb-1">
            <select name="sponsor" class="form-select form-select-sm form-select-solid" >
                <option selected="true" disabled="disabled" >Choose Sponsor</option>
                    <option value="" > No Sponsor </option>
                <?php $select_sponsor = mysqli_query($DB_CONN, "select * from users ");
    while ($row_sponsor = mysqli_fetch_assoc($select_sponsor))
    { ?>

    <option value="<?php echo $row_sponsor['id'] ?>" <?php if ($row_sponsor['id'] == $row_detail['sponsor']) echo 'selected="selected"'; ?> > <?php echo $row_sponsor['username']; ?> </option>
            <?php
    } ?>
            </select>
            </div>
                                <div class="col-md-6">
            <label class="fs-9">Affiliate Referral Tier </label>
            </div>
            <div class="col-md-10 pb-1">
            <select name="tier" class="form-select form-select-sm form-select-solid" >
                <option value="">Select Tier (only if you want to change manually)</option>
                <option value="1" <?=$row_detail['tier'] == 1 ? "selected" : "" ?>>Tier 1</option>
                <option value="2" <?=$row_detail['tier'] == 2 ? "selected" : "" ?>>Tier 2</option>
                <option value="3" <?=$row_detail['tier'] == 3 ? "selected" : "" ?>>Tier 3</option>
            </select>
</div>
    
            
  <div class="col-md-6">
            <label class="fs-9"> Instant/Auto Withdraw Status </label>
            </div>
            <div class="col-md-10 pb-1">
            <select name="auto_withdraw" class="form-select form-select-sm form-select-solid" >
                <option value="0" <?=$row_detail['auto_withdraw'] == 0 ? "selected" : "" ?>>System Settings</option>
                <option value="1" <?=$row_detail['auto_withdraw'] == 1 ? "selected" : "" ?>>Enable Auto Withdrawals</option>
                <option value="2" <?=$row_detail['auto_withdraw'] == 2 ? "selected" : "" ?>>Disable Auto Withdrawals</option>
                <option value="3" <?=$row_detail['auto_withdraw'] == 3 ? "selected" : "" ?>>Disable Instant Withdrawals / Manual</option>
                <option value="4" <?=$row_detail['auto_withdraw'] == 4 ? "selected" : "" ?>>Enable Fake Hash</option>
            </select>
            
                </div>
        <div class="col-md-6">
            <label class="fs-9"> Multiple Account Withdraw Status </label>
            </div>
            <div class="col-md-10 pb-1">
            <select name="allowed_multiple" class="form-select form-select-sm form-select-solid" >
                <option value="0" <?=$row_detail['allowed_multiple'] == 0 ? "selected" : "" ?>>Default</option>
                <option value="1" <?=$row_detail['allowed_multiple'] == 1 ? "selected" : "" ?>>Allow Withdraw</option>
            </select>
            
                </div>     

    <div class="col-md-2">
            <label class="fs-9"> Withdraw Processor</label>
            </div>
            <div class="col-md-10 pb-1">
            <select class="form-select form-select-sm form-select-solid" name="wi_pm_id">
               <option value="0">System Default</option>
                <? $w = mysqli_query($DB_CONN, "SELECT * FROM `payment_methods` WHERE withdraw_allow and json_length(currencies) and status and withdraw");
        while ($value = mysqli_fetch_assoc($w))
        {
?>
                    <option value="<?=$value['id'] ?>" <?=$row_detail['wi_pm_id'] == $value['id'] ? "selected" : "" ?>><?=$value['name'] ?></option>
                    <?
        } ?>
            </select>
            </div>
                        <div class="col-md-6">
            <label class="fs-9"> Min Withdraw</label>
            </div>
            <div class="col-md-10 pb-1">
            <input type="text" name="min_withdraw" value="<?php echo $row_detail['min_withdraw'] ?>" class="form-control form-control-sm">
            </div><div class="col-md-6">
            <label class="fs-9"> Max Withdraw</label>
            </div>
            <div class="col-md-10 pb-1">
            <input type="text" name="max_withdraw" value="<?php echo $row_detail['max_withdraw'] ?>" class="form-control form-control-sm">
            </div>
            <div class="col-md-6">
            <label class="fs-9"> Withdraw Delay Timer (Instant/Auto) - Mins</label>
            </div>
            <div class="col-md-10 pb-1">
    <input type="text" name="delay" value="<?php echo $row_detail['delay'] ?>" class="form-control form-control-sm">
            </div>  
             <div class="col-md-6">
            <label class="fs-9">Author Account </label>
            </div>
            <div class="col-md-10 pb-1">
            <select name="author" class="form-select form-select-sm form-select-solid" >
                <option value="0" <?=$row_detail['author'] == 0 ? "selected" : "" ?>>No</option>
                <option value="1" <?=$row_detail['author'] == 1 ? "selected" : "" ?>>Yes</option>
            </select>
            <div class="col-md-6">
            <label class="fs-9">Account Status </label>
            </div>
            <div class="col-md-10 pb-1">
            <select name="status" class="form-select form-select-sm form-select-solid" >
                <option value="0" <?=$row_detail['status'] == 0 ? "selected" : "" ?>>InActive</option>
                <option value="1" <?=$row_detail['status'] == 1 ? "selected" : "" ?>>Active</option>
                <option value="2" <?=$row_detail['status'] == 2 ? "selected" : "" ?>>Blocked</option>
            </select>
</div>
              <div class="col-md-2">
            <label class="fs-9"> Bio </label>
            </div>
            <div class="col-md-10 pb-1">
            <textarea type="text" name="bio" class="form-control form-control-sm"><?php echo $row_detail['bio'] ?></textarea>
            </div>         
    <div class="col-md-2">
            <label class="fs-9"> Admin Notes</label>
            </div>
            <div class="col-md-10 pb-1">
            <textarea type="text" name="admin_notes" class="form-control form-control-sm"><?php echo $row_detail['admin_notes'] ?></textarea>
            </div>
            
            

          

        </div>
           

</div>
</div>
<br>
<div class="card-footer">
<div class="row">
    <div class="col-md-4">
            <input class="btn btn-primary btn-sm" type="submit" name="submit"value="Update User" >&nbsp;
            </div>      
    </div>
</div>
</form>
</div>
</div>
</div>
</div>

<script>
function togglePassword() {
    const passwordInput = document.getElementById('password');
    const icon = document.querySelector('.ki-eye');
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        icon.classList.remove('ki-eye');
        icon.classList.add('ki-eye-slash');
    } else {
        passwordInput.type = 'password';
        icon.classList.remove('ki-eye-slash');
        icon.classList.add('ki-eye');
    }
}
</script>

<?
}
if ($_GET['view'] == 'logs')
{ ?>
    <div class="card mb-5 mb-lg-10">
    <!--begin::Card header-->
    <div class="card-header">
        <!--begin::Heading-->
        <div class="card-title">
            <h3>Login Sessions</h3>
           
        </div>
        <!--end::Heading-->

       
        <!--end::Toolbar-->
    </div>
    <!--end::Card header-->

    <!--begin::Card body-->
    <div class="card-body p-0">
        
        
        <!--begin::Table wrapper-->
        <div class="table-responsive">
            <!--begin::Table-->
            <table  class="table align-middle table-row-bordered table-row-solid gy-4 gs-9">
                                                    <!--begin::Thead-->
                                                    <thead class="border-gray-200 fs-5 fw-semibold bg-lighten">
                                                        <tr>
                                                            <th class="min-w-250px">Ip</th>
                                                            <th class="min-w-100px">Location</th>
                                                            <th class="min-w-150px">Browser</th>
                                                            <th class="min-w-150px">OS</th>
                                                            <th class="min-w-150px">Time</th>
                                                        </tr>
                                                    </thead>
                                                    <!--end::Thead-->
                                                    <!--begin::Tbody-->
                                                    <tbody class="fw-6 fw-semibold text-gray-600">
                                                         <?php
    $l = mysqli_query($DB_CONN, "select * from login_report where user_id = '$user_id' order by id desc");
    while ($login = mysqli_fetch_assoc($l))
    {
?>
                                                        <tr>
                                                            <td>
                                                                <a  href="#" class="text-hover-primary text-gray-600">    <span class="badge badge-light-primary fs-7 fw-bold"><? echo $login['ip']; ?></span></a>
                                                            </td>
                                                            <td>
                                                            <? echo $login['country']; ?>
                                                            </td>
                                                            <td><? echo $login['browser']; ?></td>
                                                            <td><? echo $login['os']; ?></td>
                                                        
                                                            <td> <?php $dt = date("M d, Y h:i:s A", strtotime($login['datetime']));
        echo time_elapsed_string($dt, true); ?></td>
                                                        </tr>
                                                        <tr>
                                                          <td><span class="text-muted fw-semibold text-muted d-block fs-7">Useragent</span></td> 
                                                          <td colspan="4"><? echo $login['useragent']; ?> </td>
                                                        </tr>
                                                     <?
    } ?>
                                                    </tbody>
                                                    <!--end::Tbody-->
                                                </table>
                                                
          
            <!--end::Table-->
        </div>
        <!--end::Table wrapper-->
    </div>
    <!--end::Card body-->
</div>

<?
}
if ($_GET['view'] == 'activities')

{ ?>
    <div class="card mb-5 mb-lg-10">
    <!--begin::Card header-->
    <div class="card-header">
        <!--begin::Heading-->
        <div class="card-title">
            <h3>Activites</h3>
           
        </div>
        <!--end::Heading-->

       
        <!--end::Toolbar-->
    </div>
    <!--end::Card header-->

    <!--begin::Card body-->
    <div class="card-body p-0">
        
        
        <!--begin::Table wrapper-->
        <div class="table-responsive">
            <!--begin::Table-->
            <table  class="table align-middle table-row-bordered table-row-solid gy-4 gs-9">
                                                    <!--begin::Thead-->
                                                    <thead class="border-gray-200 fs-5 fw-semibold bg-lighten">
                                                        <tr>
                                                            <th class="min-w-250px">Title</th>
                                                            <th class="min-w-100px">Content</th>
                                                            <th class="min-w-150px">DateTime</th>
                                                        
                                                        </tr>
                                                    </thead>
                                                    <!--end::Thead-->
                                                    <!--begin::Tbody-->
                                                    <tbody class="fw-6 fw-semibold text-gray-600">
                                                         <?php
    $l = mysqli_query($DB_CONN, "select * from notifications where user_id = '$user_id' order by id desc");
    while ($activity = mysqli_fetch_assoc($l))
    {
?>
                                                        <tr>
                                                        
                                                            <td>
                                                            <? echo $activity['title']; ?>
                                                            </td>
                                                            <td><? echo $activity['content']; ?></td>
                                                    
                                                        
                                                            <td> <?php $dt = date("M d, Y h:i:s A", strtotime($activity['timestamp']));
        echo time_elapsed_string($dt, true); ?></td>
                                                        </tr>
                                                        
                                                     <?
    } ?>
                                                    </tbody>
                                                    <!--end::Tbody-->
                                                </table>
                                                
          
            <!--end::Table-->
        </div>
        <!--end::Table wrapper-->
    </div>
    <!--end::Card body-->
</div>
<?
} 
} 
}

if ($_GET['page'] == 'check_update')
{
    header("location: bitder?check_update");
}
if ($_GET['page'] == 'performance')
{ ?>

  <div class="card mb-5">
            <div class="card-header min-h-unset py-2">
            <h3 class="card-title align-items-start flex-column">
            <span class="card-label fw-bold text-gray-900">System Performance </span>
            <span class="text-gray-500 mt-1 fw-semibold fs-6">Member Funds Invested, Active Investments, Earnings, Withdrawals</span>
            </h3>
            </div>

            <div class="table-responsive">
            <table  class="table table-striped table-bordered table-sm">
            <thead class="">
            <tr class="">
            <th  class="text-center align-middle">Currencies</th>
            <th  class="text-center"><b>Members Funds Added</b></th>
            <th  class="text-center"><b>Total Invested</b></th>
            <th class="text-center"><b>Active Investments</b></th>
            <th class="text-center"><b>User Earnings</b></th>
            <th class="text-center"><b>Referral Commissions</b></th>
            <th class="text-center"><b>Withdrawals</b></th>
            <th class="text-center"><b>Pending Withdrawals</b></th>
             <th class="text-center"><b>Members Balance</b></th>
             <th class="text-center"><b>Next Earning Est</b></th>
            <th  class="text-center"><b>System Earning</b></th>
            </tr>

            </thead>
            <tbody>
            <?php
    $cur = mysqli_query($DB_CONN, "select * from currencies where de_pm_id or wi_pm_id");
    $totals = array(
        'pm_funds' => 0,
        'pm_deposit' => 0,
        'pm_a_deposit' => 0,
        'pm_earning' => 0,
        'pm_referral' => 0,
        'pm_withdraw' => 0,
        'pm_p_withdraw' => 0,
        'pm_user_balance' => 0,
        'next_day_est' => 0,
        'total_remaining_est' => 0,
        'system_earnings' => 0
    );
    while ($currency = mysqli_fetch_assoc($cur))
    {
        $stat = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT
        (SELECT SUM(amount) FROM transactions 
     WHERE payment_method_id = '{$currency['id']}' 
     AND (txn_type = 'invest' OR txn_type = 'deposit')
     AND status = 1 
     AND user_id NOT IN (SELECT id from users WHERE auto_withdraw = 4)) 
    - 
    (SELECT SUM(amount) FROM transactions 
     WHERE payment_method_id = '{$currency['id']}' 
     AND txn_type = 'withdraw'
     AND status = 1 
     AND user_id NOT IN (SELECT id from users WHERE auto_withdraw = 4))
    -
    (SELECT COALESCE(SUM(balance), 0) FROM user_balances 
     WHERE payment_method_id = '{$currency['id']}' 
     AND user_id NOT IN (SELECT id from users WHERE auto_withdraw = 4))
    as system_earnings,
    (SELECT sum(pd.amount * pp.percent_max / 100 * (p.duration - pd.avail))
     FROM package_deposits pd
     JOIN packages p ON pd.package_id = p.id
     JOIN package_plans pp ON pd.plan_id = pp.id
     WHERE pd.payment_method_id = '{$currency['id']}'
     AND pd.status = 1
     AND pd.user_id NOT IN (SELECT id from users WHERE auto_withdraw = 4)) as total_remaining_est,
     
    (SELECT sum(pd.amount * pp.percent_max / 100)
     FROM package_deposits pd
     JOIN packages p ON pd.package_id = p.id
     JOIN package_plans pp ON pd.plan_id = pp.id
     WHERE pd.payment_method_id = '{$currency['id']}'
     AND pd.status = 1
     AND pd.avail < p.duration
     AND pd.user_id NOT IN (SELECT id from users WHERE auto_withdraw = 4)) as next_day_est,
(SELECT sum(amount) FROM `transactions` where payment_method_id ='{$currency['id']}' and txn_type ='deposit' and status = 1 and user_id NOT IN (SELECT id from users WHERE auto_withdraw = 4)) as pm_funds,
(SELECT sum(amount) FROM `package_deposits` where payment_method_id ='{$currency['id']}' and status = 1 and user_id NOT IN (SELECT id from users WHERE auto_withdraw = 4)) as pm_a_deposit,
(SELECT sum(amount) FROM `transactions` where payment_method_id ='{$currency['id']}' and txn_type ='invest' and status = 1 and user_id NOT IN (SELECT id from users WHERE auto_withdraw = 4)) as pm_deposit,
(SELECT sum(amount) FROM `transactions` where payment_method_id ='{$currency['id']}' and txn_type ='earning' and status = 1 and user_id NOT IN (SELECT id from users WHERE auto_withdraw = 4)) as pm_earning,
(SELECT sum(amount) FROM `transactions` where payment_method_id ='{$currency['id']}' and txn_type ='referral' and status = 1 and user_id NOT IN (SELECT id from users WHERE auto_withdraw = 4)) as pm_referral,
(SELECT sum(amount) FROM `transactions` where payment_method_id ='{$currency['id']}' and txn_type ='withdraw' and status = 0 and user_id NOT IN (SELECT id from users WHERE auto_withdraw = 4)) as pm_p_withdraw,
(SELECT sum(amount) FROM `transactions` where payment_method_id ='{$currency['id']}' and txn_type ='withdraw' and status = 1 and user_id NOT IN (SELECT id from users WHERE auto_withdraw = 4)) as pm_withdraw,
(SELECT sum(balance) FROM `user_balances` where payment_method_id ='{$currency['id']}' and user_id NOT IN (SELECT id from users WHERE auto_withdraw = 4)) as pm_user_balance"));
foreach ($totals as $key => $value) {
            $totals[$key] += $stat[$key];
        }
?>
                                                 <tr class="">
                                                       <td class="p-0 min-w-150px align-middle">
                                                            <div class="d-flex ">
                                                                <div class="symbol symbol-25px me-5">
                                                                    <img alt="Bitcoin" src="images/icons/<?=$currency['id'] ?>.svg">
                                                                </div>
                                                                <div class="d-flex justify-content-start flex-column">
                                                                    <a  href="#" class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6">  <?=$currency['name'] ?></a>
                                                                    </div>
                                                            </div>
                                                        </td>
                                                        <td  class="text-center"> <?=number_format($stat['pm_funds'], $preferences['round']) ?> </td>
                                                        <td  class="text-center"> <?=number_format($stat['pm_deposit'], $preferences['round']) ?> </td>
                                                        <td  class="text-center"> <?=number_format($stat['pm_a_deposit'], $preferences['round']) ?> </td>
                                                        <td  class="text-center"> <?=number_format($stat['pm_earning'], $preferences['round']) ?> </td>
                                                        <td  class="text-center"><?=number_format($stat['pm_referral'], $preferences['round']) ?></td>
                                                        <td  class="text-center"> <?=number_format($stat['pm_withdraw'], $preferences['round']) ?> </td>
                                                        <td  class="text-center"> <?=number_format($stat['pm_p_withdraw'], $preferences['round']) ?> </td>
                                                        <td  class="text-center"> <?=number_format($stat['pm_user_balance'], $preferences['round']) ?> </td>
                                                        <td class="text-center">
                                                            <div class="d-flex flex-column">
                                                                <span class="text-muted fs-7">Next Day: <?=number_format($stat['next_day_est'], $preferences['round'])?></span>
                                                                <span class="fw-bold">Total: <?=number_format($stat['total_remaining_est'], $preferences['round'])?></span>
                                                            </div>
                                                        </td>
                                                       <td  class="text-center"> <?=number_format($stat['system_earnings'], $preferences['round']) ?> </td>
                                                    </tr>
                                         
                    <?
    } ?>                            </tbody>
                                              <tfoot class="">
        <tr class="tr-color">
            <th class="text-center align-middle">Totals</th>
            <th class="text-center"><?=number_format($totals['pm_funds'], $preferences['round'])?></th>
            <th class="text-center"><?=number_format($totals['pm_deposit'], $preferences['round'])?></th>
            <th class="text-center"><?=number_format($totals['pm_a_deposit'], $preferences['round'])?></th>
            <th class="text-center"><?=number_format($totals['pm_earning'], $preferences['round'])?></th>
            <th class="text-center"><?=number_format($totals['pm_referral'], $preferences['round'])?></th>
            <th class="text-center"><?=number_format($totals['pm_withdraw'], $preferences['round'])?></th>
            <th class="text-center"><?=number_format($totals['pm_p_withdraw'], $preferences['round'])?></th>
            <th class="text-center"><?=number_format($totals['pm_user_balance'], $preferences['round'])?></th>
            <th class="text-center">
                <div class="d-flex flex-column">
                    <span class="text-muted fs-7">Next Day: <?=number_format($totals['next_day_est'], $preferences['round'])?></span>
                    <span class="fw-bold">Total: <?=number_format($totals['total_remaining_est'], $preferences['round'])?></span>
                </div>
            </th>
            <th class="text-center"><?=number_format($totals['system_earnings'], $preferences['round'])?></th>
        </tr>
    </tfoot>
                                            </table>
                                        </div>
                                </div>
                                
        <div class="card">
            <div class="card-header min-h-unset py-2">
                                        <h3 class="card-title align-items-start flex-column">
                                                        <span class="card-label fw-bold text-gray-900">Currencies Performance </span>
                                                        <span class="text-gray-500 mt-1 fw-semibold fs-6">In/Outs Currencies Performance</span>
                                                    </h3>
                                        </div>
                        
                                        <div class="table-responsive">
                                            <table  class="table table-striped table-bordered table-sm">
                                                <thead class="">
                                                    <tr class="tr-color">
                                                        <th width="1%" rowspan="2" class="text-center align-middle">Currencies</th>
                                                        <th colspan="2" class="text-center"><b>Today</b></th>
                                                        <th colspan="2" class="text-center"><b>This Week</b></th>
                                                        <th colspan="2" class="text-center"><b>This Month</b></th>
                                                        <th colspan="2" class="text-center"><b>This Year</b></th>
                                                        <th colspan="2" class="text-center"><b>Total</b></th>
                                                    </tr>
                                                    <tr class="thead-bg-1">
                                                        
                                                        <th class="text-center"><b>In</b></th>
                                                        <th class="text-center"><b>Out</b></th>
                                                        <th class="text-center"><b>In</b></th>
                                                        <th class="text-center"><b>Out</b></th>
                                                        <th class="text-center"><b>In</b></th>
                                                        <th class="text-center"><b>Out</b></th>
                                                        <th class="text-center"><b>In</b></th>
                                                        <th class="text-center"><b>Out</b></th>
                                                        <th class="text-center"><b>In</b></th>
                                                        <th class="text-center"><b>Out</b></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
<?php
$cur = mysqli_query($DB_CONN, "SELECT * FROM currencies WHERE de_pm_id OR wi_pm_id");
$total_stats = array(
    'today' => 0,
    'weekly' => 0,
    'monthly' => 0,
    'yearly' => 0,
    'total' => 0,
    'today_profit_est' => 0,
    'weekly_profit_est' => 0,
    'monthly_profit_est' => 0
);

$total_withdrawals = array(
    'today' => 0,
    'weekly' => 0,
    'monthly' => 0,
    'yearly' => 0,
    'total' => 0
);
while ($currency = mysqli_fetch_assoc($cur)) {
    $stat = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT
        /* Today's Deposits */
        (SELECT SUM(amount) FROM `package_deposits` 
         WHERE DATE(`datetime`) = CURDATE() 
         AND payment_method_id = '{$currency['id']}' 
         AND (status = 1 OR last_earningDateTime)) as pm_today,
        
        /* Today's Profit Estimate */
        (SELECT SUM(pd.amount * pp.percent_max / 100)
         FROM package_deposits pd
         JOIN packages p ON pd.package_id = p.id
         JOIN package_plans pp ON pd.plan_id = pp.id
         WHERE DATE(pd.datetime) = CURDATE() 
         AND pd.payment_method_id = '{$currency['id']}'
         AND pd.status = 1) as today_profit_est,
        
        /* Weekly Metrics */
        (SELECT SUM(amount) FROM `package_deposits` 
         WHERE YEARWEEK(`datetime`, 1) = YEARWEEK(CURDATE(), 1)
         AND payment_method_id = '{$currency['id']}'
         AND (status = 1 OR last_earningDateTime)) as pm_weekly,
        
        (SELECT SUM(pd.amount * pp.percent_max / 100)
         FROM package_deposits pd
         JOIN packages p ON pd.package_id = p.id
         JOIN package_plans pp ON pd.plan_id = pp.id
         WHERE YEARWEEK(pd.datetime, 1) = YEARWEEK(CURDATE(), 1)
         AND pd.payment_method_id = '{$currency['id']}'
         AND pd.status = 1) as weekly_profit_est,
        
        /* Monthly Metrics */
        (SELECT SUM(amount) FROM `package_deposits` 
         WHERE MONTH(`datetime`) = MONTH(CURDATE())
         AND YEAR(`datetime`) = YEAR(CURDATE())
         AND payment_method_id = '{$currency['id']}'
         AND (status = 1 OR last_earningDateTime)) as pm_monthly,
        
        (SELECT SUM(pd.amount * pp.percent_max / 100)
         FROM package_deposits pd
         JOIN packages p ON pd.package_id = p.id
         JOIN package_plans pp ON pd.plan_id = pp.id
         WHERE MONTH(pd.datetime) = MONTH(CURDATE())
         AND YEAR(pd.datetime) = YEAR(CURDATE())
         AND pd.payment_method_id = '{$currency['id']}'
         AND pd.status = 1) as monthly_profit_est,
        
        /* Yearly and Total Metrics */
        (SELECT SUM(amount) FROM `package_deposits` 
         WHERE YEAR(`datetime`) = YEAR(CURDATE())
         AND payment_method_id = '{$currency['id']}'
         AND (status = 1 OR last_earningDateTime)) as pm_yearly,
        
        (SELECT SUM(amount) FROM `package_deposits` 
         WHERE payment_method_id = '{$currency['id']}'
         AND (status = 1 OR last_earningDateTime)) as pm_total,
        
        /* Performance Metrics */
        (SELECT AVG(amount) FROM `package_deposits` 
         WHERE payment_method_id = '{$currency['id']}'
         AND status = 1) as avg_deposit_size,
        
        (SELECT COUNT(*) FROM `package_deposits` 
         WHERE payment_method_id = '{$currency['id']}'
         AND status = 1) / 
        NULLIF((SELECT COUNT(*) FROM `package_deposits` 
         WHERE payment_method_id = '{$currency['id']}'), 0) * 100 as success_rate"));

    // Withdrawals statistics
    $with = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT
        (SELECT SUM(amount) FROM `transactions` 
         WHERE DATE(`timestamp`) = CURDATE()
         AND payment_method_id = '{$currency['id']}'
         AND status = 1 AND txn_type = 'withdraw') as pm_today,
         
        (SELECT SUM(amount) FROM `transactions` 
         WHERE YEARWEEK(`timestamp`, 1) = YEARWEEK(CURDATE(), 1)
         AND payment_method_id = '{$currency['id']}'
         AND status = 1 AND txn_type = 'withdraw') as pm_weekly,
         
        (SELECT SUM(amount) FROM `transactions` 
         WHERE MONTH(`timestamp`) = MONTH(CURDATE())
         AND YEAR(`timestamp`) = YEAR(CURDATE())
         AND payment_method_id = '{$currency['id']}'
         AND status = 1 AND txn_type = 'withdraw') as pm_monthly,
         
        (SELECT SUM(amount) FROM `transactions` 
         WHERE YEAR(`timestamp`) = YEAR(CURDATE())
         AND payment_method_id = '{$currency['id']}'
         AND status = 1 AND txn_type = 'withdraw') as pm_yearly,
         
        (SELECT SUM(amount) FROM `transactions` 
         WHERE payment_method_id = '{$currency['id']}'
         AND status = 1 AND txn_type = 'withdraw') as pm_total"));
          $total_stats['today'] += $stat['pm_today'];
    $total_stats['weekly'] += $stat['pm_weekly'];
    $total_stats['monthly'] += $stat['pm_monthly'];
    $total_stats['yearly'] += $stat['pm_yearly'];
    $total_stats['total'] += $stat['pm_total'];
    $total_stats['today_profit_est'] += $stat['today_profit_est'];
    $total_stats['weekly_profit_est'] += $stat['weekly_profit_est'];
    $total_stats['monthly_profit_est'] += $stat['monthly_profit_est'];

    // Add to withdrawal totals
    $total_withdrawals['today'] += $with['pm_today'];
    $total_withdrawals['weekly'] += $with['pm_weekly'];
    $total_withdrawals['monthly'] += $with['pm_monthly'];
    $total_withdrawals['yearly'] += $with['pm_yearly'];
    $total_withdrawals['total'] += $with['pm_total'];
    ?>
    
    <tr>
        <td class="p-0 min-w-150px align-middle">
            <div class="d-flex">
                <div class="symbol symbol-25px me-5">
                    <img alt="<?=$currency['name']?>" src="images/icons/<?=$currency['id']?>.svg">
                </div>
                <div class="d-flex justify-content-start flex-column">
                    <a href="#" class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6"><?=$currency['name']?></a>
                    <span class="text-muted fs-7">Avg: <?=number_format($stat['avg_deposit_size'], $preferences['round'])?></span>
                    <span class="text-muted fs-7">Success: <?=number_format($stat['success_rate'], 1)?>%</span>
                </div>
            </div>
        </td>
        
        <!-- Today's Metrics -->
        <td class="text-center">
            <div class="d-flex flex-column">
                <span class="fw-bold"><?=number_format($stat['pm_today'], $preferences['round'])?></span>
                <span class="text-success fs-7">+<?=number_format($stat['today_profit_est'], $preferences['round'])?></span>
            </div>
        </td>
        <td class="text-center"><?=number_format($with['pm_today'], $preferences['round'])?></td>
        
        <!-- Weekly Metrics -->
        <td class="text-center">
            <div class="d-flex flex-column">
                <span class="fw-bold"><?=number_format($stat['pm_weekly'], $preferences['round'])?></span>
                <span class="text-success fs-7">+<?=number_format($stat['weekly_profit_est'], $preferences['round'])?></span>
            </div>
        </td>
        <td class="text-center"><?=number_format($with['pm_weekly'], $preferences['round'])?></td>
        
        <!-- Monthly Metrics -->
        <td class="text-center">
            <div class="d-flex flex-column">
                <span class="fw-bold"><?=number_format($stat['pm_monthly'], $preferences['round'])?></span>
                <span class="text-success fs-7">+<?=number_format($stat['monthly_profit_est'], $preferences['round'])?></span>
            </div>
        </td>
        <td class="text-center"><?=number_format($with['pm_monthly'], $preferences['round'])?></td>
        
        <!-- Yearly Metrics -->
        <td class="text-center"><?=number_format($stat['pm_yearly'], $preferences['round'])?></td>
        <td class="text-center"><?=number_format($with['pm_yearly'], $preferences['round'])?></td>
        
        <!-- Total Metrics -->
        <td class="text-center"><?=number_format($stat['pm_total'], $preferences['round'])?></td>
        <td class="text-center"><?=number_format($with['pm_total'], $preferences['round'])?></td>
    </tr>
    <?php
}
?>
                                                </tbody>
                                                 <tfoot class="">
                                                    <tr>
                                                        <td class="text-center" rowspan="2">TOTAL</td>
                                                        <td class="text-center text-bold">
                                                            <div class="d-flex flex-column">
                                                                <span class="fw-bold"><?=number_format($total_stats['today'], $preferences['round'])?></span>
                                                                <span class="text-success fs-7">+<?=number_format($total_stats['today_profit_est'], $preferences['round'])?></span>
                                                            </div>
                                                        </td>
                                                        <td class="text-center text-bold"><b><?=number_format($total_withdrawals['today'], $preferences['round'])?></b></td>
                                                        <td class="text-center text-bold">
                                                            <div class="d-flex flex-column">
                                                                <span class="fw-bold"><?=number_format($total_stats['weekly'], $preferences['round'])?></span>
                                                                <span class="text-success fs-7">+<?=number_format($total_stats['weekly_profit_est'], $preferences['round'])?></span>
                                                            </div>
                                                        </td>
                                                        <td class="text-center text-bold"><b><?=number_format($total_withdrawals['weekly'], $preferences['round'])?></b></td>
                                                        <td class="text-center text-bold">
                                                            <div class="d-flex flex-column">
                                                                <span class="fw-bold"><?=number_format($total_stats['monthly'], $preferences['round'])?></span>
                                                                <span class="text-success fs-7">+<?=number_format($total_stats['monthly_profit_est'], $preferences['round'])?></span>
                                                            </div>
                                                        </td>
                                                        <td class="text-center text-bold"><b><?=number_format($total_withdrawals['monthly'], $preferences['round'])?></b></td>
                                                        <td class="text-center text-bold"><b><?=number_format($total_stats['yearly'], $preferences['round'])?></b></td>
                                                        <td class="text-center text-bold"><b><?=number_format($total_withdrawals['yearly'], $preferences['round'])?></b></td>
                                                        <td class="text-center text-bold"><b><?=number_format($total_stats['total'], $preferences['round'])?></b></td>
                                                        <td class="text-center text-bold"><b><?=number_format($total_withdrawals['total'], $preferences['round'])?></b></td>
                                                    </tr>
                                                    <tr>
                                                        <td class="text-center text-bold" colspan="2"><b><?=number_format($total_stats['today'] - $total_withdrawals['today'], $preferences['round'])?></b></td>
                                                        <td class="text-center text-bold" colspan="2"><b><?=number_format($total_stats['weekly'] - $total_withdrawals['weekly'], $preferences['round'])?></b></td>
                                                        <td class="text-center text-bold" colspan="2"><b><?=number_format($total_stats['monthly'] - $total_withdrawals['monthly'], $preferences['round'])?></b></td>
                                                        <td class="text-center text-bold" colspan="2"><b><?=number_format($total_stats['yearly'] - $total_withdrawals['yearly'], $preferences['round'])?></b></td>
                                                        <td class="text-center text-bold" colspan="2"><b><?=number_format($total_stats['total'] - $total_withdrawals['total'], $preferences['round'])?></b></td>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                </div>
                                
                                
                                
<?
}
if ($_GET['page'] == 'launchpad')
{ ?>
<div class="card mb-5 mb-xl-10" id="kt_profile_details_view">
    <div class="card-header cursor-pointer">
        <div class="card-title m-0">
            <h3 class="fw-bold m-0">LaunchPad</h3>
        </div>
    </div>
    <div class="card-body p-9">
        <div class="row mb-3">
            <label class="col-lg-4 fw-semibold text-muted">Site Name</label>
            <div class="col-lg-8">                    
                <span class="fw-bold fs-6 text-gray-800"><?=$pref['title'] ?></span>              
            </div>
        </div>
          <div class="row mb-3">
            <label class="col-lg-4 fw-semibold text-muted">Site Name</label>
            <div class="col-lg-8">                    
                <span class="fw-bold fs-6 text-gray-800"><?=$pref['domain'] ?></span>              
            </div>
        </div>
          <div class="row mb-3">
            <label class="col-lg-4 fw-semibold text-muted">Start Date</label>
            <div class="col-lg-8">                    
                <span class="fw-bold fs-6 text-gray-800"><?=$pref['datetime'] ?></span>               
            </div>
        </div>
           <div class="row mb-3">
            <label class="col-lg-4 fw-semibold text-muted">TimeZone</label>
            <div class="col-lg-8">                    
                <span class="fw-bold fs-6 text-gray-800"><?=$pref['timezone'] ? :'GMT' ?></span>                
            </div>
        </div>
               <div class="row mb-3">
            <label class="col-lg-4 fw-semibold text-muted">SMTP</label>
            <div class="col-lg-8">                    
                <span class="fw-bold fs-6 text-gray-800"><?=$email_settings['type'] ? 'PHP' :'SMTP ENABLED' ?></span>                
            </div>
        </div>
         <div class="row mb-3">
            <label class="col-lg-4 fw-semibold text-muted">Telegram </label>
            <div class="col-lg-8">                    
                <span class="fw-bold fs-6 text-gray-800"><?=$telegram_settings['personal_id'] ? 'SET' : 'Not Set' ?></span>                
            </div>
        </div>
        <div class="row mb-3">
            <label class="col-lg-4 fw-semibold text-muted">Plans </label>
            <div class="col-lg-8">                    
                <span class="fw-bold fs-6 text-gray-800"><?=$telegram_settings['personal_id'] ? 'Not Set' :'SET' ?></span>       
                <?php var_dump($packages);
                foreach($packages as $p): ?>
    <div class="col">
        <article class="card h-100 shadow-sm border-0">
            <div class="card-header bg-primary bg-gradient text-white py-3">
                <h2 class="h5 card-title text-center mb-0 fw-bold">
                    <?php echo htmlspecialchars($p['name']); ?>
                </h2>
            </div>
            <?php if(isset($p['plans'])): ?>
                <?php foreach($p['plans'] as $o): ?>
                    <div class="card-body p-4">
                        <div class="text-center mb-4">
                            <span class="display-6 fw-bold text-primary">
                                <?php 
                                if($p['etype'] == 0) {
                                    echo $o['percent'];
                                } elseif($p['etype'] == 1 || $p['etype'] == 2) {
                                    echo $o['percent_min'] . '~' . $o['percent_max'];
                                }
                                ?>
                            </span>
                            <p class="text-muted mb-0">
                                <?php echo $p['frequency']; ?><?php echo ($p['period'] > 1) ? 's' : ''; ?>
                            </p>
                        </div>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span class="text-muted">Minimum Deposit</span>
                                <strong aria-label="Minimum deposit amount: <?php echo $o['min_deposit']; ?>">
                                    <?php echo $o['min_deposit']; ?>
                                </strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span class="text-muted">Maximum Deposit</span>
                                <strong aria-label="Maximum deposit amount: <?php echo $o['max_deposit']; ?>">
                                    <?php echo $o['max_deposit']; ?>
                                </strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span class="text-muted">Accrual Period</span>
                                <strong aria-label="Accrual period: <?php echo $p['accurals']; ?> times">
                                    <?php echo $p['accurals']; ?>
                                </strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span class="text-muted">Duration</span>
                                <strong aria-label="Duration: <?php echo $p['days']; ?> days">
                                    <?php echo $p['days']; ?> Days
                                </strong>
                            </li>
                        </ul>
                    </div>
                <?php endforeach; ?>
            <?php endif; ?>
            </div>
             <?php endforeach; ?>
        </div>
        <div class="row mb-3">
            <label class="col-lg-4 fw-semibold text-muted">Referral </label>
            <div class="col-lg-8">                    
                <span class="fw-bold fs-6 text-gray-800"><?=$telegram_settings['personal_id'] ? 'Not Set' :'SET' ?></span>                
            </div>
        </div>
         <div class="row mb-3">
            <label class="col-lg-4 fw-semibold text-muted">Payment Methods</label>
            <div class="col-lg-8">                    
                <span class="fw-bold fs-6 text-gray-800"><?=$email_settings['type'] ? 'PHP' :'SMTP ENABLED' ?></span>                
            </div>
        </div>
        

        <!--begin::Input group-->
        <div class="row mb-7">
            <!--begin::Label-->
            <label class="col-lg-4 fw-semibold text-muted">Site URL</label>
            <!--end::Label-->

            <!--begin::Col-->
            <div class="col-lg-8 fv-row">
                <span class="fw-semibold text-gray-800 fs-6">Keenthemes</span>                         
            </div>
            <!--end::Col-->
        </div>
        <!--end::Input group-->

        <!--begin::Input group-->
        <div class="row mb-7">
           <!--begin::Label-->
           <label class="col-lg-4 fw-semibold text-muted">
                Contact Phone

                <span class="ms-1" data-bs-toggle="tooltip" aria-label="Phone number must be active" data-bs-original-title="Phone number must be active" data-kt-initialized="1">
                    <i class="ki-duotone ki-information fs-7"><span class="path1"></span><span class="path2"></span><span class="path3"></span></i>                </span>              
            </label>
            <!--end::Label-->
            
            <!--begin::Col-->
            <div class="col-lg-8 d-flex align-items-center">
                <span class="fw-bold fs-6 text-gray-800 me-2">044 3276 454 935</span>                      
                <span class="badge badge-success">Verified</span>
            </div>
            <!--end::Col-->
        </div>
        <!--end::Input group-->

        <!--begin::Input group-->
        <div class="row mb-7">
            <!--begin::Label-->
            <label class="col-lg-4 fw-semibold text-muted">Company Site</label>
            <!--end::Label-->

            <!--begin::Col-->
            <div class="col-lg-8">
                <a href="#" class="fw-semibold fs-6 text-gray-800 text-hover-primary">keenthemes.com</a>                         
            </div>
            <!--end::Col-->
        </div>
        <!--end::Input group-->

        <!--begin::Input group-->
        <div class="row mb-7">
             <!--begin::Label-->
             <label class="col-lg-4 fw-semibold text-muted">
                Country
                
                <span class="ms-1" data-bs-toggle="tooltip" aria-label="Country of origination" data-bs-original-title="Country of origination" data-kt-initialized="1">
                    <i class="ki-duotone ki-information fs-7"><span class="path1"></span><span class="path2"></span><span class="path3"></span></i>                </span>
            </label>
            <!--end::Label-->

            <!--begin::Col-->
            <div class="col-lg-8">
                <span class="fw-bold fs-6 text-gray-800">Germany</span> 
            </div>
            <!--end::Col-->
        </div>
        <!--end::Input group-->    

        <!--begin::Input group-->
        <div class="row mb-7">
            <!--begin::Label-->
            <label class="col-lg-4 fw-semibold text-muted">Communication</label>
            <!--end::Label-->

            <!--begin::Col-->
            <div class="col-lg-8">
                <span class="fw-bold fs-6 text-gray-800">Email, Phone</span>  
            </div>
            <!--end::Col-->
        </div>
        <!--end::Input group-->

        <!--begin::Input group-->
        <div class="row mb-10">
            <!--begin::Label-->
            <label class="col-lg-4 fw-semibold text-muted">Allow Changes</label>
            <!--begin::Label-->

            <!--begin::Label-->
            <div class="col-lg-8">
                <span class="fw-semibold fs-6 text-gray-800">Yes</span> 
            </div>
            <!--begin::Label-->
        </div>
        <!--end::Input group-->

        
<!--begin::Notice-->
<div class="notice d-flex bg-light-warning rounded border-warning border border-dashed  p-6">
            <!--begin::Icon-->
        <i class="ki-duotone ki-information fs-2tx text-warning me-4"><span class="path1"></span><span class="path2"></span><span class="path3"></span></i>        <!--end::Icon-->
    
    <!--begin::Wrapper-->
    <div class="d-flex flex-stack flex-grow-1 ">
                    <!--begin::Content-->
            <div class=" fw-semibold">
                                    <h4 class="text-gray-900 fw-bold">We need your attention!</h4>
                
                                    <div class="fs-6 text-gray-700 ">Your payment was declined. To start using tools, please <a class="fw-bold" href="/metronic8/demo1/account/billing.html">Add Payment Method</a>.</div>
                            </div>
            <!--end::Content-->
        
            </div>
    <!--end::Wrapper-->  
</div>
<!--end::Notice-->
    </div>
    <!--end::Card body-->     
</div>

<?
}
if (basename($_SERVER["REQUEST_URI"]) == 'admin')
{
    ?>

                                           
                                           <div class="row gy-5 g-xl-10">
                                        <!--begin::Col-->
                                        <div class="col-sm-6 col-xl-3 mb-xl-10">
                                            <!--begin::Card widget 2-->
                                            <div class="card h-lg-100">
                                                <!--begin::Body-->
                                                <div class="card-body d-flex justify-content-between align-items-start flex-column">
                                                    <!--begin::Icon-->
                                                
                                                    <!--end::Icon-->
                                                    <!--begin::Section-->
                                                    <div class="d-flex flex-column my-2">
                                                        <!--begin::Number-->
                                                        <span class="fw-semibold fs-2x text-gray-800 lh-1 ls-n2"><?php echo $b = mysqli_num_rows(mysqli_query($DB_CONN, "select * from users")) ?></span>
                                                        <!--end::Number-->
                                                        <!--begin::Follower-->
                                                        <div class="m-0">
                                                            <span class="fw-semibold fs-6 text-gray-500">Users</span>
                                                        </div>
                                                        <!--end::Follower-->
                                                    </div>
                                                    <!--end::Section-->
                                                    <!--begin::Badge-->
                                                        <div class="d-flex flex-stack">
                                                                <!--begin::Section-->
                                                                <div class="text-gray-700 fw-semibold fs-6 me-2">Active </div>
                                                                <!--end::Section-->
                                                                <!--begin::Statistics-->
                                                                <div class="d-flex align-items-senter">
                                                                    <i class="ki-duotone ki-arrow-up-right fs-2 text-success me-2">
                                                                        <span class="path1"></span>
                                                                        <span class="path2"></span>
                                                                    </i>
                                                                    <!--begin::Number-->
                                                                    <span class="text-gray-900 fw-bolder fs-6"><?php echo $b = mysqli_num_rows(mysqli_query($DB_CONN, "select * from users where status = 1")) ?></span>
                                                                    <!--end::Number-->
                                                                
                                                                </div>
                                                                <!--end::Statistics-->
                                                            </div>
                                                                <div class="d-flex flex-stack">
                                                                <!--begin::Section-->
                                                                <div class="text-gray-700 fw-semibold fs-6 me-2">Blocked </div>
                                                                <!--end::Section-->
                                                                <!--begin::Statistics-->
                                                                <div class="d-flex align-items-senter">
                                                                    <i class="ki-duotone ki-arrow-up-right fs-2 text-success me-2">
                                                                        <span class="path1"></span>
                                                                        <span class="path2"></span>
                                                                    </i>
                                                                    <!--begin::Number-->
                                                                    <span class="text-gray-900 fw-bolder fs-6"><?php echo $b = mysqli_num_rows(mysqli_query($DB_CONN, "select * from users where status = 2")) ?></span>
                                                                    <!--end::Number-->
                                                                
                                                                </div>
                                                                <!--end::Statistics-->
                                                            </div>
                                                                <div class="d-flex flex-stack">
                                                                <!--begin::Section-->
                                                                <div class="text-gray-700 fw-semibold fs-6 me-2">Funded </div>
                                                                <!--end::Section-->
                                                                <!--begin::Statistics-->
                                                                <div class="d-flex align-items-senter">
                                                                    <i class="ki-duotone ki-arrow-up-right fs-2 text-success me-2">
                                                                        <span class="path1"></span>
                                                                        <span class="path2"></span>
                                                                    </i>
                                                                    <!--begin::Number-->
                                                                    <span class="text-gray-900 fw-bolder fs-6"><?php echo $a = mysqli_num_rows(mysqli_query($DB_CONN, "SELECT DISTINCT user_id FROM `package_deposits` where status = 1")) ?></span> 
                                                                    <!--end::Number-->
                                                                
                                                                </div>
                                                                <!--end::Statistics-->
                                                            </div>
                                                    <!--end::Badge-->
                                                </div>
                                                <!--end::Body-->
                                            </div>
                                            <!--end::Card widget 2-->
                                        </div>
                                        <!--end::Col-->
                                        <!--begin::Col-->
                                        <div class="col-sm-6 col-xl-3 mb-xl-10">
                                            <!--begin::Card widget 2-->
                                            <div class="card h-lg-100">
                                                <!--begin::Body-->
                                                <div class="card-body d-flex justify-content-between align-items-start flex-column">
                                                    <!--begin::Icon-->
                                                
                                                    <!--end::Icon-->
                                                    <!--begin::Section-->
                                                    <div class="d-flex flex-column my-2">
                                                        <!--begin::Number-->
                                                        <span class="fw-semibold fs-2x text-gray-800 lh-1 ls-n2"><?php $q1 = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT sum(amount) as c FROM `package_deposits` where (status = 1 or last_earningDateTime)")) ['c'];
    echo number_format($q1, $preferences['round']) ?> <small class="fs-7"><?=$preferences['symbol'] ?></small> </span> 
                                                        <!--end::Number-->
                                                        <!--begin::Follower-->
                                                        <div class="m-0">
                                                            <span class="fw-semibold fs-6 text-gray-500">Investments</span>
                                                        </div>
                                                        <!--end::Follower-->
                                                    </div>
                                                    <!--end::Section-->
                                                    <!--begin::Badge-->
                                            <div class="d-flex flex-stack">
                                                                <!--begin::Section-->
                                                                <div class="text-gray-700 fw-semibold fs-6 me-2">Total </div>
                                                                <!--end::Section-->
                                                                <!--begin::Statistics-->
                                                                <div class="d-flex align-items-senter">
                                                                    <i class="ki-duotone ki-arrow-up-right fs-2 text-success me-2">
                                                                        <span class="path1"></span>
                                                                        <span class="path2"></span>
                                                                    </i>
                                                                    <!--begin::Number-->
                                                                    <span class="text-gray-900 fw-bolder fs-6"><small class="fs-8"><?=$preferences['symbol'] ?></small> <?php $q1 = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT sum(amount) as c FROM `package_deposits` where (status = 1 or last_earningDateTime)")) ['c'];
    echo number_format($q1, $preferences['round']) ?></span>
                                                                    <!--end::Number-->
                                                                
                                                                </div>
                                                                <!--end::Statistics-->
                                                            </div>
                                                            
                                                            <div class="d-flex flex-stack">
                                                                <!--begin::Section-->
                                                                <div class="text-gray-700 fw-semibold fs-6 me-2">Active</div>
                                                                <!--end::Section-->
                                                                <!--begin::Statistics-->
                                                                <div class="d-flex align-items-senter">
                                                                    <i class="ki-duotone ki-arrow-up-right fs-2 text-success me-2">
                                                                        <span class="path1"></span>
                                                                        <span class="path2"></span>
                                                                    </i>
                                                                    <!--begin::Number-->
                                                                    <span class="text-gray-900 fw-bolder fs-6"><small class="fs-8"><?=$preferences['symbol'] ?></small> <?php $q1 = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT sum(amount) as c FROM `package_deposits` where txn_id != ''")) ['c'];
    echo number_format($q1, $preferences['round']) ?></span>
                                                                    <!--end::Number-->
                                                                
                                                                </div>
                                                                <!--end::Statistics-->
                                                            </div>
                                                            <div class="d-flex flex-stack">
                                                                <!--begin::Section-->
                                                                <div class="text-gray-700 fw-semibold fs-6 me-2">Pending</div>
                                                                <!--end::Section-->
                                                                <!--begin::Statistics-->
                                                                <div class="d-flex align-items-senter">
                                                                    <i class="ki-duotone ki-arrow-up-right fs-2 text-success me-2">
                                                                        <span class="path1"></span>
                                                                        <span class="path2"></span>
                                                                    </i>
                                                                    <!--begin::Number-->
                                                                    <span class="text-gray-900 fw-bolder fs-6"><small class="fs-8"><?=$preferences['symbol'] ?></small> <?php $q1 = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT sum(amount) as c FROM `package_deposits` where txn_id = '' and status = 0")) ['c'];
    echo number_format($q1, $preferences['round']) ?></span>
                                                                    <span class="text-gray-500 fw-bold fs-6"> <span class="badge badge-warning ms-2"><?php $q1 = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT count(id) as c FROM `package_deposits` where txn_id = '' and status = 0")) ['c'];
    echo number_format($q1) ?></span></span>
                                                                    <!--end::Number-->
                                                                
                                                                </div>
                                                                <!--end::Statistics-->
                                                            </div>
                                                            
                                                    <!--end::Badge-->
                                                </div>
                                                <!--end::Body-->
                                            </div>
                                            <!--end::Card widget 2-->
                                        </div>
                                        <!--end::Col-->
                                        <!--begin::Col-->
                                
                                        <!--end::Col-->
                                        <!--begin::Col-->
                                        <div class="col-sm-6 col-xl-3 mb-xl-10">
                                            <!--begin::Card widget 2-->
                                            <div class="card h-lg-100">
                                                <!--begin::Body-->
                                                <div class="card-body d-flex justify-content-between align-items-start flex-column">
                                                    <!--begin::Icon-->
                                                
                                                    <!--end::Icon-->
                                                    <!--begin::Section-->
                                                    <div class="d-flex flex-column my-2">
                                                        <!--begin::Number-->
                                                        <span class="fw-semibold fs-2x text-gray-800 lh-1 ls-n2"><?php $q1 = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT sum(amount) as c FROM `transactions` where txn_type = 'earning' ")) ['c'];
    $q1 = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT sum(amount) as c FROM `transactions` where txn_type = 'referral' ")) ['c'];
    echo number_format($q1 + $q2, $preferences['round']) ?> <small class="fs-7"><?=$preferences['symbol'] ?></small> </span>
                                                        <!--end::Number-->
                                                        <!--begin::Follower-->
                                                        <div class="m-0">
                                                            <span class="fw-semibold fs-6 text-gray-500">Earnings</span>
                                                        </div>
                                                        <!--end::Follower-->
                                                    </div>
                                                    <!--end::Section-->
                                                    <!--begin::Badge-->
                                                
                                                    <div class="d-flex flex-stack">
                                                                <!--begin::Section-->
                                                                <div class="text-gray-700 fw-semibold fs-6 me-2">Earnings </div>
                                                                <!--end::Section-->
                                                                <!--begin::Statistics-->
                                                                <div class="d-flex align-items-senter">
                                                                    <i class="ki-duotone ki-arrow-up-right fs-2 text-success me-2">
                                                                        <span class="path1"></span>
                                                                        <span class="path2"></span>
                                                                    </i>
                                                                    <!--begin::Number-->
                                                                    <span class="text-gray-900 fw-bolder fs-6"><small class="fs-8"><?=$preferences['symbol'] ?></small> <?php $q2 = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT sum(amount) as c FROM `transactions` where txn_type = 'earning'")) ['c'];
    echo number_format($q2, $preferences['round']) ?></span>
                                                                    <!--end::Number-->
                                                                
                                                                </div>
                                                                <!--end::Statistics-->
                                                            </div>
                                                                <div class="d-flex flex-stack">
                                                                <!--begin::Section-->
                                                                <div class="text-gray-700 fw-semibold fs-6 me-2">Referrals </div>
                                                                <!--end::Section-->
                                                                <!--begin::Statistics-->
                                                                <div class="d-flex align-items-senter">
                                                                    <i class="ki-duotone ki-arrow-up-right fs-2 text-success me-2">
                                                                        <span class="path1"></span>
                                                                        <span class="path2"></span>
                                                                    </i>
                                                                    <!--begin::Number-->
                                                                    <span class="text-gray-900 fw-bolder fs-6"><small class="fs-8"><?=$preferences['symbol'] ?></small> <?php $q2 = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT sum(amount) as c FROM `transactions` where txn_type = 'referral'")) ['c'];
    echo number_format($q2, $preferences['round']) ?></span>
                                                                    <!--end::Number-->
                                                                
                                                                </div>
                                                                <!--end::Statistics-->
                                                            </div>
                                                            <div class="d-flex flex-stack">
                                                                <!--begin::Section-->
                                                                <div class="text-gray-700 fw-semibold fs-6 me-2">Faucets  </div>
                                                                <!--end::Section-->
                                                                <!--begin::Statistics-->
                                                                <div class="d-flex align-items-senter">
                                                                    <i class="ki-duotone ki-arrow-up-right fs-2 text-success me-2"> 
                                                                        <span class="path1"></span>
                                                                        <span class="path2"></span>
                                                                    </i>
                                                                    <!--begin::Number-->
                                                                    <span class="text-gray-900 fw-bolder fs-6"><small class="fs-8"><?=$preferences['symbol'] ?></small> <?php $q2 = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT sum(amount) as c FROM `transactions` where txn_type = 'faucet'")) ['c'];
    echo number_format($q2, $preferences['round']) ?></span>
                                                                    <!--end::Number-->
                                                                
                                                                </div>
                                                                <!--end::Statistics-->
                                                            </div>
                                                            
                                                    <!--end::Badge-->
                                                </div>
                                                <!--end::Body-->
                                            </div>
                                            <!--end::Card widget 2-->
                                        </div>
                                        <!--end::Col-->
                                        <!--begin::Col-->
                                        <div class="col-sm-6 col-xl-3 mb-5 mb-xl-10">
                                            <!--begin::Card widget 2-->
                                            <div class="card h-lg-100">
                                                <!--begin::Body-->
                                                <div class="card-body d-flex justify-content-between align-items-start flex-column">
                                                    <!--begin::Icon-->
                                                
                                                    <!--end::Icon-->
                                                    <!--begin::Section-->
                                                    <div class="d-flex flex-column my-2">
                                                        <!--begin::Number-->
                                                        <span class="fw-semibold fs-2x text-gray-800 lh-1 ls-n2"><?php $q2 = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT sum(amount) as c FROM `transactions` where txn_type = 'withdraw' ")) ['c'];
    echo number_format($q2, $preferences['round']) ?> <small class="fs-7"><?=$preferences['symbol'] ?></small> </span>
                                                        <!--end::Number-->
                                                        <!--begin::Follower-->
                                                        <div class="m-0">
                                                            <span class="fw-semibold fs-6 text-gray-500">Withdrawals</span>
                                                        </div>
                                                        <!--end::Follower-->
                                                    </div>
                                                    <!--end::Section-->
                                                    <!--begin::Badge-->
                                                        
                                            <div class="d-flex flex-stack">
                                                                <!--begin::Section-->
                                                                <div class="text-gray-700 fw-semibold fs-6 me-2">Total</div>
                                                                <!--end::Section-->
                                                                <!--begin::Statistics-->
                                                                <div class="d-flex align-items-senter">
                                                                    <i class="ki-duotone ki-arrow-up-right fs-2 text-success me-2">
                                                                        <span class="path1"></span>
                                                                        <span class="path2"></span>
                                                                    </i>
                                                                    <!--begin::Number-->
                                                                    <span class="text-gray-900 fw-bolder fs-6"><small class="fs-8"><?=$preferences['symbol'] ?></small> <?php $q2 = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT sum(amount) as c FROM `transactions` where txn_type = 'withdraw' ")) ['c'];
    echo number_format($q2, $preferences['round']) ?></span>
                                                                    
                                                                    <!--end::Number-->
                                                                
                                                                </div>
                                                                <!--end::Statistics-->
                                                            </div>
                                                            
                                                            <div class="d-flex flex-stack">
                                                                <!--begin::Section-->
                                                                <div class="text-gray-700 fw-semibold fs-6 me-2">Pending</div>
                                                                <!--end::Section-->
                                                                <!--begin::Statistics-->
                                                                <div class="d-flex align-items-senter">
                                                                    <i class="ki-duotone ki-arrow-up-right fs-2 text-success me-2">
                                                                        <span class="path1"></span>
                                                                        <span class="path2"></span>
                                                                    </i>
                                                                    <!--begin::Number-->
                                                                    <span class="text-gray-900 fw-bolder fs-6"><small class="fs-8"><?=$preferences['symbol'] ?></small> <?php $q2 = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT sum(amount) as c FROM `transactions` where txn_type = 'withdraw' and txn_id !='' and status = '0' ")) ['c'];
    echo number_format($q2, $preferences['round']) ?></span>
                                                                    <span class="text-gray-500 fw-bold fs-6"> <span class="badge badge-danger ms-2"><?php $q1 = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT count(id) as c FROM `transactions` where txn_type = 'withdraw'   and txn_id !='' and status = '0' ")) ['c'];
    echo number_format($q1) ?></span></span>
                                                                    <!--end::Number-->
                                                                
                                                                </div>
                                                                <!--end::Statistics-->
                                                            </div>
                                                            
                                                            
                                                            
                                                    <!--end::Badge-->
                                                </div>
                                                <!--end::Body-->
                                            </div>
                                            <!--end::Card widget 2-->
                                        </div>
                                        <!--end::Col-->
                                        <!--begin::Col-->
                                
                                        <!--end::Col-->
                                    </div>
                                    <div class="row gy-5 g-xl-10">
                                        <div class="col-xl-5">
                                            <div class="card card-bordered">
                                                <div class="card-header ">
                                                    <!--begin::Title-->
                                                    <h3 class="card-title align-items-start flex-column">
                                                        <span class="card-label fw-bold text-gray-900">Investment Plans</span>
                                                        <span class="text-gray-500 pt-2 fw-semibold fs-6">Total Plans <span class="badge badge-primary ms-2"><?php echo mysqli_num_rows(mysqli_query($DB_CONN, "SELECT id FROM `packages` where status = 1")) ?></span> | Active Users <span class="badge badge-warning ms-2"><?php echo mysqli_num_rows(mysqli_query($DB_CONN, "SELECT id FROM `package_deposits` where status = 1")) ?></span> </span>
                                                    </h3>
                                                    <!--end::Title-->
                                                    <!--begin::Toolbar-->
                                            
                                                    <!--end::Toolbar-->
                                                </div>
    <div class="card-body">
        <div id="chartdiv" class="w-100 h-400px" ></div>
    </div>
</div>
                                        </div>
                                        <div class="col-xl-7">
                                            <div class="card card-bordered">
                                                    <div class="card-header ">
                                                    <!--begin::Title-->
                                                    <h3 class="card-title align-items-start flex-column">
                                                        <span class="card-label fw-bold text-gray-900">Finance Performance</span>
                                                    </h3>
                                                    <!--end::Title-->
                                                    <!--begin::Toolbar-->
                                                <div class="card-toolbar">
                                                <a  href="admin?page=transactions" class="btn btn-sm btn-light-primary">
                                                <i class="ki-duotone ki-graph fs-2"><span class="path1"></span>
                                                <span class="path2"></span>
                                                <span class="path3"></span>
                                                <span class="path4"></span></i>
                                                 Detailed Performance</a>
                                            </div>
                                                    <!--end::Toolbar-->
                                                </div>
    <div class="card-body">
        <div id="kt_amcharts_1" class=" h-400px"></div>
    </div>
</div>
                                        </div>
                                    </div>    
                                           
                        <div class="card my-5  card-bordered">
                            <div class="card-header border-0 pt-5">
                                            <h3 class="card-title align-items-start flex-column">
                                                <span class="card-label fw-bold fs-3 mb-1">Transactions</span>
                                                <span class="text-muted mt-1 fw-semibold fs-7">Last 10 System Transactions</span>
                                            </h3>
                                            <div class="card-toolbar">
                                                <a  href="admin?page=transactions" class="btn btn-sm btn-light-primary">
                                                <i class="ki-duotone ki-book fs-2"><span class="path1"></span>
                                                <span class="path2"></span>
                                                <span class="path3"></span>
                                                <span class="path4"></span></i>
                                                 See All</a>
                                            </div>
                                        </div>
    <div class="card-body p-0">
    <div class="table-responsive">
                                                        <!--begin::Table-->
                                                        <table  class="table table-rounded table-row-dashed  table-hover  gs-0 gy-4 ">
                                                            <!--begin::Table head-->
                                                            <thead>
                                                                <tr class="fw-bold text-muted bg-light border-bottom border-gray-300">
                                                                    <th class="  px-5 py-0  align-middle">ID</th>
                                                                    <th class="">Type</th>
                                                                <th class="">User</th>
                                                                <th class="">Currency</th>
                                                                    <th class="">Amount</th>
                                                                    <th class="  ">Timestamp</th>
                                                                    
                                                                </tr>
                                                            </thead>
                                                            <!--end::Table head-->
                                                            <!--begin::Table body-->
                                                            <tbody>
                                                            <? $d = mysqli_query($DB_CONN, "SELECT *, (SELECT name FROM currencies WHERE id =  transactions.payment_method_id) as currency,(SELECT symbol FROM currencies WHERE id =  transactions.payment_method_id) as symbol, (SELECT username FROM users WHERE id =  transactions.user_id) as username, (SELECT email FROM users WHERE id =  transactions.user_id) as email FROM `transactions` WHERE user_id NOT IN (SELECT id from users WHERE auto_withdraw = 4) order by id desc limit 20");
                if (mysqli_num_rows($d))
                {
                    while ($tx = mysqli_fetch_assoc($d))
                    { ?>
    
    <tr >
            <td class=" px-5 py-0  align-middle border-gray-500" <?if($tx['txn_id']){?>rowspan="3"<?}else{?>rowspan="2"<?}?> class="ps-0"><?=$tx['id']?></td>
                <td>
              <? echo getBadge($tx['txn_type']); ?>
            </td>
            <td class="p-0">
                                                                <div class="d-flex align-items-center">
                                                                
                                                                
                                                                    <!--begin::Name-->
                                                                    <div class="d-flex justify-content-start flex-column">
                                                                        <a  href="admin?page=user&id=<?=$tx['user_id']?>&view=overview" class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6">   <?=$tx['username']?></a>
                                                                        <a  href="admin?page=user&id=<?=$tx['user_id']?>&view=overview" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-9">
                                                                        <span class="text-gray-900">@</span>:   <?=$tx['email']?></a>
                                                                    </div>
                                                                    <!--end::Name-->
                                                                </div>
                                                            </td>
            
        <td class="p-0">
                
                                                                <div class="d-flex align-items-center">
                                                                    <!--begin::Avatar-->
                                                                    <div class="symbol symbol-20px me-5">
                                                                        <img alt="<?=$tx['cname']?>" src="images/icons/<?=$tx['payment_method_id']?>.svg" width="15px">
                                                                    </div>
                                                                    <!--end::Avatar-->
                                                                    <!--begin::Name-->
                                                                    <div class="d-flex justify-content-start flex-column">
                                                                        <a  href="#" class="text-gray-900 fw-bold text-hover-primary  fs-6">  <?=$tx['currency']?></a>
                                                                        <a  href="#" class="text-muted text-hover-primary fw-semibold text-muted d-block fs-7">
                                                                        <span class="text-gray-900">Symbol</span>:  <?=$tx['symbol']?></a>
                                                                    </div>
                                                                    <!--end::Name-->
                                                                </div>
            
            </td >
            <td class="p-0">
                <a  class="text-gray-900 fw-bold text-hover-primary d-block mb-1 fs-6"><?=fiat($tx['amount'])?></a>
                <span class="text-muted fw-semibold text-muted d-block fs-7">Fee: <?=fiat($tx['fee'])?></span>
                
            
            </td>
        
            
            <td class="p-0">
                                                                                <span class="text-gray-900 fw-bold d-block fs-7"><?=$tx['timestamp'] ?></span>
                                                                                <span class="text-muted fw-semibold d-block fs-8"><?php $dt = date("M d, Y h:i:s A", strtotime($tx['timestamp']));
            echo time_elapsed_string($dt, true); ?></span>
                                                                            </td>
        
    <tr >
            <td class="pb-1 pt-1 <? if($tx['txn_id']){?>  <? }else{ ?>border-gray-500<? } ?>">Details</td>
              <td class="pb-1 pt-1 <? if($tx['txn_id']){?>  <? }else{ ?>border-gray-500<? } ?>" colspan="6">
                                                                <span  class="badge badge-sm badge-light fs-12"><?=$tx['detail']?></span>
                                                            
                                                            </td>
                                                        
                                                        
        </tr>
    <? if($tx['txn_id']){?>
        <tr >
            <td class="pb-1 pt-1 border-gray-500">Transaction</td>
            <td class="pb-1 pt-1 border-gray-500" colspan="6" ><span class="text-muted fw-semibold text-muted  fs-7"><?=$tx['packagename']?>    <?      switch($tx['status']) {
        case '0':?>
                <span class="badge badge-light-info">Pending</span>
         <? ; break; case '1'     ?>    
            <span class="badge badge-light-success"> Done</span>
            <? ; break; }?></span><a  href="<?=$tx['chain_url']?><?=$tx['txn_id']?>" target="_blank"><span class="badge badge-sm badge-light"><?=$tx['txn_id']?></span></a></td>
            
        </tr>
        <?
    }
} ?>
                    
                                                            </tbody>
                                
     <?
}
else
{ ?>
        <tfoot>
                                                            
            <tr>
                <td> No Transactions found</td>
            </tr>                                           
                
                </tfoot>      
                <?
} ?>                            
        <!--end::Table body-->
    </table>
    <!--end::Table-->
</div>
</div></div>

<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
<script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
<script src="https://cdn.amcharts.com/lib/5/radar.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Dataviz.js"></script>
<script>
    am5.ready(function () {
    // Create root element
    // https://www.amcharts.com/docs/v5/getting-started/#Root_element
    var root = am5.Root.new("chartdiv");

    // Set themes
    // https://www.amcharts.com/docs/v5/concepts/themes/
    root.setThemes([
        am5themes_Animated.new(root)
    ]);

    // Create chart
    // https://www.amcharts.com/docs/v5/charts/radar-chart/
    var chart = root.container.children.push(am5radar.RadarChart.new(root, {
        panX: false,
        panY: false,
        wheelX: "panX",
        wheelY: "zoomX",
        innerRadius: am5.percent(20),
        startAngle: -90,
        endAngle: 180
    }));

    // Data
       var data = [
        <?php $p = mysqli_query($DB_CONN, "select name, (SELECT COUNT(id) from package_deposits where package_id = packages.id and status = 1) as c , (SELECT COUNT(id) from package_deposits where status = 1) as t from packages where status = 1");
    $i = 0;
    while ($pack = mysqli_fetch_assoc($p))
    { ?>
        {
        category: "<?=$pack['name'] ?>",
        value: <?=$pack['c'] ?>,
        full: <?=$pack['t'] ?>,
        columnSettings: {
            fill: chart.get("colors").getIndex(<?=++$i ?>)
        }
        }, 
        <?
    } ?>
];

 <? $slct_d = mysqli_query($DB_CONN, "select name, (SELECT COUNT(id) from package_deposits where package_id = packages.id and status = 1) as c , (SELECT COUNT(id) from package_deposits where status = 1) as t from packages where status = 1");
    $fetch_d = mysqli_fetch_assoc($slct_d); ?> // Add cursor
    // https://www.amcharts.com/docs/v5/charts/radar-chart/#Cursor
    var cursor = chart.set("cursor", am5radar.RadarCursor.new(root, {
        behavior: "zoomX"
    }));

    cursor.lineY.set("visible", false);

    // Create axes and their renderers
    // https://www.amcharts.com/docs/v5/charts/radar-chart/#Adding_axes
    var xRenderer = am5radar.AxisRendererCircular.new(root, {
        minGridDistance: 50
    });

    xRenderer.labels.template.setAll({
        radius: 10
    });

    xRenderer.grid.template.setAll({
        forceHidden: true
    });

    var xAxis = chart.xAxes.push(am5xy.ValueAxis.new(root, {
        renderer: xRenderer,
        min: 0,
        max: <?=$fetch_d['t'] ?>,
        strictMinMax: true,
        numberFormat: "#",
        tooltip: am5.Tooltip.new(root, {})
    }));
    var yRenderer = am5radar.AxisRendererRadial.new(root, {
        minGridDistance: 10
    });

    yRenderer.labels.template.setAll({
        centerX: am5.p100,
        fontWeight: "500",
        fontSize: 12,
        templateField: "columnSettings"
    });
    xRenderer.labels.template.setAll({
        fill: "#5d616e",
        fontWeight: "600",
        fontSize: 12,

    });

    yRenderer.grid.template.setAll({
        forceHidden: true  
    });

    var yAxis = chart.yAxes.push(am5xy.CategoryAxis.new(root, {
        categoryField: "category",
        renderer: yRenderer
    }));

    yAxis.data.setAll(data);

    // Create series
    // https://www.amcharts.com/docs/v5/charts/radar-chart/#Adding_series
    var series1 = chart.series.push(am5radar.RadarColumnSeries.new(root, {
        xAxis: xAxis,
        yAxis: yAxis,
        clustered: false,
        valueXField: "full",
        categoryYField: "category",
        fill: root.interfaceColors.get("alternativeBackground")
    }));

    series1.columns.template.setAll({
        width: am5.p100,
        fillOpacity: 0.08,
        strokeOpacity: 0,
        cornerRadius: 20
    });

    series1.data.setAll(data);

    var series2 = chart.series.push(am5radar.RadarColumnSeries.new(root, {
        xAxis: xAxis,
        yAxis: yAxis,
        clustered: false,
        valueXField: "value",
        categoryYField: "category"
    }));

    series2.columns.template.setAll({
        width: am5.p100,
        strokeOpacity: 0,
        tooltipText: "{category}: {valueX} ",
        cornerRadius: 20,
        templateField: "columnSettings"
    });

    series2.data.setAll(data);

    // Animate chart and series in
    // https://www.amcharts.com/docs/v5/concepts/animations/#Initial_animation
    series1.appear(1000);
    series2.appear(1000);
    chart.appear(1000, 100);
}); // end am5.ready()
</script>
<script>
am5.ready(function () {

    // Create root element
    var root = am5.Root.new("kt_amcharts_1");

    // Set themes
    root.setThemes([
        am5themes_Animated.new(root)
    ]);

    // Create chart
    var chart = root.container.children.push(am5xy.XYChart.new(root, {
        panX: false,
        panY: false,
        wheelX: "panX",
        wheelY: "zoomX",
        layout: root.verticalLayout
    }));

    // Add legend
    var legend = chart.children.push(
        am5.Legend.new(root, {
            centerX: am5.p50,
            x: am5.p50
        })
    );

    // Data from PHP
    var data = [
        <?php
        $date1 = date("Y-m-d", strtotime("-10 days"));
        $start = new DateTime($date1);
        $end = new DateTime("now");
        $interval = DateInterval::createFromDateString('1 day');
        $period = new DatePeriod($start, $interval, $end);

        $dates = array();
        foreach ($period as $dt) {
            $dates[] = $dt->format("Y-m-d");
        }
        ?>
        <?php foreach ($dates as $date) {
            $de = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT (SELECT sum(amount) FROM `transactions` where date(timestamp) = '{$date}' and txn_type ='invest') as deposit"));
            $ea = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT (SELECT sum(amount) FROM `transactions` where date(timestamp) = '{$date}' and txn_type ='earning') as earning"));
            $wi = mysqli_fetch_assoc(mysqli_query($DB_CONN, "SELECT (SELECT sum(amount) FROM `transactions` where date(timestamp) = '{$date}' and status = 1 and txn_type ='withdraw') as withdraw"));
        ?>
            {
                "date": "<?=$date?>",
                "deposit": <?=round($de['deposit'], $preferences['round']); ?>,
                "earning": <?=round($ea['earning'], $preferences['round']); ?>,
                "withdraw": <?=round($wi['withdraw'], $preferences['round']); ?>,
            }, 
        <?php } ?>
    ];

    // Create axes
    var xAxis = chart.xAxes.push(am5xy.CategoryAxis.new(root, {
        categoryField: "date",
        renderer: am5xy.AxisRendererX.new(root, {
            cellStartLocation: 0.1,
            cellEndLocation: 0.9
        }),
        tooltip: am5.Tooltip.new(root, {})
    }));

    // Set custom color for X-axis labels
    xAxis.get("renderer").labels.template.setAll({
        fill: am5.color(0x636674)
    });
    xAxis.data.setAll(data);

    var yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root, {
        renderer: am5xy.AxisRendererY.new(root, {})
    }));

    // Set custom color for Y-axis labels
    yAxis.get("renderer").labels.template.setAll({
        fill: am5.color(0x636674)
    });

    // Add series
    function makeSeries(name, fieldName, textColor) {
        var series = chart.series.push(am5xy.ColumnSeries.new(root, {
            name: name,
            xAxis: xAxis,
            yAxis: yAxis,
            valueYField: fieldName,
            categoryXField: "date"
        }));

        series.columns.template.setAll({
            tooltipText: "{name}, {categoryX}:{valueY}",
            width: am5.percent(90),
            tooltipY: 0
        });

        series.data.setAll(data);

        // Add bullets with custom text color
        series.bullets.push(function () {
            return am5.Bullet.new(root, {
                locationY: 0,
                sprite: am5.Label.new(root, {
                    text: "{valueY}",
                    fill: am5.color(textColor),
                    centerY: am5.p50,
                    centerX: am5.p50,
                    populateText: true
                })
            });
        });

        legend.data.push(series);
    }

    // Create series with custom color for Deposits
    makeSeries("Deposits", "deposit", root.interfaceColors.get("text")); // Custom color for Deposits (#636674)
    makeSeries("Earnings", "earning", root.interfaceColors.get("text")); // Default color
    makeSeries("Withdrawals", "withdraw", root.interfaceColors.get("text")); // Default color

    // Make stuff animate on load
    chart.appear(1000, 100);

}); // end am5.ready()
</script>
<?
} ?>
<!-- end admin -->
 
    <!--end::Layout-->
                                </div>
                                <!--end::Content container-->
                            </div>
                            <!--end::Content-->
                        </div>
                        <!--end::Content wrapper-->
                        <!--begin::Footer-->
                    </div>
               
                        </div>
                        
                            </div> 
<div class="modal fade" tabindex="-1" id="kt_modal_100">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Upload and Manage Images</h5>
                    <div class="btn btn-icon btn-sm btn-active-light-primary ms-2" data-bs-dismiss="modal" aria-label="Close">
                        <span class="svg-icon svg-icon-2x"></span>
                    </div>
                </div>
<div id="message" class="alert d-none p-3" role="alert">
    <span id="message-text" class="me-auto"></span>
    <button type="button" class="btn-close ms-2" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
                            
    <div class="modal-body">
        <ul class="nav nav-tabs nav-line-tabs mb-5 fs-6">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#kt_tab_pane_1">Upload</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#kt_tab_pane_2">Manage Images</a>
            </li>
        </ul>
        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="kt_tab_pane_1" role="tabpanel">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="avatar" class="form-label">Choose file to upload</label>
                        <input type="file" class="form-control" id="avatar" name="avatar" accept=".png, .jpg, .jpeg, .gif">
                    </div>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </form>
            </div>
            <div class="tab-pane fade" id="kt_tab_pane_2" role="tabpanel">
                <div class="mb-5">
    <span class="fs-6 fw-bold me-2">Sort by:</span>
    <button id="sort-name-asc" class="btn btn-sm btn-secondary sort-btn me-2">Name ↑</button>
    <button id="sort-name-desc" class="btn btn-sm btn-secondary sort-btn me-2">Name ↓</button>
    <button id="sort-date-asc" class="btn btn-sm btn-secondary sort-btn me-2">Date ↑</button>
    <button id="sort-date-desc" class="btn btn-sm btn-primary sort-btn">Date ↓</button>
</div>
<div id="imageManageContainer"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- categories -->
<div class="modal fade" id="kt_modal_categories" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Categories</h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="card">
                    <div class="card-header border-0 pt-6">
                        <!--begin::Search-->
                        <div class="card-title">
                            <div class="d-flex align-items-center position-relative my-1">
                                <span class="svg-icon svg-icon-1 position-absolute ms-6">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                        <path d="M21.7 18.9L18.6 15.8C17.9 16.9 16.9 17.9 15.8 18.6L18.9 21.7C19.3 22.1 19.9 22.1 20.3 21.7L21.7 20.3C22.1 19.9 22.1 19.3 21.7 18.9Z" fill="currentColor"/>
                                        <path opacity="0.3" d="M11 20C6 20 2 16 2 11C2 6 6 2 11 2C16 2 20 6 20 11C20 16 16 20 11 20Z" fill="currentColor"/>
                                    </svg>
                                </span>
                                <input type="text" id="categorySearch" class="form-control form-control-solid w-250px ps-14" placeholder="Search categories"/>
                            </div>
                        </div>
                        <!--end::Search-->
                        
                        <!--begin::Add button-->
                        <div class="card-toolbar">
                            <button type="button" class="btn btn-primary" onclick="addCategory()">
                                <span class="svg-icon svg-icon-2">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                        <rect opacity="0.5" x="11.364" y="20.364" width="16" height="2" rx="1" transform="rotate(-90 11.364 20.364)" fill="currentColor"/>
                                        <rect x="4.36396" y="11.364" width="16" height="2" rx="1" fill="currentColor"/>
                                    </svg>
                                </span>
                                Add Category
                            </button>
                        </div>
                        <!--end::Add button-->
                    </div>

                    <div class="card-body py-4">
                        <table class="table align-middle table-row-dashed fs-6 gy-5">
                            <thead>
                               <tr class="text-start text-muted fw-bold fs-7 text-uppercase gs-0">
    <th>Order</th>
    <th>Name</th>
    <th>Parent</th>
    <th>SEO Robots</th>
    <th>Items</th>
    <th>Actions</th>
</tr>
                            </thead>
                            <tbody id="categoriesTableBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
 <!-- Add categories -->
<div class="modal fade" id="kt_modal_category_form" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered mw-650px">
        <div class="modal-content">
            <form id="categoryForm" class="form">
                <div class="modal-header">
                    <h2 class="fw-bold" id="modalTitle">Add Category</h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body py-10 px-lg-17">
                    <input type="hidden" name="action" id="form_action" value="add">
                    <input type="hidden" name="id" id="category_id">
                      <div class="fv-row mb-7">
                        <label class="fw-semibold fs-6 mb-2 required">Parent Category</label>
                        <select name="parent_id" class="form-select form-select-solid" required>
                          
                            <!-- Options will be loaded dynamically -->
                        </select>
                        <small class="text-muted"></small>
                    </div>
                    
                    <div class="fv-row mb-7">
                        <label class="required fw-semibold fs-6 mb-2">Name</label>
                        <input type="text" name="name" class="form-control form-control-solid" required />
                    </div>
                    <div class="fv-row mb-7">
                        <label class="required fw-semibold fs-6 mb-2">Slug</label>
                        <input type="text" name="slug" class="form-control form-control-solid" required />
                    </div>

                    <div class="fv-row mb-7">
                        <label class="fw-semibold fs-6 mb-2">Description</label>
                        <textarea name="description" class="form-control form-control-solid" rows="3"></textarea>
                    </div>

                  

                    <div class="fv-row mb-7">
                        <label class="required fw-semibold fs-6 mb-2">SEO Robots</label>
                        <select name="seo_robots" class="form-select form-select-solid" required>
                              <option value="no">No</option>
                            <option value="yes">Yes</option>
                          
                        </select>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submitButton">
                        <span class="indicator-label">Save</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

    <script>


$(document).ready(function() {
    let currentSortBy = 'upload_date';
    let currentSortOrder = 'desc';
    let currentPage = 1;
    let searchTimer = null;

function showMessage(message, isSuccess) {
    const messageContainer = $('#message');
    const messageText = $('#message-text');
    
    // Clear any existing timeouts
    if (messageContainer.data('timeout')) {
        clearTimeout(messageContainer.data('timeout'));
    }
    
    // Reset any existing animations
    messageContainer.stop(true, true);
    
    // Update classes and content
    messageContainer
        .removeClass('alert-success alert-danger d-none')
        .addClass(isSuccess ? 'alert-success' : 'alert-danger')
        .addClass('d-flex');
        
    messageText.text(message);
    
    // Show the message
    messageContainer.show();
    
    // Set timeout for hiding
    const timeout = setTimeout(() => {
        hideMessage();
    }, 3000);
    
    messageContainer.data('timeout', timeout);
}

function hideMessage() {
    const messageContainer = $('#message');
    const messageText = $('#message-text');
    
    // Clear any existing timeouts
    if (messageContainer.data('timeout')) {
        clearTimeout(messageContainer.data('timeout'));
    }
    
    // Hide the container and reset content
    messageContainer.fadeOut(300, function() {
        messageContainer
            .removeClass('d-flex')
            .addClass('d-none')
            .hide();
        messageText.text('');
    });
}
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}
// Add event handler for close button
$(document).on('click', '.btn-close', function() {
    hideMessage();
});

    function formatDate(timestamp) {
        return new Date(timestamp).toLocaleString();
    }
    $('#kt_tab_pane_2').prepend(`
        <div class="d-flex align-items-center position-relative my-1 mb-5">
            <span class="svg-icon svg-icon-1 position-absolute ms-6">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect opacity="0.5" x="17.0365" y="15.1223" width="8.15546" height="2" rx="1" transform="rotate(45 17.0365 15.1223)" fill="currentColor"></rect>
                    <path d="M11 19C6.55556 19 3 15.4444 3 11C3 6.55556 6.55556 3 11 3C15.4444 3 19 6.55556 19 11C19 15.4444 15.4444 19 11 19ZM11 5C7.53333 5 5 7.53333 5 11C5 14.4667 7.53333 17 11 17C14.4667 17 17 14.4667 17 11C17 7.53333 14.4667 5 11 5Z" fill="currentColor"></path>
                </svg>
            </span>
            <input type="text" class="form-control form-control-solid w-250px ps-14" id="imageSearch" placeholder="Search images...">
        </div>
    `);
      $('#imageManageContainer').after(`
        <div class="d-flex flex-stack flex-wrap pt-10" id="pagination-container" style="display: none;">
            <div class="fs-6 fw-semibold text-gray-700" id="pagination-info"></div>
            <ul class="pagination"></ul>
        </div>
    `);
   function loadImages(page = 1, search = '') {
        const perPage = 10;
     
        $.post('admin.php?page=upload', {
            action: 'get_images',
            sort_by: currentSortBy,
            sort_order: currentSortOrder,
            page: page,
            per_page: perPage,
            search: search
        }, function(response) {
            if (response.success) {
                const container = $('#imageManageContainer');
                container.empty();
                
               if (response.images.length === 0) {
                    container.append(`
                        <div class="card">
                            <div class="card-body text-center py-15">
                                <span class="svg-icon svg-icon-5tx svg-icon-gray-600 mb-5">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path opacity="0.3" d="M11 19C6 19 2 15 2 10C2 5 6 1 11 1C16 1 20 5 20 10C20 15 16 19 11 19ZM11 3C7.1 3 4 6.1 4 10C4 13.9 7.1 17 11 17C14.9 17 18 13.9 18 10C18 6.1 14.9 3 11 3Z" fill="currentColor"/>
                                        <path d="M11 14C6.6 14 3 10.4 3 6C3 1.6 6.6 -2 11 -2C15.4 -2 19 1.6 19 6C19 10.4 15.4 14 11 14ZM11 0C7.7 0 5 2.7 5 6C5 9.3 7.7 12 11 12C14.3 12 17 9.3 17 6C17 2.7 14.3 0 11 0Z" fill="currentColor"/>
                                    </svg>
                                </span>
                                <div class="text-gray-600 fw-semibold fs-4">
                                    ${search ? 'No images found matching your search' : 'No images available'}
                                </div>
                            </div>
                        </div>
                    `);
                    $('#pagination-container').hide();
                    return;
                }

                response.images.forEach(function(image) {
                      
                    container.append(`
                        <div class="card card-flush mb-5">
                            <div class="card-body p-5">
                                <div class="d-flex align-items-center mb-5">
                                    <!--begin::Image-->
                                    <div class="symbol symbol-100px me-5">
                                        <div class="symbol-label" style="background-image: url('${image.url}')"></div>
                                    </div>
                                    <!--end::Image-->

                                    <!--begin::Details-->
                                    <div class="flex-grow-1">
                                        <div class="view-mode">
                                            <div class="d-flex align-items-center mb-2">
                                                <span class="text-gray-800 fs-2 fw-bold me-2 image-name">${image.name}</span>
                                            </div>
                                            <div class="fs-7 text-muted">
                                                <div class="d-flex flex-column gap-1">
                                                    <span>Upload Date: ${formatDate(image.upload_date)}</span>
                                                    <span>Last Modified: ${formatDate(image.last_modified)}</span>
                                                    <span>File Size: ${formatFileSize(image.filesize)}</span>
<span>Dimensions: ${image.width && image.height ? `${image.width} × ${image.height} px` : 'Unknown'}</span>
                                                    ${image.alt_text ? `<span>Alt Text: ${image.alt_text}</span>` : ''}
                                                    ${image.title ? `<span>Title: ${image.title}</span>` : ''}
                                        <input value="${image.url}" class="form-control form-control-sm" readonly onclick="this.select()" style="width: 70%;" />
                                                </div>
                                            </div>
                                        </div>

                                        <div class="edit-mode" style="display:none;">
                                            <div class="row g-5">
                                                <div class="col-md-6">
                                                    <label class="form-label">File Name</label>
                                                    <input type="text" class="form-control form-control-sm  new-name" 
                                                        value="${image.name.split('.')[0]}" 
                                                        placeholder="New name (without extension)">
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Alt Text</label>
                                                    <input type="text" class="form-control form-control-sm alt-text" 
                                                        placeholder="Alt Text" value="${image.alt_text || ''}">
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Title</label>
                                                    <input type="text" class="form-control form-control-sm  title" 
                                                        placeholder="Title" value="${image.title || ''}">
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Caption</label>
                                                    <input type="text" class="form-control form-control-sm  caption" 
                                                        placeholder="Caption" value="${image.caption || ''}">
                                                </div>
                                                <div class="col-12">
                                                    <label class="form-label">Description</label>
                                                    <textarea class="form-control form-control-sm  description" 
                                                        placeholder="Description" rows="3">${image.description || ''}</textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--end::Details-->

                                    <!--begin::Actions-->
                                    <div class="d-flex flex-column gap-2">
                                        <div class="view-mode-buttons">
                                            <button type="button" class="btn btn-sm btn-light-primary select-image" 
                                                data-image-url="${image.url}" 
                                                data-image-alt="${image.alt_text || ''}" 
                                                data-image-title="${image.title || ''}">
                                               
                                                Select
                                            </button>
                                            <button type="button" class="btn btn-sm btn-light-warning edit-metadata">
                                               
                                                Edit
                                            </button>
                                            <button type="button" class="btn btn-sm btn-light-danger delete-image" 
                                                data-image-name="${image.name}">
                                             
                                                Delete
                                            </button>
                                        </div>
                                        <div class="edit-mode-buttons" style="display:none;">
                                            <button type="button" class="btn btn-sm btn-light-success save-metadata" 
                                                data-image-name="${image.name}">
                                                
                                                Save 
                                            </button>
                                            <button type="button" class="btn btn-sm btn-light-secondary cancel-edit">
                                               
                                                Cancel
                                            </button>
                                        </div>
                                    </div>
                                    <!--end::Actions-->
                                </div>
                            </div>
                        </div>
                    `);
                });
                updatePagination(response.pagination);
            }
        });
    }
    function updatePagination(pagination) {
        const container = $('#pagination-container');
        const paginationList = container.find('.pagination');
        const paginationInfo = container.find('#pagination-info');
        
        // Update info text
        const start = ((pagination.current_page - 1) * pagination.per_page) + 1;
        const end = Math.min(start + pagination.per_page - 1, pagination.total);
        paginationInfo.text(`Showing ${start} to ${end} of ${pagination.total} images`);

        // Generate pagination links
        paginationList.empty();
        
        // Previous button
        paginationList.append(`
            <li class="page-item previous ${pagination.current_page === 1 ? 'disabled' : ''}">
                <a href="#" class="page-link" data-page="${pagination.current_page - 1}">
                    <i class="previous"></i>
                </a>
            </li>
        `);

        // Page numbers
        for (let i = 1; i <= pagination.total_pages; i++) {
            if (
                i === 1 || 
                i === pagination.total_pages || 
                (i >= pagination.current_page - 1 && i <= pagination.current_page + 1)
            ) {
                paginationList.append(`
                    <li class="page-item ${i === pagination.current_page ? 'active' : ''}">
                        <a href="#" class="page-link" data-page="${i}">${i}</a>
                    </li>
                `);
            } else if (
                i === pagination.current_page - 2 || 
                i === pagination.current_page + 2
            ) {
                paginationList.append(`
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                `);
            }
        }

        // Next button
        paginationList.append(`
            <li class="page-item next ${pagination.current_page === pagination.total_pages ? 'disabled' : ''}">
                <a href="#" class="page-link" data-page="${pagination.current_page + 1}">
                    <i class="next"></i>
                </a>
            </li>
        `);

        container.show();
    }
    function updateSortButtons() {
        $('.sort-btn').removeClass('btn-primary').addClass('btn-secondary');
        $(`#sort-${currentSortBy}-${currentSortOrder}`).removeClass('btn-secondary').addClass('btn-primary');
    }

    $('#imageSearch').on('input', function() {
        const searchValue = $(this).val();
        clearTimeout(searchTimer);
        
        searchTimer = setTimeout(() => {
            currentPage = 1;
            loadImages(currentPage, searchValue);
        }, 300);
    });

    // Pagination click handling
    $(document).on('click', '.pagination .page-link', function(e) {
        e.preventDefault();
        const page = $(this).data('page');
        if (page && !$(this).parent().hasClass('disabled')) {
            currentPage = page;
            loadImages(currentPage, $('#imageSearch').val());
        }
    });

    // Sort button handling (updated)
    $('.sort-btn').click(function() {
        const [sortBy, sortOrder] = $(this).attr('id').split('-').slice(1);
        currentSortBy = sortBy;
        currentSortOrder = sortOrder;
        currentPage = 1;
        updateSortButtons();
        loadImages(currentPage, $('#imageSearch').val());
    });

    $('#uploadForm').submit(function(e) {
        e.preventDefault();
        var formData = new FormData(this);
        $.ajax({
            url: 'admin.php?page=upload',
            type: 'POST',
            data: formData,
            success: function(response) {
                showMessage(response.message, response.success);
                if (response.success) {
                    loadImages();
                    var newImageUrl = response.newUrl;
                    $('.image-input-wrapper[data-active="true"]').css('background-image', `url(${newImageUrl})`);
                    $('.image-input-wrapper[data-active="true"]').siblings('input[type="hidden"]').val(newImageUrl);
                }
            },
            cache: false,
            contentType: false,
            processData: false
        });
    });

    $(document).on('click', '[data-kt-image-input-action="change"]', function() {
        var inputWrapper = $(this).closest('.image-input');
        $('.image-input').removeAttr('data-active');
        inputWrapper.attr('data-active', 'true');
    });

function insertImageIntoQuill(imageUrl, imageAlt, imageTitle) {
    const range = quill.getSelection();
    if (range) {
        quill.insertEmbed(range.index, 'image', imageUrl);
        quill.setSelection(range.index + 1);
    }
}


$(document).on('click', '.select-image', function() {
    var imageUrl = $(this).data('image-url');
    var imageAlt = $(this).data('image-alt');
    var imageTitle = $(this).data('image-title');
    var activeInput = $('.image-input[data-active="true"]');
    
    if (activeInput.length) {
        var previewWrapper = activeInput.find('.image-input-wrapper');
        previewWrapper.css('background-image', `url(${imageUrl})`);
        var hiddenInput = activeInput.closest('.col-md-10').find('input[type="hidden"]');
         var hiddenInput = activeInput.find('input[type="hidden"]');
        console.log('Found hidden input:', hiddenInput.length);
        if (!hiddenInput.length) {
            hiddenInput = activeInput.siblings('input[type="hidden"]');
        }
        if (!hiddenInput.length) {
            var previewId = previewWrapper.attr('id');
            if (previewId) {
                hiddenInput = $(`input[type="hidden"]#${previewId}_url`);
            }
        }
        if (hiddenInput.length) {
            hiddenInput.val(imageUrl);
            console.log('Updated hidden input value:', hiddenInput.val());
        }
    } else {
        insertImageIntoQuill(imageUrl, imageAlt, imageTitle);
    }
    $('.image-input').removeAttr('data-active');
    $('#kt_modal_100').modal('hide');
});

    $(document).on('click', '[data-kt-image-input-action="remove"]', function() {
        var inputWrapper = $(this).closest('.image-input');
        var previewWrapper = inputWrapper.find('.image-input-wrapper');
        var hiddenInput = inputWrapper.siblings('input[type="hidden"]');
        
        previewWrapper.css('background-image', 'url(bitders/assets/placeholder.svg)');
        hiddenInput.val('');
    });

    $(document).on('click', '[data-kt-image-input-action="cancel"]', function() {
        var inputWrapper = $(this).closest('.image-input');
        var previewWrapper = inputWrapper.find('.image-input-wrapper');
        var hiddenInput = inputWrapper.siblings('input[type="hidden"]');
        var originalImage = hiddenInput.data('original-value') || 'bitders/assets/placeholder.svg';
        
        previewWrapper.css('background-image', `url(${originalImage})`);
        hiddenInput.val(originalImage !== 'bitders/assets/placeholder.svg' ? originalImage : '');
    });

 $(document).on('click', '.edit-metadata', function() {
        const container = $(this).closest('.card-body');
        container.find('.view-mode, .view-mode-buttons').hide();
        container.find('.edit-mode, .edit-mode-buttons').fadeIn();
    });

    $(document).on('click', '.cancel-edit', function() {
        const container = $(this).closest('.card-body');
        container.find('.edit-mode, .edit-mode-buttons').hide();
        container.find('.view-mode, .view-mode-buttons').fadeIn();
    });

    $(document).on('click', '.save-metadata', function() {
        const button = $(this);
        const container = button.closest('.card-body');
        const oldName = button.data('image-name');
        const newName = container.find('.new-name').val();
        const altText = container.find('.alt-text').val();
        const title = container.find('.title').val();
        const caption = container.find('.caption').val();
        const description = container.find('.description').val();
        
        // Disable button and show loading state using Metronic's indicator
        button.attr('data-kt-indicator', 'on').prop('disabled', true);
        
        const saveMetadata = () => {
            $.post('admin.php?page=upload', {
                update_metadata: true,
                filename: oldName,
                alt_text: altText,
                title: title,
                caption: caption,
                description: description
            }, function(response) {
                button.removeAttr('data-kt-indicator').prop('disabled', false);
                showMessage(response.message, response.success);
                if (response.success) {
                    container.find('.edit-mode, .edit-mode-buttons').hide();
                    container.find('.view-mode, .view-mode-buttons').show();
                    loadImages();
                }
            });
        };

        if (newName !== oldName.split('.')[0]) {
            $.post('admin.php?page=upload', {
                rename_image: oldName,
                new_name: newName
            }, function(response) {
                if (response.success) {
                    button.data('image-name', response.newName);
                    saveMetadata();
                } else {
                    button.removeAttr('data-kt-indicator').prop('disabled', false);
                    showMessage("Failed to rename image.", false);
                }
            });
        } else {
            saveMetadata();
        }
    });

    $(document).on('click', '.delete-image', function() {
        const imageName = $(this).data('image-name');
        
        Swal.fire({
            text: "Are you sure you want to delete this image?",
            icon: "warning",
            showCancelButton: true,
            buttonsStyling: false,
            confirmButtonText: "Yes, delete it!",
            cancelButtonText: "No, cancel",
            customClass: {
                confirmButton: "btn fw-bold btn-danger",
                cancelButton: "btn fw-bold btn-active-light-primary"
            }
        }).then(function (result) {
            if (result.value) {
                $.post('admin.php?page=upload', {
                    delete_image: imageName
                }, function(response) {
                    showMessage(response.message, response.success);
                    if (response.success) {
                        loadImages();
                    }
                });
            }
        });
    });

    $('#kt_modal_100').on('show.bs.modal', function () {
        loadImages();
        updateSortButtons();
    });

    // Initial load
    updateSortButtons();
    loadImages();
});
function addFaqItem() {
    const faqSection = document.getElementById('faq-section');
    const faqCount = faqSection.querySelectorAll('.faq-item').length + 1;
    
    const newFaq = `
        <div class="faq-item card card-bordered mb-5" data-kt-element="faq-item">
            <div class="card-body p-5">
                <div class="d-flex flex-column gap-5">
                    <div class="form-group">
                        <label class="form-label required">Question #${faqCount}</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light">
                                <i class="ki-duotone ki-question-2 fs-3">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                            </span>
                            <input type="text" 
                                   class="form-control form-control-sm form-control-solid" 
                                   name="faq_question[]" 
                                   placeholder="Enter question here"
                                   required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label required">Answer</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light">
                                <i class="ki-duotone ki-message-text-2 fs-3">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                            </span>
                            <textarea class="form-control form-control-sm form-control-solid" 
                                      name="faq_answer[]" 
                                      placeholder="Enter detailed answer" 
                                      rows="3"
                                      required></textarea>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end">
                        <button type="button" 
                                class="btn btn-sm btn-icon btn-light-danger" 
                                onclick="removeFaqItem(this)"
                                data-bs-toggle="tooltip"
                                title="Remove FAQ">
                            <i class="ki-duotone ki-trash fs-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                                <span class="path4"></span>
                                <span class="path5"></span>
                            </i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    faqSection.insertAdjacentHTML('beforeend', newFaq);
    initTooltips();
    
    // Scroll to the new FAQ
    const newElement = faqSection.lastElementChild;
    newElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function removeFaqItem(button) {
    const faqItem = button.closest('.faq-item');
    
    // Animate removal
    faqItem.style.transition = 'all 0.3s ease-out';
    faqItem.style.opacity = '0';
    faqItem.style.transform = 'translateX(20px)';
    
    setTimeout(() => {
        faqItem.remove();
        updateFaqNumbers();
    }, 300);
}

function updateFaqNumbers() {
    const questions = document.querySelectorAll('.faq-item .form-label');
    questions.forEach((label, index) => {
        if (label.textContent.includes('Question #')) {
            label.textContent = `Question #${index + 1}`;
        }
    });
}

function initTooltips() {
    [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')).map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl, {
            trigger: 'hover'
        });
    });
}

// Initialize tooltips on page load
document.addEventListener('DOMContentLoaded', function() {
    initTooltips();
});

function showCategoryManager() {
    const modal = new bootstrap.Modal(document.getElementById('kt_modal_categories'));
    loadCategories();
    modal.show();
}

function loadCategories() {
    const formData = new FormData();
    formData.append('action', 'get_all');

    fetch('admin?page=categories', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if(data.success) {
            const tbody = document.getElementById('categoriesTableBody');
            tbody.innerHTML = data.data.map(category => `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <input type="number" 
                                   class="form-control form-control-sm w-75px me-3" 
                                   value="${category.sort_order}"
                                   onchange="updateOrder(${category.id}, this.value)">
                        </div>
                    </td>
                    <td>${category.name}</td>
                    <td>${category.parent_name || '-'}</td>
                    <td>${category.seo_robots}</td>
                    <td>
                        <span class="badge badge-light-primary">Products: ${category.products_count}</span>
                        <span class="badge badge-light-info">News: ${category.news_count}</span>
                    </td>
                    <td>
                        <button type="button" class="btn btn-icon btn-light-primary btn-sm me-1" 
                                onclick='editCategory(${JSON.stringify(category)})'>
                            <i class="ki-duotone ki-pencil fs-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                        </button>
                        <button type="button" class="btn btn-icon btn-light-danger btn-sm"
                                onclick="deleteCategory(${category.id})">
                            <i class="ki-duotone ki-trash fs-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
    });
}

function updateOrder(id, value) {
    const formData = new FormData();
    formData.append('action', 'update_order');
    formData.append('id', id);
    formData.append('order', value);

    fetch('admin?page=categories', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if(data.success) {
            loadCategories(); // Refresh to show new order
        }
    });
}
// Search functionality
document.getElementById('categorySearch').addEventListener('keyup', function() {
    const searchText = this.value.toLowerCase();
    const rows = document.querySelectorAll('#categoriesTableBody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchText) ? '' : 'none';
    });
});
function addCategory() {
    document.getElementById('form_action').value = 'add';
    document.getElementById('modalTitle').textContent = 'Add Subcategory';
    document.getElementById('categoryForm').reset();
    
    loadParentCategories();
    
    const modal = new bootstrap.Modal(document.getElementById('kt_modal_category_form'));
    modal.show();
}
function editCategory(category) {
    document.getElementById('form_action').value = 'edit';
    document.getElementById('category_id').value = category.id;
    document.getElementById('modalTitle').textContent = 'Edit Category';
    
    const form = document.getElementById('categoryForm');
    form.querySelector('[name="name"]').value = category.name;
     form.querySelector('[name="slug"]').value = category.slug;
    form.querySelector('[name="description"]').value = category.description || '';
    form.querySelector('[name="seo_robots"]').value = category.seo_robots;
    
    loadParentCategories(category.parent_id);
    
    const modal = new bootstrap.Modal(document.getElementById('kt_modal_category_form'));
    modal.show();
}

function refreshCategoryCheckboxes() {
    const formData = new FormData();
    formData.append('action', 'get_all_site');

    fetch('admin?page=categories', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if(data.success) {
            const container = document.getElementById('categoriesCheckboxContainer');
            const selectedCategories = Array.from(container.querySelectorAll('input[type="checkbox"]:checked'))
                                          .map(cb => cb.value);
            
            container.innerHTML = data.data.map(category => `
                <div class="form-check form-check-custom form-check-solid mb-1">
                    <input class="form-check-input" type="checkbox" 
                           name="categories[]" 
                           value="${category.id}"
                           id="category_${category.id}"
                           ${selectedCategories.includes(category.id.toString()) ? 'checked' : ''}>
                    <label class="form-check-label fs-7" for="category_${category.id}">
                        ${category.name}
                    </label>
                </div>
            `).join('');
        }
    });
}
// Delete category
function deleteCategory(categoryId) {
    Swal.fire({
        text: "Are you sure you want to delete this category?",
        icon: "warning",
        showCancelButton: true,
        buttonsStyling: false,
        confirmButtonText: "Yes, delete!",
        cancelButtonText: "No, cancel",
        customClass: {
            confirmButton: "btn fw-bold btn-danger",
            cancelButton: "btn fw-bold btn-active-light-primary"
        }
    }).then((result) => {
        if (result.isConfirmed) {
            const formData = new FormData();
            formData.append('action', 'delete');
            formData.append('id', categoryId);
            
            fetch('admin?page=categories', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    loadCategories();
                    refreshCategoryCheckboxes(); // Refresh the checkboxes
                    Swal.fire({
                        text: "Category deleted successfully!",
                        icon: "success",
                        buttonsStyling: false,
                        confirmButtonText: "Ok, got it!",
                        customClass: {
                            confirmButton: "btn fw-bold btn-primary"
                        }
                    });
                }
            });
        }
    });
}

// Load parent categories for select
function loadParentCategories(selectedId = '') {
    const formData = new FormData();
    formData.append('action', 'get_parents');
    
    fetch('admin?page=categories', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if(data.success) {
            const select = document.querySelector('[name="parent_id"]');
            // Only show parent categories (Site and FAQs)
            select.innerHTML = data.data
                .filter(category => ['Site', 'FAQs'].includes(category.name))
                .map(category => `
                    <option value="${category.id}" ${category.id == selectedId ? 'selected' : ''}>
                        ${category.name}
                    </option>
                `).join('');
            
            // Make parent selection required
            select.required = true;
        }
    });
}

// Handle form submission
document.getElementById('categoryForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('admin?page=categories', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if(data.success) {
            loadCategories(); // Reload the table
            refreshCategoryCheckboxes(); // Refresh the checkboxes
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('kt_modal_category_form'));
            modal.hide();
            
            Swal.fire({
                text: formData.get('action') === 'add' ? 
                    "Category added successfully!" : "Category updated successfully!",
                icon: "success",
                buttonsStyling: false,
                confirmButtonText: "Ok, got it!",
                customClass: {
                    confirmButton: "btn fw-bold btn-primary"
                }
            });
        }
    });
});
</script>


<!--end::Content wrapper-->
                        <!--begin::Footer-->
                        <div id="kt_app_footer" class="app-footer">
                            <!--begin::Footer container-->
                            <div class="app-container container-fluid d-flex flex-column flex-md-row flex-center flex-md-stack py-3">
                                <!--begin::Copyright-->
                                <div class="text-gray-900 order-2 order-md-1">
                                    <span class="text-muted fw-semibold me-1">2024&copy;</span>
                                    <a  href="https://bitders.com" target="_blank" class="text-gray-800 text-hover-primary">$$$ Bitders</a>
                                </div>
                                <!--end::Copyright-->
                                <!--begin::Menu-->
                                <ul class="menu menu-gray-600 menu-hover-primary fw-semibold order-1">
                                
                                    <li class="menu-item">
                                        <a  href="https://bitders.com/support" target="_blank" class="menu-link px-2">Support</a>
                                    </li>
                                
                                </ul>
                                <!--end::Menu-->
                            </div>
                            <!--end::Footer container-->
                        </div>
                        <!--end::Footer-->
                    </div>
                    <!--end:::Main-->
                </div>
                <!--end::Wrapper-->
            </div>
            <!--end::Page-->
 
        
        <!--begin::Scrolltop-->
        <div id="kt_scrolltop" class="scrolltop" data-kt-scrolltop="true">
            <i class="ki-duotone ki-arrow-up">
                <span class="path1"></span>
                <span class="path2"></span>
            </i>
        </div>
        
    </body>
    <!--end::Body-->
</html>